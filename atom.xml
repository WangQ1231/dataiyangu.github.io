<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Leesin&#39;s Blog</title>
  
  <subtitle>To be a better me</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mmmmmm.me/"/>
  <updated>2019-03-10T15:09:21.597Z</updated>
  <id>http://mmmmmm.me/</id>
  
  <author>
    <name>Leesin.Dong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆåäºŒï¼‰ï¼šå€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ã€èŠå¤©å®¤å°é¡¹ç›®ã€netty3å’Œ4ã€5çš„ä¸åŒã€ä¸šåŠ¡çº¿ç¨‹æ± ä»¥åŠæ¶ˆæ¯ä¸²è¡ŒåŒ–</title>
    <link href="http://mmmmmm.me/2019-03-10-12.html"/>
    <id>http://mmmmmm.me/2019-03-10-12.html</id>
    <published>2019-03-10T02:21:12.000Z</published>
    <updated>2019-03-10T15:09:21.597Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰"><a href="#å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰" class="headerlink" title="å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰"></a>å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰</h1><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¹‹å‰çš„æ–‡ç« ä¸­çš„handleræ¯æ¬¡éƒ½éœ€è¦åˆ¤æ–­å¦‚æœæ˜¯moudle=ï¼Ÿç„¶åå¦‚æœcmd=ï¼Ÿï¼Œæ‰è¿›è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œè¿™é‡Œå¸Œæœ›èƒ½å¤Ÿé€šè¿‡æŸç§æ–¹æ³•å®ç°è‡ªåŠ¨æ‰§è¡Œmoudle=ï¼Ÿcmd=ï¼Ÿæ—¶å€™çš„æ–¹æ³•ï¼Œä»è€Œå®ç°ä¸šåŠ¡åˆ†ç¦»ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"><span class="comment">//ä¿®æ”¹ä¸ºresponseå¯¹è±¡</span></span><br><span class="line">Response message = (Response)e.getMessage();</span><br><span class="line"><span class="keyword">if</span>(message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(message.getCmd() == <span class="number">1</span>)&#123;</span><br><span class="line">ã€‚ã€‚ã€‚</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(message.getCmd() == <span class="number">2</span>)&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡springå®ç°ä¸šåŠ¡åˆ†ç¦»çš„ğŸŒ°</p><h2 id="SocketMoudle-interface"><a href="#SocketMoudle-interface" class="headerlink" title="SocketMoudle(interface)"></a>SocketMoudle(interface)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SocketMoudle(moudle=<span class="number">1</span>)</span><br><span class="line">public interface UserService &#123;</span><br><span class="line">@SocketCmd(cmd=<span class="number">1</span>)</span><br><span class="line">public <span class="keyword">void</span> login();</span><br><span class="line">@SocketCmd(cmd=<span class="number">2</span>)</span><br><span class="line">public <span class="keyword">void</span> getInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Scanner-java"><a href="#Scanner-java" class="headerlink" title="Scanner.java"></a>Scanner.java</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Scanner</span> <span class="title">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">@Override</span><br><span class="line">public <span class="built_in">Object</span> postProcessBeforeInitialization(<span class="built_in">Object</span> bean, <span class="built_in">String</span> beanName) throws BeansException &#123;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public <span class="built_in">Object</span> postProcessAfterInitialization(<span class="built_in">Object</span> bean, <span class="built_in">String</span> beanName) throws BeansException &#123;</span><br><span class="line">Class&lt;? extends <span class="built_in">Object</span>&gt; clazz = bean.getClass();</span><br><span class="line">Class&lt;?&gt;[] interfaces = clazz.getInterfaces();</span><br><span class="line"><span class="keyword">if</span>(interfaces != <span class="literal">null</span> &amp;&amp; interfaces.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//æ‰«æç±»çš„æ‰€æœ‰æ¥å£çˆ¶ç±»</span></span><br><span class="line"><span class="keyword">for</span> (Class&lt;?&gt; interFace : interfaces) &#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦ä¸ºhandleræ¥å£ç±»</span></span><br><span class="line"><span class="comment">//getAnnotationè·å¾—interfaceä¸­æ³¨è§£åå­—ä¸ºSocketModuleçš„æ³¨è§£å¯¹è±¡</span></span><br><span class="line">SocketModule socketModule = interFace.getAnnotation(SocketModule.class);</span><br><span class="line"><span class="keyword">if</span> (socketModule == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰¾å‡ºå‘½ä»¤æ–¹æ³•</span></span><br><span class="line">Method[] methods = interFace.getMethods();</span><br><span class="line"><span class="keyword">if</span>(methods != <span class="literal">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">for</span>(Method method : methods)&#123;</span><br><span class="line"><span class="comment">//getAnnotationè·å¾—methodä¸­æ³¨è§£åå­—ä¸ºSocketCmdçš„æ³¨è§£å¯¹è±¡</span></span><br><span class="line">SocketCmd socketCmd = method.getAnnotation(SocketCmd.class);</span><br><span class="line"><span class="keyword">if</span>(socketCmd == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è·å¾—æ³¨è§£é‡Œé¢çš„moudleå€¼</span></span><br><span class="line">final short <span class="built_in">module</span> = socketModule.module();</span><br><span class="line"><span class="comment">//è·å¾—æ³¨è§£é‡Œé¢çš„cmdå€¼</span></span><br><span class="line">final short cmd = socketCmd.cmd();</span><br><span class="line"><span class="comment">//InvokerHolderã€Invokeråœ¨ä¸‹é¢ï¼Œå¯¹invokeè¿›è¡Œäº†å°è£…</span></span><br><span class="line"><span class="keyword">if</span>(InvokerHoler.getInvoker(<span class="built_in">module</span>, cmd) == <span class="literal">null</span>)&#123;</span><br><span class="line">InvokerHoler.addInvoker(<span class="built_in">module</span>, cmd, Invoker.valueOf(method, bean));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"é‡å¤å‘½ä»¤:"</span>+<span class="string">"module:"</span>+<span class="built_in">module</span> +<span class="string">" "</span>+<span class="string">"cmdï¼š"</span> + cmd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Invoker.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private Method method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›®æ ‡å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private <span class="built_in">Object</span> target;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> Invoker valueOf(Method method, <span class="built_in">Object</span> target)&#123;</span><br><span class="line">Invoker invoker = <span class="keyword">new</span> Invoker();</span><br><span class="line">invoker.setMethod(method);</span><br><span class="line">invoker.setTarget(target);</span><br><span class="line"><span class="keyword">return</span> invoker;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> * @param paramValues</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> * @throws InvocationTargetException </span></span><br><span class="line"><span class="comment"> * @throws IllegalArgumentException </span></span><br><span class="line"><span class="comment"> * @throws IllegalAccessException </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="built_in">Object</span> invoke(<span class="built_in">Object</span>... paramValues)&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> method.invoke(target, paramValues);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Method getMethod() &#123;</span><br><span class="line"><span class="keyword">return</span> method;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setMethod(Method method) &#123;</span><br><span class="line"><span class="keyword">this</span>.method = method;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="built_in">Object</span> getTarget() &#123;</span><br><span class="line"><span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setTarget(<span class="built_in">Object</span> target) &#123;</span><br><span class="line"><span class="keyword">this</span>.target = target;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InvokerHodler.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">InvokerHoler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**å‘½ä»¤è°ƒç”¨å™¨*/</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="built_in">Map</span>&lt;Short, <span class="built_in">Map</span>&lt;Short, Invoker&gt;&gt; invokers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ å‘½ä»¤è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * @param module</span></span><br><span class="line"><span class="comment">     * @param cmd</span></span><br><span class="line"><span class="comment">     * @param invoker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> addInvoker(short <span class="built_in">module</span>, short cmd, Invoker invoker)&#123;</span><br><span class="line">    <span class="built_in">Map</span>&lt;Short, Invoker&gt; map = invokers.get(<span class="built_in">module</span>);</span><br><span class="line">    <span class="keyword">if</span>(map == <span class="literal">null</span>)&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    invokers.put(<span class="built_in">module</span>, map);</span><br><span class="line">    &#125;</span><br><span class="line">    map.put(cmd, invoker);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å‘½ä»¤è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * @param module</span></span><br><span class="line"><span class="comment">     * @param cmd</span></span><br><span class="line"><span class="comment">     * @param invoker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> Invoker getInvoker(short <span class="built_in">module</span>, short cmd)&#123;</span><br><span class="line">    <span class="built_in">Map</span>&lt;Short, Invoker&gt; map = invokers.get(<span class="built_in">module</span>);</span><br><span class="line">    <span class="keyword">if</span>(map != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†Scanneräº¤ç»™springå¤„ç†ï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡æ³¨è§£å®ç°ä¸šåŠ¡åˆ†ç¦»ã€‚</p><h1 id="èŠå¤©å®¤é¡¹ç›®"><a href="#èŠå¤©å®¤é¡¹ç›®" class="headerlink" title="èŠå¤©å®¤é¡¹ç›®"></a>èŠå¤©å®¤é¡¹ç›®</h1><p>èŠå¤©å®¤åŠŸèƒ½ï¼šå¤šä¸ªå®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨ç±»ä¼¼qqç¾¤é‡ŒèŠå¤©ï¼ŒæŸä¸ªç”¨æˆ·èƒ½å¤ŸæŒ‡å®šè§’è‰²å‡ å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¦‚æœè§’è‰²åœ¨å¦ä¸€ä¸ªå®¢æˆ·ç«¯è¢«ç™»å½•ï¼Œä¼šè¢«æŒ¤ä¸‹çº¿ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190310183550321.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ä»£ç ç•¥ï¼ˆæ”¾åœ¨å˜¿å˜¿å˜¿ã€‚ï¼‰</p><h1 id="netty3å’Œ4ã€5çš„ä¸åŒ"><a href="#netty3å’Œ4ã€5çš„ä¸åŒ" class="headerlink" title="netty3å’Œ4ã€5çš„ä¸åŒ"></a>netty3å’Œ4ã€5çš„ä¸åŒ</h1><table><thead><tr><th style="text-align:center">ä½œç”¨</th><th>netty3</th><th>netty4/5</th></tr></thead><tbody><tr><td style="text-align:center"></td></tr></tbody></table><p>åˆ¤æ–­æ˜¯å¦è¿æ¥|channel.isConnected | channel.isActive<br>å‘é€æ•°æ®|write|writeAndFlush<br>ç»‘å®š|getAttachementã€setAttachementã€removeAttachement| channe.attr(ATTACHMENT_KEY).set(attachement)/get()/remove()<br>å†™æ•°æ®ï¼ˆé‡Œé¢çš„æ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯å¯¹è±¡åå­—å˜äº†ï¼‰|ChannelBuffer|ByteBuf<br>newä¸€ä¸ªchannel| ChannelBuffers.dynamicBuffer() | PooledByteBufAllocatorä¸€ä¸ªå†…å­˜ç”³è¯·å™¨(è¦æ³¨æ„ä½¿ç”¨å®Œåé‡Šæ”¾buffer)releaseï¼ˆï¼‰é‡Šæ”¾æˆ–UnpooledByteBufAllocatorï¼ˆæœ€å¥½ä¹Ÿè¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼‰æˆ–Unpooledï¼ˆåº•å±‚èµ°çš„æ˜¯UnpooledByteBufAllocatorï¼‰ æ³¨æ„ç”³è¯·ä¸€æ¬¡ï¼Œå°±åªèƒ½é‡Šæ”¾ä¸€æ¬¡ â€”â€”-å½“ç„¶nettyå°è£…æ¶ˆæ¯çš„bytebufç”¨çš„æ˜¯UnpooledByteBufAllocatorï¼Œå¯ä»¥é€šè¿‡new ServerBootstrap().childOption(channelOption.ALLOCATOR,PooledByteBufAllocator.DEFAULT);è¿˜æœ‰ï¼šdecodeæ–¹æ³•ä¸­ä¼ å…¥çš„bufferæ˜¯nettyå¸®æˆ‘ä»¬åˆ›å»ºçš„ï¼Œdecodeæ–¹æ³•ä¸Šå±‚è‡ªåŠ¨åˆ¤æ–­å¦‚æœç¼“å­˜ï¼ˆcumulationï¼‰ä¸­æ²¡æœ‰äº†æ•°æ®å°±ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚ç»§æ‰¿è‡ªSimpleChannelInbundHandlerçš„handleré¡¶å±‚ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾<br>ååŠ©æˆ‘ä»¬è§£å†³ç²˜åŒ…åˆ†åŒ…çš„é—®é¢˜ï¼ˆé‡Œé¢å®ç°çš„åŸç†å·®ä¸å¤šï¼Œåªæ˜¯æ”¹äº†åå­—ï¼‰è§£ç å™¨|FrameDecoder|ByteToMessageDecoder<br>ç¼–ç å™¨|OneToOneEncoder|MessageToByteEncoder<br>æ¥æ”¶æ¶ˆæ¯| messageReceive|channelRead0(netty5é‡Œé¢æ˜¯messageReceive)</p><h1 id="ä¸šåŠ¡çº¿ç¨‹æ± "><a href="#ä¸šåŠ¡çº¿ç¨‹æ± " class="headerlink" title="ä¸šåŠ¡çº¿ç¨‹æ± "></a>ä¸šåŠ¡çº¿ç¨‹æ± </h1><p>å‰é¢è®²åˆ°æŠ½è±¡çš„ä¾‹å­ï¼Œbosså’Œworkeråˆ†åˆ«æ˜¯é¤å…çš„æœåŠ¡å‘˜ï¼Œè´Ÿè´£çš„æ˜¯å¸®å®¢äººç‚¹èœï¼Œå¯æ˜¯ç‚¹å®Œèœä¹‹ååšèœçš„è¿‡ç¨‹ä¹ˆï¼Ÿåšèœçš„è¿‡ç¨‹å°±æ˜¯ä¸šåŠ¡ï¼Œæ˜¯ä¸èƒ½äº¤ç»™æœåŠ¡å‘˜ï¼ˆbooså’Œworkeræ¥åšçš„ï¼‰ï¼Œå¦åˆ™æ•ˆç‡å¤§æ‰“æŠ˜æ‰£ã€‚å¨å¸ˆåº”è¯¥æœ‰å¤šä¸ªï¼Œaé¡¾å®¢è¦çš„æ‰å¨å¸ˆ1æ¥åšï¼Œå‰©ä¸‹è¿˜æœ‰å¤šä¸ªå¨å¸ˆï¼Œä¸å½±å“å…¶ä»–é¡¾å®¢çš„æ­£å¸¸æ¶ˆè´¹ã€‚<br>ä¸Šé¢ä¾‹å­ä¸­æ•´ä¸ªå¨å¸ˆå›¢é˜Ÿå°±æ˜¯ä¸šåŠ¡çº¿ç¨‹æ± ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœä¸ä½œå¤„ç†çš„è¯ï¼Œä¸šåŠ¡æ˜¯åœ¨workerçº¿ç¨‹ä¸­çš„</p><h2 id="netty3ä¸­è§£å†³æ–¹æ³•"><a href="#netty3ä¸­è§£å†³æ–¹æ³•" class="headerlink" title="netty3ä¸­è§£å†³æ–¹æ³•"></a>netty3ä¸­è§£å†³æ–¹æ³•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HiHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> ExecutorService executorService = Executors.newFixedTHeradPool(Runtime.getRuntime().availableProcessors()*<span class="number">2</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"><span class="comment">//ä¿®æ”¹ä¸ºresponseå¯¹è±¡</span></span><br><span class="line">Response message = (Response)e.getMessage();</span><br><span class="line">RUnnavle task  = handlerMessage(<span class="keyword">new</span> SessionImpl(ctx.getChannel()),request);</span><br><span class="line">executorService.execute(task);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public Runnavle handlerMessage(final Session session,final Request request)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Runnable()&#123;</span><br><span class="line"><span class="comment">//æ­¤å¤„çœç•¥ä¸šåŠ¡å¤„ç†çš„è¿‡ç¨‹ï¼Œè‡ªè¡Œè„‘è¡¥</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<br>å¦‚æœä¸è‡ªå·±å°†ä¸šåŠ¡è¿›è¡Œå¼‚æ­¥çš„è¯ï¼Œnettyå…¶å®æ˜¯ä¸€ä¸ªåŒæ­¥çš„è¿‡ç¨‹ï¼ˆè™½ç„¶nettyè¢«å«åšå¼‚æ­¥ï¼‰ã€‚<br>ä¸šåŠ¡ä¸­å›å†™æ•°æ®ä¹Ÿé»˜è®¤æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºåœ¨å‰é¢çš„æºç ä»‹ç»ä¸­æœ‰ä»‹ç»ï¼ŒAbstractNioSelector.javaä¸­çš„runæ–¹æ³•é‡Œé¢æœ‰ processTaskQueue();å°±æ˜¯è®²writeå›å†™çš„æ•°æ®å°è£…åˆ°äº†é˜Ÿåˆ—ä¸­ï¼Œä¾›å¼‚æ­¥è°ƒç”¨ã€‚</p><h2 id="netty4ã€netty5ä¸­çš„è§£å†³æ–¹æ³•"><a href="#netty4ã€netty5ä¸­çš„è§£å†³æ–¹æ³•" class="headerlink" title="netty4ã€netty5ä¸­çš„è§£å†³æ–¹æ³•"></a>netty4ã€netty5ä¸­çš„è§£å†³æ–¹æ³•</h2><p>ä¸éœ€è¦è‡ªå·±newä¸€ä¸ªçº¿ç¨‹æ± <br>Server.java(serverä¸­)<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ClientBootstrap bootstrap = <span class="keyword">new</span>  ClientBootstrap();</span><br><span class="line"><span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span>.NioEventLoopGroup();</span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span>.NioEventLoopGroup();</span><br><span class="line"><span class="comment">//ä¸šåŠ¡çº¿ç¨‹æ± </span></span><br><span class="line">EventLoopGroup busyGroup = <span class="keyword">new</span>.NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> ResponseDecoder());</span><br><span class="line">ch.pipeline.addLast(<span class="keyword">new</span> RequestEncoder());</span><br><span class="line">ch.pipeline.addLast(busyGroup,<span class="keyword">new</span> HiHandler());</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>è¿™é‡Œåªéœ€è¦</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup busyGroup = <span class="keyword">new</span>.NioEventLoopGroup();</span><br><span class="line">ch.pipeline.addLast(busyGroup,<span class="keyword">new</span> HiHandler());<span class="comment">//åœ¨new HiHandlerï¼ˆï¼‰å‰é¢åŠ å…¥busyGroupå‚æ•°</span></span><br></pre></td></tr></table></figure><p>åŸæœ¬çš„handlerå°±ä¸æ˜¯å†workerä¸­è¿è¡Œäº†ï¼Œå˜æˆäº†åœ¨ä¸Šé¢çš„çº¿ç¨‹æ± å¾ªç¯ç»„ä¸­è¿è¡Œ</p><p>å¦‚æœä¸åŠ å…¥è¿™ä¸ªå‚æ•°ï¼ŒHiHandlerå’ŒRequestEncoderæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼ˆworkerï¼‰<br>åŠ å…¥ä¹‹åä¸¤ä¸ªhandlerå°±ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­äº†ã€‚</p><p><strong><font color="red">æ³¨æ„ï¼š netty4ã€netty5ä¸­çš„è¿™ç§æ–¹æ³•æ¯”netty3è¦å¥½</font></strong><br>å› ä¸ºåœ¨EventLoopGroupå…·æœ‰æ¶ˆæ¯ä¸²è¡ŒåŒ–çš„åŠŸèƒ½</p><h2 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸²è¡ŒåŒ–ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸²è¡ŒåŒ–ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸²è¡ŒåŒ–ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸²è¡ŒåŒ–ï¼Ÿ</h2><p>ä¸¾ä¸ªğŸŒ°ï¼š<br>å‡å¦‚aå’ŒbåŒæ—¶åœ¨æ‰“æ¸¸æˆ<br>aå‘å‡ºæŒ‡ä»¤1-1ï¼Œè¦æ±‚é”å®šè‡ªå·±çš„è´¦å·ï¼Œbä¹Ÿå‘å‡ºæŒ‡ä»¤2-1ï¼Œè¦æ±‚é”å®šaçš„è´¦å·ï¼Œä¸¤è€…ä¹‹é—´å­˜åœ¨é”ç«äº‰æ˜¯æ­£å¸¸çš„ã€‚<br>å¯æ˜¯å¦‚æœaè‡ªå·±å‘å‡ºäº†5æ¡1-1çš„æŒ‡ä»¤ï¼Œå³è¿ç»­è¦æ±‚é”å®šè‡ªå·±äº”æ¬¡ï¼Œäº”æ¬¡è¯·æ±‚åŒæ—¶è¿›è¡Œï¼Œå°±ä¼šè‡ªå·±è·Ÿè‡ªå·±ç«äº‰ã€‚<br>ä¸€æ—¦æœ‰äº†é”çš„ç«äº‰ï¼Œå°±ä¼šååˆ†å½±å“æ•ˆç‡</p><p>æ¶ˆæ¯ä¸²è¡ŒåŒ–å°±æ˜¯è¯·æ±‚ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œ</p><p>æ‰€ä»¥åœ¨netty3ä¸­éœ€è¦è‡ªå·±å®ç°ç¼–å†™å¯ä»¥å®ç°æœ‰åºçš„è¯·æ±‚çš„å¤„ç†çº¿ç¨‹ï¼Œä½†æ˜¯åœ¨netty4ï¼Œnetty5ä¸­EventLoopGroupå…·æœ‰æ¶ˆæ¯ä¸²è¡ŒåŒ–çš„åŠŸèƒ½ã€‚</p><p>å…·ä½“å®ç°å¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸­å­˜å‚¨ç€é˜Ÿåˆ—ï¼Œå°†aå’Œbçš„è¯·æ±‚åˆ†åˆ«æ”¾åˆ°è‡ªå·±å¯¹åº”çš„çº¿ç¨‹ä¸­çš„é˜Ÿåˆ—ä¸­å»ï¼Œé€šè¿‡é˜Ÿåˆ—å»æ‰§è¡Œï¼Œè¾¾åˆ°æ¶ˆæ¯çš„ä¸²è¡ŒåŒ–ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰&quot;&gt;&lt;a href=&quot;#å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰&quot; class=&quot;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šç²˜åŒ…ã€åˆ†åŒ…åˆ†æï¼Œå¦‚ä½•é¿å…socketæ”»å‡»</title>
    <link href="http://mmmmmm.me/2019-03-10-11.html"/>
    <id>http://mmmmmm.me/2019-03-10-11.html</id>
    <published>2019-03-10T02:21:11.000Z</published>
    <updated>2019-03-10T15:09:18.717Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><h2 id="æ¶ˆæ¯å¦‚ä½•åœ¨ç®¡é“ä¸­æµè½¬"><a href="#æ¶ˆæ¯å¦‚ä½•åœ¨ç®¡é“ä¸­æµè½¬" class="headerlink" title="æ¶ˆæ¯å¦‚ä½•åœ¨ç®¡é“ä¸­æµè½¬"></a>æ¶ˆæ¯å¦‚ä½•åœ¨ç®¡é“ä¸­æµè½¬</h2><p>å½“å‰çš„ä¸€ä¸ªhandlerå¦‚ä½•å¾€ä¸‹é¢çš„ä¸€ä¸ªhandlerä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Ÿ<br>ä¸€ä¸ªç®¡é“ï¼ˆpipelineï¼‰ä¸­ä¼šæœ‰å¤šä¸ªhandler<br>handlerå¾€ä¸‹ä¼ é€’å¯¹è±¡çš„æ–¹æ³•æ˜¯sendUpstream(event)</p><p>æ¯ä¸ªç®¡é“ä¸‹é¢å¨¥decoderã€encoderå…¶å®æœ€ç»ˆéƒ½æ˜¯ç»§æ‰¿äº†æŸä¸ªhandler</p><p>å½“å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯ä»¥ånettyä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯å¯¹è±¡å°è£…æˆä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠäº‹ä»¶ä¼ é€’åˆ°ç®¡é“é‡Œé¢ï¼Œç®¡é“é‡Œé¢æœ‰å¾ˆå¤šhandler,æ¯æ¬¡ç»è¿‡ä¸€ä¸ªhandlerï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªæ–°çš„äº‹ä»¶ï¼Œç„¶åç»è¿‡ä¸‹ä¸€ä¸ªhandlerï¼Œå½¢æˆæ–°çš„äº‹ä»¶ã€‚<br>ä¹Ÿæ²¡æ‰¾åˆ°ä»€ä¹ˆå¥½çš„å›¾è§£ï¼Œæ„Ÿè°¢ï¼š<a href="https://www.cnblogs.com/chenmo-xpw/p/3938284.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenmo-xpw/p/3938284.html</a><br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190309134530270.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ä¸Šå›¾ä¸­å…¶å®æ˜¯å°†ä¸€ä¸ªchannelEventå³äº‹ä»¶ä¼ å…¥äº†channelä¸­çš„pipelineï¼Œä¸‹é¢æºç ä¸­è¯¦ç»†ä»‹ç»ã€‚</p><h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><p>è¿›å…¥</p><h3 id="AbstractNioSelector-java"><a href="#AbstractNioSelector-java" class="headerlink" title="AbstractNioSelector.java"></a>AbstractNioSelector.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run()&#123;</span><br><span class="line">...</span><br><span class="line">    process(selector);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»processæ–¹æ³•åˆ°</p><h3 id="AbstractNioWorker-java"><a href="#AbstractNioWorker-java" class="headerlink" title="AbstractNioWorker.java"></a>AbstractNioWorker.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">process()&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (!read(k)) &#123;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»readæ–¹æ³•åˆ°</p><h3 id="NioWorker-java"><a href="#NioWorker-java" class="headerlink" title="NioWorker.java"></a>NioWorker.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">read(k)&#123;</span><br><span class="line"><span class="comment">//é€šè¿‡kå¾—åˆ°channel</span></span><br><span class="line">final SocketChannel ch = (SocketChannel) k.channel();</span><br><span class="line">final NioSocketChannel channel = (NioSocketChannel) k.attachment();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">final ChannelBuffer buffer = bufferFactory.getBuffer(readBytes);</span><br><span class="line">    buffer.setBytes(<span class="number">0</span>, bb);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Fire the event.</span></span><br><span class="line">    fireMessageReceived(channel, buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»fireMessageReceivedæ–¹æ³•å†è¿›å…¥fireMessageReceivedæ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="keyword">static</span> <span class="keyword">void</span> fireMessageReceived(Channel channel, <span class="built_in">Object</span> message, SocketAddress remoteAddress) &#123;</span><br><span class="line"> <span class="comment">//ä»channelä¸­è·å–ä¸€ä¸ªç®¡é“ï¼Œå¾€ç®¡é“ä¸­å‘é€äº†ä¸€ä¸ªsendUpstreamäº‹ä»¶</span></span><br><span class="line">        channel.getPipeline().sendUpstream(</span><br><span class="line">        <span class="comment">//newäº†ä¸€ä¸ªUpstreamMessageEventå¾€ç®¡é“ä¸­æ‰”</span></span><br><span class="line">                <span class="keyword">new</span> UpstreamMessageEvent(channel, message, remoteAddress));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//ä¸Šä¼ çš„event</span></span><br><span class="line">  public <span class="keyword">void</span> sendUpstream(ChannelEvent e) &#123;</span><br><span class="line">  <span class="comment">//é¦–å…ˆè·å–åˆ°ä¸€ä¸ªDefaultChannelHandlerContext,åœ¨ä¸‹é¢</span></span><br><span class="line">  <span class="comment">//headæ˜¯å¤´æŒ‡é’ˆ</span></span><br><span class="line">  <span class="comment">//getActualUpstreamContextæ–¹æ³•åœ¨ä¸‹é¢çš„DefualtChannelPipeline.java</span></span><br><span class="line">        DefaultChannelHandlerContext head = getActualUpstreamContext(<span class="keyword">this</span>.head);</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(</span><br><span class="line">                        <span class="string">"The pipeline contains no upstream handlers; discarding: "</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//æ¥ç€headé‡Œé¢æ¥ç€send</span></span><br><span class="line"><span class="comment">//å…·ä½“å®ç°åœ¨DefaultChannelPipeline.java</span></span><br><span class="line">        sendUpstream(head, e);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="DefaultChannelHandlerContext-java"><a href="#DefaultChannelHandlerContext-java" class="headerlink" title="DefaultChannelHandlerContext.java"></a>DefaultChannelHandlerContext.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private final <span class="class"><span class="keyword">class</span> <span class="title">DefaultChannelHandlerContext</span> <span class="title">implements</span> <span class="title">ChannelHandlerContext</span> </span>&#123;</span><br><span class="line"><span class="comment">//æœ‰nextå’Œprevæ¥ç»´æŠ¤é“¾è¡¨çš„å…³ç³»ã€‚</span></span><br><span class="line">        volatile DefaultChannelHandlerContext next;</span><br><span class="line">        volatile DefaultChannelHandlerContext prev;</span><br><span class="line">        private final <span class="built_in">String</span> name;</span><br><span class="line">        <span class="comment">//å°±æ˜¯å‰é¢çš„demoä¸­çš„encodehandlerå’Œdecodehandler</span></span><br><span class="line">        private final ChannelHandler handler;</span><br><span class="line">        private final boolean canHandleUpstream;</span><br><span class="line">        private final boolean canHandleDownstream;</span><br><span class="line">        private volatile <span class="built_in">Object</span> attachment;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šå°±æ˜¯é€šè¿‡ChannelHandlerContextå°è£…handlerå¯¹è±¡ï¼Œè®©handlerå’Œhandlerä¹‹é—´æœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å…³ç³»</p><h3 id="DefualtChannelPipeline-java"><a href="#DefualtChannelPipeline-java" class="headerlink" title="DefualtChannelPipeline.java"></a>DefualtChannelPipeline.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private DefaultChannelHandlerContext getActualUpstreamContext(DefaultChannelHandlerContext ctx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DefaultChannelHandlerContext realCtx = ctx;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­å¤´æŒ‡é’ˆæ˜¯ä¸æ˜¯ä¸€ä¸ªå¯ä»¥æ¥å—Upstreamçš„handler</span></span><br><span class="line">        <span class="keyword">while</span> (!realCtx.canHandleUpstream()) &#123;</span><br><span class="line">        <span class="comment">//ä¸æ˜¯çš„è¯å°±å¾€ä¸‹æ‰¾ï¼Œæ‰¾ä¸‹ä¸€ä¸ªå¯ä»¥æ¥å—Upstreamçš„handler</span></span><br><span class="line">            realCtx = realCtx.next;</span><br><span class="line">            <span class="keyword">if</span> (realCtx == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> realCtx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> sendUpstream(DefaultChannelHandlerContext ctx, ChannelEvent e) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ä»headé‡Œé¢å¾—åˆ°è¿™äº›handlerï¼Œç„¶åè°ƒç”¨è¿™äº›handlerçš„handleUpstreamæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œå½“å‰çš„ç±»ç»§æ‰¿è‡ªSimpleChannelUpstreamHandlerç±»ï¼Œæ‰€ä»¥å»è¿™ä¸ªç±»ä¸­çœ‹å…·ä½“å®ç°</span></span><br><span class="line">        <span class="comment">//SimpleChannelUpstreamHandleråœ¨ä¸‹é¢</span></span><br><span class="line">            ((ChannelUpstreamHandler) ctx.getHandler()).handleUpstream(ctx, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            notifyHandlerException(e, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬demoä¸­çš„StringDecoderå’ŒHellohandleræ˜¯å¯ä»¥æ¥å—Upstreamçš„ï¼Œä½†æ˜¯StringEncoderæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºimplements ChannelDownstreamHandlerï¼Œæ˜¯ä¸€ä¸ªä¸‹è¡Œçš„handler</p><h3 id="SimpleChannelUpstreamHandler-java"><a href="#SimpleChannelUpstreamHandler-java" class="headerlink" title="SimpleChannelUpstreamHandler.java"></a>SimpleChannelUpstreamHandler.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> handleUpstream(</span><br><span class="line">            ChannelHandlerContext ctx, ChannelEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MessageEvent) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯MessageEventï¼Œå°±æ‰§è¡ŒmessageReceivedæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//public void messageReceived(</span></span><br><span class="line">        <span class="comment">//    ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span></span><br><span class="line">        <span class="comment">//è°ƒç”¨å®Œäº†ä¹‹åæ¥ç€è°ƒç”¨sendUpstreamæ–¹æ³•</span></span><br><span class="line">        <span class="comment">// ctx.sendUpstream(e);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//public void sendUpstream(ChannelEvent e) &#123;</span></span><br><span class="line">          <span class="comment">//  DefaultChannelHandlerContext next = getActualUpstreamContext(this.next);</span></span><br><span class="line">         <span class="comment">//   if (next != null) &#123;</span></span><br><span class="line">         <span class="comment">//ä»å½“å‰èŠ‚ç‚¹å¾€ä¸‹æ‰¾ä¸‹ä¸€ä¸ªå¯ä»¥å¤„ç†sendUpstreamçš„handlerï¼Œç»§ç»­ä¼ é€’eäº‹ä»¶</span></span><br><span class="line">         <span class="comment">//       DefaultChannelPipeline.this.sendUpstream(next, e);</span></span><br><span class="line">          <span class="comment">//  &#125;</span></span><br><span class="line">       <span class="comment">// &#125;</span></span><br><span class="line">            messageReceived(ctx, (MessageEvent) e);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> WriteCompletionEvent) &#123;</span><br><span class="line">            WriteCompletionEvent evt = (WriteCompletionEvent) e;</span><br><span class="line">            writeComplete(ctx, evt);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ChildChannelStateEvent) &#123;</span><br><span class="line">            ChildChannelStateEvent evt = (ChildChannelStateEvent) e;</span><br><span class="line">            <span class="keyword">if</span> (evt.getChildChannel().isOpen()) &#123;</span><br><span class="line">                childChannelOpen(ctx, evt);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                childChannelClosed(ctx, evt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ChannelStateEvent) &#123;</span><br><span class="line">            ChannelStateEvent evt = (ChannelStateEvent) e;</span><br><span class="line">            <span class="keyword">switch</span> (evt.getState()) &#123;</span><br><span class="line">            <span class="keyword">case</span> OPEN:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">Boolean</span>.TRUE.equals(evt.getValue())) &#123;</span><br><span class="line">                    channelOpen(ctx, evt);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    channelClosed(ctx, evt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">          ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢è¿™æ®µä»£ç çŸ¥é“<br><strong><font color="red">handlerå¾€ä¸‹ä¼ é€’çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ sendUpstream ï¼Œåº”è¯¥ç»§æ‰¿SimpleChannelUpstreamHandler</font></strong></p><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>éªŒè¯ä¸Šé¢çš„ handlerå¾€ä¸‹ä¼ é€’çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ sendUpstream<br><strong><font color="red">è‡ªå·±å®šä¹‰handlerã€‚<br></font></strong></p><h3 id="Server-java"><a href="#Server-java" class="headerlink" title="Server.java"></a>Server.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™</span></span><br><span class="line">ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line">bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ç®¡é“çš„å·¥å‚</span></span><br><span class="line">bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line">pipeline.addLast(<span class="string">"handler1"</span>, <span class="keyword">new</span> MyHandler1());</span><br><span class="line">pipeline.addLast(<span class="string">"handler2"</span>, <span class="keyword">new</span> MyHandler2());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"start!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Handler1-java"><a href="#Handler1-java" class="headerlink" title="Handler1.java"></a>Handler1.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.UpstreamMessageEvent;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyHandler1</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelBuffer buffer = (ChannelBuffer)e.getMessage();</span><br><span class="line"></span><br><span class="line">byte[] array = buffer.array();</span><br><span class="line"><span class="built_in">String</span> message = <span class="keyword">new</span> <span class="built_in">String</span>(array);</span><br><span class="line">System.out.println(<span class="string">"handler1:"</span> + message);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¼ é€’</span></span><br><span class="line">ctx.sendUpstream(<span class="keyword">new</span> UpstreamMessageEvent(ctx.getChannel(), <span class="string">"abc"</span>, e.getRemoteAddress()));</span><br><span class="line">ctx.sendUpstream(<span class="keyword">new</span> UpstreamMessageEvent(ctx.getChannel(), <span class="string">"efg"</span>, e.getRemoteAddress()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Handler2-java"><a href="#Handler2-java" class="headerlink" title="Handler2.java"></a>Handler2.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyHandler2</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> message = (<span class="built_in">String</span>)e.getMessage();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"handler2:"</span> + message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-java"><a href="#Client-java" class="headerlink" title="Client.java"></a>Client.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, <span class="number">10101</span>);</span><br><span class="line"></span><br><span class="line">socket.getOutputStream().write(<span class="string">"hello"</span>.getBytes());</span><br><span class="line"></span><br><span class="line">socket.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">startï¼ï¼ï¼</span><br><span class="line">handler1ï¼šhello</span><br><span class="line">handler2ï¼šabc</span><br><span class="line">handler2ï¼šefg</span><br></pre></td></tr></table></figure><p>æ³¨æ„handler1ä¸­ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç å‘ä¸‹ä¼ é€’</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¼ é€’</span></span><br><span class="line">ctx.sendUpstream(<span class="keyword">new</span> UpstreamMessageEvent(ctx.getChannel(), <span class="string">"abc"</span>, e.getRemoteAddress()));</span><br><span class="line">ctx.sendUpstream(<span class="keyword">new</span> UpstreamMessageEvent(ctx.getChannel(), <span class="string">"efg"</span>, e.getRemoteAddress()));</span><br></pre></td></tr></table></figure><h1 id="è§‚å¯Ÿç²˜åŒ…ã€åˆ†åŒ…ç°è±¡ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚"><a href="#è§‚å¯Ÿç²˜åŒ…ã€åˆ†åŒ…ç°è±¡ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚" class="headerlink" title="è§‚å¯Ÿç²˜åŒ…ã€åˆ†åŒ…ç°è±¡ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚"></a>è§‚å¯Ÿç²˜åŒ…ã€åˆ†åŒ…ç°è±¡ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚</h1><p>ç²˜åŒ…å°±æ˜¯å®¢æˆ·ç«¯åˆ†åæ¬¡è¿›è¡Œä¼ é€’åä¸ªhelloï¼Œå¯æ˜¯å®¢æˆ·ç«¯ä¸€æ¬¡å°±è¾“å‡ºäº†ï¼Œæ‰€ä»¥ä¸èƒ½åˆ¤æ–­æ˜¯å‡ æ¬¡è¯·æ±‚ï¼Œç›¸å½“äºåªå¤„ç†äº†ä¸€æ¬¡</p><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><h3 id="Server-java-1"><a href="#Server-java-1" class="headerlink" title="Server.java"></a>Server.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™</span></span><br><span class="line">ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line">bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ç®¡é“çš„å·¥å‚</span></span><br><span class="line">bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line"><span class="comment">//pipeline.addLast("decoder", new MyDecoder());</span></span><br><span class="line">pipeline.addLast(<span class="string">"handler1"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"start!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HelloHandler-java"><a href="#HelloHandler-java" class="headerlink" title="HelloHandler.java"></a>HelloHandler.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelBuffer message = (ChannelBuffer)e.getMessage();</span><br><span class="line">byte[] array = message.arrage();</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="built_in">String</span> (array))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-java-1"><a href="#Client-java-1" class="headerlink" title="Client.java"></a>Client.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, <span class="number">10101</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span> message = <span class="string">"hello"</span>;</span><br><span class="line"></span><br><span class="line">byte[] bytes = message.getBytes();</span><br><span class="line"></span><br><span class="line"><span class="comment">//ByteBuffer buffer = ByteBuffer.allocate(4 + bytes.length);</span></span><br><span class="line"><span class="comment">//buffer.putInt(bytes.length);</span></span><br><span class="line"><span class="comment">//buffer.put(bytes);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//byte[] array = buffer.array();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for(int i=0; i&lt;1000; i++)&#123;</span></span><br><span class="line"><span class="comment">//socket.getOutputStream().write(array);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++)&#123;</span><br><span class="line">socket.getOutputStream().write(message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">socket.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º-1"><a href="#è¾“å‡º-1" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start!!!</span><br><span class="line">hellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohellohell</span><br><span class="line">ohellohellohellohellohellohellohellohellohellohellohellohe</span><br><span class="line">llohellohellohellohellohellohellohello</span><br><span class="line">hellohellohellohellohello</span><br></pre></td></tr></table></figure><p>å¦‚å›¾å°†å¾ˆå¤šè¯·æ±‚å½“åšä¸€æ¬¡è¯·æ±‚è¾“å‡ºï¼Œå°±æ˜¯ç²˜åŒ…ï¼Œåé¢å‡ è¡Œçš„è¡Œé¦–ä¸æ˜¯heå¼€å¤´çš„ï¼Œå°±æ˜¯è€Œæ˜¯ä¸Šä¸€è¡Œçš„è¡Œå°¾å’Œæœ¬è¡Œè¡Œé¦–åˆ†å¼€äº†ï¼Œå°±æ˜¯åˆ†åŒ…</p><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>å®šä¹‰ä¸€ä¸ªç¨³å®šçš„ç»“æ„ length + hello</p><h3 id="MyDecoder-java"><a href="#MyDecoder-java" class="headerlink" title="MyDecoder.java"></a>MyDecoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.frame.FrameDecoder;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyDecoder</span> <span class="keyword">extends</span> <span class="title">FrameDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> decode(ChannelHandlerContext ctx, Channel channel, ChannelBuffer buffer) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt; <span class="number">4</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™æ®µä»£ç æ˜¯ä¸ºäº†é˜²æ­¢å­—èŠ‚æµæ”»å‡»ï¼Œæœ¬æ–‡çš„ä¸‹é¢å°èŠ‚ä¸­ä¼šè®²åˆ°</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt; <span class="number">2048</span>)&#123;</span><br><span class="line">buffer.skipBytes(buffer.readableBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ‡è®°</span></span><br><span class="line">buffer.markReaderIndex();</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">int length = buffer.readInt();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; length)&#123;</span><br><span class="line">buffer.resetReaderIndex();</span><br><span class="line"><span class="comment">//ç¼“å­˜å½“å‰å‰©ä½™çš„bufferæ•°æ®ï¼Œç­‰å¾…å‰©ä¸‹æ•°æ®åŒ…åˆ°æ¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»æ•°æ®</span></span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[length];</span><br><span class="line">buffer.readBytes(bytes);</span><br><span class="line"><span class="comment">//å¾€ä¸‹ä¼ é€’å¯¹è±¡</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">String</span>(bytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç¼“å­˜å½“å‰å‰©ä½™çš„bufferæ•°æ®ï¼Œç­‰å¾…å‰©ä¸‹æ•°æ®åŒ…åˆ°æ¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜-1"><a href="#é—®é¢˜-1" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>1ã€ä¸ºä»€ä¹ˆFrameDecoder returnçš„å¯¹è±¡å°±æ˜¯å¾€ä¸‹ä¼ é€’çš„å¯¹è±¡</p><p>2ã€bufferé‡Œé¢æ•°æ®æœªè¢«è¯»å–å®Œæ€ä¹ˆåŠï¼Ÿ</p><p>3ã€ä¸ºä»€ä¹ˆreturn nullå°±å¯ä»¥ç¼“å­˜buffer</p><p>ä¼šåœ¨æœ¬æ–‡ç« çš„ä¸‹é¢çš„å°èŠ‚ä¸­è§£ç­”</p><h3 id="HelloHandler-java-1"><a href="#HelloHandler-java-1" class="headerlink" title="HelloHandler.java"></a>HelloHandler.java</h3><p>ä¸Šé¢çš„HelloHandlerä¿®æ”¹ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"><span class="comment">//ä¸ºäº†ç¡®å®šæ˜¯ä¸æ˜¯ä¸€æ¬¡ä¸€æ¬¡çš„è¯·æ±‚è¿‡æ¥çš„ï¼Œ</span></span><br><span class="line"><span class="comment">//å› ä¸ºpipelineä¸­å¤„ç†handlerçš„æ—¶é—´æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ—¶é—´</span></span><br><span class="line"><span class="comment">//ä¸ä¼šæ¶‰åŠåˆ°å¹¶å‘ï¼Œæ‰€ä»¥ç›´æ¥ç»™ä¸€ä¸ªç§æœ‰å˜é‡å³å¯ã€‚</span></span><br><span class="line"></span><br><span class="line">private int count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(e.getMessage() + <span class="string">"  "</span> +count);</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœ¨server-javaä¸­æ·»åŠ "><a href="#åœ¨server-javaä¸­æ·»åŠ " class="headerlink" title="åœ¨server.javaä¸­æ·»åŠ "></a>åœ¨server.javaä¸­æ·»åŠ </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> MyDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"handler1"</span>, <span class="keyword">new</span> HelloHandler());</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º-2"><a href="#è¾“å‡º-2" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">startï¼ï¼ï¼</span><br><span class="line">hello <span class="number">1</span></span><br><span class="line">hello <span class="number">2</span></span><br><span class="line">hello <span class="number">3</span></span><br><span class="line">hello <span class="number">4</span></span><br></pre></td></tr></table></figure><h1 id="æŸ¥çœ‹FramDecoderæºç ï¼ˆè§£å†³ä¸Šå°èŠ‚çš„ç–‘é—®ï¼‰"><a href="#æŸ¥çœ‹FramDecoderæºç ï¼ˆè§£å†³ä¸Šå°èŠ‚çš„ç–‘é—®ï¼‰" class="headerlink" title="æŸ¥çœ‹FramDecoderæºç ï¼ˆè§£å†³ä¸Šå°èŠ‚çš„ç–‘é—®ï¼‰"></a>æŸ¥çœ‹FramDecoderæºç ï¼ˆè§£å†³ä¸Šå°èŠ‚çš„ç–‘é—®ï¼‰</h1><p>FramDecoder ç»§æ‰¿SimpleChannelUpstreamHandler<br>ä¸Šé¢æåˆ°è¿›å…¥pipelineåç¬¬ä¸€ä¸ªå¤„ç†çš„æ–¹æ³•æ˜¯messageReceivedæ–¹æ³•</p><h2 id="FramDecoder"><a href="#FramDecoder" class="headerlink" title="FramDecoder"></a>FramDecoder</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public <span class="keyword">void</span> messageReceived(</span><br><span class="line">            ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Object</span> m = e.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (!(m <span class="keyword">instanceof</span> ChannelBuffer)) &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯channelbufferï¼Œä¸æ˜¯çš„è¯å°±å‘ä¸‹ä¼ é€’äº‹ä»¶</span></span><br><span class="line">            ctx.sendUpstream(e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ChannelBuffer input = (ChannelBuffer) m;</span><br><span class="line">        <span class="keyword">if</span> (!input.readable()) &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æœ‰æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œæ²¡æœ‰çš„è¯å°±ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œçš„cumulationå…¶å®å°±æ˜¯ä¸€ä¸ªç¼“å­˜çš„bufferå¯¹è±¡</span></span><br><span class="line"><span class="comment">//å‡å¦‚handlerä¸­return nullä¹‹åbufferä¸­æµ·æœ‰æ•°æ®ï¼Œå°±å­˜åˆ°è¿™é‡Œé¢</span></span><br><span class="line"><span class="comment">//å‡å¦‚è¯»å®Œä¹‹åï¼Œå¾€ä¸‹ä¼ é€’å¯¹è±¡ï¼Œä½†æ˜¯bufferä¸­è¿˜æœ‰æœªä¼ é€’å®Œçš„å¯¹è±¡ï¼Œä¹Ÿä¼šå°†æ•°æ®å­˜åˆ°é‡Œé¢</span></span><br><span class="line"><span class="comment">//å…¶å®        protected ChannelBuffer cumulation; æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªchannelbuffer</span></span><br><span class="line">        <span class="keyword">if</span> (cumulation == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// the cumulation buffer is not created yet so just pass the input to callDecode(...) method</span></span><br><span class="line">                <span class="comment">//ç¬¬ä¸€æ¬¡è¿›æ¥cumulationé‡Œé¢æ²¡æœ‰ç¼“å­˜çš„æ•°æ®è¿›å…¥callDecodeå¯¹è±¡ï¼Œå¾€ä¸‹é¢çœ‹</span></span><br><span class="line">                <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„input</span></span><br><span class="line">                <span class="comment">//è¿™ä¸ªæ–¹æ³•å…·ä½“å®ç°å¾€ä¸‹çœ‹</span></span><br><span class="line">                callDecode(ctx, e.getChannel(), input, e.getRemoteAddress());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//ç¼“å­˜æ•°æ®åˆ°cumulation</span></span><br><span class="line">                updateCumulation(ctx, input);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Cumulationä¸­æœ‰æ•°æ®ï¼Œå°±æŠŠæ–°çš„æ•°æ®æ·»åŠ åˆ°cumulationåé¢,å…·ä½“ä»£ç å¾€ä¸‹çœ‹</span></span><br><span class="line">            input = appendToCumulation(input);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å†æ¬¡è¿›å…¥callDecodeæ–¹æ³•</span></span><br><span class="line">                callDecode(ctx, e.getChannel(), input, e.getRemoteAddress());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                updateCumulation(ctx, input);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> private <span class="keyword">void</span> callDecode(</span><br><span class="line">            ChannelHandlerContext context, Channel channel,</span><br><span class="line">            ChannelBuffer cumulation, SocketAddress remoteAddress) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (cumulation.readable()) &#123;</span><br><span class="line">        <span class="comment">//é¦–å…ˆè®°å½•ä¸€ä¸‹è¯»æŒ‡é’ˆä½ç½®</span></span><br><span class="line">            int oldReaderIndex = cumulation.readerIndex();</span><br><span class="line">            <span class="comment">//ç„¶åæ‰§è¡Œdecodeæ–¹æ³•ï¼Œè¿™é‡Œçš„decodeæ–¹æ³•å°±æ˜¯æˆ‘æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„myDecoderç­‰æ–¹æ³•</span></span><br><span class="line">            <span class="comment">//å›ä¸€ä¸‹ä¹‹å‰è‡ªå®šä¹‰çš„ï¼Œå¦‚æœè¿›æ¥çš„æ•°æ®å°äºå››ä¸ªå­—èŠ‚ï¼Œç›´æ¥return nullï¼Œå¦‚æœé•¿åº¦ä¸å¤Ÿä¹Ÿreturn null</span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­é•¿åº¦ä¹‹åï¼Œè¯»ï¼Œè¯»å®Œä¹‹åbufferä¸­è¿˜æœ‰æ•°æ®ï¼Œreturn new Stringï¼ˆï¼‰ï¼›</span></span><br><span class="line">            <span class="comment">//çœ‹ä¸€ä¸‹è¿™é‡Œrenturnçš„å¯¹è±¡æ˜¯frame</span></span><br><span class="line">            <span class="built_in">Object</span> frame = decode(context, channel, cumulation);</span><br><span class="line">            <span class="keyword">if</span> (frame == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//é¦–å…ˆçœ‹æ—§çš„æŒ‡é’ˆå’Œç°åœ¨çš„æ˜¯ä¸æ˜¯ä¸€æ ·</span></span><br><span class="line">                <span class="keyword">if</span> (oldReaderIndex == cumulation.readerIndex()) &#123;</span><br><span class="line">                    <span class="comment">// Seems like more data is required.</span></span><br><span class="line">                    <span class="comment">// Let us wait for the next notification.</span></span><br><span class="line">                    <span class="comment">//æ˜¯çš„è¯å°±ä¸ç®¡äº†</span></span><br><span class="line">                    <span class="comment">//ç¬¬ä¸€æ¬¡returnäº†è¿”å›çœ‹ä¸Šé¢çš„ä»£ç </span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Previous data has been discarded.</span></span><br><span class="line">                    <span class="comment">// Probably it is reading on.</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„Handlerä¸æ˜¯return nullï¼Œå°±èµ°è¿™é‡Œ</span></span><br><span class="line">            <span class="comment">//å¦‚æœæ—§çš„æŒ‡é’ˆå’Œæ–°çš„æŒ‡é’ˆç›¸åŒçš„è¯ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="comment">//å¯æ˜¯æˆ‘ä»¬returnçš„æ˜¯ä¸€ä¸ªstringï¼Œæ‰€ä»¥è‚¯å®šä¸æ˜¯null</span></span><br><span class="line">            <span class="keyword">if</span> (oldReaderIndex == cumulation.readerIndex()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                        <span class="string">"decode() method must read at least one byte "</span> +</span><br><span class="line">                        <span class="string">"if it returned a frame (caused by: "</span> + getClass() + <span class="string">')'</span>);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//æ‰€ä»¥èµ°åˆ°äº†è¿™é‡Œï¼Œå…·ä½“ä»£ç å¾€ä¸‹çœ‹</span></span><br><span class="line">            unfoldAndFireMessageReceived(context, remoteAddress, frame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°±æ˜¯çœ‹inputé‡Œé¢è¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œæœ‰çš„è¯å°±æŠŠæ•°æ®åŠ åˆ°cumulationä¸­</span></span><br><span class="line">protected ChannelBuffer updateCumulation(ChannelHandlerContext ctx, ChannelBuffer input) &#123;</span><br><span class="line">        ChannelBuffer newCumulation;</span><br><span class="line">        int readableBytes = input.readableBytes();</span><br><span class="line">        <span class="keyword">if</span> (readableBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            int inputCapacity = input.capacity();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If input.readableBytes() == input.capacity() (i.e. input is full),</span></span><br><span class="line">            <span class="comment">// there's nothing to save from creating a new cumulation buffer</span></span><br><span class="line">            <span class="comment">// even if input.capacity() exceeds the threshold, because the new cumulation</span></span><br><span class="line">            <span class="comment">// buffer will have the same capacity and content with input.</span></span><br><span class="line">            <span class="keyword">if</span> (readableBytes &lt; inputCapacity &amp;&amp; inputCapacity &gt; copyThreshold) &#123;</span><br><span class="line">                <span class="comment">// At least one byte was consumed by callDecode() and input.capacity()</span></span><br><span class="line">                <span class="comment">// exceeded the threshold.</span></span><br><span class="line">                cumulation = newCumulation = newCumulationBuffer(ctx, input.readableBytes());</span><br><span class="line">                cumulation.writeBytes(input);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Nothing was consumed by callDecode() or input.capacity() did not</span></span><br><span class="line">                <span class="comment">// exceed the threshold.</span></span><br><span class="line">                <span class="keyword">if</span> (input.readerIndex() != <span class="number">0</span>) &#123;</span><br><span class="line">                    cumulation = newCumulation = input.slice();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cumulation = newCumulation = input;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cumulation = newCumulation = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newCumulation;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚è¿‡cumulationä¸­æœ‰æ•°æ®ï¼Œå°±æŠŠæ–°çš„æ•°æ®åŠ åˆ°åé¢ï¼Œè¿”å›ä¸Šé¢æ¥ç€çœ‹</span></span><br><span class="line"> protected ChannelBuffer appendToCumulation(ChannelBuffer input) &#123;</span><br><span class="line">        ChannelBuffer cumulation = <span class="keyword">this</span>.cumulation;</span><br><span class="line">        assert cumulation.readable();</span><br><span class="line">        <span class="keyword">if</span> (cumulation <span class="keyword">instanceof</span> CompositeChannelBuffer) &#123;</span><br><span class="line">            <span class="comment">// Make sure the resulting cumulation buffer has no more than the configured components.</span></span><br><span class="line">            CompositeChannelBuffer composite = (CompositeChannelBuffer) cumulation;</span><br><span class="line">            <span class="keyword">if</span> (composite.numComponents() &gt;= maxCumulationBufferComponents) &#123;</span><br><span class="line">                cumulation = composite.copy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.cumulation = input = ChannelBuffers.wrappedBuffer(cumulation, input);</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> protected final <span class="keyword">void</span> unfoldAndFireMessageReceived(</span><br><span class="line">            ChannelHandlerContext context, SocketAddress remoteAddress, <span class="built_in">Object</span> result) &#123;</span><br><span class="line">        <span class="keyword">if</span> (unfold) &#123;</span><br><span class="line">        <span class="comment">//resultå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„frameï¼Œå°±æ˜¯è‡ªå®šä¹‰çš„handlerä¸­çš„return åé¢çš„å€¼ï¼ˆèµ°åˆ°è¿™æ­¥è¯´æ˜returnè‚¯å®šä¸æ˜¯nullï¼‰</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯æ•°ç»„</span></span><br><span class="line">            <span class="keyword">if</span> (result <span class="keyword">instanceof</span> <span class="built_in">Object</span>[]) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">Object</span> r: (<span class="built_in">Object</span>[]) result) &#123;</span><br><span class="line">                    Channels.fireMessageReceived(context, r, remoteAddress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Iterable&lt;?&gt;) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">Object</span> r: (Iterable&lt;?&gt;) result) &#123;</span><br><span class="line">                    Channels.fireMessageReceived(context, r, remoteAddress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//fireMessageReceivedæ–¹æ³•å¾€ä¸‹çœ‹ï¼Œå…¶å®è¿˜æ˜¯æ‰§è¡Œäº†sendUpStreamæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¾€ä¸‹ä¼ ã€‚</span></span><br><span class="line">                Channels.fireMessageReceived(context, result, remoteAddress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Channels.fireMessageReceived(context, result, remoteAddress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> fireMessageReceived(</span><br><span class="line">            ChannelHandlerContext ctx, <span class="built_in">Object</span> message, SocketAddress remoteAddress) &#123;</span><br><span class="line">        ctx.sendUpstream(<span class="keyword">new</span> UpstreamMessageEvent(</span><br><span class="line">                ctx.getChannel(), message, remoteAddress));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="ç­”æ¡ˆ"><a href="#ç­”æ¡ˆ" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h2><p>1ã€ä¸ºä»€ä¹ˆFrameDecoder returnçš„å¯¹è±¡å°±æ˜¯å¾€ä¸‹ä¼ é€’çš„å¯¹è±¡ ï¼ˆè¿˜æ˜¯è°ƒç”¨äº†sendUpstreamï¼‰</p><p>2ã€bufferé‡Œé¢æ•°æ®æœªè¢«è¯»å–å®Œæ€ä¹ˆåŠï¼Ÿ ï¼ˆcumulationç¼“å­˜ï¼‰</p><p>3ã€ä¸ºä»€ä¹ˆreturn nullå°±å¯ä»¥ç¼“å­˜buffer ï¼ˆcumulationç¼“å­˜ï¼‰</p><h1 id="å¦‚ä½•é¿å…socketæ”»å‡»"><a href="#å¦‚ä½•é¿å…socketæ”»å‡»" class="headerlink" title="å¦‚ä½•é¿å…socketæ”»å‡»"></a>å¦‚ä½•é¿å…socketæ”»å‡»</h1><p>ä¸Šé¢çš„é•¿åº¦åŠ å†…å®¹çš„æ–¹å¼è¿˜æ˜¯æœ‰é—®é¢˜çš„<br>æ¯”å¦‚å®¢æˆ·ç«¯å‘é€çš„æ•°æ® é•¿åº¦æ˜¯8ï¼Œå¯æ˜¯çœŸæ­£å‘é€äº†10ä¸ªå­—èŠ‚ã€‚<br>æˆ–è€…å®¢æˆ·ç«¯å‘é€äº†Integer.Maxä¸ªå­—èŠ‚ï¼Œæ¯æ¬¡åˆ¤æ–­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; length)&#123;</span><br><span class="line">buffer.resetReaderIndex();</span><br><span class="line"><span class="comment">//ç¼“å­˜å½“å‰å‰©ä½™çš„bufferæ•°æ®ï¼Œç­‰å¾…å‰©ä¸‹æ•°æ®åŒ…åˆ°æ¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡éƒ½æ˜¯åˆ¤æ–­ï¼Œä¸æ–­çš„ç½‘ç¼“å­˜é‡Œé¢ç”Ÿäº§æ•°æ®åŒ…ï¼ŒçŸ¥é“å†…å­˜ä¸å¤Ÿï¼Œå®•æœº</p><p>æŠŠé•¿åº¦å®šä¹‰çš„å¾ˆå¤§ï¼Œè¿™ç§æ•°æ®åŒ…ï¼Œé€šå¸¸è¢«ç§°ä¸ºsocketæ”»å‡»ï¼Œå­—èŠ‚æµå¼æ”»å‡»</p><h2 id="è§£å†³ï¼ˆğŸŒ°ï¼‰"><a href="#è§£å†³ï¼ˆğŸŒ°ï¼‰" class="headerlink" title="è§£å†³ï¼ˆğŸŒ°ï¼‰"></a>è§£å†³ï¼ˆğŸŒ°ï¼‰</h2><p>å¯ä»¥é€šè¿‡æ¸…é™¤ç¼“å­˜çš„æ–¹å¼ï¼Œå¯æ˜¯å› ä¸ºæ¸…é™¤äº†æ•°æ®ä¹‹åï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç°åˆ†åŒ…æˆªæ–­çš„ç°è±¡ï¼Œä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™ï¼Œå¯èƒ½ä¸æ˜¯å¼€å¤´ï¼Œæ‰€ä»¥ä¸èƒ½çŸ¥é“å“ªä¸ªæ˜¯é•¿åº¦ï¼Œå“ªä¸ªæ˜¯æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦åŒ…å¤´ï¼Œåªæœ‰å½“æ—¶è¯»åˆ°åŒ…å¤´çš„æ—¶å€™æ‰ç»§ç»­å¾€ä¸‹èµ°ã€‚</p><h3 id="ResponseDecoder-java"><a href="#ResponseDecoder-java" class="headerlink" title="ResponseDecoder.java"></a>ResponseDecoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.codc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.frame.FrameDecoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.constant.ConstantValue;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * responseè§£ç å™¨</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…æ ¼å¼</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·       |  çŠ¶æ€ç     |  é•¿åº¦          |   æ•°æ®       |</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´4å­—èŠ‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å—å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> -</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ResponseDecoder</span> <span class="keyword">extends</span> <span class="title">FrameDecoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…åŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int BASE_LENTH = <span class="number">4</span> + <span class="number">2</span> + <span class="number">2</span> + <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> decode(ChannelHandlerContext arg0, Channel arg1, ChannelBuffer buffer) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯è¯»é•¿åº¦å¿…é¡»å¤§äºåŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt;= BASE_LENTH)&#123;</span><br><span class="line"><span class="comment">//é˜²æ­¢å­—èŠ‚æµæ”»å‡»</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes()&gt;<span class="number">2048</span>)&#123;</span><br><span class="line"><span class="comment">//æ¸…é™¤ç¼“å­˜ä¸­çš„æ•°æ®</span></span><br><span class="line">buffer.skipBytes(buffer.readableBytes());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è®°å½•åŒ…å¤´å¼€å§‹çš„index</span></span><br><span class="line">int beginReader ï¼›</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">beginReader = buffer.readerIndex();</span><br><span class="line"><span class="comment">//æ ‡è®°å½“å‰ç´¢å¼•</span></span><br><span class="line">buffer.markReaderIndex();</span><br><span class="line"><span class="comment">//åˆ¤æ–­åŒ…å¤´æ˜¯å¦æ˜¯å½“å‰çš„åŒ…å¤´</span></span><br><span class="line"><span class="comment">//å› ä¸ºæ¸…é™¤äº†æ•°æ®ä¹‹åï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç°åˆ†åŒ…æˆªæ–­çš„ç°è±¡ï¼Œä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™ï¼Œ</span></span><br><span class="line"><span class="comment">//å¯èƒ½ä¸æ˜¯å¼€å¤´ï¼Œæ‰€ä»¥ä¸èƒ½çŸ¥é“å“ªä¸ªæ˜¯é•¿åº¦ï¼Œå“ªä¸ªæ˜¯æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦åŒ…å¤´ï¼Œ</span></span><br><span class="line"><span class="comment">//åªæœ‰å½“æ—¶è¯»åˆ°åŒ…å¤´çš„æ—¶å€™æ‰ç»§ç»­å¾€ä¸‹èµ°ã€‚</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readInt() == ConstantValue.FLAG)&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æœªè¯»åˆ°åŒ…å¤´è¶…è¿‡äº†ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">buffer.resetReaderIndex();</span><br><span class="line"><span class="comment">//å› ä¸ºå¯èƒ½è¯»ä¸€ä¸ªintä¹‹åï¼Œç•¥è¿‡äº†åŒ…å¤´ï¼Œå› ä¸ºå¯èƒ½åŒ…å¤´åœ¨ç¬¬ä¸€ä¸ªå­—èŠ‚å¤„</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥è¿™é‡Œé€‰æ‹©ç»§ç»­å¾€ä¸‹è¯»ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">buffer.readByte();</span><br><span class="line"><span class="comment">//å¯èƒ½å‡ºç°æç«¯çš„æƒ…å†µï¼Œé•¿åº¦åˆå˜å¾—ä¸æ»¡è¶³</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes()&lt;BASE_LENGTH)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡å—å·</span></span><br><span class="line">short <span class="built_in">module</span> = buffer.readShort();</span><br><span class="line"><span class="comment">//å‘½ä»¤å·</span></span><br><span class="line">short cmd = buffer.readShort();</span><br><span class="line"><span class="comment">//çŠ¶æ€ç </span></span><br><span class="line">int stateCode = buffer.readInt();</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">int length = buffer.readInt();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; length)&#123;</span><br><span class="line"><span class="comment">//è¿˜åŸè¯»æŒ‡é’ˆ</span></span><br><span class="line">buffer.readerIndex(beginReader);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte[] data = <span class="keyword">new</span> byte[length];</span><br><span class="line">buffer.readBytes(data);</span><br><span class="line"></span><br><span class="line">Response response = <span class="keyword">new</span> Response();</span><br><span class="line">response.setModule(<span class="built_in">module</span>);</span><br><span class="line">response.setCmd(cmd);</span><br><span class="line">response.setStateCode(stateCode);</span><br><span class="line">response.setData(data);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»§ç»­å¾€ä¸‹ä¼ é€’ </span></span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ•°æ®åŒ…ä¸å®Œæ•´ï¼Œéœ€è¦ç­‰å¾…åé¢çš„åŒ…æ¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;é—®é¢˜&quot;&gt;&lt;a href=&quot;#é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜&quot;&gt;&lt;/a&gt;é—®é¢˜&lt;/h
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆåï¼‰ï¼šè‡ªå®šä¹‰æ•°æ®åŒ…åè®®</title>
    <link href="http://mmmmmm.me/2019-03-10-10.html"/>
    <id>http://mmmmmm.me/2019-03-10-10.html</id>
    <published>2019-03-10T02:21:10.000Z</published>
    <updated>2019-03-10T15:09:15.833Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="æ•°æ®åŒ…ç®€ä»‹"><a href="#æ•°æ®åŒ…ç®€ä»‹" class="headerlink" title="æ•°æ®åŒ…ç®€ä»‹"></a>æ•°æ®åŒ…ç®€ä»‹</h1><h2 id="ç²˜åŒ…ã€åˆ†åŒ…ç°è±¡"><a href="#ç²˜åŒ…ã€åˆ†åŒ…ç°è±¡" class="headerlink" title="ç²˜åŒ…ã€åˆ†åŒ…ç°è±¡"></a>ç²˜åŒ…ã€åˆ†åŒ…ç°è±¡</h2><p>å‡å¦‚å®¢æˆ·ç«¯éœ€è¦ç»™æœåŠ¡ç«¯å‘é€æ•°æ®<br>give me a coffee give me a tea<br>å¯èƒ½ä¼šå‡ºç°ç²˜åŒ…æˆ–è€…åˆ†åŒ…çš„ç°è±¡</p><ul><li>ç²˜åŒ…ç°è±¡<br>give me a coffeegive me a tea</li><li><p>åˆ†åŒ…ç°è±¡<br>give me<br>a coffeegive me a tea</p><p>ç²˜åŒ…å’Œåˆ†åŒ…å‡ºç°çš„åŸå› æ˜¯ï¼šæ²¡æœ‰ä¸€ä¸ªç¨³å®šæ•°æ®ç»“æ„ï¼Œè§£å†³æ–¹æ³•æ¯”å¦‚</p></li><li>åˆ†å‰²ç¬¦<br>give me a coffee|give me a tea|<br>give me a coffee|<br>give me a tea|<ul><li>é•¿åº¦ + æ•°æ®<br>16give me a coffee13give me a tea<br>16give me a coffee<br>13give me a tea<h2 id="æ•°æ®åŒ…æ ¼å¼"><a href="#æ•°æ®åŒ…æ ¼å¼" class="headerlink" title="æ•°æ®åŒ…æ ¼å¼"></a>æ•°æ®åŒ…æ ¼å¼</h2>+â€”â€”â€”-â€”â€”+â€”â€”â€”â€“â€”â€”+â€”â€”â€”-â€”â€”+â€”â€”â€”-â€”â€”+â€”â€”â€”â€“â€”â€”+<br>| åŒ…å¤´ | æ¨¡å—å· | å‘½ä»¤å· | é•¿åº¦ | æ•°æ® |<br>+â€”â€”â€”-â€”â€”+â€”â€”â€”â€“â€”â€”+â€”â€”â€”-â€”â€”+â€”â€”â€”-â€”â€”+â€”â€”â€”â€“â€”â€”+<br>åŒ…å¤´4å­—èŠ‚ ï¼ˆä¸€äº›ä¸å¸¸ç”¨çš„ä¸œè¥¿ï¼‰<br>æ¨¡å—å·2å­—èŠ‚shortï¼ˆPlayer 1å·ï¼‰<br>å‘½ä»¤å·2å­—èŠ‚shortï¼ˆPlayerè¦åšçš„äº‹æƒ…ï¼Œæ¯”å¦‚è·å–ç©å®¶æ•°æ® 1å·ï¼‰<br>é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)<br>Player 1<br>1 è·å–ç©å®¶æ•°æ®<br>2 æ³¨å†Œç”¨æˆ·<br>3 è´­ä¹°é‡‘å¸</li></ul></li></ul><h1 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h1><p>éœ€è¦çš„jarï¼šnetty-3.10.5.final.jar</p><h2 id="Commoné¡¹ç›®"><a href="#Commoné¡¹ç›®" class="headerlink" title="Commoné¡¹ç›®"></a>Commoné¡¹ç›®</h2><p>æ–°å»ºé¡¹ç›®Common==ã€‹æ–°å»ºåŒ…modelã€ moduleã€codcã€constantã€serial==&gt;modelåŒ…ä¸‹æ–°å»ºRequest.java</p><h3 id="Request-java"><a href="#Request-java" class="headerlink" title="Request.java"></a>Request.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.model;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚æ¨¡å—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private short <span class="built_in">module</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private short cmd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®éƒ¨åˆ†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private byte[] data;</span><br><span class="line"></span><br><span class="line">public short getModule() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setModule(short <span class="built_in">module</span>) &#123;</span><br><span class="line"><span class="keyword">this</span>.module = <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public short getCmd() &#123;</span><br><span class="line"><span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setCmd(short cmd) &#123;</span><br><span class="line"><span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public byte[] getData() &#123;</span><br><span class="line"><span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setData(byte[] data) &#123;</span><br><span class="line"><span class="keyword">this</span>.data = data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public int getDataLength()&#123;</span><br><span class="line"><span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> data.length;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>constantåŒ…ä¸‹æ–°å»º</p><h3 id="ConstantValue-java"><a href="#ConstantValue-java" class="headerlink" title="ConstantValue.java"></a>ConstantValue.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.constant;</span><br><span class="line"></span><br><span class="line">public interface ConstantValue &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´,åŒ…å¤´æ˜¯ä¸€ä¸ªå¸¸é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> final int FLAG = <span class="number">-32523523</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>codcåŒ…ä¸‹æ–°å»ºRequestDecoder.javaå’ŒRequestEncoder.java</p><h3 id="RequestEncoder-java"><a href="#RequestEncoder-java" class="headerlink" title="RequestEncoder.java"></a>RequestEncoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.codc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.oneone.OneToOneEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.constant.ConstantValue;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Request;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚ç¼–ç å™¨</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…æ ¼å¼</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·      |  é•¿åº¦        |   æ•°æ®       |</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´4å­—èŠ‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å—å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RequestEncoder</span> <span class="keyword">extends</span> <span class="title">OneToOneEncoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> encode(ChannelHandlerContext context, Channel channel, <span class="built_in">Object</span> rs) throws Exception &#123;</span><br><span class="line">Request request = (Request)(rs);</span><br><span class="line"></span><br><span class="line">ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();</span><br><span class="line"><span class="comment">//åŒ…å¤´</span></span><br><span class="line">buffer.writeInt(ConstantValue.FLAG);</span><br><span class="line"><span class="comment">//module</span></span><br><span class="line">buffer.writeShort(request.getModule());</span><br><span class="line"><span class="comment">//cmd</span></span><br><span class="line">buffer.writeShort(request.getCmd());</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">buffer.writeInt(request.getDataLength());</span><br><span class="line"><span class="comment">//data</span></span><br><span class="line"><span class="keyword">if</span>(request.getData() != <span class="literal">null</span>)&#123;</span><br><span class="line">buffer.writeBytes(request.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RequestDecoder-java"><a href="#RequestDecoder-java" class="headerlink" title="RequestDecoder.java"></a>RequestDecoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.codc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.frame.FrameDecoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.constant.ConstantValue;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Request;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚è§£ç å™¨</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…æ ¼å¼</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·      |  é•¿åº¦        |   æ•°æ®       |</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´4å­—èŠ‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å—å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//FrameDecoderå¯ä»¥ååŠ©æˆ‘ä»¬è§£å†³ç²˜åŒ…åˆ†åŒ…çš„é—®é¢˜</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RequestDecoder</span> <span class="keyword">extends</span> <span class="title">FrameDecoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…åŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int BASE_LENTH = <span class="number">4</span> + <span class="number">2</span> + <span class="number">2</span> + <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> decode(ChannelHandlerContext arg0, Channel arg1, ChannelBuffer buffer) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯è¯»é•¿åº¦å¿…é¡»å¤§äºåŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt;= BASE_LENTH)&#123;</span><br><span class="line"><span class="comment">//é˜²æ­¢socketå­—èŠ‚æµæ”»å‡»</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt; <span class="number">2048</span>)&#123;</span><br><span class="line">buffer.skipBytes(buffer.readableBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•åŒ…å¤´å¼€å§‹çš„index</span></span><br><span class="line">int beginReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">beginReader = buffer.readerIndex();</span><br><span class="line">buffer.markReaderIndex();</span><br><span class="line"><span class="keyword">if</span>(buffer.readInt() == ConstantValue.FLAG)&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœªè¯»åˆ°åŒ…å¤´ï¼Œç•¥è¿‡ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">buffer.resetReaderIndex();</span><br><span class="line">buffer.readByte();</span><br><span class="line"></span><br><span class="line"><span class="comment">//é•¿åº¦åˆå˜å¾—ä¸æ»¡è¶³</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; BASE_LENTH)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡å—å·</span></span><br><span class="line">short <span class="built_in">module</span> = buffer.readShort();</span><br><span class="line"><span class="comment">//å‘½ä»¤å·</span></span><br><span class="line">short cmd = buffer.readShort();</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">int length = buffer.readInt();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­è¯·æ±‚æ•°æ®åŒ…æ•°æ®æ˜¯å¦åˆ°é½</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; length)&#123;</span><br><span class="line"><span class="comment">//è¿˜åŸè¯»æŒ‡é’ˆåˆ°æœ€å¼€å§‹çš„åœ°æ–¹</span></span><br><span class="line">buffer.readerIndex(beginReader);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–dataæ•°æ®</span></span><br><span class="line">byte[] data = <span class="keyword">new</span> byte[length];</span><br><span class="line">buffer.readBytes(data);</span><br><span class="line"></span><br><span class="line">Request request = <span class="keyword">new</span> Request();</span><br><span class="line">request.setModule(<span class="built_in">module</span>);</span><br><span class="line">request.setCmd(cmd);</span><br><span class="line">request.setData(data);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»§ç»­å¾€ä¸‹ä¼ é€’ </span></span><br><span class="line"><span class="keyword">return</span> request;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ•°æ®åŒ…ä¸å®Œæ•´ï¼Œéœ€è¦ç­‰å¾…åé¢çš„åŒ…æ¥,(buffer.readableBytes() &lt; BASE_LENTH</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ChannelBuffer writeindexå’Œreadindex<br>wirteindexåˆå§‹å€¼æ˜¯0ï¼Œå½“å†™ä¸€ä¸ªintï¼Œwirteindexå°±æ˜¯4<br>readindexåŒä¸Š<br>ä½†æ˜¯æ³¨æ„readindexæ˜¯ä¸èƒ½è¶…è¿‡writeindexçš„</p><p>modleåŒ…ä¸‹æ–°å»º</p><h3 id="Response-java"><a href="#Response-java" class="headerlink" title="Response.java"></a>Response.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.model;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- è¿”å›å¯¹è±¡</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - è¯·æ±‚æ¨¡å—</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private short <span class="built_in">module</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å‘½ä»¤å·</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private short cmd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private int stateCode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ•°æ®éƒ¨åˆ†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private byte[] data;</span><br><span class="line"></span><br><span class="line">  public short getModule() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setModule(short <span class="built_in">module</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.module = <span class="built_in">module</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public short getCmd() &#123;</span><br><span class="line">  <span class="keyword">return</span> cmd;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setCmd(short cmd) &#123;</span><br><span class="line">  <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public int getStateCode() &#123;</span><br><span class="line">  <span class="keyword">return</span> stateCode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setStateCode(int stateCode) &#123;</span><br><span class="line">  <span class="keyword">this</span>.stateCode = stateCode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public byte[] getData() &#123;</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setData(byte[] data) &#123;</span><br><span class="line">  <span class="keyword">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public int getDataLength()&#123;</span><br><span class="line">  <span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data.length;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>modelä¸‹æ–°å»º</p><h3 id="StateCode-javaï¼Œresponseçš„çŠ¶æ€ç "><a href="#StateCode-javaï¼Œresponseçš„çŠ¶æ€ç " class="headerlink" title="StateCode.javaï¼Œresponseçš„çŠ¶æ€ç "></a>StateCode.javaï¼Œresponseçš„çŠ¶æ€ç </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.model;</span><br><span class="line"></span><br><span class="line">public interface StateCode &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆåŠŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int SUCCESS  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int FAIL  =  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>codcåŒ…ä¸‹æ–°å»ºResponseEncoder.javaå’ŒResponseDecoder.java</p><h3 id="ResponseEncoder-java"><a href="#ResponseEncoder-java" class="headerlink" title="ResponseEncoder.java"></a>ResponseEncoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.codc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.oneone.OneToOneEncoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.constant.ConstantValue;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚ç¼–ç å™¨</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…æ ¼å¼</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·       |  çŠ¶æ€ç     |  é•¿åº¦          |   æ•°æ®       |</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´4å­—èŠ‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å—å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ResponseEncoder</span> <span class="keyword">extends</span> <span class="title">OneToOneEncoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> encode(ChannelHandlerContext context, Channel channel, <span class="built_in">Object</span> rs) throws Exception &#123;</span><br><span class="line">Response response = (Response)(rs);</span><br><span class="line"></span><br><span class="line">ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();</span><br><span class="line"><span class="comment">//åŒ…å¤´</span></span><br><span class="line">buffer.writeInt(ConstantValue.FLAG);</span><br><span class="line"><span class="comment">//module</span></span><br><span class="line">buffer.writeShort(response.getModule());</span><br><span class="line"><span class="comment">//cmd</span></span><br><span class="line">buffer.writeShort(response.getCmd());</span><br><span class="line"><span class="comment">//çŠ¶æ€ç </span></span><br><span class="line">buffer.writeInt(response.getStateCode());</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">buffer.writeInt(response.getDataLength());</span><br><span class="line"><span class="comment">//data</span></span><br><span class="line"><span class="keyword">if</span>(response.getData() != <span class="literal">null</span>)&#123;</span><br><span class="line">buffer.writeBytes(response.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ResponseDecoder-java"><a href="#ResponseDecoder-java" class="headerlink" title="ResponseDecoder.java"></a>ResponseDecoder.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.codc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.frame.FrameDecoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.constant.ConstantValue;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * responseè§£ç å™¨</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…æ ¼å¼</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·       |  çŠ¶æ€ç     |  é•¿åº¦          |   æ•°æ®       |</span></span><br><span class="line"><span class="comment"> * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * åŒ…å¤´4å­—èŠ‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å—å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * å‘½ä»¤å·2å­—èŠ‚short</span></span><br><span class="line"><span class="comment"> * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> -</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ResponseDecoder</span> <span class="keyword">extends</span> <span class="title">FrameDecoder</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ®åŒ…åŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int BASE_LENTH = <span class="number">4</span> + <span class="number">2</span> + <span class="number">2</span> + <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="built_in">Object</span> decode(ChannelHandlerContext arg0, Channel arg1, ChannelBuffer buffer) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯è¯»é•¿åº¦å¿…é¡»å¤§äºåŸºæœ¬é•¿åº¦</span></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &gt;= BASE_LENTH)&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®°å½•åŒ…å¤´å¼€å§‹çš„index</span></span><br><span class="line">int beginReader = buffer.readerIndex();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(buffer.readInt() == ConstantValue.FLAG)&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡å—å·</span></span><br><span class="line">short <span class="built_in">module</span> = buffer.readShort();</span><br><span class="line"><span class="comment">//å‘½ä»¤å·</span></span><br><span class="line">short cmd = buffer.readShort();</span><br><span class="line"><span class="comment">//çŠ¶æ€ç </span></span><br><span class="line">int stateCode = buffer.readInt();</span><br><span class="line"><span class="comment">//é•¿åº¦</span></span><br><span class="line">int length = buffer.readInt();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(buffer.readableBytes() &lt; length)&#123;</span><br><span class="line"><span class="comment">//è¿˜åŸè¯»æŒ‡é’ˆ</span></span><br><span class="line">buffer.readerIndex(beginReader);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte[] data = <span class="keyword">new</span> byte[length];</span><br><span class="line">buffer.readBytes(data);</span><br><span class="line"></span><br><span class="line">Response response = <span class="keyword">new</span> Response();</span><br><span class="line">response.setModule(<span class="built_in">module</span>);</span><br><span class="line">response.setCmd(cmd);</span><br><span class="line">response.setStateCode(stateCode);</span><br><span class="line">response.setData(data);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»§ç»­å¾€ä¸‹ä¼ é€’ </span></span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ•°æ®åŒ…ä¸å®Œæ•´ï¼Œéœ€è¦ç­‰å¾…åé¢çš„åŒ…æ¥</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š <strong><font color="red">ä¸Šé¢çš„ä»£ç åœ¨é‡åˆ°socketå­—èŠ‚æµæ”»å‡»çš„æ—¶å€™ä¼šæœ‰å¼‚å¸¸ï¼ŒåŒ…æ‹¬ä¸ºä»€ä¹ˆéœ€è¦åŒ…å¤´ï¼Œä¼šåœ¨ä¸‹é¢ä¸€èŠ‚ä¸­çš„æœ€åè¿›è¡Œè®²è§£</font></strong></p><p>æ–°å»ºserialåŒ…==ã€‹å°†ä¸ŠèŠ‚æœ€åçš„ä¸¤ä¸ªåºåˆ—åŒ–çš„å·¥å…·ç±»ç²˜è´´è¿‡æ¥ï¼ˆBufferFactory.javaå’ŒSerializer.javaï¼‰<br>modelåŒ…ä¸‹æ–°å»ºfubenåŒ…==ã€‹æ–°å»ºå’ŒrequeståŒ…å’ŒresponseåŒ…==ã€‹requeståŒ…ä¸‹æ–°å»ºFightRequest.java==ã€‹responseåŒ…ä¸‹æ–°å»ºFightResponse.java<br>è¿™é‡Œçš„å‰¯æœ¬ç®€å•ç†è§£ä¸ºæ‰“æ¸¸æˆåˆ·çš„å‰¯æœ¬è¿™ä¸ªå¯¹è±¡</p><h2 id="FightRequest-java"><a href="#FightRequest-java" class="headerlink" title="FightRequest.java"></a>FightRequest.java</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.module.fuben.request;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.serial.Serializer;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FightRequest</span> <span class="keyword">extends</span> <span class="title">Serializer</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰¯æœ¬id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private int fubenId;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private int count;</span><br><span class="line"></span><br><span class="line">public int getFubenId() &#123;</span><br><span class="line"><span class="keyword">return</span> fubenId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setFubenId(int fubenId) &#123;</span><br><span class="line"><span class="keyword">this</span>.fubenId = fubenId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int getCount() &#123;</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setCount(int count) &#123;</span><br><span class="line"><span class="keyword">this</span>.count = count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> read() &#123;</span><br><span class="line"><span class="keyword">this</span>.fubenId = readInt();</span><br><span class="line"><span class="keyword">this</span>.count = readInt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> write() &#123;</span><br><span class="line">writeInt(fubenId);</span><br><span class="line">writeInt(count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Clienté¡¹ç›®"><a href="#Clienté¡¹ç›®" class="headerlink" title="Clienté¡¹ç›®"></a>Clienté¡¹ç›®</h2><p>æ–°å»ºClienté¡¹ç›®ï¼Œå°†ä¹‹å‰clientä»£ç æ‹·è´è¿‡æ¥</p><h3 id="Client-java"><a href="#Client-java" class="headerlink" title="Client.java"></a>Client.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ClientBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> com.cn.codc.RequestEncoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.codc.ResponseDecoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Request;</span><br><span class="line"><span class="keyword">import</span> com.cn.module.fuben.request.FightRequest;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nettyå®¢æˆ·ç«¯å…¥é—¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ClientBootstrap bootstrap = <span class="keyword">new</span>  ClientBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">//socketå·¥å‚</span></span><br><span class="line">bootstrap.setFactory(<span class="keyword">new</span> NioClientSocketChannelFactory(boss, worker));</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç®¡é“å·¥å‚</span></span><br><span class="line">bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line"><span class="comment">//ä¿®æ”¹ä¸ºåˆšåˆšå†™çš„ResponseEncoderå’ŒRequestEndoder</span></span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> ResponseDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> RequestEncoder());</span><br><span class="line">pipeline.addLast(<span class="string">"hiHandler"</span>, <span class="keyword">new</span> HiHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿æ¥æœåŠ¡ç«¯</span></span><br><span class="line">ChannelFuture connect = bootstrap.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">10101</span>));</span><br><span class="line">Channel channel = connect.sync().getChannel();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"client start"</span>);</span><br><span class="line"></span><br><span class="line">Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">System.out.println(<span class="string">"è¯·è¾“å…¥"</span>);</span><br><span class="line">int fubenId = Integer.parseInt(scanner.nextLine());</span><br><span class="line">int count = Integer.parseInt(scanner.nextLine());</span><br><span class="line"></span><br><span class="line">FightRequest fightRequest = <span class="keyword">new</span> FightRequest();</span><br><span class="line">fightRequest.setFubenId(fubenId);</span><br><span class="line">fightRequest.setCount(count);</span><br><span class="line"></span><br><span class="line">Request request = <span class="keyword">new</span> Request();</span><br><span class="line">request.setModule((short) <span class="number">1</span>);</span><br><span class="line">request.setCmd((short) <span class="number">1</span>);</span><br><span class="line">request.setData(fightRequest.getBytes());</span><br><span class="line"><span class="comment">//å‘é€è¯·æ±‚</span></span><br><span class="line">channel.write(request);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„å˜åŒ–æ˜¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¿®æ”¹ä¸ºåˆšåˆšå†™çš„ResponseEncoderå’ŒRequestEndoder</span></span><br><span class="line"><span class="comment">//responseè§£ç </span></span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> ResponseDecoder());</span><br><span class="line"><span class="comment">//requsetç¼–ç </span></span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> RequestEncoder());</span><br><span class="line">pipeline.addLast(<span class="string">"hiHandler"</span>, <span class="keyword">new</span> HiHandler());</span><br></pre></td></tr></table></figure><p>å’Œæœ€åå˜æˆå‘é€requst</p><h3 id="HiHandler-java"><a href="#HiHandler-java" class="headerlink" title="HiHandler.java"></a>HiHandler.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelStateEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ExceptionEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.model.Response;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.StateCode;</span><br><span class="line"><span class="keyword">import</span> com.cn.module.fuben.request.FightRequest;</span><br><span class="line"><span class="keyword">import</span> com.cn.module.fuben.response.FightResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯æ¥å—å¤„ç†ç±»</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HiHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"><span class="comment">//ä¿®æ”¹ä¸ºresponseå¯¹è±¡</span></span><br><span class="line">Response message = (Response)e.getMessage();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(message.getCmd() == <span class="number">1</span>)&#123;</span><br><span class="line"><span class="comment">//ä»serverç«¯è·å–æ•°æ®å¹¶è¾“å‡º</span></span><br><span class="line">FightResponse fightResponse = <span class="keyword">new</span> FightResponse();</span><br><span class="line">fightResponse.readFromBytes(message.getData());</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"gold:"</span> + fightResponse.getGold());</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(message.getCmd() == <span class="number">2</span>)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•è·å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"exceptionCaught"</span>);</span><br><span class="line"><span class="keyword">super</span>.exceptionCaught(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°è¿æ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelConnected"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelConnected(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelDisconnected"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelDisconnected(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * channelå…³é—­çš„æ—¶å€™è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelClosed"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelClosed(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†åŸæ¥æ”¶åˆ°å’Œå›å†™çš„å¯¹è±¡è½¬åŒ–æˆresponseå¯¹è±¡</p><h2 id="Serveré¡¹ç›®"><a href="#Serveré¡¹ç›®" class="headerlink" title="Serveré¡¹ç›®"></a>Serveré¡¹ç›®</h2><p>æ–°å»ºServeré¡¹ç›®ï¼Œå°†ä¹‹å‰serverä»£ç æ‹·è´è¿‡æ¥</p><h3 id="Server-java"><a href="#Server-java" class="headerlink" title="Server.java"></a>Server.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.codc.RequestDecoder;</span><br><span class="line"><span class="keyword">import</span> com.cn.codc.ResponseEncoder;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nettyæœåŠ¡ç«¯å…¥é—¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™</span></span><br><span class="line">ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line">bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ç®¡é“çš„å·¥å‚</span></span><br><span class="line">bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> RequestDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> ResponseEncoder());</span><br><span class="line">pipeline.addLast(<span class="string">"helloHandler"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"start!!!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å˜åŒ–</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line"><span class="comment">//å¯¹requestè§£ç </span></span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> RequestDecoder());</span><br><span class="line"><span class="comment">//responseç¼–ç </span></span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> ResponseEncoder());</span><br><span class="line">pipeline.addLast(<span class="string">"helloHandler"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br></pre></td></tr></table></figure><h3 id="HiHandler-java-1"><a href="#HiHandler-java-1" class="headerlink" title="HiHandler.java"></a>HiHandler.java</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelStateEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ExceptionEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.model.Request;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.Response;</span><br><span class="line"><span class="keyword">import</span> com.cn.model.StateCode;</span><br><span class="line"><span class="keyword">import</span> com.cn.module.fuben.request.FightRequest;</span><br><span class="line"><span class="keyword">import</span> com.cn.module.fuben.response.FightResponse;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯æ¥å—å¤„ç†ç±»</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">Request message = (Request)e.getMessage();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(message.getCmd() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line">FightRequest fightRequest = <span class="keyword">new</span> FightRequest();</span><br><span class="line">fightRequest.readFromBytes(message.getData());</span><br><span class="line"><span class="comment">//éœ€è¦æ‰“çš„å‰¯æœ¬idæ˜¯xxxæ‰“äº†xxxæ¬¡</span></span><br><span class="line">System.out.println(<span class="string">"fubenId:"</span> +fightRequest.getFubenId() + <span class="string">"   "</span> + <span class="string">"count:"</span> + fightRequest.getCount());</span><br><span class="line"></span><br><span class="line"><span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">FightResponse fightResponse = <span class="keyword">new</span> FightResponse();</span><br><span class="line">fightResponse.setGold(<span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">Response response = <span class="keyword">new</span> Response();</span><br><span class="line">response.setModule((short) <span class="number">1</span>);</span><br><span class="line">response.setCmd((short) <span class="number">1</span>);</span><br><span class="line">response.setStateCode(StateCode.SUCCESS);</span><br><span class="line">response.setData(fightResponse.getBytes());</span><br><span class="line">ctx.getChannel().write(response);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(message.getCmd() == <span class="number">2</span>)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•è·å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"exceptionCaught"</span>);</span><br><span class="line"><span class="keyword">super</span>.exceptionCaught(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°è¿æ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelConnected"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelConnected(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelDisconnected"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelDisconnected(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * channelå…³é—­çš„æ—¶å€™è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelClosed"</span>);</span><br><span class="line"><span class="keyword">super</span>.channelClosed(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æ”¶åˆ°çš„æ•°æ®å¼ºè½¬ä¸ºrequset</p><h2 id="ç»“æœï¼š"><a href="#ç»“æœï¼š" class="headerlink" title="ç»“æœï¼š"></a>ç»“æœï¼š</h2><p>è¿è¡Œï¼š<br>clientç«¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¯·è¾“å…¥ï¼š</span><br><span class="line"><span class="number">101</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="comment">//è¦æ‰“101å‰¯æœ¬ï¼Œæ‰“åæ¬¡</span></span><br></pre></td></tr></table></figure><p>serverç«¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fubenIDï¼š<span class="number">101</span> countï¼š<span class="number">10</span></span><br></pre></td></tr></table></figure><p>clientç«¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gold:<span class="number">999</span></span><br></pre></td></tr></table></figure><h2 id="å¼Šç«¯ï¼š"><a href="#å¼Šç«¯ï¼š" class="headerlink" title="å¼Šç«¯ï¼š"></a>å¼Šç«¯ï¼š</h2><p>æ¯æ¬¡éƒ½è¦åšåˆ¤æ–­<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(message.getModule() == <span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(message.getCmd() == <span class="number">1</span>)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;æ•°æ®åŒ…ç®€ä»‹&quot;&gt;&lt;a href=&quot;#æ•°æ®åŒ…ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®åŒ…ç®€ä»‹&quot;&gt;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰ï¼šè‡ªå®šä¹‰åºåˆ—åŒ–åè®®</title>
    <link href="http://mmmmmm.me/2019-03-10-9.html"/>
    <id>http://mmmmmm.me/2019-03-10-9.html</id>
    <published>2019-03-10T02:21:09.000Z</published>
    <updated>2019-03-10T15:09:13.017Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®"></a>ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®</h1><p>ä¸ŠèŠ‚ä¸­proto buffæ˜æ˜¾æ¯”javaæœ¬èº«çš„åºåˆ—åŒ–ç”Ÿæˆçš„byteæ•°ç»„çŸ­å¾ˆå¤šï¼Œå› ä¸ºjavaè‡ªèº«çš„åºåˆ—åŒ–ä¼ å…¥äº†å¾ˆå¤šä¿¡æ¯ï¼ˆæ¯”å¦‚ç±»ä¿¡æ¯ã€ç±»å‹ã€å­—æ®µç­‰ï¼‰ï¼Œé€šè¿‡è‡ªå®šä¹‰åºåˆ—åŒ–åè®®èƒ½å¤Ÿé€šè¿‡è‡ªå·±å®šä¹‰çš„æ–¹å¼å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><h1 id="ğŸŒ°"><a href="#ğŸŒ°" class="headerlink" title="ğŸŒ°"></a>ğŸŒ°</h1><h2 id="test1"><a href="#test1" class="headerlink" title="test1"></a>test1</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException &#123;</span><br><span class="line">int id = <span class="number">101</span>;</span><br><span class="line">int age = <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line">ByteArrayOutputStream arrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"><span class="comment">//å¸Œæœ›å°†intå†™è¿›å»ï¼Œå¯æ˜¯çœ‹writeçš„æºç è¿”ç°</span></span><br><span class="line"><span class="comment">//writeï¼ˆint bï¼‰&#123;</span></span><br><span class="line"><span class="comment">//  buf[coung] = byteï¼ˆbï¼‰</span></span><br><span class="line"><span class="comment">//count+=1;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//å‘ç°æ˜¯ç›´æ¥æŠŠintè½¬åŒ–æˆäº†byteï¼Œintå æœ‰4ä¸ªå­—èŠ‚é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œå‡ºç°äº†æ•°æ®æˆªæ–­ï¼Œæ‰€ä»¥è‡ªå·±å†™ä¸€ä¸ªæ–¹æ³•int2bytesã€‚</span></span><br><span class="line">arrayOutputStream.write(int2bytes(id));</span><br><span class="line">arrayOutputStream.write(int2bytes(age));</span><br><span class="line"></span><br><span class="line">byte[] byteArray = arrayOutputStream.toByteArray();</span><br><span class="line"></span><br><span class="line">System.out.println(Arrays.toString(byteArray));</span><br><span class="line"></span><br><span class="line"><span class="comment">//==============================================================</span></span><br><span class="line">ByteArrayInputStream arrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(byteArray);</span><br><span class="line">byte[] idBytes = <span class="keyword">new</span> byte[<span class="number">4</span>];</span><br><span class="line">arrayInputStream.read(idBytes);</span><br><span class="line">System.out.println(<span class="string">"id:"</span> + bytes2int(idBytes));</span><br><span class="line"></span><br><span class="line">byte[] ageBytes = <span class="keyword">new</span> byte[<span class="number">4</span>];</span><br><span class="line">arrayInputStream.read(ageBytes);</span><br><span class="line">System.out.println(<span class="string">"age:"</span> + bytes2int(ageBytes));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤§ç«¯å­—èŠ‚åºåˆ—(å…ˆå†™é«˜ä½ï¼Œå†å†™ä½ä½)</span></span><br><span class="line"><span class="comment"> * ç™¾åº¦ä¸‹ å¤§å°ç«¯å­—èŠ‚åºåˆ—</span></span><br><span class="line"><span class="comment"> * @param i</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> byte[] int2bytes(int i)&#123;</span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[<span class="number">4</span>];</span><br><span class="line"><span class="comment">//ä¸€ä¸ªå­—èŠ‚å…«ä½ï¼Œæ‰€ä»¥3*8</span></span><br><span class="line">bytes[<span class="number">0</span>] = (byte)(i &gt;&gt; <span class="number">3</span>*<span class="number">8</span>);</span><br><span class="line">bytes[<span class="number">1</span>] = (byte)(i &gt;&gt; <span class="number">2</span>*<span class="number">8</span>);</span><br><span class="line">bytes[<span class="number">2</span>] = (byte)(i &gt;&gt; <span class="number">1</span>*<span class="number">8</span>);</span><br><span class="line">bytes[<span class="number">3</span>] = (byte)(i &gt;&gt; <span class="number">0</span>*<span class="number">8</span>);</span><br><span class="line"><span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤§ç«¯</span></span><br><span class="line"><span class="comment"> * @param bytes</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> int bytes2int(byte[] bytes)&#123;</span><br><span class="line"><span class="comment">//åŸæ¥å‘å³ç§»åŠ¨äº†ä¸‰ä¸ªå­—èŠ‚ï¼Œå¸Œæœ›è¿˜åŸå›æ¥ï¼Œæ‰€ä»¥å‘å·¦ç§»åŠ¨ä¸‰ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="comment">//æˆ–è¿ç®—å°±æ˜¯ä¸ºäº†æŠŠæ•°æ®åˆå¹¶èµ·æ¥ï¼Œå˜æˆintæ•°æ®</span></span><br><span class="line"><span class="keyword">return</span> (bytes[<span class="number">0</span>] &lt;&lt; <span class="number">3</span>*<span class="number">8</span>) |</span><br><span class="line">(bytes[<span class="number">1</span>] &lt;&lt; <span class="number">2</span>*<span class="number">8</span>) |</span><br><span class="line">(bytes[<span class="number">2</span>] &lt;&lt; <span class="number">1</span>*<span class="number">8</span>) |</span><br><span class="line">(bytes[<span class="number">3</span>] &lt;&lt; <span class="number">0</span>*<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">101</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>]</span><br><span class="line">id:<span class="number">101</span></span><br><span class="line">age:<span class="number">21</span></span><br></pre></td></tr></table></figure><p>æ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œä½è¿ç®—ï¼Œè€Œä¸”å…ˆåœ¨æ˜¯è½¬æ¢intï¼Œlongã€floatã€doubleè½¬æ¢å‘¢ï¼Ÿ</p><h2 id="test2"><a href="#test2" class="headerlink" title="test2"></a>test2</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">int id = <span class="number">101</span>;</span><br><span class="line">int age = <span class="number">21</span>;</span><br><span class="line"><span class="comment">//é€šè¿‡nioçš„bytebufferè½¬æ¢ï¼Œçœå»äº†ä½è¿ç®—æ–¹æ³•</span></span><br><span class="line"><span class="comment">//ç”³è¯·å…«ä¸ªç©ºé—´å¤§å°</span></span><br><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">8</span>);</span><br><span class="line">buffer.putInt(id);</span><br><span class="line">buffer.putInt(age);</span><br><span class="line">byte[] array = buffer.array();</span><br><span class="line">System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line"></span><br><span class="line"><span class="comment">//====================================================</span></span><br><span class="line"></span><br><span class="line">ByteBuffer buffer2 = ByteBuffer.wrap(array);</span><br><span class="line">System.out.println(<span class="string">"id:"</span>+buffer2.getInt());</span><br><span class="line">System.out.println(<span class="string">"age:"</span>+buffer2.getInt());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">101</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>]</span><br><span class="line">id:<span class="number">101</span></span><br><span class="line">age:<span class="number">21</span></span><br></pre></td></tr></table></figure><p>ç®€åŒ–äº†å¾ˆå¤šæ“ä½œï¼Œä½†æ˜¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">8</span>);</span><br></pre></td></tr></table></figure><p>å¯æ˜¯æ¯æ¬¡éœ€è¦ç»™å®šç”³è¯·çš„ç»™å®šç©ºé—´å¤§å°ï¼Œä¸èƒ½è‡ªåŠ¨æ‰©å®¹</p><h2 id="test3ï¼ˆä½¿ç”¨nettyä¸­çš„ChannelBuffersï¼‰"><a href="#test3ï¼ˆä½¿ç”¨nettyä¸­çš„ChannelBuffersï¼‰" class="headerlink" title="test3ï¼ˆä½¿ç”¨nettyä¸­çš„ChannelBuffersï¼‰"></a>test3ï¼ˆä½¿ç”¨nettyä¸­çš„ChannelBuffersï¼‰</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line">ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();</span><br><span class="line">buffer.writeInt(<span class="number">101</span>);</span><br><span class="line">buffer.writeDouble(<span class="number">80.1</span>);</span><br><span class="line"></span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[buffer.writerIndex()];</span><br><span class="line">buffer.readBytes(bytes);</span><br><span class="line"></span><br><span class="line">System.out.println(Arrays.toString(bytes));</span><br><span class="line"></span><br><span class="line"><span class="string">"abc"</span>.getBytes();</span><br><span class="line"></span><br><span class="line"><span class="comment">//================================================</span></span><br><span class="line">ChannelBuffer wrappedBuffer = ChannelBuffers.wrappedBuffer(bytes);</span><br><span class="line">System.out.println(wrappedBuffer.readInt());</span><br><span class="line">System.out.println(wrappedBuffer.readDouble());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">101</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">21</span>]</span><br><span class="line">id:<span class="number">101</span></span><br><span class="line">age:<span class="number">21</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//channelBufferæ ¹æ®å†™æŒ‡é’ˆçš„ä½ç½®ï¼Œè·å–byteæ•°ç»„å¤§å°</span></span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[buffer.writerIndex()];</span><br></pre></td></tr></table></figure><p>é™¤äº†èƒ½å¤Ÿè‡ªåŠ¨æ‰©å®¹ï¼Œè¿˜èƒ½å¤Ÿè‡ªåŠ¨å†™å…¥int doubleç­‰ç±»å‹ï¼Œå¯æ˜¯è¿˜æ˜¯ä¼˜ç¼ºç‚¹ï¼Œè¿™é‡Œæ²¡æœ‰ä¸€ä¸ªwriteStringçš„æ–¹æ³•</p><p><strong><font color="red">é€šè¿‡â€œabcâ€.getBytes()å¾—åˆ°å­—èŠ‚æ•°æ®ï¼Œå¯æ˜¯æ— æ³•ç¡®å®šå­—èŠ‚çš„å¤§å°ï¼Œä¸åƒintçŸ¥é“æ˜¯å››ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥String LIst Mapéƒ½éœ€è¦åœ¨å‰é¢åŠ ä¸€ä¸ªé•¿åº¦å­—æ®µã€‚<br></font></strong><br>|-|-|<br>|-|-|<br>String List Map | shorté•¿åº¦+å­—èŠ‚æ•°ç»„</p><h2 id="è‡ªå®šä¹‰åºåˆ—åŒ–åè®®ï¼ˆtest4ï¼‰"><a href="#è‡ªå®šä¹‰åºåˆ—åŒ–åè®®ï¼ˆtest4ï¼‰" class="headerlink" title="è‡ªå®šä¹‰åºåˆ—åŒ–åè®®ï¼ˆtest4ï¼‰"></a>è‡ªå®šä¹‰åºåˆ—åŒ–åè®®ï¼ˆtest4ï¼‰</h2><p>SeriaLizer.java (è‡ªå®šä¹‰äº†åºåˆ—åŒ–çš„è§„åˆ™)<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line">package com.serial;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰åºåˆ—åŒ–æ¥å£</span></span><br><span class="line"><span class="comment"> * @</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public abstract <span class="class"><span class="keyword">class</span> <span class="title">Serializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> final Charset CHARSET = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">protected ChannelBuffer writeBuffer;</span><br><span class="line"></span><br><span class="line">protected ChannelBuffer readBuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ååºåˆ—åŒ–å…·ä½“å®ç°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected abstract <span class="keyword">void</span> read();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—åŒ–å…·ä½“å®ç°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected abstract <span class="keyword">void</span> write();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»byteæ•°ç»„è·å–æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param bytesè¯»å–çš„æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public Serializer readFromBytes(byte[] bytes) &#123;</span><br><span class="line">readBuffer = BufferFactory.getBuffer(bytes);</span><br><span class="line">read();</span><br><span class="line">readBuffer.clear();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»buffè·å–æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param readBuffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> readFromBuffer(ChannelBuffer readBuffer) &#123;</span><br><span class="line"><span class="keyword">this</span>.readBuffer = readBuffer;</span><br><span class="line">read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥æœ¬åœ°buff</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public ChannelBuffer writeToLocalBuff()&#123;</span><br><span class="line">writeBuffer = BufferFactory.getBuffer();</span><br><span class="line">write();</span><br><span class="line"><span class="keyword">return</span> writeBuffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥ç›®æ ‡buff</span></span><br><span class="line"><span class="comment"> * @param buffer</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public ChannelBuffer writeToTargetBuff(ChannelBuffer buffer)&#123;</span><br><span class="line">writeBuffer = buffer;</span><br><span class="line">write();</span><br><span class="line"><span class="keyword">return</span> writeBuffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›bufferæ•°ç»„</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public byte[] getBytes() &#123;</span><br><span class="line">writeToLocalBuff();</span><br><span class="line">byte[] bytes = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (writeBuffer.writerIndex() == <span class="number">0</span>) &#123;</span><br><span class="line">bytes = <span class="keyword">new</span> byte[<span class="number">0</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bytes = <span class="keyword">new</span> byte[writeBuffer.writerIndex()];</span><br><span class="line">writeBuffer.readBytes(bytes);</span><br><span class="line">&#125;</span><br><span class="line">writeBuffer.clear();</span><br><span class="line"><span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public byte readByte() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readByte();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public short readShort() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readShort();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int readInt() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readInt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public long readLong() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readLong();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public float readFloat() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readFloat();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public double readDouble() &#123;</span><br><span class="line"><span class="keyword">return</span> readBuffer.readDouble();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="built_in">String</span> readString() &#123;</span><br><span class="line">int size = readBuffer.readShort();</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[size];</span><br><span class="line">readBuffer.readBytes(bytes);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">String</span>(bytes, CHARSET);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public &lt;T&gt; List&lt;T&gt; readList(Class&lt;T&gt; clz) &#123;</span><br><span class="line">List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">int size = readBuffer.readShort();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">list.add(read(clz));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public &lt;K,V&gt; <span class="built_in">Map</span>&lt;K,V&gt; readMap(Class&lt;K&gt; keyClz, Class&lt;V&gt; valueClz) &#123;</span><br><span class="line"><span class="built_in">Map</span>&lt;K,V&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">int size = readBuffer.readShort();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">K key = read(keyClz);</span><br><span class="line">V value = read(valueClz);</span><br><span class="line">map.put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">public &lt;I&gt; I read(Class&lt;I&gt; clz) &#123;</span><br><span class="line"><span class="built_in">Object</span> t = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> ( clz == int.class || clz == Integer.class) &#123;</span><br><span class="line">t = <span class="keyword">this</span>.readInt();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == byte.class || clz == Byte.class)&#123;</span><br><span class="line">t = <span class="keyword">this</span>.readByte();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == short.class || clz == Short.class)&#123;</span><br><span class="line">t = <span class="keyword">this</span>.readShort();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == long.class || clz == Long.class)&#123;</span><br><span class="line">t = <span class="keyword">this</span>.readLong();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == float.class || clz == Float.class)&#123;</span><br><span class="line">t = readFloat();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == double.class || clz == Double.class)&#123;</span><br><span class="line">t = readDouble();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clz == <span class="built_in">String</span>.class )&#123;</span><br><span class="line">t = readString();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Serializer.class.isAssignableFrom(clz))&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">byte hasObject = <span class="keyword">this</span>.readBuffer.readByte();</span><br><span class="line"><span class="keyword">if</span>(hasObject == <span class="number">1</span>)&#123;</span><br><span class="line">Serializer temp = (Serializer)clz.newInstance();</span><br><span class="line">temp.readFromBuffer(<span class="keyword">this</span>.readBuffer);</span><br><span class="line">t = temp;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">t = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="built_in">String</span>.format(<span class="string">"ä¸æ”¯æŒç±»å‹:[%s]"</span>, clz));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (I) t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public Serializer writeByte(Byte value) &#123;</span><br><span class="line">writeBuffer.writeByte(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeShort(Short value) &#123;</span><br><span class="line">writeBuffer.writeShort(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeInt(Integer value) &#123;</span><br><span class="line">writeBuffer.writeInt(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeLong(Long value) &#123;</span><br><span class="line">writeBuffer.writeLong(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeFloat(Float value) &#123;</span><br><span class="line">writeBuffer.writeFloat(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeDouble(Double value) &#123;</span><br><span class="line">writeBuffer.writeDouble(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public &lt;T&gt; Serializer writeList(List&lt;T&gt; list) &#123;</span><br><span class="line"><span class="keyword">if</span> (isEmpty(list)) &#123;</span><br><span class="line">writeBuffer.writeShort((short) <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">writeBuffer.writeShort((short) list.size());</span><br><span class="line"><span class="keyword">for</span> (T item : list) &#123;</span><br><span class="line">writeObject(item);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public &lt;K,V&gt; Serializer writeMap(<span class="built_in">Map</span>&lt;K, V&gt; map) &#123;</span><br><span class="line"><span class="keyword">if</span> (isEmpty(map)) &#123;</span><br><span class="line">writeBuffer.writeShort((short) <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">writeBuffer.writeShort((short) map.size());</span><br><span class="line"><span class="keyword">for</span> (Entry&lt;K, V&gt; entry : map.entrySet()) &#123;</span><br><span class="line">writeObject(entry.getKey());</span><br><span class="line">writeObject(entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeString(<span class="built_in">String</span> value) &#123;</span><br><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span> || value.isEmpty()) &#123;</span><br><span class="line">writeShort((short) <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte data[] = value.getBytes(CHARSET);</span><br><span class="line">short len = (short) data.length;</span><br><span class="line">writeBuffer.writeShort(len);</span><br><span class="line">writeBuffer.writeBytes(data);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Serializer writeObject(<span class="built_in">Object</span> object) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(object == <span class="literal">null</span>)&#123;</span><br><span class="line">writeByte((byte)<span class="number">0</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">â€‹</span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">writeInt((int) object);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">writeLong((long) object);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> Short) &#123;</span><br><span class="line">writeShort((short) object);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> Byte) &#123;</span><br><span class="line">writeByte((byte) object);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="built_in">String</span>) &#123;</span><br><span class="line"><span class="built_in">String</span> value = (<span class="built_in">String</span>) object;</span><br><span class="line">writeString(value);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (object <span class="keyword">instanceof</span> Serializer) &#123;</span><br><span class="line">writeByte((byte)<span class="number">1</span>);</span><br><span class="line">Serializer value = (Serializer) object;</span><br><span class="line">value.writeToTargetBuff(writeBuffer);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ä¸å¯åºåˆ—åŒ–çš„ç±»å‹:"</span> + object.getClass());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private &lt;T&gt; boolean isEmpty(Collection&lt;T&gt; c) &#123;</span><br><span class="line"><span class="keyword">return</span> c == <span class="literal">null</span> || c.size() == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">public &lt;K,V&gt; boolean isEmpty(<span class="built_in">Map</span>&lt;K,V&gt; c) &#123;</span><br><span class="line"><span class="keyword">return</span> c == <span class="literal">null</span> || c.size() == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ³¨æ„å…¶ä¸­çš„readStringç­‰æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="built_in">String</span> readString() &#123;</span><br><span class="line">int size = readBuffer.readShort();</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[size];</span><br><span class="line">readBuffer.readBytes(bytes);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">String</span>(bytes, CHARSET);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†éœ€è¦çš„Stringï¼ˆlist mapä¸€æ ·ï¼‰çš„byteå¤§å°ä¿å­˜åˆ°readbufferä¸­ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å†ä»é‡Œé¢è¯»å‡ºæ¥ã€‚<br>BufferFactory.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.serial;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteOrder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * buffå·¥å‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">BufferFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> ByteOrder BYTE_ORDER = ByteOrder.BIG_ENDIAN;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–ä¸€ä¸ªbuffer</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> ChannelBuffer getBuffer() &#123;</span><br><span class="line">ChannelBuffer dynamicBuffer = ChannelBuffers.dynamicBuffer();</span><br><span class="line"><span class="keyword">return</span> dynamicBuffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†æ•°æ®å†™å…¥buffer</span></span><br><span class="line"><span class="comment"> * @param bytes</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> ChannelBuffer getBuffer(byte[] bytes) &#123;</span><br><span class="line">ChannelBuffer copiedBuffer = ChannelBuffers.copiedBuffer(bytes);</span><br><span class="line"><span class="keyword">return</span> copiedBuffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Player.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.serial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©å®¶å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="keyword">extends</span> <span class="title">Serializer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">public Player() &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Player(long playerId,  int age, <span class="built_in">String</span> name) &#123;</span><br><span class="line"><span class="keyword">this</span>.playerId = playerId;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private long playerId;</span><br><span class="line"></span><br><span class="line">private int age;</span><br><span class="line"></span><br><span class="line">private <span class="built_in">String</span> name;</span><br><span class="line"></span><br><span class="line">private List&lt;Integer&gt; skills = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">public long getPlayerId() &#123;</span><br><span class="line"><span class="keyword">return</span> playerId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setPlayerId(long playerId) &#123;</span><br><span class="line"><span class="keyword">this</span>.playerId = playerId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int getAge() &#123;</span><br><span class="line"><span class="keyword">return</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setAge(int age) &#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="built_in">String</span> getName() &#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setName(<span class="built_in">String</span> name) &#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public List&lt;Integer&gt; getSkills() &#123;</span><br><span class="line"><span class="keyword">return</span> skills;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setSkills(List&lt;Integer&gt; skills) &#123;</span><br><span class="line"><span class="keyword">this</span>.skills = skills;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> read() &#123;</span><br><span class="line"><span class="keyword">this</span>.playerId = readLong();</span><br><span class="line"><span class="keyword">this</span>.age = readInt();</span><br><span class="line"><span class="keyword">this</span>.name = readString();</span><br><span class="line"><span class="keyword">this</span>.skills = readList(Integer.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> write() &#123;</span><br><span class="line">writeLong(playerId);</span><br><span class="line">writeInt(age);</span><br><span class="line">writeString(name);</span><br><span class="line">writeList(skills);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test4.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line">Player player = <span class="keyword">new</span> Player();</span><br><span class="line">player.setPlayerId(<span class="number">10001</span>);</span><br><span class="line">player.setAge(<span class="number">22</span>);</span><br><span class="line">player.getSkills().add(<span class="number">101</span>);</span><br><span class="line">player.getResource().setGold(<span class="number">99999</span>);</span><br><span class="line"></span><br><span class="line">byte[] bytes = player.getBytes();</span><br><span class="line"></span><br><span class="line">System.out.println(Arrays.toString(bytes));</span><br><span class="line"></span><br><span class="line"><span class="comment">//==============================================</span></span><br><span class="line"></span><br><span class="line">Player player2 = <span class="keyword">new</span> Player();</span><br><span class="line">player2.readFromBytes(bytes);</span><br><span class="line">System.out.println(player2.getPlayerId() + <span class="string">"   "</span>+player2.getAge() + <span class="string">"     "</span>+ Arrays.toString(player2.getSkills().toArray())+<span class="string">"   "</span> +player2.getResource().getGold());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">39</span>,<span class="number">17</span>,<span class="number">0</span>,<span class="number">0</span>ã€‚ã€‚ã€‚ã€‚]</span><br><span class="line"><span class="number">1001</span> <span class="number">33</span> <span class="number">101</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡Seriazerçš„å°è£…ï¼Œç»“åˆå‰é¢ChannelBuffersçš„æ–¹å¼ï¼Œå°†String list mapéœ€è¦ä¼ å…¥å¤§å°çš„é—®é¢˜è¿›è¡Œäº†ç»“å±€ã€‚</p><h1 id="å¯¹æ¯”åˆ†æprotobuffåŸç†-é‡ç‚¹å­¦ä¹ protoä½è¿ç®—çš„åŸç†"><a href="#å¯¹æ¯”åˆ†æprotobuffåŸç†-é‡ç‚¹å­¦ä¹ protoä½è¿ç®—çš„åŸç†" class="headerlink" title="å¯¹æ¯”åˆ†æprotobuffåŸç†  é‡ç‚¹å­¦ä¹ protoä½è¿ç®—çš„åŸç†   "></a>å¯¹æ¯”åˆ†æprotobuffåŸç† <strong><font color="red">é‡ç‚¹å­¦ä¹ protoä½è¿ç®—çš„åŸç†</font></strong></h1><h2 id="åˆçª¥"><a href="#åˆçª¥" class="headerlink" title="åˆçª¥"></a>åˆçª¥</h2><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­å’Œä¸ŠèŠ‚çš„protobuffï¼Œä¼ å…¥ç›¸åŒçš„å€¼åˆ°Playerç±»ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">39</span>,<span class="number">17</span>,<span class="number">0</span>,<span class="number">0</span>ã€‚ã€‚ã€‚ã€‚]</span><br><span class="line"><span class="number">1001</span> <span class="number">33</span> <span class="number">101</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">39</span>,<span class="number">17</span>]</span><br><span class="line"><span class="number">1001</span> <span class="number">33</span> <span class="number">101</span> <span class="number">9999</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¸Šé¢çš„æ•°æ®æ˜¯æˆ‘ç¼–çš„ï¼Œå¯æ˜¯protobuffç”Ÿäº§å‡ºæ¥çš„byteæ•°ç»„å¤§å°ï¼Œæ¯”æˆ‘ä»¬å°½æœ€å¤§åŠªåŠ›è‡ªå®šä¹‰çš„æ•°ç»„å¤§å°è¿˜è¦å°å¾ˆå¤šã€‚</p><h2 id="åˆ†æprotobuffæºç "><a href="#åˆ†æprotobuffæºç " class="headerlink" title="åˆ†æprotobuffæºç "></a>åˆ†æprotobuffæºç </h2><p>ä¸ŠèŠ‚ä¸­çš„ä¾‹å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Player player = builder.build();</span><br><span class="line">byte[] byteArray = player.toByteArray();</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥çœ‹tobyteArrayæ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public byte[] toByteArray() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    final byte[] result = <span class="keyword">new</span> byte[getSerializedSize()];</span><br><span class="line">    final CodedOutputStream output = CodedOutputStream.newInstance(result);</span><br><span class="line">    writeTo(output);</span><br><span class="line">    output.checkNoSpaceLeft();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">      <span class="string">"Serializing to a byte array threw an IOException "</span> +</span><br><span class="line">      <span class="string">"(should never happen)."</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹writeToæ–¹æ³•ï¼ŒwriteToæ˜¯ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼ŒæŸ¥çœ‹å…·ä½“å®ç°ç±»PlayerModule.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  public <span class="keyword">void</span> writeTo(com.google.protobuf.CodedOutputStream output)</span><br><span class="line">                        throws java.io.IOException &#123;</span><br><span class="line">      getSerializedSize();</span><br><span class="line">      <span class="keyword">if</span> (((bitField0_ &amp; <span class="number">0x00000001</span>) == <span class="number">0x00000001</span>)) &#123;</span><br><span class="line">        output.writeInt64(<span class="number">1</span>, playerID_);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (((bitField0_ &amp; <span class="number">0x00000002</span>) == <span class="number">0x00000002</span>)) &#123;</span><br><span class="line">        output.writeInt32(<span class="number">2</span>, age_);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="keyword">if</span> (((bitField0_ &amp; <span class="number">0x00000001</span>) == <span class="number">0x00000001</span>)) &#123;</span><br><span class="line">        output.writeBytes(<span class="number">3</span>, getNameBytes());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; skill.size(); i++) &#123;</span><br><span class="line">        output.writeInt32(<span class="number">4</span>, skill.get(i));</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      getUnknownFields().writeTo(output);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™é‡Œçš„writeInt64ç­‰æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°1234æ˜¯ä¸ŠèŠ‚ä¸­protoæ–‡ä»¶ä¸­çš„keyï¼Œè¡¨ç¤ºæ˜¯ç¬¬å‡ ä¸ªå­—èŠ‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">required int64 playerId = <span class="number">1</span>;</span><br><span class="line">required int32 age = <span class="number">2</span>;</span><br><span class="line">required string name = <span class="number">3</span>;</span><br><span class="line"><span class="comment">//repeatedçš„æ„æ€æ˜¯listï¼Œé‡å¤intçš„list</span></span><br><span class="line">repeated int32 skills = <span class="number">4</span>;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹WriteInt32æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> writeInt32(final int fieldNumber, final int value)</span><br><span class="line">                        throws IOException &#123;</span><br><span class="line"> <span class="comment">//å†™ç¬¬å‡ ä¸ªå­—èŠ‚</span></span><br><span class="line">   writeTag(fieldNumber, WireFormat.WIRETYPE_VARINT);</span><br><span class="line">   <span class="comment">//å†™å…·ä½“çš„å¹´é¾„</span></span><br><span class="line">   writeInt32NoTag(value);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹writeInt32NoTagæ–¹æ³•<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> writeInt32NoTag(final int value) throws IOException &#123;</span><br><span class="line">  <span class="keyword">if</span> (value &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    writeRawVarint32(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Must sign-extend.</span></span><br><span class="line">    writeRawVarint64(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹writeRawVarint32æ–¹æ³•<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> writeRawVarint32(int value) throws IOException &#123;</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> ((value &amp; ~<span class="number">0x7F</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">       writeRawByte(value);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       writeRawByte((value &amp; <span class="number">0x7F</span>) | <span class="number">0x80</span>);</span><br><span class="line">       value &gt;&gt;&gt;= <span class="number">7</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p></p><p>0x7F è½¬åŒ–æˆäºŒè¿›åˆ¶ 0111 1111<br>~0x7F å–åå 1000 0000<br>value&amp; ~0x7F çš„ç»“æœå°±æ˜¯valueçš„1-7ä½éƒ½è¢«ç½®ä¸ºäº†0ï¼Œvalueæ˜¯32ä½ï¼Œå‰é¢è¿˜æœ‰25ä½å¯èƒ½æœ‰æ•°æ®ï¼Œæ‰€ä»¥å¯èƒ½value &amp; ~0x7F != 0<br>æ‰€ä»¥å¦‚æœvalue &amp; ~0x7F == 0ï¼Œè¯´æ˜valueå€¼çš„å¤§å°æ˜¯å°äº7ä½çš„</p><p>å¦‚æœå°äºåé¢7ä½çš„å¤§å°ï¼Œå°±å†™ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> writeRawByte(final byte value) throws IOException &#123;</span><br><span class="line">   <span class="keyword">if</span> (position == limit) &#123;</span><br><span class="line">     refreshBuffer();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¤§äºåé¢7ä½çš„å¤§å°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">writeRawByte((value &amp; <span class="number">0x7F</span>) | <span class="number">0x80</span>);</span><br><span class="line">value &gt;&gt;&gt;= <span class="number">7</span>;</span><br></pre></td></tr></table></figure><p>value &amp; 0x7Fè·å–1-7ä½æ•°æ®<br>0x80è¡¨ç¤ºæˆäºŒè¿›åˆ¶1000 0000<br>æˆ–è¿ç®— 1xxx xxxx é€šè¿‡ç¬¬å…«ä½åˆ¤æ–­åé¢è¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®å°±æ˜¯1ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±æ˜¯0ï¼Œ<br>æ‰€ä»¥è¿™é‡Œè¯´æ˜æœ‰æ•°æ®ï¼Œå¾€å³ç§»7ä½ï¼Œæ¥ç€è¯»ï¼Œç„¶ååœ¨æ­¤åˆ¤æ–­å‰©ä¸‹çš„æ•°æ®æ˜¯ä¸æ˜¯å°äºä¸ƒä½ï¼Œå¦‚æ­¤å¾ªç¯ã€‚</p><p>å› ä¸ºè¿™é‡Œçš„ç¬¬ä¸€ä½ç”¨æ¥è¡¨ç¤ºè¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥åªèƒ½è¡¨ç¤º28ä½çš„æ•°æ®ä½ï¼Œè€ŒçœŸæ­£éœ€è¦è¡¨ç¤ºçš„æ˜¯32ä½ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ä¸¢å¤±çš„4ä½ï¼Œæ‰€ä»¥int çš„å­—èŠ‚é•¿åº¦ä¸æ˜¯ä¼ ç»Ÿçš„4ä¸ªï¼Œåœ¨protoä¸­ä¸ºä¼¸ç¼©çš„1-5ä¸ªå­—èŠ‚ï¼Œlongä¸æ˜¯ä¼ ç»Ÿçš„8ä½ï¼Œåœ¨protoä¸­æ˜¯ä¼¸ç¼©çš„1-9ä½</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®&quot; class=&quot;headerlink
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆå…«ï¼‰ï¼šprotocol buffå­¦ä¹ ä½¿ç”¨</title>
    <link href="http://mmmmmm.me/2019-03-10-8.html"/>
    <id>http://mmmmmm.me/2019-03-10-8.html</id>
    <published>2019-03-10T02:21:08.000Z</published>
    <updated>2019-03-10T15:09:10.101Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>protocol buffæ˜¯ä¸€ç§åè®®ï¼Œæ˜¯è°·æ­Œæ¨å‡ºçš„ä¸€ç§åºåˆ—åŒ–åè®®<br>Javaåºåˆ—åŒ–åè®®ä¹Ÿæ˜¯ä¸€ç§åè®®<br>ä¸¤è€…çš„ç›®çš„æ˜¯ï¼Œå°†å¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„ï¼Œæˆ–è€…è¯´æ˜¯äºŒè¿›åˆ¶æ•°æ®</p><h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><p>protobufçš„ä¸¤ä¸ªjaråŒ…ã€ protoc.exe(ç”Ÿæˆjavaçš„æºä»£ç ï¼Œéœ€è¦å†™protobufçš„é…ç½®æ–‡ä»¶æ‰èƒ½ç”Ÿæˆã€‚)</p><h2 id="protobufé…ç½®æ–‡ä»¶"><a href="#protobufé…ç½®æ–‡ä»¶" class="headerlink" title="protobufé…ç½®æ–‡ä»¶"></a>protobufé…ç½®æ–‡ä»¶</h2><p>ä»»æ„ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹ï¼ˆä»»æ„åå­—ï¼‰==ã€‹æ–°å»ºprotoæ–‡ä»¶ï¼ˆä»»æ„åå­—ï¼Œä¾‹å¦‚player.protoï¼‰åç¼€ä¸ºproto</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒ…å</span></span><br><span class="line">option java_package = <span class="string">"com.proto"</span>;</span><br><span class="line"><span class="comment">//java_outer_classnameçš„ä½œç”¨æ˜¯å°†Palerç±»å’ŒResourceç±»æ•´åˆåˆ°ä¸€ä¸ªå¤§çš„ç±»ä¸­ï¼Œä¸€ä¸ªå¤§çš„Moudleä¸­ï¼Œåå«PlayerModule</span></span><br><span class="line">option java_outer_classname = <span class="string">"PlayerModule"</span>;</span><br><span class="line"><span class="comment">//messageç›¸å½“äºjavaä¸­çš„class</span></span><br><span class="line">message PBPlayer&#123;</span><br><span class="line"><span class="comment">//åœ¨protobufä¸­æ²¡æœ‰intå’Œlongå½“æ—¶æœ‰å¯¹åº”çš„ç±»å‹ï¼Œint32æ˜¯intç±»å‹ï¼Œint64æ˜¯longç±»å‹</span></span><br><span class="line"><span class="comment">//requiredæ„æ€æ˜¯è¿™ä¸ªå­—æ®µç±»å‹å¿…é¡»è®¾ç½®ï¼ŒåŠ å…¥ä¸è®¾ç½®å°±ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment">//åé¢çš„123æ˜¯keyå€¼ï¼Œè¿™äº›keyå€¼åœ¨messageä¸­æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œè¿™é‡Œçš„keyç›¸å½“äº&#123;nameï¼šxiaoming&#125;ä¸­çš„name</span></span><br><span class="line">required int64 playerId = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">required int32 age = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">required string name = <span class="number">3</span>;</span><br><span class="line"><span class="comment">//repeatedçš„æ„æ€æ˜¯listï¼Œé‡å¤intçš„list</span></span><br><span class="line">repeated int32 skills = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message PBResource&#123;</span><br><span class="line"><span class="comment">//é‡‘å¸</span></span><br><span class="line">required int64 gold = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">required int32 energy = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆjavaä»£ç "><a href="#ç”Ÿæˆjavaä»£ç " class="headerlink" title="ç”Ÿæˆjavaä»£ç "></a>ç”Ÿæˆjavaä»£ç </h2><p>å°†ä¸Šé¢çš„player.protoæ”¾åˆ°protoc.exeçš„åŒçº§ç›®å½•===ã€‹åœ¨è¿™ä¸ªç›®å½•ä¸­æ–°å»ºbuild.bat<br>build.bat</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœæ˜¯ç”Ÿæˆcä»£ç å°±æ˜¯--cpp_out</span></span><br><span class="line"><span class="comment">//=åé¢æ˜¯å°†javaæ–‡ä»¶ç”Ÿæˆåˆ°å“ªä¸ªç›®å½•</span></span><br><span class="line">protoc ./player.protp --java_out=./</span><br><span class="line"><span class="comment">//æ–­ç‚¹å¯åŠ¨æ–¹ä¾¿è§‚å¯Ÿé”™è¯¯</span></span><br><span class="line">pasue</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»build.batä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åŠ com.proto ===ã€‹PlayerModule.java</p><h1 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h1><p>æ–°å»ºé¡¹ç›®==ã€‹libsç”¨æ¥æ”¾jaråŒ…==ã€‹æ–°å»ºprotoç›®å½•ç”¨æ¥æ”¾protoæ–‡ä»¶==ã€‹æŠŠä¸Šé¢çš„ä¸¤ä¸ªjaræ‹·è´è¿‡å» ==ã€‹protoæ–‡ä»¶æ‹·è´åˆ°protoç›®å½•ä¸­==ã€‹protoc.exeå’Œbuild.batæ‹·è´åˆ°é¡¹ç›®æ ¹ç›®å½•<br>ä¿®æ”¹build.bat<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc ./proto<span class="comment">/*.protp --java_out=./src</span></span><br><span class="line"><span class="comment">pasue</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨srcä¸‹æ–°å»ºPB2Bytes.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">package com.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JAVA2Bytes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">byte[] bytes = toBytes();</span><br><span class="line">toPlayer(bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"> * @throws IOException </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> byte[] toBytes() throws IOException&#123;</span><br><span class="line"></span><br><span class="line">Player player = <span class="keyword">new</span> Player(<span class="number">101</span>, <span class="number">20</span>, <span class="string">"peter"</span>);</span><br><span class="line">player.getSkills().add(<span class="number">1001</span>);</span><br><span class="line"></span><br><span class="line">ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†™å…¥å¯¹è±¡</span></span><br><span class="line">objectOutputStream.writeObject(player);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å– å­—èŠ‚æ•°ç»„</span></span><br><span class="line">byte[] byteArray = byteArrayOutputStream.toByteArray();</span><br><span class="line">System.out.println(Arrays.toString(byteArray));</span><br><span class="line"><span class="keyword">return</span> byteArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ååºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"> * @param bs</span></span><br><span class="line"><span class="comment"> * @throws Exceptipackage com.proto;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">import java.util.Arrays;</span></span><br><span class="line"><span class="comment">import com.proto.PlayerModule.PBPlayer;</span></span><br><span class="line"><span class="comment">import com.proto.PlayerModule.PBPlayer.Builder;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- protobufå­¦ä¹ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- @author </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">PB2Bytes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">  byte[] bytes = toBytes();</span><br><span class="line">  toPlayer(bytes);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">static</span> byte[] toBytes()&#123;</span><br><span class="line">    <span class="comment">//è·å–ä¸€ä¸ªPBPlayerçš„æ„é€ å™¨</span></span><br><span class="line">    Builder builder = PlayerModule.PBPlayer.newBuilder();</span><br><span class="line">    <span class="comment">//è®¾ç½®æ•°æ®</span></span><br><span class="line">    <span class="comment">//ä¸Šé¢skillæ˜¯listï¼Œæœ¬åº”è¯¥setSkillï¼Œå¯æ˜¯è¿™é‡Œæ˜¯setSkillï¼ˆindexï¼Œvalueï¼‰ï¼Œä¸æ˜¯æˆ‘ä»¬å¹³å¸¸çš„skill</span></span><br><span class="line">    <span class="comment">//å¯ä»¥ç›´æ¥addSkillï¼ˆ1001ï¼‰æ·»åŠ 1001è¿™ä¸ªæŠ€èƒ½</span></span><br><span class="line">    <span class="comment">//å‰é¢æ–‡ä»¶æ–‡åŠ äº†requiredå‰ç¼€çš„å¿…é¡»è¦åœ¨è¿™é‡Œè®¾ç½®å€¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™å¦‚ä¸‹</span></span><br><span class="line">    <span class="comment">//Message missing required field</span></span><br><span class="line">    builder.setPlayerId(<span class="number">101</span>).setAge(<span class="number">20</span>).setName(<span class="string">"peter"</span>).addSkills(<span class="number">1001</span>);</span><br><span class="line">    <span class="comment">//æ„é€ å‡ºå¯¹è±¡</span></span><br><span class="line">    PBPlayer player = builder.build();</span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    byte[] byteArray = player.toByteArray();</span><br><span class="line"></span><br><span class="line">    System.out.println(Arrays.toString(byteArray));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> byteArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - ååºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - @param bs</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - @throws Exception </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> toPlayer(byte[] bs) throws Exception&#123;</span><br><span class="line"></span><br><span class="line">     PBPlayer player = PlayerModule.PBPlayer.parseFrom(bs);</span><br><span class="line"></span><br><span class="line">     System.out.println(<span class="string">"playerId:"</span> + player.getPlayerId());</span><br><span class="line">     System.out.println(<span class="string">"age:"</span> + player.getAge());</span><br><span class="line">     System.out.println(<span class="string">"name:"</span> + player.getName());</span><br><span class="line">     System.out.println(<span class="string">"skills:"</span> + (Arrays.toString(player.getSkillsList().toArray())));</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">8</span>,<span class="number">101</span>,<span class="number">16</span>,<span class="number">20</span>,<span class="number">16</span>,<span class="number">5</span>,<span class="number">112</span>,<span class="number">101</span>,<span class="number">116</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">32</span>,<span class="number">-23</span>,<span class="number">7</span>]</span><br><span class="line"><span class="number">101</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line">peter</span><br><span class="line"><span class="number">1001</span></span><br></pre></td></tr></table></figure><h1 id="javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</h1><p>Player.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- ç©å®¶å¯¹è±¡</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Player</span> <span class="title">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - */</span></span><br><span class="line">    private <span class="keyword">static</span> final long serialVersionUID = <span class="number">-5248069984631225347</span>L;</span><br><span class="line"></span><br><span class="line">  public Player(long playerId,  int age, <span class="built_in">String</span> name) &#123;</span><br><span class="line">  <span class="keyword">this</span>.playerId = playerId;</span><br><span class="line">  <span class="keyword">this</span>.age = age;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private long playerId;</span><br><span class="line"></span><br><span class="line">  private int age;</span><br><span class="line"></span><br><span class="line">  private <span class="built_in">String</span> name;</span><br><span class="line"></span><br><span class="line">  private List&lt;Integer&gt; skills = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  public long getPlayerId() &#123;</span><br><span class="line">  <span class="keyword">return</span> playerId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setPlayerId(long playerId) &#123;</span><br><span class="line">  <span class="keyword">this</span>.playerId = playerId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public int getAge() &#123;</span><br><span class="line">  <span class="keyword">return</span> age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setAge(int age) &#123;</span><br><span class="line">  <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="built_in">String</span> getName() &#123;</span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setName(<span class="built_in">String</span> name) &#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public List&lt;Integer&gt; getSkills() &#123;</span><br><span class="line">  <span class="keyword">return</span> skills;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">void</span> setSkills(List&lt;Integer&gt; skills) &#123;</span><br><span class="line">  <span class="keyword">this</span>.skills = skills;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>JAVA2Bytes.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">package com.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JAVA2Bytes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line">byte[] bytes = toBytes();</span><br><span class="line">toPlayer(bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"> * @throws IOException </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> byte[] toBytes() throws IOException&#123;</span><br><span class="line"></span><br><span class="line">Player player = <span class="keyword">new</span> Player(<span class="number">101</span>, <span class="number">20</span>, <span class="string">"peter"</span>);</span><br><span class="line">player.getSkills().add(<span class="number">1001</span>);</span><br><span class="line"></span><br><span class="line">ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†™å…¥å¯¹è±¡</span></span><br><span class="line">objectOutputStream.writeObject(player);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å– å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="comment">//ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);</span></span><br><span class="line"><span class="comment">//æœ€ç»ˆæ˜¯å†™åˆ°byteArrayOutputStreamä¸­ï¼Œæ‰€ä»¥é€šè¿‡byteArrayOutputStreamè·å¾—ã€‚</span></span><br><span class="line">byte[] byteArray = byteArrayOutputStream.toByteArray();</span><br><span class="line">System.out.println(Arrays.toString(byteArray));</span><br><span class="line"><span class="keyword">return</span> byteArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ååºåˆ—åŒ–</span></span><br><span class="line"><span class="comment"> * @param bs</span></span><br><span class="line"><span class="comment"> * @throws Exception </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> toPlayer(byte[] bs) throws Exception&#123;</span><br><span class="line"></span><br><span class="line">ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(bs));</span><br><span class="line">Player player = (Player)inputStream.readObject();</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°</span></span><br><span class="line"> System.out.println(<span class="string">"playerId:"</span> + player.getPlayerId());</span><br><span class="line"> System.out.println(<span class="string">"age:"</span> + player.getAge());</span><br><span class="line"> System.out.println(<span class="string">"name:"</span> + player.getName());</span><br><span class="line"> System.out.println(<span class="string">"skills:"</span> + (Arrays.toString(player.getSkills().toArray())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">-84</span>,<span class="number">-19</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">115</span>,<span class="number">114</span>,<span class="number">0</span>,<span class="number">15</span>,<span class="number">99</span>,<span class="number">111</span>,<span class="number">109</span>,<span class="number">46</span>,<span class="number">106</span>,<span class="number">97</span>,<span class="number">118</span>,<span class="number">97</span>,<span class="number">46</span>,<span class="number">80</span>,<span class="number">108.</span>.......]</span><br><span class="line"><span class="number">101</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line">peter</span><br><span class="line"><span class="number">1001</span></span><br></pre></td></tr></table></figure><p></p><h1 id="ä¸åŒ"><a href="#ä¸åŒ" class="headerlink" title="ä¸åŒ"></a>ä¸åŒ</h1><p>javaåºåˆ—åŒ–å‡ºæ¥çš„å­—èŠ‚æ•°ç»„æ¯”proto buffçš„é•¿å¾ˆå¤šï¼Œå­—èŠ‚æ•°ç»„çŸ­çš„è¯èƒ½å¤Ÿå‡å°‘å¾ˆå¤šçš„å¸¦å®½ã€‚</p><p>ä¸ºä»€ä¹ˆï¼Ÿ</p><p>javaä¸­çš„å­—èŠ‚æ•°ç»„åŒ…æ‹¬è¿™ä¸ªç±»çš„ç±»ä¿¡æ¯ã€è¿™ä¸ªç±»æœ‰å“ªä¸ªå­—æ®µã€åè®®å¤´ã€æ¯ä¸ªç±»å«ä»€ä¹ˆåç§°ã€æ¯ä¸ªç±»æ˜¯ä»€ä¹ˆç±»å‹çš„ã€æœ€åçš„æ•°å€¼æ˜¯å¤šå°‘ç­‰ã€‚</p><p>proto buffä¸è®¸è¦æœ‰é…ç½®æ–‡ä»¶ï¼Œjavaä¸éœ€è¦åªè¦åŒæ–¹éƒ½æ˜¯javaå°±è¡Œï¼Œæ‰€ä»¥proto buffå…¶å®æ˜¯æŠŠç±»çš„åç§°ã€ç±»å‹ã€å­—æ®µç­‰éƒ½å†™åˆ°äº†é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„æ—¶å€™é›†æˆäº†è¿™äº›æè¿°ä¿¡æ¯ï¼Œæ‰€ä»¥å­—èŠ‚å¾ˆçŸ­ã€‚</p><p>proto buffåˆ†é…ç©ºé—´æ˜¯æœ‰ä¼¸ç¼©æ€§çš„ï¼Œæ¯”å¦‚int åœ¨å†…å­˜ä¸­æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œproto buffæ ¹æ®å®é™…å¤§å°åˆ†é…1-5ä¸ªå­—èŠ‚ï¼Œä»æ¦‚ç‡å­¦çš„è§’åº¦è®²å¤§éƒ¨åˆ†å¯èƒ½éƒ½æ˜¯ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå­—èŠ‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šnettyå­¦ä¹ ä¹‹å¿ƒè·³</title>
    <link href="http://mmmmmm.me/2019-03-10-7.html"/>
    <id>http://mmmmmm.me/2019-03-10-7.html</id>
    <published>2019-03-10T02:21:07.000Z</published>
    <updated>2019-03-10T15:09:07.694Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="idleStateHandler"><a href="#idleStateHandler" class="headerlink" title="idleStateHandler"></a>idleStateHandler</h1><p>Nettyæä¾›çš„æ£€æµ‹ä¼šè¯çŠ¶æ€çš„å·¥å…·ã€‚</p><h2 id="netty3ğŸŒ°"><a href="#netty3ğŸŒ°" class="headerlink" title="netty3ğŸŒ°"></a>netty3ğŸŒ°</h2><p>Server.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.heart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.timeout.IdleStateHandler;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.util.HashedWheelTimer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™</span></span><br><span class="line">ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line">bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br><span class="line"><span class="comment">//newä¸€ä¸ªå®šæ—¶å™¨</span></span><br><span class="line">final HashedWheelTimer hashedWheelTimer = <span class="keyword">new</span> HashedWheelTimer();</span><br><span class="line"><span class="comment">//è®¾ç½®ç®¡é“çš„å·¥å‚</span></span><br><span class="line">bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line"><span class="comment">//éœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªå¤„ç†ï¼Œhandleræ‰èƒ½å¤„ç†</span></span><br><span class="line"><span class="comment">//IdleStateHandlerå‚æ•°ï¼Œå®šæ—¶å™¨ï¼ˆåœ¨ä¸Šé¢å®šä¹‰äº†ï¼Œéœ€è¦newå‡ºæ¥ï¼‰ï¼Œè¯»è¶…æ—¶æ—¶é—´ï¼Œå†™è¶…æ—¶æ—¶é—´ï¼Œè¯»å†™è¶…æ—¶æ—¶é—´ã€‚</span></span><br><span class="line">pipeline.addLast(<span class="string">"idle"</span>, <span class="keyword">new</span> IdleStateHandler(hashedWheelTimer, <span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>));</span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">pipeline.addLast(<span class="string">"helloHandler"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"start!!!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HelloHanler.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.heart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelFutureListener;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.timeout.IdleState;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.timeout.IdleStateEvent;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> handleUpstream(final ChannelHandlerContext ctx, ChannelEvent e) throws Exception &#123;</span><br><span class="line"><span class="keyword">if</span> (e <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line"><span class="comment">//e.getStateè¿”å›çŠ¶æ€ï¼Œå¦‚æœå¤ªä¹…æ²¡æœ‰è¯»ï¼Œå°±ä¼šè¿”å›readï¼Œå¦‚æœå¤ªä¹…æ²¡æœ‰å†™å°±ä¼šè¿”å›writeï¼Œæ²¡æœ‰åº¦ä¹Ÿæ²¡æœ‰å†™è¿”å›ALL_IDE</span></span><br><span class="line"><span class="keyword">if</span>(((IdleStateEvent)e).getState() == IdleState.ALL_IDLE)&#123;</span><br><span class="line">System.out.println(<span class="string">"æç¤ºç©å®¶ä¸‹çº¿"</span>);</span><br><span class="line"><span class="comment">//å…³é—­ä¼šè¯ï¼Œè¸¢ç©å®¶ä¸‹çº¿</span></span><br><span class="line"><span class="comment">//å›å†™ç»™ç”¨æˆ·ï¼Œæç¤ºä¼šè¯å°†ä¼šå…³é—­ã€‚</span></span><br><span class="line">ChannelFuture write = ctx.getChannel().write(<span class="string">"time out, you will close"</span>);</span><br><span class="line">write.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> operationComplete(ChannelFuture future) throws Exception &#123;</span><br><span class="line"> ctx.getChannel().close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">super</span>.handleUpstream(ctx, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç­‰10ç§’ä¸è¯»ä¹Ÿä¸å†™å°±ä¼šè‡ªåŠ¨å…³é—­</p><h2 id="netty5ğŸŒ°"><a href="#netty5ğŸŒ°" class="headerlink" title="netty5ğŸŒ°"></a>netty5ğŸŒ°</h2><p>Server.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">package com.heart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * netty5æœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"> * @au</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"><span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">//bosså’Œworker</span></span><br><span class="line">EventLoopGroup boss = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">EventLoopGroup worker = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è®¾ç½®çº¿ç¨‹æ± </span></span><br><span class="line">bootstrap.group(boss, worker);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®socketå·¥å‚ã€</span></span><br><span class="line">bootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ç®¡é“å·¥å‚</span></span><br><span class="line">bootstrap.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> initChannel(Channel ch) throws Exception &#123;</span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">5</span>, <span class="number">5</span>, <span class="number">10</span>));</span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">ch.pipeline().addLast(<span class="keyword">new</span> ServerHandler());</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//netty3ä¸­å¯¹åº”è®¾ç½®å¦‚ä¸‹</span></span><br><span class="line"><span class="comment">//bootstrap.setOption("backlog", 1024);</span></span><br><span class="line"><span class="comment">//bootstrap.setOption("tcpNoDelay", true);</span></span><br><span class="line"><span class="comment">//bootstrap.setOption("keepAlive", true);</span></span><br><span class="line"><span class="comment">//è®¾ç½®å‚æ•°ï¼ŒTCPå‚æ•°</span></span><br><span class="line">bootstrap.option(ChannelOption.SO_BACKLOG, <span class="number">2048</span>);<span class="comment">//serverSocketchannelçš„è®¾ç½®ï¼Œé“¾æ¥ç¼“å†²æ± çš„å¤§å°</span></span><br><span class="line">bootstrap.childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);<span class="comment">//socketchannelçš„è®¾ç½®,ç»´æŒé“¾æ¥çš„æ´»è·ƒï¼Œæ¸…é™¤æ­»é“¾æ¥</span></span><br><span class="line">bootstrap.childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>);<span class="comment">//socketchannelçš„è®¾ç½®,å…³é—­å»¶è¿Ÿå‘é€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»‘å®šç«¯å£</span></span><br><span class="line">ChannelFuture future = bootstrap.bind(<span class="number">10101</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"start"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç­‰å¾…æœåŠ¡ç«¯å…³é—­</span></span><br><span class="line">future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line"><span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">boss.shutdownGracefully();</span><br><span class="line">worker.shutdownGracefully();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ServerHandler.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">package com.heart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFutureListener;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleState;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateEvent;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœåŠ¡ç«¯æ¶ˆæ¯å¤„ç†</span></span><br><span class="line"><span class="comment"> * @</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, <span class="built_in">String</span> msg) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(msg);</span><br><span class="line"></span><br><span class="line">ctx.channel().writeAndFlush(<span class="string">"hi"</span>);</span><br><span class="line">ctx.writeAndFlush(<span class="string">"hi"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> userEventTriggered(final ChannelHandlerContext ctx, <span class="built_in">Object</span> evt) throws Exception &#123;</span><br><span class="line"><span class="keyword">if</span>(evt <span class="keyword">instanceof</span> IdleStateEvent)&#123;</span><br><span class="line">IdleStateEvent event = (IdleStateEvent)evt;</span><br><span class="line"><span class="keyword">if</span>(event.state() == IdleState.ALL_IDLE)&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¸…é™¤è¶…æ—¶ä¼šè¯</span></span><br><span class="line">ChannelFuture writeAndFlush = ctx.writeAndFlush(<span class="string">"you will close"</span>);</span><br><span class="line">writeAndFlush.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> operationComplete(ChannelFuture future) throws Exception &#123;</span><br><span class="line">ctx.channel().close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å®¢æˆ·ç«¯æ¥å…¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelActive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelActive"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¢æˆ·ç«¯æ–­å¼€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> channelInactive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">System.out.println(<span class="string">"channelInactive"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</span><br><span class="line">cause.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ol><li>å¿ƒè·³å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¯·æ±‚ï¼Œç‰¹ç‚¹æ•°æ®ç®€å•ï¼Œä¸šåŠ¡ä¹Ÿç®€å•</li></ol><ol start="2"><li>å¿ƒè·³å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå®šæ—¶æ¸…é™¤é—²ç½®ä¼šè¯inactive(netty5) channelclose(netty3)</li></ol><p>å‡å¦‚å®¢æˆ·ç«¯çªç„¶åœç”µäº†ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè¯ä¿å­˜ç€ï¼Œç„¶åæœ‰ç”µäº†ä¹‹åï¼Œå†æ¬¡è¯·æ±‚ä¼šé‡æ–°å»ºç«‹ä¼šè¯ï¼ŒåŸæ¥çš„ä¼šè¯å°±æˆäº†åƒµå°¸ä¼šè¯ï¼Œéœ€è¦å®šæ—¶å»æ¸…ç†è¿™äº›åƒµå°¸ä¼šè¯ã€‚åå°è¿˜å¯ä»¥è¿”å›ç³»ç»Ÿæ—¶é—´ï¼Œè¾¾åˆ°ä¸€ä¸ªé˜²ä½œå¼Šçš„æ•ˆæœï¼Œå‰ç«¯ä¿®æ”¹ç³»ç»Ÿæ—¶é—´å¯ä»¥è¾¾åˆ°ä¸€ä¸ªæ¸¸æˆåŠ é€Ÿçš„ä½œç”¨ã€‚</p><ol start="3"><li>å¿ƒè·³å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œç”¨æ¥æ£€æµ‹ä¼šè¯æ˜¯å¦æ–­å¼€ï¼Œæ˜¯å¦é‡è¿ï¼ ç”¨æ¥æ£€æµ‹ç½‘ç»œå»¶æ—¶ï¼</li></ol><p>æ‰‹æœºappä¸­ç»å¸¸æœ‰æ–­å¼€è¿æ¥ã€é‡æ–°è¿æ¥çš„æ“ä½œã€‚ç©ç‹è€…çš„æ—¶å€™å³ä¸Šè§’æœ‰ä¸€ä¸ªç½‘ç»œå»¶è¿Ÿï¼Œå°±æ˜¯å¿ƒè·³åšçš„ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;idleStateHandler&quot;&gt;&lt;a href=&quot;#idleStateHandler&quot; class=&quot;head
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆå…­ï¼‰ï¼šnetty5æ¡ˆä¾‹å­¦ä¹ </title>
    <link href="http://mmmmmm.me/2019-03-10-6.html"/>
    <id>http://mmmmmm.me/2019-03-10-6.html</id>
    <published>2019-03-10T02:21:06.000Z</published>
    <updated>2019-03-10T15:09:05.283Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹"><a href="#netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹"></a>netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹</h1><p>Server.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelOption;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- netty5æœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">  <span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">  ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">//bosså’Œworker</span></span><br><span class="line">  <span class="comment">//åœ¨å‰é¢çš„3é‡Œé¢çš„ä¾‹å­è¿™é‡Œæ˜¯ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œåœ¨5é‡Œé¢åšäº†ä¸€æ¬¡å°è£…</span></span><br><span class="line">  <span class="comment">//EventLoopGroupè¿™ä¸ªç±»ä¸­è¿˜æ˜¯åŒ…å«çº¿ç¨‹æ± è¿™ä¸ªå±æ€§çš„</span></span><br><span class="line">  EventLoopGroup boss = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">  EventLoopGroup worker = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">//è®¾ç½®çº¿ç¨‹æ± </span></span><br><span class="line">  bootstrap.group(boss, worker);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®socketå·¥å‚ã€</span></span><br><span class="line">  <span class="comment">//åœ¨3ä¸­ bootstrap.setFactory(new NioServerSocketChannelFactory(boss, worker));</span></span><br><span class="line">  </span><br><span class="line">  bootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®ç®¡é“å·¥å‚</span></span><br><span class="line">  <span class="comment">//åœ¨3ä¸­bootstrap.setPipelineFactory(new ChannelPipelineFactory() &#123;</span></span><br><span class="line">  <span class="comment">//ç®¡é“æœ€ç»ˆæ˜¯è¦æ”¾åˆ°channelä¸­çš„ï¼Œè¿™è¾¹ä¸æ˜¯æŠŠç®¡é“ä¼ è¿‡æ¥ï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ‹¥æœ‰ç®¡é“çš„channelï¼Œä¼ è¿‡æ¥ï¼Œ</span></span><br><span class="line">  <span class="comment">//æˆ‘ä»¬è‡ªå·±å»è®¾ç½®ç®¡é“</span></span><br><span class="line">  bootstrap.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</span><br><span class="line">  </span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> initChannel(Channel ch) throws Exception &#123;</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> ServerHandler());</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//netty3ä¸­å¯¹åº”è®¾ç½®å¦‚ä¸‹</span></span><br><span class="line">  <span class="comment">//bootstrap.setOption("backlog", 1024);</span></span><br><span class="line">  <span class="comment">//bootstrap.setOption("tcpNoDelay", true);</span></span><br><span class="line">  <span class="comment">//bootstrap.setOption("keepAlive", true);</span></span><br><span class="line">  <span class="comment">//è®¾ç½®å‚æ•°ï¼ŒTCPå‚æ•°</span></span><br><span class="line">  <span class="comment">//serverSocketchannelçš„è®¾ç½®ï¼Œé“¾æ¥ç¼“å†²æ± çš„å¤§å°</span></span><br><span class="line">  <span class="comment">//acceptæ“ä½œæ˜¯ä»ç¼“å­˜é˜Ÿåˆ—é‡Œé¢æ‹¿åˆ°ä¸»æœºï¼ŒåŠ å…¥æœ‰2048ä¸ªä¸»æœºè¿æ¥è¿›æ¥ï¼Œç¬¬2049ä¸ªä¸»æœºæƒ³å†æ¬¡è¿æ¥è¿›æ¥</span></span><br><span class="line">  <span class="comment">//å°±ä¼šè¢«æ‹’ç»</span></span><br><span class="line">  bootstrap.option(ChannelOption.SO_BACKLOG, <span class="number">2048</span>);</span><br><span class="line">  <span class="comment">//socketchannelçš„è®¾ç½®,ç»´æŒé“¾æ¥çš„æ´»è·ƒï¼Œæ¸…é™¤æ­»é“¾æ¥</span></span><br><span class="line">  <span class="comment">//åŠ å…¥æœ‰è¿æ¥åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´æ—¢æ²¡æœ‰è¯»ä¹Ÿæ²¡æœ‰å†™ï¼Œå°±ä¼šè‡ªåŠ¨å…³æ‰è¿™ä¸ªè¿æ¥</span></span><br><span class="line">  bootstrap.childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//socketchannelçš„è®¾ç½®,å…³é—­å»¶è¿Ÿå‘é€</span></span><br><span class="line">  <span class="comment">//tcpæ˜¯æœ‰æ‰¹é‡å‘é€çš„ç®—æ³•çš„ï¼Œè¿™é‡Œè®¾ç½®ä¸ºtrueï¼Œè¿›è¡Œå…³é—­</span></span><br><span class="line">  bootstrap.childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ç»‘å®šç«¯å£</span></span><br><span class="line">  ChannelFuture future = bootstrap.bind(<span class="number">10101</span>);</span><br><span class="line">  </span><br><span class="line">  System.out.println(<span class="string">"start"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ç­‰å¾…æœåŠ¡ç«¯å…³é—­</span></span><br><span class="line">  <span class="comment">//è¿™é‡Œçš„channelæ˜¯serversocketchannelæˆ–è€…ç›‘å¬ç«¯å£çš„channel</span></span><br><span class="line">  <span class="comment">//.sync()å°±ä¼šé˜»å¡åœ¨è¿™é‡Œç­‰å¾…channelå…³é—­ä¹‹åå†ç»§ç»­å¾€ä¸‹èµ°ã€‚</span></span><br><span class="line">  future.channel().closeFuture().sync();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">  &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">  <span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">  boss.shutdownGracefully();</span><br><span class="line">  worker.shutdownGracefully();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ServerHandler.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- æœåŠ¡ç«¯æ¶ˆæ¯å¤„ç†</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, <span class="built_in">String</span> msg) throws Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¾—åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line"><span class="comment">//3ä¸­ String s = (String) e.getMessage()</span></span><br><span class="line"><span class="comment">//è¿™é‡Œå¯ä»¥æ‹¿æ¥ç›´æ¥ç”¨</span></span><br><span class="line">  System.out.println(msg);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ä¸‹é¢ä¸¤ç§å›å†™éƒ½æ˜¯å¯ä»¥çš„ï¼Œä»–ä»¬ä¸¤ä¸ªè°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•</span></span><br><span class="line">  ctx.channel().writeAndFlush(<span class="string">"hi"</span>);</span><br><span class="line">  ctx.writeAndFlush(<span class="string">"hi"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ–°å®¢æˆ·ç«¯æ¥å…¥,ç›¸å½“äº3ä¸­çš„channelConnected</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelActive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelActive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å®¢æˆ·ç«¯æ–­å¼€</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Overrideï¼Œç›¸å½“äº<span class="number">3</span>ä¸­çš„channelDisconnected</span><br><span class="line">    public <span class="keyword">void</span> channelInactive(ChannelHandlerContext ctx) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelInactive"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å¼‚å¸¸</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</span><br><span class="line">    cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡telnetè¿›è¡Œæµ‹è¯•</p><h1 id="netty5å®¢æˆ·ç«¯å…¥é—¨æ¡ˆä¾‹"><a href="#netty5å®¢æˆ·ç«¯å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="netty5å®¢æˆ·ç«¯å…¥é—¨æ¡ˆä¾‹"></a>netty5å®¢æˆ·ç«¯å…¥é—¨æ¡ˆä¾‹</h1><p>Client.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- netty5çš„å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">  <span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">  Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">  <span class="comment">//å› ä¸ºbossæ˜¯ç›‘å¬ç«¯å£çš„æ‰€ä»¥è¿™é‡Œåªéœ€è¦worker</span></span><br><span class="line">  <span class="comment">//worker</span></span><br><span class="line">  EventLoopGroup worker = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">//è®¾ç½®çº¿ç¨‹æ± </span></span><br><span class="line">  bootstrap.group(worker);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®socketå·¥å‚ã€</span></span><br><span class="line">  bootstrap.channel(NioSocketChannel.class);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®ç®¡é“</span></span><br><span class="line">  bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</span><br><span class="line">  </span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> initChannel(Channel ch) throws Exception &#123;</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">  ch.pipeline().addLast(<span class="keyword">new</span> ClientHandler());</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  ChannelFuture connect = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">10101</span>);</span><br><span class="line">  </span><br><span class="line">  BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">  System.out.println(<span class="string">"è¯·è¾“å…¥ï¼š"</span>);</span><br><span class="line">  <span class="built_in">String</span> msg = bufferedReader.readLine();</span><br><span class="line">  connect.channel().writeAndFlush(msg);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">  &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">  worker.shutdownGracefully();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ClientHandler</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- å®¢æˆ·ç«¯æ¶ˆæ¯å¤„ç†</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, <span class="built_in">String</span> msg) throws Exception &#123;</span><br><span class="line">  System.out.println(<span class="string">"å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯:"</span>+msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å•å®¢æˆ·ç«¯å¤šè¿æ¥ç¨‹åº"><a href="#å•å®¢æˆ·ç«¯å¤šè¿æ¥ç¨‹åº" class="headerlink" title="å•å®¢æˆ·ç«¯å¤šè¿æ¥ç¨‹åº"></a>å•å®¢æˆ·ç«¯å¤šè¿æ¥ç¨‹åº</h1><h2 id="çŸ¥è¯†æ™®åŠ"><a href="#çŸ¥è¯†æ™®åŠ" class="headerlink" title="çŸ¥è¯†æ™®åŠ"></a>çŸ¥è¯†æ™®åŠ</h2><h3 id="çº¿ç¨‹æ± åŸç†å›¾"><a href="#çº¿ç¨‹æ± åŸç†å›¾" class="headerlink" title="çº¿ç¨‹æ± åŸç†å›¾"></a>çº¿ç¨‹æ± åŸç†å›¾</h3><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190307071625733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å½“ä»»åŠ¡è¿›æ¥çš„æ—¶å€™ï¼Œå°†ä»»åŠ¡æ”¾åˆ°å„ä¸ªçº¿ç¨‹å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼Œçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡äº†å°±å»é˜Ÿåˆ—é‡Œé¢å–ï¼Œå› ä¸ºæœ‰è¿™äº›é˜Ÿåˆ—çš„å­˜åœ¨æ‰€ä»¥æ˜¯å¹¶å‘æ‰§è¡Œã€‚<br>ä¸€ä¸ªthread+é˜Ÿåˆ—======ã€‹ä¸€ä¸ªå•çº¿ç¨‹çº¿ç¨‹æ±  ======ã€‹çº¿ç¨‹å®‰å…¨çš„ï¼Œä»»åŠ¡æ˜¯çº¿æ€§æ‰§è¡Œçš„</p><p>ç»´æŠ¤å¤šä¸ªç¼“å­˜å¯¹è±¡é€šå¸¸ä¼šæœ‰ä¸¤ç§è®¾è®¡æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯åšæˆå¯¹è±¡æ± ï¼Œä¸€ç§æ˜¯åšæˆå¯¹è±¡ç»„ã€‚</p><h3 id="å¯¹è±¡æ± åŸç†å›¾"><a href="#å¯¹è±¡æ± åŸç†å›¾" class="headerlink" title="å¯¹è±¡æ± åŸç†å›¾"></a>å¯¹è±¡æ± åŸç†å›¾</h3><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190307072250874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>åˆå§‹åŒ–nä¸ªå¯¹è±¡æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ‹¿å‡ºæ¥ç›´æ¥ç”¨ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæ‹¿å»ç”¨ï¼Œç”¨å®Œä¹‹åå½’è¿˜ç»™çº¿ç¨‹æ± ï¼Œå‘ç°å¤šäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥é”€æ¯ï¼Œä¹Ÿå¯ä»¥ç­‰å¾…çº¿ç¨‹æ± ä¸­æœ‰å¯ç”¨çš„å¯¹è±¡å†æ‰§è¡Œç›¸å…³çš„ä»»åŠ¡ã€‚<br>å¯¹è±¡æ± é€šå¸¸ç”¨åœ¨ï¼Œå¯¹è±¡æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„æˆ–è€…å¯¹è±¡åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æ—¶å€™ä¼šå‡ºç°é˜»å¡æ•ˆåº”çš„æ—¶å€™ã€‚</p><h3 id="å¯¹è±¡ç»„åŸç†å›¾"><a href="#å¯¹è±¡ç»„åŸç†å›¾" class="headerlink" title="å¯¹è±¡ç»„åŸç†å›¾"></a>å¯¹è±¡ç»„åŸç†å›¾</h3><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190307072313202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å› ä¸ºå¯¹è±¡è¿˜åœ¨æ•°ç»„ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦å½’è¿˜å¯¹è±¡ã€‚<br>æ•°ç»„ä¸­çš„å¯¹è±¡å¯èƒ½ä¼šè¢«å¤šä¸ªå¯¹è±¡è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦æ•°ç»„ä¸­çš„å¯¹è±¡å…·æœ‰é”å¹¶å‘çš„èƒ½åŠ›ï¼Œå¦åˆ™ä¸é€‚åˆç”¨å¯¹è±¡ç»„çš„æ–¹å¼</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­Nettyè¦å¹¶å‘å†™çš„æ˜¯channel</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>å•ä¸ªçº¿ç¨‹å®‰å…¨ï¼Œä¸ä¼šäº§ç”Ÿé˜»å¡æ•ˆåº”ï¼Œä½¿ç”¨å¯¹è±¡ç»„<br>å•ä¸ªçº¿ç¨‹ä¸å®‰å…¨ï¼Œä¼šäº§ç”Ÿé˜»å¡æ•ˆåº”ï¼Œä½¿ç”¨å¯¹è±¡æ± </p><h3 id="ç†è®ºç»“åˆå®é™…"><a href="#ç†è®ºç»“åˆå®é™…" class="headerlink" title="ç†è®ºç»“åˆå®é™…"></a>ç†è®ºç»“åˆå®é™…</h3><p>nettyä¸­çš„channelæ˜¯æ”¯æŒå¹¶å‘çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connect.channel().writeAndFlush(msg)<span class="comment">//writeAndFlushå¾€ä¸‹ç‚¹</span></span><br><span class="line">|</span><br><span class="line">AbstractChannelHandlerContext<span class="comment">//writeAndFlushç‚¹å‡»invokeWrite</span></span><br><span class="line">|</span><br><span class="line">DefaultChannelHandleInvoker</span><br><span class="line"><span class="comment">//å…³æ³¨writeAndFlushæ–¹æ³•ï¼Œå‡å¦‚å½“å‰æ˜¯workerçº¿ç¨‹ï¼Œå°±ç›´æ¥å†™ï¼Œå‡å¦‚ä¸æ˜¯å°±å°è£…æˆä¸€ä¸ªä»»åŠ¡æ‰”åˆ°ä¸€ä¸ªçº¿ç¨‹æ± ä¸­ï¼ŒsafeExecuteOutboundæ–¹æ³•</span></span><br><span class="line">|</span><br><span class="line"><span class="comment">//è¿›å…¥safeExecuteOutboundï¼Œé‡Œé¢çš„çº¿ç¨‹æ± æ˜¯ä¸€ä¸ªNioEventoopå¯¹è±¡ï¼Œç»§æ‰¿è‡ªSingleThreadEventLoopï¼Œ</span></span><br><span class="line"><span class="comment">//å†ç»§æ‰¿SingleThreadEventLoopExecuterï¼Œå³å•çº¿ç¨‹çº¿ç¨‹æ± </span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªthread+é˜Ÿåˆ—======ã€‹ä¸€ä¸ªå•çº¿ç¨‹çº¿ç¨‹æ±  ======ã€‹çº¿ç¨‹å®‰å…¨çš„ï¼Œä»»åŠ¡æ˜¯çº¿æ€§æ‰§è¡Œçš„</p><p>å› ä¸ºchannelæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æœ€åé‡‡ç”¨å¯¹è±¡ç»„çš„æ–¹å¼ã€‚</p><h2 id="å¼€å¹²å¼€å¹²"><a href="#å¼€å¹²å¼€å¹²" class="headerlink" title="å¼€å¹²å¼€å¹²"></a>å¼€å¹²å¼€å¹²</h2><p>MultClient.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- å¤šè¿æ¥å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">MultClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æœåŠ¡ç±»</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - ä¼šè¯    ç¼“å­˜å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private List&lt;Channel&gt; channels = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private final AtomicInteger index = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - @param count</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">void</span> init(int count)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//worker</span></span><br><span class="line">    EventLoopGroup worker = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®çº¿ç¨‹æ± </span></span><br><span class="line">    bootstrap.group(worker);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®socketå·¥å‚ã€</span></span><br><span class="line">    bootstrap.channel(NioSocketChannel.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®ç®¡é“</span></span><br><span class="line">    bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected <span class="keyword">void</span> initChannel(Channel ch) throws Exception &#123;</span><br><span class="line">    ch.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">    ch.pipeline().addLast(<span class="keyword">new</span> StringEncoder());</span><br><span class="line">    ch.pipeline().addLast(<span class="keyword">new</span> ClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(int i=<span class="number">1</span>; i&lt;=count; i++)&#123;</span><br><span class="line">    ChannelFuture future = bootstrap.connect(<span class="string">"192.168.0.103"</span>, <span class="number">10101</span>);</span><br><span class="line">    channels.add(future.channel());</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - è·å–ä¼šè¯</span></span><br><span class="line"><span class="comment">  - @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public Channel nextChannel()&#123;</span><br><span class="line">    <span class="keyword">return</span> getFirstActiveChannel(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  private Channel getFirstActiveChannel(int count)&#123;</span><br><span class="line">  Channel channel = channels.get(<span class="built_in">Math</span>.abs(index.getAndIncrement() % channels.size()));</span><br><span class="line">  <span class="keyword">if</span>(!channel.isActive())&#123;</span><br><span class="line">  <span class="comment">//é‡è¿</span></span><br><span class="line">  reconnect(channel);</span><br><span class="line">  <span class="comment">//å¦‚æœå·²ç»æ²¡æœ‰channelå¯ç”¨äº†</span></span><br><span class="line">  <span class="keyword">if</span>(count &gt;= channels.size())&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"no can use channel"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getFirstActiveChannel(count + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> channel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - é‡è¿</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - @param channel</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="keyword">void</span> reconnect(Channel channel)&#123;</span><br><span class="line">    synchronized(channel)&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯-1ï¼Œè¯´æ˜å·²ç»ä¸åœ¨channelæ•°ç»„ä¸­äº†ï¼Œå·²ç»ç§»é™¤æ‰äº†</span></span><br><span class="line">    <span class="keyword">if</span>(channels.indexOf(channel) == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    Channel newChannel = bootstrap.connect(<span class="string">"192.168.0.103"</span>, <span class="number">10101</span>).channel();</span><br><span class="line">    channels.set(channels.indexOf(channel), newChannel);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Start.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- å¯åŠ¨ç±»</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- @au</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Start</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  MultClient client = <span class="keyword">new</span> MultClient();</span><br><span class="line">  client.init(<span class="number">5</span>);</span><br><span class="line">  </span><br><span class="line">  BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  System.out.println(<span class="string">"è¯·è¾“å…¥:"</span>);</span><br><span class="line">  <span class="built_in">String</span> msg = bufferedReader.readLine();</span><br><span class="line">  client.nextChannel().writeAndFlush(msg);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ======ã€‹è¾“å‡ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">channelActive</span><br><span class="line">channelActive</span><br><span class="line">channelActive</span><br><span class="line">channelActive</span><br><span class="line">channelActive</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æ–­å¼€æœ¬æœºçš„ç½‘ç»œï¼ˆå¦‚æœä¸Šé¢å®¢æˆ·ç«¯å°è¯•è¿æ¥çš„æ˜¯127.0.0.1çš„è¯ï¼Œæ–­å¼€ä¹Ÿèƒ½è¿æ¥ï¼Œæ‰€ä»¥å³ä½¿æ˜¯è¿æ¥æœ¬æœºæœåŠ¡ç«¯ï¼Œä¹Ÿè¦å†™æˆçœŸæ­£çš„ipåœ°å€ï¼‰ï¼ŒæŠ›å‡ºå¼‚å¸¸</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException:no can use channel</span><br></pre></td></tr></table></figure><p>ç„¶åå†æ¬¡å¼€å¯ç½‘ç»œï¼Œåœ¨while true çš„å¸®åŠ©ä¸‹è‡ªåŠ¨é‡è¿ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å› ä¸ºchannelæœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¤šå®¢æˆ·ç«¯è¿ä¸€ä¸ªæœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°è¯•éé˜»å¡çš„æ–¹å¼ï¼Œå³å¯¹è±¡ç»„ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹&quot;&gt;&lt;a href=&quot;#netty5æœåŠ¡ç«¯å…¥é—¨æ¡ˆä¾‹&quot; class=&quot;headerlink
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆäº”ï¼‰ï¼šnettyçº¿ç¨‹æ¨¡å‹æºç åˆ†æï¼ˆäºŒï¼‰</title>
    <link href="http://mmmmmm.me/2019-03-10-5.html"/>
    <id>http://mmmmmm.me/2019-03-10-5.html</id>
    <published>2019-03-10T02:21:05.000Z</published>
    <updated>2019-03-10T15:09:02.915Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰"><a href="#å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰" class="headerlink" title="å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰"></a>å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰</h1><p>ä¸€æ–­ç‚¹<br>äºŒæ‰“å°<br>ä¸‰çœ‹è°ƒç”¨æ ˆ<br>å››æœç´¢</p><h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line"><span class="comment">//NioServerSocketChannelFactoryçœ‹ä¸‹é¢</span></span><br><span class="line">  bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br></pre></td></tr></table></figure><p>NioServerSocketChannelFactory.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public NioServerSocketChannelFactory(</span><br><span class="line">            Executor bossExecutor, Executor workerExecutor) &#123;</span><br><span class="line">            <span class="comment">//é¦–å…ˆè·å–å½“å‰workerçš„æ•°é‡,ä»£ç çœ‹ä¸‹é¢çš„SelectorUtil.java</span></span><br><span class="line">            <span class="comment">//æ¥ç€ä¼šè°ƒç”¨ä¸‹é¢ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•NioServerSocketChannelFactory</span></span><br><span class="line">        <span class="keyword">this</span>(bossExecutor, workerExecutor, getMaxThreads(workerExecutor));</span><br><span class="line">&#125;</span><br><span class="line">public NioServerSocketChannelFactory(</span><br><span class="line">            Executor bossExecutor, Executor workerExecutor,</span><br><span class="line">            int workerCount) &#123;</span><br><span class="line">            <span class="comment">//æ¥ç€è°ƒç”¨ä¸‹é¢å››ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•NioServerSocketChannelFactory</span></span><br><span class="line">            <span class="comment">//bossé»˜è®¤ç»™çš„1</span></span><br><span class="line">        <span class="keyword">this</span>(bossExecutor, <span class="number">1</span>, workerExecutor, workerCount);</span><br><span class="line">&#125;</span><br><span class="line">public NioServerSocketChannelFactory(</span><br><span class="line">            Executor bossExecutor, int bossCount, Executor workerExecutor,</span><br><span class="line">            int workerCount) &#123;</span><br><span class="line">            <span class="comment">//å¼€å§‹newä¸€ä¸ªworkerçš„æ± å­</span></span><br><span class="line">            <span class="comment">//ä»£ç çœ‹ä¸‹é¢çš„NioWorkerPool.java</span></span><br><span class="line">        <span class="keyword">this</span>(bossExecutor, bossCount, <span class="keyword">new</span> NioWorkerPool(workerExecutor, workerCount));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SelectorUtil.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤æ•°é‡æ˜¯å½“å‰çš„æ ¸æ•°æˆ2</span></span><br><span class="line"><span class="keyword">static</span> final int DEFAULT_IO_THREADS = Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"> private <span class="keyword">static</span> int getMaxThreads(Executor executor) &#123;</span><br><span class="line"> <span class="comment">//MaxThreadsæœ€å¤§æ± å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span> (executor <span class="keyword">instanceof</span> ThreadPoolExecutor) &#123;</span><br><span class="line">            final int maxThreads = ((ThreadPoolExecutor) executor).getMaximumPoolSize();</span><br><span class="line">            <span class="comment">//å–maxThreadså’ŒDEFAULT_IO_THREADSä¸¤è€…çš„æœ€å°å€¼</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Math</span>.min(maxThreads, SelectorUtil.DEFAULT_IO_THREADS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­ä¸­æ˜¯ç»™çš„æ— é™å¤§å°çš„æ± å­ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›DEFAULT_IO_THREADS</span></span><br><span class="line">        <span class="keyword">return</span> SelectorUtil.DEFAULT_IO_THREADS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>NioWorkerPool.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public NioWorkerPool(Executor workerExecutor, int workerCount) &#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨è‡ªå·±çš„NioWorkerPoolæ–¹æ³•ï¼Œåœ¨ä¸‹é¢</span></span><br><span class="line">        <span class="keyword">this</span>(workerExecutor, workerCount, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">public NioWorkerPool(Executor workerExecutor, int workerCount, ThreadNameDeterminer determiner) &#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">super</span>(workerExecutor, workerCount, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.determiner = determiner;</span><br><span class="line">        <span class="comment">//initäº†ä¸€æ¬¡,ä»£ç çœ‹ä¸‹é¢initæ–¹æ³•</span></span><br><span class="line">        init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å®ç°äº†æŠ½è±¡æ–¹æ³•newWorker</span></span><br><span class="line">@Override</span><br><span class="line">protected NioWorker newWorker(Executor executor) &#123;</span><br><span class="line"><span class="comment">//newäº†ä¸€ä¸ªNioWorker</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NioWorker(executor, determiner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NioWOrker.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public NioWorker(Executor executor, ThreadNameDeterminer determiner) &#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œçœ‹ä¸‹é¢AbstractNioWorker.java</span></span><br><span class="line">        <span class="keyword">super</span>(executor, determiner);</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">    protected boolean read(SelectionKey k) &#123;</span><br><span class="line">        final SocketChannel ch = (SocketChannel) k.channel();</span><br><span class="line">        final NioSocketChannel channel = (NioSocketChannel) k.attachment();</span><br><span class="line"></span><br><span class="line">        final ReceiveBufferSizePredictor predictor =</span><br><span class="line">            channel.getConfig().getReceiveBufferSizePredictor();</span><br><span class="line">        final int predictedRecvBufSize = predictor.nextReceiveBufferSize();</span><br><span class="line">        final ChannelBufferFactory bufferFactory = channel.getConfig().getBufferFactory();</span><br><span class="line"></span><br><span class="line">        int ret = <span class="number">0</span>;</span><br><span class="line">        int readBytes = <span class="number">0</span>;</span><br><span class="line">        boolean failure = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        ByteBuffer bb = recvBufferPool.get(predictedRecvBufSize).order(bufferFactory.getDefaultOrder());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((ret = ch.read(bb)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                readBytes += ret;</span><br><span class="line">                <span class="keyword">if</span> (!bb.hasRemaining()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            failure = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">            <span class="comment">// Can happen, and does not need a user attention.</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            fireExceptionCaught(channel, t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            bb.flip();</span><br><span class="line"><span class="comment">//åœ¨è¿™é‡Œå°è£…æˆäº†ChannelBuffer</span></span><br><span class="line">            final ChannelBuffer buffer = bufferFactory.getBuffer(readBytes);</span><br><span class="line">            buffer.setBytes(<span class="number">0</span>, bb);</span><br><span class="line">            buffer.writerIndex(readBytes);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the predictor.</span></span><br><span class="line">            predictor.previousReceiveBufferSize(readBytes);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Fire the event.äº§ç”Ÿä¸€ä¸ªä¸Šä¼ çš„äº‹ä»¶</span></span><br><span class="line">            <span class="comment">//channelsé‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•</span></span><br><span class="line">             <span class="comment">//   * @param message  the received message </span></span><br><span class="line">    <span class="comment">//public static void fireMessageReceived(Channel channel, Object message) &#123;</span></span><br><span class="line">        <span class="comment">//fireMessageReceived(channel, message, null);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">            fireMessageReceived(channel, buffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span> || failure) &#123;</span><br><span class="line">            k.cancel(); <span class="comment">// Some JDK implementations run into an infinite loop without this.</span></span><br><span class="line">            close(channel, succeededFuture(channel));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>AbstractNioWorker.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">AbstractNioWorker(Executor executor, ThreadNameDeterminer determiner) &#123;</span><br><span class="line"><span class="comment">//åˆè°ƒç”¨äº†çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œçœ‹ä¸‹é¢AbstractNioSelector.java</span></span><br><span class="line">        <span class="keyword">super</span>(executor, determiner);</span><br><span class="line"> &#125;</span><br><span class="line">  @Override</span><br><span class="line">    protected <span class="keyword">void</span> process(Selector selector) throws IOException &#123;</span><br><span class="line">        <span class="built_in">Set</span>&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">        <span class="comment">// check if the set is empty and if so just return to not create garbage by</span></span><br><span class="line">        <span class="comment">// creating a new Iterator every time even if there is nothing to process.</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/597</span></span><br><span class="line">        <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator(); i.hasNext();) &#123;</span><br><span class="line">            SelectionKey k = i.next();</span><br><span class="line">            i.remove();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                int readyOps = k.readyOps();</span><br><span class="line">                <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_READ) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//è¯»æ•°æ®ï¼Œå‘ä¸Šçœ‹NioWorkerä¸­çš„readæ–¹æ³•</span></span><br><span class="line">                    <span class="keyword">if</span> (!read(k)) &#123;</span><br><span class="line">                        <span class="comment">// Connection already closed - no need to handle write.</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</span><br><span class="line">                    writeFromSelectorLoop(k);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">                close(k);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cleanUpCancelledKeys()) &#123;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// break the loop to avoid ConcurrentModificationException</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>AbstractNioSelector.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">AbstractNioSelector(Executor executor, ThreadNameDeterminer determiner) &#123;</span><br><span class="line"><span class="comment">//ç»™äº†ä¸€ä¸ªçº¿ç¨‹æ± </span></span><br><span class="line">        <span class="keyword">this</span>.executor = executor;</span><br><span class="line"><span class="comment">//openSelectorçœ‹ä¸‹é¢openSelectoræ–¹æ³•</span></span><br><span class="line">        openSelector(determiner);</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">void</span> openSelector(ThreadNameDeterminer determiner) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®å½“å‰çš„selector</span></span><br><span class="line">            selector = SelectorUtil.open();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"Failed to create a selector."</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the worker thread with the new Selector.</span></span><br><span class="line">        boolean success = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æŠŠè¿™ä¸ªNioworkerè·‘èµ·æ¥ï¼Œå› ä¸ºNioWorkeræœ¬èº«æ˜¯ç»§æ‰¿AbstractNioSelectorè¿™ä¸ªç±»çš„</span></span><br><span class="line">        <span class="comment">//æ‰€ä»¥è·‘çš„æ˜¯è¿™ä¸ªç±»çš„runæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//ä»å“ªé‡Œå¯åŠ¨å‘¢ï¼Ÿå¾€ä¸‹çœ‹DeadLockProofWorker.java</span></span><br><span class="line">        <span class="comment">//ä¹Ÿå°±æ˜¯è°ƒç”¨çš„newThreadRenamingRunnable(id, determiner)</span></span><br><span class="line">        <span class="comment">//newThreadRenamingRunnableçœ‹ä¸‹é¢AbstractNioWorker.java</span></span><br><span class="line">            DeadLockProofWorker.start(executor, newThreadRenamingRunnable(id, determiner));</span><br><span class="line">            success = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                <span class="comment">// Release the Selector if the execution fails.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Failed to close a selector."</span>, t);</span><br><span class="line">                &#125;</span><br><span class="line">                selector = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// The method will return to the caller at this point.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        assert selector != <span class="literal">null</span> &amp;&amp; selector.isOpen();</span><br><span class="line">    &#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">//æ ‡è®°wakenupçŠ¶æ€</span></span><br><span class="line">            wakenUp.set(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//çŠ¶æ€ç›‘æµ‹çš„ä»£ç </span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//å–ä»»åŠ¡</span></span><br><span class="line">            processTaskQueue();</span><br><span class="line"><span class="comment">//ä¸šåŠ¡å¤„ç†ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¢«ä¸‰ä¸ªç±»å®ç°AbstractNioWorkerã€NioClientBossã€</span></span><br><span class="line"><span class="comment">//AbstractNioWorkerä¸­çš„processåœ¨ä¸Šæ–¹</span></span><br><span class="line"><span class="comment">//NioServerBossä¸­çš„processåœ¨ä¸‹æ–¹</span></span><br><span class="line">process(selector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NioServerBoss.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  protected <span class="keyword">void</span> process(Selector selector) &#123;</span><br><span class="line">      <span class="built_in">Set</span>&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">      <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator(); i.hasNext();) &#123;</span><br><span class="line">          SelectionKey k = i.next();</span><br><span class="line">          i.remove();</span><br><span class="line">          NioServerSocketChannel channel = (NioServerSocketChannel) k.attachment();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// accept connections in a for loop until no new connection is ready</span></span><br><span class="line">              <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">              <span class="comment">//acceptäº‹ä»¶</span></span><br><span class="line">                  SocketChannel acceptedSocket = channel.socket.accept();</span><br><span class="line">                  <span class="keyword">if</span> (acceptedSocket == <span class="literal">null</span>) &#123;</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">//æ³¨å†Œçš„æ–¹æ³•åœ¨æœ¬ç±»çš„ä¸‹æ–¹ï¼Œå‘workerçº¿ç¨‹é‡Œé¢æ³¨å†Œä»»åŠ¡</span></span><br><span class="line">                  registerAcceptedChannel(channel, acceptedSocket, thread);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">              <span class="comment">// Raised by accept() when the server socket was closed.</span></span><br><span class="line">              k.cancel();</span><br><span class="line">              channel.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</span><br><span class="line">              <span class="comment">// Thrown every second to get ClosedChannelException</span></span><br><span class="line">              <span class="comment">// raised.</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">              <span class="comment">// Closed as requested.</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">              <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                  logger.warn(</span><br><span class="line">                          <span class="string">"Failed to accept a connection."</span>, t);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                  <span class="comment">// Ignore</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private <span class="keyword">static</span> <span class="keyword">void</span> registerAcceptedChannel(NioServerSocketChannel parent, SocketChannel acceptedSocket,</span><br><span class="line">                                       Thread currentThread) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          ChannelSink sink = parent.getPipeline().getSink();</span><br><span class="line">          ChannelPipeline pipeline =</span><br><span class="line">                  parent.getConfig().getPipelineFactory().getPipeline();</span><br><span class="line">                  <span class="comment">//æ‰¾åˆ°ä¸€ä¸ªworker,é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æŠŠæ¯ä¸ªå·¥ä½œå‡åŒ€çš„åˆ†é…ç»™æ¯ä¸€ä¸ªworker</span></span><br><span class="line">                  <span class="comment">// public E nextWorker() &#123;</span></span><br><span class="line">      <span class="comment">//return (E) workers[Math.abs(workerIndex.getAndIncrement() % workers.length)];</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line">          NioWorker worker = parent.workerPool.nextWorker();</span><br><span class="line">          <span class="comment">//å‘workeré‡Œé¢æ³¨å†Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥å»æ“ä½œworker</span></span><br><span class="line">          <span class="comment">//è®©ä»–å…³æ³¨ä¸€ä¸‹socketchannelï¼Œå³acceptedSocketæ³¨å†Œè¿™ä¸ªä¸œè¥¿</span></span><br><span class="line">          <span class="comment">//å› ä¸ºregisterè¿™ä¸ªæ–¹æ³•æ˜¯ç»§æ‰¿AbstractNioSelectorçš„ï¼Œå³å®Œæˆä¹‹åéœ€è¦æäº¤ä»»åŠ¡å¹¶è®°è¿‡wakenup</span></span><br><span class="line">         <span class="comment">//ä»£ç ç²˜è´´è¿‡æ¥äº†</span></span><br><span class="line">          <span class="comment">//public void register(Channel channel, ChannelFuture future) &#123;</span></span><br><span class="line">      <span class="comment">//Runnable task = createRegisterTask(channel, future);</span></span><br><span class="line">      <span class="comment">//registerTask(task);</span></span><br><span class="line"> <span class="comment">// &#125;</span></span><br><span class="line"> <span class="comment">// protected final void registerTask(Runnable task) &#123;</span></span><br><span class="line">     <span class="comment">// taskQueue.add(task);</span></span><br><span class="line">      <span class="comment">//Selector selector = this.selector;</span></span><br><span class="line">      <span class="comment">//if (selector != null) &#123;</span></span><br><span class="line">          <span class="comment">//if (wakenUp.compareAndSet(false, true)) &#123;</span></span><br><span class="line">              <span class="comment">//selector.wakenup();</span></span><br><span class="line">          <span class="comment">//&#125;</span></span><br><span class="line">      <span class="comment">//&#125; else &#123;</span></span><br><span class="line">          <span class="comment">//if (taskQueue.remove(task)) &#123;</span></span><br><span class="line">              <span class="comment">// the selector was null this means the Worker has already been shutdown.</span></span><br><span class="line">              <span class="comment">//throw new RejectedExecutionException("Worker has already been shutdown");</span></span><br><span class="line">          <span class="comment">//&#125;</span></span><br><span class="line">     <span class="comment">// &#125;</span></span><br><span class="line"> <span class="comment">// &#125;</span></span><br><span class="line">          worker.register(<span class="keyword">new</span> NioAcceptedSocketChannel(</span><br><span class="line">                  parent.getFactory(), pipeline, parent, sink</span><br><span class="line">                  , acceptedSocket,</span><br><span class="line">                  worker, currentThread), <span class="literal">null</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">              logger.warn(</span><br><span class="line">                      <span class="string">"Failed to initialize an accepted socket."</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              acceptedSocket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">              <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                  logger.warn(</span><br><span class="line">                          <span class="string">"Failed to close a partially accepted socket."</span>,</span><br><span class="line">                          e2);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>AbstractNioWorker.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected ThreadRenamingRunnable newThreadRenamingRunnable(int id, ThreadNameDeterminer determiner) &#123;</span><br><span class="line"><span class="comment">//thiså½“å‰çš„NioWorkerï¼Œç„¶åç»™äº†ä¸€ä¸ªçº¿ç¨‹çš„åç§°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadRenamingRunnable(<span class="keyword">this</span>, <span class="string">"New I/O worker #"</span> + id, determiner);</span><br><span class="line">    &#125;</span><br><span class="line">public ThreadRenamingRunnable(Runnable runnable, <span class="built_in">String</span> proposedThreadName, ThreadNameDeterminer determiner) &#123;</span><br><span class="line">        <span class="keyword">if</span> (runnable == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"runnable"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (proposedThreadName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"proposedThreadName"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.runnable = runnable;</span><br><span class="line">        <span class="keyword">this</span>.determiner = determiner;</span><br><span class="line">        <span class="keyword">this</span>.proposedThreadName = proposedThreadName;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œrunnableæ‰§è¡Œå…¶å®å°±æ˜¯NioWorkerè¿›è¡Œäº†run</span></span><br><span class="line"><span class="comment">//NioWorker.runå…¶å®æ˜¯è¿è¡Œçˆ¶ç±»çš„AbstractNioWorker run</span></span><br><span class="line"><span class="comment">//AbstractNioWorker çš„runåˆè°ƒç”¨çš„æ˜¯çˆ¶ç±»AbstractNioSelectorçš„runæ–¹æ³•</span></span><br><span class="line"><span class="comment">//AbstractNioSelectorçš„runæ–¹æ³•,å¾€ä¸Šé¢çœ‹</span></span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>DeadLockProofWorker.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public final <span class="class"><span class="keyword">class</span> <span class="title">DeadLockProofWorker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &lt;em&gt;internal use only&lt;/em&gt; thread-local variable that tells the</span></span><br><span class="line"><span class="comment">     * &#123;@link Executor&#125; that this worker acquired a worker thread from.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">static</span> final ThreadLocal&lt;Executor&gt; PARENT = <span class="keyword">new</span> ThreadLocal&lt;Executor&gt;();</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> start(final Executor parent, final Runnable runnable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"parent"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (runnable == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"runnable"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//é€šè¿‡çº¿ç¨‹æ± å¯åŠ¨ä¸€ä¸ªRunnable</span></span><br><span class="line">        parent.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            public <span class="keyword">void</span> run() &#123;</span><br><span class="line">                PARENT.set(parent);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨Runnableçš„runæ–¹æ³•ï¼Œç„¶åè¿”å›å»çœ‹</span></span><br><span class="line">                    runnable.run();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    PARENT.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private DeadLockProofWorker() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>AbstractNioWorkerPool.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œåˆ°äº†ä»–çš„çˆ¶ç±»AbstractNioWorkerPool</span></span><br><span class="line">blic <span class="keyword">void</span> run() &#123;</span><br><span class="line">        thread = Thread.currentThread();</span><br><span class="line">        startupLatch.countDown();</span><br><span class="line"></span><br><span class="line">        int selectReturnsImmediately = <span class="number">0</span>;</span><br><span class="line">        Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ•°ç»„workers</span></span><br><span class="line">private final AbstractNioWorker[] workers;</span><br><span class="line"><span class="comment">//çˆ¶ç±»çš„æ„é€ æ–¹æ³•æ–¹æ³•</span></span><br><span class="line">AbstractNioWorkerPool(Executor workerExecutor, int workerCount, boolean autoInit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (workerExecutor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"workerExecutor"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (workerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"workerCount ("</span> + workerCount + <span class="string">") "</span> + <span class="string">"must be a positive integer."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æœ‰ä¸€ä¸ªworkersçš„æ•°ç»„ï¼Œnewäº†workerCountçš„æ•°ç»„</span></span><br><span class="line">        workers = <span class="keyword">new</span> AbstractNioWorker[workerCount];</span><br><span class="line">        <span class="keyword">this</span>.workerExecutor = workerExecutor;</span><br><span class="line">        <span class="keyword">if</span> (autoInit) &#123;</span><br><span class="line">            init();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">protected <span class="keyword">void</span> init() &#123;</span><br><span class="line">        <span class="keyword">if</span> (!initialized.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"initialized already"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; workers.length; i++) &#123;</span><br><span class="line">        <span class="comment">//å¯¹workerè¿›è¡Œåˆå§‹åŒ–ï¼Œå…·ä½“å®ç°å¾€ä¸‹çœ‹</span></span><br><span class="line">            workers[i] = newWorker(workerExecutor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        waitForWorkerThreads();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“å®ç°çœ‹ä¸Šé¢çš„NioWorkerPool.javaä¸­çš„newWorkeræ–¹æ³•</span></span><br><span class="line">protected abstract E newWorker(Executor executor);</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">    public E nextWorker() &#123;</span><br><span class="line">        <span class="keyword">return</span> (E) workers[<span class="built_in">Math</span>.abs(workerIndex.getAndIncrement() % workers.length)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> rebuildSelectors() &#123;</span><br><span class="line">        <span class="keyword">for</span> (AbstractNioWorker worker: workers) &#123;</span><br><span class="line">            worker.rebuildSelector();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="é˜…è¯»æºç æŠ€å·§"><a href="#é˜…è¯»æºç æŠ€å·§" class="headerlink" title="é˜…è¯»æºç æŠ€å·§"></a>é˜…è¯»æºç æŠ€å·§</h1><h2 id="æ‰“å°æŸ¥çœ‹"><a href="#æ‰“å°æŸ¥çœ‹" class="headerlink" title="æ‰“å°æŸ¥çœ‹"></a>æ‰“å°æŸ¥çœ‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">sout(Thread.currentThread().getName()+<span class="string">" "</span>+wakenup);</span><br><span class="line">wakenUp.set(<span class="literal">false</span>);</span><br><span class="line">...</span><br><span class="line">sout(Thread.currentThread().getName()+<span class="string">" "</span>+select);</span><br><span class="line">int selected = select(selector);</span><br><span class="line">...</span><br><span class="line">sout(Thread.currentThread().getName()+<span class="string">" "</span>+processTaskQueue);</span><br><span class="line">processTaskQueue();</span><br><span class="line">...</span><br><span class="line">sout(Thread.currentThread().getName()+<span class="string">" "</span>+process);</span><br><span class="line">process(selector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">New I/O server boss #2 process </span><br><span class="line">New I/O server boss #2 wakenup </span><br><span class="line">New I/O server boss #2 select </span><br><span class="line">New I/O server boss #2 processTaskQueue</span><br><span class="line">New I/O server boss #2 process</span><br><span class="line">New I/O server boss #2 wakenup </span><br><span class="line">New I/O server boss #2 select </span><br><span class="line">...</span><br><span class="line">New I/O worker #1 wakenup</span><br><span class="line">New I/O worker #1 select</span><br><span class="line">New I/O worker #1 processTaskQueue</span><br><span class="line">New I/O worker #1 process</span><br><span class="line">New I/O worker #1 wakenup</span><br><span class="line">New I/O worker #1 select</span><br><span class="line">New I/O worker #1 processTaskQueue</span><br><span class="line">New I/O worker #1 process</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°workeræ˜¯å››ä¸ªå››ä¸ªå¾ªç¯å¾€å¤ï¼Œå¯æ˜¯bossçº¿ç¨‹ä¸ºä»€ä¹ˆåœ¨selectå°±æ²¡æœ‰ç»§ç»­æ‰§è¡Œäº†ï¼Ÿ</p><h2 id="é€šè¿‡æ‰“æ–­ç‚¹è°ƒè¯•"><a href="#é€šè¿‡æ‰“æ–­ç‚¹è°ƒè¯•" class="headerlink" title="é€šè¿‡æ‰“æ–­ç‚¹è°ƒè¯•"></a>é€šè¿‡æ‰“æ–­ç‚¹è°ƒè¯•</h2><p>å°†æ–­ç‚¹æ‰“åœ¨wakenup.set<br>ä¸ºäº†åªçœ‹bossçº¿ç¨‹ï¼Œeclipseè¿›å…¥æ–­ç‚¹çš„æ§åˆ¶é¡µé¢â€“ã€‹å³ä¸Šè§’breanpointsâ€“ã€‹é€‰ä¸­æœ¬ç±»å³å‡»â€“ã€‹BreakPoint Propertiesâ€“ã€‹æ–°çš„é¡µé¢ä¸­å‹¾é€‰Conditionalâ€“ã€‹ä¸‹é¢è¾“å…¥â€œThread.currentThread().getName().contains(â€œbossâ€)â€â€“ã€‹ç‚¹å‡»ok</p><p>é€šè¿‡æ‰“æ–­ç‚¹å‘ç°åˆ°äº†selectæ–¹æ³•çš„æ—¶å€™ç‚¹è¿›å»ï¼Œç„¶åæ²¡æœ‰æ‰§è¡Œé»˜è®¤çš„selectï¼ˆ500ï¼‰ï¼Œè¿™æ ·çš„æ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡Œçš„selectï¼ˆï¼‰è¿™ç§é˜»å¡çš„æ–¹å¼ï¼Œæ‰€ä»¥é˜»å¡ä½äº†ã€‚</p><h2 id="æŸ¥çœ‹è°ƒç”¨æ ˆ"><a href="#æŸ¥çœ‹è°ƒç”¨æ ˆ" class="headerlink" title="æŸ¥çœ‹è°ƒç”¨æ ˆ"></a>æŸ¥çœ‹è°ƒç”¨æ ˆ</h2><p>é€šè¿‡æŸ¥çœ‹è°ƒç”¨æ ˆçš„æ–¹å¼æŸ¥çœ‹æŸä¸ªæ–¹æ³•å…·ä½“è°ƒç”¨çš„å †æ ˆä¿¡æ¯<br>eclipseåœ¨debugç•Œé¢çš„å·¦ä¸Šè§’<br>ideaåœ¨debugç•Œé¢çš„å·¦ä¸‹è§’</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰&quot;&gt;&lt;a href=&quot;#å°æŠ€å·§ï¼ˆå¦‚ä½•çœ‹å¼€æºæ¡†æ¶çš„æºç ï¼‰&quot; class=&quot;header
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆå››ï¼‰ï¼šnettyçº¿ç¨‹æ¨¡å‹æºç åˆ†æï¼ˆä¸€ï¼‰</title>
    <link href="http://mmmmmm.me/2019-03-10-4.html"/>
    <id>http://mmmmmm.me/2019-03-10-4.html</id>
    <published>2019-03-10T02:21:04.000Z</published>
    <updated>2019-03-10T15:09:00.711Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡"><a href="#å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡" class="headerlink" title="å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡"></a>å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡</h1><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>å‰é¢ç¬¬ä¸€èŠ‚ä¸­çš„NIOä»£ç <br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> listen() throws IOException &#123;</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼"</span>);</span><br><span class="line"><span class="comment">// è½®è¯¢è®¿é—®selector</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="comment">// å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line"><span class="comment">//ç‚¹ä¸è¿›å»selectæ–¹æ³•ï¼Œå› ä¸ºåº•å±‚æ˜¯cå†™çš„</span></span><br><span class="line">selector.select();</span><br><span class="line"><span class="comment">// è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶</span></span><br><span class="line">Iterator&lt;?&gt; ite = <span class="keyword">this</span>.selector.selectedKeys().iterator();</span><br><span class="line"><span class="keyword">while</span> (ite.hasNext()) &#123;</span><br><span class="line">SelectionKey key = (SelectionKey) ite.next();</span><br><span class="line"><span class="comment">// åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†</span></span><br><span class="line">ite.remove();</span><br><span class="line">handler(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»…ä»…ä¿®æ”¹æˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> listen() throws IOException &#123;</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼"</span>);</span><br><span class="line"><span class="comment">// è½®è¯¢è®¿é—®selector</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="comment">// å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line"><span class="comment">//ç‚¹ä¸è¿›å»selectæ–¹æ³•ï¼Œå› ä¸ºåº•å±‚æ˜¯cå†™çš„</span></span><br><span class="line">selector.select();</span><br><span class="line"><span class="comment">// è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶</span></span><br><span class="line">Iterator&lt;?&gt; ite = <span class="keyword">this</span>.selector.selectedKeys().iterator();</span><br><span class="line"><span class="keyword">while</span> (ite.hasNext()) &#123;</span><br><span class="line">SelectionKey key = (SelectionKey) ite.next();</span><br><span class="line"><span class="comment">// åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†</span></span><br><span class="line">ite.remove();</span><br><span class="line">newCachedThreadPool.execute(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">handler(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> handlerAccept(SelectionKey key) throws IOException &#123;</span><br><span class="line">ServerSocketChannel server = (ServerSocketChannel) key.channel();</span><br><span class="line"><span class="comment">// è·å¾—å’Œå®¢æˆ·ç«¯è¿æ¥çš„é€šé“ï¼ŒSocketChannelç›¸å½“äºä¼ ç»Ÿioé‡Œé¢çš„Channel</span></span><br><span class="line">SocketChannel channel = server.accept();</span><br><span class="line"><span class="comment">// è®¾ç½®æˆéé˜»å¡</span></span><br><span class="line">channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è¿™é‡Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯å“¦</span></span><br><span class="line">System.out.println(<span class="string">"æ–°çš„å®¢æˆ·ç«¯è¿æ¥"</span>);</span><br><span class="line"><span class="comment">// åœ¨å’Œå®¢æˆ·ç«¯è¿æ¥æˆåŠŸä¹‹åï¼Œä¸ºäº†å¯ä»¥æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œéœ€è¦ç»™é€šé“è®¾ç½®è¯»çš„æƒé™ã€‚</span></span><br><span class="line">channel.register(<span class="keyword">this</span>.selector, SelectionKey.OP_READ);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡telnetè¯·æ±‚ä¸€ä¸‹</p><p>æŠ¥é”™ï¼Œç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå› ä¸ºè™½ç„¶ite.removeï¼Œå¯æ˜¯åœ¨handlerï¼ˆkeyï¼‰è¿˜æ²¡æœ‰å¤„ç†å®Œçš„æ—¶å€™å°±è¿”å›äº†ï¼Œæ²¡æœ‰å¤„ç†selectæ–¹æ³•å¹¶ä¸ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥ä¸‹æ¬¡è¿˜æ˜¯è¿™ä¸ªkeyå»è®¿é—®selector.select()ï¼Œthis.selector.selectedKeys()è¿˜æ˜¯åˆšæ‰çš„å®¢æˆ·ç«¯ï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡handlerï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªketåˆè¿›è¡Œäº†ä¸€æ¬¡acceptï¼ŒåŒä¸€ä¸ªkey acceptäº†ä¸¤æ¬¡ã€‚<br>çœ‹åˆ°ä¸Šé¢çš„handleracceptæ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡å·²ç»acceptåˆ°äº†å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡acceptçš„æ—¶å€™å°±è·å–ä¸åˆ°äº†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SocketChannel channel = server.accept();</span><br></pre></td></tr></table></figure><p>è·å–ä¸åˆ°channelï¼Œè¿™è¡Œä»£ç çš„ä¸‹é¢å°±æŠ›å‡ºäº†ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p><strong><font color="red">ç»¼ä¸Šï¼šNIOçš„å¤šçº¿ç¨‹ä¸èƒ½é€šè¿‡ä¸Šé¢çš„æ–¹å¼</font></strong></p><h2 id="å°é—®é¢˜"><a href="#å°é—®é¢˜" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h2><h3 id="ä¸€ä¸ªNIOæ˜¯ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªselectorï¼Ÿ"><a href="#ä¸€ä¸ªNIOæ˜¯ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªselectorï¼Ÿ" class="headerlink" title="ä¸€ä¸ªNIOæ˜¯ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªselectorï¼Ÿ"></a>ä¸€ä¸ªNIOæ˜¯ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªselectorï¼Ÿ</h3><p>ä¸æ˜¯ï¼Œä¸€ä¸ªç³»ç»Ÿå¯ä»¥æœ‰å¤šä¸ªselector</p><h3 id="selectoræ˜¯ä¸æ˜¯åªèƒ½æ³¨å†Œä¸€ä¸ªServerSocketChannelï¼Ÿ"><a href="#selectoræ˜¯ä¸æ˜¯åªèƒ½æ³¨å†Œä¸€ä¸ªServerSocketChannelï¼Ÿ" class="headerlink" title="selectoræ˜¯ä¸æ˜¯åªèƒ½æ³¨å†Œä¸€ä¸ªServerSocketChannelï¼Ÿ"></a>selectoræ˜¯ä¸æ˜¯åªèƒ½æ³¨å†Œä¸€ä¸ªServerSocketChannelï¼Ÿ</h3><p>ä¸æ˜¯ï¼Œå¯ä»¥æ³¨å†Œå¤šä¸ª</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">scocketchannel.register(<span class="keyword">this</span>.selector, SelectionKey.OP_READ);</span><br></pre></td></tr></table></figure><p>selectoræ—¢è¦è´Ÿè´£å¤§é—¨ï¼Œåˆè¦è´Ÿè´£æ¯ä¸ªå®¢äººç‚¹èœçš„éœ€æ±‚</p><h2 id="å›¾è¯´NettyIO"><a href="#å›¾è¯´NettyIO" class="headerlink" title="å›¾è¯´NettyIO"></a>å›¾è¯´NettyIO</h2><p>socketIO<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/2019030522030278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>NIO<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190305220242932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>NettyIO<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190305220224896.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>éšç€é¤å…è§„æ¨¡çš„è¶Šæ¥è¶Šå¤§ï¼Œéœ€è¦æ›´å¤šçš„æœåŠ¡ç”Ÿï¼Œå¦‚ä½•åˆ†é…è¿™äº›æœåŠ¡ç”Ÿå‘¢ï¼Ÿæ¯ä¸ªæœåŠ¡ç”Ÿåˆ†é…åˆ°ä¸åŒçš„åŒºåŸŸï¼Œç®¡ç†ä¸åŒçš„åŒºåŸŸï¼Œå¤§é—¨çš„åœ°æ–¹ä¹Ÿå¯ä»¥åˆ†é…ä¸€ä¸ªæœåŠ¡ç”Ÿã€‚</p><h1 id="å¦‚ä½•æ„å»ºä¸€ä¸ªå¤šçº¿ç¨‹çš„NIOç³»ç»Ÿ-ğŸŒ°æºç è§£è¯»"><a href="#å¦‚ä½•æ„å»ºä¸€ä¸ªå¤šçº¿ç¨‹çš„NIOç³»ç»Ÿ-ğŸŒ°æºç è§£è¯»" class="headerlink" title="å¦‚ä½•æ„å»ºä¸€ä¸ªå¤šçº¿ç¨‹çš„NIOç³»ç»Ÿ(ğŸŒ°æºç è§£è¯»)"></a>å¦‚ä½•æ„å»ºä¸€ä¸ªå¤šçº¿ç¨‹çš„NIOç³»ç»Ÿ(ğŸŒ°æºç è§£è¯»)</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç²¾ç®€äº†Nettyæºç çš„å°ä¾‹å­ï¼ˆä»Nettyä¸­æŠ½å–éƒ¨åˆ†ä»£ç å¹¶æ•´åˆï¼‰<br>ä»£ç ç»“æ„ï¼š<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190305224454949.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>start.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.NioSelectorRunnablePool;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- å¯åŠ¨å‡½æ•°</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Start</span> </span>&#123;</span><br><span class="line"> public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–çº¿ç¨‹</span></span><br><span class="line">  <span class="comment">//NioSelectorRunnablePoolæ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹æ± çš„</span></span><br><span class="line">  <span class="comment">//ç»™äº†ä¸¤ä¸ªçº¿ç¨‹æ± ä¸€ä¸ªbossï¼Œä¸€ä¸ªworker</span></span><br><span class="line">  <span class="comment">//newCachedThreadPool ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œå½“ä¸€ä¸‹å­å¥½å¤šä»»åŠ¡çš„æ—¶å€™ï¼Œå°±å¼€å¥½å¤šçº¿ç¨‹å»åšï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡</span></span><br><span class="line">  <span class="comment">//çš„æ—¶å€™ï¼Œçº¿ç¨‹ç©ºé—²ä¸‹æ¥çš„æ—¶å€™ï¼Œæ…¢æ…¢çº¿ç¨‹çš„æ•°é‡å°±ä¼šå‡å°‘ï¼Œè‡ªç„¶æ¶ˆäº¡ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯çº¿ç¨‹çš„æ•°é‡åœ¨æŸæ®µæ—¶</span></span><br><span class="line">  <span class="comment">//é—´å†…æ˜¯ä¼šæ‰©å¼ æˆ–è€…æ”¶ç¼©çš„</span></span><br><span class="line">  <span class="comment">//è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°åœ¨ä¸‹é¢çš„NioSelectorRunnablePool.java</span></span><br><span class="line">  NioSelectorRunnablePool nioSelectorRunnablePool = <span class="keyword">new</span> NioSelectorRunnablePool(Executors.newCachedThreadPool(), Executors.newCachedThreadPool()); </span><br><span class="line">  <span class="comment">//è·å–æœåŠ¡ç±»ï¼Œå°†çº¿ç¨‹ç®¡ç†è€…äº¤ç»™æœåŠ¡ç±»</span></span><br><span class="line">  <span class="comment">//å…·ä½“çœ‹ServerBoosTrap.java</span></span><br><span class="line">  ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap(nioSelectorRunnablePool);  </span><br><span class="line">  <span class="comment">//ç»‘å®šç«¯å£å…·ä½“çœ‹ServerBoosTrap.java</span></span><br><span class="line">  bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line">  System.out.println(<span class="string">"start"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NioSelectorRunnablePool.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.pool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> com.cn.NioServerBoss;</span><br><span class="line"><span class="keyword">import</span> com.cn.NioServerWorker;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- selectorçº¿ç¨‹ç®¡ç†è€…</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">NioSelectorRunnablePool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - bossçº¿ç¨‹æ•°ç»„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private final AtomicInteger bossIndex = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    private Boss[] bosses;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - workerçº¿ç¨‹æ•°ç»„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private final AtomicInteger workerIndex = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    private Worker[] workeres;</span><br><span class="line"></span><br><span class="line">  public NioSelectorRunnablePool(Executor boss, Executor worker) &#123;</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–çº¿ç¨‹æ± bossï¼Œé»˜è®¤æ˜¯1çš„æ•°é‡</span></span><br><span class="line">  <span class="comment">//å¾€ä¸‹ä¸€ç‚¹ç‚¹æ˜¯initBossè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">  initBoss(boss, <span class="number">1</span>);</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–workerï¼Œä¼ å…¥workerçº¿ç¨‹æ± ï¼Œæ•°é‡æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°é‡*2</span></span><br><span class="line">  <span class="comment">//å¾€ä¸‹çœ‹initWorkeræ–¹æ³•</span></span><br><span class="line">  initWorker(worker, Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åˆå§‹åŒ–bossçº¿ç¨‹</span></span><br><span class="line"><span class="comment">  - @param boss</span></span><br><span class="line"><span class="comment">  - @param count</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="keyword">void</span> initBoss(Executor boss, int count) &#123;</span><br><span class="line">    <span class="comment">//NioServerBossåœ¨ä¸‹é¢NioServerBoss.javaé‡Œé¢</span></span><br><span class="line">    <span class="keyword">this</span>.bosses = <span class="keyword">new</span> NioServerBoss[count];</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; bosses.length; i++) &#123;</span><br><span class="line">    <span class="comment">//å›åˆ°è¿™é‡Œå¯¹æ¯ä¸€ä¸ªbossåˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•åœ¨ä¸‹é¢</span></span><br><span class="line">    bosses[i] = <span class="keyword">new</span> NioServerBoss(boss, <span class="string">"boss thread "</span> + (i+<span class="number">1</span>), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åˆå§‹åŒ–workerçº¿ç¨‹</span></span><br><span class="line"><span class="comment">  - @param worker</span></span><br><span class="line"><span class="comment">  - @param count</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="keyword">void</span> initWorker(Executor worker, int count) &#123;</span><br><span class="line">    <span class="keyword">this</span>.workeres = <span class="keyword">new</span> NioServerWorker[count];</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; workeres.length; i++) &#123;</span><br><span class="line">    <span class="comment">//NioServerWorkeråœ¨ä¸‹é¢</span></span><br><span class="line">    workeres[i] = <span class="keyword">new</span> NioServerWorker(worker, <span class="string">"worker thread "</span> + (i+<span class="number">1</span>), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - è·å–ä¸€ä¸ªworker</span></span><br><span class="line"><span class="comment">  - @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public Worker nextWorker() &#123;</span><br><span class="line">     <span class="keyword">return</span> workeres[<span class="built_in">Math</span>.abs(workerIndex.getAndIncrement() % workeres.length)];</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - è·å–ä¸€ä¸ªboss</span></span><br><span class="line"><span class="comment">  - @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public Boss nextBoss() &#123;</span><br><span class="line">     <span class="keyword">return</span> bosses[<span class="built_in">Math</span>.abs(bossIndex.getAndIncrement() % bosses.length)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NioServerBoss,java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ClosedChannelException;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.pool.Boss;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.NioSelectorRunnablePool;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.Worker;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- bosså®ç°ç±»</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="comment">//AbstractNioSelectoråœ¨ä¸‹é¢AbstractNioSelector.javaè¿™ä¸ªç±»æ˜¯selectorçš„ä¸€ä¸ªæŠ½è±¡ç±»</span></span><br><span class="line">   <span class="comment">//ä¸ºä»€ä¹ˆè¦æ˜¯æŠ½è±¡ç±»ï¼Ÿ</span></span><br><span class="line">   <span class="comment">//åœ¨é—¨å£çš„æœåŠ¡ç”Ÿå’Œåœ¨é‡Œé¢ä¸ºå®¢äººæœåŠ¡çš„æœåŠ¡ç”Ÿæœ‰å¾ˆå¤šå…±åŒç‚¹ï¼Œæ¯”å¦‚å…³æ³¨å¤šä¸ªåœ°æ–¹ï¼Œç©¿ç€ä¸€æ ·</span></span><br><span class="line">   <span class="comment">//ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šä¸åŒçš„åœ°æ–¹ï¼Œæ¯”å¦‚å¤§é—¨å£çš„æœåŠ¡ç”Ÿè¯´æ¬¢è¿å…‰ä¸´ï¼Œå¤§å…çš„æœåŠ¡ç”Ÿçœ‹å“ªé‡Œæœ‰ç‚¹èœçš„éœ€æ±‚</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">NioServerBoss</span> <span class="keyword">extends</span> <span class="title">AbstractNioSelector</span> <span class="title">implements</span> <span class="title">Boss</span></span>&#123;</span><br><span class="line">  public NioServerBoss(Executor executor, <span class="built_in">String</span> threadName, NioSelectorRunnablePool selectorRunnablePool) &#123;</span><br><span class="line">  <span class="comment">//è°ƒåŠ¨çš„æ˜¯å…¶çˆ¶ç±»AbstractNioSelectorçš„æ„é€ æ–¹æ³•ï¼Œå¾€ä¸‹çœ‹</span></span><br><span class="line">  <span class="keyword">super</span>(executor, threadName, selectorRunnablePool);</span><br><span class="line">  &#125;</span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> process(Selector selector) throws IOException &#123;</span><br><span class="line">  <span class="built_in">Set</span>&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">      <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">for</span> (Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator(); i.hasNext();) &#123;</span><br><span class="line">      SelectionKey key = i.next();</span><br><span class="line">      i.remove();</span><br><span class="line">      ServerSocketChannel server = (ServerSocketChannel) key.channel();</span><br><span class="line">  <span class="comment">//accept æ–°å®¢æˆ·ç«¯</span></span><br><span class="line">  SocketChannel channel = server.accept();</span><br><span class="line">  <span class="comment">// è®¾ç½®ä¸ºéé˜»å¡</span></span><br><span class="line">  channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">  <span class="comment">// é€šè¿‡çº¿ç¨‹ç®¡ç†è€…ï¼Œè·å–ä¸€ä¸ªworkerï¼Œ</span></span><br><span class="line">  <span class="comment">//é—¨å£çš„æœåŠ¡ç”Ÿå¼•å…¥å®¢äººåè¦å¸¦åˆ°æŸä¸ªåŒºåŸŸçš„workerèº«è¾¹ï¼Œå‘Šè¯‰ä»–ä½ è¦è´Ÿè´£è¿™ä½å®¢äººã€‚</span></span><br><span class="line">  Worker nextworker = getSelectorRunnablePool().nextWorker();</span><br><span class="line">  <span class="comment">// æ³¨å†Œæ–°å®¢æˆ·ç«¯æ¥å…¥ä»»åŠ¡</span></span><br><span class="line">  <span class="comment">//è´Ÿè´£å¤§å…çš„æœåŠ¡ç”Ÿç»™è‡ªå·±æ³¨å†Œä»»åŠ¡</span></span><br><span class="line">  <span class="comment">//registerNewChannelTaskå…·ä½“çš„å®ç°çœ‹ä¸‹é¢çš„NioServerWorkerç±»</span></span><br><span class="line">  <span class="comment">//å°†å½“å‰çš„å®¢æˆ·ç«¯æ³¨å†Œç»™selector readäº‹ä»¶</span></span><br><span class="line">  <span class="comment">//è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿæœ‰æ•ˆçš„è§£å†³é«˜å¹¶å‘</span></span><br><span class="line">  <span class="comment">//å¾€åˆ«çš„é˜Ÿåˆ—é‡Œé¢åŠ ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥å»æ“ä½œä½ çš„ä¸œè¥¿ï¼Œä½ è‡ªå·±å»å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼Œ</span></span><br><span class="line">  nextworker.registerNewChannelTask(channel);</span><br><span class="line">  </span><br><span class="line">  System.out.println(<span class="string">"æ–°å®¢æˆ·ç«¯é“¾æ¥"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="keyword">void</span> registerAcceptChannelTask(final ServerSocketChannel serverChannel)&#123;</span><br><span class="line">   final Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">   <span class="comment">//æ³¨å†Œå®Œä¸‹é¢çš„äº‹ä»¶ä¹‹åï¼Œæ‰§è¡ŒregisterTaskï¼Œå…·ä½“çœ‹AbstractNioSelector.java</span></span><br><span class="line">   <span class="comment">//ç®€è€Œè¨€ä¹‹å°±æ˜¯æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¹¶wakenup</span></span><br><span class="line">   registerTask(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public <span class="keyword">void</span> run() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">//æ³¨å†ŒserverChannelï¼Œacceptåˆ°selector</span></span><br><span class="line">  serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">  e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  @Override</span><br><span class="line">  protected int select(Selector selector) throws IOException &#123;</span><br><span class="line">  <span class="keyword">return</span> selector.select();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>AbstractNioSelector.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.NioSelectorRunnablePool;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">- æŠ½è±¡selectorçº¿ç¨‹ç±»</span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">- */</span></span><br><span class="line">  public abstract <span class="class"><span class="keyword">class</span> <span class="title">AbstractNioSelector</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private final Executor executor;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - é€‰æ‹©å™¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected Selector selector;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  - é€‰æ‹©å™¨wakenUpçŠ¶æ€æ ‡è®°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected final AtomicBoolean wakenUp = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> - ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private final Queue&lt;Runnable&gt; taskQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Runnable&gt;();</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - çº¿ç¨‹åç§°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="built_in">String</span> threadName;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - çº¿ç¨‹ç®¡ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected NioSelectorRunnablePool selectorRunnablePool;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± ã€çº¿ç¨‹åã€çº¿ç¨‹ç®¡ç†è€…</span></span><br><span class="line">  AbstractNioSelector(Executor executor, <span class="built_in">String</span> threadName, NioSelectorRunnablePool selectorRunnablePool) &#123;</span><br><span class="line">  <span class="keyword">this</span>.executor = executor;</span><br><span class="line">  <span class="keyword">this</span>.threadName = threadName;</span><br><span class="line">  <span class="keyword">this</span>.selectorRunnablePool = selectorRunnablePool;</span><br><span class="line">  <span class="comment">//æœ€åopenSelectorï¼Œå¾€ä¸‹çœ‹å¾€æ¯ä¸€ä¸ªçº¿ç¨‹é‡Œé¢åŠ å…¥äº†selectorè¿™ä¸ªä¸œè¥¿</span></span><br><span class="line">  <span class="comment">//ä¸€ä¸ªçº¿ç¨‹åŠ ä¸€ä¸ªselectoræ‰æœ‰ä¸ºå¤šä¸ªå®¢äººæœåŠ¡çš„èƒ½åŠ›ã€‚</span></span><br><span class="line">  openSelector();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - è·å–selectorå¹¶å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="keyword">void</span> openSelector() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.selector = Selector.open();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to create a selector."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”¨çº¿ç¨‹æ± æ‰§è¡Œå½“å‰å¯¹è±¡ï¼Œè¿è¡Œå½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„thiså°±æ˜¯bosses[i] = new NioServerBoss(boss, "boss thread " + (i+1), this);</span></span><br><span class="line">    <span class="comment">//ç»§æ‰¿AbstractNioSelectåˆå®ç°äº†Runnableï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªrunæ–¹æ³•ï¼Œçœ‹ä¸‹é¢</span></span><br><span class="line">    executor.execute(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  @Override</span><br><span class="line">  public <span class="keyword">void</span> run() &#123;</span><br><span class="line">  <span class="comment">//ç»™å½“å‰çº¿ç¨‹èµ‹ä¸€ä¸ªåå­—</span></span><br><span class="line">  Thread.currentThread().setName(<span class="keyword">this</span>.threadName);</span><br><span class="line">  <span class="comment">//è¿™é‡Œæ˜¯æœ€æ ¸å¿ƒçš„ï¼Œçœ‹å®Œè¿™é‡Œå›å»çœ‹NioSelectorRunnablePoolçš„initWorker</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  wakenUp.set(<span class="literal">false</span>);  </span><br><span class="line">  <span class="comment">//selectorçš„æŠ½è±¡æ–¹æ³•æœ‰ä¸¤ä¸ªå®ç°</span></span><br><span class="line">  <span class="comment">//boosä¸­return selector.select();ç›´æ¥é˜»å¡äº†</span></span><br><span class="line">  <span class="comment">//workerä¸­return selector.select(500);è¶…æ—¶æ—¶é—´500</span></span><br><span class="line">  select(selector);</span><br><span class="line">  <span class="comment">//æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">  <span class="comment">//æ–¹æ³•åœ¨ä¸‹é¢</span></span><br><span class="line">  processTaskQueue(); </span><br><span class="line">  <span class="comment">//æŠ½è±¡æ–¹æ³•è¢«bosså’Œworkerå®ç°ï¼Œå…·ä½“å®ç°çœ‹ä¸Šé¢çš„NioServerBosså’Œä¸‹é¢çš„NioServerWorker</span></span><br><span class="line">  process(selector);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  <span class="comment">// ignore</span></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - æ³¨å†Œä¸€ä¸ªä»»åŠ¡å¹¶æ¿€æ´»selector</span></span><br><span class="line"><span class="comment">  - </span></span><br><span class="line"><span class="comment">  - @param task</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">//ç®€è€Œè¨€ä¹‹å°±æ˜¯æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¹¶wakenup</span></span><br><span class="line">    protected final <span class="keyword">void</span> registerTask(Runnable task) &#123;</span><br><span class="line">    <span class="comment">//å¾€é˜Ÿåˆ—ä¸­åŠ äº†ä»»åŠ¡</span></span><br><span class="line">    taskQueue.add(task);</span><br><span class="line">    Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">    <span class="keyword">if</span> (selector != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//wakenUpæ˜¯ä¸€ä¸ªåŸå­çš„ç±»ï¼ŒconpareAndSetï¼Œçœ‹ä»–æ˜¯ä¸æ˜¯falseï¼Œæ˜¯falseçš„è¯å°±è®¾ç½®ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> (wakenUp.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="comment">//åŠ å…¥ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ï¼Œè¦ç«‹é©¬æ¿€æ´»selectorçš„é˜»å¡çŠ¶æ€ï¼Œå³å¦‚æœåŸæ¥selectæˆ–selectï¼ˆlongï¼‰</span></span><br><span class="line">    <span class="comment">//è¢«é˜»å¡ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°†å…¶ç«‹é©¬è¿”å›ã€‚</span></span><br><span class="line">    <span class="comment">//å¯ä»¥çœ‹åˆ°ä¸Šé¢å“ªä¸ªæ–¹æ³•é‡ŒwakenUp.set(false);  </span></span><br><span class="line">    <span class="comment">//çœ‹å®Œè¿™é‡Œå›å»æ¥ç€çœ‹mainæ–¹æ³•ä¸­çš„ç¬¬äºŒè¡ŒServerBootstrap</span></span><br><span class="line">    selector.wakenup();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    taskQueue.remove(task);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    private <span class="keyword">void</span> processTaskQueue() &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    final Runnable task = taskQueue.poll();</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    task.run();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - è·å–çº¿ç¨‹ç®¡ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">  - @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public NioSelectorRunnablePool getSelectorRunnablePool() &#123;</span><br><span class="line">    <span class="keyword">return</span> selectorRunnablePool;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - selectæŠ½è±¡æ–¹æ³•</span></span><br><span class="line"><span class="comment">  - </span></span><br><span class="line"><span class="comment">  - @param selector</span></span><br><span class="line"><span class="comment">  - @return</span></span><br><span class="line"><span class="comment">  - @throws IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected abstract int select(Selector selector) throws IOException;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  - selectorçš„ä¸šåŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment">  - </span></span><br><span class="line"><span class="comment">  - @param selector</span></span><br><span class="line"><span class="comment">  - @throws IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protected abstract <span class="keyword">void</span> process(Selector selector) throws IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>NioServerWorker.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ClosedChannelException;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cn.pool.NioSelectorRunnablePool;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.Worker;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- workerå®ç°ç±»</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="comment">//å’ŒNioServerBossæ˜¯ä¸€æ ·çš„ç»§æ‰¿AbstractNioSelector</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">NioServerWorker</span> <span class="keyword">extends</span> <span class="title">AbstractNioSelector</span> <span class="title">implements</span> <span class="title">Worker</span></span>&#123;</span><br><span class="line">  <span class="comment">//å’ŒNioServerBossæ˜¯ä¸€æ ·çš„è¿è¡Œçˆ¶ç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">  <span class="comment">//è·³è½¬åˆ°ä¸Šé¢çš„AbstractNioSelectorç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">  public NioServerWorker(Executor executor, <span class="built_in">String</span> threadName, NioSelectorRunnablePool selectorRunnablePool) &#123;</span><br><span class="line">  <span class="keyword">super</span>(executor, threadName, selectorRunnablePool);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected <span class="keyword">void</span> process(Selector selector) throws IOException &#123;</span><br><span class="line">  <span class="built_in">Set</span>&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">      <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Iterator&lt;SelectionKey&gt; ite = <span class="keyword">this</span>.selector.selectedKeys().iterator();</span><br><span class="line">  <span class="keyword">while</span> (ite.hasNext()) &#123;</span><br><span class="line">  SelectionKey key = (SelectionKey) ite.next();</span><br><span class="line">  <span class="comment">// ç§»é™¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†</span></span><br><span class="line">  ite.remove();</span><br><span class="line">  <span class="comment">// å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“</span></span><br><span class="line">  SocketChannel channel = (SocketChannel) key.channel();</span><br><span class="line">  <span class="comment">// æ•°æ®æ€»é•¿åº¦</span></span><br><span class="line">  int ret = <span class="number">0</span>;</span><br><span class="line">  boolean failure = <span class="literal">true</span>;</span><br><span class="line">  ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">  <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  ret = channel.read(buffer);</span><br><span class="line">  failure = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  <span class="comment">// ignore</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//åˆ¤æ–­æ˜¯å¦è¿æ¥å·²æ–­å¼€</span></span><br><span class="line">  <span class="keyword">if</span> (ret &lt;= <span class="number">0</span> || failure) &#123;</span><br><span class="line">  key.cancel();</span><br><span class="line">  System.out.println(<span class="string">"å®¢æˆ·ç«¯æ–­å¼€è¿æ¥"</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"æ”¶åˆ°æ•°æ®:"</span> + <span class="keyword">new</span> <span class="built_in">String</span>(buffer.array())); </span><br><span class="line">   <span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">   ByteBuffer outBuffer = ByteBuffer.wrap(<span class="string">"æ”¶åˆ°\n"</span>.getBytes());</span><br><span class="line">   channel.write(outBuffer);<span class="comment">// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åŠ å…¥ä¸€ä¸ªæ–°çš„socketå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">void</span> registerNewChannelTask(final SocketChannel channel)&#123;</span><br><span class="line">     final Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">     <span class="comment">//registerTaskæ–¹æ³•æ˜¯æŠ½è±¡çš„åœ¨AbstractNioSelectorï¼Œå¾€ä¸Šé¢çœ‹</span></span><br><span class="line">     registerTask(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> run() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//å°†å®¢æˆ·ç«¯æ³¨å†Œåˆ°selectorä¸­</span></span><br><span class="line">    <span class="comment">//å°†å½“å‰çš„å®¢æˆ·ç«¯æ³¨å†Œç»™selector readäº‹ä»¶</span></span><br><span class="line">    channel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  protected int select(Selector selector) throws IOException &#123;</span><br><span class="line">  <span class="keyword">return</span> selector.select(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerBootstrap.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.cn;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.Boss;</span><br><span class="line"><span class="keyword">import</span> com.cn.pool.NioSelectorRunnablePool;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- æœåŠ¡ç±»</span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="comment">//ç®€å•çœ‹ä¸‹å›åˆ°ä¸Šé¢çš„mainå‡½æ•°ç¬¬ä¸‰è¡Œç»‘å®šç«¯å£</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">ServerBootstrap</span> </span>&#123;</span><br><span class="line">private NioSelectorRunnablePool selectorRunnablePool;</span><br><span class="line">public ServerBootstrap(NioSelectorRunnablePool selectorRunnablePool) &#123;</span><br><span class="line"><span class="keyword">this</span>.selectorRunnablePool = selectorRunnablePool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»‘å®šç«¯å£</span></span><br><span class="line"><span class="comment"> * @param localAddress</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> bind(final SocketAddress localAddress)&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// è·å¾—ä¸€ä¸ªServerSocketé€šé“</span></span><br><span class="line">ServerSocketChannel serverChannel = ServerSocketChannel.open();</span><br><span class="line"><span class="comment">// è®¾ç½®é€šé“ä¸ºéé˜»å¡</span></span><br><span class="line">serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">// å°†è¯¥é€šé“å¯¹åº”çš„ServerSocketç»‘å®šåˆ°portç«¯å£</span></span><br><span class="line">serverChannel.socket().bind(localAddress);</span><br><span class="line"><span class="comment">//è·å–ä¸€ä¸ªbossçº¿ç¨‹ï¼Œå› ä¸ºbossçº¿ç¨‹æ˜¯ä¸“é—¨è´Ÿè´£ç›‘å¬ç«¯å£çš„</span></span><br><span class="line">Boss nextBoss = selectorRunnablePool.nextBoss();</span><br><span class="line"><span class="comment">//å‘bossæ³¨å†Œä¸€ä¸ªServerSocketé€šé“</span></span><br><span class="line"><span class="comment">//æ³¨å†Œæ—¶é—´å’Œä¸Šé¢çš„workerçš„æ³¨å†Œæ—¶é—´ç±»ä¼¼</span></span><br><span class="line"><span class="comment">//å…·ä½“çœ‹NioServerBoss.java</span></span><br><span class="line">nextBoss.registerAcceptChannelTask(serverChannel);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>boss.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.pool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- bossæ¥å£</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public interface Boss &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åŠ å…¥ä¸€ä¸ªæ–°çš„ServerSocket</span></span><br><span class="line"><span class="comment">  - @param serverChannel</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">void</span> registerAcceptChannelTask(ServerSocketChannel serverChannel);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>worker.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.cn.pool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- workeræ¥å£</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public interface Worker &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - åŠ å…¥ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ä¼šè¯</span></span><br><span class="line"><span class="comment">  - @param channel</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    public <span class="keyword">void</span> registerNewChannelTask(SocketChannel channel);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å­¦åˆ°çš„æ€æƒ³"><a href="#å­¦åˆ°çš„æ€æƒ³" class="headerlink" title="å­¦åˆ°çš„æ€æƒ³"></a>å­¦åˆ°çš„æ€æƒ³</h1><p>ä¸Šé¢çš„processæ–¹æ³•è¢«bosså’Œworkerç»§æ‰¿ï¼Œbossä¸­é™¤äº†ç»™æ–°å®¢æˆ·ç«¯acceptä¹‹å¤–ï¼Œè¿˜å¾€workerçš„é˜Ÿåˆ—ä¸­åŠ å…¥äº†å½“å‰å®¢æˆ·ç«¯çš„readä»»åŠ¡<br>å¾ˆå¤šæ—¶å€™éƒ½æ˜¯è¿™æ ·ï¼Œæˆ‘ä¸ä¼šå»æ“ä½œä½ çš„æŸäº›ä¸œè¥¿ï¼Œè€Œæ˜¯æŠŠä»»åŠ¡æ”¾åˆ°çš„é˜Ÿåˆ—ä¸­ï¼Œå…·ä½“æ€ä¹ˆæ‰§è¡Œå’Œæˆ‘æ— å…³ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„è§£å†³é«˜å¹¶å‘</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡&quot;&gt;&lt;a href=&quot;#å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šnettyå®¢æˆ·ç«¯</title>
    <link href="http://mmmmmm.me/2019-03-10-3.html"/>
    <id>http://mmmmmm.me/2019-03-10-3.html</id>
    <published>2019-03-10T02:21:03.000Z</published>
    <updated>2019-03-10T15:08:58.448Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h1><p>Client.java</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ClientBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- nettyå®¢æˆ·ç«¯å…¥é—¨</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- =</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">  ClientBootstrap bootstrap = <span class="keyword">new</span>  ClientBootstrap();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">  ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">  ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//socketå·¥å‚</span></span><br><span class="line">  bootstrap.setFactory(<span class="keyword">new</span> NioClientSocketChannelFactory(boss, worker));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ç®¡é“å·¥å‚</span></span><br><span class="line">  bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line">  </span><br><span class="line">  @Override</span><br><span class="line">  public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line">  ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line">  pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">  pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">  pipeline.addLast(<span class="string">"hiHandler"</span>, <span class="keyword">new</span> HiHandler());</span><br><span class="line">  <span class="keyword">return</span> pipeline;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è¿æ¥æœåŠ¡ç«¯</span></span><br><span class="line">  ChannelFuture connect = bootstrap.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">10101</span>));</span><br><span class="line">  Channel channel = connect.getChannel();</span><br><span class="line">  </span><br><span class="line">  System.out.println(<span class="string">"client start"</span>);</span><br><span class="line">  </span><br><span class="line">  Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">  System.out.println(<span class="string">"è¯·è¾“å…¥"</span>);</span><br><span class="line">  channel.write(scanner.next());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HiHandler.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">package com.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelStateEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ExceptionEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- æ¶ˆæ¯æ¥å—å¤„ç†ç±»</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- =</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">HiHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> s = (<span class="built_in">String</span>) e.getMessage();</span><br><span class="line">    System.out.println(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.messageReceived(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ•è·å¼‚å¸¸</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"exceptionCaught"</span>);</span><br><span class="line">    <span class="keyword">super</span>.exceptionCaught(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ–°è¿æ¥</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelConnected"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelConnected(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelDisconnected"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelDisconnected(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - channelå…³é—­çš„æ—¶å€™è§¦å‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelClosed"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelClosed(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ<br>channelDisconnectedåªæœ‰åœ¨è¿æ¥å»ºç«‹åæ–­å¼€æ‰ä¼šè°ƒç”¨<br>channelClosedæ— è®ºè¿æ¥æ˜¯å¦æˆåŠŸéƒ½ä¼šè°ƒç”¨å…³é—­èµ„æº<br>åœ¨è¿™é‡ŒéªŒè¯ä¸‹ï¼š<br>å½“serveræ²¡æœ‰å¼€å¯çš„æ—¶å€™ï¼Œclientå»è¯·æ±‚ï¼Œå‘ç°æŠ¥é”™ï¼Œç„¶ååªæ‰“å°äº†channelClosedï¼Œè€Œæ²¡æœ‰æ‰“å°channelConnected<br>serverå¼€å¯å¹¶clientå’Œserveræ­£å¸¸äº¤äº’åå°†æœåŠ¡ç«¯æ–­å¼€ä¼šæ‰“å°channelDisconnected</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä¸¾ä¸ªğŸŒ°&quot;&gt;&lt;a href=&quot;#ä¸¾ä¸ªğŸŒ°&quot; class=&quot;headerlink&quot; title=&quot;ä¸¾ä¸ªğŸŒ°&quot;&gt;&lt;/a
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ï¼šnettyæœåŠ¡å™¨</title>
    <link href="http://mmmmmm.me/2019-03-10-2.html"/>
    <id>http://mmmmmm.me/2019-03-10-2.html</id>
    <published>2019-03-10T02:21:02.000Z</published>
    <updated>2019-03-10T14:54:23.744Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>nettyç‰ˆæœ¬å¤§è‡´ç‰ˆæœ¬åˆ†ä¸º netty3.x å’Œ netty4.xã€netty5.x</p><p>nettyå¯ä»¥è¿ç”¨åœ¨é‚£äº›é¢†åŸŸï¼Ÿ</p><ol><li><p>åˆ†å¸ƒå¼è¿›ç¨‹é€šä¿¡<br>ä¾‹å¦‚: hadoopã€dubboã€akkaç­‰å…·æœ‰åˆ†å¸ƒå¼åŠŸèƒ½çš„æ¡†æ¶ï¼Œåº•å±‚RPCé€šä¿¡éƒ½æ˜¯åŸºäºnettyå®ç°çš„ï¼Œè¿™äº›æ¡†æ¶ä½¿ç”¨çš„ç‰ˆæœ¬é€šå¸¸éƒ½è¿˜åœ¨ç”¨netty3.x</p></li><li><p>æ¸¸æˆæœåŠ¡å™¨å¼€å‘<br>æœ€æ–°çš„æ¸¸æˆæœåŠ¡å™¨æœ‰éƒ¨åˆ†å…¬å¸å¯èƒ½å·²ç»å¼€å§‹é‡‡ç”¨netty4.x æˆ– netty5.x</p></li></ol><h1 id="NettyæœåŠ¡ç«¯Hello-Worldæ¡ˆä¾‹"><a href="#NettyæœåŠ¡ç«¯Hello-Worldæ¡ˆä¾‹" class="headerlink" title="NettyæœåŠ¡ç«¯Hello Worldæ¡ˆä¾‹"></a>NettyæœåŠ¡ç«¯Hello Worldæ¡ˆä¾‹</h1><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>server.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelPipelineFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.Channels;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.handler.codec.string.StringEncoder;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- nettyæœåŠ¡ç«¯å…¥é—¨</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//æœåŠ¡ç±»</span></span><br><span class="line">  ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™</span></span><br><span class="line">  ExecutorService boss = Executors.newCachedThreadPool();</span><br><span class="line">  ExecutorService worker = Executors.newCachedThreadPool();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®niosocketå·¥å‚</span></span><br><span class="line">  bootstrap.setFactory(<span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è®¾ç½®ç®¡é“çš„å·¥å‚ï¼Œç®¡é“æ˜¯æœåŠ¡ï¼Œç›¸å½“äºè£…äº†ä¸€å¤§å †çš„è¿‡æ»¤å™¨</span></span><br><span class="line">  bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() &#123;</span><br><span class="line">  </span><br><span class="line">  @Override</span><br><span class="line">  public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line">  </span><br><span class="line">  ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line">  pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">  pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">  <span class="comment">//æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">  pipeline.addLast(<span class="string">"helloHandler"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line">  <span class="keyword">return</span> pipeline;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//ç»‘å®šç«¯å£</span></span><br><span class="line">  bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">10101</span>));</span><br><span class="line">  </span><br><span class="line">  System.out.println(<span class="string">"start!!!"</span>);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>HelloHandler.java<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">package com.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ChannelStateEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.ExceptionEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.MessageEvent;</span><br><span class="line"><span class="keyword">import</span> org.jboss.netty.channel.SimpleChannelHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">- æ¶ˆæ¯æ¥å—å¤„ç†ç±»</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public <span class="class"><span class="keyword">class</span> <span class="title">HelloHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span> s = (<span class="built_in">String</span>) e.getMessage();</span><br><span class="line">    System.out.println(s);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">    ctx.getChannel().write(<span class="string">"hi"</span>);</span><br><span class="line">    <span class="keyword">super</span>.messageReceived(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ•è·å¼‚å¸¸</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"exceptionCaught"</span>);</span><br><span class="line">    <span class="keyword">super</span>.exceptionCaught(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - æ–°è¿æ¥</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelConnected"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelConnected(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelDisconnected"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelDisconnected(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  - channelå…³é—­çš„æ—¶å€™è§¦å‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    @Override</span><br><span class="line">    public <span class="keyword">void</span> channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">"channelClosed"</span>);</span><br><span class="line">    <span class="keyword">super</span>.channelClosed(ctx, e);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨Server.java<br>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start!!!</span><br></pre></td></tr></table></figure><p></p><p>telnet<br>è¾“å…¥<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10101</span></span><br></pre></td></tr></table></figure><p></p><p>å›è½¦<br>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channelConnected</span><br></pre></td></tr></table></figure><p></p><p>telnet<br>è¾“å…¥<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send hello</span><br></pre></td></tr></table></figure><p></p><p>å›è½¦<br>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">messageReceived</span><br></pre></td></tr></table></figure><p></p><p>åœ¨messageReceivedæ–¹æ³•å¤„åŠ int i = i/10<br>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">messageReceived</span><br><span class="line">exception</span><br></pre></td></tr></table></figure><p></p><p>å…³é—­telnet<br>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channelDisconnected</span><br><span class="line">channelClosed</span><br></pre></td></tr></table></figure><p>channelDisconnectedå’ŒchannelClosedçš„åŒºåˆ«<br>channelDisconnectedï¼šå¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘<br>channelClosedï¼šchannelå…³é—­çš„æ—¶å€™è§¦å‘<br>å®¢æˆ·ç«¯è¿æ¥ä¸æˆåŠŸçš„è¯ä¸ä¼šè§¦å‘channelDisconnectedï¼Œåªä¼šè§¦å‘channelClosedæ–¹æ³•</p><h2 id="å°æ”¹è¿›"><a href="#å°æ”¹è¿›" class="headerlink" title="å°æ”¹è¿›"></a>å°æ”¹è¿›</h2><ul><li>æ¥æ”¶æ•°æ®æ”¹è¿›<br>æ³¨æ„messageReceivedæ–¹æ³•ä¸­æœ¬åº”è¯¥æ˜¯</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ChannelBuffer message = (ChannelBuffer)e.getMessage();</span><br><span class="line"><span class="built_in">String</span> s = <span class="keyword">new</span> <span class="built_in">String</span>(message.array());</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šåº”è¯¥æ˜¯Nettyè¿›è¡Œäº†å°è£…<br>Server.javaä¸­åŠ å…¥<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br></pre></td></tr></table></figure><p></p><p>messageReceivedä¸­å°±å¯ä»¥æ”¹æˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> s = e.getMessage();</span><br></pre></td></tr></table></figure><p>è¿™æ ·å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„æ•ˆæœ</p><ul><li>å›å†™æ•°æ®<br>messageReceivedæ–¹æ³•ä¸­<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.getChannel().write(<span class="string">"hi"</span>);</span><br></pre></td></tr></table></figure></li></ul><p>è¿™æ ·æ˜¯ä¼šæŠ¥é”™çš„ï¼Œåº”è¯¥ä¼ ä¸€ä¸ªChannelBuffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ChannelBuffer copoedBuffer = ChannelBuffers.copiedBuffer(<span class="string">"hi"</span>.getBytes());</span><br><span class="line">ctx.getChannel.write(copoedBuffer);</span><br></pre></td></tr></table></figure><p>å¯æ˜¯è¿™æ ·è¿˜æ˜¯æŒºéº»çƒ¦çš„Nettyè¿˜æ˜¯å¸®æˆ‘ä»¬å°è£…å¥½äº†<br>åœ¨Server.javaä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br></pre></td></tr></table></figure><p>ä¼šå†™æ•°æ®å°±å¯çŸ¥ç›´æ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.getChannel().write(<span class="string">"hi"</span>);</span><br></pre></td></tr></table></figure><h2 id="é‡ç‚¹è®²è§£"><a href="#é‡ç‚¹è®²è§£" class="headerlink" title="é‡ç‚¹è®²è§£"></a>é‡ç‚¹è®²è§£</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ChannelPipeline getPipeline() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ChannelPipeline pipeline = Channels.pipeline();</span><br><span class="line">pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line"><span class="comment">//æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">pipeline.addLast(<span class="string">"helloHandler"</span>, <span class="keyword">new</span> HelloHandler());</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®¡é“åˆ†ä¸ºæ¶ˆæ¯åˆ†ä¸ºäº†ä¸Šè¡Œå’Œä¸‹è¡Œ<br>StringDecoderç»§æ‰¿ChannelIpstreamHandler<br>StringEncoderç»§æ‰¿äº†ChannelDownStreamHandler<br>HelloHandlerç»§æ‰¿äº†SimpleChannelHandler<br>ä¸Šè¡Œä¼šç»è¿‡HelloHandlerï¼Œç„¶åä¸‹è¡Œå›å†™æ•°æ®å°±ä¼šç»è¿‡StringEncoderï¼Œç„¶åå†å›å†™æ•°æ®ç»™å®¢æˆ·ç«¯</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><h2 id="nettyæœåŠ¡ç«¯hello-worldæ¡ˆä¾‹"><a href="#nettyæœåŠ¡ç«¯hello-worldæ¡ˆä¾‹" class="headerlink" title="nettyæœåŠ¡ç«¯hello worldæ¡ˆä¾‹"></a>nettyæœåŠ¡ç«¯hello worldæ¡ˆä¾‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SimpleChannelHandler å¤„ç†æ¶ˆæ¯æ¥æ”¶å’Œå†™</span><br><span class="line">&#123;</span><br><span class="line">messageReceivedæ¥æ”¶æ¶ˆæ¯</span><br><span class="line"></span><br><span class="line">channelConnectedæ–°è¿æ¥ï¼Œé€šå¸¸ç”¨æ¥æ£€æµ‹IPæ˜¯å¦æ˜¯é»‘åå•ï¼Œæ¯æ¬¡åšä¸€ä¸ªç»Ÿè®¡ï¼Œ</span><br><span class="line">å½“ç¨‹åºå‘˜æ¶æ„é€šè¿‡å®¢æˆ·ç«¯ä¸æ–­åœ°å‘é€è¯·æ±‚ï¼Œ</span><br><span class="line">ç»è¿‡è¯†åˆ«ï¼Œå°±ä¼šchannel.closeå…³é—­æ‰ï¼Œé€šè¿‡å¤„ç†åŠ å…¥é»‘åå•ã€‚</span><br><span class="line"></span><br><span class="line">channelDisconnectedé“¾æ¥å…³é—­ï¼Œå¯ä»¥å†ç”¨æˆ·æ–­çº¿çš„æ—¶å€™æ¸…æ¥šç”¨æˆ·çš„ç¼“å­˜æ•°æ®ç­‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bosså’Œworkerçº¿ç¨‹æ± é‡Œé¢å…¶å®æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œé‡Œé¢æ˜¯selectorï¼Œboss selectoræ˜¯ç”¨æ¥ç›‘å¬ç«¯å£çš„ï¼Œworker selectoræ˜¯è´Ÿè´£channelçš„è¯»å†™ä»»åŠ¡çš„</p><h2 id="channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ"><a href="#channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ"></a>channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ</h2><p>channelDisconnectedåªæœ‰åœ¨è¿æ¥å»ºç«‹åæ–­å¼€æ‰ä¼šè°ƒç”¨<br>channelClosedæ— è®ºè¿æ¥æ˜¯å¦æˆåŠŸéƒ½ä¼šè°ƒç”¨å…³é—­èµ„æº</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šNIO</title>
    <link href="http://mmmmmm.me/2019-03-10-1.html"/>
    <id>http://mmmmmm.me/2019-03-10-1.html</id>
    <published>2019-03-10T02:21:01.000Z</published>
    <updated>2019-03-10T15:08:54.462Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä¼ ç»Ÿçš„socketåˆ†æ"><a href="#ä¼ ç»Ÿçš„socketåˆ†æ" class="headerlink" title="ä¼ ç»Ÿçš„socketåˆ†æ"></a>ä¼ ç»Ÿçš„socketåˆ†æ</h1><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">package OIO;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ ç»ŸsocketæœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OioServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(<span class="string">"resource"</span>)</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</span><br><span class="line"><span class="comment">//åˆ›å»ºsocketæœåŠ¡,ç›‘å¬10101ç«¯å£</span></span><br><span class="line">ServerSocket server=<span class="keyword">new</span> ServerSocket(<span class="number">10101</span>);</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡å™¨å¯åŠ¨ï¼"</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="comment">//è·å–ä¸€ä¸ªå¥—æ¥å­—ï¼ˆé˜»å¡ï¼‰</span></span><br><span class="line">final Socket socket = server.accept();</span><br><span class="line">System.out.println(<span class="string">"æ¥ä¸ªä¸€ä¸ªæ–°å®¢æˆ·ç«¯ï¼"</span>);</span><br><span class="line">newCachedThreadPool.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="comment">//ä¸šåŠ¡å¤„ç†</span></span><br><span class="line">handler(socket);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment"> * @param socket</span></span><br><span class="line"><span class="comment"> * @throws Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> handler(Socket socket)&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">byte[] bytes = <span class="keyword">new</span> byte[<span class="number">1024</span>];</span><br><span class="line">InputStream inputStream = socket.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="comment">//è¯»å–æ•°æ®ï¼ˆé˜»å¡ï¼‰</span></span><br><span class="line">int read = inputStream.read(bytes);</span><br><span class="line"><span class="keyword">if</span>(read != <span class="number">-1</span>)&#123;</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="built_in">String</span>(bytes, <span class="number">0</span>, read));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">System.out.println(<span class="string">"socketå…³é—­"</span>);</span><br><span class="line">socket.close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸ºä¿®æ”¹åçš„ä»£ç ã€‚å¦‚æœä¸å°†handler(socket);æ”¾åœ¨çº¿ç¨‹æ± ä¸­</p><p>æ‰“å¼€ç¬¬ä¸€ä¸ªtelnet<br>cmd<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10101</span></span><br></pre></td></tr></table></figure><p></p><p>eclisepç»ˆç«¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ–­ç‚¹æ‰§è¡Œï¼Œæ–­ç‚¹æ‰§è¡Œåˆ°readå½¢æˆäº†é˜»å¡<br>å†æ‰“å¼€ç¬¬äºŒä¸ªtelnet<br>cmd<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10101</span></span><br></pre></td></tr></table></figure><p></p><p>eclipseç»ˆç«¯æ²¡æœ‰ä»»ä½•ååº”ï¼Œè¯´æ˜æ²¡æœ‰è¿ä¸Šå®¢æˆ·ç«¯ï¼Œå› ä¸ºå·²ç»é˜»å¡åœ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯çš„readå‡½æ•°ä¸­ï¼Œæ‰€ä»¥ä¸èƒ½è¿”å›åˆ°acceptï¼ˆï¼‰<br>è¿™ä¸ªæ—¶å€™åœ¨ç¬¬ä¸€ä¸ªtelnetä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send hello</span><br></pre></td></tr></table></figure><p>eclipseç»ˆç«¯<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p></p><p>ä½†æ˜¯ç¬¬äºŒä¸ªè¿˜æ˜¯è¿›ä¸æ¥ï¼Ÿ</p><p>é‚£æ˜¯ä¸æ˜¯å¯ä»¥å§handlerä¿®æ”¹æˆä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å‘¢ï¼Ÿæ¥ä¸€ä¸ªsocketå°±ä¸ºè¿™ä¸ªsockeæœåŠ¡<br>é€šè¿‡çº¿ç¨‹æ± ï¼Œå°†ä»»åŠ¡æ·»åŠ è¿›å…¥çº¿ç¨‹æ± å†çœ‹ç»“æœ<br>é‡å¤ä¸Šé¢çš„æ“ä½œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10101</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br></pre></td></tr></table></figure><p>send hello<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p></p><p>å†å¼€å¯ä¸€ä¸ªtelnet</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10101</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br><span class="line">hello</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br></pre></td></tr></table></figure><p>send abc<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡å™¨å¯åŠ¨ï¼</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br><span class="line">hello</span><br><span class="line">æ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯</span><br><span class="line">abc</span><br></pre></td></tr></table></figure><p></p><h3 id="å¼Šç«¯"><a href="#å¼Šç«¯" class="headerlink" title="å¼Šç«¯"></a>å¼Šç«¯</h3><p>ä¸Šé¢è™½ç„¶æŠŠhandler(socket);æ”¾åˆ°äº†çº¿ç¨‹æ± ä¸­ï¼Œä½¿å¾—å¤šä¸ªsocketèƒ½å¤Ÿè¿›è¡Œè¿æ¥ï¼Œå¯æ˜¯æ¯ä¸ªsocketéœ€è¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡å¦‚æŠŠç³»ç»Ÿæ¯”ä½œæ˜¯ä¸€ä¸ªé¤å…çš„è¯ï¼Œæ¥ä¸€å®¢äººå°±å®‰æ’ä¸€ä¸ªæœåŠ¡ç”Ÿä¸“é—¨æ¥å¾…è¿™ä¸ªå®¢äººï¼Œåˆæ¥ä¸€ä¸ªæ–°çš„å®¢äººåˆå®‰æ’ä¸€ä¸ªæ–°çš„æœåŠ¡ç”Ÿï¼Œè¿™æ ·çš„æ¶ˆè€—å¾ˆå¤§ï¼Œå®¢äººè¶Šæ¥è¶Šå¤šï¼Œé¥­åº—è¿Ÿæ—©ä¸€å¤©ä¼šé»„äº†çš„<br>æ‰€ä»¥ä¼ ç»Ÿçš„socketä¸èƒ½åšé•¿è¿æ¥çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯å¯ä»¥åšçŸ­è¿æ¥çš„æœåŠ¡å™¨ã€‚<br>ä¾‹å¦‚è€çš„tomcatï¼Œåº•å±‚æ˜¯ç”¨socketï¼Œå› ä¸ºæ˜¯ä¸€é—®ä¸€ç­”æœºåˆ¶ï¼Œå®¢æˆ·ç«¯å‘ä¸€ä¸ªæ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å›äº†ä»¥åå°±å¯ä»¥å…³æ‰ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°çº¿ç¨‹ä¸€ç›´è¢«ä¸€ä¸ªå®¢æˆ·ç«¯å ç”¨çš„æƒ…å†µï¼Œä¸€ä¸ªçº¿ç¨‹æ˜¯å¯ä»¥ä¸ºå¤šä¸ªå®¢æˆ·ç«¯å¤„ç†ä»»åŠ¡çš„</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é˜»å¡ç‚¹</p><ul><li>server.accept();</li><li>inputStream.read(bytes);</li></ul><p>å•çº¿ç¨‹æƒ…å†µä¸‹åªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯<br>ç”¨çº¿ç¨‹æ± å¯ä»¥æœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œä½†æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½</p><h1 id="NIOä»£ç åˆ†æ"><a href="#NIOä»£ç åˆ†æ" class="headerlink" title="NIOä»£ç åˆ†æ"></a>NIOä»£ç åˆ†æ</h1><h2 id="ä¸¾ä¸ªğŸŒ°-1"><a href="#ä¸¾ä¸ªğŸŒ°-1" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">package NIO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NIOæœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">NIOServer</span> </span>&#123;</span><br><span class="line"><span class="comment">// é€šé“ç®¡ç†å™¨</span></span><br><span class="line">private Selector selector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å¾—ä¸€ä¸ªServerSocketé€šé“ï¼Œå¹¶å¯¹è¯¥é€šé“åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param port</span></span><br><span class="line"><span class="comment"> *            ç»‘å®šçš„ç«¯å£å·</span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> initServer(int port) throws IOException &#123;</span><br><span class="line"><span class="comment">// è·å¾—ä¸€ä¸ªServerSocketé€šé“ï¼ŒServerSocketChannelæƒ³åˆ°ä¸æ™®é€šioçš„ServerSocket</span></span><br><span class="line">ServerSocketChannel serverChannel = ServerSocketChannel.open();</span><br><span class="line"><span class="comment">// è®¾ç½®é€šé“ä¸ºéé˜»å¡</span></span><br><span class="line">serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">// å°†è¯¥é€šé“å¯¹åº”çš„ServerSocketç»‘å®šåˆ°portç«¯å£</span></span><br><span class="line">serverChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line"><span class="comment">// è·å¾—ä¸€ä¸ªé€šé“ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">this</span>.selector = Selector.open();</span><br><span class="line"><span class="comment">// å°†é€šé“ç®¡ç†å™¨å’Œè¯¥é€šé“ç»‘å®šï¼Œå¹¶ä¸ºè¯¥é€šé“æ³¨å†ŒSelectionKey.OP_ACCEPTäº‹ä»¶,æ³¨å†Œè¯¥äº‹ä»¶åï¼Œ</span></span><br><span class="line"><span class="comment">// å½“è¯¥äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œselector.select()ä¼šè¿”å›ï¼Œå¦‚æœè¯¥äº‹ä»¶æ²¡åˆ°è¾¾selector.select()ä¼šä¸€ç›´é˜»å¡ã€‚</span></span><br><span class="line">serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ç›‘å¬selectorä¸Šæ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„äº‹ä»¶ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> listen() throws IOException &#123;</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼"</span>);</span><br><span class="line"><span class="comment">// è½®è¯¢è®¿é—®selector</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="comment">// å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line"><span class="comment">//ç‚¹ä¸è¿›å»selectæ–¹æ³•ï¼Œå› ä¸ºåº•å±‚æ˜¯cå†™çš„</span></span><br><span class="line">selector.select();</span><br><span class="line"><span class="comment">// è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶</span></span><br><span class="line">Iterator&lt;?&gt; ite = <span class="keyword">this</span>.selector.selectedKeys().iterator();</span><br><span class="line"><span class="keyword">while</span> (ite.hasNext()) &#123;</span><br><span class="line">SelectionKey key = (SelectionKey) ite.next();</span><br><span class="line"><span class="comment">// åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†</span></span><br><span class="line">ite.remove();</span><br><span class="line"></span><br><span class="line">handler(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param key</span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> handler(SelectionKey key) throws IOException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥äº‹ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">handlerAccept(key);</span><br><span class="line"><span class="comment">// è·å¾—äº†å¯è¯»çš„äº‹ä»¶</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">handelerRead(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†è¿æ¥è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param key</span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> handlerAccept(SelectionKey key) throws IOException &#123;</span><br><span class="line">ServerSocketChannel server = (ServerSocketChannel) key.channel();</span><br><span class="line"><span class="comment">// è·å¾—å’Œå®¢æˆ·ç«¯è¿æ¥çš„é€šé“ï¼ŒSocketChannelç›¸å½“äºä¼ ç»Ÿioé‡Œé¢çš„Channel</span></span><br><span class="line">SocketChannel channel = server.accept();</span><br><span class="line"><span class="comment">// è®¾ç½®æˆéé˜»å¡</span></span><br><span class="line">channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è¿™é‡Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯å“¦</span></span><br><span class="line">System.out.println(<span class="string">"æ–°çš„å®¢æˆ·ç«¯è¿æ¥"</span>);</span><br><span class="line"><span class="comment">// åœ¨å’Œå®¢æˆ·ç«¯è¿æ¥æˆåŠŸä¹‹åï¼Œä¸ºäº†å¯ä»¥æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œéœ€è¦ç»™é€šé“è®¾ç½®è¯»çš„æƒé™ã€‚</span></span><br><span class="line">channel.register(<span class="keyword">this</span>.selector, SelectionKey.OP_READ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†è¯»çš„äº‹ä»¶</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param key</span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">void</span> handelerRead(SelectionKey key) throws IOException &#123;</span><br><span class="line"><span class="comment">// æœåŠ¡å™¨å¯è¯»å–æ¶ˆæ¯:å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“</span></span><br><span class="line">SocketChannel channel = (SocketChannel) key.channel();</span><br><span class="line"><span class="comment">// åˆ›å»ºè¯»å–çš„ç¼“å†²åŒº</span></span><br><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">int read = channel.read(buffer);</span><br><span class="line"><span class="keyword">if</span>(read &gt; <span class="number">0</span>)&#123;</span><br><span class="line">byte[] data = buffer.array();</span><br><span class="line"><span class="built_in">String</span> msg = <span class="keyword">new</span> <span class="built_in">String</span>(data).trim();</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š"</span> + msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">ByteBuffer outBuffer = ByteBuffer.wrap(<span class="string">"å¥½çš„"</span>.getBytes());</span><br><span class="line">channel.write(outBuffer);<span class="comment">// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"å®¢æˆ·ç«¯å…³é—­"</span>);</span><br><span class="line">key.cancel();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨æœåŠ¡ç«¯æµ‹è¯•</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @throws IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException &#123;</span><br><span class="line">NIOServer server = <span class="keyword">new</span> NIOServer();</span><br><span class="line">server.initServer(<span class="number">8000</span>);</span><br><span class="line">server.listen();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š<br>é€šè¿‡telnet å¤šæ¬¡è¿æ¥ï¼Œéƒ½å¯ä»¥æˆåŠŸ</p><h2 id="ä¸¾ä¸ªğŸŒ°-2"><a href="#ä¸¾ä¸ªğŸŒ°-2" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>NIOçš„ç‰¹ç‚¹</p><p>ServerSocketChannel ç›¸å½“äºServerSocket</p><p>SocketChannelç›¸å½“äºSocket</p><p>Selector ä½¿å¾—NIOèƒ½å¤Ÿé€šè¿‡å•çº¿ç¨‹ä¸ºå¤šä¸ªå®¢æˆ·ç«¯æœåŠ¡</p><p>SelectionKey</p><h1 id="å›¾è§£IO-NIO"><a href="#å›¾è§£IO-NIO" class="headerlink" title="å›¾è§£IO/NIO"></a>å›¾è§£IO/NIO</h1><h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190305125935937.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"></p><h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190305130054328.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>selectorç›‘æ§ç€å¤§é—¨ï¼ˆacceptï¼‰å’Œå®¢äººï¼Œå¾…åœ¨å²—ä½ä¸Šç­‰å¾…å®¢äºº<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">selector.select();</span><br></pre></td></tr></table></figure><p></p><p>å®¢äººè¿›åº—ä¹‹åå…ˆåœ¨å¤§é—¨è¿™é‡Œæ³¨å†Œä¸€ä¸ªreadäº‹ä»¶ï¼Œç›¸å½“äºè¯´äº†ä¸€å£°â€æ¬¢è¿å…‰ä¸´â€œï¼Œå¸®åŠ©å®¢äººèµ°åˆ°åº§ä½ä¸Šï¼Œç„¶åå®¢äººæœ‰éœ€æ±‚çš„è¯éšæ—¶å¾…å‘½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.register(<span class="keyword">this</span>.selector, SelectionKey.OP_READ);</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ¥ç€å›åˆ°åŸæ¥çš„å²—ä½ä¸Šå¾…å‘½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">selector.select();</span><br></pre></td></tr></table></figure><p>ç„¶åæœåŠ¡å‘˜å°±å¯ä»¥èµ°äº†ï¼Œæˆ‘ç‚¹èœï¼ˆreadçš„æ—¶å€™ï¼‰äº†å†å«ä½ <br>å®¢äººç‚¹èœâ€“ã€‹tlnet</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æƒ³è¦è¿ç»­å‘é€ï¼Œç¬¬ä¸€æ¬¡å›æ’¤ä¹‹åï¼Œéœ€è¦å…ˆé€€å‡ºå½“å‰é¡µé¢ä¸€æ¬¡ï¼Œç„¶åé€šè¿‡ç»ˆç«¯å†æ¬¡send ï¼ˆwin7ï¼‰</span></span><br><span class="line">send wo yao chi fan</span><br></pre></td></tr></table></figure><p>ç„¶åå®¢æˆ·ç«¯è¿›è¡Œè¯»èœå•ï¼ˆreadæ“ä½œï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">soutï¼ˆâ€œxxxxxxâ€ï¼‰</span><br></pre></td></tr></table></figure><h1 id="å…³äºNIOçš„ä¸€äº›ç–‘æƒ‘"><a href="#å…³äºNIOçš„ä¸€äº›ç–‘æƒ‘" class="headerlink" title="å…³äºNIOçš„ä¸€äº›ç–‘æƒ‘"></a>å…³äºNIOçš„ä¸€äº›ç–‘æƒ‘</h1><h2 id="å®¢æˆ·ç«¯å…³é—­çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­»å¾ªç¯"><a href="#å®¢æˆ·ç«¯å…³é—­çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­»å¾ªç¯" class="headerlink" title="å®¢æˆ·ç«¯å…³é—­çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­»å¾ªç¯"></a>å®¢æˆ·ç«¯å…³é—­çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­»å¾ªç¯</h2><p>è¿è¡Œä¸Šé¢çš„ç¨‹åºï¼Œæ‰“å¼€tlnet</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send hello</span><br></pre></td></tr></table></figure><p>ç„¶åå…³é—­æ‰å½“å‰tlnetçª—å£<br>æŠ¥é”™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.IOException:æ‚¨çš„ä¸»æœºä¸­çš„è½¯ä»¶ç»ˆæ­¢äº†ä¸€ä¸ªå·²å»ºç«‹çš„è¿æ¥</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> handelerRead(SelectionKey key) throws IOException &#123;</span><br><span class="line"><span class="comment">// æœåŠ¡å™¨å¯è¯»å–æ¶ˆæ¯:å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“</span></span><br><span class="line">SocketChannel channel = (SocketChannel) key.channel();</span><br><span class="line"><span class="comment">// åˆ›å»ºè¯»å–çš„ç¼“å†²åŒº</span></span><br><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">int read = channel.read(buffer);</span><br><span class="line"><span class="keyword">if</span>(read &gt; <span class="number">0</span>)&#123;</span><br><span class="line">byte[] data = buffer.array();</span><br><span class="line"><span class="built_in">String</span> msg = <span class="keyword">new</span> <span class="built_in">String</span>(data).trim();</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š"</span> + msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">ByteBuffer outBuffer = ByteBuffer.wrap(<span class="string">"å¥½çš„"</span>.getBytes());</span><br><span class="line">channel.write(outBuffer);<span class="comment">// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"å®¢æˆ·ç«¯å…³é—­"</span>);</span><br><span class="line">key.cancel();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¼šå†™æ•°æ®è¿™é‡Œå‡ºé”™ï¼Œå¯ä»¥å°†å…¶æ³¨é‡Šæ‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">ByteBuffer outBuffer = ByteBuffer.wrap(<span class="string">"å¥½çš„"</span>.getBytes());</span><br><span class="line">channel.write(outBuffer);<span class="comment">// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</span></span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€åŸæ¥çš„é”™è¯¯æ²¡æœ‰äº†å¯æ˜¯ä¼šå‡ºç°ä¸åœçš„æ­»å¾ªç¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br><span class="line">æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int read = channel.read(buffer);</span><br><span class="line"><span class="keyword">if</span>(read &gt; <span class="number">0</span>)&#123;</span><br><span class="line">byte[] data = buffer.array();</span><br><span class="line"><span class="built_in">String</span> msg = <span class="keyword">new</span> <span class="built_in">String</span>(data).trim();</span><br><span class="line">System.out.println(<span class="string">"æœåŠ¡ç«¯æ”¶åˆ°ä¿¡æ¯ï¼š"</span> + msg);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å›å†™æ•°æ®</span></span><br><span class="line">ByteBuffer outBuffer = ByteBuffer.wrap(<span class="string">"å¥½çš„"</span>.getBytes());</span><br><span class="line">channel.write(outBuffer);<span class="comment">// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"å®¢æˆ·ç«¯å…³é—­"</span>);</span><br><span class="line">key.cancel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”è¯¥å¯¹æ”¶åˆ°çš„æ•°æ®åšä¸€æ¬¡åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°±å°†keyå–æ¶ˆã€‚</p><h2 id="selector-select-é˜»å¡ï¼Œé‚£ä¸ºä»€ä¹ˆè¯´nioæ˜¯éé˜»å¡çš„IOï¼Ÿ"><a href="#selector-select-é˜»å¡ï¼Œé‚£ä¸ºä»€ä¹ˆè¯´nioæ˜¯éé˜»å¡çš„IOï¼Ÿ" class="headerlink" title="selector.select();é˜»å¡ï¼Œé‚£ä¸ºä»€ä¹ˆè¯´nioæ˜¯éé˜»å¡çš„IOï¼Ÿ"></a>selector.select();é˜»å¡ï¼Œé‚£ä¸ºä»€ä¹ˆè¯´nioæ˜¯éé˜»å¡çš„IOï¼Ÿ</h2><p>åˆ¤æ–­ioæ˜¯ä¸æ˜¯é˜»å¡çš„ç‚¹ï¼Œä¸æ˜¯acceptæˆ–è€…selectorï¼Œè€Œæ˜¯è¯»å–æ•°æ®çš„æ—¶å€™æ˜¯å¦èƒ½å¤Ÿç«‹é©¬è¿”å›ï¼Œä»ä¸Šé¢çš„é—®é¢˜çŸ¥é“ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®è¾“å…¥ä¹Ÿæ˜¯ä¼šç«‹å³è¿”å›çš„ï¼Œä½†æ˜¯ä¼ ç»Ÿçš„ioæ˜¯ä¼šé˜»å¡åœ¨å“ªé‡Œçš„<br>selector.select()<br>selectï¼ˆï¼‰å¯ä»¥éé˜»å¡ï¼Œå¸¦æœ‰å‚æ•°å³å¯å˜æˆéé˜»å¡<br>selector.select(1000);ä¸é˜»å¡ï¼Œåœ¨ä¸€ç§’å†…å†…æœ‰å‘é€è¯·æ±‚ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¼šè¿”å›ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯é›¶ã€‚<br>selector.wakeup();ä¹Ÿå¯ä»¥å”¤é†’selectorï¼Œå¦‚æœå½“å‰çš„selectoræ˜¯é˜»å¡çŠ¶æ€çš„ï¼Œç”¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨åä¼šç«‹å³è¿”å›ã€‚<br>selector.selectNow();ä¹Ÿå¯ä»¥ç«‹é©¬è¿”è¿˜ï¼Œè§†é¢‘é‡Œå¿˜äº†è®²äº†ï¼Œå“ˆï¼Œè¿™é‡Œè¡¥ä¸Š</p><h2 id="SelectionKey-OP-WRITEæ˜¯ä»£è¡¨ä»€ä¹ˆæ„æ€"><a href="#SelectionKey-OP-WRITEæ˜¯ä»£è¡¨ä»€ä¹ˆæ„æ€" class="headerlink" title="SelectionKey.OP_WRITEæ˜¯ä»£è¡¨ä»€ä¹ˆæ„æ€"></a>SelectionKey.OP_WRITEæ˜¯ä»£è¡¨ä»€ä¹ˆæ„æ€</h2><p><strong><font color="red">ä¸€èˆ¬writeæ–¹æ³•ç”¨çš„å¾ˆå°‘ï¼Œå†™æ•°æ®çš„æ—¶å€™ä¹Ÿä¸éœ€è¦æ³¨å†Œwriteäº‹ä»¶ã€‚</font></strong></p><p>OP_WRITEè¡¨ç¤ºåº•å±‚ç¼“å†²åŒºæ˜¯å¦æœ‰ç©ºé—´ï¼Œæ˜¯åˆ™å“åº”è¿”è¿˜trueï¼ˆä¸€èˆ¬éƒ½æ˜¯æœ‰ç©ºé—´çš„ï¼Œå³ä¸€èˆ¬æ˜¯trueï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"isWriteabl"</span>+key.isWritable)</span><br></pre></td></tr></table></figure><p>è¾“å‡º<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºæ²¡æœ‰ç»™selectoræ³¨å†Œè¿™ä¸ªäº‹ä»¶ï¼Œæ‰€ä»¥é»˜è®¤æ˜¯false<br>æ¯”å¦‚é¤å…é‡Œé¢çš„ç­·å­æ‰äº†ï¼Œç»ç†æ²¡è®©ä½ ç®¡ï¼Œä½ å°±å‡è£…ä¸çŸ¥é“ï¼Œä½†æ˜¯ç»ç†å‘Šè¯‰ä½ ç­·å­æ‰äº†ï¼ˆæ³¨å†Œï¼‰ï¼Œä½ å°±éœ€è¦æ¡èµ·æ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.register(<span class="keyword">this</span>.selector,SelectionKey.OP_WRITE)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">isWriteabl <span class="literal">true</span></span><br><span class="line">isWriteabl <span class="literal">true</span></span><br><span class="line">isWriteabl <span class="literal">true</span></span><br><span class="line">isWriteabl <span class="literal">true</span></span><br><span class="line">isWriteabl <span class="literal">true</span></span><br><span class="line">isWriteabl <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å°±æ˜¯åˆ¤æ–­ç¼“å†²åŒºæœ‰æ²¡æœ‰ç©ºé—´ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæ³¨å†Œwriteäº‹ä»¶</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä¼ ç»Ÿçš„socketåˆ†æ&quot;&gt;&lt;a href=&quot;#ä¼ ç»Ÿçš„socketåˆ†æ&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84RPC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Netty" scheme="http://mmmmmm.me/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šJVMå­—èŠ‚ç æ‰§è¡Œ</title>
    <link href="http://mmmmmm.me/2019-03-05-1.html"/>
    <id>http://mmmmmm.me/2019-03-05-1.html</id>
    <published>2019-03-05T01:21:02.000Z</published>
    <updated>2019-03-04T23:42:02.587Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="javap"><a href="#javap" class="headerlink" title="javap"></a>javap</h1><h2 id="javap-1"><a href="#javap-1" class="headerlink" title="javap"></a>javap</h2><p>classæ–‡ä»¶åæ±‡ç¼–å·¥å…·<br><strong><font color="red">ç”ŸæˆcodeåŒºï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰ ï¼Œè¿™å’Œclassæ–‡ä»¶ä¸­çš„å­—èŠ‚ç æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„â€2A 1B B5 00 20 B1â€œ æ˜¯åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­æ˜ å°„è¿™å…·ä½“çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå¯æ˜¯åœ¨å­—èŠ‚ç æ–‡ä»¶ä¸­ä»…ä»…å­˜åœ¨çš„éƒ½æ˜¯åå…­è¿›åˆ¶çš„æœ‰æ˜ å°„èƒ½åŠ›çš„å­—èŠ‚ç è€Œéæ±‡ç¼–æŒ‡ä»¤ã€‚</font></strong></p><p>javapæ˜¯jdkè‡ªå¸¦çš„åè§£æå·¥å…·ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®classå­—èŠ‚ç æ–‡ä»¶ï¼Œåè§£æå‡ºå½“å‰ç±»å¯¹åº”çš„codeåŒºï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰ã€æœ¬åœ°å˜é‡è¡¨ã€å¼‚å¸¸è¡¨å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ã€å¸¸é‡æ± ç­‰ç­‰ä¿¡æ¯ã€‚<br>å½“ç„¶è¿™äº›ä¿¡æ¯ä¸­ï¼Œæœ‰äº›ä¿¡æ¯ï¼ˆå¦‚æœ¬åœ°å˜é‡è¡¨ã€æŒ‡ä»¤å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ã€å¸¸é‡æ± ä¸­æ–¹æ³•çš„å‚æ•°åç§°ç­‰ç­‰ï¼‰éœ€è¦åœ¨ä½¿ç”¨javacç¼–è¯‘æˆclassæ–‡ä»¶æ—¶ï¼ŒæŒ‡å®šå‚æ•°æ‰èƒ½è¾“å‡ºï¼Œæ¯”å¦‚ï¼Œä½ ç›´æ¥javac xx.javaï¼Œå°±ä¸ä¼šåœ¨ç”Ÿæˆå¯¹åº”çš„å±€éƒ¨å˜é‡è¡¨ç­‰ä¿¡æ¯ï¼Œå¦‚æœä½ ä½¿ç”¨javac -g xx.javaå°±å¯ä»¥ç”Ÿæˆæ‰€æœ‰ç›¸å…³ä¿¡æ¯äº†ã€‚å¦‚æœä½ ä½¿ç”¨çš„eclipseï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹ï¼Œeclipseåœ¨ç¼–è¯‘æ—¶ä¼šå¸®ä½ ç”Ÿæˆå±€éƒ¨å˜é‡è¡¨ã€æŒ‡ä»¤å’Œä»£ç è¡Œåç§»é‡æ˜ å°„è¡¨ç­‰ä¿¡æ¯çš„ã€‚<br>é€šè¿‡åç¼–è¯‘ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥çš„äº†è§£javaä»£ç çš„å·¥ä½œæœºåˆ¶ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹i++ï¼›è¿™è¡Œä»£ç å®é™…è¿è¡Œæ—¶æ˜¯å…ˆè·å–å˜é‡içš„å€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼åŠ 1ï¼Œæœ€åå†å°†åŠ 1åçš„å€¼èµ‹å€¼ç»™å˜é‡iã€‚<br>é€šè¿‡å±€éƒ¨å˜é‡è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸèŒƒå›´ã€æ‰€åœ¨æ§½ä½ç­‰ä¿¡æ¯ï¼Œç”šè‡³å¯ä»¥çœ‹åˆ°æ§½ä½å¤ç”¨ç­‰ä¿¡æ¯ã€‚<br>javapçš„ç”¨æ³•æ ¼å¼ï¼š<br>javap<options><classes><br>å…¶ä¸­classeså°±æ˜¯ä½ è¦åç¼–è¯‘çš„classæ–‡ä»¶ã€‚<br>åœ¨å‘½ä»¤è¡Œä¸­ç›´æ¥è¾“å…¥javapæˆ–javap -helpå¯ä»¥çœ‹åˆ°javapçš„optionsæœ‰å¦‚ä¸‹é€‰é¡¹ï¼š</classes></options></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-help  --help  -?        è¾“å‡ºæ­¤ç”¨æ³•æ¶ˆæ¯</span><br><span class="line">-version                 ç‰ˆæœ¬ä¿¡æ¯ï¼Œå…¶å®æ˜¯å½“å‰javapæ‰€åœ¨jdkçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¸æ˜¯<span class="class"><span class="keyword">class</span>åœ¨å“ªä¸ª<span class="title">jdk</span>ä¸‹ç”Ÿæˆçš„ã€‚</span></span><br><span class="line"><span class="class">-<span class="title">v</span>  -<span class="title">verbose</span>             è¾“å‡ºé™„åŠ ä¿¡æ¯ï¼ˆåŒ…æ‹¬è¡Œå·ã€æœ¬åœ°å˜é‡è¡¨ï¼Œåæ±‡ç¼–ç­‰è¯¦ç»†ä¿¡æ¯ï¼‰</span></span><br><span class="line"><span class="class">-<span class="title">l</span>                         è¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨</span></span><br><span class="line"><span class="class">-<span class="title">public</span>                    ä»…æ˜¾ç¤ºå…¬å…±ç±»å’Œæˆå‘˜</span></span><br><span class="line"><span class="class">-<span class="title">protected</span>               æ˜¾ç¤ºå—ä¿æŠ¤çš„/å…¬å…±ç±»å’Œæˆå‘˜</span></span><br><span class="line"><span class="class">-<span class="title">package</span>                 æ˜¾ç¤ºç¨‹åºåŒ…/å—ä¿æŠ¤çš„/å…¬å…±ç±» å’Œæˆå‘˜ (é»˜è®¤)</span></span><br><span class="line"><span class="class">-<span class="title">p</span>  -<span class="title">private</span>             æ˜¾ç¤ºæ‰€æœ‰ç±»å’Œæˆå‘˜</span></span><br><span class="line"><span class="class">-<span class="title">c</span>                       å¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–</span></span><br><span class="line"><span class="class">-<span class="title">s</span>                       è¾“å‡ºå†…éƒ¨ç±»å‹ç­¾å</span></span><br><span class="line"><span class="class">-<span class="title">sysinfo</span>                 æ˜¾ç¤ºæ­£åœ¨å¤„ç†çš„ç±»çš„ç³»ç»Ÿä¿¡æ¯ (è·¯å¾„, å¤§å°, æ—¥æœŸ, <span class="title">MD5</span> æ•£åˆ—)</span></span><br><span class="line"><span class="class">-<span class="title">constants</span>               æ˜¾ç¤ºé™æ€æœ€ç»ˆå¸¸é‡</span></span><br><span class="line"><span class="class">-<span class="title">classpath</span> &lt;<span class="title">path</span>&gt;        æŒ‡å®šæŸ¥æ‰¾ç”¨æˆ·ç±»æ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line"><span class="class">-<span class="title">bootclasspath</span> &lt;<span class="title">path</span>&gt;    è¦†ç›–å¼•å¯¼ç±»æ–‡ä»¶çš„ä½ç½®</span></span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬å¸¸ç”¨çš„æ˜¯-v -l -cä¸‰ä¸ªé€‰é¡¹ã€‚<br>javap -v classxxï¼Œä¸ä»…ä¼šè¾“å‡ºè¡Œå·ã€æœ¬åœ°å˜é‡è¡¨ä¿¡æ¯ã€åç¼–è¯‘æ±‡ç¼–ä»£ç ï¼Œè¿˜ä¼šè¾“å‡ºå½“å‰ç±»ç”¨åˆ°çš„å¸¸é‡æ± ç­‰ä¿¡æ¯ã€‚<br>javap -l ä¼šè¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨ä¿¡æ¯ã€‚<br>javap -c ä¼šå¯¹å½“å‰classå­—èŠ‚ç è¿›è¡Œåç¼–è¯‘ç”Ÿæˆæ±‡ç¼–ä»£ç ã€‚<br>æŸ¥çœ‹æ±‡ç¼–ä»£ç æ—¶ï¼Œéœ€è¦çŸ¥é“é‡Œé¢çš„jvmæŒ‡ä»¤ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<br><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html</a><br>å¦å¤–é€šè¿‡jclasslibå·¥å…·ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œè€Œä¸”æ˜¯å¯è§†åŒ–çš„ï¼Œæ•ˆæœæ›´å¥½ä¸€äº›ã€‚</p><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Calc</span> </span>&#123;</span><br><span class="line">public int calc() &#123;</span><br><span class="line">int a = <span class="number">500</span>;</span><br><span class="line">int b = <span class="number">200</span>;</span><br><span class="line">int c = <span class="number">50</span>;</span><br><span class="line"><span class="keyword">return</span> (a + b) / c;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘½ä»¤<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap â€“verbose Calc</span><br></pre></td></tr></table></figure><p></p><p>å¾—åˆ°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public int calc();</span><br><span class="line">  Code:</span><br><span class="line">  <span class="comment">//æ ˆå¤§å°   å±€éƒ¨å˜é‡å¤§å° </span></span><br><span class="line">   Stack=<span class="number">2</span>, Locals=<span class="number">4</span>, Args_size=<span class="number">1</span></span><br><span class="line">   <span class="comment">//å‰é¢çš„æ•°å­—å¯ä»¥ç†è§£ä¸ºå¹¿ä¹‰ä¸Šçš„è¡Œå·ï¼Œä½†ä¸æ˜¯çœŸæ­£çš„è¡Œå·ï¼Œ</span></span><br><span class="line">   <span class="comment">//å› ä¸ºè¿™æ˜¯åç¼–è¯‘è¿‡æ¥çš„ï¼Œè¿™æ˜¯åç§»é‡çš„æ„æ€ã€‚</span></span><br><span class="line">   <span class="comment">//sipushã€istore_1ç­‰å°±æ˜¯å­—èŠ‚ç æœ¬èº«ï¼Œå°±æ˜¯æ–¹æ³•ä½“åœ¨è¿è¡Œçš„æ—¶å€™</span></span><br><span class="line">   <span class="comment">//ä¼šæ‰§è¡Œçš„æŒ‡ä»¤</span></span><br><span class="line">   <span class="number">0</span>:   sipush  <span class="number">500</span></span><br><span class="line">   <span class="number">3</span>:   istore_1</span><br><span class="line">   <span class="number">4</span>:   sipush  <span class="number">200</span></span><br><span class="line">   <span class="number">7</span>:   istore_2</span><br><span class="line">   <span class="number">8</span>:   bipush  <span class="number">50</span></span><br><span class="line">   <span class="number">10</span>:  istore_3</span><br><span class="line">   <span class="number">11</span>:  iload_1</span><br><span class="line">   <span class="number">12</span>:  iload_2</span><br><span class="line">   <span class="number">13</span>:  iadd</span><br><span class="line">   <span class="number">14</span>:  iload_3</span><br><span class="line">   <span class="number">15</span>:  idiv</span><br><span class="line">   <span class="number">16</span>:  ireturn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç®€å•çš„å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹"><a href="#ç®€å•çš„å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="ç®€å•çš„å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹"></a>ç®€å•çš„å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹</h1><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190305074041653.png"><br>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ŒæŒ‡å‘å½“å‰è¿è¡Œçš„è¿™æ¡æŒ‡ä»¤çš„ä½ç½®<br>å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆéƒ½æ˜¯åœ¨å¸§æ ˆä¸­äº§ç”Ÿçš„æ•°æ®</p><p>sipush 500å› ä¸ºå½“å‰æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥thisä½œä¸ºå‚æ•°æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨çš„ç¬¬0ä¸ªä½ç½®ï¼ŒåŒæ—¶å°†500æ“ä½œæ•°å‹å…¥åˆ°æ“ä½œæ•°æ ˆä¸­<br>istore 1 ä»æ“ä½œæ•°æ ˆä¸­å–å‡ºä¸€ä¸ªæ•°å¼¹å‡ºåˆ°å±€éƒ¨å˜é‡è¡¨ä¸­ 1çš„ä½ç½®<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304214852630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>åŒä¸Š<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190305074042945.png"><br>bipush 50 å°†50å‹å…¥åˆ°æ“ä½œæ•°æ ˆå½“ä¸­<br>istore 3 å°†æ“ä½œæ•°æ ˆé¡¶ç«¯çš„æ•°å‹å…¥åˆ°å±€éƒ¨å˜é‡è¡¨çš„ç¬¬3ä¸ªä½ç½®<br>æ‰§è¡Œå®Œä»¥ä¸ŠæŒ‡ä»¤å±€éƒ¨å˜é‡è¡¨ä¸­æ¬§å† 0123éƒ½æœ‰äº†æ•°å­—ï¼ŒåŒæ—¶æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304214915796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>iload 1 å°†å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®å‹å…¥åˆ°æ“ä½œæ•°æ ˆä¸­ï¼Œå°†å±€éƒ¨å˜é‡è¡¨çš„ç¬¬1ä¸ªä½ç½®çš„æ•´æ•°ï¼Œå‹å…¥åˆ°æ“ä½œæ•°æ ˆä¸­<br>iload 2 åŒä¸Š<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304215442985.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>iadd ç›¸åŠ æ“ä½œï¼Œä»æ“ä½œæ•°æ ˆä¸­ã€‚å¼¹å‡ºä¸¤ä¸ªæ“ä½œæ•°ï¼Œåšç´¯åŠ ï¼Œå°†æ•°æ®ä¹‹å’Œå†å‹å…¥æ“ä½œæ•°æ ˆï¼Œæ‰€ä»¥åœ¨iaddæ‰§è¡Œå®Œä¹‹åï¼Œ200+500=700<br>iload 3 å°†å±€éƒ¨å˜é‡è¡¨çš„ç¬¬3ä¸ªä½ç½®çš„æ•´æ•°50å‹å…¥æ“ä½œæ•°æ ˆçš„é¡¶ç«¯<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304215642341.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>idiv è¡¨ç¤ºæ•´æ•°çš„é™¤æ³•ï¼Œä»æ“ä½œæ•°æ ˆä¸­å¼¹å‡ºä¸¤ä¸ªæ•°ï¼Œåšé™¤æ³•ï¼Œ700/50=14<br>ireturn è¿”å›æ“ä½œæ•°æ ˆçš„æ ˆé¡¶çš„å…ƒç´ å³14<br>è‡³æ­¤å‡½æ•°è¿è¡Œå®Œæ¯•ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/2019030421594023.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ä¹‹å‰è¿™ä¸ªå›¾ä¸­é»‘è‰²æ¡†ä¸­çš„å†…å®¹æ²¡æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚<br>å³</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>A1B B5 <span class="number">00</span> <span class="number">20</span> B1</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯å‡½æ•°çœŸæ­£çš„å­—èŠ‚ç </p><p><strong><font color="red">å­—èŠ‚ç æŒ‡ä»¤ä¸ºä¸€ä¸ªbyteæ•´æ•°</font></strong><br>| æŒ‡ä»¤ | æ•´æ•° | è§£é‡Š |<br>| â€”â€”â€”â€” | â€”â€”â€”â€”â€“ | â€”â€” |<br>| _nop | = 0, // 0x00 | ç©ºæŒ‡ä»¤ |<br>| _aconst_null | = 1, // 0x01 | |<br>| _iconst_0 | = 3, // 0x03 | |<br>| _iconst_1 | = 4, // 0x04 | |<br>| _dconst_1 | = 15, // 0x0f | |<br>| _bipush | = 16, // 0x10 | |<br>| _iload_0 | = 26, // 0x1a | |<br>| _iload_1 | = 27, // 0x1b | |<br>| _aload_0 | = 42, // 0x2a | |<br>| _istore | = 54, // 0x36 | |<br>| _pop | = 87, // 0x57 | |<br>| _imul | = 104, // 0x68 | |<br>| _idiv | = 108, // 0x6c | |<br>æŒ‡ä»¤æ˜¯æ–¹ä¾¿é˜…è¯»å’Œç†è§£çš„ï¼Œå³åŠéƒ¨åˆ†æ˜¯æ–‡ä»¶ä¸­ã€è®¡ç®—æœºå†…çœŸæ­£çš„è¡¨ç¤ºæ–¹å¼</p><p>ä¸Šé¢çš„å­—èŠ‚ç è§£æ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>A1B B5 <span class="number">00</span> <span class="number">20</span> B1</span><br></pre></td></tr></table></figure><p></p><ul><li>void setAge(int) æ–¹æ³•çš„å­—èŠ‚ç <br>2A 1B B5 00 20 B1</li><li>2A _aload_0<br>æ— å‚<br>å°†å±€éƒ¨å˜é‡slot0 ï¼ˆthisï¼‰ä½œä¸ºå¼•ç”¨ å‹å…¥æ“ä½œæ•°æ ˆ</li><li>1B _iload_1<br>æ— å‚<br>å°†å±€éƒ¨å˜é‡slot1 ä½œä¸ºæ•´æ•° å‹å…¥æ“ä½œæ•°æ ˆ</li><li>B5 _putfield<br>è®¾ç½®å¯¹è±¡ä¸­å­—æ®µçš„å€¼<br>å‚æ•°ä¸º2bytes (00 20) (æŒ‡æ˜äº†å­—æ®µåç§°)</li></ul><ol><li>æŒ‡å‘å¸¸é‡æ± çš„å¼•ç”¨</li><li>Constant_Fieldref</li><li>æ­¤å¤„ä¸ºUser.age<br>å¼¹å‡ºæ ˆä¸­2ä¸ªå¯¹è±¡:objectrefï¼ˆiload_0ä¸­çš„å€¼ï¼Œå³thiså¯¹è±¡ï¼‰, valueï¼ˆload_1ä¸­çš„å€¼ï¼‰<br>å°†æ ˆä¸­çš„valueèµ‹ç»™objectrefçš„ç»™å®šå­—æ®µ</li></ol><ul><li>ç®€è€Œè¨€ä¹‹ï¼šå°±æ˜¯è®²load_1å‹å…¥çš„å€¼èµ‹å€¼ç»™thiså¯¹è±¡ä¸­çš„ageå­—æ®µ</li><li>B1 _return æ²¡æœ‰è¿”å›å€¼ï¼Œè¿”å›void</li></ul><h1 id="å¸¸ç”¨çš„å­—èŠ‚ç "><a href="#å¸¸ç”¨çš„å­—èŠ‚ç " class="headerlink" title="å¸¸ç”¨çš„å­—èŠ‚ç "></a>å¸¸ç”¨çš„å­—èŠ‚ç </h1><h2 id="å¸¸é‡å…¥æ ˆ"><a href="#å¸¸é‡å…¥æ ˆ" class="headerlink" title="å¸¸é‡å…¥æ ˆ"></a>å¸¸é‡å…¥æ ˆ</h2><table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td>aconst_null</td><td>nullå¯¹è±¡å…¥æ ˆ</td></tr><tr><td>iconst_m1</td><td>intå¸¸é‡-1å…¥æ ˆ</td></tr><tr><td>iconst_0</td><td>intå¸¸é‡0å…¥æ ˆ</td></tr><tr><td>iconst_5</td><td></td></tr><tr><td>lconst_1</td><td>longå¸¸é‡1å…¥æ ˆ</td></tr><tr><td>fconst_1</td><td>float 1.0å…¥æ ˆ</td></tr><tr><td>dconst_1</td><td>double 1.0 å…¥æ ˆ</td></tr><tr><td>bipush</td><td>8ä½å¸¦ç¬¦å·æ•´æ•°å…¥æ ˆ</td></tr><tr><td>sipush</td><td>16ä½å¸¦ç¬¦å·æ•´æ•°å…¥æ ˆ</td></tr><tr><td>ldc</td><td>å¸¸é‡æ± ä¸­çš„é¡¹å…¥æ ˆ</td></tr></tbody></table><p>å‰é¢æ˜¯<br>aè¡¨ç¤ºå¯¹è±¡çš„å¼•ç”¨ï¼Œ<br>iè¡¨ç¤ºintï¼Œ<br>lè¡¨ç¤ºlongï¼Œ<br>fè¡¨ç¤ºfloatï¼Œ<br>dè¡¨ç¤ºdoubleï¼Œ<br>biè¡¨ç¤º8ä½å¸¦ç¬¦å·æ•´æ•°ï¼ˆ128ä»¥ä¸‹ï¼‰ï¼Œ<br>siè¡¨ç¤º16ä½å¸¦ç¬¦å·æ•´æ•°ï¼Œ<br>ldcè¡¨ç¤ºå¸¸é‡æ± ä¸­çš„å¯¹è±¡æŸä¸€é¡¹å…¥æ ˆ</p><h2 id="å±€éƒ¨å˜é‡å‹æ ˆ"><a href="#å±€éƒ¨å˜é‡å‹æ ˆ" class="headerlink" title="å±€éƒ¨å˜é‡å‹æ ˆ"></a>å±€éƒ¨å˜é‡å‹æ ˆ</h2><p>å±€éƒ¨å˜é‡åŒ…æ‹¬æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡å’Œæ–¹æ³•çš„å‚æ•°</p><ul><li>xload(xä¸ºi l f d a)<br>åˆ†åˆ«è¡¨ç¤ºintï¼Œlongï¼Œfloatï¼Œdoubleï¼Œobject ref</li><li>xload_n(nä¸º0 1 2 3)</li><li>xaload(xä¸ºi l f d a b c s) xåé¢çš„aè¡¨ç¤ºæ•°ç»„<br>åˆ†åˆ«è¡¨ç¤ºint, long, float, double, obj ref ,byte,char,short<br>ä»æ•°ç»„ä¸­å–å¾—ç»™å®šç´¢å¼•çš„å€¼ï¼Œå°†è¯¥å€¼å‹æ ˆ<br>iaload</li></ul><ol><li>æ‰§è¡Œå‰ï¼Œæ ˆï¼šâ€¦, arrayref, indexï¼Œæ ˆé¡¶å…ƒç´ æ˜¯æ•°ç»„ä¸‹è¡¨ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯æ•´æ•°æ•°ç»„çš„ç´¢å¼•</li><li>å®ƒå–å¾—arrayrefæ‰€åœ¨æ•°ç»„çš„indexçš„å€¼ï¼Œå¹¶å°†å€¼å‹æ ˆï¼Œå¹¶å°†arrayrefå’Œindexä»æ ˆé¡¶å¼¹å‡ºæ¥</li><li>æ‰§è¡Œåï¼Œæ ˆï¼šâ€¦, valuï¼Œæœ€ååªå‰©ä¸‹ç»™å®šæ•°ç»„çš„indexç´¢å¼•çš„æ•°å€¼<h2 id="å‡ºæ ˆè£…è½½å…¥å±€éƒ¨å˜é‡"><a href="#å‡ºæ ˆè£…è½½å…¥å±€éƒ¨å˜é‡" class="headerlink" title="å‡ºæ ˆè£…è½½å…¥å±€éƒ¨å˜é‡"></a>å‡ºæ ˆè£…è½½å…¥å±€éƒ¨å˜é‡</h2></li></ol><ul><li>xstore(xä¸ºi l f d a)<br>å‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡</li><li>xstore_n(n 0 1 2 3)<br>å‡ºæ ˆï¼Œå°†å€¼å­˜å…¥ç¬¬nä¸ªå±€éƒ¨å˜é‡</li><li>xastore(xä¸ºi l f d a b c s)<br>å°†å€¼å­˜å…¥æ•°ç»„ä¸­<br>iastore</li></ul><ol><li>æ‰§è¡Œå‰ï¼Œæ ˆï¼šâ€¦,arrayref, index, value</li><li>æ‰§è¡Œåï¼Œæ ˆï¼šâ€¦</li><li>å°†valueå€¼å­˜å…¥arrayref[index]<h2 id="é€šç”¨æ ˆæ“ä½œï¼ˆæ— ç±»å‹ï¼Œä¸æŒ‡å®šæ•°æ®ç±»å‹ï¼‰"><a href="#é€šç”¨æ ˆæ“ä½œï¼ˆæ— ç±»å‹ï¼Œä¸æŒ‡å®šæ•°æ®ç±»å‹ï¼‰" class="headerlink" title="é€šç”¨æ ˆæ“ä½œï¼ˆæ— ç±»å‹ï¼Œä¸æŒ‡å®šæ•°æ®ç±»å‹ï¼‰"></a>é€šç”¨æ ˆæ“ä½œï¼ˆæ— ç±»å‹ï¼Œä¸æŒ‡å®šæ•°æ®ç±»å‹ï¼‰</h2></li></ol><ul><li>nop ç©ºæŒ‡ä»¤ï¼Œä»€ä¹ˆéƒ½ä¸åš</li><li>pop<br>å¼¹å‡ºæ ˆé¡¶1ä¸ªå­—é•¿</li><li><p>dup<br>å¤åˆ¶æ ˆé¡¶1ä¸ªå­—é•¿ï¼Œå¤åˆ¶å†…å®¹å‹å…¥æ ˆ</p><h2 id="ç±»å‹è½¬åŒ–"><a href="#ç±»å‹è½¬åŒ–" class="headerlink" title="ç±»å‹è½¬åŒ–"></a>ç±»å‹è½¬åŒ–</h2><p>| - |<br>| â€”- |<br>| i2l |<br>| i2f |<br>| l2i |<br>| l2f |<br>| l2d |<br>| f2i |<br>| f2d |<br>| d2i |<br>| d2l |<br>| d2f |<br>| i2b |<br>| i2c |</p><h3 id="i2l"><a href="#i2l" class="headerlink" title="i2l"></a>i2l</h3><p>å°†intè½¬ä¸ºlong<br>æ‰§è¡Œå‰ï¼Œæ ˆï¼šâ€¦, value valueæ˜¯int<br>æ‰§è¡Œåï¼Œæ ˆï¼šâ€¦,result.word1,result.word2 å°†åŸæ¥çš„intå˜æˆäº†longçš„å‰åŠéƒ¨åˆ†å’ŒååŠéƒ¨åˆ†<br>å¼¹å‡ºintï¼Œæ‰©å±•ä¸ºlongï¼Œå¹¶å…¥æ ˆ</p><h2 id="è¿ç®—"><a href="#è¿ç®—" class="headerlink" title="è¿ç®—"></a>è¿ç®—</h2><h3 id="æ•´æ•°è¿ç®—"><a href="#æ•´æ•°è¿ç®—" class="headerlink" title="æ•´æ•°è¿ç®—"></a>æ•´æ•°è¿ç®—</h3><p>|-| -|<br>|-| -|<br>iadd | åŠ <br>ladd |<br>isub | å‡<br>lsub |<br>idiv | é™¤<br>ldiv |<br>imul | ä¹˜<br>lmul |<br>iinc | æ•´æ•°åŠ åŠ <br>iâ€“ã€‹int lâ€“ã€‹long</p><h3 id="æµ®ç‚¹è¿ç®—"><a href="#æµ®ç‚¹è¿ç®—" class="headerlink" title="æµ®ç‚¹è¿ç®—"></a>æµ®ç‚¹è¿ç®—</h3><p>|-|<br>|-|<br>fadd |<br>dadd |<br>fsub |<br>dsub |<br>fdiv |<br>ddiv |<br>fmul |<br>dmul |<br>fâ€“ã€‹float dâ€“ã€‹double</p><h2 id="å¯¹è±¡æ“ä½œæŒ‡ä»¤"><a href="#å¯¹è±¡æ“ä½œæŒ‡ä»¤" class="headerlink" title="å¯¹è±¡æ“ä½œæŒ‡ä»¤"></a>å¯¹è±¡æ“ä½œæŒ‡ä»¤</h2><p>|-|<br>|-|<br>new | ç”Ÿæˆå¯¹è±¡<br>getfield |æ‹¿åˆ°å®ä¾‹å¯¹è±¡ç»™å®šå­—æ®µçš„å€¼<br>putfield |è®¾ç½®å®ä¾‹å¯¹è±¡ç»™å®šå­—æ®µçš„å€¼<br>getstatic| æ‹¿åˆ°é™æ€å­—æ®µçš„å€¼<br>putstatic| è®¾ç½®é™æ€å­—æ®µçš„å€¼</p><h2 id="æ¡ä»¶æ§åˆ¶"><a href="#æ¡ä»¶æ§åˆ¶" class="headerlink" title="æ¡ä»¶æ§åˆ¶"></a>æ¡ä»¶æ§åˆ¶</h2><p>| - | - |<br>| â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€“ |<br>| feq | å¦‚æœä¸º0ï¼Œåˆ™è·³è½¬ |<br>| fne | å¦‚æœä¸ä¸º0ï¼Œåˆ™è·³è½¬ |<br>| flt | å¦‚æœå°äº0 ï¼Œåˆ™è·³è½¬ |<br>| fge | å¦‚æœå¤§äº0ï¼Œåˆ™è·³è½¬ |<br>| f_icmpeq | å¦‚æœä¸¤ä¸ªintç›¸åŒï¼Œåˆ™è·³è½¬ |</p><h3 id="ä¸¾ä¸ªğŸŒ°-1"><a href="#ä¸¾ä¸ªğŸŒ°-1" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h3></li><li>ifeq<br>å‚æ•° byte1,byte2<br>valueå‡ºæ ˆ ï¼Œå¦‚æœæ ˆé¡¶valueä¸º0åˆ™è·³è½¬åˆ°(byte1&lt;&lt;8)|byte2 byte1å·¦ç§»8ä½ï¼Œå†å’Œbyte2å–æˆ–<br>æ‰§è¡Œå‰ï¼Œæ ˆï¼šâ€¦,value<br>æ‰§è¡Œåï¼Œæ ˆï¼šâ€¦<h2 id="æ–¹æ³•è°ƒç”¨"><a href="#æ–¹æ³•è°ƒç”¨" class="headerlink" title="æ–¹æ³•è°ƒç”¨"></a>æ–¹æ³•è°ƒç”¨</h2>|-| -|<br>|-| -|<br>invokevirtual | æ™®é€šçš„å®ä¾‹çš„ç±»æ–¹æ³•è°ƒç”¨ï¼ˆåŠ¨æ€è°ƒç”¨ï¼Œè¿è¡Œçš„æ—¶å€™æ ¹æ®ç›®å‰çš„å®é™…ç±»å‹ï¼Œè·å–è°ƒç”¨çš„æ–¹æ³•ï¼‰ |<br>invokespecial | çˆ¶ç±»æ–¹æ³•è°ƒç”¨ï¼Œç¼–è¯‘çš„æ—¶å€™è¡¨åçš„ç±»å‹çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¤šæ€çš„ä½œç”¨ |<br>invokestatic | é™æ€æ–¹æ³•çš„è°ƒç”¨ |<br>invokeinterface | æ¥å£æ–¹æ³•çš„è°ƒç”¨ |<br>xreturn(xä¸º i l f d a æˆ–ä¸ºç©º) | xä¸ºè¿”å›å€¼ç±»å‹ï¼Œç©ºä½void |<h1 id="ä½¿ç”¨ASMç”ŸæˆJavaå­—èŠ‚ç "><a href="#ä½¿ç”¨ASMç”ŸæˆJavaå­—èŠ‚ç " class="headerlink" title="ä½¿ç”¨ASMç”ŸæˆJavaå­—èŠ‚ç "></a>ä½¿ç”¨ASMç”ŸæˆJavaå­—èŠ‚ç </h1></li><li>Javaå­—èŠ‚ç æ“ä½œæ¡†æ¶</li><li>å¯ä»¥ç”¨äºä¿®æ”¹ç°æœ‰ç±»æˆ–è€…åŠ¨æ€äº§ç”Ÿæ–°ç±»(ä»æ— åˆ°æœ‰)</li><li>ç”¨æˆ·ï¼ˆéƒ½ç”¨åˆ°äº†ASMæŠ€æœ¯ï¼‰<br>AspectJ<br>Clojure<br>Ecplise<br>spring<br>cglib(hibernate)</li></ul><p>ASMé€šè¿‡è®¿é—®è€…æ¨¡å¼è®¿é—®classæ–‡ä»¶ï¼Œæœ€ç»ˆç”Ÿæˆclassæ–‡ä»¶ï¼Œç”Ÿäº§classæ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯ClassWriterè¿™ä¸ªç±»ï¼Œvisitè®¿é—®classæ–‡ä»¶</p><h2 id="ä¸¾ä¸ªğŸŒ°-2"><a href="#ä¸¾ä¸ªğŸŒ°-2" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>ä¸€ä¸ªclassä»æ— åˆ°æœ‰çš„è¿‡ç¨‹<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”Ÿæˆä¸€ä¸ªClassWeiterï¼Œå†™classæ–‡ä»¶çš„å¯¹è±¡</span></span><br><span class="line">ClassWriter cw = <span class="keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS|ClassWriter.COMPUTE_FRAMES);  </span><br><span class="line"><span class="comment">//è®©ClassWriterè®¿é—®ä¸€ä¸ªç±»ï¼Œç”Ÿæˆç±»çš„åå­—çš„Exampleï¼Œè®¿é—®æƒé™publicï¼Œçˆ¶ç±»æ˜¯Object</span></span><br><span class="line">cw.visit(V1_7, ACC_PUBLIC, <span class="string">"Example"</span>, <span class="literal">null</span>, <span class="string">"java/lang/Object"</span>, <span class="literal">null</span>); </span><br><span class="line"><span class="comment">//visitMEthodåŠ¨æ€äº§ç”Ÿä¸€ä¸ªinitæ–¹æ³•ï¼Œæƒé™publicï¼Œå³æ„é€ æ–¹æ³•ï¼Œå‚æ•°è¿”å›å€¼éƒ½æ˜¯ç©ºçš„</span></span><br><span class="line">MethodVisitor mw = cw.visitMethod(ACC_PUBLIC, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>, <span class="literal">null</span>,  <span class="literal">null</span>);  </span><br><span class="line"><span class="comment">//this å…¥æ ˆ</span></span><br><span class="line">mw.visitVarInsn(ALOAD, <span class="number">0</span>);  </span><br><span class="line"><span class="comment">//è°ƒç”¨ç»™å®šå¯¹è±¡çš„æ–¹æ³•ï¼Œé™æ€ç»‘å®šï¼Œä¹Ÿå°±æ˜¯è®¿é—®äº†çˆ¶ç±»objectçš„initå‡½æ•°</span></span><br><span class="line">mw.visitMethodInsn(INVOKESPECIAL, <span class="string">"java/lang/Object"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);  </span><br><span class="line"><span class="comment">//return æ²¡æœ‰è¿”å›å€¼</span></span><br><span class="line">mw.visitInsn(RETURN);  </span><br><span class="line"><span class="comment">//å¯¹è®¿é—®çš„å¸§æ ˆå’Œå±€éƒ¨å˜é‡è¡¨åšä¸€ä¸ªè‡ªåŠ¨çš„è®¡ç®—</span></span><br><span class="line">mw.visitMaxs(<span class="number">0</span>, <span class="number">0</span>);  </span><br><span class="line"><span class="comment">//è®¿é—®ç»“æŸ</span></span><br><span class="line">mw.visitEnd();  </span><br><span class="line"><span class="comment">//è®¿é—®mainæ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°æ˜¯Stringæ•°ç»„ï¼Œ[è¡¨ç¤ºæ•°ç»„Lè¡¨ç¤ºå¯¹è±¡ è¿”å›å€¼void</span></span><br><span class="line">mw = cw.visitMethod(ACC_PUBLIC + ACC_STATIC, <span class="string">"main"</span>,  <span class="string">"([Ljava/lang/String;)V"</span>, <span class="literal">null</span>, <span class="literal">null</span>);  </span><br><span class="line"><span class="comment">//å¾—åˆ°åä¸ºjava.lang.systemçš„staticå±æ€§ï¼Œè¿™ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ªç±»å‹ä¸ºjava.io.pritStreamçš„out</span></span><br><span class="line">mw.visitFieldInsn(GETSTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"out"</span>,  <span class="string">"Ljava/io/PrintStream;"</span>);  </span><br><span class="line"><span class="comment">//å‹æ ˆLdcå°†å¸¸é‡æ± ä¸­çš„å¸¸é‡å‹å…¥å †æ ˆ</span></span><br><span class="line">mw.visitLdcInsn(<span class="string">"Hello world!"</span>);  </span><br><span class="line"><span class="comment">//è°ƒç”¨å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ï¼Œå°†å‰é¢GWTSTATICæ‹¿åˆ°çš„å€¼å‹å…¥å †æ ˆï¼Œå°†helloworldå‹å…¥å †æ ˆï¼Œæ‰€ä»¥</span></span><br><span class="line"><span class="comment">//å †æ ˆçš„å‰ä¸¤ä½å°±æ˜¯system.outå¯¹è±¡çš„å¼•ç”¨å’Œprintlnæ–¹æ³•çš„å‚æ•°â€Hello Worldâ€œï¼Œ</span></span><br><span class="line"><span class="comment">//INVOKEVOTUALå°±å°†å‹å…¥å †æ ˆçš„system.out çš„prontlnè°ƒç”¨äº†ä¸€æ¬¡ï¼Œå¹¶ä¼ å…¥äº†ä¸€ä¸ªå‚æ•°â€Hello Worldâ€œ</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥å®Œæˆäº†ä¸€ä¸ªsystem.println HelloWorldçš„æ“ä½œ</span></span><br><span class="line">mw.visitMethodInsn(INVOKEVIRTUAL, <span class="string">"java/io/PrintStream"</span>, <span class="string">"println"</span>,  <span class="string">"(Ljava/lang/String;)V"</span>);  </span><br><span class="line"><span class="comment">//return  void</span></span><br><span class="line">mw.visitInsn(RETURN);  </span><br><span class="line"><span class="comment">//è‡ªåŠ¨ç”Ÿæˆå¸§æ ˆå±€éƒ¨å˜é‡çš„å¤§å°</span></span><br><span class="line">mw.visitMaxs(<span class="number">0</span>,<span class="number">0</span>);  </span><br><span class="line"><span class="comment">//ç»“æŸ</span></span><br><span class="line">mw.visitEnd();  </span><br><span class="line"><span class="comment">//å°†æ•´ä¸ªç±»å˜æˆä¸€ä¸ªbyteæ•°ç»„</span></span><br><span class="line">byte[] code = cw.toByteArray();  </span><br><span class="line"></span><br><span class="line">AsmHelloWorld loader = <span class="keyword">new</span> AsmHelloWorld();  </span><br><span class="line"><span class="comment">//é€šè¿‡classloaderå®šä¹‰ä¸€ä¸ªç±»ï¼Œå°†åˆšåˆšçš„byteæ•°ç»„ä¼ å…¥ï¼Œé€šè¿‡defineClassç”Ÿæˆç±»</span></span><br><span class="line">Class exampleClass = loader  </span><br><span class="line">    .defineClass(<span class="string">"Example"</span>, code, <span class="number">0</span>, code.length);  </span><br><span class="line"> <span class="comment">//é€šè¿‡åå°„æ‰§è¡Œåˆšåˆšç”Ÿæˆçš„mainæ–¹æ³•</span></span><br><span class="line">exampleClass.getMethods()[<span class="number">0</span>].invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="built_in">Object</span>[] &#123; <span class="literal">null</span> &#125;);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello world!</span><br></pre></td></tr></table></figure><h2 id="æ¨¡æ‹Ÿå®ç°AOPå­—èŠ‚ç ç»‡å…¥"><a href="#æ¨¡æ‹Ÿå®ç°AOPå­—èŠ‚ç ç»‡å…¥" class="headerlink" title="æ¨¡æ‹Ÿå®ç°AOPå­—èŠ‚ç ç»‡å…¥"></a>æ¨¡æ‹Ÿå®ç°AOPå­—èŠ‚ç ç»‡å…¥</h2><p>åœ¨å‡½æ•°å¼€å§‹éƒ¨åˆ†æˆ–è€…ç»“æŸéƒ¨åˆ†åµŒå…¥å­—èŠ‚ç <br>å¯ç”¨äºè¿›è¡Œé‰´æƒï¼ˆæŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼‰ã€æ—¥å¿—ï¼ˆæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™è®°å½•ä¸€äº›é¢å¤–çš„æ—¥å¿—ï¼‰ç­‰</p><h3 id="ä¸¾ä¸ªğŸŒ°-3"><a href="#ä¸¾ä¸ªğŸŒ°-3" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123; </span><br><span class="line"> public <span class="keyword">void</span> operation() &#123; </span><br><span class="line"> System.out.println(<span class="string">"operation...."</span>); </span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ“ä½œå‰åŠ ä¸Šé‰´æƒæˆ–è€…æ—¥å¿—<br>æˆ‘ä»¬è¦åµŒå…¥çš„å†…å®¹<br>å®‰å…¨æ£€æŸ¥ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SecurityChecker</span> </span>&#123; </span><br><span class="line"> public <span class="keyword">static</span> boolean checkSecurity() &#123; </span><br><span class="line"> System.out.println(<span class="string">"SecurityChecker.checkSecurity ..."</span>);</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç»§æ‰¿ä¸€ä¸ªClassVisitorï¼Œè¡¨ç¤ºå¯¹ç±»è¿›è¡Œä¸€äº›è®¿é—®</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddSecurityCheckClassAdapter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line"><span class="comment">//ç»™classåŠ ä¸ŠSecurityCheckerç±»çš„checkSecurityåŠŸèƒ½</span></span><br><span class="line">    public AddSecurityCheckClassAdapter( ClassVisitor cv) &#123;</span><br><span class="line"><span class="keyword">super</span>(Opcodes.ASM5, cv);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// é‡å†™ visitMethodï¼Œè®¿é—®åˆ° "operation" æ–¹æ³•æ—¶ï¼Œ</span></span><br><span class="line">    <span class="comment">// ç»™å‡ºè‡ªå®šä¹‰ MethodVisitorï¼Œå®é™…æ”¹å†™æ–¹æ³•å†…å®¹</span></span><br><span class="line">    <span class="comment">//nameæ˜¯methodçš„åå­—</span></span><br><span class="line">    public MethodVisitor visitMethod(final int access, final <span class="built_in">String</span> name, </span><br><span class="line">        final <span class="built_in">String</span> desc, final <span class="built_in">String</span> signature, final <span class="built_in">String</span>[] exceptions) &#123; </span><br><span class="line">        MethodVisitor mv = cv.visitMethod(access, name, desc, signature,exceptions);</span><br><span class="line">        MethodVisitor wrappedMv = mv; </span><br><span class="line">        <span class="keyword">if</span> (mv != <span class="literal">null</span>) &#123; </span><br><span class="line">            <span class="comment">// å¯¹äº "operation" æ–¹æ³•ï¼Œå½“nameå«åšoprationçš„æ—¶å€™</span></span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">"operation"</span>)) &#123; </span><br><span class="line">                <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰ MethodVisitorï¼Œå®é™…æ”¹å†™æ–¹æ³•å†…å®¹</span></span><br><span class="line">                wrappedMv = <span class="keyword">new</span> AddSecurityCheckMethodAdapter(mv); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> wrappedMv; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AddSecurityCheckMethodAdapter<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MethodVIsitorä¸“é—¨ç”¨æ¥è®¿é—®æ–¹æ³•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddSecurityCheckMethodAdapter</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123; </span><br><span class="line"> public AddSecurityCheckMethodAdapter(MethodVisitor mv) &#123; </span><br><span class="line"> <span class="keyword">super</span>(Opcodes.ASM5,mv); </span><br><span class="line"> &#125; </span><br><span class="line"> public <span class="keyword">void</span> visitCode() &#123; </span><br><span class="line"> <span class="comment">//å…ˆæ‰§è¡Œgeym/jvm/ch10/asm/SecurityCheckerç©ºå‚çš„è¿”å›å€¼æ˜¯booleançš„checkSecurityæ–¹æ³•</span></span><br><span class="line"> visitMethodInsn(Opcodes.INVOKESTATIC, <span class="string">"geym/jvm/ch10/asm/SecurityChecker"</span>, </span><br><span class="line"><span class="string">"checkSecurity"</span>, <span class="string">"()Z"</span>); </span><br><span class="line"><span class="comment">//ç„¶åå†æ‰§è¡ŒçœŸæ­£çš„æ“ä½œï¼Œå³åœ¨classæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªAttributeæ˜¯code</span></span><br><span class="line"><span class="comment">//å³å°†åŸåŸæœ¬æœ¬çš„å…¶ä»–çš„ä¸€äº›å­—èŠ‚ç å†è¿è¡Œä¸€é</span></span><br><span class="line"> <span class="keyword">super</span>.visitCode();</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å°†å­—èŠ‚ç ç»‡å…¥<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123; </span><br><span class="line"> public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) throws Exception &#123; </span><br><span class="line"> <span class="comment">//é€šè¿‡ClassReaderå°†Accountç±»è¯»è¿›æ¥ï¼Œç”Ÿæˆä¸€ä¸ªClassReaderå®ä¾‹</span></span><br><span class="line"> ClassReader cr = <span class="keyword">new</span> ClassReader(<span class="string">"geym.jvm.ch10.asm.Account"</span>); </span><br><span class="line"> ClassWriter cw = <span class="keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS|ClassWriter.COMPUTE_FRAMES); </span><br><span class="line"> AddSecurityCheckClassAdapter classAdapter = <span class="keyword">new</span> AddSecurityCheckClassAdapter(cw); </span><br><span class="line"> <span class="comment">//cræ¥å—ä¸€ä¸ªè®¿é—®è€…classAdapterï¼Œå³AddSecurityCheckClassAdapter</span></span><br><span class="line"> <span class="comment">//ç”±classReaderä½œä¸ºä¸€ä¸ªå¼•å¯¼å¯¹è¿™ä¸ªclassæ–‡ä»¶åšä¸€ä¸ªè®¿é—®</span></span><br><span class="line"> <span class="comment">//åœ¨è®¿é—®çš„è¿‡ç¨‹ä¸­å°±ä¼šåšä¸€äº›è‡ªå·±å—çš„ç»‡å…¥</span></span><br><span class="line"> cr.accept(classAdapter, ClassReader.SKIP_DEBUG); </span><br><span class="line"> <span class="comment">//å°†ä¿®æ”¹è¿‡çš„å­—èŠ‚ç åšä¸€ä¸ªè¾“å‡º</span></span><br><span class="line"> byte[] data = cw.toByteArray(); </span><br><span class="line"> File file = <span class="keyword">new</span> File(<span class="string">"bin/geym/jvm/ch10/asm/Account.class"</span>); </span><br><span class="line"> FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(file); </span><br><span class="line"> <span class="comment">//é€šè¿‡dataå³cw.toByteArrayè¦†ç›–åŸæ¥çš„Accountæ–‡ä»¶</span></span><br><span class="line"> fout.write(data); </span><br><span class="line"> fout.close(); </span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨operationæ‰§è¡Œä¹‹å‰ä¼šå…ˆæ‰§è¡ŒcheckSecurity</span></span><br><span class="line">SecurityChecker.checkSecurity ...</span><br><span class="line">operation....</span><br></pre></td></tr></table></figure><h1 id="JITåŠå…¶ç›¸å…³å‚æ•°"><a href="#JITåŠå…¶ç›¸å…³å‚æ•°" class="headerlink" title="JITåŠå…¶ç›¸å…³å‚æ•°"></a>JITåŠå…¶ç›¸å…³å‚æ•°</h1><ul><li>å­—èŠ‚ç æ‰§è¡Œæ€§èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥å¯ä»¥å¯¹äºçƒ­ç‚¹ä»£ç ç¼–è¯‘æˆæœºå™¨ç å†æ‰§è¡Œï¼Œåœ¨è¿è¡Œæ—¶çš„ç¼–è¯‘ï¼Œ<br>å«åšJIT Just-In-Time</li><li>JITçš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œå°†çƒ­ç‚¹ä»£ç ï¼Œå°±æ˜¯æ‰§è¡Œæ¯”è¾ƒé¢‘ç¹çš„ä»£ç ï¼Œç¼–è¯‘æˆæœºå™¨ç ï¼Œå½“å†æ¬¡æ‰§è¡Œçš„æ—¶å€™å°±ä¸åšè§£é‡Šæ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œæœºå™¨ç ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190305074044370.png"><br>å³ä½¿æ˜¯åœ¨å¾ªç¯ä½“ä¸­è¢«å¤šæ¬¡è°ƒç”¨ä¹Ÿä¼šè¢«è®¤ä¸ºçƒ­ç‚¹ä»£ç ï¼Œå¯èƒ½æ–¹æ³•è¢«å³æ—¶è°ƒç”¨å¹¶æ²¡æœ‰è¿”å›ï¼Œè¿™ç§æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿä¿ƒè¿›è¢«ç¼–è¯‘å®Œçš„ä»£ç çš„ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšâ€æ ˆä¸Šæ›¿æ¢â€œï¼Œåœ¨æ–¹æ³•çš„æ‰§è¡Œæ ˆä¸Šç›´æ¥æ›¿æ¢æˆæœºå™¨ç <br>CompileThreadshld è®¾ç½®é˜ˆå€¼ï¼Œæ–¹æ³•è¢«è°ƒç”¨å¤šå°‘æ¬¡ä¹‹åå°†å…¶è®¾ç½®æˆæœºå™¨ç <br>PrintCompilatoin æ‰“å‡ºJITçš„ä¸€äº›ç¼–è¯‘çš„ä¿¡æ¯ï¼Œå“ªäº›æ–¹æ³•å·²ç»å®Œæˆäº†ç¼–è¯‘<h2 id="ä¸¾ä¸ªğŸŒ°-4"><a href="#ä¸¾ä¸ªğŸŒ°-4" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JITTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> met()&#123;</span><br><span class="line">        int a=<span class="number">0</span>,b=<span class="number">0</span>;</span><br><span class="line">        b=a+b;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">        <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">            met();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:CompileThreshold=<span class="number">1000</span></span><br><span class="line">-XX:+PrintCompilation</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰€æœ‰è¢«ç¼–è¯‘çš„æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªè¾“å‡º</span></span><br><span class="line"><span class="number">56</span>    <span class="number">1</span>             java.lang.String::hashCode (<span class="number">55</span> bytes)</span><br><span class="line"><span class="number">56</span>    <span class="number">2</span>             java.lang.String::equals (<span class="number">81</span> bytes)</span><br><span class="line"><span class="number">57</span>    <span class="number">3</span>             java.lang.String::indexOf (<span class="number">70</span> bytes)</span><br><span class="line"><span class="number">60</span>    <span class="number">4</span>             java.lang.String::charAt (<span class="number">29</span> bytes)</span><br><span class="line"><span class="number">61</span>    <span class="number">5</span>             java.lang.String::length (<span class="number">6</span> bytes)</span><br><span class="line"><span class="number">61</span>    <span class="number">6</span>             java.lang.String::lastIndexOf (<span class="number">52</span> bytes)</span><br><span class="line"><span class="number">61</span>    <span class="number">7</span>             java.lang.String::toLowerCase (<span class="number">472</span> bytes)</span><br><span class="line"><span class="number">67</span>    <span class="number">8</span>             geym.jvm.ch2.jit.JITTest::met (<span class="number">9</span> bytes)</span><br></pre></td></tr></table></figure><p></p><h2 id="JITç›¸å…³å‚æ•°"><a href="#JITç›¸å…³å‚æ•°" class="headerlink" title="JITç›¸å…³å‚æ•°"></a>JITç›¸å…³å‚æ•°</h2><p>é»˜è®¤æ˜¯è§£é‡Šå’Œç¼–è¯‘æ··åˆçš„ï¼Œä½•æ—¶è§£é‡Šå’Œç¼–è¯‘ï¼Œå–å†³äºè¢«è°ƒç”¨çš„æ¬¡æ•°å’Œçƒ­ç‚¹ä»£ç çš„åˆ†å¸ƒæƒ…å†µ</p><p>ç¼–è¯‘å™¨æ˜¯æŠŠæºç¨‹åºçš„æ¯ä¸€æ¡è¯­å¥éƒ½ç¼–è¯‘æˆæœºå™¨è¯­è¨€,å¹¶ä¿å­˜æˆäºŒè¿›åˆ¶æ–‡ä»¶,è¿™æ ·è¿è¡Œæ—¶è®¡ç®—æœºå¯ä»¥ç›´æ¥ä»¥æœºå™¨è¯­è¨€æ¥è¿è¡Œæ­¤ç¨‹åº,é€Ÿåº¦å¾ˆå¿«;</p><p>è€Œè§£é‡Šå™¨åˆ™æ˜¯åªåœ¨æ‰§è¡Œç¨‹åºæ—¶,æ‰ä¸€æ¡ä¸€æ¡çš„è§£é‡Šæˆæœºå™¨è¯­è¨€ç»™è®¡ç®—æœºæ¥æ‰§è¡Œ,æ‰€ä»¥è¿è¡Œé€Ÿåº¦æ˜¯ä¸å¦‚ç¼–è¯‘åçš„ç¨‹åºè¿è¡Œçš„å¿«çš„.</p><p>è¿™æ˜¯å› ä¸ºè®¡ç®—æœºä¸èƒ½ç›´æ¥è®¤è¯†å¹¶æ‰§è¡Œæˆ‘ä»¬å†™çš„è¯­å¥,å®ƒåªèƒ½è®¤è¯†æœºå™¨è¯­è¨€(æ˜¯äºŒè¿›åˆ¶çš„å½¢å¼)</p><ul><li>-Xint<br>è§£é‡Šæ‰§è¡Œ<br>æ‰§è¡Œæ€§èƒ½æ¯”è¾ƒå·®</li><li>-Xcomp<br>å…¨éƒ¨ç¼–è¯‘æ‰§è¡Œ<br>å¯åŠ¨åˆæœŸï¼Œæ‰€æœ‰çš„æ–¹æ³•éƒ½è¿˜æ²¡æœ‰è¢«ç¼–è¯‘å®Œä¹‹å‰ï¼Œè¿™æ—¶å€™çš„ç¼–è¯‘é‡æ˜¯éå¸¸å·¨å¤§çš„ï¼Œè¿™ä¸ªæ—¶å€™çš„æ€§èƒ½æ¯”è¾ƒå·®ï¼Œå¯æ˜¯å…¨éƒ¨ç¼–è¯‘å®Œæˆä¹‹åï¼Œä¼šæ¯”è§£é‡Šæ‰§è¡Œå¿«å¾ˆå¤šã€‚</li><li>-Xmixed<br>é»˜è®¤ï¼Œæ··åˆ</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;javap&quot;&gt;&lt;a href=&quot;#javap&quot; class=&quot;headerlink&quot; title=&quot;javap&quot;&gt;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆåï¼‰ï¼šClassæ–‡ä»¶ç»“æ„</title>
    <link href="http://mmmmmm.me/2019-03-04-1.html"/>
    <id>http://mmmmmm.me/2019-03-04-1.html</id>
    <published>2019-03-04T02:21:02.000Z</published>
    <updated>2019-03-04T08:08:33.378Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="è¯­è¨€æ— å…³æ€§"><a href="#è¯­è¨€æ— å…³æ€§" class="headerlink" title="è¯­è¨€æ— å…³æ€§"></a>è¯­è¨€æ— å…³æ€§</h1><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160708704.png"><br>.classæ–‡ä»¶èƒ½å¤Ÿåœ¨JVMä¸Šè¿è¡Œï¼Œä¸Šå›¾å¯ä»¥çœ‹å‡ºè®¸å¤šè¯­è¨€rbã€groovyç­‰éƒ½èƒ½ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œæ‰€ä»¥javaå’ŒJVMæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ã€‚<br>åŒæ ·èƒ½å¾—å‡ºç»“è®ºï¼šclassæ–‡ä»¶æ˜¯JVMçš„åŸºçŸ³</p><h1 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h1><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td>u4</td><td>magic</td><td>1</td><td>é­”æ•°ï¼Œä¹Ÿå«magic numberï¼Œæ•°å­—è¡¨ç¤ºæ˜¯å¦æ˜¯ä¸€ä¸ªjavaæ–‡ä»¶</td></tr><tr><td>u2</td><td>minor_version</td><td>1</td><td>å°ç‰ˆæœ¬</td></tr><tr><td>u2</td><td>major_version</td><td>1</td><td>å¤§ç‰ˆæœ¬</td></tr><tr><td>u2</td><td>constant_pool_count</td><td>1</td><td>å¸¸é‡æ± æ•°é‡çš„å±æ€§</td></tr><tr><td>cp_info</td><td>constant_pool</td><td>constant_pool_count - 1</td><td>å¸¸é‡æ± çš„å†…å®¹ï¼Œå°±æ˜¯å¸¸é‡æ± çš„ä¸ªæ•°å‡ä¸€</td></tr><tr><td>u2</td><td>access_flags</td><td>1</td><td>è®¿é—®ä¿®é¥°ç¬¦ public privateç­‰</td></tr><tr><td>u2</td><td>this_class</td><td>1</td><td>å½“å‰ç±»</td></tr><tr><td>u2</td><td>super_class</td><td>1</td><td>è¶…ç±»ï¼Œå•ç»§æ‰¿</td></tr><tr><td>u2</td><td>interfaces_count</td><td>1</td><td>æ¥å£æ•°é‡çš„å±æ€§</td></tr><tr><td>u2</td><td>interfaces</td><td>interfaces_count</td><td>æ¥å£</td></tr><tr><td>u2</td><td>fields_count</td><td>1</td><td>å­—æ®µæ•°é‡çš„å±æ€§</td></tr><tr><td>field_info</td><td>fields</td><td>fields_count</td><td>å­—æ®µ</td></tr><tr><td>u2</td><td>methods_count</td><td>1</td><td>æ–¹æ³•æ•°é‡çš„å±æ€§</td></tr><tr><td>method_info</td><td>methods</td><td>methods_count</td><td>æ–¹æ³•çš„ä¿¡æ¯</td></tr><tr><td>u2</td><td>attribute_count</td><td>1</td><td>å±æ€§æ•°é‡çš„å±æ€§</td></tr><tr><td>attribute_info</td><td>attributes</td><td>attributes_count</td><td>å±æ€§çš„ä¿¡æ¯</td></tr></tbody></table><p>u1 u2 u3 u4è¡¨ç¤ºæ— ç¬¦å·çš„æ•´æ•°ï¼Œu1è¡¨ç¤º1ä¸ªbyteçš„æ•´æ•°ï¼Œu2è¡¨ç¤º2ä¸ªbyteçš„æ•´æ•°ï¼Œæ•°å­—è¡¨ç¤ºæ•´æ•°çš„é•¿åº¦ã€‚</p><h2 id="é­”æ•°"><a href="#é­”æ•°" class="headerlink" title="é­”æ•°"></a>é­”æ•°</h2><p>magic u4</p><ul><li><p>0xCAFEBABE</p><p>4ä¸ªbyteçš„ä¸€ä¸ªæ•°å­—ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰æ–‡ä»¶æ˜¯ä¸€ä¸ªclassæ–‡ä»¶</p></li></ul><h2 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h2><p>minor_version u2<br>major_version u2<br>å½“è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ç”¨ä»€ä¹ˆç‰ˆæœ¬çš„javacç¼–è¯‘å‡ºæ¥çš„classæ–‡ä»¶<br>-targetç›®æ ‡ç‰ˆæœ¬æ˜¯å¤šå°‘</p><p>JDK ç¼–è¯‘å™¨ç‰ˆæœ¬| target å‚æ•° |å…­è¿›åˆ¶ minor.major |åè¿›åˆ¶major.minor<br>|â€“|â€“|â€“|â€“|<br>jdk1.1.8| ä¸èƒ½å¸¦ target å‚æ•° |00 03 00 2D |45.3<br>jdk1.2.2| ä¸å¸¦(é»˜è®¤ä¸º -target 1.1) | 00 03 00 2D |45.3<br>jdk1.2.2| -target 1.2 | 00 00 00 2E | 46.0<br>jdk1.3.1_19| ä¸å¸¦(é»˜è®¤ä¸º -target 1.1) | 00 03 00 2D | 45.3<br>jdk1.3.1_19| -target 1.3 | 00 00 00 2F | 47.0<br>j2sdk1.4.2_| ä¸å¸¦(é»˜è®¤ä¸º -target 1.2) | 00 00 00 2E |46.0<br>j2sdk1.4.2_| -target 1.4 | 00 00 00 30 | 48.0<br>jdk1.5.0_11| ä¸å¸¦(é»˜è®¤ä¸º -target 1.5) | 00 00 00 31 | 49.0<br>jdk1.5.0_11| -target 1.4 -source 1.4| 00 00 00 30| 48.0<br>jdk1.6.0_01| ä¸å¸¦(é»˜è®¤ä¸º -target 1.6) | 00 00 00 32 | 50.0<br>jdk1.6.0_01| -target 1.5 | 00 00 00 31| 49.0<br>jdk1.6.0_01| -target 1.4 -source 1.4| 00 00 00 30| 48.0<br>jdk1.7.0| ä¸å¸¦(é»˜è®¤ä¸º -target 1.6) | 00 00 00 32 |50.0<br>jdk1.7.0| -target 1.7 | 00 00 00 33 | 51.0<br>jdk1.7.0| -target 1.4 -source 1.4 | 00 00 00 30 | 48.0</p><h2 id="å¸¸é‡æ± "><a href="#å¸¸é‡æ± " class="headerlink" title="å¸¸é‡æ± "></a>å¸¸é‡æ± </h2><p><strong><font color="red">åŸºæœ¬ä¸Šæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯å­˜åœ¨è¿™é‡Œï¼Œåé¢çš„ç±»åæ–¹æ³•åç­‰éƒ½æ˜¯é€šè¿‡ç´¢å¼•çš„æ–¹å¼æŒ‡å‘è¿™é‡Œï¼Œä¸€åˆ‡æ•°æ®çš„åŸºçŸ³ã€‚</font></strong></p><ul><li>constant_pool_count u2</li><li><p>constant_pool cp_info</p><p>|-|-|-|<br>|â€“|â€“|â€“|<br>CONSTANT_Utf8 |1|UTF-8ç¼–ç çš„Unicodeå­—ç¬¦ä¸²<br>CONSTANT_Integer |3| intç±»å‹çš„å­—é¢å€¼<br>CONSTANT_Float |4|floatç±»å‹çš„å­—é¢å€¼<br>CONSTANT_Long |5|longç±»å‹çš„å­—é¢å€¼<br>CONSTANT_Double |6|doubleç±»å‹çš„å­—é¢å€¼<br>CONSTANT_Class |7|å¯¹ä¸€ä¸ªç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨<br>CONSTANT_String |8|Stringç±»å‹å­—é¢å€¼çš„å¼•ç”¨<br>CONSTANT_Fieldref |9| å¯¹ä¸€ä¸ªå­—æ®µçš„ç¬¦å·å¼•ç”¨<br>CONSTANT_Methodref |10|å¯¹ä¸€ä¸ªç±»ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨<br>CONSTANT_InterfaceMethodref |11| å¯¹ä¸€ä¸ªæ¥å£ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨<br>CONSTANT_NameAndType |12| å¯¹ä¸€ä¸ªå­—æ®µæˆ–æ–¹æ³•çš„éƒ¨åˆ†ç¬¦å·å¼•ç”¨</p><h3 id="CONSTANT-Utf8"><a href="#CONSTANT-Utf8" class="headerlink" title="CONSTANT_Utf8"></a>CONSTANT_Utf8</h3></li><li>tag 1 (å¸¸é‡æ ‡è¯†ç¬¦ 1ä»£è¡¨UTF-8)</li><li>length u2 ï¼ˆUFT-8è¿™ä¸ªå­—ç¬¦ä¸²byteæ•°ç»„çš„é•¿åº¦ï¼‰</li><li>bytes[length]ï¼ˆUTF-8çš„å®é™…çš„å†…å®¹ï¼‰<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/20190304071517995.png"><br>ä¸‰ä¸ªUTF-8ç±»å‹çš„å¸¸é‡ï¼šå…ˆæ˜¾ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œ()I è¡¨ç¤ºç©ºå‚è¿”å›å€¼æ˜¯intçš„æ•°ï¼Œ()Ljava/lang/Objectè¡¨ç¤ºç©ºå‚è¿”å›å€¼æ˜¯Objectï¼ŒcompareToè¡¨ç¤ºæ–¹æ³•çš„åç§°<h3 id="CONSTANT-Integer"><a href="#CONSTANT-Integer" class="headerlink" title="CONSTANT_Integer"></a>CONSTANT_Integer</h3><ul><li>tag 3</li><li>byte u4</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> final int sid=<span class="number">99</span>;</span><br></pre></td></tr></table></figure><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/20190304072028605.png"></p><h3 id="CONSTANT-String"><a href="#CONSTANT-String" class="headerlink" title="CONSTANT_String"></a>CONSTANT_String</h3><ul><li>tag 8</li><li>string_index u2 (æŒ‡å‘utf8çš„ç´¢å¼•)<br>å†…éƒ¨ä¸ç›´æ¥å­˜å‚¨å†…å®¹è€Œæ˜¯æŒ‡å‘UFT-8ï¼Œå®é™…çš„å†…å®¹ä¿å­˜åœ¨UTF-8ä¸­</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> final <span class="built_in">String</span> sname=<span class="string">"geym"</span>;</span><br></pre></td></tr></table></figure><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304072138569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"></p><h3 id="CONSTANT-NameAndType"><a href="#CONSTANT-NameAndType" class="headerlink" title="CONSTANT_NameAndType"></a>CONSTANT_NameAndType</h3><ul><li>tag 12</li><li>name_index u2 (åå­—ï¼ŒæŒ‡å‘utf8)</li><li>descriptor_index u2 (æè¿°ç¬¦ç±»å‹ï¼ŒæŒ‡å‘utf8)<br>åå­—å’Œç±»å‹éƒ½æ˜¯æŒ‡å‘UTF-8æè¿°çš„ï¼Œæœ¬èº«æ˜¯æ²¡æœ‰å†…å®¹çš„</li></ul><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70.png"><br>ä¸Šå›¾è¡¨ç¤ºäº†åå­—ä¸ºinitï¼Œç©ºå‚ï¼Œè¿”å›å€¼ä¸ºvoidçš„æ–¹æ³•ï¼Œå³é»˜è®¤çš„æ„é€ å‡½æ•°çš„è¡¨ç¤ºã€‚</p><h3 id="CONSTANT-Class"><a href="#CONSTANT-Class" class="headerlink" title="CONSTANT_Class"></a>CONSTANT_Class</h3><ul><li>tag 7</li><li>name_index u2 (åå­—ï¼ŒæŒ‡å‘utf8)</li></ul><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160706491.png"></p><h3 id="CONSTANT-Fieldref-CONSTANT-Methodref-CONSTANT-InterfaceMethodref"><a href="#CONSTANT-Fieldref-CONSTANT-Methodref-CONSTANT-InterfaceMethodref" class="headerlink" title="CONSTANT_Fieldref ,CONSTANT_Methodref ,CONSTANT_InterfaceMethodref"></a>CONSTANT_Fieldref ,CONSTANT_Methodref ,CONSTANT_InterfaceMethodref</h3><p>å­—æ®µã€æ–¹æ³•ã€æ¥å£æ–¹æ³•</p><ul><li>tag 9 ,10, 11</li><li>class_index u2 (æŒ‡å‘CONSTANT_Class)å±äºå“ªä¸ªç±»</li><li>name_and_type_index u2 (æŒ‡å‘CONSTANT_NameAndType)æœ¬èº«çš„åå­—å’Œç±»å‹</li></ul><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160706283.png"><br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304073503808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"></p><h2 id="è®¿é—®æ ‡è¯†ç¬¦"><a href="#è®¿é—®æ ‡è¯†ç¬¦" class="headerlink" title="è®¿é—®æ ‡è¯†ç¬¦"></a>è®¿é—®æ ‡è¯†ç¬¦</h2><p>access flag u2ï¼šç±»çš„æ ‡ç¤ºç¬¦<br>æ ¹æ®valueçš„å€¼åšåŒºåˆ†</p><p>Flag Name |Value |Interpretation<br>|-|-|-|<br>ACC_PUBLIC |0x0001 |public<br>ACC_FINAL |0x0010 |final,ä¸èƒ½è¢«ç»§æ‰¿.<br>ACC_SUPER |0x0020 |æ˜¯å¦å…è®¸ä½¿ç”¨invokespecialæŒ‡ä»¤ï¼ŒJDK1.2åï¼Œè¯¥å€¼ä¸ºtrue<br>ACC_INTERFACE |0x0200 |æ˜¯å¦æ˜¯æ¥å£<br>ACC_ABSTRACT |0x0400 |æŠ½è±¡ç±»<br>ACC_SYNTHETIC |0x1000 |è¯¥ç±»ä¸æ˜¯ç”±ç”¨æˆ·ä»£ç ç”Ÿæˆ,è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œæ²¡æœ‰æºç <br>ACC_ANNOTATION |0x2000 |æ˜¯å¦ä¸ºæ³¨è§£<br>ACC_ENUM |0x4000 |æ˜¯å¦æ˜¯æšä¸¾</p><h2 id="ç±»ã€è¶…ç±»ã€æ¥å£"><a href="#ç±»ã€è¶…ç±»ã€æ¥å£" class="headerlink" title="ç±»ã€è¶…ç±»ã€æ¥å£"></a>ç±»ã€è¶…ç±»ã€æ¥å£</h2><ul><li>this_class u2<br>æŒ‡å‘å¸¸é‡æ± çš„Class</li><li>super_class u2<br>æŒ‡å‘å¸¸é‡æ± çš„Class</li><li>interface_count u2<br>æ¥å£æ•°é‡</li><li>interfaces<br>interface_count ä¸ª interface u2<br>æ¯ä¸ªinterfaceæ˜¯æŒ‡å‘CONSTANT_Classçš„ç´¢å¼•<h2 id="å­—æ®µ"><a href="#å­—æ®µ" class="headerlink" title="å­—æ®µ"></a>å­—æ®µ</h2></li><li>field_count<br>å­—æ®µæ•°é‡</li><li>fields<br>field_countä¸ªfield_info</li><li>field<br>access_flags u2<br>name_index u2<br>descriptor_index u2<br>attributes_count u2<br>attribute_info attributes[attributes_count];<h3 id="access-flags"><a href="#access-flags" class="headerlink" title="access_flags"></a>access_flags</h3>Flag Name |Value |Interpretat<br>|â€“|â€“|â€“|<br>ACC_PUBLIC |0x0001 |public<br>ACC_PRIVATE |0x0002 |private<br>ACC_PROTECTED |0x0004 |protected<br>ACC_STATIC |0x0008 |static.<br>ACC_FINAL |0x0010 |final<br>ACC_VOLATILE |0x0040 |volatile<br>ACC_TRANSIENT |0x0080 |transient<br>ACC_SYNTHETIC |0x1000 |synthetic;<br>ACC_ENUM |0x4000 |æšä¸¾ç±»å‹<ul><li>name_index u2<br>å¸¸é‡æ± å¼•ç”¨ ï¼Œè¡¨ç¤ºå­—æ®µçš„åå­—</li></ul></li><li>descriptor_index<br>è¡¨ç¤ºå­—æ®µçš„ç±»å‹<br>ä¸ºäº†å°½é‡å°‘çš„å ç”¨ç©ºé—´ï¼Œç®€å•è¡¨ç¤º</li></ul><table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td></td><td>B</td><td>byte</td><td></td></tr><tr><td></td><td>C</td><td>char</td><td></td></tr><tr><td></td><td>D</td><td>double</td><td></td></tr><tr><td></td><td>F</td><td>float</td><td></td></tr><tr><td></td><td>I</td><td>int</td><td></td></tr><tr><td></td><td>J</td><td>long</td><td></td></tr><tr><td></td><td>S</td><td>short</td><td></td></tr><tr><td></td><td>Z</td><td>boolean</td><td></td></tr><tr><td></td><td>V</td><td>void</td><td></td></tr><tr><td></td><td>L</td><td>å¯¹è±¡Ljava/lang/Object;</td><td></td></tr><tr><td></td><td>[</td><td>æ•°ç»„ [[Ljava/lang/String; = String[][] äºŒç»´æ•°ç»„[[</td><td></td></tr></tbody></table><h3 id="å°é—®é¢˜"><a href="#å°é—®é¢˜" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h3><p>descriptor_indexçš„å­—ç¬¦ä¸²å­˜æ”¾ä½ç½®åœ¨å“ªé‡Œï¼Ÿ</p><h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><ul><li>methods_count<br>æ–¹æ³•æ•°é‡</li><li>methods<br>methods_countä¸ªmethod_info<h3 id="method-info"><a href="#method-info" class="headerlink" title="method_info"></a>method_info</h3>access_flags u2<br>name_index u2<br>descriptor_index u2<br>attributes_count u2<br>attribute_info attributes[attributes_count];<h4 id="access-flag"><a href="#access-flag" class="headerlink" title="access flag"></a>access flag</h4>|-|-|-|<br>|â€“|â€“|â€“|<br>Flag Name | Value |Interpretation<br>ACC_PUBLIC | 0x0001 |public<br>ACC_PRIVATE | 0x0002 |private<br>ACC_PROTECTED | 0x0004 |protected<br>ACC_STATIC | 0x0008 |static<br>ACC_FINAL | 0x0010 |final<br>ACC_SYNCHRONIZED| 0x0020 |synchronized<br>ACC_BRIDGE | 0x0040 |ç¼–è¯‘å™¨äº§ç”Ÿ æ¡¥æ¥æ–¹æ³•<br>ACC_VARARGS | 0x0080 |å¯å˜å‚æ•°<br>ACC_NATIVE | 0x0100 |native<br>ACC_ABSTRACT | 0x0400 |abstract<br>ACC_STRICT | 0x0800 |strictfp<br>ACC_SYNTHETIC | 0x1000 |ä¸åœ¨æºç ä¸­ï¼Œç”±ç¼–è¯‘å™¨äº§<h4 id="name-index-u2"><a href="#name-index-u2" class="headerlink" title="name_index u2"></a>name_index u2</h4>æ–¹æ³•åå­—ï¼Œå¸¸é‡æ± UTF-8ç´¢å¼•<h4 id="descriptor-index-u2"><a href="#descriptor-index-u2" class="headerlink" title="descriptor_index u2"></a>descriptor_index u2</h4>æè¿°ç¬¦ï¼Œç”¨äºè¡¨è¾¾æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼</li><li>æ–¹æ³•æè¿°ç¬¦<br>void inc() ()V<br>void setId(int) (I)V<br>int indexOf(char[],int ) ([CI)I<h2 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h2></li><li>åœ¨fieldå’Œmethodä¸­ï¼Œå¯ä»¥æœ‰è‹¥å¹²ä¸ªattributeï¼Œç±»æ–‡ä»¶ä¹Ÿæœ‰attributeï¼Œç”¨äºæè¿°ä¸€äº›é¢å¤–çš„ä¿¡æ¯<br>attribute_name_index u2<br>åå­—ï¼ŒæŒ‡å‘å¸¸é‡æ± UTF-8<br>attribute_length u4<br>é•¿åº¦<br>info[attribute_length] u1<br>å†…å®¹</li><li>attributeæœ¬èº«ä¹Ÿå¯ä»¥åŒ…å«å…¶ä»–attribute(å³å¯åµŒå¥—çš„)</li><li>éšç€JDKçš„å‘å±•ä¸æ–­æœ‰æ–°çš„attributeåŠ å…¥</li></ul><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡</th></tr></thead><tbody><tr><td></td></tr></tbody></table><p>u2 |methods_count | 1 |<br>method_info |methods | methods_count |<br>u2 |attribute_count | 1 |<br>attribute_info |attributes | attributes_count |</p><table><thead><tr><th>åç§°</th><th>ä½¿ç”¨è€…</th><th>æè¿°</th></tr></thead><tbody><tr><td>Deprecated</td><td>field method</td><td>å­—æ®µã€æ–¹æ³•ã€ç±»è¢«åºŸå¼ƒ</td></tr><tr><td>ConstantValue</td><td>field</td><td>finalå¸¸é‡</td></tr><tr><td>Code</td><td>method</td><td>æ–¹æ³•çš„å­—èŠ‚ç å’Œå…¶ä»–æ•°æ®</td></tr><tr><td>ptions</td><td>method</td><td>æ–¹æ³•çš„å¼‚å¸¸</td></tr><tr><td>LineNumberTable</td><td>Code_Attribute</td><td>æ–¹æ³•è¡Œå·å’Œå­—èŠ‚ç æ˜ å°„</td></tr><tr><td>LocalVaribleTable</td><td>Code_Attribute</td><td>æ–¹æ³•å±€éƒ¨å˜é‡è¡¨æè¿°</td></tr><tr><td>ceFile</td><td>Class file</td><td>æºæ–‡ä»¶å</td></tr><tr><td>hetic</td><td>field method</td><td>ç¼–è¯‘å™¨äº§ç”Ÿçš„æ–¹æ³•æˆ–å­—æ®µ</td></tr></tbody></table><p>LineNUmberTableå’ŒLocalVatibleTableæ˜¯Code_attributeçš„ï¼Œå³Attributeæ˜¯å¯ä»¥åµŒå¥—ä½¿ç”¨çš„</p><h3 id="Deprecated"><a href="#Deprecated" class="headerlink" title="Deprecated"></a>Deprecated</h3><p>attribute_name_index u2<br>attribute_length u4</p><ul><li>attribute_name_index<br>æŒ‡å‘åŒ…å«Deprecatedçš„UTF-8å¸¸é‡</li><li>attribute_length<br>ä¸º0<h3 id="ConstantantValue"><a href="#ConstantantValue" class="headerlink" title="ConstantantValue"></a>ConstantantValue</h3>attribute_name_index u2<br>attribute_length u4<br>constantvalue_index u2</li><li>attribute_name_index<br>åŒ…å«ConstantantValueå­—é¢é‡çš„UTF-8ç´¢å¼•</li><li>attribute_length<br>ä¸º2</li><li>constantvalue_index<br>å¸¸é‡å€¼ï¼ŒæŒ‡å‘å¸¸é‡æ± ï¼Œå¯ä»¥æ˜¯UTF-8ï¼ŒFloat, Double ç­‰</li></ul><p>public static final int sid=99;<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160706370.png"></p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;<span class="comment">//Code</span></span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 max_stack;</span><br><span class="line">    u2 max_locals;</span><br><span class="line">    u4 code_length;<span class="comment">//å­—èŠ‚ç é•¿åº¦</span></span><br><span class="line">    u1 code[code_length];<span class="comment">//å­—èŠ‚ç </span></span><br><span class="line">    u2 exception_table_length;<span class="comment">//å¼‚å¸¸è¡¨é•¿åº¦</span></span><br><span class="line">    &#123;   u2 start_pc;<span class="comment">//å¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®</span></span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;<span class="comment">//å¤„ç†è¿™ä¸ªå¼‚å¸¸çš„å­—èŠ‚ç ä½ç½®</span></span><br><span class="line">        <span class="comment">//å¦‚æœå‡ºç°å¼‚å¸¸å¤„ç†ä»£ç çš„æŒ‡é’ˆå°±ä¼šåç§»åˆ°è¿™é‡Œ</span></span><br><span class="line">        u2 catch_type;<span class="comment">//å¤„ç†çš„å¼‚å¸¸ç±»å‹ï¼ŒæŒ‡å‘Constant_Classçš„æŒ‡é’ˆ</span></span><br><span class="line">        <span class="comment">//æ˜¯ä»€ä¹ˆç±»å‹çš„å¼‚å¸¸</span></span><br><span class="line">    &#125; exception_table[exception_table_length];</span><br><span class="line">    u2 attributes_count;<span class="comment">//å±æ€§æ•°é‡</span></span><br><span class="line">    <span class="comment">//åœ¨codeåŸºç¡€ä¸Šå°è£…çš„å±æ€§ï¼Œæ¯”å¦‚LineNumberTable</span></span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LineNumberTable-Codeå±æ€§çš„å±æ€§-å­—èŠ‚ç çš„åç§»é‡å’Œå¯¹åº”çš„è¡Œå·"><a href="#LineNumberTable-Codeå±æ€§çš„å±æ€§-å­—èŠ‚ç çš„åç§»é‡å’Œå¯¹åº”çš„è¡Œå·" class="headerlink" title="LineNumberTable - Codeå±æ€§çš„å±æ€§(å­—èŠ‚ç çš„åç§»é‡å’Œå¯¹åº”çš„è¡Œå·)"></a>LineNumberTable - Codeå±æ€§çš„å±æ€§(å­—èŠ‚ç çš„åç§»é‡å’Œå¯¹åº”çš„è¡Œå·)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LineNumberTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;<span class="comment">//UTF-8å¸¸é‡æ± ï¼Œå­—é¢é‡LineNumberTable</span></span><br><span class="line"></span><br><span class="line">    u4 attribute_length;</span><br><span class="line"></span><br><span class="line">    u2 line_number_table_length;<span class="comment">//è¡¨é¡¹</span></span><br><span class="line"></span><br><span class="line">    &#123;   u2 start_pc;<span class="comment">//å­—èŠ‚ç åç§»é‡å’Œå¯¹åº”çš„è¡Œå·</span></span><br><span class="line">        u2 line_number;</span><br><span class="line">    &#125; line_number_table[line_number_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LocalVariableTable-Codeå±æ€§çš„å±æ€§-å±€éƒ¨å˜é‡è¡¨"><a href="#LocalVariableTable-Codeå±æ€§çš„å±æ€§-å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="LocalVariableTable -  Codeå±æ€§çš„å±æ€§(å±€éƒ¨å˜é‡è¡¨)"></a>LocalVariableTable - Codeå±æ€§çš„å±æ€§(å±€éƒ¨å˜é‡è¡¨)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LocalVariableTable_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;<span class="comment">//UTF-8å¸¸é‡æ± ï¼Œå­—é¢é‡LocalVariableTable</span></span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 local_variable_table_length;</span><br><span class="line"></span><br><span class="line">    &#123;   u2 start_pc;<span class="comment">//å±€éƒ¨å˜é‡ä½œç”¨åŸŸï¼Œä»å“ªé‡Œå¼€å§‹</span></span><br><span class="line">        u2 length;</span><br><span class="line">        u2 name_index;<span class="comment">//å±€éƒ¨å˜é‡åç§°</span></span><br><span class="line">        u2 descriptor_index;<span class="comment">//ç±»å‹</span></span><br><span class="line">        u2 index;<span class="comment">//å±€éƒ¨å˜é‡çš„Slotä½ç½®</span></span><br><span class="line">        <span class="comment">//å±€éƒ¨å˜é‡çš„slotæ˜¯èƒ½å¤Ÿé‡ç”¨çš„ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œåé¢å±€éƒ¨å˜é‡ä¼šé‡ç”¨å‰é¢å±€éƒ¨å˜é‡çš„slot</span></span><br><span class="line">        <span class="comment">//slotçš„æ„æ€æ˜¯â€å˜é‡æ§½â€œ</span></span><br><span class="line">    &#125; local_variable_table[local_variable_table_length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Exceptionså±æ€§"><a href="#Exceptionså±æ€§" class="headerlink" title="Exceptionså±æ€§"></a>Exceptionså±æ€§</h3><p>å’ŒCodeå±æ€§å¹³çº§<br>è¡¨ç¤ºæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ <strong><font color="red">(ä¸æ˜¯try catchéƒ¨åˆ†ï¼Œè€Œæ˜¯ throwséƒ¨åˆ†)</font></strong></p><ul><li>ç»“æ„<br>attribute_name_index u2<br>attribute_length u4<br>number_of_exceptions u2<br>exception_index_table[number_of_exceptions] u2 è¿™ä¸ªclasså°±æ˜¯è¦æŠ›å‡ºçš„å¼‚å¸¸çš„ç±»<br>æŒ‡å‘Constant_Classçš„ç´¢å¼•<h4 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h4></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> setAge(int age)  throws IOException&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;<span class="keyword">catch</span>(IllegalStateException e)&#123;</span><br><span class="line"><span class="keyword">this</span>.age = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160710163.png"><br>codeé‡Œé¢çš„Exceptionå³try catchçš„æ˜¯ç¬¬äº”ä¸ªå­—èŠ‚ç å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œå°±è·³è½¬åˆ°ç¬¬å…«ä¸ªå­—èŠ‚ç ï¼Œä¸Šå°èŠ‚æœ‰è®²åˆ°ã€‚</p><h3 id="SourceFile"><a href="#SourceFile" class="headerlink" title="SourceFile"></a>SourceFile</h3><p>æè¿°ç”ŸæˆClassæ–‡ä»¶çš„æºç æ–‡ä»¶åç§°</p><ul><li>ç»“æ„<br>attribute_name_index u2<br>attribute_length u4<br>å›ºå®šä¸º2<br>soucefile_index u2æ–‡ä»¶å<br>UTF-8å¸¸é‡ç´¢å¼•<h1 id="classæ–‡ä»¶ç»“æ„ğŸŒ°"><a href="#classæ–‡ä»¶ç»“æ„ğŸŒ°" class="headerlink" title="classæ–‡ä»¶ç»“æ„ğŸŒ°"></a>classæ–‡ä»¶ç»“æ„ğŸŒ°</h1><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">private int id;</span><br><span class="line">private <span class="built_in">String</span> name;</span><br><span class="line">private int age;</span><br><span class="line">public int getId() &#123;</span><br><span class="line"><span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> setId(int id) &#123;</span><br><span class="line"><span class="keyword">this</span>.id = id;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getName() &#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> setName(<span class="built_in">String</span> name) &#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">public int getAge() &#123;</span><br><span class="line"><span class="keyword">return</span> age;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> setAge(int age) &#123;</span><br><span class="line"><span class="keyword">this</span>.age = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160709322.png"><br>0123 é­”æ•°ï¼Œè¡¨ç¤ºæ˜¯classæ–‡ä»¶<br>45 å°ç‰ˆæœ¬<br>67 å¤§ç‰ˆæœ¬<br>89 å¸¸é‡æ± çš„ä¸ªæ•°0025è¡¨ç¤º36ä¸ªå¸¸é‡<br>æ¥ç€å¼€å§‹æè¿°å¸¸é‡æ± é‡Œé¢çš„å†…å®¹<br>A 07 è¡¨ç¤ºclassç±»å‹çš„å¸¸é‡ï¼ˆä¸Šé¢æœ‰å¯¹åº”çš„è¡¨æ ¼ï¼‰<br>classç±»å‹çš„å¸¸é‡é‡Œæœ‰0002ï¼Œè¡¨ç¤ºæŒ‡å‘å¸¸é‡æ± çš„æŒ‡é’ˆï¼Œè¿™ä¸ªç±»çš„utf-8çš„æè¿°æ˜¯å¸¸é‡æ± çš„ç¬¬äºŒä¸ªï¼Œç¬¬äºŒä¸ªæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿçœ‹D å‘ç°æ˜¯01ç±»å‹çš„å°±æ˜¯utf-8ã€‚ç„¶åæ˜¯é•¿åº¦001Bï¼Œå³27ï¼Œå†…å®¹æ˜¯geym/â€”â€”â€”â€”Userï¼Œè‡³æ­¤å®Œæ•´æè¿°äº†ä¸€ä¸ªç±»</p><p>å¸¸é‡æ± é‡Œé¢ä¸€å…±36ä¸ªï¼Œè¿™é‡Œä¸ä¸€ä¸€çš„è¿›è¡Œåˆ†æ<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160708880.png"><br>access_flagè®¿é—®æƒé™ 0021è¡¨ç¤ºpublicå’Œsuper<br>ç„¶åthisclassï¼Œè·Ÿä¸Šå¸¸é‡æ± çš„ç¬¬ä¸€ä¸ªï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ç±»æœ¬èº«<br>superclassï¼Œçˆ¶ç±»<br>interfaceï¼Œæ¥å£ï¼Œæ²¡æœ‰å®ç°æ¥å£ï¼Œæ‰€ä»¥æ˜¯0ï¼Œ<br>field count 0003ä¸‰ä¸ªï¼Œç¡®å®æ˜¯ä¸‰ä¸ªå­—æ®µ<br>0002 ç¬¬ä¸€ä¸ªå­—æ®µå¼€å§‹æè¿°äº†ï¼Œfield count ä¹‹åå°±æ˜¯å…·ä½“ä¿¡æ¯çš„æè¿°ï¼Œè¿™é‡Œçš„0002è¡¨ç¤ºfieldæ˜¯privateçš„å³ç§æœ‰çš„<br>0005 fieldåå­—çš„ç´¢å¼•åœ¨å¸¸é‡æ± ä¸­çš„ç´¢å¼•æ˜¯ç¬¬äº”ä¸ª<br>0006 æè¿°ç¬¦ï¼Œå¤§å†™çš„I è¡¨ç¤ºè¿™ä¸ªfieldçš„ç±»å‹æ˜¯ä¸€ä¸ªintç±»å‹<br>0000 attribute æ²¡æœ‰attribute</p><p>ä»¥æ­¤ç±»æ¨å°†ä¸‰ä¸ªfieldè§£è¯»ä¸€ä¸‹ã€‚<br>0007,fieldæè¿°å®Œä¹‹åå¼€å§‹æè¿°æ–¹æ³•method count 7ä¸ªæ–¹æ³•ä¸Šé¢ä¸€å…±æœ‰å…­ä¸ªï¼Œ7ä¸ªå› ä¸ºè¿˜æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°<br>0001 publicæ–¹æ³•<br>000Aæ–¹æ³•åå­—çš„ç´¢å¼•è¡¨ç¤ºçš„æ˜¯initæ–¹æ³•ã€‚<br>000Bæ–¹æ³•æè¿°<br>0001attribute countå±æ€§çš„å€¼</p><p>ç¦»æ•£çš„æ ‡å‡ºäº†å‡ ä¸ªæ–¹æ³•çš„å¼€å§‹<br>00010013<br>00010017<br>000100<br>0001001D<br>0001001F</p><p>00010022è¡¨ç¤ºæœ€åä¸€ä¸ªæ–¹æ³•setAge<br>0018æ–¹æ³•çš„descritoræ–¹æ³•çš„æè¿°ç­¾å<br>0001attribute count 1<br>000c codeå±æ€§<br>0000003E changdu 62<br>0002max stackæœ€å¤§æ ˆçš„å¤§å°<br>0002max localsæœ€å¤§å±€éƒ¨å˜é‡è¡¨çš„å¤§å°<img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190304160707218.png"><br>ä¸Šå›¾è¡¨ç¤ºcode<br>00000006 6ä¸ªbyte<br>2A1BB50020B1ç³»ç»Ÿä¸­çœŸæ­£è¿è¡Œçš„å­—èŠ‚ç <br>0000å¼‚å¸¸è¡¨å› ä¸ºæ²¡æœ‰å¼‚å¸¸æ‰€ä»¥ä¸ºç©º<br>0002å±æ€§å±æ€§<br>000Flinenumbertable<br>0000000Aé•¿åº¦ä¸º10<br>0002linenumber table lenthè¡¨è±¡<br>0000 0017 0005 0018 åˆ†åˆ«ä¸ºåç§»é‡å’Œè¡Œå·<br>0010 å±€éƒ¨å˜é‡è¡¨<br>00000016 é•¿åº¦22<br>ã€‚ã€‚ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190304134755173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>0002å±€éƒ¨å˜é‡è¡¨çš„è¡¨è±¡çš„é•¿åº¦<br>0000åç§»é‡<br>0006é•¿åº¦ä½œç”¨èŒƒå›´<br>0011ç¬¬ä¸€å±€éƒ¨å˜é‡çš„åå­—ï¼Œthis<br>0012å±€éƒ¨å˜é‡çš„ç±»å‹user<br>0000slotç¬¬ä¸€ä¸ªslotè¢«å®ƒæ‰€å <br>00000006å¦ä¸€ä¸ªå±€éƒ¨å˜é‡çš„ä¿¡æ¯<br>0001attributeå…¶ä»–çš„å±æ€§ è¿˜æœ‰ä¸€ä¸ª<br>0023å“ªä¸ªæºæ–‡ä»¶å£°ç§°å‡ºæ¥çš„<br>00000002é•¿åº¦2<br>0024æŒ‡å‘ç´¢å¼•ï¼Œç±»æ˜¯ç”±User.javaç¼–è¯‘å‡ºæ¥çš„ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;è¯­è¨€æ— å…³æ€§&quot;&gt;&lt;a href=&quot;#è¯­è¨€æ— å…³æ€§&quot; class=&quot;headerlink&quot; title=&quot;è¯­è¨€æ— å…³æ€§&quot;&gt;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰ï¼šé”</title>
    <link href="http://mmmmmm.me/2019-03-03-2.html"/>
    <id>http://mmmmmm.me/2019-03-03-2.html</id>
    <published>2019-03-03T08:21:02.000Z</published>
    <updated>2019-03-03T14:19:57.064Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h1><h2 id="å¤šçº¿ç¨‹ç½‘ç«™ç»Ÿè®¡è®¿é—®äººæ•°"><a href="#å¤šçº¿ç¨‹ç½‘ç«™ç»Ÿè®¡è®¿é—®äººæ•°" class="headerlink" title="å¤šçº¿ç¨‹ç½‘ç«™ç»Ÿè®¡è®¿é—®äººæ•°"></a>å¤šçº¿ç¨‹ç½‘ç«™ç»Ÿè®¡è®¿é—®äººæ•°</h2><p>ä½¿ç”¨é”ï¼Œç»´æŠ¤è®¡æ•°å™¨çš„ä¸²è¡Œè®¿é—®ä¸å®‰å…¨æ€§<br>å½“ç„¶å¦‚æœç½‘ç«™çš„ä»»åŠ¡ç²¾ç¡®åº¦è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œå¹¶å‘é‡ä¸æ˜¯å¾ˆå¤§ï¼Œå¯ä»¥ä¸åŠ é”ï¼Œä»¥æ­¤æå‡æ€§èƒ½ï¼Œå…·ä½“æ€æ ·å–èˆçœ‹å®é™…æƒ…å†µ</p><h2 id="å¤šçº¿ç¨‹è®¿é—®ArrayList"><a href="#å¤šçº¿ç¨‹è®¿é—®ArrayList" class="headerlink" title="å¤šçº¿ç¨‹è®¿é—®ArrayList"></a>å¤šçº¿ç¨‹è®¿é—®ArrayList</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> List&lt;Integer&gt; numberList =<span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddToList</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">int startnum=<span class="number">0</span>;</span><br><span class="line">public AddToList(int startnumber)&#123;</span><br><span class="line">startnum=startnumber;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">int count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(count&lt;<span class="number">1000000</span>)&#123;</span><br><span class="line">numberList.add(startnum);</span><br><span class="line">startnum+=<span class="number">2</span>;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> AddToList(<span class="number">0</span>));</span><br><span class="line">Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> AddToList(<span class="number">1</span>));</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line"><span class="keyword">while</span>(t1.isAlive() || t2.isAlive())&#123;</span><br><span class="line">Thread.sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(numberList.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303210402250.png"><br>æ ¹æ®ä¸Šä¸Šé¢çš„ä»£ç å‘½ååº”è¯¥ä¼šæœ‰200000çš„å®¹é‡ï¼ŒArrayListæ˜¯ä¼šè‡ªå·±æ‰©å®¹çš„ï¼Œä¸ºä»€ä¹ˆæœ€åæŠ¥é”™ArrayIistOutOfBoundsExceptionï¼ˆä¸‹æ ‡è¶Šç•Œï¼‰çš„é”™è¯¯å‘¢ï¼Ÿ<br>ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè™½ç„¶å®ƒè‡ªå·±ä¼šæ‰©å®¹ï¼Œä½†æ˜¯å¦‚æœå®ƒå¦‚æœå®¹é‡ä¸å¤Ÿéœ€è¦æ‰©å±•çš„æƒ…å†µä¸‹ï¼Œå®é™…ä¸Šå®ƒæ˜¯ä¸€ä¸ªä¸å¯ç”¨çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹çªç„¶å¾€é‡Œé¢æ’æ•°æ®ï¼Œåˆæ²¡æœ‰å¯¹ArrayListåšçº¿ç¨‹ä¿æŠ¤ï¼Œ ArrayListæœ¬èº«æ˜¯ä¸å¯ç”¨çš„ï¼Œå› æ­¤æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚</p><p>æ‰€ä»¥å¾ˆå¯èƒ½çº¿ç¨‹ä¸ä»…ä»…æ˜¯ä¸èƒ½ç²¾ç¡®ç»Ÿè®¡çš„é—®é¢˜ï¼Œå¾ˆå¯èƒ½æ•´ä¸ªç¨‹åºæ ¹æœ¬æ— æ³•æ­£å¸¸çš„æ‰§è¡Œã€‚</p><h1 id="å¯¹è±¡å¤´Mark"><a href="#å¯¹è±¡å¤´Mark" class="headerlink" title="å¯¹è±¡å¤´Mark"></a>å¯¹è±¡å¤´Mark</h1><h2 id="Mark-Wordï¼Œå¯¹è±¡å¤´çš„æ ‡è®°ï¼Œ32ä½"><a href="#Mark-Wordï¼Œå¯¹è±¡å¤´çš„æ ‡è®°ï¼Œ32ä½" class="headerlink" title="Mark Wordï¼Œå¯¹è±¡å¤´çš„æ ‡è®°ï¼Œ32ä½"></a>Mark Wordï¼Œå¯¹è±¡å¤´çš„æ ‡è®°ï¼Œ32ä½</h2><h2 id="æè¿°å¯¹è±¡çš„hashã€é”ä¿¡æ¯ï¼Œåƒåœ¾å›æ”¶æ ‡è®°ï¼Œå¹´é¾„"><a href="#æè¿°å¯¹è±¡çš„hashã€é”ä¿¡æ¯ï¼Œåƒåœ¾å›æ”¶æ ‡è®°ï¼Œå¹´é¾„" class="headerlink" title="æè¿°å¯¹è±¡çš„hashã€é”ä¿¡æ¯ï¼Œåƒåœ¾å›æ”¶æ ‡è®°ï¼Œå¹´é¾„"></a>æè¿°å¯¹è±¡çš„hashã€é”ä¿¡æ¯ï¼Œåƒåœ¾å›æ”¶æ ‡è®°ï¼Œå¹´é¾„</h2><p>æŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ<br>æŒ‡å‘monitorçš„æŒ‡é’ˆ<br>GCæ ‡è®°<br>åå‘é”çº¿ç¨‹ID</p><h1 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h1><ul><li>å¤§éƒ¨åˆ†æƒ…å†µæ˜¯æ²¡æœ‰ç«äº‰çš„ï¼Œæˆ–è€…ç«äº‰ä¸æ¿€çƒˆçš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡åå‘æ¥æé«˜æ€§èƒ½</li><li>æ‰€è°“çš„åå‘ï¼Œå°±æ˜¯åå¿ƒï¼Œå³é”ä¼šåå‘äºå½“å‰å·²ç»å æœ‰é”çš„çº¿ç¨‹</li><li>å°†å¯¹è±¡å¤´Markçš„æ ‡è®°è®¾ç½®ä¸ºåå‘ï¼Œå¹¶å°†çº¿ç¨‹IDå†™å…¥å¯¹è±¡å¤´Mark</li><li>åªè¦æ²¡æœ‰ç«äº‰ï¼Œè·å¾—åå‘é”çš„çº¿ç¨‹ï¼Œåœ¨å°†æ¥è¿›å…¥åŒæ­¥å—ï¼Œä¸éœ€è¦åšåŒæ­¥</li><li>å½“å…¶ä»–çº¿ç¨‹è¯·æ±‚ç›¸åŒçš„é”æ—¶ï¼Œåå‘æ¨¡å¼ç»“æŸ</li><li>-XX:+UseBiasedLocking é»˜è®¤å¯ç”¨</li><li><strong><font color="red">åœ¨ç«äº‰æ¿€çƒˆçš„åœºåˆï¼Œåå‘é”ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…</font></strong></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> List&lt;Integer&gt; numberList =<span class="keyword">new</span> Vector&lt;Integer&gt;();</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">long begin=System.currentTimeMillis();</span><br><span class="line">int count=<span class="number">0</span>;</span><br><span class="line">int startnum=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(count&lt;<span class="number">10000000</span>)&#123;</span><br><span class="line">numberList.add(startnum);</span><br><span class="line">startnum+=<span class="number">2</span>;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">long end=System.currentTimeMillis();</span><br><span class="line">System.out.println(end-begin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¡¨é¢ä¸Šçœ‹èµ·æ¥æ²¡æœ‰åŠ é”ï¼Œä½†æ˜¯Vectoræ˜¯é€šè¿‡åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰“å¼€åå‘é”ï¼Œå› ä¸ºjvmåˆšå¯åŠ¨çš„æ—¶å€™ç«äº‰æ˜¯æ¯”è¾ƒæ¿€çƒˆçš„ï¼Œæ‰€ä»¥ç³»ç»Ÿé»˜è®¤æ˜¯è¿‡å‡ ç§’é’Ÿåœ¨å¼€å¯åå‘é”çš„</span></span><br><span class="line"><span class="comment">//è¿™é‡ŒBiasedLockingStartupDelay=0æ˜¯å¸Œæœ›jvmåˆšèµ·åŠ¨å°±æ‰“å¼€åå‘é”</span></span><br><span class="line"><span class="comment">//å› ä¸ºè¿™ä¸ªç¨‹åºæ‰§è¡Œçš„å¾ˆå¿«</span></span><br><span class="line">-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=<span class="number">0</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³é—­åå‘é”</span></span><br><span class="line">-XX:-UseBiasedLocking</span><br></pre></td></tr></table></figure><p>æœ¬ä¾‹ä¸­ï¼Œä½¿ç”¨åå‘é”ï¼Œå¯ä»¥è·å¾—5%ä»¥ä¸Šçš„æ€§èƒ½æå‡</p><h1 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h1><h2 id="BasicObjectLock"><a href="#BasicObjectLock" class="headerlink" title="BasicObjectLock"></a>BasicObjectLock</h2><p>åµŒå…¥åœ¨ <strong><font color="red">çº¿ç¨‹æ ˆ</font></strong>ä¸­çš„å¯¹è±¡<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303212517541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>BasicLockå°±æ˜¯å¯¹è±¡å¤´ï¼Œptr to obj holdd the lock æŒ‡å‘æŒæœ‰è¿™ä¸ªé”çš„å¯¹è±¡çš„æŒ‡é’ˆ</p><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰è½»é‡çº§é”"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰è½»é‡çº§é”" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰è½»é‡çº§é”"></a>ä¸ºä»€ä¹ˆè¦æœ‰è½»é‡çº§é”</h2><ul><li>æ™®é€šçš„é”å¤„ç†æ€§èƒ½ä¸å¤Ÿç†æƒ³ï¼Œè½»é‡çº§é”æ˜¯ä¸€ç§å¿«é€Ÿçš„é”å®šæ–¹æ³•ã€‚</li><li>å¦‚æœå¯¹è±¡æ²¡æœ‰è¢«é”å®š<br>å°†å¯¹è±¡å¤´çš„MarkæŒ‡é’ˆä¿å­˜åˆ°é”å¯¹è±¡ï¼ˆBasicObjectLockï¼‰ä¸­<br>å°†å¯¹è±¡å¤´è®¾ç½®ä¸ºæŒ‡å‘é”çš„æŒ‡é’ˆï¼ˆåœ¨çº¿ç¨‹æ ˆç©ºé—´ä¸­ï¼‰</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é”é‡Œé¢æœ‰displaced_headerï¼ˆå¯¹è±¡å¤´ï¼‰</span></span><br><span class="line">lock-&gt;set_displaced_header(mark);</span><br><span class="line"><span class="comment">//å¯¹è±¡äº¤æ¢ï¼Œå°†lockï¼ˆé”ï¼‰æœ¬èº«æ”¾åˆ°å¯¹è±¡å¤´å½“ä¸­å»</span></span><br><span class="line"><span class="comment">//å¦‚æœæˆåŠŸäº†å°±è¡¨ç¤ºé”æ‹¿åˆ°äº†ï¼Œlockæ˜¯ä½äºçº¿ç¨‹æ ˆä¸­çš„ï¼Œå› æ­¤å¦‚ä½•åˆ¤æ–­çº¿ç¨‹æŒæœ‰è¿™ä¸ªé”</span></span><br><span class="line"><span class="comment">//åªéœ€è¦åˆ¤æ–­å¯¹è±¡å¤´çš„æŒ‡é’ˆï¼Œæ˜¯ä¸æ˜¯åœ¨çº¿ç¨‹çš„æ ˆå½“ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">//æ˜¯å°±æ˜¯æŒæœ‰è¿™æŠŠé”ï¼Œä¸æ˜¯å°±æ²¡æœ‰æŒæœ‰è¿™æŠŠé”</span></span><br><span class="line"> <span class="keyword">if</span> (mark == (markOop) Atomic::cmpxchg_ptr(lock, obj()-&gt;mark_addr(), mark)) &#123;</span><br><span class="line">      TEVENT (slow_enter: release stacklock) ;</span><br><span class="line">      <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè½»é‡çº§é”å¤±è´¥ï¼Œè¡¨ç¤ºå­˜åœ¨ç«äº‰ï¼Œå‡çº§ä¸ºé‡é‡çº§é”ï¼ˆå¸¸è§„é”ï¼‰<br>åœ¨æ²¡æœ‰é”ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿé”ä½¿ç”¨OSäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æŸè€—<br>åœ¨ç«äº‰æ¿€çƒˆæ—¶ï¼Œè½»é‡çº§é”ä¼šå¤šåšå¾ˆå¤šé¢å¤–æ“ä½œï¼ˆæ— ç”¨åŠŸï¼‰ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™</p><h1 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h1><p>å½“ç«äº‰å­˜åœ¨æ—¶ï¼Œå¦‚æœçº¿ç¨‹å¯ä»¥å¾ˆå¿«è·å¾—é”ï¼Œé‚£ä¹ˆå¯ä»¥ä¸åœ¨OSå±‚æŒ‚èµ·çº¿ç¨‹ï¼Œè®©çº¿ç¨‹åšå‡ ä¸ªç©ºæ“ä½œï¼ˆè‡ªæ—‹ï¼‰<br>JDK1.6ä¸­-XX:+UseSpinningå¼€å¯<br>JDK1.7ä¸­ï¼Œå»æ‰æ­¤å‚æ•°ï¼Œæ”¹ä¸ºå†…ç½®å®ç°<br>å¦‚æœåŒæ­¥å—å¾ˆé•¿ï¼Œéœ€è¦è‡ªæ—‹å¾ˆä¹…ï¼Œè¿˜æ²¡æœ‰æ‹¿åˆ°é”ï¼Œè‡ªæ—‹å¤±è´¥ï¼Œä¼šé™ä½ç³»ç»Ÿæ€§èƒ½<br>å¦‚æœåŒæ­¥å—å¾ˆçŸ­ï¼Œå¾ˆå¿«å°±æ‹¿åˆ°äº†é”ï¼Œè‡ªæ—‹æˆåŠŸï¼ŒèŠ‚çœçº¿ç¨‹æŒ‚èµ·åˆ‡æ¢æ—¶é—´ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½</p><h1 id="åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“"><a href="#åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“" class="headerlink" title="åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“"></a>åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“</h1><ul><li>ä¸æ˜¯Javaè¯­è¨€å±‚é¢çš„é”ä¼˜åŒ–æ–¹æ³•</li><li><p>å†…ç½®äºJVMä¸­çš„è·å–é”çš„ä¼˜åŒ–æ–¹æ³•å’Œè·å–é”çš„æ­¥éª¤<br>åå‘é”å¯ç”¨ä¼šå…ˆå°è¯•åå‘é”<br>è½»é‡çº§é”å¯ç”¨ä¼šå…ˆå°è¯•è½»é‡çº§é”<br>ä»¥ä¸Šéƒ½å¤±è´¥ï¼Œå°è¯•è‡ªæ—‹é”<br>å†å¤±è´¥ï¼Œå°è¯•æ™®é€šé”ï¼Œä½¿ç”¨OSäº’æ–¥é‡åœ¨æ“ä½œç³»ç»Ÿå±‚æŒ‚èµ·</p><p><strong><font color="red">çº¿é¢å¼€å§‹æ˜¯jvmçº§åˆ«çš„é”çš„ä¼˜åŒ–</font></strong></p><h1 id="å‡å°‘é”æŒæœ‰æ—¶é—´"><a href="#å‡å°‘é”æŒæœ‰æ—¶é—´" class="headerlink" title="å‡å°‘é”æŒæœ‰æ—¶é—´"></a>å‡å°‘é”æŒæœ‰æ—¶é—´</h1></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public synchronized <span class="keyword">void</span> syncMethod()&#123;</span><br><span class="line">othercode1();</span><br><span class="line">mutextMethod();</span><br><span class="line">othercode2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜æˆï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> syncMethod2()&#123;</span><br><span class="line">othercode1();</span><br><span class="line">synchronized(<span class="keyword">this</span>)&#123;</span><br><span class="line">mutextMethod();</span><br><span class="line">&#125;</span><br><span class="line">othercode2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ²¡æœ‰å¿…è¦åšåŒæ­¥çš„å°±ä¸è¦æ”¾åˆ°åŒæ­¥ä»£ç å—ä¸­</p><h1 id="å‡å°é”ç²’åº¦"><a href="#å‡å°é”ç²’åº¦" class="headerlink" title="å‡å°é”ç²’åº¦"></a>å‡å°é”ç²’åº¦</h1><ul><li>å°†å¤§å¯¹è±¡ï¼Œæ‹†æˆå°å¯¹è±¡ï¼Œå¤§å¤§å¢åŠ å¹¶è¡Œåº¦ï¼Œé™ä½é”ç«äº‰</li><li>åå‘é”ï¼Œè½»é‡çº§é”æˆåŠŸç‡æé«˜ï¼ˆå› ä¸ºå¸Œæœ›åœ¨çŸ­æ—¶é—´å†…å¾—åˆ°é”ï¼‰</li><li>ConcurrentHashMap</li><li>HashMapçš„åŒæ­¥å®ç°<br>Collections.synchronizedMap(Map&lt;K,V&gt; m)<br>è¿”å›SynchronizedMapå¯¹è±¡</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public V get(<span class="built_in">Object</span> key) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.get(key);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.put(key, value);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ConcurrentHashMap<br>è‹¥å¹²ä¸ªSegment ï¼šSegment&lt;K,V&gt;[] segments<br>Segmentä¸­ç»´æŠ¤HashEntry&lt;K,V&gt;<br>putæ“ä½œæ—¶<br>å…ˆå®šä½åˆ°Segmentï¼Œé”å®šä¸€ä¸ªSegmentï¼Œæ‰§è¡Œput</li><li><p>åœ¨å‡å°é”ç²’åº¦åï¼Œ ConcurrentHashMapå…è®¸è‹¥å¹²ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥</p><h2 id="å°é—®é¢˜ï¼Ÿ"><a href="#å°é—®é¢˜ï¼Ÿ" class="headerlink" title="å°é—®é¢˜ï¼Ÿ"></a>å°é—®é¢˜ï¼Ÿ</h2><p>å‡å°‘é”ç²’åº¦åï¼Œå¯èƒ½ä¼šå¸¦æ¥ä»€ä¹ˆè´Ÿé¢å½±å“å‘¢ï¼Ÿä»¥ConcurrentHashMapä¸ºä¾‹ï¼Œè¯´æ˜åˆ†å‰²ä¸ºå¤šä¸ª<br>Segmentåï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œä¼šæœ‰æ€§èƒ½æŸè€—ï¼Ÿ</p><h1 id="é”åˆ†ç¦»"><a href="#é”åˆ†ç¦»" class="headerlink" title="é”åˆ†ç¦»"></a>é”åˆ†ç¦»</h1><p>æ ¹æ®åŠŸèƒ½è¿›è¡Œé”åˆ†ç¦»<br>ReadWriteLock<br>è¯»å¤šå†™å°‘çš„æƒ…å†µï¼Œå¯ä»¥æé«˜æ€§èƒ½<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303214844901.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ArrayLIståœ¨å†™çš„æ—¶å€™å¯èƒ½éœ€è¦åšä¸€äº›æ‰©å±•ï¼Œè¿™ä¸ªæ—¶å€™ç¦æ­¢å…¶ä»–ä»»ä½•çº¿ç¨‹å¯¹å®ƒåšè®¿é—®ã€‚</p></li><li><p>è¯»å†™åˆ†ç¦»æ€æƒ³å¯ä»¥å»¶ä¼¸ï¼Œåªè¦æ“ä½œäº’ä¸å½±å“ï¼Œé”å°±å¯ä»¥åˆ†ç¦»</p></li><li>LinkedBlockingQueue<br>é˜Ÿåˆ—<br>é“¾è¡¨<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303215307471.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>takeå’Œputæ“ä½œäº’è¡¥å½±å“ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ†ç¦»ã€‚<h1 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h1>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯å¤šçº¿ç¨‹é—´çš„æœ‰æ•ˆå¹¶å‘ï¼Œä¼šè¦æ±‚æ¯ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´å°½é‡çŸ­ï¼ˆæ¯”å¦‚è‡ªæ—‹ï¼‰ï¼Œå³åœ¨ä½¿ç”¨å®Œå…¬å…±èµ„æºåï¼Œåº”è¯¥ç«‹å³é‡Šæ”¾é”ã€‚åªæœ‰è¿™æ ·ï¼Œç­‰å¾…åœ¨è¿™ä¸ªé”ä¸Šçš„å…¶ä»–çº¿ç¨‹æ‰èƒ½å°½æ—©çš„è·å¾—èµ„æºæ‰§è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œå‡¡äº‹éƒ½æœ‰ä¸€ä¸ªåº¦ï¼Œå¦‚æœå¯¹åŒä¸€ä¸ªé”ä¸åœçš„è¿›è¡Œè¯·æ±‚ã€åŒæ­¥å’Œé‡Šæ”¾ï¼Œå…¶æœ¬èº«ä¹Ÿä¼šæ¶ˆè€—ç³»ç»Ÿå®è´µçš„èµ„æºï¼Œåè€Œä¸åˆ©äºæ€§èƒ½çš„ä¼˜åŒ–<h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> demoMethod()&#123;</span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"><span class="comment">//do sth.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åšå…¶ä»–ä¸éœ€è¦çš„åŒæ­¥çš„å·¥ä½œï¼Œä½†èƒ½å¾ˆå¿«æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"><span class="comment">//do sth.</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å˜æˆï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> demoMethod()&#123;</span><br><span class="line"><span class="comment">//æ•´åˆæˆä¸€æ¬¡é”è¯·æ±‚</span></span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"><span class="comment">//do sth.</span></span><br><span class="line"><span class="comment">//åšå…¶ä»–ä¸éœ€è¦çš„åŒæ­¥çš„å·¥ä½œï¼Œä½†èƒ½å¾ˆå¿«æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;CIRCLE;i++)&#123;</span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜æˆï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">synchronized(lock)&#123;</span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;CIRCLE;i++)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h1><p>åœ¨å³æ—¶ç¼–è¯‘å™¨æ—¶ï¼Œå¦‚æœå‘ç°ä¸å¯èƒ½è¢«å…±äº«çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥æ¶ˆé™¤è¿™äº›å¯¹è±¡çš„é”æ“ä½œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) throws InterruptedException &#123;</span><br><span class="line">long start = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; CIRCLE; i++) &#123;</span><br><span class="line">craeteStringBuffer(<span class="string">"JVM"</span>, <span class="string">"Diagnosis"</span>);</span><br><span class="line">&#125;</span><br><span class="line">long bufferCost = System.currentTimeMillis() - start;</span><br><span class="line">System.out.println(<span class="string">"craeteStringBuffer: "</span> + bufferCost + <span class="string">" ms"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">String</span> craeteStringBuffer(<span class="built_in">String</span> s1, <span class="built_in">String</span> s2) &#123;</span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">sb.append(s1);</span><br><span class="line">sb.append(s2);</span><br><span class="line"><span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>appendæ˜¯åŒæ­¥çš„æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CIRCLE= <span class="number">2000000</span></span><br></pre></td></tr></table></figure><p>DoEscapeAnalysisé€ƒé€¸åˆ†æï¼Œå› ä¸ºè¿™ä¸ªå˜é‡èƒ½å¤Ÿè¢«å…¶ä»–çš„ä»£ç å—è®¿é—®ï¼Œå°±ä¸èƒ½ç¡®å®šç©¶ç«Ÿæ˜¯ä¸æ˜¯éœ€è¦çº¿ç¨‹å®‰å…¨äº†<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-server -XX:+DoEscapeAnalysis -XX:+EliminateLocks</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createStringBuffer: <span class="number">187</span> ms</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-server -XX:+DoEscapeAnalysis -XX:-EliminateLocks</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createStringBuffer: <span class="number">254</span> ms</span><br></pre></td></tr></table></figure><h1 id="æ— é”"><a href="#æ— é”" class="headerlink" title="æ— é”"></a>æ— é”</h1><ul><li>é”æ˜¯æ‚²è§‚çš„æ“ä½œ</li><li>æ— é”æ˜¯ä¹è§‚çš„æ“ä½œ</li><li>æ— é”çš„ä¸€ç§å®ç°æ–¹å¼<br>CAS(Compare And Swap)<br>éé˜»å¡çš„åŒæ­¥<br>CAS(V,E,N)vè¦æ›´æ–°çš„å˜é‡eæœŸæœ›å€¼ï¼Œnå¦‚æœè¾¾åˆ°æœŸæœ›å€¼ï¼Œèµ‹ç»™æ–°å€¼</li><li>åœ¨åº”ç”¨å±‚é¢åˆ¤æ–­å¤šçº¿ç¨‹çš„å¹²æ‰°ï¼Œå¦‚æœæœ‰å¹²æ‰°ï¼Œåˆ™é€šçŸ¥çº¿ç¨‹é‡è¯•</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.atomic.AtomicInteger</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final int getAndSet(int newValue) &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        int current = get();</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, newValue))</span><br><span class="line">            <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®æ–°å€¼ï¼Œè¿”å›æ—§å€¼<br>public final boolean compareAndSet(int expect, int update)<br>æ›´æ–°æˆåŠŸè¿”å›true<br>java.util.concurrent.atomicåŒ…ä½¿ç”¨æ— é”å®ç°ï¼Œæ€§èƒ½é«˜äºä¸€èˆ¬çš„æœ‰é”æ“ä½œ</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;çº¿ç¨‹å®‰å…¨&quot;&gt;&lt;a href=&quot;#çº¿ç¨‹å®‰å…¨&quot; class=&quot;headerlink&quot; title=&quot;çº¿ç¨‹å®‰å…¨&quot;&gt;&lt;/a
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆå…«ï¼‰ï¼šJAVAå †åˆ†æ</title>
    <link href="http://mmmmmm.me/2019-03-03-1.html"/>
    <id>http://mmmmmm.me/2019-03-03-1.html</id>
    <published>2019-03-03T02:22:02.000Z</published>
    <updated>2019-03-03T12:10:11.129Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å†…å­˜æº¢å‡º-OOM-çš„åŸå› "><a href="#å†…å­˜æº¢å‡º-OOM-çš„åŸå› " class="headerlink" title="å†…å­˜æº¢å‡º(OOM)çš„åŸå› "></a>å†…å­˜æº¢å‡º(OOM)çš„åŸå› </h1><h2 id="åœ¨JVMä¸­ï¼Œæœ‰å“ªäº›å†…å­˜åŒºé—´ï¼Ÿ"><a href="#åœ¨JVMä¸­ï¼Œæœ‰å“ªäº›å†…å­˜åŒºé—´ï¼Ÿ" class="headerlink" title="åœ¨JVMä¸­ï¼Œæœ‰å“ªäº›å†…å­˜åŒºé—´ï¼Ÿ"></a>åœ¨JVMä¸­ï¼Œæœ‰å“ªäº›å†…å­˜åŒºé—´ï¼Ÿ</h2><p>å †ã€æ°¸ä¹…åŒºã€çº¿ç¨‹æ ˆã€ç›´æ¥å†…å­˜ï¼Œæ­¤å¤–è¿˜æœ‰code cacheç­‰ï¼Œä½†æ˜¯ä¸ä¼šå‡ºç°OOMã€‚<br>è¿™å‡ å—ç©ºé—´çš„æ€»å’Œæ˜¯ä¸èƒ½è¶…è¿‡è®¡ç®—æœºåˆ†é…ç»™jvmçš„å†…å­˜ç©ºé—´çš„ï¼Œä¸€èˆ¬åœ¨32ä½çš„è®¡ç®—æœºä¸­ä¸èƒ½è¶…è¿‡2gï¼Œæ€»ä½“ä¸Šæ¥è¯´ä¸èƒ½è¶…è¿‡ç‰©ç†å†…å­˜ï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªå†…å­˜ç©ºé—´æ²¡æœ‰åŠæ³•å¾—åˆ°è¶³å¤Ÿçš„åˆ†é…ï¼Œéƒ½æœ‰å¯èƒ½ä¼šOOM</p><h2 id="å †æº¢å‡º"><a href="#å †æº¢å‡º" class="headerlink" title="å †æº¢å‡º"></a>å †æº¢å‡º</h2><p>ä½¿ç”¨å †ä¸­çš„ç©ºé—´ï¼Œå¯¹å…¶ä¸­æ— ç”¨çš„å¯¹è±¡ï¼Œæ²¡æœ‰è¿›è¡ŒåŠæ—¶çš„é‡Šæ”¾ï¼Œå¯¼è‡´å †æº¢å‡ºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[])&#123;</span><br><span class="line">    ArrayList&lt;byte[]&gt; list=<span class="keyword">new</span> ArrayList&lt;byte[]&gt;();</span><br><span class="line">    <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1024</span>;i++)&#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> byte[<span class="number">1024</span>*<span class="number">1024</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºarrayListæ˜¯æŒæœ‰byteæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›byteæ•°ç»„éƒ½æ˜¯æœ‰å¼•ç”¨çš„ï¼Œæ‰€ä»¥byteæ•°ç»„ä¸ä¼šè¢«è®¤ä¸ºæ˜¯åƒåœ¾å¯¹è±¡ï¼Œæ— æ³•è¢«ç³»ç»Ÿå›æ”¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å ç”¨å¤§é‡å †ç©ºé—´ï¼Œç›´æ¥æº¢å‡º</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">at geym.jvm.ch8.oom.SimpleHeapOOM.main(SimpleHeapOOM.java:<span class="number">14</span>)</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼š Java heap space</font></strong><br>è§£å†³æ–¹æ³•ï¼šå¢å¤§å †ç©ºé—´ï¼ŒåŠæ—¶é‡Šæ”¾å†…å­˜</p><h2 id="æ°¸ä¹…åŒº"><a href="#æ°¸ä¹…åŒº" class="headerlink" title="æ°¸ä¹…åŒº"></a>æ°¸ä¹…åŒº</h2><p>æ°¸ä¹…åŒºå­˜ç€ç±»çš„å…ƒä¿¡æ¯ï¼Œæ‰€ä»¥å½“ç±»å¾ˆå¤šçš„æ—¶å€™ï¼Œæ°¸ä¹…åŒºä¹Ÿä¼šç©ºé—´ä¸è¶³ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    for(int i=0;i&lt;100000;i++)&#123;</span><br><span class="line">        CglibBean bean = new CglibBean(&quot;geym.jvm.ch3.perm.bean&quot;+i,new HashMap());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œnewäº†å¾ˆå¤šç±»<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.OutOfMemoryError: PermGen space</span><br><span class="line">[Full GC[Tenured: <span class="number">2523</span>K-&gt;<span class="number">2523</span>K(<span class="number">10944</span>K), <span class="number">0.0125610</span> secs] <span class="number">2523</span>K-&gt;<span class="number">2523</span>K(<span class="number">15936</span>K), </span><br><span class="line">[Perm : <span class="number">4095</span>K-&gt;<span class="number">4095</span>K(<span class="number">4096</span>K)], <span class="number">0.0125868</span> secs] [Times: user=<span class="number">0.02</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">Heap</span><br><span class="line"> def <span class="keyword">new</span> generation   total <span class="number">4992</span>K, used <span class="number">89</span>K [<span class="number">0x28280000</span>, <span class="number">0x287e0000</span>, <span class="number">0x2d7d0000</span>)</span><br><span class="line">  eden space <span class="number">4480</span>K,   <span class="number">2</span>% used [<span class="number">0x28280000</span>, <span class="number">0x282966d0</span>, <span class="number">0x286e0000</span>)</span><br><span class="line">  <span class="keyword">from</span> space <span class="number">512</span>K,   <span class="number">0</span>% used [<span class="number">0x286e0000</span>, <span class="number">0x286e0000</span>, <span class="number">0x28760000</span>)</span><br><span class="line">  to   space <span class="number">512</span>K,   <span class="number">0</span>% used [<span class="number">0x28760000</span>, <span class="number">0x28760000</span>, <span class="number">0x287e0000</span>)</span><br><span class="line"> tenured generation   total <span class="number">10944</span>K, used <span class="number">2523</span>K [<span class="number">0x2d7d0000</span>, <span class="number">0x2e280000</span>, <span class="number">0x38280000</span>)</span><br><span class="line">   the space <span class="number">10944</span>K,  <span class="number">23</span>% used [<span class="number">0x2d7d0000</span>, <span class="number">0x2da46cf0</span>, <span class="number">0x2da46e00</span>, <span class="number">0x2e280000</span>)</span><br><span class="line"> compacting perm gen  total <span class="number">4096</span>K, used <span class="number">4095</span>K [<span class="number">0x38280000</span>, <span class="number">0x38680000</span>, <span class="number">0x38680000</span>)</span><br><span class="line">   the space <span class="number">4096</span>K,  <span class="number">99</span>% used [<span class="number">0x38280000</span>, <span class="number">0x3867fff0</span>, <span class="number">0x38680000</span>, <span class="number">0x38680000</span>)</span><br><span class="line">    ro space <span class="number">10240</span>K,  <span class="number">44</span>% used [<span class="number">0x38680000</span>, <span class="number">0x38af73f0</span>, <span class="number">0x38af7400</span>, <span class="number">0x39080000</span>)</span><br><span class="line">    rw space <span class="number">12288</span>K,  <span class="number">52</span>% used [<span class="number">0x39080000</span>, <span class="number">0x396cdd28</span>, <span class="number">0x396cde00</span>, <span class="number">0x39c80000</span>)</span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">æ³¨æ„ï¼š PermGen space</font></strong><br>è§£å†³æ–¹æ³•ï¼š<br>å¢å¤§PermåŒº<br>å…è®¸Classå›æ”¶ï¼ˆåœ¨JVMä¸­å¯ä»¥è®¾ç½®ä¸ºå…è®¸å›æ”¶Classå…ƒæ•°æ®ï¼‰</p><h2 id="Javaæ ˆæº¢å‡º"><a href="#Javaæ ˆæº¢å‡º" class="headerlink" title="Javaæ ˆæº¢å‡º"></a>Javaæ ˆæº¢å‡º</h2><p>è¿™é‡Œçš„æ ˆæº¢å‡ºæŒ‡ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œéœ€è¦ä¸ºçº¿ç¨‹åˆ†é…æ ˆç©ºé—´ï¼Œè¿™ä¸ªæ ˆç©ºé—´æ˜¯å‘æ“ä½œç³»ç»Ÿè¯·æ±‚çš„ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ— æ³•ç»™å‡ºè¶³å¤Ÿçš„ç©ºé—´ï¼Œå°±ä¼šæŠ›å‡ºOOM<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194124779.png"><br>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºå¯¹ç©ºé—´å’Œçº¿ç¨‹æ ˆç©ºé—´æ˜¯ä¸èƒ½è¶…è¿‡æ“ä½œç³»ç»Ÿå¯åˆ†é…çš„æ€»ç©ºé—´çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepThread</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    public <span class="keyword">void</span> run()&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[])&#123;</span><br><span class="line">    <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> SleepThread(),<span class="string">"Thread"</span>+i).start();</span><br><span class="line">        System.out.println(<span class="string">"Thread"</span>+i+<span class="string">" created"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx1g -Xss1m</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: </span><br><span class="line">unable to create <span class="keyword">new</span> native thread</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼š unable to create new native thread</font></strong><br>è§£å†³æ–¹æ³•ï¼š<br>å‡å°‘å †å†…å­˜<br>å‡å°‘çº¿ç¨‹æ ˆå¤§å°</p><p>è§£æï¼šå› ä¸ºè¿™é‡Œçš„é—®é¢˜æ˜¯çº¿ç¨‹sleepæ—¶é—´å¤ªä¹…ï¼Œæœ‰å¤ªå¤šçš„çº¿ç¨‹å­˜åœ¨äºæ ˆä¸­ï¼Œæ‰€ä»¥æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ–°å»ºæ–°çš„çº¿ç¨‹ï¼Œä»ä¸Šé¢å¾—çŸ¥ï¼Œæ“ä½œç³»ç»Ÿçš„æ€»ç©ºé—´æ˜¯å †å†…å­˜å’Œçº¿ç¨‹æ ˆç©ºé—´çš„å¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å‡å°å †å†…å­˜ï¼Œä¹Ÿå¯ä»¥å‡å°å•ä¸ªçº¿ç¨‹æ ˆçš„å¤§å°ï¼Œå°±èƒ½å¤Ÿäº§ç”Ÿæ›´å¤šçš„çº¿ç¨‹ã€‚</p><h2 id="ç›´æ¥å†…å­˜æº¢å‡º"><a href="#ç›´æ¥å†…å­˜æº¢å‡º" class="headerlink" title="ç›´æ¥å†…å­˜æº¢å‡º"></a>ç›´æ¥å†…å­˜æº¢å‡º</h2><p>ByteBuffer.allocateDirect()æ— æ³•ä»æ“ä½œç³»ç»Ÿè·å¾—è¶³å¤Ÿçš„ç©ºé—´<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194124379.png"><br>å¯¹ç©ºé—´ã€çº¿ç¨‹æ ˆç©ºé—´ã€ç›´æ¥å†…å­˜åŠ èµ·æ¥æ˜¯ä¸èƒ½å¤§äºæ“ä½œç³»ç»Ÿå¯åˆ†é…ç©ºé—´çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1024</span>;i++)&#123;</span><br><span class="line">    ByteBuffer.allocateDirect(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">      System.gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ByteBufferåˆ†é…äº†ä¸€äº›ç›´æ¥çš„å†…å­˜åŒºåŸŸï¼Œè¿™äº›å†…å­˜æ˜¯åœ¨å †å¤–çš„ï¼Œæ˜¯æ“ä½œç³»ç»Ÿç›´æ¥åˆ†é…ç»™jvmå†…å­˜çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx1g -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p>åˆ†é…äº†ä¸€ä¸ªgçš„å †ç©ºé—´<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194127250.png"><br>å¯ä»¥çœ‹åˆ°æŠ¥é”™çš„ç›´æ¥åŸå› æ˜¯DirectByteBufferåˆ†é…çš„memoryæ²¡æœ‰åŠæ³•åˆ†é…åˆ°ï¼Œä»æœ€åé¢çš„å †ä¸­çš„ä¿¡æ¯å¯ä»¥çœ‹åˆ°å †çš„ç©ºé—´æ˜¯ååˆ†å¯Œè£•çš„ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®šï¼Œå°±æ˜¯å› ä¸ºä½¿ç”¨ç›´æ¥å†…å­˜è¿‡åº¦å¯¼è‡´çš„ã€‚</p><p>è§£å†³æ–¹æ³•ï¼š<br>å‡å°‘å †å†…å­˜<br>æœ‰æ„è§¦å‘GC</p><p>è§£æï¼šåŒä¸Šé¢çš„æ ˆç©ºé—´è§£æä¸€æ ·ï¼Œè¿™ä¸‰è€…åŠ èµ·æ¥ä¸èƒ½è¶…è¿‡ç³»ç»Ÿå¯åˆ†é…çš„æ€»ç©ºé—´ï¼Œæ‰€ä»¥å‡å°å †å†…å­˜ï¼Œèƒ½å¤Ÿè§£å†³ç›´æ¥å†…å­˜å †æ ˆæº¢å‡ºçš„é—®é¢˜ã€‚ç›´æ¥å†…å­˜åˆ†é…ä¸ä¼šå¼•èµ·GCï¼Œåªæœ‰å †å’Œæ°¸ä¹…åŒºä¼šå¯¼è‡´GCçš„å‘ç”Ÿï¼Œè™½ç„¶ç›´æ¥å†…å­˜æ˜¯èƒ½å¤Ÿè¢«jvmå›æ”¶çš„ï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿè‡ªåŠ¨è§¦å‘GCã€‚</p><h2 id="å°é—®é¢˜ï¼Ÿ"><a href="#å°é—®é¢˜ï¼Ÿ" class="headerlink" title="å°é—®é¢˜ï¼Ÿ"></a>å°é—®é¢˜ï¼Ÿ</h2><p>é‡åˆ°å†…å­˜æº¢å‡ºåï¼Œåº”è¯¥å¦‚ä½•æ€è€ƒå’Œå¤„ç†é—®é¢˜ï¼Ÿ</p><h1 id="MATä½¿ç”¨åŸºç¡€"><a href="#MATä½¿ç”¨åŸºç¡€" class="headerlink" title="MATä½¿ç”¨åŸºç¡€"></a>MATä½¿ç”¨åŸºç¡€</h1><p>Memory Analyzerï¼ˆMATï¼‰å†…å­˜åˆ†æçš„å·¥å…·<br>åŸºäºEclipseçš„è½¯ä»¶ï¼ˆèƒ½å¤Ÿåœ¨eclipseå®˜ç½‘è¿›è¡Œä¸‹è½½ï¼‰<br><a href="http://www.eclipse.org/mat/" target="_blank" rel="noopener">http://www.eclipse.org/mat/</a></p><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194126243.png"></p><h2 id="æŸ±çŠ¶å›¾æ˜¾ç¤º"><a href="#æŸ±çŠ¶å›¾æ˜¾ç¤º" class="headerlink" title="æŸ±çŠ¶å›¾æ˜¾ç¤º"></a>æŸ±çŠ¶å›¾æ˜¾ç¤º</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194126228.png"><br>æŸ±çŠ¶å›¾æ˜¾ç¤ºï¼Œæ˜¾ç¤ºæ¯ä¸ªç±»çš„ä½¿ç”¨æƒ…å†µï¼Œ<br>æ¯”å¦‚ç±»çš„æ•°é‡ï¼Œæ‰€å ç©ºé—´ç­‰</p><h2 id="æ”¯é…æ ‘"><a href="#æ”¯é…æ ‘" class="headerlink" title="æ”¯é…æ ‘"></a>æ”¯é…æ ‘</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194128576.png"><br>æ˜¾ç¤ºæ”¯é…æ ‘</p><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194126646.png"><br>ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œå·¦è¾¹æ˜¯å¯¹è±¡å¼•ç”¨å›¾ï¼ˆaå¼•ç”¨cï¼Œbå¼•ç”¨cï¼Œç­‰ç­‰ç•¥ï¼‰ï¼Œå³è¾¹æ˜¯æ”¯é…æ ‘ï¼ˆå›¾ä¸­æœ‰æ”¯é…æ ‘çš„è§£é‡Šï¼‰ï¼Œæˆ‘è®¤ä¸ºæ›´ç¡®åˆ‡çš„è§£é‡Šæ˜¯â€œæ‰€æœ‰æŒ‡å‘å¯¹è±¡Bçš„è·¯å¾„éƒ½ <strong><font color="red">å¿…é¡»å¹¶ä¸”åªèƒ½ </font></strong>ç»è¿‡Aï¼Œåˆ™è®¤ä¸ºå¯¹è±¡Aæ”¯é…å¯¹è±¡Bâ€ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°cå¯ä»¥é€šè¿‡aè¿‡æ¥å¯ä»¥é€šè¿‡bè¿‡æ¥ï¼Œæ‰€ä»¥aã€bä¸cä¹‹é—´æ²¡æœ‰æ”¯é…å…³ç³»ï¼ŒåŒæ ·ï¼Œå¯ä»¥é€€å‡ºä¸Šé¢çš„æ”¯é…å…³ç³»ï¼Œä½†æ˜¯æ³¨æ„hä¸èƒ½è¢«få’Œgæ”¯é…ä½†æ˜¯è¢«cæ”¯é…ç€ï¼Œæ‰€ä»¥çœ‹ä¼¼cå’Œhä¹‹é—´ç¦»å¾—å¾ˆè¿œï¼Œå…¶å®æ˜¯ç›´æ¥æ”¯é…çš„å…³ç³»ã€‚</p><p>æ”¯é…è€…è¢«å›æ”¶ï¼Œè¢«æ”¯é…å¯¹è±¡ä¹Ÿä¼šè¢«å›æ”¶ï¼šcè¢«å›æ”¶åˆ™dã€eã€fã€gã€héƒ½ä¼šè¢«å›æ”¶<br>å› ä¸ºè¾¾åˆ°æˆ‘çš„å”¯ä¸€è·¯å¾„è¢«å›æ”¶äº†ï¼Œæ‰€ä»¥æ²¡æœ‰å…¶ä»–è·¯å¾„èƒ½è¿‡åˆ°è¾¾è¢«æ”¯é…å¯¹è±¡äº†ã€‚<br><strong><font color="red">æ‰€ä»¥å½“ä¸€ä¸ªå¯¹è±¡è¢«å›æ”¶ä¹‹åï¼Œç©¶ç«Ÿæœ‰å¤šå°‘å†…å­˜ç©ºé—´èƒ½è¢«é‡Šæ”¾æ‰ï¼Œè¿™ä¸ªæ˜¯ä¸ªæ”¯é…æ ‘ç›´æ¥ç›¸å…³çš„ã€‚</font></strong></p><h2 id="æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯"><a href="#æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯"></a>æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194127422.png"><br>è¿™é‡Œä¸æ˜¯æŒ‡çº¿ç¨‹å †æ ˆçš„ä¿¡æ¯ï¼Œè€Œæ˜¯æ¯ä¸ªçº¿ç¨‹åœ¨å †ä¸­çš„å¯¹è±¡ï¼Œæ¯”å¦‚è¿™é‡Œå°±èƒ½çœ‹åˆ°ä¸»çº¿ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼Œä»è€Œçœ‹åˆ°ä¸»çº¿ç¨‹çš„ä¸€äº›å¼•ç”¨ã€‚</p><h2 id="æ˜¾ç¤ºå †æ€»ä½“ä¿¡æ¯ï¼Œæ¯”å¦‚æ¶ˆè€—æœ€å¤§çš„ä¸€äº›å¯¹è±¡ç­‰"><a href="#æ˜¾ç¤ºå †æ€»ä½“ä¿¡æ¯ï¼Œæ¯”å¦‚æ¶ˆè€—æœ€å¤§çš„ä¸€äº›å¯¹è±¡ç­‰" class="headerlink" title="æ˜¾ç¤ºå †æ€»ä½“ä¿¡æ¯ï¼Œæ¯”å¦‚æ¶ˆè€—æœ€å¤§çš„ä¸€äº›å¯¹è±¡ç­‰"></a>æ˜¾ç¤ºå †æ€»ä½“ä¿¡æ¯ï¼Œæ¯”å¦‚æ¶ˆè€—æœ€å¤§çš„ä¸€äº›å¯¹è±¡ç­‰</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194128723.png"></p><h2 id="å…¥å¼•ç”¨å’Œå‡ºå¼•ç”¨"><a href="#å…¥å¼•ç”¨å’Œå‡ºå¼•ç”¨" class="headerlink" title="å…¥å¼•ç”¨å’Œå‡ºå¼•ç”¨"></a>å…¥å¼•ç”¨å’Œå‡ºå¼•ç”¨</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194130304.png"></p><h2 id="æµ…å †ã€æ·±å †"><a href="#æµ…å †ã€æ·±å †" class="headerlink" title="æµ…å †ã€æ·±å †"></a>æµ…å †ã€æ·±å †</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194129545.png"></p><h3 id="æµ…å †"><a href="#æµ…å †" class="headerlink" title="æµ…å †"></a>æµ…å †</h3><p>ä¸€ä¸ªå¯¹è±¡ç»“æ„æ‰€å ç”¨çš„å†…å­˜å¤§å°</p><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/20190303182629113.png"><br>3ä¸ªintç±»å‹ä»¥åŠä¸€ä¸ªå¼•ç”¨ç±»å‹åˆè®¡å ç”¨å†…å­˜3*4+4=16ä¸ªå­—èŠ‚ã€‚å†åŠ ä¸Šå¯¹è±¡å¤´çš„8ä¸ªå­—èŠ‚ï¼Œå› æ­¤Stringå¯¹è±¡å ç”¨çš„ç©ºé—´ï¼Œå³æµ…å †çš„å¤§å°æ˜¯16+8=24å­—èŠ‚<br>å¯¹è±¡å¤§å°æŒ‰ç…§8å­—èŠ‚å¯¹é½<br><strong><font color="red">æµ…å †å¤§å°å’Œå¯¹è±¡çš„å†…å®¹æ— å…³ï¼Œåªå’Œå¯¹è±¡çš„ç»“æ„æœ‰å…³</font></strong></p><h3 id="æ·±å †"><a href="#æ·±å †" class="headerlink" title="æ·±å †"></a>æ·±å †</h3><p>ä¸€ä¸ªå¯¹è±¡è¢«GCå›æ”¶åï¼Œå¯ä»¥çœŸå®é‡Šæ”¾çš„å†…å­˜å¤§å°ï¼ˆæ˜¯å¯¹è±¡å®é™…å ç”¨çš„ç©ºé—´çš„å¤§å°ï¼‰<br><strong><font color="red">åªèƒ½é€šè¿‡å¯¹è±¡è®¿é—®åˆ°çš„ï¼ˆç›´æ¥æˆ–è€…é—´æ¥ï¼‰æ‰€æœ‰å¯¹è±¡çš„æµ…å †ä¹‹å’Œ ï¼ˆæ”¯é…æ ‘ï¼‰</font></strong></p><h3 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303183606703.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194128788.png"><br>å°†bã€aã€cã€dã€eè®¾ç½®ä¸ºnullï¼Œfã€gä¸è®¾ç½®ä¸ºnull<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303183714843.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å¯ä»¥çœ‹åˆ°få’Œgä¸ä»…åœ¨ä¸‹é¢çš„dlineæœ‰å¼•ç”¨ï¼Œè€Œä¸”è¢«mainå¼•ç”¨å› ä¸ºæ²¡æœ‰è¢«è®¾ç½®ä¸ºnullï¼Œæ‰€ä»¥èƒ½å¤Ÿè¢«mainå½“åšå±€éƒ¨å˜é‡ï¼ˆä¸Šå›¾ä¸­localï¼‰ä½¿ç”¨ã€‚<br>å³è¾¹çš„ç¬¬ä¸€åˆ—æ˜¯æµ…å †ï¼Œç¬¬äºŒåˆ—æ˜¯æ·±å †ï¼Œæ¯ä¸€ä¸ªæµ…å †ï¼ˆpointå’Œlineï¼Œå› ä¸ºlineä¸­æ˜¯ä¸¤ä¸ªå¼•ç”¨ï¼Œ <strong><font color="red">å¼•ç”¨æ˜¯å››ä¸ªå­—èŠ‚ </font></strong>ï¼‰éƒ½æ˜¯16ï¼Œfå’Œgæ˜¯æ²¡æœ‰å¼•ç”¨ä»»ä½•äººï¼Œæ‰€ä»¥ä¹Ÿæ˜¯16ï¼Œ<br>alineçš„æ·±å †æ˜¯32ï¼Œå› ä¸ºalineè¢«é‡Šæ”¾æ‰ä¹‹åpoint aè¿˜è¢«blineå¼•ç”¨è¿™ï¼Œæ‰€ä»¥alineæœ¬èº«é‡Šæ”¾èƒ½é‡Šæ”¾16ï¼Œå†åŠ ä¸Šè‡ªå·±æ”¯é…æ ‘ä¸Šçš„bç‚¹ï¼Œä¸€å…±èƒ½é‡Šæ”¾32<br>blineèƒ½å¤Ÿé‡Šæ”¾æœ¬èº«ï¼ˆåªèƒ½é‡Šæ”¾bç‚¹ï¼Œå› ä¸ºaåœ¨alineä¸­ä¹Ÿæœ‰ï¼Œæ‰€ä»¥æ˜¯æ²¡æœ‰æ”¯é…aç‚¹çš„ï¼‰æ‰€ä»¥èƒ½å¤Ÿé‡Šæ”¾bç‚¹ï¼Œä¸€å…±ä¹Ÿæ˜¯32<br>clineé™¤äº†è‡ªå·±çš„16ï¼Œè¿˜æœ‰è‡ªå·±æ”¯é…çš„då’Œeï¼Œæ‰€ä»¥ä¸€å…±48<br>dlineåªèƒ½é‡Šæ”¾16ï¼Œå› ä¸ºé™¤äº†é‡Šæ”¾è‡ªå·±ï¼Œåœ¨miançš„å±€éƒ¨å˜é‡ä¸­è¿˜æœ‰få’Œgçš„å¼•ç”¨ï¼Œæ‰€ä»¥æ·±å †æ˜¯16</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼šæ·±å †å°±æ˜¯ <strong><font color="red">å¯¹è±¡è¢«å›æ”¶ä¹‹åï¼Œå®é™…èƒ½å¤Ÿé‡Šæ”¾çš„å†…å­˜ç©ºé—´</font></strong></p><h1 id="ä½¿ç”¨Visual-VMåˆ†æå †"><a href="#ä½¿ç”¨Visual-VMåˆ†æå †" class="headerlink" title="ä½¿ç”¨Visual VMåˆ†æå †"></a>ä½¿ç”¨Visual VMåˆ†æå †</h1><h2 id="javaè‡ªå¸¦çš„å¤šåŠŸèƒ½åˆ†æå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥åˆ†æå †Dump"><a href="#javaè‡ªå¸¦çš„å¤šåŠŸèƒ½åˆ†æå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥åˆ†æå †Dump" class="headerlink" title="javaè‡ªå¸¦çš„å¤šåŠŸèƒ½åˆ†æå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥åˆ†æå †Dump"></a>javaè‡ªå¸¦çš„å¤šåŠŸèƒ½åˆ†æå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥åˆ†æå †Dump</h2><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303185307711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>é€šè¿‡ä½¿ç”¨Visual VMå¯ä»¥çŸ¥é“å“ªä¸ªç±»çš„å®ä¾‹æ•°æ˜¯æœ€å¤šçš„ï¼Œå ç”¨çš„ç©ºé—´å¤§å°æ˜¯æœ€å¤šçš„ï¼Œæ–¹ä¾¿å®šä½ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194130385.png"><br>ä¸‹é¢çš„è¿‡æ»¤æ¡†æ–¹ä¾¿è¿‡æ»¤ç‡ç±»<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303185546546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ç‚¹å‡»pointå®ä¾‹ï¼Œå³è¾¹æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œå’Œå¼•ç”¨ä¿¡æ¯<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303185922764.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ä¸Šå›¾ä¸ºä½¿ç”¨OQLè¯­å¥è¿›è¡Œåˆ†æï¼Œé€šè¿‡ç±»ä¼¼äºSQLè¯­å¥çš„æ–¹å¼ï¼Œè¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚ä¸Šé¢çš„OQLè¯­å¥çš„å«ä¹‰å°±æ˜¯å°†æ‰€æœ‰çš„point å¯¹è±¡é€šè¿‡{x:p.x,y:p.y}çš„jsonå½¢å¼æ˜¾ç¤ºå‡ºæ¥ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/201903031902354.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>referenceï¼Œè¿”å›å¼•ç”¨äº†æŸä¸ªå˜é‡çš„å¯¹è±¡<br>è¿”å›å¼•ç”¨äº†(0,0)è¿™ä¸ªç‚¹çš„æ‰€æœ‰å¯¹è±¡ï¼Œå‘ç°æœ‰ä¸¤æ¡å¼•ç”¨äº†ï¼ˆ0ï¼Œ0ï¼‰çš„ç‚¹</p><h1 id="Tomcat-OOMåˆ†ææ¡ˆä¾‹"><a href="#Tomcat-OOMåˆ†ææ¡ˆä¾‹" class="headerlink" title="Tomcat OOMåˆ†ææ¡ˆä¾‹"></a>Tomcat OOMåˆ†ææ¡ˆä¾‹</h1><ul><li>Tomcat OOM<br>Tomcat åœ¨æ¥æ”¶å¤§é‡è¯·æ±‚æ—¶ï¼ˆå¯èƒ½é€šè¿‡jmeterå‹åŠ›æµ‹è¯•ï¼‰å‘ç”ŸOOMï¼Œè·å–å †Dumpæ–‡ä»¶ï¼Œè¿›è¡Œåˆ†æã€‚</li><li>ä½¿ç”¨MATæ‰“å¼€å †<br>-åˆ†æç›®çš„ï¼š<br>æ‰¾å‡ºOOMçš„åŸå› <br>æ¨æµ‹ç³»ç»ŸOOMæ—¶çš„çŠ¶æ€<br>ç»™å‡ºè§£å†³è¿™ä¸ªOOMçš„æ–¹æ³•<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303191028721.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å †çš„å¤§å°æ˜¯29mï¼Œæ¨æ–­å½“æ—¶ï¼Œä½¿ç”¨å¯30må·¦å³å †çš„å¤§å°ï¼Œæ‰€ä»¥29mçš„æ—¶å€™å°±å‘ç”Ÿäº†OOMçš„é—®é¢˜ï¼Œè¿˜çœ‹åˆ°RetainedSizeæ˜¯16.4mï¼ŒRetainedSizeæ˜¯é‡Šæ”¾æ‰å¯¹è±¡åæ‰€èƒ½å¾—åˆ°çš„ç©ºé—´ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯StandardManagerï¼Œä½äºcatalina.sessionåŒ…ä¸‹ï¼Œå¯ä»¥æ¨æ–­å’Œsessionæœ‰å…³ç³»ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°æœ€å¤§çš„å°±æ˜¯å¥¹16.4m<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194132727.png"><br>å³å‡»æŸ¥çœ‹å‡ºå¼•ç”¨ï¼ˆå¼•ç”¨äº†è°ï¼‰<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303191648238.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å¯ä»¥çœ‹åˆ°sessionsæ·±å †è¿œè¿œå¤§äºå…¶ä»–ï¼Œæ¨æ–­æ˜¯å› ä¸ºsessionä¸­ä¿å­˜äº†å¤§é‡çš„æ•°æ®ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/201903031918118.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>é€šè¿‡ä¸Šå›¾ï¼Œæ‰“å¼€sessionsï¼Œå‘ç°æœ‰å¾ˆå¤šçš„segementsï¼ŒconcurrentHashMapæ˜¯ä¸€ä¸ªé«˜å¹¶å‘çš„HashMapï¼Œé€šè¿‡â€œé”åˆ†ç¦»â€å°†HashMapçš„æ•°ç»„åˆ†æˆå¤šä»½ï¼Œæ¯æ¬¡åŠ é”ï¼Œåªé”ä½å…¶ä¸­çš„ä¸€ä¸ªå°é”ï¼Œè¾¾åˆ°ä¼˜åŒ–æ€§èƒ½çš„ä½œç”¨ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303192252199.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>æ¥ç€æ‰“å¼€segementå‘ç°é‡Œé¢å°±æ˜¯æ™®é€šçš„tableâ€“ã€‹entryï¼ˆè¡¨è±¡ï¼‰â€“ã€‹keyã€valueï¼Œæ‰€ä»¥æ¨æ–­å°±æ˜¯åœ¨ä¿å­˜äº†è¿‡å¤šçš„sessionæ²¡æœ‰è¢«é‡Šæ”¾</li></ul><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303192507719.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>éªŒè¯æ˜¯å¦æ˜¯å› ä¸ºå­˜æ”¾äº†è¿‡å¤šçš„session<br>visual VMçš„OQLå’ŒMATçš„OQLæ˜¯æœ‰ä¸€å®šçš„åŒºåˆ«çš„ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚<br>é€šè¿‡ä¸Šé¢çš„OQLå°†æ‰€æœ‰çš„standerdSessionå¯¹è±¡æŸ¥æ‰¾å‡ºæ¥ï¼ŒæŸ¥è¯¢çš„æœ€åå‘ç°è¿”å›äº†9941ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡çš„æ·±å †å°†è¿‘1.6kã€‚æ‰€ä»¥æ–­å®šOOMçš„æ—¶å€™ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„è®¿é—®ï¼Œæ‰€ä»¥æŒæœ‰å¤§é‡çš„sessionæ²¡æœ‰è¢«é‡Šæ”¾æ‰ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190303192908964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>ç‚¹å‡»ä»»æ„ä¸€ä¸ªsessionï¼Œå·¦è¾¹æœ‰è¯¦ç»†çš„ä¿¡æ¯ï¼š<br>thisAccessedTimeï¼Œå½“å‰è®¿é—®çš„æ—¶é—´<br>maxInactiveIntervalï¼Œæœ€å¤§çš„è¿‡æœŸæ—¶é—´é—´éš”ï¼Œå¤§çº¦äºŒååˆ†é’Ÿ<br>expiringï¼Œæ˜¯å¦è¿‡æœŸ<br>creationTimeï¼Œsessionåˆ›å»ºçš„æ—¶é—´<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="/images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190303194135596.png"><br>ä¸Šå›¾ä¸­æœ€åä¸€ä¸ªsessionåˆ›å»ºæ—¶é—´å‡å»ç¬¬ä¸€ä¸ªsessionåˆ›å»ºæ—¶é—´/1000å°±æ˜¯ä¸€ä¸ªå†å¤šå°‘ç§’ä¹‹å†…æ˜¯æœ‰è¯·æ±‚çš„ï¼Œ9941/è¿™ä¸ªæ•°å€¼ï¼Œå°±æ˜¯æ¯ç§’æœ‰åˆ›å»ºäº†å¤šå°‘ä¸ªï¼Œå³å¤šå°‘æ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥å¾—å‡ºäº†ä¸Šå›¾çš„ç»“è®ºã€‚</p><h2 id="è§£å†³æ–¹æ³•ï¼š"><a href="#è§£å†³æ–¹æ³•ï¼š" class="headerlink" title="è§£å†³æ–¹æ³•ï¼š"></a>è§£å†³æ–¹æ³•ï¼š</h2><ol><li>OOMç”±äºä¿å­˜sessionè¿‡å¤šå¼•èµ·ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ å †å¤§å°</li><li>å¦‚æœåº”ç”¨å…è®¸ï¼Œç¼©çŸ­sessionçš„è¿‡æœŸæ—¶é—´ï¼Œä½¿å¾—sessionå¯ä»¥åŠæ—¶è¿‡æœŸï¼Œå¹¶å›æ”¶</li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å†…å­˜æº¢å‡º-OOM-çš„åŸå› &quot;&gt;&lt;a href=&quot;#å†…å­˜æº¢å‡º-OOM-çš„åŸå› &quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šæ€§èƒ½ç›‘æ§å·¥å…·</title>
    <link href="http://mmmmmm.me/2019-03-03.html"/>
    <id>http://mmmmmm.me/2019-03-03.html</id>
    <published>2019-03-03T02:21:02.000Z</published>
    <updated>2019-03-03T11:39:07.346Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ç³»ç»Ÿæ€§èƒ½ç›‘æ§"><a href="#ç³»ç»Ÿæ€§èƒ½ç›‘æ§" class="headerlink" title="ç³»ç»Ÿæ€§èƒ½ç›‘æ§"></a>ç³»ç»Ÿæ€§èƒ½ç›‘æ§</h1><p>ç¡®å®šç³»ç»Ÿè¿è¡Œçš„æ•´ä½“çŠ¶æ€ï¼ŒåŸºæœ¬å®šä½é—®é¢˜æ‰€åœ¨</p><h2 id="ç³»ç»Ÿæ€§èƒ½ç›‘æ§-linux"><a href="#ç³»ç»Ÿæ€§èƒ½ç›‘æ§-linux" class="headerlink" title="ç³»ç»Ÿæ€§èƒ½ç›‘æ§- linux"></a>ç³»ç»Ÿæ€§èƒ½ç›‘æ§- linux</h2><h3 id="uptime"><a href="#uptime" class="headerlink" title="uptime"></a>uptime</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ uptime</span><br><span class="line"> <span class="number">7</span>:<span class="number">38</span>  up <span class="number">11</span> days, <span class="number">14</span>:<span class="number">06</span>, <span class="number">14</span> users, load averages: <span class="number">2.60</span> <span class="number">2.06</span> <span class="number">1.96</span></span><br></pre></td></tr></table></figure><p>å‚æ•°è§£é‡Šï¼š</p><ul><li>ç³»ç»Ÿæ—¶é—´</li><li>è¿è¡Œæ—¶é—´<br>ä¾‹å­ä¸­ä¸º7åˆ†é’Ÿ</li><li>è¿æ¥æ•°<br>æ¯ä¸€ä¸ªç»ˆç«¯ç®—ä¸€ä¸ªè¿æ¥</li><li>1,5,15åˆ†é’Ÿå†…çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½<br>è¿è¡Œé˜Ÿåˆ—ä¸­çš„å¹³å‡è¿›ç¨‹æ•°ï¼Œè¿™ä¸ªæ•°è¶Šå¤§è´Ÿè½½è¶Šå¤§ã€‚<h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">top - <span class="number">07</span>:<span class="number">43</span>:<span class="number">53</span> up <span class="number">168</span> days, <span class="number">13</span>:<span class="number">16</span>,  <span class="number">2</span> users,  load average: <span class="number">0.00</span>, <span class="number">0.00</span>, <span class="number">0.00</span></span><br><span class="line">Tasks: <span class="number">110</span> total,   <span class="number">1</span> running, <span class="number">109</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line">Cpu(s):  <span class="number">0.3</span>%us,  <span class="number">0.3</span>%sy,  <span class="number">0.0</span>%ni, <span class="number">99.3</span>%id,  <span class="number">0.0</span>%wa,  <span class="number">0.0</span>%hi,  <span class="number">0.0</span>%si,  <span class="number">0.0</span>%st</span><br><span class="line">Mem:    <span class="number">520132</span>k total,   <span class="number">425620</span>k used,    <span class="number">94512</span>k free,    <span class="number">91668</span>k buffers</span><br><span class="line">Swap:   <span class="number">135164</span>k total,     <span class="number">9164</span>k used,   <span class="number">126000</span>k free,   <span class="number">136948</span>k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</span><br><span class="line"> <span class="number">4694</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">440</span>m  <span class="number">77</span>m  <span class="number">14</span>m S  <span class="number">0.3</span> <span class="number">15.2</span> <span class="number">144</span>:<span class="number">14.78</span> java</span><br><span class="line"><span class="number">21796</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">12292</span> <span class="number">6332</span> <span class="number">5516</span> S  <span class="number">0.3</span>  <span class="number">1.2</span>   <span class="number">0</span>:<span class="number">00.14</span> sshd</span><br><span class="line">    <span class="number">1</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">2964</span>  <span class="number">624</span>  <span class="number">504</span> S  <span class="number">0.0</span>  <span class="number">0.1</span>   <span class="number">0</span>:<span class="number">01.14</span> init</span><br><span class="line">    <span class="number">2</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> kthreadd</span><br><span class="line">    <span class="number">4</span> root       <span class="number">0</span> <span class="number">-20</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> kworker/<span class="number">0</span>:<span class="number">0</span>H</span><br><span class="line">    <span class="number">6</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">26.37</span> ksoftirqd/<span class="number">0</span></span><br><span class="line">    <span class="number">7</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">2</span>:<span class="number">47.42</span> rcu_sched</span><br><span class="line">    <span class="number">8</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> rcu_bh</span><br><span class="line">    <span class="number">9</span> root      RT   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> migration/<span class="number">0</span></span><br><span class="line">   <span class="number">10</span> root       <span class="number">0</span> <span class="number">-20</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> lru-add-drain</span><br><span class="line">   <span class="number">11</span> root      RT   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">47.40</span> watchdog/<span class="number">0</span></span><br><span class="line">   <span class="number">12</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> cpuhp/<span class="number">0</span></span><br><span class="line">   <span class="number">13</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> kdevtmpfs</span><br><span class="line">   <span class="number">14</span> root       <span class="number">0</span> <span class="number">-20</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> netns</span><br><span class="line">   <span class="number">15</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">15.88</span> khungtaskd</span><br><span class="line">   <span class="number">16</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> oom_reaper</span><br><span class="line">   <span class="number">17</span> root       <span class="number">0</span> <span class="number">-20</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">00.00</span> writeback</span><br><span class="line">   <span class="number">18</span> root      <span class="number">20</span>   <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span> S  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">0</span>:<span class="number">01.28</span> kcompactd0</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„åŠŸèƒ½åŒuptimeï¼Œç„¶ååŒ…å—CPUçš„ä½¿ç”¨æƒ…å†µã€å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€äº¤æ¢ç©ºé—´çš„ä½¿ç”¨æƒ…å†µï¼Œä¸‹é¢çš„è¡¨æ ¼æ˜¯æ¯ä¸ªè¿›ç¨‹å CPUçš„æƒ…å†µã€‚</p><h2 id="vmstatï¼ˆè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ï¼‰"><a href="#vmstatï¼ˆè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ï¼‰" class="headerlink" title="vmstatï¼ˆè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ï¼‰"></a>vmstatï¼ˆè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ï¼‰</h2><p>å¯ä»¥ç»Ÿè®¡ç³»ç»Ÿçš„CPUï¼Œå†…å­˜ï¼Œswapï¼Œioç­‰æƒ…å†µ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1sé‡‡æ ·ä¸€æ¬¡ï¼Œè¾“å‡º4æ¬¡å°±ç»“æŸäº†ã€‚</span></span><br><span class="line">[root@host ~]# vmstat 1 4</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> <span class="number">0</span>  <span class="number">0</span>   <span class="number">9164</span>  <span class="number">94768</span>  <span class="number">91668</span> <span class="number">136948</span>    <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>     <span class="number">1</span>    <span class="number">1</span>    <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">100</span>  <span class="number">0</span>  <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>  <span class="number">0</span>   <span class="number">9164</span>  <span class="number">94656</span>  <span class="number">91668</span> <span class="number">136972</span>    <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">12</span>   <span class="number">61</span>  <span class="number">108</span>  <span class="number">1</span>  <span class="number">0</span> <span class="number">99</span>  <span class="number">0</span>  <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>  <span class="number">0</span>   <span class="number">9164</span>  <span class="number">94656</span>  <span class="number">91668</span> <span class="number">136972</span>    <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">45</span>   <span class="number">87</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">100</span>  <span class="number">0</span>  <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>  <span class="number">0</span>   <span class="number">9164</span>  <span class="number">94688</span>  <span class="number">91668</span> <span class="number">136972</span>    <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">46</span>   <span class="number">90</span>  <span class="number">0</span>  <span class="number">0</span> <span class="number">100</span>  <span class="number">0</span>  <span class="number">0</span></span><br></pre></td></tr></table></figure><p></p><p>javaç©ºé—´çš„ä½¿ç”¨æƒ…å†µï¼šmemory:freeå‰©ä½™å†…å­˜ï¼Œ<br>ioï¼šbiã€boå³è¾“å…¥è¾“å‡ºï¼Œ<br>systemï¼šå¤šå°‘ä¸ªç»ˆä¸­æ–­ï¼Œå¤šå°‘ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcsï¼Œ æ¯ç§’çš„ç¯å¢ƒï¼ˆä¸Šä¸‹æ–‡ï¼‰åˆ‡æ¢æ¬¡æ•°ï¼‰ï¼Œç”¨æˆ·å ç”¨çš„cpuæ˜¯å¤šå°‘ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¶Šå¤šï¼Œè¡¨ç¤ºçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ¯”è¾ƒé¢‘ç¹ï¼Œ usï¼Œç”¨æˆ·CPUæ—¶é—´(éå†…æ ¸è¿›ç¨‹å ç”¨æ—¶é—´)ï¼ˆå•ä½ä¸ºç™¾åˆ†æ¯”ï¼‰ã€‚ usçš„å€¼æ¯”è¾ƒé«˜æ—¶ï¼Œè¯´æ˜ç”¨æˆ·è¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´å¤š</p><h2 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h2><ul><li>ç»†è‡´è§‚å¯Ÿè¿›ç¨‹</li><li>éœ€è¦å®‰è£…<br>sudo apt-get install sysstat</li><li>ç›‘æ§CPU</li><li>ç›‘æ§IO</li><li>ç›‘æ§å†…å­˜</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//-p æŒ‡å®šè¿›ç¨‹ â€“u ç›‘æ§CPU æ¯ç§’é‡‡æ · ä¸€å…±3æ¬¡</span></span><br><span class="line">[root@host ~]# pidstat -p  4694 -u 1 3</span><br><span class="line">Linux <span class="number">4.10</span><span class="number">.4</span><span class="number">-1.</span>el6.elrepo.i686 (host.localdomain) <span class="number">03</span>/<span class="number">02</span>/<span class="number">2019</span> _i686_(<span class="number">1</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">08</span>:<span class="number">11</span>:<span class="number">25</span> AM       PID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line"><span class="number">08</span>:<span class="number">11</span>:<span class="number">26</span> AM      <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  java</span><br><span class="line"><span class="number">08</span>:<span class="number">11</span>:<span class="number">27</span> AM      <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  java</span><br><span class="line"><span class="number">08</span>:<span class="number">11</span>:<span class="number">28</span> AM      <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  java</span><br><span class="line">Average:         <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     -  java</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//-t æ˜¾ç¤ºçº¿ç¨‹</span></span><br><span class="line">[root@host ~]# pidstat -p  4694 -u 1 3 -t</span><br><span class="line">Linux <span class="number">4.10</span><span class="number">.4</span><span class="number">-1.</span>el6.elrepo.i686 (host.localdomain) <span class="number">03</span>/<span class="number">02</span>/<span class="number">2019</span> _i686_(<span class="number">1</span> CPU)</span><br><span class="line"><span class="comment">//%usrçœ‹å½“å‰çº¿ç¨‹å ç”¨çš„cpu   å‚æ•°â€CPUâ€œæ˜¯æŒ‡å½“å‰çº¿ç¨‹è¿è¡Œåœ¨å“ªä¸ªcpuä¸Šï¼Œ</span></span><br><span class="line"><span class="comment">//ä¸€èˆ¬æœ‰ä¸¤ä¸ªcpuçš„è¯ï¼Œæ˜¯è½®ç€ç”¨çš„</span></span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">05</span> AM      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM      <span class="number">4694</span>         -    <span class="number">1.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">1.00</span>     <span class="number">0</span>  java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4695</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4696</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4697</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4698</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4699</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4700</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4701</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4702</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4703</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM         -      <span class="number">4704</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line"></span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">06</span> AM      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">07</span> AM      <span class="number">4694</span>         -    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  java</span><br><span class="line"><span class="number">08</span>:<span class="number">12</span>:<span class="number">07</span> AM         -      <span class="number">4694</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0</span>  |__java</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//-d   ioæƒ…å†µ</span></span><br><span class="line">[root@host ~]# pidstat -p  4694  1 3 -d -t</span><br><span class="line">Linux <span class="number">4.10</span><span class="number">.4</span><span class="number">-1.</span>el6.elrepo.i686 (host.localdomain) <span class="number">03</span>/<span class="number">02</span>/<span class="number">2019</span> _i686_(<span class="number">1</span> CPU)</span><br><span class="line"><span class="comment">//PIDï¼šè¿›ç¨‹id</span></span><br><span class="line"><span class="comment">//kB_rd/sï¼šæ¯ç§’ä»ç£ç›˜è¯»å–çš„KB</span></span><br><span class="line"><span class="comment">//kB_wr/sï¼šæ¯ç§’å†™å…¥ç£ç›˜KB</span></span><br><span class="line"><span class="comment">//kB_ccwr/sï¼šä»»åŠ¡å–æ¶ˆçš„å†™å…¥ç£ç›˜çš„KBã€‚å½“ä»»åŠ¡æˆªæ–­è„çš„pagecacheçš„æ—¶å€™ä¼šå‘ç”Ÿã€‚</span></span><br><span class="line"><span class="comment">//COMMAND:taskçš„å‘½ä»¤å</span></span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">55</span> AM      TGID       TID   kB_rd/s   kB_wr/s kB_ccwr/s  Command</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM      <span class="number">4694</span>         -      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4694</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4695</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4696</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4697</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4698</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4699</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4700</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4701</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4702</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4703</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM         -      <span class="number">4704</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  |__java</span><br><span class="line"></span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">56</span> AM      TGID       TID   kB_rd/s   kB_wr/s kB_ccwr/s  Command</span><br><span class="line"><span class="number">08</span>:<span class="number">13</span>:<span class="number">57</span> AM      <span class="number">4694</span>         -      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>  java</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿæ€§èƒ½ç›‘æ§-windows"><a href="#ç³»ç»Ÿæ€§èƒ½ç›‘æ§-windows" class="headerlink" title="ç³»ç»Ÿæ€§èƒ½ç›‘æ§ - windows"></a>ç³»ç»Ÿæ€§èƒ½ç›‘æ§ - windows</h2><h3 id="ä»»åŠ¡ç®¡ç†å™¨"><a href="#ä»»åŠ¡ç®¡ç†å™¨" class="headerlink" title="ä»»åŠ¡ç®¡ç†å™¨"></a>ä»»åŠ¡ç®¡ç†å™¨</h3><p>æè¿°æ¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå³è¾¹æ˜¯é€‰æ‹©åŠŸèƒ½ã€‚<br><img alt="" data-original="/images/15515830761606.png"></p><h3 id="Perfmon"><a href="#Perfmon" class="headerlink" title="Perfmon"></a>Perfmon</h3><p>Windowsè‡ªå¸¦å¤šåŠŸèƒ½æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œwindows+r-ã€‹è¾“å…¥perfmon<br><img alt="" data-original="/images/15515831007888.png"><br><img alt="" data-original="/images/15515831073180.png"><br><img alt="" data-original="/images/15515831108264.png"></p><p>å¦‚ä¸Šå›¾ï¼šå³å‡»-ã€‹æ·»åŠ è®¡æ•°å™¨-ã€‹é€‰æ‹©å¯¹è±¡å®ä¾‹ï¼ˆè¿›ç¨‹ï¼‰ï¼Œå…³é”®å­—java-ã€‹ç¡®å®š-ã€‹å°†åŸæ¥çš„çº¿æ¡æ˜¾ç¤ºçš„æ–¹å¼å˜æˆæŠ¥å‘Šçš„å½¢å¼</p><p>å¯ä»¥çœ‹åˆ°æœ€åçš„javaè¿›ç¨‹ä¸­çº¿ç¨‹idä¸º2368000çš„çº¿ç¨‹cpuå ç”¨æ—¶é—´100%ã€‚<br>% Processor Time<br>% Processor Time æŒ‡å¤„ç†å™¨ç”¨æ¥æ‰§è¡Œéé—²ç½®çº¿ç¨‹æ—¶é—´çš„ç™¾åˆ†æ¯”ã€‚è®¡ç®—æ–¹æ³•æ˜¯ï¼Œæµ‹é‡èŒƒä¾‹é—´éš”å†…éé—²ç½®çº¿ç¨‹æ´»åŠ¨çš„æ—¶é—´ï¼Œç”¨èŒƒä¾‹é—´éš”å‡å»è¯¥å€¼ã€‚è¿™ä¸ªè®¡æ•°å™¨æ˜¯å¤„ç†å™¨æ´»åŠ¨çš„ä¸»è¦è¯´æ˜å™¨ï¼Œæ˜¾ç¤ºåœ¨èŒƒä¾‹é—´éš”æ—¶æ‰€è§‚å¯Ÿçš„ç¹å¿™æ—¶é—´å¹³å‡ç™¾åˆ†æ¯”ã€‚<br>% User Time<br>% User Time æŒ‡å¤„ç†å™¨å¤„äºç”¨æˆ·æ¨¡å¼çš„æ—¶é—´ç™¾åˆ†æ¯”ã€‚ç”¨æˆ·æ¨¡å¼æ˜¯ä¸ºåº”ç”¨ç¨‹åºã€ç¯å¢ƒåˆ†ç³»ç»Ÿå’Œæ•´æ•°åˆ†ç³»ç»Ÿè®¾è®¡çš„æœ‰é™å¤„ç†æ¨¡å¼ã€‚</p><h2 id="Process-Explorer"><a href="#Process-Explorer" class="headerlink" title="Process Explorer"></a>Process Explorer</h2><p>è¿›ç¨‹ç®¡ç†å™¨<br><img alt="" data-original="/images/15515831220858.png"></p><p>å³å‡»-ã€‹å±æ€§ï¼ŒæŸ¥çœ‹å…·ä½“çš„çº¿ç¨‹ä½¿ç”¨æƒ…å†µï¼Œæœ€æ¶ˆè€—æ€§èƒ½çš„æ˜¯3132<br><img alt="" data-original="/images/15515831289177.png"></p><h3 id="å°é—®é¢˜ï¼Ÿ"><a href="#å°é—®é¢˜ï¼Ÿ" class="headerlink" title="å°é—®é¢˜ï¼Ÿ"></a>å°é—®é¢˜ï¼Ÿ</h3><p>æ‰¾åˆ°ç³»ç»Ÿå†…æœ€æ¶ˆè€—CPUçš„çº¿ç¨‹</p><h2 id="pslist"><a href="#pslist" class="headerlink" title="pslist"></a>pslist</h2><p>ä¸ºä»€ä¹ˆä»‹ç»windowsä¸‹å‘½ä»¤è¡Œçš„å½¢å¼ï¼Ÿç”¨äºå†™ä¸€äº›è„šæœ¬è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚<br>éœ€è¦å®‰è£…<br>å‘½ä»¤è¡Œå·¥å…·<br>å¯ç”¨äºè‡ªåŠ¨åŒ–æ•°æ®æ”¶é›†<br>æ˜¾ç¤ºjavaç¨‹åºçš„è¿è¡Œæƒ…å†µ<br><img alt="" data-original="/images/15515831368171.png"></p><p>cmd-ã€‹PsList javawï¼ˆæŸ¥çœ‹javawè¿™ä¸ªè¿›ç¨‹çš„ä½¿ç”¨æƒ…å†µï¼‰</p><ul><li>Cpu Time cpuæ—¶é—´<br>CPUæ—¶é—´å°±æ˜¯å•çº¯çš„æ¶ˆè€—cpuçš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§ä»£è¡¨å ç”¨çš„cpuæ—¶é—´è¶Šå¤š</li><li>Elapsed Timeæ¶ˆè€—çš„æ—¶é—´<br>å ç”¨çš„cpuæ—¶é—´ï¼Œioæˆ–è€…ç½‘ç»œä¸Šçš„è¯»å†™ï¼Œéƒ½æœ‰ç­‰å¾…æ—¶é—´ï¼Œè¿™äº›æ—¶é—´ä¸èƒ½ç®—åˆ°cpuæ—¶é—´ä¸Šå»ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›æµå¤±çš„æ—¶é—´ï¼Œæµå¤±çš„æ—¶é—´ç­‰äºcpuçš„æ—¶é—´ï¼Œå®é™…ä¸Šcpuçš„æ—¶é—´åŠ ä¸Šç­‰å¾…æ—¶é—´ã€‚<br>ä½†æ˜¯è¿™é‡Œçš„cpuæ—¶é—´å¤§äºæµå¤±æ—¶é—´ï¼Œå› ä¸ºè¿™ä¸ªè®¡ç®—æœºæ˜¯ä¸€ä¸ªå¤šæ ¸è®¡ç®—æœºï¼Œåœ¨å¤šæ ¸è®¡ç®—æœºä¸Šï¼Œå¦‚æœæœ‰ä¸¤ä¸ªæ ¸ï¼Œç¬¬ä¸€ä¸ªæ ¸æµå ç”¨ä¸€åˆ†é’Ÿï¼Œç¬¬äºŒä¸ªæ ¸ä¹Ÿå ç”¨ä¸€åˆ†é’Ÿï¼Œæœ€åè¿˜æ˜¯ä¸€åˆ†é’Ÿï¼Œ</li></ul><h3 id="pslist-javaw-d-æŸ¥çœ‹javawè¿™ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯"><a href="#pslist-javaw-d-æŸ¥çœ‹javawè¿™ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯" class="headerlink" title="pslist javaw -d(æŸ¥çœ‹javawè¿™ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯)"></a>pslist javaw -d(æŸ¥çœ‹javawè¿™ä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯)</h3><p><img alt="" data-original="/images/15515831518900.png"></p><p>user timeå’Œkernel timeåˆ†åˆ«æ˜¯ç³»ç»Ÿåœ¨ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼å ç”¨çš„cpuæ—¶é—´ï¼Œåº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œï¼Œæ ¸å¿ƒæ“ä½œç³»ç»Ÿç»„ä»¶åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œã€‚<br>çº¿ç¨‹5756 ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯9235</p><h1 id="Javaè‡ªå¸¦çš„å·¥å…·"><a href="#Javaè‡ªå¸¦çš„å·¥å…·" class="headerlink" title="Javaè‡ªå¸¦çš„å·¥å…·"></a>Javaè‡ªå¸¦çš„å·¥å…·</h1><p>æŸ¥çœ‹Javaç¨‹åºè¿è¡Œç»†èŠ‚ï¼Œè¿›ä¸€æ­¥å®šä½é—®é¢˜ï¼ŒæŸ¥çœ‹javaç¨‹åºæœ¬èº«çš„ã€‚<br>ä¸€èˆ¬å‡ºäº†é—®é¢˜éƒ½å…ˆé€šè¿‡ç³»ç»Ÿçº§åˆ«çš„æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œå¦‚æœç¡®å®šäº†æ˜¯javaç¨‹åºæœ¬èº«é™¤äº†é—®é¢˜ï¼Œå†ç”¨javaè‡ªå¸¦çš„æ€§èƒ½ç›‘æ§å·¥å…·ã€‚<br><img alt="" data-original="/images/15515831681694.png"></p><p>è¿™äº›å·¥å…·åœ¨jdkä¸­çš„tools.jar/sun/toolsç›®å½•ä¸‹é¢</p><h2 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h2><p>åˆ—å‡ºjavaè¿›ç¨‹ï¼Œç±»ä¼¼äºpså‘½ä»¤<br>å‚æ•°-qå¯ä»¥æŒ‡å®šjpsåªè¾“å‡ºè¿›ç¨‹ID ï¼Œä¸è¾“å‡ºç±»çš„çŸ­åç§°<br>å‚æ•°-må¯ä»¥ç”¨äºè¾“å‡ºä¼ é€’ç»™Javaè¿›ç¨‹ï¼ˆä¸»å‡½æ•°ï¼‰çš„å‚æ•°<br>å‚æ•°-lå¯ä»¥ç”¨äºè¾“å‡ºä¸»å‡½æ•°çš„å®Œæ•´è·¯å¾„<br>å‚æ•°-vå¯ä»¥æ˜¾ç¤ºä¼ é€’ç»™JVMçš„å‚æ•°</p><h3 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ jps</span><br><span class="line"><span class="number">16821</span></span><br><span class="line"><span class="number">31612</span> Jps</span><br><span class="line"><span class="number">26588</span> OsxApp</span><br><span class="line">âœ  ~ jps -q</span><br><span class="line"><span class="number">16821</span></span><br><span class="line"><span class="number">31624</span></span><br><span class="line"><span class="number">26588</span></span><br><span class="line">âœ  ~ jps -m</span><br><span class="line"><span class="number">31634</span> Jps -m</span><br><span class="line"><span class="number">16821</span></span><br><span class="line"><span class="number">26588</span> OsxApp</span><br><span class="line">âœ  ~ jps -l</span><br><span class="line"><span class="number">16821</span></span><br><span class="line"><span class="number">31639</span> sun.tools.jps.Jps</span><br><span class="line"><span class="number">26588</span> org.jd.gui.OsxApp</span><br><span class="line">âœ  ~ jps -v</span><br><span class="line"><span class="number">16821</span>  -Xms128m -Xmx750m -XX:ReservedCodeCacheSize=<span class="number">240</span>m -XX:+UseCompressedOops -Dfile.encoding=UTF<span class="number">-8</span> -XX:+UseConcMarkSweepGC -XX:SoftRefLRUPolicyMSPerMB=<span class="number">50</span> -ea -Dsun.io.useCanonCaches=<span class="literal">false</span> -Djava.net.preferIPv4Stack=<span class="literal">true</span> -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Xverify:none -XX:ErrorFile=<span class="regexp">/Users/</span>leesin/java_error_in_idea_%p.log -XX:HeapDumpPath=<span class="regexp">/Users/</span>leesin/java_error_in_idea.hprof -javaagent:<span class="regexp">/Applications/</span>IntelliJ IDEA.app/Contents/bin/JetbrainsCrack.jar -Djb.vmOptionsFile=<span class="regexp">/Applications/</span>IntelliJ IDEA.app/Contents/bin/idea.vmoptions -Didea.java.redist=jdk-bundled -Didea.home.path=<span class="regexp">/Applications/</span>IntelliJ IDEA.app/Contents -Didea.executable=idea -Didea.paths.selector=IntelliJIdea2018<span class="number">.1</span></span><br><span class="line"><span class="number">31644</span> Jps -Dapplication.home=<span class="regexp">/Library/</span>Java/JavaVirtualMachines/jdk1<span class="number">.8</span><span class="number">.0</span>_202.jdk/Contents/Home -Xms8m</span><br><span class="line"><span class="number">26588</span> OsxApp -Dapple.laf.useScreenMenuBar=<span class="literal">true</span> -Xms512m</span><br></pre></td></tr></table></figure><h2 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h2><p>å¯ä»¥ç”¨æ¥æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„Javaåº”ç”¨ç¨‹åºçš„æ‰©å±•å‚æ•°ï¼Œç”šè‡³æ”¯æŒåœ¨è¿è¡Œæ—¶ï¼Œä¿®æ”¹éƒ¨åˆ†å‚æ•°<br>-flag<name>ï¼šæ‰“å°æŒ‡å®šJVMçš„å‚æ•°å€¼<br>-flag [+|-]<name>ï¼šè®¾ç½®æŒ‡å®šJVMå‚æ•°çš„å¸ƒå°”å€¼<br>-flag<name>=<value>ï¼šè®¾ç½®æŒ‡å®šJVMå‚æ•°çš„å€¼</value></name></name></name></p><h3 id="ä¸¾ä¸ªæ —å­-1"><a href="#ä¸¾ä¸ªæ —å­-1" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p>2972æ˜¯è¿›ç¨‹å·<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ˜¾ç¤ºäº†æ–°ç”Ÿä»£å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„æœ€å¤§å¹´é¾„</span><br><span class="line">jinfo -flag MaxTenuringThreshold <span class="number">2972</span></span><br><span class="line">-XX:MaxTenuringThreshold=<span class="number">15</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ˜¾ç¤ºæ˜¯å¦æ‰“å°GCè¯¦ç»†ä¿¡æ¯</span><br><span class="line">jinfo -flag PrintGCDetails  <span class="number">2972</span></span><br><span class="line">-XX:-PrintGCDetails</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">è¿è¡Œæ—¶ä¿®æ”¹å‚æ•°ï¼Œæ§åˆ¶æ˜¯å¦è¾“å‡ºGCæ—¥å¿—</span><br><span class="line">jinfo -flag PrintGCDetails  <span class="number">2972</span></span><br><span class="line">-XX:-PrintGCDetails</span><br><span class="line"></span><br><span class="line">jinfo -flag +PrintGCDetails  <span class="number">2972</span></span><br><span class="line"></span><br><span class="line">jinfo -flag PrintGCDetails  <span class="number">2972</span></span><br><span class="line">-XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><p>ç”ŸæˆJavaåº”ç”¨ç¨‹åºçš„å †å¿«ç…§å’Œå¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¿¡æ¯è¾“å‡ºåˆ°s.txt</span></span><br><span class="line">jmap -histo <span class="number">2972</span> &gt;c:\s.txt</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   <span class="number">1</span>:          <span class="number">4983</span>        <span class="number">6057848</span>  [I</span><br><span class="line">   <span class="number">2</span>:         <span class="number">20929</span>        <span class="number">2473080</span>  &lt;constMethodKlass&gt;</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦.</span><br><span class="line"><span class="number">1932</span>:             <span class="number">1</span>              <span class="number">8</span>  sun.java2d.pipe.AlphaColorPipe</span><br><span class="line"><span class="number">1933</span>:             <span class="number">1</span>              <span class="number">8</span>  sun.reflect.GeneratedMethodAccessor64</span><br><span class="line">Total        <span class="number">230478</span>       <span class="number">22043360</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€s.txtå‘ç°ï¼Œ[I å ç”¨äº†å°†è¿‘6mçš„ç©ºé—´</p><h3 id="Dumpå †"><a href="#Dumpå †" class="headerlink" title="Dumpå †"></a>Dumpå †</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†å †ä¿¡æ¯dumpåˆ°ç³»ç»Ÿçš„æ–‡ä»¶ä¸­   hprofæ–‡ä»¶é€šè¿‡ç‰¹æ®Šçš„å·¥å…·æ‰“å¼€</span></span><br><span class="line">jmap -dump:format=b,file=c:\heap.hprof <span class="number">2972</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dumping heap to C:\heap.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15515831988264.png"></p><h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p>æ‰“å°çº¿ç¨‹dump<br>-l æ‰“å°é”ä¿¡æ¯<br>-m æ‰“å°javaå’Œnativeçš„å¸§ä¿¡æ¯<br>-F å¼ºåˆ¶dumpï¼Œå½“jstackæ²¡æœ‰å“åº”æ—¶ä½¿ç”¨</p><h3 id="ä¸¾ä¸ªæ —å­-2"><a href="#ä¸¾ä¸ªæ —å­-2" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack <span class="number">120</span> &gt;&gt;C:\a.txt</span><br></pre></td></tr></table></figure><p>tidæ˜¯javaä¸­çš„tidï¼Œæ“ä½œç³»ç»Ÿä¸­æœ¬çº¿ç¨‹çš„idæ˜¯nid<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">"main" #1 prio=6 os_prio=0 tid=0x0831c400 nid=0xecc runnable [0x0018f000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">at org.eclipse.swt.internal.win32.OS.WaitMessage(Native Method)</span><br><span class="line">at org.eclipse.swt.widgets.Display.sleep(Display.java:<span class="number">4657</span>)</span><br><span class="line">at org.eclipse.ui.application.WorkbenchAdvisor.eventLoopIdle(WorkbenchAdvisor.java:<span class="number">364</span>)</span><br><span class="line">at org.eclipse.ui.internal.ide.application.IDEWorkbenchAdvisor.eventLoopIdle(IDEWorkbenchAdvisor.java:<span class="number">917</span>)</span><br><span class="line">at org.eclipse.ui.internal.Workbench$<span class="number">3.</span>eventLoopIdle(Workbench.java:<span class="number">487</span>)</span><br><span class="line">at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$<span class="number">9.</span>run(PartRenderingEngine.java:<span class="number">1117</span>)</span><br><span class="line">at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:<span class="number">332</span>)</span><br><span class="line">at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.run(PartRenderingEngine.java:<span class="number">997</span>)</span><br><span class="line">at org.eclipse.e4.ui.internal.workbench.E4Workbench.createAndRunUI(E4Workbench.java:<span class="number">140</span>)</span><br><span class="line">at org.eclipse.ui.internal.Workbench$<span class="number">5.</span>run(Workbench.java:<span class="number">611</span>)</span><br><span class="line">at org.eclipse.core.databinding.observable.Realm.runWithDefault(Realm.java:<span class="number">332</span>)</span><br><span class="line">at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Workbench.java:<span class="number">567</span>)</span><br><span class="line">at org.eclipse.ui.PlatformUI.createAndRunWorkbench(PlatformUI.java:<span class="number">150</span>)</span><br><span class="line">at org.eclipse.ui.internal.ide.application.IDEApplication.start(IDEApplication.java:<span class="number">124</span>)</span><br><span class="line">at org.eclipse.equinox.internal.app.EclipseAppHandle.run(EclipseAppHandle.java:<span class="number">196</span>)</span><br><span class="line">at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(EclipseAppLauncher.java:<span class="number">110</span>)</span><br><span class="line">at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(EclipseAppLauncher.java:<span class="number">79</span>)</span><br><span class="line">at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:<span class="number">354</span>)</span><br><span class="line">at org.eclipse.core.runtime.adaptor.EclipseStarter.run(EclipseStarter.java:<span class="number">181</span>)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">at java.lang.reflect.Method.invoke(Unknown Source)</span><br><span class="line">at org.eclipse.equinox.launcher.Main.invokeFramework(Main.java:<span class="number">636</span>)</span><br><span class="line">at org.eclipse.equinox.launcher.Main.basicRun(Main.java:<span class="number">591</span>)</span><br><span class="line">at org.eclipse.equinox.launcher.Main.run(Main.java:<span class="number">1450</span>)</span><br></pre></td></tr></table></figure><p></p><h2 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h2><p>javaè‡ªå¸¦çš„<br>å›¾å½¢åŒ–ç›‘æ§å·¥å…·<br>å¯ä»¥æŸ¥çœ‹Javaåº”ç”¨ç¨‹åºçš„è¿è¡Œæ¦‚å†µï¼Œç›‘æ§å †ä¿¡æ¯ã€æ°¸ä¹…åŒºä½¿ç”¨æƒ…å†µã€ç±»åŠ è½½æƒ…å†µç­‰</p><ul><li>æ‰“å¼€æ–¹å¼<br>winï¼šjdk/binä¸‹åŒå‡»JConsole.exe<br>linux/macï¼šè¿è¡Œå‘½ä»¤<code>$JAVA_HOME/bin/jconsole</code>(è¿™é‡Œçš„$JAVA_HOMEæ˜¯jdkçš„è·¯å¾„)<br><img alt="" data-original="/images/15515832176371.png"></li></ul><p>é€‰ä¸­-ã€‹è¿æ¥<br><img alt="" data-original="/images/15515832271783.png"><br><img alt="" data-original="/images/15515832324623.png"></p><p>code cacheæ˜¯ç¼–è¯‘å®Œçš„nativeçš„ä»£ç ã€‚<br>å³ä¸Šè§’æœ‰æ‰§è¡Œgcçš„æŒ‰é’®ã€‚<br><img alt="" data-original="/images/15515832402734.png"></p><p>æ‰€ä»¥å»ºè®®ä»¥åå†™ä»£ç éƒ½ç»™çº¿ç¨‹èµ·ä¸€ä¸ªæ¯”è¾ƒå¥½å¬ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜çš„åå­—ã€‚</p><h2 id="Visual-VM"><a href="#Visual-VM" class="headerlink" title="Visual VM"></a>Visual VM</h2><p>Visual VMæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å¤šåˆä¸€æ•…éšœè¯Šæ–­å’Œæ€§èƒ½ç›‘æ§çš„å¯è§†åŒ–å·¥å…·<br>-æ‰“å¼€æ–¹å¼<br>winï¼šjdk/binä¸‹åŒå‡»jvisualvm.exe<br>linux/macï¼šè¿è¡Œå‘½ä»¤<code>$JAVA_HOME/bin/jvisualvm</code>(è¿™é‡Œçš„$JAVA_HOMEæ˜¯jdkçš„è·¯å¾„)<br>æœ¬åœ°-ã€‹VisualVM-ã€‹æ¦‚è¿°<br><img alt="" data-original="/images/15515832489585.png"></p><p>æœ¬åœ°-ã€‹VisualVM-ã€‹ç›‘è§†</p><p><img alt="" data-original="/images/15515832594207.png"><br>å³ä¸Šè§’æœ‰å¼ºåˆ¶æ‰§è¡Œgcå’Œå †dumpçš„æŒ‰é’®<br>æœ¬åœ°-ã€‹VisualVM-ã€‹çº¿ç¨‹<br><img alt="" data-original="/images/15515832693242.png"></p><p>çº¢è‰²éƒ¨åˆ†å¯ä»¥æ˜¾ç¤ºæ­»é”ï¼ŒåŒ…æ‹¬å³ä¸Šè§’æœ‰çº¿ç¨‹dumpçš„æŒ‰é’®</p><p>æ€§èƒ½ç›‘æ§ï¼šæ‰¾åˆ°å ç”¨CPUæ—¶é—´æœ€é•¿çš„æ–¹æ³•<br>æœ¬åœ°-ã€‹VisualVM-ã€‹æŠ½æ ·å™¨-ã€‹cpu</p><p><img alt="" data-original="/images/15515832853326.png"><br>æ ¹æ®cpuçš„æ—¶é—´è‡ªåŠ¨è¿›è¡Œæ’åº<br>invocationè°ƒç”¨æ¬¡æ•°</p><p>åˆ†æå †Dump<br>visualVmæœ¬èº«å°±æ˜¯ä¸€ä¸ªèƒ½å¤ŸæŸ¥çœ‹Dumpå †æ–‡ä»¶çš„å·¥å…·ï¼Œä¸‹å›¾å°±æ˜¯é€šè¿‡VisualVmæ‰“å¼€çš„Dumpæ–‡ä»¶çš„å†…å®¹<br><img alt="" data-original="/images/15515832936691.png"></p><p>å°é—®é¢˜ï¼Ÿ<br>è§‚å¯ŸJavaçº¿ç¨‹æ‰“å°</p><h1 id="å®æˆ˜åˆ†æ"><a href="#å®æˆ˜åˆ†æ" class="headerlink" title="å®æˆ˜åˆ†æ"></a>å®æˆ˜åˆ†æ</h1><h2 id="è¿è¡Œä¸€ç¨‹åºThreadBlockMainï¼ŒæœŸæœ›è¾“å‡ºHello-World-ï¼Œç»“æœåœ¨ç¨‹åºè¿è¡Œåï¼Œç¨‹åºå¡æ­»ï¼Œæ²¡æœ‰é¢„æœŸè¾“å‡ºã€‚"><a href="#è¿è¡Œä¸€ç¨‹åºThreadBlockMainï¼ŒæœŸæœ›è¾“å‡ºHello-World-ï¼Œç»“æœåœ¨ç¨‹åºè¿è¡Œåï¼Œç¨‹åºå¡æ­»ï¼Œæ²¡æœ‰é¢„æœŸè¾“å‡ºã€‚" class="headerlink" title="è¿è¡Œä¸€ç¨‹åºThreadBlockMainï¼ŒæœŸæœ›è¾“å‡ºHello,World ï¼Œç»“æœåœ¨ç¨‹åºè¿è¡Œåï¼Œç¨‹åºå¡æ­»ï¼Œæ²¡æœ‰é¢„æœŸè¾“å‡ºã€‚"></a>è¿è¡Œä¸€ç¨‹åºThreadBlockMainï¼ŒæœŸæœ›è¾“å‡ºHello,World ï¼Œç»“æœåœ¨ç¨‹åºè¿è¡Œåï¼Œç¨‹åºå¡æ­»ï¼Œæ²¡æœ‰é¢„æœŸè¾“å‡ºã€‚</h2><p><img alt="" data-original="/images/15515833015880.png"></p><p>å…ˆé€šè¿‡jpså‘½ä»¤æ‰¾åˆ°è¿›ç¨‹idï¼Œç„¶åå°†jstack dumpåˆ°æ–‡ä»¶ä¸­ï¼Œæ‰“å¼€æ–‡ä»¶ã€‚<br>å‘ç°ï¼šçº¿ç¨‹è¿˜æ˜¯RUNNABLEçš„çŠ¶æ€ï¼Œè¯´æ˜è¿˜åœ¨è¿è¡Œ<br>åœ¨ç­‰å¾…ä¸€ä¸ªsocketReceiverOrPeekDataè¯´æ˜åœ¨ç­‰å¾…æ¥å—ä¸€ä¸ªç½‘ç»œio<br>å†å¾€ä¸‹æœ‰ä¸€ä¸ªDatagramSocketImplè¯´æ˜æ˜¯åœ¨ç­‰å¾…ä¸€ä¸ªUDPçš„socket</p><h2 id="Javaç¨‹åºHoldCPUMainè¿è¡Œåï¼Œå‘ç°å ç”¨CPUå¾ˆé«˜ï¼Œå¸Œæœ›èƒ½æ‰¾åˆ°åŸå› ã€‚"><a href="#Javaç¨‹åºHoldCPUMainè¿è¡Œåï¼Œå‘ç°å ç”¨CPUå¾ˆé«˜ï¼Œå¸Œæœ›èƒ½æ‰¾åˆ°åŸå› ã€‚" class="headerlink" title="Javaç¨‹åºHoldCPUMainè¿è¡Œåï¼Œå‘ç°å ç”¨CPUå¾ˆé«˜ï¼Œå¸Œæœ›èƒ½æ‰¾åˆ°åŸå› ã€‚"></a>Javaç¨‹åºHoldCPUMainè¿è¡Œåï¼Œå‘ç°å ç”¨CPUå¾ˆé«˜ï¼Œå¸Œæœ›èƒ½æ‰¾åˆ°åŸå› ã€‚</h2><p><img alt="" data-original="/images/15515833093962.png"></p><p>å…ˆé€šè¿‡jpsæ‰¾åˆ°è¿›ç¨‹idâ€“ã€‹é€šè¿‡uptimeå‘ç°load averageï¼ˆç³»ç»Ÿå¹³å‡è´Ÿè½½ï¼‰æ¯”è¾ƒå¤§â€“ã€‹é€šè¿‡topå‘½ä»¤å‘ç°javaè¿›ç¨‹å ç”¨çš„cpuæ˜¯ç™¾åˆ†ä¹‹ç™¾<br><img alt="" data-original="/images/15515833167429.png"></p><p>é€šè¿‡pidstatå‘½ä»¤æŸ¥çœ‹pidä¸º3455çš„è¿›ç¨‹çš„cpuä½¿ç”¨æƒ…å†µå¹¶ä»¥çº¿ç¨‹çš„å½¢å¼è¾“å‡º<br><strong><font color="red">æ³¨æ„è¿™é‡Œçš„3467 </font></strong>ï¼šå› ä¸ºä¸‹é¢å°†ä¼šç”¨åˆ°jstackå‘½ä»¤ï¼Œå‘ç°é‡Œé¢æ˜¾ç¤ºçš„éƒ½æ˜¯ç”¨äº†åå…­è¿›åˆ¶è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥åº”è¯¥å°†å®ƒè½¬åŒ–æˆåå…­è¿›åˆ¶ï¼Œå³D8B<br><img alt="" data-original="/images/15515833243569.png"></p><p>é€šè¿‡jstackå‘½ä»¤æŸ¥çœ‹3455è¿›ç¨‹ï¼Œæ‰¾åˆ°äº†d8bè¿™ä¸ªçº¿ç¨‹ï¼Œå¾—çŸ¥é‡Œé¢çš„ç¬¬å…«è¡Œå‡ºç°äº†é—®é¢˜ã€‚</p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>æ­»é”çš„ç»“æœæ˜¯ï¼Œç¨‹åºå¡æ­»<br>å¯ä»¥ç”¨jstackæŸ¥æ‰¾æ­»é”</p><h3 id="å¦‚ä½•ä»jstackçš„è¾“å‡ºä¸­æ‰¾å‡ºæ­»é”"><a href="#å¦‚ä½•ä»jstackçš„è¾“å‡ºä¸­æ‰¾å‡ºæ­»é”" class="headerlink" title="å¦‚ä½•ä»jstackçš„è¾“å‡ºä¸­æ‰¾å‡ºæ­»é”"></a>å¦‚ä½•ä»jstackçš„è¾“å‡ºä¸­æ‰¾å‡ºæ­»é”</h3><p><img alt="" data-original="/images/15515833390623.png"><br><img alt="" data-original="/images/15515833429657.png"></p><p>å¦‚æœéå¸¸æ˜æ˜¾çš„èƒ½å¤Ÿæ‰¾æ‰“ä¸€ä¸ªç®€å•çš„æ­»é”ï¼Œä¼šè‡ªåŠ¨è¾“å‡ºå¦‚ä¸‹ï¼š<br><img alt="" data-original="/images/15515833486715.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ç³»ç»Ÿæ€§èƒ½ç›‘æ§&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿæ€§èƒ½ç›‘æ§&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿæ€§èƒ½ç›‘
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆå…­ï¼‰ï¼šç±»è£…è½½å™¨</title>
    <link href="http://mmmmmm.me/2019-03-01.html"/>
    <id>http://mmmmmm.me/2019-03-01.html</id>
    <published>2019-03-01T02:21:02.000Z</published>
    <updated>2019-03-01T23:32:09.918Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="classè£…è½½éªŒè¯æµç¨‹"><a href="#classè£…è½½éªŒè¯æµç¨‹" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹"></a>classè£…è½½éªŒè¯æµç¨‹</h1><h2 id="classè£…è½½éªŒè¯æµç¨‹-1"><a href="#classè£…è½½éªŒè¯æµç¨‹-1" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹"></a>classè£…è½½éªŒè¯æµç¨‹</h2><p>åŠ è½½<br>é“¾æ¥ï¼ˆéªŒè¯ã€å‡†å¤‡ã€è§£æï¼‰<br>åˆå§‹åŒ–</p><h2 id="classè£…è½½éªŒè¯æµç¨‹-åŠ è½½"><a href="#classè£…è½½éªŒè¯æµç¨‹-åŠ è½½" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹ -åŠ è½½"></a>classè£…è½½éªŒè¯æµç¨‹ -åŠ è½½</h2><p>è£…è½½ç±»çš„ç¬¬ä¸€ä¸ªé˜¶æ®µ<br>å–å¾—ç±»çš„äºŒè¿›åˆ¶æµ<br>è½¬ä¸ºæ–¹æ³•åŒºæ•°æ®ç»“æ„<br>åœ¨Javaå †ä¸­ç”Ÿæˆå¯¹åº”çš„java.lang.Classå¯¹è±¡</p><h2 id="classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-éªŒè¯"><a href="#classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-éªŒè¯" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ éªŒè¯"></a>classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ éªŒè¯</h2><h3 id="é“¾æ¥-gt-éªŒè¯"><a href="#é“¾æ¥-gt-éªŒè¯" class="headerlink" title="é“¾æ¥ -&gt; éªŒè¯"></a>é“¾æ¥ -&gt; éªŒè¯</h3><p>ç›®çš„ï¼šä¿è¯Classæµçš„æ ¼å¼æ˜¯æ­£ç¡®çš„</p><h4 id="æ–‡ä»¶æ ¼å¼çš„éªŒè¯"><a href="#æ–‡ä»¶æ ¼å¼çš„éªŒè¯" class="headerlink" title="æ–‡ä»¶æ ¼å¼çš„éªŒè¯"></a>æ–‡ä»¶æ ¼å¼çš„éªŒè¯</h4><p>æ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´<br>ç‰ˆæœ¬å·æ˜¯å¦åˆç†</p><h4 id="å…ƒæ•°æ®éªŒè¯ï¼ˆclassæ–‡ä»¶ç®€å•è¯­ä¹‰çš„éªŒè¯ï¼‰"><a href="#å…ƒæ•°æ®éªŒè¯ï¼ˆclassæ–‡ä»¶ç®€å•è¯­ä¹‰çš„éªŒè¯ï¼‰" class="headerlink" title="å…ƒæ•°æ®éªŒè¯ï¼ˆclassæ–‡ä»¶ç®€å•è¯­ä¹‰çš„éªŒè¯ï¼‰"></a>å…ƒæ•°æ®éªŒè¯ï¼ˆclassæ–‡ä»¶ç®€å•è¯­ä¹‰çš„éªŒè¯ï¼‰</h4><p>æ˜¯å¦æœ‰çˆ¶ç±»ï¼ˆæ¯”å¦‚æŸä¸ªç±»ç»§æ‰¿äº†æŸä¸ªç±»ï¼Œå¯æ˜¯è¿™ä¸ªç±»æ ¹æœ¬å°±æ˜¯ä¸å­˜åœ¨çš„ã€‚ï¼‰<br>ç»§æ‰¿äº†finalç±»ï¼Ÿï¼ˆç»§æ‰¿äº†finalçš„æ–¹æ³•æˆ–è€…ä¿®æ”¹äº†finalå±æ€§ï¼‰<br>éæŠ½è±¡ç±»å®ç°äº†æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•ï¼ˆéæŠ½è±¡ç±»å®ç°æ¥å£ä¸­æ‰€æœ‰çš„éæŠ½è±¡æ–¹æ³•ï¼‰</p><h4 id="å­—èŠ‚ç éªŒè¯-å¾ˆå¤æ‚"><a href="#å­—èŠ‚ç éªŒè¯-å¾ˆå¤æ‚" class="headerlink" title="å­—èŠ‚ç éªŒè¯ (å¾ˆå¤æ‚)"></a>å­—èŠ‚ç éªŒè¯ (å¾ˆå¤æ‚)</h4><p>è¿è¡Œæ£€æŸ¥<br>æ ˆæ•°æ®ç±»å‹å’Œæ“ä½œç æ•°æ®å‚æ•°å»åˆï¼ˆåˆ†é…äº†ä¸¤ä¸ªå­—çš„ç©ºé—´ï¼Œå¯æ˜¯è¿è¡Œçš„æ—¶å€™å¯èƒ½ä¸åªæ˜¯ä¸¤ä¸ªå­—ã€åˆ†é…äº†ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œå¯æ˜¯è¿è¡Œçš„æ—¶å€™å‘ç°å¾ˆå¤šçš„å±€éƒ¨å˜é‡ï¼‰<br>è·³è½¬æŒ‡ä»¤æŒ‡å®šåˆ°åˆç†çš„ä½ç½®ï¼ˆè·³è½¬è‡³é›¶è·³è½¬åˆ°å­—èŠ‚ç çš„ä¸€ä¸ªåç§»é‡ä¸Šé¢ï¼Œæ¯”å¦‚æœ¬æ¥å°±äº”åä¸ªå­—èŠ‚ï¼Œç»“æœè·³è½¬åˆ°ç¬¬äº”åä¸€ä¸ªå­—èŠ‚ä¸Šå»äº†ã€‚ï¼‰</p><h4 id="ç¬¦å·å¼•ç”¨éªŒè¯"><a href="#ç¬¦å·å¼•ç”¨éªŒè¯" class="headerlink" title="ç¬¦å·å¼•ç”¨éªŒè¯"></a>ç¬¦å·å¼•ç”¨éªŒè¯</h4><p>å¸¸é‡æ± ä¸­æè¿°ç±»æ˜¯å¦å­˜åœ¨ï¼ˆæ¯”å¦‚ä¸€ä¸ªç±»ç»§æ‰¿äº†æŸä¸ªç±»ï¼Œå¯æ˜¯è¿™ä¸ªæ¥å£æˆ–è€…ç±»å®é™…ä¸Šæ˜¯ä¸å­˜åœ¨ã€‚ï¼‰<br>è®¿é—®çš„æ–¹æ³•æˆ–å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”æœ‰è¶³å¤Ÿçš„æƒé™ï¼ˆè®¿é—®çš„æ–¹æ³•æˆ–è€…å­—æ®µçš„æƒé™æ˜¯å¦è¶³å¤Ÿï¼ˆpublic privateç­‰ï¼‰ï¼‰</p><h2 id="classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-å‡†å¤‡"><a href="#classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-å‡†å¤‡" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ å‡†å¤‡"></a>classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ å‡†å¤‡</h2><h4 id="åˆ†é…å†…å­˜ï¼Œå¹¶ä¸ºç±»è®¾ç½®åˆå§‹å€¼-ï¼ˆæ–¹æ³•åŒºä¸­ï¼‰"><a href="#åˆ†é…å†…å­˜ï¼Œå¹¶ä¸ºç±»è®¾ç½®åˆå§‹å€¼-ï¼ˆæ–¹æ³•åŒºä¸­ï¼‰" class="headerlink" title="åˆ†é…å†…å­˜ï¼Œå¹¶ä¸ºç±»è®¾ç½®åˆå§‹å€¼ ï¼ˆæ–¹æ³•åŒºä¸­ï¼‰"></a>åˆ†é…å†…å­˜ï¼Œå¹¶ä¸ºç±»è®¾ç½®åˆå§‹å€¼ ï¼ˆæ–¹æ³•åŒºä¸­ï¼‰</h4><p>public static int v=1;<br>åœ¨å‡†å¤‡é˜¶æ®µä¸­ï¼Œvä¼šè¢«è®¾ç½®ä¸º0<br>åœ¨åˆå§‹åŒ–çš„<clinit>ä¸­æ‰ä¼šè¢«è®¾ç½®ä¸º1<br>å¯¹äºstatic finalç±»å‹ï¼Œåœ¨å‡†å¤‡é˜¶æ®µå°±ä¼šè¢«èµ‹ä¸Šæ­£ç¡®çš„å€¼<br>public static final int v=1;</clinit></p><h2 id="classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-è§£æ"><a href="#classè£…è½½éªŒè¯æµç¨‹-é“¾æ¥-è§£æ" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ è§£æ"></a>classè£…è½½éªŒè¯æµç¨‹ -é“¾æ¥ è§£æ</h2><h4 id="ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨"><a href="#ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨" class="headerlink" title="ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨"></a>ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨</h4><p>ç¬¦å·å¼•ç”¨å°±æ˜¯å­—ç¬¦ä¸²ï¼Œé»˜è®¤çš„è¶…ç±»å°±æ˜¯java.lang.Objectï¼Œç¬¦å·å¼•ç”¨å°±æ˜¯åœ¨å¸¸äº®æ± é‡Œé¢æœ‰ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²çš„å†…å®¹å°±æ˜¯java.lang.Objectï¼Œç¬¦å·å¼•ç”¨å¹¶ä¸èƒ½è¢«ç”¨ï¼Œåªæ˜¯ä¸€ç§è¡¨ç¤ºçš„æ–¹å¼ï¼Œç›´æ¥å°±æ˜¯æŒ‡é’ˆæˆ–è€…åœ°å€åç§»é‡ï¼Œå› ä¸ºæœ€åä¸€å®šæ˜¯æŒ‡å‘ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œæ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ä¹‹åï¼Œclassæ‰èƒ½å¤Ÿç”¨è‡ªå·±éœ€è¦å¼•ç”¨çš„å†…å®¹ã€‚</p><p>ç¬¦å·å¼•ç”¨ï¼šå­—ç¬¦ä¸²å¼•ç”¨å¯¹è±¡ä¸ä¸€å®šè¢«åŠ è½½<br>ç›´æ¥å¼•ç”¨ï¼šæŒ‡é’ˆæˆ–è€…åœ°å€åç§»é‡å¼•ç”¨å¯¹è±¡ä¸€å®šåœ¨å†…å­˜</p><h2 id="classè£…è½½éªŒè¯æµç¨‹-â€“-åˆå§‹åŒ–"><a href="#classè£…è½½éªŒè¯æµç¨‹-â€“-åˆå§‹åŒ–" class="headerlink" title="classè£…è½½éªŒè¯æµç¨‹ â€“ åˆå§‹åŒ–"></a>classè£…è½½éªŒè¯æµç¨‹ â€“ åˆå§‹åŒ–</h2><p>æ‰§è¡Œç±»æ„é€ å™¨<clinit><br>staticå˜é‡ èµ‹å€¼è¯­å¥<br>static{}è¯­å¥<br>å­ç±»çš„<clinit>è°ƒç”¨å‰ä¿è¯çˆ¶ç±»çš„<clinit>è¢«è°ƒç”¨</clinit></clinit></clinit></p><p><clinit>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆä¸€ä¸ªçº¿ç¨‹è¿›å»ä¹‹åå…¶ä»–çš„ç­‰å¾…ï¼‰</clinit></p><h2 id="å°é—®é¢˜"><a href="#å°é—®é¢˜" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h2><p>Java.lang.NoSuchFieldErroré”™è¯¯å¯èƒ½åœ¨ä»€ä¹ˆé˜¶æ®µæŠ›å‡ºï¼Ÿ</p><h1 id="ä»€ä¹ˆæ˜¯ç±»è£…è½½å™¨ClassLoader"><a href="#ä»€ä¹ˆæ˜¯ç±»è£…è½½å™¨ClassLoader" class="headerlink" title="ä»€ä¹ˆæ˜¯ç±»è£…è½½å™¨ClassLoader"></a>ä»€ä¹ˆæ˜¯ç±»è£…è½½å™¨ClassLoader</h1><p>ClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»<br>ClassLoaderçš„å®ä¾‹å°†è¯»å…¥Javaå­—èŠ‚ç å°†ç±»è£…è½½åˆ°JVMä¸­<br>ClassLoaderå¯ä»¥å®šåˆ¶ï¼Œæ»¡è¶³ä¸åŒçš„å­—èŠ‚ç æµè·å–æ–¹å¼ï¼ˆç½‘ç»œä¸­ã€æ–‡ä»¶ä¸­ï¼‰<br>ClassLoaderè´Ÿè´£ç±»è£…è½½è¿‡ç¨‹ä¸­çš„åŠ è½½é˜¶æ®µï¼ˆè¿æ¥å’Œåˆå§‹åŒ–é˜¶æ®µæ˜¯å’ŒClassLoaderæ˜¯æ²¡æœ‰å…³ç³»çš„ï¼‰</p><h2 id="ClassLoaderçš„é‡è¦æ–¹æ³•"><a href="#ClassLoaderçš„é‡è¦æ–¹æ³•" class="headerlink" title="ClassLoaderçš„é‡è¦æ–¹æ³•"></a>ClassLoaderçš„é‡è¦æ–¹æ³•</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Class&lt;?&gt; loadClass(<span class="built_in">String</span> name) throws ClassNotFoundException</span><br></pre></td></tr></table></figure><p>æ ¹æ®åå­—åŠ è½½ä¸€ä¸ªclassï¼Œå¹¶è¿”å›è¿™ä¸ªclassç±»çš„ä¿¡æ¯ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected final Class&lt;?&gt; defineClass(byte[] b, int off, int len)</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªç±»ï¼Œå‚æ•°ï¼šbyteæ•°ç»„ã€åç§»é‡ã€é•¿åº¦ï¼Œä¸å…¬å¼€è°ƒç”¨ï¼Œbyteæ•°ç»„ä¸­æ˜¯äºŒè¿›åˆ¶çš„å­—èŠ‚ç ï¼ŒäºŒè¿›åˆ¶çš„æµä¿¡æ¯ï¼Œå°±æ˜¯classæ–‡ä»¶é‡Œé¢çš„å†…å®¹ï¼ŒæŠŠäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¿¡æ¯è½¬åŒ–æˆclassæ–‡ä»¶çš„å†…å®¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; findClass(<span class="built_in">String</span> name) throws ClassNotFoundException</span><br></pre></td></tr></table></figure><p>loadClasså›è°ƒè¯¥æ–¹æ³•ï¼Œå³loadClassé‡Œé¢ä¼šè°ƒç”¨findClassæ–¹æ³•ï¼Œå»åšç±»çš„æŸ¥æ‰¾ã€‚è‡ªå®šä¹‰ClassLoaderçš„æ¨èåšæ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected final Class&lt;?&gt; findLoadedClass(<span class="built_in">String</span> name)</span><br></pre></td></tr></table></figure><p>å¯»æ‰¾å·²ç»åŠ è½½çš„ç±»ï¼Œåªæœ‰æŸ¥æ‰¾ä¸åˆ°æ‰ä¼šåšåŠ è½½ï¼Œå¦‚æœå·²ç»åŠ è½½äº†ä¸ä¼šåšäºŒæ¬¡çš„åŠ è½½ã€‚</p><h1 id="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼"><a href="#JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼" class="headerlink" title="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼"></a>JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼</h1><p>BootStrap ClassLoader ï¼ˆå¯åŠ¨ClassLoaderï¼‰<br>Extension ClassLoader ï¼ˆæ‰©å±•ClassLoaderï¼‰<br>App ClassLoader ï¼ˆåº”ç”¨ClassLoader/ç³»ç»ŸClassLoaderï¼‰<br>Custom ClassLoader(è‡ªå®šä¹‰ClassLoader)</p><p>æ¯ä¸ªClassLoaderéƒ½æœ‰ä¸€ä¸ªParentä½œä¸ºçˆ¶äº²</p><h2 id="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-ååŒå·¥ä½œ"><a href="#JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-ååŒå·¥ä½œ" class="headerlink" title="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ ååŒå·¥ä½œ"></a>JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ ååŒå·¥ä½œ</h2><p><img alt="" data-original="/images/15514529271718.png"></p><p><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br>å½“æ‰¾ç±»çš„æ—¶å€™åœ¨å½“å‰çš„classloderæ‰¾ï¼Œå³AppClassLoaderï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¼šå°†æŸ¥æ‰¾çš„è¯·æ±‚ç»™çˆ¶ç±»ï¼ŒExtensionClassLoaderï¼Œå¦‚æœæœ‰åˆ™ExtensionClassLoaderåšåŠ è½½ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œå°†æŸ¥æ‰¾çš„è¯·æ±‚ç»™BootsTrapClassLoaderï¼Œæœ‰åˆ™åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¯´æ˜è¿™ä¸ªç±»çš„æ•´ä¸ªClassLoaderçš„æ•´ä¸ªç³»åˆ—ä¸­éƒ½æ²¡æœ‰è¿™ä¸ªç±»ï¼Œå®ƒå°±ä¼šå°è¯•å»åŠ è½½ã€‚<br>åŠ è½½çš„æ–¹æ³•æ˜¯ä»ä¸Šå¾€ä¸‹çš„ï¼Œå¹¶ä¸æ˜¯APPClassLoaderæ‰¾ä¸åˆ°å°±è®©APPClassLoaderåšåŠ è½½ï¼Œå…ˆç”±BootsTrapClassLoaderåšåŠ è½½ï¼Œå¦‚æœBootsTrapClassLoaderåŠ è½½æˆåŠŸäº†ï¼Œä¸‹é¢çš„ClassLoaderå°±ä¸åšäº‹æƒ…ï¼Œå¦‚æœBootsTrapClassLoaderæ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå°±è®©ExtensionClassLoaderï¼ŒåšåŠ è½½ï¼Œå¦‚æœExtensionClassLoaderæ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå†è®©APPClassLoaderåŠ è½½ã€‚ç”±æ­¤å¯è§ï¼Œå¦‚æœä¸€ä¸ªclassç”±BootsTrapClassLoaderåŠ è½½ä¹‹åï¼Œå†å»è¯¢é—®ï¼Œåœ¨ExtensionClassLoaderä¸­æ˜¯æ²¡æœ‰çš„ï¼Œå› ä¸ºä¸æ˜¯ç¬¬ä¸€ä¸ªå°è¯•åŠ è½½çš„ClassLoader</p><ul><li>BootsTrapClassLoader ä¸­æ˜¯$JAVA_HOME/jre/lib/rt.jarä¸­çš„å†…å®¹ï¼Œé€šå¸¸æ˜¯javaä¸­çš„ç³»ç»Ÿæ ¸å¿ƒç±»ï¼ŒåŒæ ·å¯ä»¥å†å¯åŠ¨jarçš„æ—¶å€™é€šè¿‡-Xbootsclasspathï¼Œä½¿å¾—åé¢çš„classæ–‡ä»¶é€šè¿‡BootsTrapClassLoaderåŠ è½½</li><li>ExtensionClassLoaderåŠ è½½$JAVAHOME/lib/ext/*.jarä¸­çš„classå†…å®¹</li><li>APPClassLoaderåŠ è½½æ¥è‡ªåœ¨å‘½ä»¤javaä¸­çš„classpathæˆ–è€…java.class.pathç³»ç»Ÿå±æ€§æˆ–è€…CLASSPATHæ“ä½œç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„JARç±»åŒ…å’Œç±»è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨åˆ°çš„classpathè·¯å¾„<br><strong><font color="red">classpathçš„é»˜è®¤è·¯å¾„æ˜¯å½“å‰è·¯å¾„</font></strong><h2 id="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-ååŒå·¥ä½œ-1"><a href="#JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-ååŒå·¥ä½œ-1" class="headerlink" title="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ ååŒå·¥ä½œ"></a>JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ ååŒå·¥ä½œ</h2></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected synchronized Class&lt;?&gt; loadClass(<span class="built_in">String</span> var1, boolean var2) throws ClassNotFoundException &#123;</span><br><span class="line"><span class="comment">//æŸ¥çœ‹æ˜¯å¦åŠ è½½äº†ç±»var1ï¼ŒåŠ è½½è¿‡çš„è¯è¿”å›classï¼Œç¡®ä¿ç±»åªåŠ è½½ä¸€æ¬¡ã€‚</span></span><br><span class="line">        Class var3 = <span class="keyword">this</span>.findLoadedClass(var1);</span><br><span class="line">        <span class="comment">//å¦‚æœæ‰¾ä¸åˆ°</span></span><br><span class="line">        <span class="keyword">if</span> (var3 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è¯·æ±‚çˆ¶ç±»åšåŠ è½½</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    var3 = <span class="keyword">this</span>.parent.loadClass(var1, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    var3 = <span class="keyword">this</span>.findBootstrapClassOrNull(var1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">                ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (var3 == <span class="literal">null</span>) &#123;</span><br><span class="line">                var3 = <span class="keyword">this</span>.findClass(var1);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p><img alt="" data-original="/images/15514529527185.png"><br>æè¿°:èµ·åˆæ˜¯å·¦è¾¹çš„HelloLoaderåœ¨å¦‚å›¾çš„åŒ…ä¸‹é¢ï¼Œä¹‹åå†åœ¨æœ¬æœºçš„clzç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªHelloLoader(çº¢è‰²éƒ¨åˆ†)</p><ul><li>ç›´æ¥è¿è¡Œä»¥ä¸Šä»£ç ï¼š<br>è¾“å‡ºï¼šI am in apploader</li><li>åŠ ä¸Šå‚æ•° -Xbootclasspath/a:D:/tmp/clz<br>è¾“å‡ºï¼šI am in bootloader<br>æ­¤æ—¶AppLoaderä¸­ä¸ä¼šåŠ è½½HelloLoader<br>I am in apploader åœ¨classpathä¸­å´æ²¡æœ‰åŠ è½½<br>è¯´æ˜ç±»åŠ è½½æ˜¯ä»ä¸Šå¾€ä¸‹çš„</li></ul><p>è§£æï¼š<br><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br><strong><font color="red">æ³¨æ„ï¼šå‘ä¸ŠæŸ¥æ‰¾ï¼Œä¸æ˜¯æŸ¥æ‰¾è¿™ä¸ªç±»å­˜åœ¨ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æŸ¥æ‰¾ç±»è¢«åŠ è½½äº†æ²¡æœ‰ï¼ï¼ï¼</font></strong><br><strong><font color="red">classpathçš„é»˜è®¤è·¯å¾„æ˜¯å½“å‰è·¯å¾„ </font></strong>ï¼Œ</p><ul><li><p>æ²¡æœ‰åŠ å…¥-Xbootclasspath/a:D:/tmp/clzå‘½ä»¤çš„æ—¶å€™<br>é¦–æ¬¡è‚¯å®šéƒ½æ²¡æœ‰è¢«åŠ è½½ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¾æ¬¡é€šè¿‡BootsTrapClassLoaderï¼ˆrt.jar/- XbootClasspathï¼Œå‘ç°æ²¡æœ‰ï¼‰ï¼ŒExtensionClassLoader ï¼ˆlib/extï¼Œè¿˜æ˜¯æ²¡æœ‰ï¼‰ï¼Œæœ€ååŠ è½½APPCLassLoaderï¼ˆå› ä¸º <strong><font color="red">classpathçš„é»˜è®¤è·¯å¾„æ˜¯å½“å‰è·¯å¾„ </font></strong>ï¼Œæ‰€ä»¥èƒ½å¤ŸåŠ è½½åˆ°ï¼‰ï¼Œæœ€åè¾“å‡ºäº†I am in apploader</p></li><li><p>åŠ å…¥-Xbootclasspath/a:D:/tmp/clzå‚æ•°<br>æŸ¥æ‰¾åŒä¸Šï¼Œé¦–æ¬¡åŠ è½½æŸ¥æ‰¾ä¸€åœˆéƒ½æ²¡æœ‰æŸ¥æ‰¾åˆ°è¢«åŠ è½½ï¼Œç„¶åä»ä¸Šå¾€ä¸‹åŠ è½½ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºè®¾ç½®äº†BootsTrapClassLoaderçš„å‚æ•°ï¼Œæ‰€ä»¥åœ¨BootsTrapClassLoaderå±‚é¢å°±å·²ç»èƒ½å¤Ÿè¢«åŠ è½½åˆ°äº†ï¼Œä¸‹é¢ä¹Ÿä¸ä¼šå†è¢«åŠ è½½ï¼Œæ‰€ä»¥è¾“å‡ºI am in bootloader</p></li></ul><h3 id="å¼ºåˆ¶åœ¨apploaderä¸­åŠ è½½"><a href="#å¼ºåˆ¶åœ¨apploaderä¸­åŠ è½½" class="headerlink" title="å¼ºåˆ¶åœ¨apploaderä¸­åŠ è½½"></a>å¼ºåˆ¶åœ¨apploaderä¸­åŠ è½½</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) throws Exception &#123;</span><br><span class="line">ClassLoader cl=FindClassOrder2.class.getClassLoader();</span><br><span class="line"><span class="comment">//å¾—åˆ°geym.jvm.ch6.findorder.HelloLoaderçš„å­—èŠ‚ç </span></span><br><span class="line">byte[] bHelloLoader=loadClassBytes(<span class="string">"geym.jvm.ch6.findorder.HelloLoader"</span>);</span><br><span class="line"><span class="comment">//ä¸ºç”šä¹ˆé€šè¿‡åå°„å¾—åˆ°è¿™ä¸ªå‡½æ•°ï¼Ÿå› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯protectçš„</span></span><br><span class="line">Method md_defineClass=ClassLoader.class.getDeclaredMethod(<span class="string">"defineClass"</span>, byte[].class,int.class,int.class);</span><br><span class="line"><span class="comment">//setä¸ºtrueèƒ½å¤Ÿä½¿ç”¨</span></span><br><span class="line"><span class="comment">//å°†æ­¤å¯¹è±¡çš„ accessible æ ‡å¿—è®¾ç½®ä¸ºæŒ‡ç¤ºçš„å¸ƒå°”å€¼ã€‚</span></span><br><span class="line"><span class="comment">//å€¼ä¸º true åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶åº”è¯¥å–æ¶ˆ Java è¯­è¨€è®¿é—®æ£€æŸ¥ã€‚</span></span><br><span class="line"><span class="comment">//å€¼ä¸º false åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åº”è¯¥å®æ–½ Java è¯­è¨€è®¿é—®æ£€æŸ¥ã€‚ </span></span><br><span class="line">md_defineClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">md_defineClass.invoke(cl, bHelloLoader,<span class="number">0</span>,bHelloLoader.length);</span><br><span class="line">md_defineClass.setAccessible(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">HelloLoader loader = <span class="keyword">new</span> HelloLoader();</span><br><span class="line">System.out.println(loader.getClass().getClassLoader());</span><br><span class="line">loader.print();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾ç„¶æ·»åŠ å‚æ•°-Xbootclasspath/a:D:/tmp/clz<br>è¾“å‡ºï¼šI am in apploader</p><p>åœ¨æŸ¥æ‰¾ç±»çš„æ—¶å€™ï¼Œå…ˆåœ¨åº•å±‚çš„LoaderæŸ¥æ‰¾ï¼Œæ˜¯ä»ä¸‹å¾€ä¸Šçš„ã€‚å› ä¸ºåœ¨APPLoaderå·²ç»åŠ è½½äº†ï¼Œæ‰€ä»¥Apploaderèƒ½æ‰¾åˆ°ï¼Œå°±ä¸ä¼šå»ä¸Šå±‚åŠ è½½å™¨åŠ è½½</p><h3 id="å°é—®é¢˜-1"><a href="#å°é—®é¢˜-1" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h3><p>èƒ½å¦åªç”¨åå°„ï¼Œä»¿ç…§ä¸Šé¢çš„å†™æ³•ï¼Œå°†ç±»æ³¨å…¥å¯åŠ¨ClassLoaderå‘¢ï¼Ÿ</p><h2 id="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-é—®é¢˜"><a href="#JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-é—®é¢˜" class="headerlink" title="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ é—®é¢˜"></a>JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ é—®é¢˜</h2><p><img alt="" data-original="/images/15514529646549.png"></p><p>å¦‚ä¸Šå›¾ï¼Œæ¥å£ä½äºrt.jar,å®ç°ç±»ä½äºAPPClassLoaderï¼Œå¦‚æœæƒ³è¦å®ç°è¿™ä¸ªç±»ï¼Œå¿…é¡»è¦åœ¨BootsTrapClassLoaderä¸­çŸ¥é“ä¸‹é¢å³APPClassLoaderä¸­çš„å†…å®¹ï¼Œå¯æ˜¯è¿™ç§åŒäº²å§”æ´¾çš„æœºåˆ¶ï¼Œè‡ªåº•å‘ä¸Šæ£€æŸ¥æ˜¯å¦è¢«å¤¹åœ¨ï¼ŒAPPClassLoaderå¯ä»¥çŸ¥é“BootsTrapClassLoaderä¸­çš„å†…å®¹ï¼ŒåŠ è½½æ˜¯è‡ªé¡¶å‘ä¸‹ï¼ŒåŠ è½½äº†BootsTrapClassLoaderä¹‹åå°±ä¸èƒ½å†åŠ è½½ExtensionClassLoaderå’ŒAPPClassLoaderï¼Œä¹Ÿå°±ä¸èƒ½çŸ¥é“APPClassLoaderä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥æ°¸è¿œæ— æ³•çŸ¥é“ã€‚</p><h2 id="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-è§£å†³"><a href="#JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼-â€“-è§£å†³" class="headerlink" title="JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ è§£å†³"></a>JDKä¸­ClassLoaderé»˜è®¤è®¾è®¡æ¨¡å¼ â€“ è§£å†³</h2><ul><li>Thread. setContextClassLoader()<br>ä¸Šä¸‹æ–‡åŠ è½½å™¨<br><strong><font color="red">æ˜¯ä¸€ä¸ªè§’è‰²</font></strong><br>è§£é‡Šï¼šè§’è‰²æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå°æ˜æ˜¯ç­é‡Œçš„ä¸€ä¸ªæˆå‘˜ï¼Œä»–çš„èŒåŠ¡æ˜¯ç­é•¿ï¼Œå°æ˜æ˜¯ClassLoaderï¼Œç­é•¿å°±æ˜¯è§’è‰²ã€‚<br>ç”¨ä»¥è§£å†³é¡¶å±‚ClassLoaderæ— æ³•è®¿é—®åº•å±‚ClassLoaderçš„ç±»çš„é—®é¢˜<br>åŸºæœ¬æ€æƒ³æ˜¯ï¼Œåœ¨é¡¶å±‚ClassLoaderä¸­ï¼Œä¼ å…¥åº•å±‚ClassLoaderçš„å®ä¾‹</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tatic private Class getProviderClass(<span class="built_in">String</span> className, ClassLoader cl,</span><br><span class="line">        boolean doFallback, boolean useBSClsLoader) throws ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (useBSClsLoader) &#123;</span><br><span class="line">                <span class="keyword">return</span> Class.forName(className, <span class="literal">true</span>, FactoryFinder.class.getClassLoader());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cl = ss.getContextClassLoader();</span><br><span class="line">                <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> cl.loadClass(className); <span class="comment">//ä½¿ç”¨ä¸Šä¸‹æ–‡ClassLoader</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cl.loadClass(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassNotFoundException e1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (doFallback) &#123;</span><br><span class="line">            <span class="comment">// Use current class loader - should always be bootstrap CL</span></span><br><span class="line">            <span class="keyword">return</span> Class.forName(className, <span class="literal">true</span>, FactoryFinder.class.getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">â€¦..</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢ä»£ç ä¸­çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> cl.loadClass(className);</span><br></pre></td></tr></table></figure><p>ä¸­çš„clå°±æ˜¯ContextClassLoader</p><p>ä»£ç æ¥è‡ªäºrt.jarä¸­çš„<br>javax.xml.parsers.FactoryFinder<br>å±•ç¤ºå¦‚ä½•åœ¨å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½AppLoaderçš„ç±»</p><p>ä¸Šä¸‹æ–‡ClassLoaderå¯ä»¥çªç ´åŒäº²æ¨¡å¼çš„å±€é™æ€§</p><h2 id="åŒäº²æ¨¡å¼çš„ç ´å"><a href="#åŒäº²æ¨¡å¼çš„ç ´å" class="headerlink" title="åŒäº²æ¨¡å¼çš„ç ´å"></a>åŒäº²æ¨¡å¼çš„ç ´å</h2><p><strong><font color="red">åŒäº²æ¨¡å¼æ˜¯é»˜è®¤çš„æ¨¡å¼ï¼Œä½†ä¸æ˜¯å¿…é¡»è¿™ä¹ˆåš</font></strong><br>Tomcatçš„WebappClassLoader å°±ä¼šå…ˆåŠ è½½è‡ªå·±çš„Classï¼Œæ‰¾ä¸åˆ°å†å§”æ‰˜parent<br>OSGiçš„ClassLoaderå½¢æˆç½‘çŠ¶ç»“æ„ï¼Œæ ¹æ®éœ€è¦è‡ªç”±åŠ è½½Classï¼Œå› ä¸ºä»–æ˜¯çƒ­åŠ è½½ï¼Œä¸€ä¼šåŠ è½½äº†ä¸€ä¼šåˆä¸åŠ è½½äº†ï¼Œæ‰€ä»¥å°±æ˜¯ç½‘çŠ¶ç»“æ„ã€‚</p><h3 id="ä¸¾ä¸ªæ —å­-1"><a href="#ä¸¾ä¸ªæ —å­-1" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p>ç ´ååŒäº²æ¨¡å¼ä¾‹å­- å…ˆä»åº•å±‚ClassLoaderåŠ è½½<br>OrderClassLoaderçš„éƒ¨åˆ†å®ç°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected synchronized Class&lt;?&gt; loadClass(<span class="built_in">String</span> name, boolean resolve) throws ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">    <span class="comment">//ç°åœ¨è‡ªå·±çš„å±‚é¢æŸ¥æ‰¾ï¼Œ</span></span><br><span class="line">    Class re=findClass(name);</span><br><span class="line">    <span class="comment">//æ‰¾ä¸åˆ°å†å»æ‰¾çˆ¶ç±»</span></span><br><span class="line">    <span class="keyword">if</span>(re==<span class="literal">null</span>)&#123;</span><br><span class="line">        System.out.println(â€œæ— æ³•è½½å…¥ç±»:â€+name+â€œ éœ€è¦è¯·æ±‚çˆ¶åŠ è½½å™¨<span class="string">");</span></span><br><span class="line"><span class="string">        return super.loadClass(name,resolve);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return re;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; findClass(<span class="built_in">String</span> className) throws ClassNotFoundException &#123;</span><br><span class="line"><span class="comment">//åœ¨è‡ªå·±å±‚é¢ä¸Šæ‰¾æ˜¯å¦åŠ è½½äº†ç±»</span></span><br><span class="line">Class clazz = <span class="keyword">this</span>.findLoadedClass(className);</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> == clazz) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">String</span> classFile = getClassFile(className);</span><br><span class="line">        <span class="comment">//æ²¡æœ‰çš„è¯å°±åœ¨è‡ªå·±çš„å±‚é¢ä¸ŠåŠ è½½æŸä¸ªæ–‡ä»¶</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(classFile);</span><br><span class="line">        FileChannel fileC = fis.getChannel();</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        WritableByteChannel outC = Channels.newChannel(baos);</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line">         çœç•¥éƒ¨åˆ†ä»£ç </span><br><span class="line">        fis.close();</span><br><span class="line">        byte[] bytes = baos.toByteArray();</span><br><span class="line"><span class="comment">//å®šä¹‰æŸä¸ªç±»</span></span><br><span class="line">        clazz = defineClass(className, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¾¾åˆ°äº†ä»è‡ªå·±å¼€å§‹åŠ è½½çš„ç›®çš„<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OrderClassLoader myLoader=<span class="keyword">new</span> OrderClassLoader(<span class="string">"D:/tmp/clz/"</span>);</span><br><span class="line">Class clz=myLoader.loadClass(<span class="string">"geym.jvm.ch6.classloader.DemoA"</span>);</span><br><span class="line">System.out.println(clz.getClassLoader());</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"==== Class Loader Tree ===="</span>);</span><br><span class="line">ClassLoader cl=myLoader;</span><br><span class="line"><span class="keyword">while</span>(cl!=<span class="literal">null</span>)&#123;</span><br><span class="line">    System.out.println(cl);</span><br><span class="line">    cl=cl.getParent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ava.io.FileNotFoundException: D:\tmp\clz\java\lang\<span class="built_in">Object</span>.class (ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„è·¯å¾„ã€‚)</span><br><span class="line">at java.io.FileInputStream.open(Native Method)</span><br><span class="line">.....</span><br><span class="line">at geym.jvm.ch6.classloader.ClassLoaderTest.main(ClassLoaderTest.java:<span class="number">7</span>)</span><br><span class="line">æ— æ³•è½½å…¥ç±»:java.lang.Objectéœ€è¦è¯·æ±‚çˆ¶åŠ è½½å™¨</span><br><span class="line">geym.jvm.ch6.classloader.OrderClassLoader@<span class="number">18</span>f5824</span><br><span class="line">==== Class Loader Tree ====</span><br><span class="line">geym.jvm.ch6.classloader.OrderClassLoader@<span class="number">18</span>f5824</span><br><span class="line">sun.misc.Launcher$AppClassLoader@f4f44a</span><br><span class="line">sun.misc.Launcher$ExtClassLoader@<span class="number">1</span>d256fa</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ‰€æœ‰çš„ç±»éƒ½ç»§æ‰¿è‡ªObjectï¼Œå‰é¢çŸ¥é“éªŒè¯çš„è¿‡ç¨‹éœ€è¦å…ˆæ£€æŸ¥è‡ªå·±çš„çˆ¶ç±»æ˜¯å¦åŠ è½½ï¼Œå…ˆä»OrderClassLoaderåŠ è½½ï¼Œå³ä»æ–‡ä»¶ä¸­åŠ è½½Objectï¼Œæ‰¾ä¸åˆ°Objectï¼Œä¹‹åä½¿ç”¨appLoaderåŠ è½½Object<br>DemoAåœ¨ClassPathä¸­ï¼Œä½†ç”±OrderClassLoaderåŠ è½½ï¼Œè€Œä¸æ˜¯ç”±APPClassLoaderåŠ è½½</p><p>å¦‚æœOrderClassLoaderä¸é‡è½½loadClass()ï¼Œåªé‡è½½findClassï¼Œè¿˜æ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‚£ä¹ˆç¨‹åºè¾“å‡ºä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sun.misc.Launcher$AppClassLoader@b23210</span><br><span class="line">==== Class Loader Tree ====</span><br><span class="line">geym.jvm.ch6.classloader.OrderClassLoader@<span class="number">290</span>fbc</span><br><span class="line">sun.misc.Launcher$AppClassLoader@b23210</span><br><span class="line">sun.misc.Launcher$ExtClassLoader@f4f44a</span><br></pre></td></tr></table></figure><p>DemoAç”±AppClassLoaderåŠ è½½ï¼ŒObjectä¹Ÿèƒ½åŠ è½½åˆ°äº†</p><h1 id="çƒ­æ›¿æ¢"><a href="#çƒ­æ›¿æ¢" class="headerlink" title="çƒ­æ›¿æ¢"></a>çƒ­æ›¿æ¢</h1><ul><li>å«ä¹‰ï¼š<br>å½“ä¸€ä¸ªclassè¢«æ›¿æ¢åï¼Œç³»ç»Ÿæ— éœ€é‡å¯ï¼Œæ›¿æ¢çš„ç±»ç«‹å³ç”Ÿæ•ˆ<br>phpå°±æ˜¯çƒ­æ›¿æ¢çš„ã€‚<br>ä¾‹å­ï¼š<br>geym.jvm.ch6.hot.CVersionA</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CVersionA</span> </span>&#123;</span><br><span class="line">public <span class="keyword">void</span> sayHello() &#123;</span><br><span class="line">System.out.println(<span class="string">"hello world! (version A)"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>DoopRun ä¸åœè°ƒç”¨CVersionA . sayHello()æ–¹æ³•ï¼Œå› æ­¤æœ‰è¾“å‡ºï¼š<br>hello world! (version A)</li><li>åœ¨DoopRun çš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ›¿æ¢CVersionA ä¸ºï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CVersionA</span> </span>&#123;</span><br><span class="line">public <span class="keyword">void</span> sayHello() &#123;</span><br><span class="line">System.out.println(<span class="string">"hello world! (version B)"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ›¿æ¢åï¼Œ DoopRun çš„è¾“å‡ºå˜ä¸º<br>hello world! (version B)<br>æ€è€ƒï¼šåº”è¯¥å¦‚ä½•åšï¼Ÿ</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;classè£…è½½éªŒè¯æµç¨‹&quot;&gt;&lt;a href=&quot;#classè£…è½½éªŒè¯æµç¨‹&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆäº”ï¼‰ï¼šGCå‚æ•°</title>
    <link href="http://mmmmmm.me/2019-02-26.html"/>
    <id>http://mmmmmm.me/2019-02-26.html</id>
    <published>2019-02-26T02:21:02.000Z</published>
    <updated>2019-02-26T03:28:16.910Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å †çš„å›é¡¾"><a href="#å †çš„å›é¡¾" class="headerlink" title="å †çš„å›é¡¾"></a>å †çš„å›é¡¾</h1><p><img alt="" data-original="/images/15511509832393.png"></p><h1 id="ä¸²è¡Œæ”¶é›†å™¨"><a href="#ä¸²è¡Œæ”¶é›†å™¨" class="headerlink" title="ä¸²è¡Œæ”¶é›†å™¨"></a>ä¸²è¡Œæ”¶é›†å™¨</h1><ul><li>æœ€å¤è€ï¼Œæœ€ç¨³å®š</li><li>æ•ˆç‡é«˜</li><li>å¯èƒ½ä¼šäº§ç”Ÿè¾ƒé•¿çš„åœé¡¿ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼‰<br>-XX:+UseSerialGC<br>æ–°ç”Ÿä»£ã€è€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶<br>æ–°ç”Ÿä»£å¤åˆ¶ç®—æ³•<br>è€å¹´ä»£æ ‡è®°-å‹ç¼©<br><img alt="" data-original="/images/15511510020884.png"></li></ul><p>GCå…³é”®å­—ï¼šæ–°ç”Ÿä»£gcæ—¥å¿—<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.844</span>: [GC <span class="number">0.844</span>: [DefNew: <span class="number">17472</span>K-&gt;<span class="number">2176</span>K(<span class="number">19648</span>K), <span class="number">0.0188339</span> secs] <span class="number">17472</span>K-&gt;<span class="number">2375</span>K(<span class="number">63360</span>K),</span><br><span class="line"> <span class="number">0.0189186</span> secs] [Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.02</span> secs]</span><br></pre></td></tr></table></figure><p></p><p>Full GCå…³é”®å­—ï¼šè€å¹´ä»£gcæ—¥å¿—<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8.259</span>: [Full GC <span class="number">8.259</span>: [Tenured: <span class="number">43711</span>K-&gt;<span class="number">40302</span>K(<span class="number">43712</span>K), <span class="number">0.2960477</span> secs] <span class="number">63350</span>K-&gt;<span class="number">40302</span>K(<span class="number">63360</span>K), </span><br><span class="line">[Perm : <span class="number">17836</span>K-&gt;<span class="number">17836</span>K(<span class="number">32768</span>K)], <span class="number">0.2961554</span> secs] [Times: user=<span class="number">0.28</span> sys=<span class="number">0.02</span>, real=<span class="number">0.30</span> secs]</span><br></pre></td></tr></table></figure><p></p><h1 id="å¹¶è¡Œæ”¶é›†å™¨"><a href="#å¹¶è¡Œæ”¶é›†å™¨" class="headerlink" title="å¹¶è¡Œæ”¶é›†å™¨"></a>å¹¶è¡Œæ”¶é›†å™¨</h1><h2 id="ParNewï¼ˆpar-å¹¶è¡Œçš„ç¼©å†™ï¼Œnew-æ–°ç”Ÿä»£ï¼Œæ‰€ä»¥åªæ˜¯æ–°ç”Ÿä»£å¹¶è¡Œï¼‰"><a href="#ParNewï¼ˆpar-å¹¶è¡Œçš„ç¼©å†™ï¼Œnew-æ–°ç”Ÿä»£ï¼Œæ‰€ä»¥åªæ˜¯æ–°ç”Ÿä»£å¹¶è¡Œï¼‰" class="headerlink" title="ParNewï¼ˆpar-å¹¶è¡Œçš„ç¼©å†™ï¼Œnew-æ–°ç”Ÿä»£ï¼Œæ‰€ä»¥åªæ˜¯æ–°ç”Ÿä»£å¹¶è¡Œï¼‰"></a>ParNewï¼ˆpar-å¹¶è¡Œçš„ç¼©å†™ï¼Œnew-æ–°ç”Ÿä»£ï¼Œæ‰€ä»¥åªæ˜¯æ–°ç”Ÿä»£å¹¶è¡Œï¼‰</h2><ul><li>-XX:+UseParNewGC<br>æ–°ç”Ÿä»£å¹¶è¡Œ<br>è€å¹´ä»£ä¸²è¡Œ</li><li>Serialæ”¶é›†å™¨æ–°ç”Ÿä»£çš„å¹¶è¡Œç‰ˆæœ¬</li><li>å¤åˆ¶ç®—æ³•</li><li>å¤šçº¿ç¨‹ï¼Œéœ€è¦å¤šæ ¸æ”¯æŒ</li><li>-XX:ParallelGCThreads é™åˆ¶çº¿ç¨‹æ•°é‡</li></ul><p>å’Œä¸²è¡Œæ”¶é›†å™¨çš„åŒºåˆ«æ˜¯ï¼Œé€šè¿‡å¤šæ ¸æ”¯æŒå¤šçº¿ç¨‹ã€‚</p><p><img alt="" data-original="/images/15511510178352.png"><br>å¤šçº¿ç¨‹ä¸ä¸€å®šå¿«å“¦ï¼<br>å¦‚æœæ˜¯å¤šæ ¸ç”¨ParNewé€Ÿåº¦å¿«ä¸€ç‚¹ï¼Œå¦‚æœæ˜¯å•çº¿ç¨‹çš„è¯ï¼Œè¿˜æ˜¯å»ºè®®ä¸²è¡Œæ”¶é›†å™¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.834</span>: [GC <span class="number">0.834</span>: [ParNew: <span class="number">13184</span>K-&gt;<span class="number">1600</span>K(<span class="number">14784</span>K), <span class="number">0.0092203</span> secs] <span class="number">13184</span>K-&gt;<span class="number">1921</span>K(<span class="number">63936</span>K), </span><br><span class="line"><span class="number">0.0093401</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼šæœ‰ParNewå…³é”®å­—è¡¨ç¤ºParNewæ”¶é›†å™¨</font></strong></p><h2 id="Parallelæ”¶é›†å™¨"><a href="#Parallelæ”¶é›†å™¨" class="headerlink" title="Parallelæ”¶é›†å™¨"></a>Parallelæ”¶é›†å™¨</h2><ul><li>ç±»ä¼¼ParNew</li><li>æ–°ç”Ÿä»£å¤åˆ¶ç®—æ³•</li><li>è€å¹´ä»£ æ ‡è®°-å‹ç¼©</li><li>æ›´åŠ å…³æ³¨ååé‡ï¼ˆå’ŒParNewæ—¶å€™çš„åŒºåˆ«ï¼‰</li><li>-XX:+UseParallelGC<br>ä½¿ç”¨Parallelæ”¶é›†å™¨+ è€å¹´ä»£ä¸²è¡Œ+æ–°ç”Ÿä»£å¹¶è¡Œ</li><li>-XX:+UseParallelOldGC<br>ä½¿ç”¨Parallelæ”¶é›†å™¨+ å¹¶è¡Œè€å¹´ä»£+æ–°ç”Ÿä»£å¹¶è¡Œ<br><img alt="" data-original="/images/15511510299020.png"></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.500</span>: [Full GC [PSYoungGen: <span class="number">2682</span>K-&gt;<span class="number">0</span>K(<span class="number">19136</span>K)] [ParOldGen: <span class="number">28035</span>K-&gt;<span class="number">30437</span>K(<span class="number">43712</span>K)] <span class="number">30717</span>K-&gt;<span class="number">30437</span>K(<span class="number">62848</span>K) </span><br><span class="line">[PSPermGen: <span class="number">10943</span>K-&gt;<span class="number">10928</span>K(<span class="number">32768</span>K)], </span><br><span class="line"><span class="number">0.2902791</span> secs] [Times: user=<span class="number">1.44</span> sys=<span class="number">0.03</span>, real=<span class="number">0.30</span> secs]</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼šPSYoungGen ã€ParOldGenå…³é”®å­—</font></strong></p><h2 id="å‚æ•°è®¾ç½®"><a href="#å‚æ•°è®¾ç½®" class="headerlink" title="å‚æ•°è®¾ç½®"></a>å‚æ•°è®¾ç½®</h2><h3 id="XX-MaxGCPauseMills"><a href="#XX-MaxGCPauseMills" class="headerlink" title="-XX:MaxGCPauseMills"></a>-XX:MaxGCPauseMills</h3><p>æœ€å¤§åœé¡¿æ—¶é—´ï¼Œå•ä½æ¯«ç§’<br>GCå°½åŠ›ä¿è¯å›æ”¶æ—¶é—´ä¸è¶…è¿‡è®¾å®šå€¼</p><h3 id="XX-GCTimeRatio"><a href="#XX-GCTimeRatio" class="headerlink" title="-XX:GCTimeRatio"></a>-XX:GCTimeRatio</h3><p>0-100çš„å–å€¼èŒƒå›´<br>åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”<br>é»˜è®¤99ï¼Œå³æœ€å¤§å…è®¸1%æ—¶é—´åšGC</p><p>è¿™ä¸¤ä¸ªå‚æ•°æ˜¯çŸ›ç›¾çš„ã€‚å› ä¸ºåœé¡¿æ—¶é—´å’Œååé‡ä¸å¯èƒ½åŒæ—¶è°ƒä¼˜ã€‚</p><p>å¯¹äºè¿™å¥è¯çš„ç†è§£ï¼š<br>åœ¨gcçš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶çš„å·¥ä½œæ€»é‡æ˜¯ä¸€å®šçš„ï¼Œæ‰€ä»¥å°±æ˜¯èŠ±ä¸€å®šçš„æ—¶é—´åšä¸€å®šçš„äº‹æƒ…ï¼Œå¦‚æœgcçš„é¢‘ç‡æé«˜ï¼Œæ¯æ¬¡gcèŠ±çš„æ—¶é—´å°±ä¼šå˜å°‘ï¼Œå¯æ˜¯ç³»ç»Ÿçš„æ€§èƒ½ä¼šå—åˆ°æŸä¼¤ï¼Œå°±ä¼šå¯¼è‡´åœé¡¿çš„æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œå¯æ˜¯æ€»ä½“çš„æ€§èƒ½å¹¶ä¸æ˜¯å¾ˆå¥½ã€‚ä½†æ˜¯ï¼Œä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½ï¼Œgcå°‘åšå‡ æ¬¡ï¼Œä¹Ÿå°±æ˜¯XX:GCTimeRatioæ¯”å€¼ä¼šæ¯”è¾ƒå¤§ï¼Œgcæ—¶é—´è¾ƒå°‘ï¼Œæ‰€ä»¥æ¯æ¬¡çš„gcåœé¡¿çš„æ—¶é—´å°±ä¼šæ¯”è¾ƒé•¿ã€‚<br>ååé‡ï¼šä¸€èˆ¬è®¤ä¸ºç³»ç»Ÿçš„æ€§èƒ½æ˜¯å’Œååé‡æ¯æ¯ç›¸å…³çš„ï¼Œå•ä½æ—¶é—´å†…cpuæ˜¯åˆ†é…åˆ°äº†åº”ç”¨ç¨‹åºè¿˜æ˜¯gcï¼Œå¦‚æœcpuæ˜¯åˆ†é…åˆ°åº”ç”¨ç¨‹åºè¶Šå¤šï¼Œååé‡è¶Šé«˜ã€‚<br>ååé‡é«˜-&gt;gcå ç”¨cpuæ—¶é—´çŸ­-&gt;gcåœé¡¿çš„æ—¶é—´é•¿ã€‚<br>è¿™é‡Œæ—¢å¸Œæœ›gcçš„åœé¡¿æ—¶é—´çŸ­ä¸€ç‚¹ï¼Œåˆå¸Œæœ›ååé‡å¤§ä¸€ç‚¹ï¼Œæ‰€ä»¥æ˜¯çŸ›ç›¾çš„ï¼Œæ‰€ä»¥ä¸èƒ½åŒæ—¶è°ƒä¼˜ï¼Œæ‰€ä»¥æœ‰ä¾§é‡çš„è°ƒä¼˜ã€‚</p><h1 id="CMSæ”¶é›†å™¨"><a href="#CMSæ”¶é›†å™¨" class="headerlink" title="CMSæ”¶é›†å™¨"></a>CMSæ”¶é›†å™¨</h1><h2 id="CMSæ”¶é›†å™¨-1"><a href="#CMSæ”¶é›†å™¨-1" class="headerlink" title="CMSæ”¶é›†å™¨"></a>CMSæ”¶é›†å™¨</h2><p>Concurrent Mark Sweep å¹¶å‘æ ‡è®°æ¸…é™¤ï¼ˆ <strong><font color="red">ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·æ‰§è¡Œ </font></strong>ï¼‰<br>è¯•å›¾å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹ä¸€èµ·æ‰§è¡Œã€‚<br>æ ‡è®°-æ¸…é™¤ç®—æ³•<br>ä¸æ ‡è®°-å‹ç¼©ç›¸æ¯”ï¼ˆå› ä¸ºæ˜¯å¹¶è¡Œçš„ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿æ ‡è®°-å‹ç¼©çš„æ–¹å¼ï¼‰<br>å¹¶å‘é˜¶æ®µä¼šé™ä½ååé‡ï¼ˆåœé¡¿å‡å°‘äº†ï¼Œååé‡å°±ä¼šé™ä½ï¼‰<br>è€å¹´ä»£æ”¶é›†å™¨ï¼ˆæ–°ç”Ÿä»£ä½¿ç”¨ParNewï¼Œè¿™é‡ŒCMSæ˜¯ä¸€ä¸ªå•çº¯çš„è€å¹´ä»£çš„æ”¶é›†å™¨ï¼‰<br>-XX:+UseConcMarkSweepGC</p><h2 id="CMSè¿è¡Œè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç€é‡å®ç°äº†æ ‡è®°çš„è¿‡ç¨‹ï¼Œå¯åˆ†ä¸º"><a href="#CMSè¿è¡Œè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç€é‡å®ç°äº†æ ‡è®°çš„è¿‡ç¨‹ï¼Œå¯åˆ†ä¸º" class="headerlink" title="CMSè¿è¡Œè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç€é‡å®ç°äº†æ ‡è®°çš„è¿‡ç¨‹ï¼Œå¯åˆ†ä¸º"></a>CMSè¿è¡Œè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç€é‡å®ç°äº†æ ‡è®°çš„è¿‡ç¨‹ï¼Œå¯åˆ†ä¸º</h2><ul><li>åˆå§‹æ ‡è®°<br>æ ¹å¯ä»¥ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡<br>é€Ÿåº¦å¿«<br>ä¼šäº§ç”Ÿå…¨å±€åœé¡¿</li><li>å¹¶å‘æ ‡è®°ï¼ˆå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·ï¼‰<br>ä¸»è¦æ ‡è®°è¿‡ç¨‹ï¼Œæ ‡è®°å…¨éƒ¨å¯¹è±¡</li><li>é‡æ–°æ ‡è®°<br>ç”±äºå¹¶å‘æ ‡è®°æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹ä¾ç„¶è¿è¡Œï¼Œå› æ­¤åœ¨æ­£å¼æ¸…ç†å‰ï¼Œå†åšä¿®æ­£<br>ä¼šäº§ç”Ÿå…¨å±€åœé¡¿</li><li>å¹¶å‘æ¸…é™¤ï¼ˆå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·ï¼‰<br>åŸºäºæ ‡è®°ç»“æœï¼Œç›´æ¥æ¸…ç†å¯¹è±¡</li></ul><p>å¯ä»¥çœ‹åˆ°åˆå§‹æ ‡è®°ã€é‡æ–°æ ‡è®°éƒ½ä¼šäº§ç”Ÿå…¨å±€çš„åœé¡¿ï¼Œæ‰€ä»¥CMSè¿˜æ˜¯æ²¡æœ‰åŠæ³•å»æ‰æ‰€æœ‰çš„å…¨å±€åœé¡¿ï¼Œä½†æ˜¯å·²ç»å¤§å¤§çš„å‡å°äº†å…¨å±€åœé¡¿ã€‚<br><img alt="" data-original="/images/15511510454444.png"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.662</span>: [GC [<span class="number">1</span> CMS-initial-mark: <span class="number">28122</span>K(<span class="number">49152</span>K)] <span class="number">29959</span>K(<span class="number">63936</span>K), <span class="number">0.0046877</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="number">1.666</span>: [CMS-concurrent-mark-start]</span><br><span class="line"><span class="number">1.699</span>: [CMS-concurrent-mark: <span class="number">0.033</span>/<span class="number">0.033</span> secs] [Times: user=<span class="number">0.25</span> sys=<span class="number">0.00</span>, real=<span class="number">0.03</span> secs] </span><br><span class="line"><span class="number">1.699</span>: [CMS-concurrent-preclean-start]</span><br><span class="line"><span class="number">1.700</span>: [CMS-concurrent-preclean: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="number">1.700</span>: [GC[YG occupancy: <span class="number">1837</span> K (<span class="number">14784</span> K)]<span class="number">1.700</span>: [Rescan (parallel) , <span class="number">0.0009330</span> secs]<span class="number">1.701</span>: [weak refs processing, <span class="number">0.0000180</span> secs] [<span class="number">1</span> CMS-remark: <span class="number">28122</span>K(<span class="number">49152</span>K)] <span class="number">29959</span>K(<span class="number">63936</span>K), <span class="number">0.0010248</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="number">1.702</span>: [CMS-concurrent-sweep-start]</span><br><span class="line"><span class="number">1.739</span>: [CMS-concurrent-sweep: <span class="number">0.035</span>/<span class="number">0.037</span> secs] [Times: user=<span class="number">0.11</span> sys=<span class="number">0.02</span>, real=<span class="number">0.05</span> secs] </span><br><span class="line"><span class="number">1.739</span>: [CMS-concurrent-reset-start]</span><br><span class="line"><span class="number">1.741</span>: [CMS-concurrent-reset: <span class="number">0.001</span>/<span class="number">0.001</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br></pre></td></tr></table></figure><p>å…³é”®å­—ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CMS-initial-mark</span><br><span class="line">CMS-concurrent-mark</span><br><span class="line">CMS-remark</span><br><span class="line">CMS-concurrent-sweep</span><br><span class="line">CMS-concurrent-reset</span><br></pre></td></tr></table></figure><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><ul><li>å°½å¯èƒ½é™ä½åœé¡¿</li><li>ä¼šå½±å“ç³»ç»Ÿæ•´ä½“ååé‡å’Œæ€§èƒ½<br>æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ†ä¸€åŠCPUå»åšGCï¼Œç³»ç»Ÿæ€§èƒ½åœ¨GCé˜¶æ®µï¼Œååº”é€Ÿåº¦å°±ä¸‹é™ä¸€åŠ</li><li>æ¸…ç†ä¸å½»åº•<br>å› ä¸ºåœ¨æ¸…ç†é˜¶æ®µï¼Œç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œä¼šäº§ç”Ÿæ–°çš„åƒåœ¾ï¼Œæ— æ³•æ¸…ç†</li><li>å› ä¸ºå’Œç”¨æˆ·çº¿ç¨‹ä¸€èµ·è¿è¡Œï¼Œä¸èƒ½åœ¨ç©ºé—´å¿«æ»¡æ—¶å†æ¸…ç†<br>å¦‚æœæ˜¯ä¸²è¡Œæ¸…ç†ã€å¹¶è¡Œæ¸…ç†ï¼Œgcçš„æ—¶å€™ä¼šåœé¡¿ï¼Œgcå®Œæˆä¹‹åæœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥ç”³è¯·ï¼Œä½†æ˜¯CMSæ˜¯å’Œåº”ç”¨ç¨‹åºåŒæ—¶è¿›è¡Œçš„ï¼Œå½“ç©ºé—´å¿«æ»¡æ—¶æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ä¾›ç”³è¯·ã€‚<br>-XX:CMSInitiatingOccupancyFractionè®¾ç½®è§¦å‘GCçš„é˜ˆå€¼<br>å¦‚æœä¸å¹¸å†…å­˜é¢„ç•™ç©ºé—´ä¸å¤Ÿï¼Œå°±ä¼šå¼•èµ·concurrent mode failure</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">33.348</span>: [Full GC <span class="number">33.348</span>: [CMS33<span class="number">.357</span>: [CMS-concurrent-sweep: <span class="number">0.035</span>/<span class="number">0.036</span> secs] [Times: user=<span class="number">0.11</span> sys=<span class="number">0.03</span>, real=<span class="number">0.03</span> secs] </span><br><span class="line"> (concurrent mode failure): <span class="number">47066</span>K-&gt;<span class="number">39901</span>K(<span class="number">49152</span>K),</span><br><span class="line">  <span class="number">0.3896802</span> secs] <span class="number">60771</span>K-&gt;<span class="number">39901</span>K(<span class="number">63936</span>K), [CMS Perm : <span class="number">22529</span>K-&gt;<span class="number">22529</span>K(<span class="number">32768</span>K)],</span><br><span class="line">  <span class="number">0.3897989</span> secs] [Times: user=<span class="number">0.39</span> sys=<span class="number">0.00</span>, real=<span class="number">0.39</span> secs]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡ºç°concurrent mode failureé”™è¯¯ï¼Œè¡¨ç¤ºåœ¨CMSçš„æ—¶å€™ï¼Œå†…å­˜ç”³è¯·å¤±è´¥ã€‚<br>ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨ä½œä¸ºåå¤‡ï¼ŒåŠæ—¶å°†CMSæ”¶é›†è½¬åŒ–ä¸ºä¸²è¡Œæ”¶é›†ï¼Œä½†æ˜¯å› ä¸ºå‡ºç°è¿™ä¸ªé”™è¯¯è¯´æ˜å†…å­˜å·²ç»åˆ°äº†æ¶ˆè€—æ®†å°½çš„çŠ¶æ€ï¼Œæ‰€ä»¥åˆ‡æ¢ä¸ºä¸²è¡Œæ”¶é›†çš„æ—¶å€™å¯èƒ½ä¼šå‡ºç°é•¿æ—¶é—´çš„åœé¡¿ã€‚</p><h2 id="æœ‰å…³ç¢ç‰‡"><a href="#æœ‰å…³ç¢ç‰‡" class="headerlink" title="æœ‰å…³ç¢ç‰‡"></a>æœ‰å…³ç¢ç‰‡</h2><p>æ ‡è®°-æ¸…é™¤å’Œæ ‡è®°-å‹ç¼©<br><img alt="" data-original="/images/15511510634628.png"></p><p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°æ¸…é™¤ä¹‹åä¼šå‡ºç°ç¢ç‰‡ï¼Œå¦‚æœè¦ç”³è¯·äº”ä¸ªè¿ç»­å•ä½çš„ç©ºé—´ï¼Œæ˜¯ç”³è¯·ä¸åˆ°çš„ï¼Œè€Œæ ‡è®°å‹ç¼©æ¸…ç†ä¹‹åæ˜¯èƒ½å¤Ÿç”³è¯·åˆ°ï¼Œæ‰€ä»¥ä¸²è¡Œæ”¶é›†å’Œå¹¶è¡Œæ”¶é›†éƒ½æ˜¯æ ‡è®°å‹ç¼©çš„ï¼Œè€Œæ ‡è®°æ¸…ç†ç®—æ³•ä¹‹åä¸€èˆ¬å¯¹å‰©ä½™çš„ç©ºé—´ä¸€èˆ¬è¿˜è¦è¿›è¡Œä¸€æ¬¡å‹ç¼©ã€‚<br>å¯æ˜¯ä¸ºä»€ä¹ˆCMSæ˜¯ä½¿ç”¨çš„æ ‡è®°æ¸…é™¤ï¼Ÿå› ä¸ºå¸Œæœ›å’Œç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œæ ‡è®°å‹ç¼©åœ¨æ¸…ç†çš„æ—¶å€™éœ€è¦ç§»åŠ¨å¯ç”¨çš„å¯¹è±¡çš„ç©ºé—´ï¼Œåº”ç”¨å±‚çš„çº¿ç¨‹å¯èƒ½æ‰¾ä¸åˆ°å¯¹è±¡åœ¨å“ªé‡Œï¼Œä¸ºäº†èƒ½å¤Ÿå’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œ å°±éœ€è¦å¯ç”¨çš„å¯¹è±¡ä½ç½®æ˜¯æ²¡æœ‰æ”¹å˜çš„ã€‚</p><p>æ‰€ä»¥å‡ºç°å¦‚ä¸‹çš„é…ç½®ï¼š</p><h3 id="XX-UseCMSCompactAtFullCollection"><a href="#XX-UseCMSCompactAtFullCollection" class="headerlink" title="-XX:+ UseCMSCompactAtFullCollection"></a>-XX:+ UseCMSCompactAtFullCollection</h3><p>Full GCåï¼Œè¿›è¡Œä¸€æ¬¡æ•´ç†<br>æ•´ç†è¿‡ç¨‹æ˜¯ç‹¬å çš„ï¼Œä¼šå¼•èµ·åœé¡¿æ—¶é—´å˜é•¿</p><h3 id="XX-CMSFullGCsBeforeCompaction"><a href="#XX-CMSFullGCsBeforeCompaction" class="headerlink" title="-XX:+CMSFullGCsBeforeCompaction"></a>-XX:+CMSFullGCsBeforeCompaction</h3><p>è®¾ç½®è¿›è¡Œå‡ æ¬¡Full GCåï¼Œè¿›è¡Œä¸€æ¬¡ç¢ç‰‡æ•´ç†ï¼Œå½“ç¢ç‰‡å¾ˆå¤šçš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šåœé¡¿å¾ˆé•¿çš„æ—¶é—´ï¼Œæ‰€ä»¥ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ã€‚</p><h3 id="XX-ParallelCMSThreads"><a href="#XX-ParallelCMSThreads" class="headerlink" title="-XX:ParallelCMSThreads"></a>-XX:ParallelCMSThreads</h3><p>è®¾å®šCMSçš„çº¿ç¨‹æ•°é‡ï¼Œä¸€èˆ¬çº¦ç­‰äºCPUçš„æ•°é‡ã€‚</p><h1 id="GCå‚æ•°æ•´ç†"><a href="#GCå‚æ•°æ•´ç†" class="headerlink" title="GCå‚æ•°æ•´ç†"></a>GCå‚æ•°æ•´ç†</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseSerialGCï¼šåœ¨æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œæ”¶é›†å™¨</span><br><span class="line">-XX:SurvivorRatioï¼šè®¾ç½®edenåŒºå¤§å°å’ŒsurvivioråŒºå¤§å°çš„æ¯”ä¾‹</span><br><span class="line">-XX:NewRatio:æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”</span><br><span class="line">-XX:+UseParNewGCï¼šåœ¨æ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨</span><br><span class="line">-XX:+UseParallelGC ï¼šæ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨</span><br><span class="line">-XX:+UseParallelOldGCï¼šè€å¹´ä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶æ”¶é›†å™¨</span><br><span class="line">-XX:ParallelGCThreadsï¼šè®¾ç½®ç”¨äºåƒåœ¾å›æ”¶çš„çº¿ç¨‹æ•°</span><br><span class="line">-XX:+UseConcMarkSweepGCï¼šæ–°ç”Ÿä»£ä½¿ç”¨å¹¶è¡Œæ”¶é›†å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨CMS+ä¸²è¡Œæ”¶é›†å™¨</span><br><span class="line">-XX:ParallelCMSThreadsï¼šè®¾å®šCMSçš„çº¿ç¨‹æ•°é‡</span><br><span class="line">-XX:CMSInitiatingOccupancyFractionï¼šè®¾ç½®CMSæ”¶é›†å™¨åœ¨è€å¹´ä»£ç©ºé—´è¢«ä½¿ç”¨å¤šå°‘åè§¦å‘</span><br><span class="line">-XX:+UseCMSCompactAtFullCollectionï¼šè®¾ç½®CMSæ”¶é›†å™¨åœ¨å®Œæˆåƒåœ¾æ”¶é›†åæ˜¯å¦è¦è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡çš„æ•´ç†</span><br><span class="line">-XX:CMSFullGCsBeforeCompactionï¼šè®¾å®šè¿›è¡Œå¤šå°‘æ¬¡CMSåƒåœ¾å›æ”¶åï¼Œè¿›è¡Œä¸€æ¬¡å†…å­˜å‹ç¼©</span><br><span class="line">-XX:+CMSClassUnloadingEnabledï¼šå…è®¸å¯¹ç±»å…ƒæ•°æ®è¿›è¡Œå›æ”¶</span><br><span class="line">-XX:CMSInitiatingPermOccupancyFractionï¼šå½“æ°¸ä¹…åŒºå ç”¨ç‡è¾¾åˆ°è¿™ä¸€ç™¾åˆ†æ¯”æ—¶ï¼Œå¯åŠ¨CMSå›æ”¶</span><br><span class="line">-XX:UseCMSInitiatingOccupancyOnlyï¼šè¡¨ç¤ºåªåœ¨åˆ°è¾¾é˜€å€¼çš„æ—¶å€™ï¼Œæ‰è¿›è¡ŒCMSå›æ”¶</span><br></pre></td></tr></table></figure><h1 id="Tomcatå®ä¾‹æ¼”ç¤º"><a href="#Tomcatå®ä¾‹æ¼”ç¤º" class="headerlink" title="Tomcatå®ä¾‹æ¼”ç¤º"></a>Tomcatå®ä¾‹æ¼”ç¤º</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>Tomcat 7<br>JSP ç½‘ç«™<br>æµ‹è¯•ç½‘ç«™ååé‡å’Œå»¶æ—¶</p><h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>JMeter</p><h2 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h2><p>è®©Tomcatæœ‰ä¸€ä¸ªä¸é”™çš„ååé‡</p><h2 id="ç³»ç»Ÿç»“æ„"><a href="#ç³»ç»Ÿç»“æ„" class="headerlink" title="ç³»ç»Ÿç»“æ„"></a>ç³»ç»Ÿç»“æ„</h2><p><img alt="" data-original="/images/15511510781198.png"></p><p>é€šè¿‡å±€åŸŸç½‘è¿æ¥ï¼Œå°†JMeterå’ŒTomcatæ”¾åœ¨ä¸¤ä¸ªç”µè„‘ä¸Šï¼Œé˜²æ­¢Jmeterå¯¹Tomcatçš„è¿è¡Œäº§ç”Ÿå½±å“</p><h2 id="Jmeter"><a href="#Jmeter" class="headerlink" title="Jmeter"></a>Jmeter</h2><p>æ€§èƒ½æµ‹è¯•å·¥å…·<br>å»ºç«‹10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è¯·æ±‚Tomcat 1000æ¬¡ å…±10000æ¬¡è¯·æ±‚<br><img alt="" data-original="/images/15511510864168.png"></p><p>è®¾ç½®ipã€ç«¯å£ã€è¯·æ±‚åœ°å€ã€‚</p><h2 id="JDK6ï¼šä½¿ç”¨32Må †å¤„ç†è¯·æ±‚"><a href="#JDK6ï¼šä½¿ç”¨32Må †å¤„ç†è¯·æ±‚" class="headerlink" title="JDK6ï¼šä½¿ç”¨32Må †å¤„ç†è¯·æ±‚"></a>JDK6ï¼šä½¿ç”¨32Må †å¤„ç†è¯·æ±‚</h2><p>å‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set CATALINA_OPTS=-server -Xloggc:gc.log -XX:+PrintGCDetails -Xmx32M -Xms32M </span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError -XX:+UseSerialGC -XX:PermSize=<span class="number">32</span>M</span><br></pre></td></tr></table></figure><p>Averageï¼šåœ¨ä¸€ä¸‡æ¬¡è¯·æ±‚ä¸­å¹³å‡çš„è¿”å›é€Ÿåº¦æ˜¯6æ¯«ç§’ï¼Œ<br>Medianï¼šä¸€åŠçš„è¯·æ±‚éƒ½èƒ½åœ¨4æ¯«ç§’å†…è¿”å›<br>90%lineï¼š90%è¯·æ±‚åœ¨7æ¯«ç§’è¿”å›ï¼Œ<br>minï¼šæœ€å°å»¶æ—¶2æ¯«ç§’<br>maxï¼šæœ€å¤§æ¼”ç¤º135æ¯«ç§’<br>Throughputï¼š540æ¯ç§’ï¼ˆï¼‰ååé‡<br><img alt="" data-original="/images/15511510986927.png"></p><p>ä¸Šè¿°æˆªå›¾æ˜¾ç¤ºçš„æ˜¯ï¼Œç³»ç»Ÿè¿è¡Œåˆ°åæœŸå¤§é‡çš„è¯·æ±‚ï¼Œå æ®äº†ä¸€äº›å†…å­˜ï¼Œä»è€Œä¼šå¯¼è‡´ç³»ç»Ÿäº§ç”Ÿå¤§é‡çš„full gcï¼Œåœ¨32-33ç§’ä¹‹é—´å°±äº§ç”Ÿäº†å››æ¬¡full gcã€‚</p><h2 id="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæœªè®¾ç½®Xms"><a href="#JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæœªè®¾ç½®Xms" class="headerlink" title="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæœªè®¾ç½®Xms"></a>JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæœªè®¾ç½®Xms</h2><p>ä¸ºäº†æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç›´æ¥å¢å¤§å †çš„æ•°é‡ã€‚<br>å‚æ•°ï¼š<br>set CATALINA_OPTS=-Xmx512m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails</p><p>ç»“æœï¼šFULL GCå¾ˆå°‘ï¼ŒåŸºæœ¬ä¸Šæ˜¯Minor GC<br><img alt="" data-original="/images/15511511093088.png"></p><p>ååé‡å˜æˆäº†651ï¼Œå› ä¸ºæ²¡æœ‰è®¾ç½®æœ€å°åˆå§‹åŒ–å †çš„å¤§å°ï¼Œæ‰€ä»¥æœ€å°åˆå§‹åŒ–å †å°±å˜æˆäº†å¯ä»¥æ‰©å±•çš„ç©ºé—´ï¼Œåœ¨ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œç³»ç»Ÿåªæœ‰16mçš„å†…å­˜ï¼Œä½†æ˜¯ç³»ç»Ÿè¿è¡Œåˆ°åé¢ï¼Œå†…å­˜åœ¨ä¸åœçš„å¾€ä¸Šæ¶¨ï¼Œåˆ°è¾¾äº†60mï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰full gcçš„äº§ç”Ÿï¼Œå› ä¸ºæ²¡æœ‰full gcçš„äº§ç”Ÿï¼Œæ‰€ä»¥ååé‡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ•ˆæœã€‚</p><h2 id="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œè®¾ç½®Xmsä¸º64m"><a href="#JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œè®¾ç½®Xmsä¸º64m" class="headerlink" title="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œè®¾ç½®Xmsä¸º64m"></a>JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œè®¾ç½®Xmsä¸º64m</h2><p>ä¸Šé¢çœ‹åˆ°æœ€åä¼šæ‰©å±•åˆ°60mï¼Œè¿™é‡Œç›´æ¥å°†Xmsè®¾ç½®ä¸º64mã€‚<br>å‚æ•°ï¼š<br>set CATALINA_OPTS=-Xmx512m -Xms64m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails</p><p>ç»“æœ GCæ•°é‡å‡å°‘ å¤§éƒ¨åˆ†æ˜¯Minor GC<br><img alt="" data-original="/images/15511511253053.png"></p><p>å› ä¸ºå †è¶Šå¤§gcè¶Šå°‘ï¼Œå¦‚æœå †å¾ˆå°çš„è¯ï¼Œç³»ç»Ÿå¸Œæœ›å°†å·¥ä½œç»´æŒåœ¨ä¸€ä¸ªå¾ˆå°çš„å †ä¸Šåšï¼Œå¿…ç„¶ä¼šä¸æ–­çš„è¿›è¡Œgcã€‚</p><h2 id="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæ”¹ä¸ºå¹¶è¡Œæ”¶é›†å™¨"><a href="#JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæ”¹ä¸ºå¹¶è¡Œæ”¶é›†å™¨" class="headerlink" title="JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæ”¹ä¸ºå¹¶è¡Œæ”¶é›†å™¨"></a>JDK6ï¼šä½¿ç”¨æœ€å¤§å †512Må †å¤„ç†è¯·æ±‚ï¼Œæ”¹ä¸ºå¹¶è¡Œæ”¶é›†å™¨</h2><p>å‚æ•°ï¼š<br>set CATALINA_OPTS=-Xmx512m -Xms64m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails -XX:+UseParallelGC -XX:+UseParallelOldGC -XX:ParallelGCThreads=4</p><p>å°†æ–°ç”Ÿä»£å’Œå¹´è€ä»£æ¢æˆå¹¶è¡Œå›æ”¶çš„æ–¹å¼ï¼Œå› ä¸ºå †å¾ˆå¤§ï¼Œæ‰€ä»¥GCå‹åŠ›åŸæœ¬å°±ä¸å¤§ã€‚<br>ç»“æœï¼šGCå‹åŠ›åŸæœ¬ä¸å¤§ï¼Œä¿®æ”¹GCæ–¹å¼å½±å“å¾ˆå°<br><img alt="" data-original="/images/15511511485451.png"></p><h2 id="JDK-6ï¼Œå‡å°å †ï¼Œä¸²è¡Œæ”¶é›†å™¨"><a href="#JDK-6ï¼Œå‡å°å †ï¼Œä¸²è¡Œæ”¶é›†å™¨" class="headerlink" title="JDK 6ï¼Œå‡å°å †ï¼Œä¸²è¡Œæ”¶é›†å™¨"></a>JDK 6ï¼Œå‡å°å †ï¼Œä¸²è¡Œæ”¶é›†å™¨</h2><p>set CATALINA_OPTS=-Xmx40m -Xms40m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails</p><p>å‡å°å †å¤§å°ï¼Œå¢åŠ GCå‹åŠ›ï¼Œä½¿ç”¨Serialå›æ”¶å™¨ï¼ŒSerialå›æ”¶å™¨æ˜¯é»˜è®¤çš„å›æ”¶å™¨ã€‚<br><img alt="" data-original="/images/15511511611935.png"></p><h2 id="JDK-6ï¼Œå‡å°å †ï¼Œå¹¶è¡Œæ”¶é›†å™¨"><a href="#JDK-6ï¼Œå‡å°å †ï¼Œå¹¶è¡Œæ”¶é›†å™¨" class="headerlink" title="JDK 6ï¼Œå‡å°å †ï¼Œå¹¶è¡Œæ”¶é›†å™¨"></a>JDK 6ï¼Œå‡å°å †ï¼Œå¹¶è¡Œæ”¶é›†å™¨</h2><p>set CATALINA_OPTS=-Xmx40m -Xms40m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails -XX:+UseParallelOldGC -XX:ParallelGCThreads=4</p><p>å‡å°å †å¤§å°ï¼Œå¢åŠ GCå‹åŠ›ï¼Œä½¿ç”¨å¹¶è¡Œå›æ”¶å™¨<img alt="" data-original="/images/15511513163999.png"></p><h2 id="JDK-6ï¼Œå‡å°å †ï¼ŒParNewæ”¶é›†å™¨"><a href="#JDK-6ï¼Œå‡å°å †ï¼ŒParNewæ”¶é›†å™¨" class="headerlink" title="JDK 6ï¼Œå‡å°å †ï¼ŒParNewæ”¶é›†å™¨"></a>JDK 6ï¼Œå‡å°å †ï¼ŒParNewæ”¶é›†å™¨</h2><p>set CATALINA_OPTS=-Xmx40m -Xms40m -XX:MaxPermSize=32M -Xloggc:gc.log -XX:+PrintGCDetails -XX:+UseParNewGC</p><p>å‡å°å †å¤§å°ï¼Œå¢åŠ GCå‹åŠ›ï¼Œä½¿ç”¨ParNewå›æ”¶å™¨<br><img alt="" data-original="/images/15511513310090.png"></p><p>ParNewåªæ˜¯å½±å“æ–°ç”Ÿä»£ï¼Œå¯¹è€å¹´ä»£å½±å“ä¸å¤§ï¼Œè€Œè¿™é‡Œçš„å‹åŠ›ä¸»è¦æ˜¯è€å¹´ä»£ï¼Œæ‰€ä»¥å½±å“ä¸å¤§ã€‚</p><h2 id="å¯åŠ¨Tomcat-7"><a href="#å¯åŠ¨Tomcat-7" class="headerlink" title="å¯åŠ¨Tomcat 7"></a>å¯åŠ¨Tomcat 7</h2><p>ä½¿ç”¨JDK6<br>ä¸åŠ ä»»ä½•å‚æ•°å¯åŠ¨æµ‹è¯•<br><img alt="" data-original="/images/15511513402372.png"></p><h2 id="å¯åŠ¨Tomcat-7-1"><a href="#å¯åŠ¨Tomcat-7-1" class="headerlink" title="å¯åŠ¨Tomcat 7"></a>å¯åŠ¨Tomcat 7</h2><p>ä½¿ç”¨JDK7<br>ä¸åŠ ä»»ä½•å‚æ•°å¯åŠ¨æµ‹è¯•<br><img alt="" data-original="/images/15511513516173.png"></p><p>å¯ä»¥çœ‹åˆ°JDK7æ€§èƒ½æ›´åŠ å¥½ä¸€ç‚¹ã€‚<br><strong><font color="red">å‡çº§JDKå¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½æå‡ï¼<br>ä¸è¦å¿½è§†JDKçš„ç‰ˆæœ¬å“¦</font></strong></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç»†èŠ‚å†³å®šæˆè´¥</p><ul><li>æ€§èƒ½çš„æ ¹æœ¬åœ¨åº”ç”¨</li><li>GCå‚æ•°å±äºå¾®è°ƒ</li><li>è®¾ç½®ä¸åˆç†ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œäº§ç”Ÿå¤§çš„å»¶æ—¶</li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å †çš„å›é¡¾&quot;&gt;&lt;a href=&quot;#å †çš„å›é¡¾&quot; class=&quot;headerlink&quot; title=&quot;å †çš„å›é¡¾&quot;&gt;&lt;/a
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆå››ï¼‰ï¼šGCç®—æ³•ä¸ç§ç±»</title>
    <link href="http://mmmmmm.me/2019-02-24-2.html"/>
    <id>http://mmmmmm.me/2019-02-24-2.html</id>
    <published>2019-02-24T14:21:02.000Z</published>
    <updated>2019-02-24T10:20:58.915Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="GCçš„æ¦‚å¿µ"><a href="#GCçš„æ¦‚å¿µ" class="headerlink" title="GCçš„æ¦‚å¿µ"></a>GCçš„æ¦‚å¿µ</h1><ul><li>Garbage Collection åƒåœ¾æ”¶é›†</li><li>1960å¹´ List ä½¿ç”¨äº†GC</li><li>Javaä¸­ï¼ŒGCçš„å¯¹è±¡æ˜¯å †ç©ºé—´å’Œæ°¸ä¹…åŒº<h1 id="GCç®—æ³•"><a href="#GCç®—æ³•" class="headerlink" title="GCç®—æ³•"></a>GCç®—æ³•</h1><h2 id="å¼•ç”¨è®¡æ•°æ³•"><a href="#å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="å¼•ç”¨è®¡æ•°æ³•"></a>å¼•ç”¨è®¡æ•°æ³•</h2>è€ç‰Œåƒåœ¾å›æ”¶ç®—æ³•<br>é€šè¿‡å¼•ç”¨è®¡ç®—æ¥å›æ”¶åƒåœ¾<br>ä½¿ç”¨è€…</li><li>COM</li><li>ActionScript3</li><li>Python</li></ul><p>å¼•ç”¨è®¡æ•°å™¨çš„å®ç°å¾ˆç®€å•ï¼Œå¯¹äºä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„å¼•ç”¨è®¡æ•°å™¨å°±åŠ 1ï¼Œå½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡1ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œåˆ™å¯¹è±¡Aå°±ä¸å¯èƒ½å†è¢«ä½¿ç”¨ã€‚<br><img alt="" data-original="/images/15510032407244.png"></p><h3 id="å¼•ç”¨è®¡æ•°æ³•çš„é—®é¢˜"><a href="#å¼•ç”¨è®¡æ•°æ³•çš„é—®é¢˜" class="headerlink" title="å¼•ç”¨è®¡æ•°æ³•çš„é—®é¢˜"></a>å¼•ç”¨è®¡æ•°æ³•çš„é—®é¢˜</h3><p>å¼•ç”¨å’Œå»å¼•ç”¨ä¼´éšåŠ æ³•å’Œå‡æ³•ï¼Œå› ä¸ºå¼•ç”¨çš„è®¡ç®—æ˜¯å®æ—¶çš„ï¼Œå½±å“æ€§èƒ½ã€‚<br>å¾ˆéš¾å¤„ç†å¾ªç¯å¼•ç”¨<br><img alt="" data-original="/images/15510032512665.png"></p><p>æ ¹å¯¹è±¡çš„å¼•ç”¨å»æ‰ä¹‹åï¼Œå¯¹äºæ ¹å¯¹è±¡æ¥è¯´ï¼Œå‰©ä¸‹çš„ä¸‰ä¸ªçš„å¼•ç”¨éƒ½ä¸ä¸º0ï¼Œæ‰€ä»¥ä¸ä¼šå›æ”¶ï¼Œæ‰€ä»¥å¼•ç”¨è®¡æ•°çš„ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ <strong><font color="red">åƒåœ¾å¯¹è±¡çš„å¾ªç¯å¼•ç”¨ ï¼Œå¯¼è‡´æ— æ³•è¢«å›æ”¶</font></strong>ã€‚</p><h2 id="æ ‡è®°æ¸…é™¤"><a href="#æ ‡è®°æ¸…é™¤" class="headerlink" title="æ ‡è®°æ¸…é™¤"></a>æ ‡è®°æ¸…é™¤</h2><p>æ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ç°ä»£åƒåœ¾å›æ”¶ç®—æ³•çš„æ€æƒ³åŸºç¡€ã€‚æ ‡è®°-æ¸…é™¤ç®—æ³•å°†åƒåœ¾å›æ”¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šæ ‡è®°é˜¶æ®µå’Œæ¸…é™¤é˜¶æ®µã€‚ä¸€ç§å¯è¡Œçš„å®ç°æ˜¯ï¼Œåœ¨æ ‡è®°é˜¶æ®µï¼Œé¦–å…ˆé€šè¿‡æ ¹èŠ‚ç‚¹ï¼Œæ ‡è®°æ‰€æœ‰ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¯è¾¾å¯¹è±¡ã€‚å› æ­¤ï¼Œæœªè¢«æ ‡è®°çš„å¯¹è±¡å°±æ˜¯æœªè¢«å¼•ç”¨çš„åƒåœ¾å¯¹è±¡ã€‚ç„¶åï¼Œåœ¨æ¸…é™¤é˜¶æ®µï¼Œæ¸…é™¤æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ã€‚<br><img alt="" data-original="/images/15510032642250.png"></p><p><strong><font color="red">ä¸Šå›¾å·¦è¾¹æ˜¯æ ‡è®°é˜¶æ®µï¼Œå³è¾¹æ˜¯æ¸…é™¤é˜¶æ®µã€‚</font></strong><br>ç©ºç™½åŒºåŸŸè¡¨ç¤ºç©ºé—²ç©ºé—´ï¼Œæ·±ç°è‰²è¡¨ç¤ºåƒåœ¾å¯¹è±¡ï¼Œæµ…ç°è‰²è¡¨ç¤ºå­˜æˆ–å¯¹è±¡ã€‚<br>ä»æ ¹èŠ‚ç‚¹ï¼Œç®­å¤´è¡¨ç¤ºå¼•ç”¨ï¼Œæ‰€æœ‰çš„æµ…ç°è‰²çš„æ˜¯ä»æ ¹èŠ‚ç‚¹çš„å¯è¾¾å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æ˜¯ä¸åº”è¯¥è¢«å›æ”¶çš„ï¼Œè€Œæ‰€æœ‰çš„ä»æ ¹èŠ‚ç‚¹ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œå³æ·±ç°è‰²çš„å¯¹è±¡ä¸ºåƒåœ¾å¯¹è±¡ã€‚</p><h2 id="æ ‡è®°å‹ç¼©"><a href="#æ ‡è®°å‹ç¼©" class="headerlink" title="æ ‡è®°å‹ç¼©"></a>æ ‡è®°å‹ç¼©</h2><p>æ ‡è®°-å‹ç¼©ç®—æ³•é€‚åˆç”¨äºå­˜æ´»å¯¹è±¡è¾ƒå¤šçš„åœºåˆï¼Œå¦‚è€å¹´ä»£ã€‚å®ƒåœ¨æ ‡è®°-æ¸…é™¤ç®—æ³•çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ã€‚å’Œæ ‡è®°-æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œæ ‡è®°-å‹ç¼©ç®—æ³•ä¹Ÿé¦–å…ˆéœ€è¦ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯¹æ‰€æœ‰å¯è¾¾å¯¹è±¡åšä¸€æ¬¡æ ‡è®°ã€‚ä½†ä¹‹åï¼Œå®ƒå¹¶ä¸ç®€å•çš„æ¸…ç†æœªæ ‡è®°çš„å¯¹è±¡ï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ã€‚ä¹‹åï¼Œ <strong><font color="red">æ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ </font></strong>ã€‚<br><img alt="" data-original="/images/15510032764407.png"></p><p>å·²ç»æ ‡è®°å¥½äº†å¯¹è±¡ï¼Œç®­å¤´è¡¨ç¤ºç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œè€Œä¸æ˜¯å»ç®€å•çš„æ¸…é™¤æœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼Œç§»åŠ¨å®Œäº†ä¹‹åæŠŠåŒºåŸŸå¤–çš„å¯¹è±¡ï¼ˆä¸Šå›¾æŒ‡çš„æ˜¯é™¤äº†ç¬¬ä¸€è¡Œï¼‰å…¨éƒ¨æ¸…ç†ã€‚</p><h3 id="å°é—®é¢˜"><a href="#å°é—®é¢˜" class="headerlink" title="å°é—®é¢˜"></a>å°é—®é¢˜</h3><p>æ ‡è®°å‹ç¼©å¯¹æ ‡è®°æ¸…é™¤è€Œè¨€ï¼Œæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿ</p><h2 id="å¤åˆ¶ç®—æ³•"><a href="#å¤åˆ¶ç®—æ³•" class="headerlink" title="å¤åˆ¶ç®—æ³•"></a>å¤åˆ¶ç®—æ³•</h2><ul><li>ä¸æ ‡è®°-æ¸…é™¤ç®—æ³•ç›¸æ¯”ï¼Œå¤åˆ¶ç®—æ³•æ˜¯ä¸€ç§ç›¸å¯¹é«˜æ•ˆçš„å›æ”¶æ–¹æ³•</li><li>ä¸é€‚ç”¨äºå­˜æ´»å¯¹è±¡è¾ƒå¤šçš„åœºåˆ å¦‚è€å¹´ä»£</li><li>å°†åŸæœ‰çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œå°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åï¼Œæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œå®Œæˆåƒåœ¾å›æ”¶</li></ul><p><img alt="" data-original="/images/15510032881638.png"></p><p>æ¯æ¬¡æŠŠå­˜æ´»çš„å¯¹è±¡è¢«å¤åˆ¶åˆ°å¦ä¸€å—åŒºåŸŸä¸­ï¼Œå¤åˆ¶å®Œä¹‹åç¬¬ä¸€å—åŒºåŸŸä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½åšä¸€æ¬¡æ¸…ç†ï¼Œç„¶åäº¤æ¢è§’è‰²ã€‚</p><h3 id="å¤åˆ¶ç®—æ³•çš„æœ€å¤§é—®é¢˜æ˜¯ï¼šç©ºé—´æµªè´¹-æ•´åˆæ ‡è®°æ¸…ç†æ€æƒ³"><a href="#å¤åˆ¶ç®—æ³•çš„æœ€å¤§é—®é¢˜æ˜¯ï¼šç©ºé—´æµªè´¹-æ•´åˆæ ‡è®°æ¸…ç†æ€æƒ³" class="headerlink" title="å¤åˆ¶ç®—æ³•çš„æœ€å¤§é—®é¢˜æ˜¯ï¼šç©ºé—´æµªè´¹ æ•´åˆæ ‡è®°æ¸…ç†æ€æƒ³"></a>å¤åˆ¶ç®—æ³•çš„æœ€å¤§é—®é¢˜æ˜¯ï¼šç©ºé—´æµªè´¹ æ•´åˆæ ‡è®°æ¸…ç†æ€æƒ³</h3><p>å› ä¸ºå¤åˆ¶ç®—æ³•ï¼Œæ¯æ¬¡éƒ½æœ‰ä¸€åŠæ˜¯æ²¡æœ‰è¢«ç”¨çš„ã€‚<br><img alt="" data-original="/images/15510033006005.png"></p><p>ä¸»è¦çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„äº§ç”Ÿæ”¾åœ¨å·¦è¾¹æœ€å¤§çš„åŒºåŸŸä¸­ï¼Œä¸‹é¢çš„ä¸¤å°å—æ˜¯å¤åˆ¶ç®—æ³•çš„æ ¸å¿ƒã€‚<br>å½“åƒåœ¾å›æ”¶è¿›è¡Œçš„æ—¶å€™ï¼Œå¤§å¯¹è±¡ç›´æ¥è¿›å…¥æ‹…ä¿ç©ºé—´ï¼ˆå¹´è€ä»£ï¼‰ï¼Œä¸ºä»€ä¹ˆå¤§å¯¹è±¡æ”¾åˆ°å¹´è€ä»£ä¸­ï¼Ÿå› ä¸ºå¤åˆ¶åŒºåŸŸå¾ˆå°ï¼Œå¯èƒ½å¤§å¯¹è±¡ç›´æ¥å°±æ”¾ä¸è¿›å»ï¼Œä¹Ÿå¯èƒ½å¤§å¯¹è±¡æ”¾åˆ°è´Ÿå€¼åŒºåŸŸï¼Œå¯¼è‡´åŸæœ¬åº”è¯¥æ”¾åˆ°è´Ÿå€¼åŒºåŸŸçš„å°å¯¹è±¡è¢«æŒ¤åˆ°äº†å¹´è€ä»£ä¸­ã€‚<br>ç„¶åè€å¹´å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Œä»€ä¹ˆå«åšè€å¹´å¯¹è±¡ï¼Œå¯¹è±¡åœ¨å‡ æ¬¡å›æ”¶ä¹‹åéƒ½æ²¡æœ‰è¢«å›æ”¶æ‰ï¼Œæ¯æ¬¡å›æ”¶åå¯¹è±¡çš„å¹´é¾„å°±ä¼šåŠ ä¸€ï¼Œå½“å¯¹è±¡åˆ°è¾¾ä¸€å®šçš„å¹´é¾„å¯¹è±¡ä¹‹åï¼Œå°±ä¼šå˜æˆè€å¹´å¯¹è±¡ï¼Œå³é•¿æœŸè¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œæ‰€ä»¥è€å¹´å¯¹è±¡è¢«æ”¾åœ¨è€å¹´ä»£ã€‚<br>å‰©ä¸‹å°çš„ã€å¹´è½»çš„å¯¹è±¡åšå¤åˆ¶å³è¾¹çš„å°çš„åŒºåŸŸä¸­å»ã€‚<br>æ ¹æ®å¤åˆ¶ç®—æ³•ï¼Œæ¸…ç©ºåŸå…ˆä½¿ç”¨çš„ç©ºé—´ï¼Œå°±å½¢æˆäº†å³è¾¹çš„ç»“æœã€‚</p><h3 id="XX-PrintGCDetailsçš„è¾“å‡º"><a href="#XX-PrintGCDetailsçš„è¾“å‡º" class="headerlink" title="-XX:+PrintGCDetailsçš„è¾“å‡º"></a>-XX:+PrintGCDetailsçš„è¾“å‡º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Heap</span><br><span class="line"><span class="comment">//ï¼ˆ0x28d80000-0x27e80000)/1024/1024=15mï¼Œå³æ–°ç”Ÿä»£æœ‰15mçš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">//å¯æ˜¯è¿™é‡Œtotalä¸ºä»€ä¹ˆæ˜¯13824Kï¼Ÿ</span></span><br><span class="line"><span class="comment">//å®è´¨ä¸Šæ˜¯12288K+ 1536K=13824</span></span><br><span class="line"><span class="comment">//å³æµªè´¹äº†from toå…¶ä¸­çš„ä¸€ä¸ªç©ºé—´ï¼Œå³å¤åˆ¶ç®—æ³•æ‰€éœ€è¦æµªè´¹çš„ç©ºé—´ã€‚</span></span><br><span class="line"> def <span class="keyword">new</span> generation   total <span class="number">13824</span>K, used <span class="number">11223</span>K [<span class="number">0x27e80000</span>, <span class="number">0x28d80000</span>, <span class="number">0x28d80000</span>)</span><br><span class="line">  eden space <span class="number">12288</span>K,  <span class="number">91</span>% used [<span class="number">0x27e80000</span>, <span class="number">0x28975f20</span>, <span class="number">0x28a80000</span>)</span><br><span class="line">  <span class="keyword">from</span> space <span class="number">1536</span>K,   <span class="number">0</span>% used [<span class="number">0x28a80000</span>, <span class="number">0x28a80000</span>, <span class="number">0x28c00000</span>)</span><br><span class="line">  to   space <span class="number">1536</span>K,   <span class="number">0</span>% used [<span class="number">0x28c00000</span>, <span class="number">0x28c00000</span>, <span class="number">0x28d80000</span>)</span><br><span class="line"> tenured generation   total <span class="number">5120</span>K, used <span class="number">0</span>K [<span class="number">0x28d80000</span>, <span class="number">0x29280000</span>, <span class="number">0x34680000</span>)</span><br><span class="line">   the space <span class="number">5120</span>K,   <span class="number">0</span>% used [<span class="number">0x28d80000</span>, <span class="number">0x28d80000</span>, <span class="number">0x28d80200</span>, <span class="number">0x29280000</span>)</span><br><span class="line"> compacting perm gen  total <span class="number">12288</span>K, used <span class="number">142</span>K [<span class="number">0x34680000</span>, <span class="number">0x35280000</span>, <span class="number">0x38680000</span>)</span><br><span class="line">   the space <span class="number">12288</span>K,   <span class="number">1</span>% used [<span class="number">0x34680000</span>, <span class="number">0x346a3a90</span>, <span class="number">0x346a3c00</span>, <span class="number">0x35280000</span>)</span><br><span class="line">    ro space <span class="number">10240</span>K,  <span class="number">44</span>% used [<span class="number">0x38680000</span>, <span class="number">0x38af73f0</span>, <span class="number">0x38af7400</span>, <span class="number">0x39080000</span>)</span><br><span class="line">    rw space <span class="number">12288</span>K,  <span class="number">52</span>% used [<span class="number">0x39080000</span>, <span class="number">0x396cdd28</span>, <span class="number">0x396cde00</span>, <span class="number">0x39c80000</span>)</span><br></pre></td></tr></table></figure><h2 id="gcæ€æƒ³ä»¥åŠæ€»ç»“"><a href="#gcæ€æƒ³ä»¥åŠæ€»ç»“" class="headerlink" title="gcæ€æƒ³ä»¥åŠæ€»ç»“"></a>gcæ€æƒ³ä»¥åŠæ€»ç»“</h2><h3 id="åˆ†ä»£æ€æƒ³"><a href="#åˆ†ä»£æ€æƒ³" class="headerlink" title="åˆ†ä»£æ€æƒ³"></a>åˆ†ä»£æ€æƒ³</h3><h4 id="ä¾æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸè¿›è¡Œåˆ†ç±»ï¼ŒçŸ­å‘½å¯¹è±¡å½’ä¸ºæ–°ç”Ÿä»£ï¼Œé•¿å‘½å¯¹è±¡å½’ä¸ºè€å¹´ä»£ã€‚"><a href="#ä¾æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸè¿›è¡Œåˆ†ç±»ï¼ŒçŸ­å‘½å¯¹è±¡å½’ä¸ºæ–°ç”Ÿä»£ï¼Œé•¿å‘½å¯¹è±¡å½’ä¸ºè€å¹´ä»£ã€‚" class="headerlink" title="ä¾æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸè¿›è¡Œåˆ†ç±»ï¼ŒçŸ­å‘½å¯¹è±¡å½’ä¸ºæ–°ç”Ÿä»£ï¼Œé•¿å‘½å¯¹è±¡å½’ä¸ºè€å¹´ä»£ã€‚"></a>ä¾æ®å¯¹è±¡çš„å­˜æ´»å‘¨æœŸè¿›è¡Œåˆ†ç±»ï¼ŒçŸ­å‘½å¯¹è±¡å½’ä¸ºæ–°ç”Ÿä»£ï¼Œé•¿å‘½å¯¹è±¡å½’ä¸ºè€å¹´ä»£ã€‚</h4><h4 id="æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹ï¼Œé€‰å–åˆé€‚çš„æ”¶é›†ç®—æ³•"><a href="#æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹ï¼Œé€‰å–åˆé€‚çš„æ”¶é›†ç®—æ³•" class="headerlink" title="æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹ï¼Œé€‰å–åˆé€‚çš„æ”¶é›†ç®—æ³•"></a>æ ¹æ®ä¸åŒä»£çš„ç‰¹ç‚¹ï¼Œé€‰å–åˆé€‚çš„æ”¶é›†ç®—æ³•</h4><p>å°‘é‡å¯¹è±¡å­˜æ´»ï¼Œé€‚åˆå¤åˆ¶ç®—æ³•ï¼ˆå¹´è½»ä»£ï¼‰<br>å¤§é‡å¯¹è±¡å­˜æ´»ï¼Œé€‚åˆæ ‡è®°æ¸…ç†æˆ–è€…æ ‡è®°å‹ç¼©ï¼ˆå¹´è€ä»£ï¼‰<br>å› ä¸ºå¹´è€ä»£çš„å¯¹è±¡é™¤äº†æ˜¯æ¯”è¾ƒå¤§çš„å¯¹è±¡ä¹‹å¤–ï¼Œå°±æ˜¯åœ¨å¹´è½»ä»£å¤šæ¬¡å­˜æ´»çš„å¯¹è±¡ï¼Œæ•°é‡æ¯”è¾ƒå¤§ï¼Œå¦‚æœæ˜¯æ•°é‡æ¯”è¾ƒå¤šçš„è¯ï¼Œå¤åˆ¶ç®—æ³•ï¼Œéœ€è¦å¤åˆ¶çš„æ“ä½œæ¯”è¾ƒå¤šï¼Œæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ã€‚</p><h3 id="GCç®—æ³•æ€»ç»“æ•´ç†"><a href="#GCç®—æ³•æ€»ç»“æ•´ç†" class="headerlink" title="GCç®—æ³•æ€»ç»“æ•´ç†"></a>GCç®—æ³•æ€»ç»“æ•´ç†</h3><p>å¼•ç”¨è®¡æ•°ï¼ˆæ²¡æœ‰è¢«Javaé‡‡ç”¨ï¼‰<br>æ ‡è®°-æ¸…é™¤ã€æ ‡è®°-å‹ç¼©ï¼ˆè¢«å¹´è€ä»£é‡‡ç”¨ï¼‰<br>å¤åˆ¶ç®—æ³•ï¼ˆè¢«æ–°ç”Ÿä»£é‡‡ç”¨ï¼‰</p><h1 id="å¯è§¦åŠæ€§"><a href="#å¯è§¦åŠæ€§" class="headerlink" title="å¯è§¦åŠæ€§"></a>å¯è§¦åŠæ€§</h1><p>æ‰€æœ‰çš„ç®—æ³•ï¼Œéœ€è¦èƒ½å¤Ÿè¯†åˆ«ä¸€ä¸ªåƒåœ¾å¯¹è±¡ï¼Œå› æ­¤éœ€è¦ç»™å‡ºä¸€ä¸ªå¯è§¦åŠæ€§çš„å®šä¹‰</p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><h3 id="å¯è§¦åŠçš„"><a href="#å¯è§¦åŠçš„" class="headerlink" title="å¯è§¦åŠçš„"></a>å¯è§¦åŠçš„</h3><p>ä»æ ¹èŠ‚ç‚¹å¯ä»¥è§¦åŠåˆ°è¿™ä¸ªå¯¹è±¡ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¼•ç”¨é“¾æ¡ä¸­æœ‰è¿™ä¸ªå¯¹è±¡å°±æ˜¯å¯è§¦åŠçš„ã€‚</p><h3 id="å¯å¤æ´»çš„"><a href="#å¯å¤æ´»çš„" class="headerlink" title="å¯å¤æ´»çš„"></a>å¯å¤æ´»çš„</h3><p>ä¸€æ—¦æ‰€æœ‰å¼•ç”¨è¢«é‡Šæ”¾ï¼Œå°±æ˜¯å¯å¤æ´»çŠ¶æ€<br>å› ä¸ºåœ¨finalize()ä¸­å¯èƒ½å¤æ´»è¯¥å¯¹è±¡<br>å°±æ˜¯åœ¨finalizeï¼ˆï¼‰æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰å˜æˆä¸å¯è§¦åŠçš„æ—¶å€™å°±æ˜¯å¯å¤æ´»çš„ï¼Œå¯èƒ½ä¼šå†æ¬¡è¢«è§¦åŠçš„ï¼Œå¯å¤æ´»çš„å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ã€‚</p><h3 id="ä¸å¯è§¦åŠçš„"><a href="#ä¸å¯è§¦åŠçš„" class="headerlink" title="ä¸å¯è§¦åŠçš„"></a>ä¸å¯è§¦åŠçš„</h3><p>åœ¨finalize()æ‰§è¡Œå®Œä¹‹åï¼Œå¯èƒ½ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€<br>ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½å¤æ´»<br>å¯ä»¥å›æ”¶</p><h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CanReliveObj</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> CanReliveObj obj;</span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> finalize() throws Throwable &#123;</span><br><span class="line">    <span class="keyword">super</span>.finalize();</span><br><span class="line">    System.out.println(<span class="string">"CanReliveObj finalize called"</span>);</span><br><span class="line">    obj=<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public <span class="built_in">String</span> toString()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"I am CanReliveObj"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws</span><br><span class="line">     InterruptedException&#123;</span><br><span class="line">obj=<span class="keyword">new</span> CanReliveObj();</span><br><span class="line">obj=<span class="literal">null</span>;   <span class="comment">//å¯å¤æ´»</span></span><br><span class="line">System.gc();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span>(obj==<span class="literal">null</span>)&#123;</span><br><span class="line">    System.out.println(<span class="string">"obj æ˜¯ null"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"obj å¯ç”¨"</span>);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"ç¬¬äºŒæ¬¡gc"</span>);</span><br><span class="line">obj=<span class="literal">null</span>;    <span class="comment">//ä¸å¯å¤æ´»</span></span><br><span class="line">System.gc();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span>(obj==<span class="literal">null</span>)&#123;</span><br><span class="line">System.out.println(<span class="string">"obj æ˜¯ null"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"obj å¯ç”¨"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CanReliveObj finalize called</span><br><span class="line">obj å¯ç”¨</span><br><span class="line">ç¬¬äºŒæ¬¡gc</span><br><span class="line">obj æ˜¯ <span class="literal">null</span></span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼š<br>æ³¨æ„ç¬¬ä¸€æ®µä»£ç ä¸­çš„obj=this;<br>ç¬¬äºŒæ®µä»£ç ä¸­ç¬¬ä¸€æ¬¡obj=nullçš„æ—¶å€™ï¼Œæ˜¯å¯å¤æ´»çš„çŠ¶æ€ï¼ŒSystem.gc();è°ƒç”¨äº†ç¬¬ä¸€æ®µä»£ç çš„finalizeæ–¹æ³•ï¼Œæ‰§è¡Œobj=thisï¼Œæ‰€ä»¥objå¯ç”¨ï¼Œä½†æ˜¯æ³¨æ„ <strong><font color="red">finalizeæ–¹æ³•åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡</font></strong>ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡obj=nullï¼ŒSystem.gc();çš„æ—¶å€™ä¸èƒ½è°ƒç”¨ç¬¬ä¸€æ®µä»£ç ä¸­çš„finalizeæ–¹æ³•ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡gcçš„æ—¶å€™è¾“å‡ºobj æ˜¯ nullã€‚</p><h3 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h3><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœç¬¬ä¸€æ¬¡æ‰§è¡Œäº†finalizeæ”¾å•Šï¼Œç¬¬äºŒæ¬¡æ²¡æœ‰æ‰§è¡Œobj=nullï¼Œé‚£æ˜¯ä¸æ˜¯ä»¥ä¸ºè¿™objè¿™ä¸ªå¯¹è±¡ï¼Œæ°¸è¿œæ— æ³•å›æ”¶ï¼Ÿ</p><ul><li>ç»éªŒï¼šé¿å…ä½¿ç”¨finalize()ï¼Œæ“ä½œä¸æ…å¯èƒ½å¯¼è‡´é”™è¯¯ã€‚</li><li>ä¼˜å…ˆçº§ä½ï¼Œä½•æ—¶è¢«è°ƒç”¨ï¼Œ ä¸ç¡®å®š<br>ä½•æ—¶å‘ç”ŸGCä¸ç¡®å®šï¼Œæ‰€ä»¥ä¸å»ºè®®åœ¨finalizeé‡Œé¢å†™ä»£ç ï¼Œè¢«è°ƒç”¨çš„ä¸ç¡®å®šæ€§å¤ªå¤§ã€‚</li><li>å¯ä»¥ä½¿ç”¨try-catch-finallyæ¥æ›¿ä»£å®ƒ</li></ul><h2 id="æ ¹"><a href="#æ ¹" class="headerlink" title="æ ¹"></a>æ ¹</h2><p>æ ¹ï¼Œä¸Šé¢è®¸å¤šåœ°æ–¹æ‰€è¯´çš„æ ¹ï¼Œç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</li><li>æ–¹æ³•åŒºä¸­é™æ€æˆå‘˜æˆ–è€…å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼ˆå…¨å±€å¯¹è±¡ï¼‰</li><li>JNIæ–¹æ³•æ ˆä¸­å¼•ç”¨å¯¹è±¡<h1 id="Stop-The-World"><a href="#Stop-The-World" class="headerlink" title="Stop-The-World"></a>Stop-The-World</h1></li><li>Javaä¸­ä¸€ç§å…¨å±€æš‚åœçš„ç°è±¡</li><li>å…¨å±€åœé¡¿ï¼Œæ‰€æœ‰Javaä»£ç åœæ­¢ï¼Œnativeä»£ç å¯ä»¥æ‰§è¡Œï¼Œä½†ä¸èƒ½å’ŒJVMäº¤äº’ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½åšæ‰€æœ‰åº”ç”¨å±‚é¢çš„äº‹æƒ…ï¼Œåªèƒ½åšgcã€‚</li><li>å¤šåŠç”±äºGCå¼•èµ·<br>Dumpçº¿ç¨‹<br>æ­»é”æ£€æŸ¥<br>å †Dump<br>å› ä¸ºDumpçº¿ç¨‹ã€æ­»é”æ£€æŸ¥ã€å †Dumpæ¦‚ç‡è¾ƒä½ï¼Œè€Œä¸”å¤šæ˜¯ç”±äºç¨‹åºå‘˜å¼•èµ·ï¼Œè€Œgcåˆ™æ˜¯ç”±ç¨‹åºè‡ªåŠ¨è§¦å‘çš„ï¼Œæ‰€ä»¥ç”±gcå¼•èµ·çš„å…¨å±€æš‚åœåº”è¯¥å¼•èµ·é‡è§†ã€‚</li><li>GCæ—¶ä¸ºä»€ä¹ˆä¼šæœ‰å…¨å±€åœé¡¿ï¼Ÿ<br>ç±»æ¯”åœ¨èšä¼šæ—¶æ‰“æ‰«æˆ¿é—´ï¼Œèšä¼šæ—¶å¾ˆä¹±ï¼Œåˆæœ‰æ–°çš„åƒåœ¾äº§ç”Ÿï¼Œæˆ¿é—´æ°¸è¿œæ‰“æ‰«ä¸å¹²å‡€ï¼Œåªæœ‰è®©å¤§å®¶åœæ­¢æ´»åŠ¨äº†ï¼Œæ‰èƒ½å°†æˆ¿é—´æ‰“æ‰«å¹²å‡€ã€‚<br>æ‰€ä»¥gcä¼šå‡ºç°åœé¡¿ï¼Œæ–°ç”Ÿä»£åœé¡¿çš„çŸ­ä¸€ç‚¹å¯èƒ½æ˜¯0.000xç§’ï¼Œå¯æ˜¯è€å¹´ä»£åœé¡¿çš„å¯èƒ½å°±æ˜¯å‡ ç™¾ç§’ï¼Œå‡ ååˆ†é’Ÿã€‚</li><li>å±å®³<br>é•¿æ—¶é—´æœåŠ¡åœæ­¢ï¼Œæ²¡æœ‰å“åº”<br>é‡åˆ°HAç³»ç»Ÿï¼Œå¯èƒ½å¼•èµ·ä¸»å¤‡åˆ‡æ¢ï¼Œä¸¥é‡å±å®³ç”Ÿäº§ç¯å¢ƒã€‚<br>çº¿ä¸Šç³»ç»Ÿï¼Œä¸»æœºgcæ—¶é—´è¾ƒé•¿çš„æ—¶å€™ï¼Œå¤‡æœºå¯åŠ¨ï¼Œå¯æ˜¯ç¨ågcå®Œæˆäº†ä¸»æœºå†æ¬¡é‡æ–°å¯åŠ¨ï¼Œä¸»æœºå’Œå¤‡æœºéƒ½å¯åŠ¨çš„çŠ¶æ€æ˜¯ååˆ†å±é™©çš„ã€‚</li></ul><h2 id="ä¸¾ä¸ªæ —å­-1"><a href="#ä¸¾ä¸ªæ —å­-1" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><p>æ¯ç§’æ‰“å°10æ¡<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public <span class="keyword">static</span> final long starttime=System.currentTimeMillis();</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">long t=System.currentTimeMillis()-starttime;</span><br><span class="line">System.out.println(<span class="string">"time:"</span>+t);</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">HashMap&lt;Long,byte[]&gt; map=<span class="keyword">new</span> HashMap&lt;Long,byte[]&gt;();</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//å¤§äº450Mæ—¶ï¼Œæ¸…ç†å†…å­˜</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(map.size()*<span class="number">512</span>/<span class="number">1024</span>/<span class="number">1024</span>&gt;=<span class="number">450</span>)&#123;</span><br><span class="line">System.out.println(â€œ=====å‡†å¤‡æ¸…ç†=====:<span class="string">"+map.size());</span></span><br><span class="line"><span class="string">map.clear();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">//å·¥ä½œçº¿ç¨‹ï¼Œæ¶ˆè€—å†…å­˜</span></span><br><span class="line"><span class="string">for(int i=0;i&lt;1024;i++)&#123;</span></span><br><span class="line"><span class="string">map.put(System.nanoTime(), new byte[512]);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">Thread.sleep(1);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;catch(Exception e)&#123;</span></span><br><span class="line"><span class="string">e.printStackTrace();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xmx512M -Xms512M -XX:+UseSerialGC -Xloggc:gc.log -XX:+PrintGCDetails</span><br><span class="line">-Xmn1m -XX:PretenureSizeThreshold=<span class="number">50</span> -XX:MaxTenuringThreshold=<span class="number">1</span></span><br></pre></td></tr></table></figure><p></p><p>ç»“æœï¼š<br>é¢„æœŸï¼Œåº”è¯¥æ˜¯æ¯ç§’ä¸­æœ‰10æ¡è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">time:<span class="number">2018</span></span><br><span class="line">time:<span class="number">2121</span></span><br><span class="line">time:<span class="number">2221</span></span><br><span class="line">time:<span class="number">2325</span></span><br><span class="line">time:<span class="number">2425</span></span><br><span class="line">time:<span class="number">2527</span></span><br><span class="line">time:<span class="number">2631</span></span><br><span class="line">time:<span class="number">2731</span></span><br><span class="line">time:<span class="number">2834</span></span><br><span class="line">time:<span class="number">2935</span></span><br><span class="line">time:<span class="number">3035</span></span><br><span class="line">time:<span class="number">3153</span></span><br><span class="line">time:<span class="number">3504</span></span><br><span class="line">time:<span class="number">4218</span></span><br><span class="line">======before clean map=======:<span class="number">921765</span></span><br><span class="line">time:<span class="number">4349</span></span><br><span class="line">time:<span class="number">4450</span></span><br><span class="line">time:<span class="number">4551</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time:<span class="number">3153</span></span><br><span class="line">time:<span class="number">3504</span></span><br><span class="line">time:<span class="number">4218</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¹¶ä¸æ˜¯ä¸­é—´é—´éš”ä¸€ç§’</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.292</span>: [GC3<span class="number">.292</span>: [DefNew: <span class="number">959</span>K-&gt;<span class="number">63</span>K(<span class="number">960</span>K), <span class="number">0.0024260</span> secs] <span class="number">523578</span>K-&gt;<span class="number">523298</span>K(<span class="number">524224</span>K), <span class="number">0.0024879</span> secs] [Times: user=<span class="number">0.02</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="number">3.296</span>: [GC3<span class="number">.296</span>: [DefNew: <span class="number">959</span>K-&gt;<span class="number">959</span>K(<span class="number">960</span>K), <span class="number">0.0000123</span> secs]<span class="number">3.296</span>: [Tenured: <span class="number">523235</span>K-&gt;<span class="number">523263</span>K(<span class="number">523264</span>K), <span class="number">0.2820915</span> secs] <span class="number">524195</span>K-&gt;<span class="number">523870</span>K(<span class="number">524224</span>K), [Perm : <span class="number">147</span>K-&gt;<span class="number">147</span>K(<span class="number">12288</span>K)], <span class="number">0.2821730</span> secs] [Times: user=<span class="number">0.26</span> sys=<span class="number">0.00</span>, real=<span class="number">0.28</span> secs] </span><br><span class="line"><span class="number">3.579</span>: [Full GC3<span class="number">.579</span>: [Tenured: <span class="number">523263</span>K-&gt;<span class="number">523263</span>K(<span class="number">523264</span>K), <span class="number">0.2846036</span> secs] <span class="number">524159</span>K-&gt;<span class="number">524042</span>K(<span class="number">524224</span>K), [Perm : <span class="number">147</span>K-&gt;<span class="number">147</span>K(<span class="number">12288</span>K)], <span class="number">0.2846745</span> secs] [Times: user=<span class="number">0.28</span> sys=<span class="number">0.00</span>, real=<span class="number">0.28</span> secs] </span><br><span class="line"><span class="number">3.863</span>: [Full GC3<span class="number">.863</span>: [Tenured: <span class="number">523263</span>K-&gt;<span class="number">515818</span>K(<span class="number">523264</span>K), <span class="number">0.4282780</span> secs] <span class="number">524042</span>K-&gt;<span class="number">515818</span>K(<span class="number">524224</span>K), [Perm : <span class="number">147</span>K-&gt;<span class="number">147</span>K(<span class="number">12288</span>K)], <span class="number">0.4283353</span> secs] [Times: user=<span class="number">0.42</span> sys=<span class="number">0.00</span>, real=<span class="number">0.43</span> secs] </span><br><span class="line"><span class="number">4.293</span>: [GC4<span class="number">.293</span>: [DefNew: <span class="number">896</span>K-&gt;<span class="number">64</span>K(<span class="number">960</span>K), <span class="number">0.0017584</span> secs] <span class="number">516716</span>K-&gt;<span class="number">516554</span>K(<span class="number">524224</span>K), <span class="number">0.0018346</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">â€¦â€¦çœç•¥è‹¥å¹²â€¦..</span><br><span class="line"><span class="number">4.345</span>: [GC4<span class="number">.345</span>: [DefNew: <span class="number">960</span>K-&gt;<span class="number">960</span>K(<span class="number">960</span>K), <span class="number">0.0000156</span> secs]<span class="number">4.345</span>: [Tenured: <span class="number">522929</span>K-&gt;<span class="number">12436</span>K(<span class="number">523264</span>K), <span class="number">0.0781624</span> secs] <span class="number">523889</span>K-&gt;<span class="number">12436</span>K(<span class="number">524224</span>K), [Perm : <span class="number">147</span>K-&gt;<span class="number">147</span>K(<span class="number">12288</span>K)], <span class="number">0.0782611</span> secs] [Times: user=<span class="number">0.08</span> sys=<span class="number">0.00</span>, real=<span class="number">0.08</span> secs]</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.296</span>: Times: user=<span class="number">0.26</span> sys=<span class="number">0.00</span>, real=<span class="number">0.28</span> secs</span><br><span class="line"><span class="number">3.579</span>ï¼šTimes: user=<span class="number">0.28</span> sys=<span class="number">0.00</span>, real=<span class="number">0.28</span> secs</span><br><span class="line"><span class="number">3.863</span>ï¼šTimes: user=<span class="number">0.42</span> sys=<span class="number">0.00</span>, real=<span class="number">0.43</span> secs</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼šå› ä¸ºç³»ç»Ÿçš„gcåœé¡¿å¯¼è‡´äº†æœ¬åº”è¯¥æ¯ç§’è¾“å‡ºçš„æ—¶é—´æœ‰äº†è¯¯å·®ã€‚<br>å› ä¸ºä¸€ä¸ªæ˜¯ç³»ç»Ÿçº¿ç¨‹ï¼ˆgcï¼‰ï¼Œä¸€ä¸ªæ˜¯åº”ç”¨çº§åˆ«çš„çº¿ç¨‹æ‰€ä»¥æ—¶é—´çš„æ˜¾ç¤ºå¯èƒ½æœ‰äº›è¯¯å·®ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;GCçš„æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#GCçš„æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;GCçš„æ¦‚å¿µ&quot;&gt;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šå¸¸ç”¨JVMé…ç½®å‚æ•°</title>
    <link href="http://mmmmmm.me/2019-02-24-1.html"/>
    <id>http://mmmmmm.me/2019-02-24-1.html</id>
    <published>2019-02-24T14:20:02.000Z</published>
    <updated>2019-02-24T03:28:45.511Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="Traceè·Ÿè¸ªå‚æ•°"><a href="#Traceè·Ÿè¸ªå‚æ•°" class="headerlink" title="Traceè·Ÿè¸ªå‚æ•°"></a>Traceè·Ÿè¸ªå‚æ•°</h1><h2 id="verbose-gc-æ‰“å¼€gcçš„è·Ÿè¸ªæƒ…å†µ"><a href="#verbose-gc-æ‰“å¼€gcçš„è·Ÿè¸ªæƒ…å†µ" class="headerlink" title="-verbose:gc (æ‰“å¼€gcçš„è·Ÿè¸ªæƒ…å†µ)"></a>-verbose:gc (æ‰“å¼€gcçš„è·Ÿè¸ªæƒ…å†µ)</h2><h2 id="XX-printGCï¼ˆæ‰“å¼€gcçš„logå¼€å…³ï¼Œå¦‚æœåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†gcï¼Œå°±ä¼šæ‰“å°å‡ºç›¸å…³çš„ä¿¡æ¯ã€‚ï¼‰"><a href="#XX-printGCï¼ˆæ‰“å¼€gcçš„logå¼€å…³ï¼Œå¦‚æœåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†gcï¼Œå°±ä¼šæ‰“å°å‡ºç›¸å…³çš„ä¿¡æ¯ã€‚ï¼‰" class="headerlink" title="-XX:+printGCï¼ˆæ‰“å¼€gcçš„logå¼€å…³ï¼Œå¦‚æœåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†gcï¼Œå°±ä¼šæ‰“å°å‡ºç›¸å…³çš„ä¿¡æ¯ã€‚ï¼‰"></a>-XX:+printGCï¼ˆæ‰“å¼€gcçš„logå¼€å…³ï¼Œå¦‚æœåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†gcï¼Œå°±ä¼šæ‰“å°å‡ºç›¸å…³çš„ä¿¡æ¯ã€‚ï¼‰</h2><ul><li>å¯ä»¥æ‰“å°GCçš„ç®€è¦ä¿¡æ¯<br>[GC 4790K-&gt;374K(15872K), 0.0001606 secs]<br>[GC 4790K-&gt;374K(15872K), 0.0001474 secs]<br>[GC 4790K-&gt;374K(15872K), 0.0001563 secs]<br>[GC 4790K-&gt;374K(15872K), 0.0001682 secs]<br>ä¸Šé¢è¿™è¡Œçš„è§£é‡Šï¼šå †åœ¨gcä¹‹å‰ç”¨äº†4mï¼Œåœ¨gcä¹‹åç”¨äº†374kï¼Œå›æ”¶äº†å°†è¿‘4mçš„å¤§å°ï¼Œæ•´ä¸ªå †çš„å¤§å°15872K<h2 id="XX-PrintGCDetails"><a href="#XX-PrintGCDetails" class="headerlink" title="-XX:+PrintGCDetails"></a>-XX:+PrintGCDetails</h2>æ‰“å°GCè¯¦ç»†ä¿¡æ¯<h2 id="XX-PrintGCTimeStamps"><a href="#XX-PrintGCTimeStamps" class="headerlink" title="XX:+PrintGCTimeStamps"></a>XX:+PrintGCTimeStamps</h2>æ‰“å°CGå‘ç”Ÿçš„æ—¶é—´æˆ³</li><li>ä¾‹<br>è¿™æ˜¯ä¸€ä¸ªPrintGCDetailsçš„log<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GC[DefNew: <span class="number">4416</span>K-&gt;<span class="number">0</span>K(<span class="number">4928</span>K), <span class="number">0.0001897</span> secs] <span class="number">4790</span>K-&gt;<span class="number">374</span>K(<span class="number">15872</span>K), <span class="number">0.0002232</span> secs] </span><br><span class="line">[Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br></pre></td></tr></table></figure></li></ul><p>DefNew: 4416K-&gt;0K(4928K), 0.0001897 secsè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–°ç”Ÿä»£çš„gc</p><ul><li>-XX:+PrintGCDetailsçš„è¾“å‡ºï¼Œåœ¨ç¨‹åºè¿è¡Œç»“æŸåçš„ä¸€æ®µæè¿°<br>PrintGCDetailsä¼šæŠŠç¨‹åºè¿è¡Œç»“æŸåï¼Œæ•´ä¸ªç¨‹åºçš„å †çš„æƒ…å†µæ‰“å°å‡ºæ¥</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Heap</span><br><span class="line"><span class="comment">//æ–°ç”Ÿä»£æ€»çš„ç©ºé—´13824Kï¼Œç”¨äº†11223K</span></span><br><span class="line"><span class="comment">//0x27e80000ä½è¾¹ç•Œï¼Œèµ·å§‹ä½ç½®ï¼Œ0x28d80000ï¼Œå½“å‰æ‰€åˆ†é…çš„ï¼Œæ‰€ç”³è¯·åˆ°çš„ä½ç½®ï¼Œ</span></span><br><span class="line"><span class="comment">//0x28d80000æœ€é«˜è¾¹ç•Œï¼Œæœ€å¤šèƒ½ç”³è¯·åˆ°çš„ä½ç½®ã€‚ä»ç°åœ¨æ¥çœ‹æ–°ç”Ÿä»£å·²ç»å…¨éƒ¨ç”³è¯·å®Œäº†ï¼Œå·²ç»ä¸èƒ½å†åšæ‰©å±•äº†ã€‚</span></span><br><span class="line"><span class="comment">//ï¼ˆ0x28d80000-0x27e80000)/1024/1024=15Mè¯´æ˜æ–°ç”Ÿä»£æ­£å¥½15m</span></span><br><span class="line"><span class="comment">//ä¹Ÿå°±æ­£å¥½æ˜¯eden+from+toï¼Œä½†æ˜¯å’Œ13824Kæ˜¯ä¸ç›¸ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯åˆ†é…äº†15mï¼Œä½†æ˜¯åªæœ‰</span></span><br><span class="line"><span class="comment">//13824Kå¯ç”¨ï¼Œä¸ºä»€ä¹ˆï¼Ÿåé¢å­¦ä¹ gcçš„ç®—æ³•ã€‚</span></span><br><span class="line">def <span class="keyword">new</span> generation   total <span class="number">13824</span>K, used <span class="number">11223</span>K [<span class="number">0x27e80000</span>, <span class="number">0x28d80000</span>, <span class="number">0x28d80000</span>)</span><br><span class="line"><span class="comment">//yidenï¼ˆä¼Šç”¸å›­ï¼‰å¯¹è±¡å‡ºç”Ÿçš„åœ°æ–¹ï¼Œæ€»å…±12288Kï¼Œ91%è¢«ä½¿ç”¨äº†</span></span><br><span class="line">eden space <span class="number">12288</span>K,  <span class="number">91</span>% used [<span class="number">0x27e80000</span>, <span class="number">0x28975f20</span>, <span class="number">0x28a80000</span>)</span><br><span class="line"><span class="comment">//fromå’Œtoçš„å¤§å°æ˜¯å¿…é¡»ç›¸ç­‰çš„</span></span><br><span class="line"><span class="keyword">from</span> space <span class="number">1536</span>K,   <span class="number">0</span>% used [<span class="number">0x28a80000</span>, <span class="number">0x28a80000</span>, <span class="number">0x28c00000</span>)</span><br><span class="line">to   space <span class="number">1536</span>K,   <span class="number">0</span>% used [<span class="number">0x28c00000</span>, <span class="number">0x28c00000</span>, <span class="number">0x28d80000</span>)</span><br><span class="line"><span class="comment">//è€å¹´ä»£ï¼Œæ€»å…±5120Kï¼Œå·²ç»ä½¿ç”¨0k</span></span><br><span class="line">tenured generation   total <span class="number">5120</span>K, used <span class="number">0</span>K [<span class="number">0x28d80000</span>, <span class="number">0x29280000</span>, <span class="number">0x34680000</span>)</span><br><span class="line">the space <span class="number">5120</span>K,   <span class="number">0</span>% used [<span class="number">0x28d80000</span>, <span class="number">0x28d80000</span>, <span class="number">0x28d80200</span>, <span class="number">0x29280000</span>)</span><br><span class="line"><span class="comment">//æŒä¹…å¸¦ï¼Œæ°¸ä¹…åŒºï¼Œæ–¹æ³•åŒºã€‚</span></span><br><span class="line">compacting perm gen  total <span class="number">12288</span>K, used <span class="number">142</span>K [<span class="number">0x34680000</span>, <span class="number">0x35280000</span>, <span class="number">0x38680000</span>)</span><br><span class="line"><span class="comment">//ä¸ºä»€ä¹ˆuse142kç›¸å¯¹è¾ƒå°ï¼Ÿ</span></span><br><span class="line"><span class="comment">//å› ä¸ºåœ¨jdk5.0ä¹‹åï¼Œåœ¨ä¸²è¡Œgcçš„æ¨¡å¼ä¹‹ä¸‹ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæ°¸ä¹…åŒºçš„å…±äº«ï¼Œå«åšç±»çš„å…±äº«</span></span><br><span class="line"><span class="comment">//æ‰“å¼€ç±»çš„å…±äº«ä¹‹åä¸€äº›åŸºç¡€çš„javaçš„ç±»ä¼šè¢«åŠ è½½åˆ°ä¸€ä¸ªå…±äº«åŒºé—´ï¼Œä¾›æ‰€æœ‰çš„jvmä½¿ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment">//roå’Œrwå°±æ˜¯å…±äº«åŒºé—´çš„å¤§å°ï¼Œä¸€ä¸ªæ˜¯åªè¯»çš„ï¼Œä¸€ä¸ªæ˜¯å¯è¯»å¯å†™çš„ï¼Œå å¾—æ¯”é‡æ¯”è¾ƒå¤§äº†</span></span><br><span class="line">the space <span class="number">12288</span>K,   <span class="number">1</span>% used [<span class="number">0x34680000</span>, <span class="number">0x346a3a90</span>, <span class="number">0x346a3c00</span>, <span class="number">0x35280000</span>)</span><br><span class="line">ro space <span class="number">10240</span>K,  <span class="number">44</span>% used [<span class="number">0x38680000</span>, <span class="number">0x38af73f0</span>, <span class="number">0x38af7400</span>, <span class="number">0x39080000</span>)</span><br><span class="line">rw space <span class="number">12288</span>K,  <span class="number">52</span>% used [<span class="number">0x39080000</span>, <span class="number">0x396cdd28</span>, <span class="number">0x396cde00</span>, <span class="number">0x39c80000</span>)</span><br></pre></td></tr></table></figure><h2 id="Xloggc-log-gc-log"><a href="#Xloggc-log-gc-log" class="headerlink" title="-Xloggc:log/gc.log"></a>-Xloggc:log/gc.log</h2><p>æŒ‡å®šGC logçš„ä½ç½®ï¼Œä»¥æ–‡ä»¶è¾“å‡º<br>å¸®åŠ©å¼€å‘äººå‘˜åˆ†æé—®é¢˜<br>å› ä¸ºä¸€èˆ¬gcæ—¥å¿—çš„è¾“å‡ºéƒ½æ˜¯åœ¨æ§åˆ¶å°çš„ï¼Œä¸ä¾¿äºä¿ç•™ã€‚</p><h2 id="XX-PrintHeapAtGC"><a href="#XX-PrintHeapAtGC" class="headerlink" title="-XX:+PrintHeapAtGC"></a>-XX:+PrintHeapAtGC</h2><p>æ¯æ¬¡ä¸€æ¬¡GCåï¼Œéƒ½æ‰“å°å †ä¿¡æ¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="comment">//gcä¹‹å‰çš„ä¿¡æ¯</span></span><br><span class="line">Heap before GC invocations=<span class="number">0</span> (full <span class="number">0</span>):</span><br><span class="line"> def <span class="keyword">new</span> generation   total <span class="number">3072</span>K, used <span class="number">2752</span>K [<span class="number">0x33c80000</span>, <span class="number">0x33fd0000</span>, <span class="number">0x33fd0000</span>)</span><br><span class="line">  eden space <span class="number">2752</span>K, <span class="number">100</span>% used [<span class="number">0x33c80000</span>, <span class="number">0x33f30000</span>, <span class="number">0x33f30000</span>)</span><br><span class="line">  <span class="keyword">from</span> space <span class="number">320</span>K,   <span class="number">0</span>% used [<span class="number">0x33f30000</span>, <span class="number">0x33f30000</span>, <span class="number">0x33f80000</span>)</span><br><span class="line">  to   space <span class="number">320</span>K,   <span class="number">0</span>% used [<span class="number">0x33f80000</span>, <span class="number">0x33f80000</span>, <span class="number">0x33fd0000</span>)</span><br><span class="line"> tenured generation   total <span class="number">6848</span>K, used <span class="number">0</span>K [<span class="number">0x33fd0000</span>, <span class="number">0x34680000</span>, <span class="number">0x34680000</span>)</span><br><span class="line">   the space <span class="number">6848</span>K,   <span class="number">0</span>% used [<span class="number">0x33fd0000</span>, <span class="number">0x33fd0000</span>, <span class="number">0x33fd0200</span>, <span class="number">0x34680000</span>)</span><br><span class="line"> compacting perm gen  total <span class="number">12288</span>K, used <span class="number">143</span>K [<span class="number">0x34680000</span>, <span class="number">0x35280000</span>, <span class="number">0x38680000</span>)</span><br><span class="line">   the space <span class="number">12288</span>K,   <span class="number">1</span>% used [<span class="number">0x34680000</span>, <span class="number">0x346a3c58</span>, <span class="number">0x346a3e00</span>, <span class="number">0x35280000</span>)</span><br><span class="line">    ro space <span class="number">10240</span>K,  <span class="number">44</span>% used [<span class="number">0x38680000</span>, <span class="number">0x38af73f0</span>, <span class="number">0x38af7400</span>, <span class="number">0x39080000</span>)</span><br><span class="line">    rw space <span class="number">12288</span>K,  <span class="number">52</span>% used [<span class="number">0x39080000</span>, <span class="number">0x396cdd28</span>, <span class="number">0x396cde00</span>, <span class="number">0x39c80000</span>)</span><br><span class="line"><span class="comment">//è¿™é‡Œæ­£å¥½æ˜¯ä¸€æ¬¡gc</span></span><br><span class="line">[GC[DefNew: <span class="number">2752</span>K-&gt;<span class="number">320</span>K(<span class="number">3072</span>K), <span class="number">0.0014296</span> secs] <span class="number">2752</span>K-&gt;<span class="number">377</span>K(<span class="number">9920</span>K), <span class="number">0.0014604</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="comment">//gcä¹‹åçš„ä¿¡æ¯</span></span><br><span class="line">Heap after GC invocations=<span class="number">1</span> (full <span class="number">0</span>):</span><br><span class="line"> def <span class="keyword">new</span> generation   total <span class="number">3072</span>K, used <span class="number">320</span>K [<span class="number">0x33c80000</span>, <span class="number">0x33fd0000</span>, <span class="number">0x33fd0000</span>)</span><br><span class="line">  eden space <span class="number">2752</span>K,   <span class="number">0</span>% used [<span class="number">0x33c80000</span>, <span class="number">0x33c80000</span>, <span class="number">0x33f30000</span>)</span><br><span class="line">  <span class="keyword">from</span> space <span class="number">320</span>K, <span class="number">100</span>% used [<span class="number">0x33f80000</span>, <span class="number">0x33fd0000</span>, <span class="number">0x33fd0000</span>)</span><br><span class="line">  to   space <span class="number">320</span>K,   <span class="number">0</span>% used [<span class="number">0x33f30000</span>, <span class="number">0x33f30000</span>, <span class="number">0x33f80000</span>)</span><br><span class="line"> tenured generation   total <span class="number">6848</span>K, used <span class="number">57</span>K [<span class="number">0x33fd0000</span>, <span class="number">0x34680000</span>, <span class="number">0x34680000</span>)</span><br><span class="line">   the space <span class="number">6848</span>K,   <span class="number">0</span>% used [<span class="number">0x33fd0000</span>, <span class="number">0x33fde458</span>, <span class="number">0x33fde600</span>, <span class="number">0x34680000</span>)</span><br><span class="line"> compacting perm gen  total <span class="number">12288</span>K, used <span class="number">143</span>K [<span class="number">0x34680000</span>, <span class="number">0x35280000</span>, <span class="number">0x38680000</span>)</span><br><span class="line">   the space <span class="number">12288</span>K,   <span class="number">1</span>% used [<span class="number">0x34680000</span>, <span class="number">0x346a3c58</span>, <span class="number">0x346a3e00</span>, <span class="number">0x35280000</span>)</span><br><span class="line">    ro space <span class="number">10240</span>K,  <span class="number">44</span>% used [<span class="number">0x38680000</span>, <span class="number">0x38af73f0</span>, <span class="number">0x38af7400</span>, <span class="number">0x39080000</span>)</span><br><span class="line">    rw space <span class="number">12288</span>K,  <span class="number">52</span>% used [<span class="number">0x39080000</span>, <span class="number">0x396cdd28</span>, <span class="number">0x396cde00</span>, <span class="number">0x39c80000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="XX-TraceClassLoading"><a href="#XX-TraceClassLoading" class="headerlink" title="-XX:+TraceClassLoading"></a>-XX:+TraceClassLoading</h2><p>ç›‘æ§ç±»çš„åŠ è½½<br>[Loaded java.lang.Object from shared objects file]<br>[Loaded java.io.Serializable from shared objects file]<br>[Loaded java.lang.Comparable from shared objects file]<br>[Loaded java.lang.CharSequence from shared objects file]<br>[Loaded java.lang.String from shared objects file]<br>[Loaded java.lang.reflect.GenericDeclaration from shared objects file]<br>[Loaded java.lang.reflect.Type from shared objects file]</p><h2 id="XX-PrintClassHistogram"><a href="#XX-PrintClassHistogram" class="headerlink" title="-XX:+PrintClassHistogram"></a>-XX:+PrintClassHistogram</h2><p>æ‰“å°ç±»çš„ç›´æ–¹å›¾<br>åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŒ‰ä¸‹Ctrl+Breakåï¼Œæ‰“å°ç±»çš„ä¿¡æ¯ï¼š<br>æ‰€æœ‰çš„ç±»çš„ä½¿ç”¨æƒ…å†µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> num     #instances      #bytes    class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   <span class="number">1</span>:        <span class="number">890617</span>      <span class="number">470266000</span>  [B    <span class="comment">//byteæ•°ç»„</span></span><br><span class="line">   <span class="number">2</span>:        <span class="number">890643</span>       <span class="number">21375432</span>  java.util.HashMap$Node<span class="comment">//hashMapçš„èŠ‚ç‚¹æ•°ã€‚</span></span><br><span class="line">   <span class="number">3</span>:        <span class="number">890608</span>       <span class="number">14249728</span>  java.lang.Long</span><br><span class="line">   <span class="number">4</span>:            <span class="number">13</span>        <span class="number">8389712</span>  [Ljava.util.HashMap$Node;</span><br><span class="line">   <span class="number">5</span>:          <span class="number">2062</span>         <span class="number">371680</span>  [C</span><br><span class="line">   <span class="number">6</span>:           <span class="number">463</span>          <span class="number">41904</span>  java.lang.Class</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«æ˜¾ç¤ºï¼šåºå·ã€å®ä¾‹æ•°é‡ã€æ€»å¤§å°ï¼ˆå ç”¨çš„ç©ºé—´ï¼‰ã€ç±»å‹</p><h1 id="å †çš„åˆ†é…å‚æ•°"><a href="#å †çš„åˆ†é…å‚æ•°" class="headerlink" title="å †çš„åˆ†é…å‚æ•°"></a>å †çš„åˆ†é…å‚æ•°</h1><h2 id="Xmx-â€“Xms"><a href="#Xmx-â€“Xms" class="headerlink" title="Xmx â€“Xms"></a>Xmx â€“Xms</h2><p>æŒ‡å®šæœ€å¤§å †å’Œæœ€å°å †(åªè¦jvmä¸€å¯åŠ¨ï¼Œè¿™ä¹ˆå¤šçš„ç©ºé—´å°±æ˜¯è¢«å ç”¨çš„ã€‚)</p><ul><li>-Xmx20m -Xms5m è¿è¡Œä»£ç ï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">System.out.print(<span class="string">"Xmx="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().maxMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"><span class="comment">//æœ€å¤§ç©ºé—´</span></span><br><span class="line">System.out.print(<span class="string">"free mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().freeMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"><span class="comment">//ç©ºé—²çš„ç©ºé—´</span></span><br><span class="line">System.out.print(<span class="string">"total mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().totalMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"><span class="comment">//æ€»çš„ç©ºé—´ã€ç›®å‰åˆ†é…åˆ°çš„ç©ºé—´</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Xmx=<span class="number">19.375</span>M  ï¼ˆXmxï¼‰</span><br><span class="line">free mem=<span class="number">4.342750549316406</span>M</span><br><span class="line">total mem=<span class="number">4.875</span>M ï¼ˆXmsï¼‰</span><br></pre></td></tr></table></figure><p>-Xmx20m -Xms5m è¿è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">byte[] b=<span class="keyword">new</span> byte[<span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">System.out.println(<span class="string">"åˆ†é…äº†1Mç©ºé—´ç»™æ•°ç»„"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"Xmx="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().maxMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"free mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().freeMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"total mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().totalMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åˆ†é…äº†<span class="number">1</span>Mç©ºé—´ç»™æ•°ç»„</span><br><span class="line">Xmx=<span class="number">19.375</span>M</span><br><span class="line">free mem=<span class="number">3.4791183471679688</span>M</span><br><span class="line">total mem=<span class="number">4.875</span>M</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸ºä»€ä¹ˆtotalè¿˜æ˜¯<span class="number">5</span>mï¼ŒJavaä¼šå°½å¯èƒ½ç»´æŒåœ¨æœ€å°å †ï¼ˆXmsï¼‰ã€‚</span><br></pre></td></tr></table></figure><p>-Xmx20m -Xms5m è¿è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">b=<span class="keyword">new</span> byte[<span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">System.out.println(<span class="string">"åˆ†é…äº†4Mç©ºé—´ç»™æ•°ç»„"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"Xmx="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().maxMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"free mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().freeMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"total mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().totalMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åˆ†é…äº†<span class="number">4</span>Mç©ºé—´ç»™æ•°ç»„</span><br><span class="line">Xmx=<span class="number">19.375</span>M</span><br><span class="line">free mem=<span class="number">3.5899810791015625</span>M</span><br><span class="line">total mem=<span class="number">9.00390625</span>M</span><br><span class="line">æ€»å†…å­˜å˜å¤šäº†</span><br></pre></td></tr></table></figure><p>-Xmx20m -Xms5m è¿è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">System.gc();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"å›æ”¶å†…å­˜"</span>);</span><br><span class="line">System.out.print(<span class="string">"Xmx="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().maxMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"free mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().freeMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br><span class="line"></span><br><span class="line">System.out.print(<span class="string">"total mem="</span>);</span><br><span class="line">System.out.println(Runtime.getRuntime().totalMemory()/<span class="number">1024.0</span>/<span class="number">1024</span>+<span class="string">"M"</span>);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å›æ”¶å†…å­˜</span><br><span class="line">Xmx=<span class="number">19.375</span>M</span><br><span class="line">free mem=<span class="number">6.354591369628906</span>M</span><br><span class="line">total mem=<span class="number">10.75390625</span>M</span><br><span class="line">ç©ºé—²å†…å­˜å˜å¤šäº†</span><br></pre></td></tr></table></figure><h2 id="å°é—®é¢˜ï¼š"><a href="#å°é—®é¢˜ï¼š" class="headerlink" title="å°é—®é¢˜ï¼š"></a>å°é—®é¢˜ï¼š</h2><p>-Xmx å’Œ â€“Xms åº”è¯¥ä¿æŒä¸€ä¸ªä»€ä¹ˆå…³ç³»ï¼Œå¯ä»¥è®©ç³»ç»Ÿçš„æ€§èƒ½å°½å¯èƒ½çš„å¥½å‘¢ï¼Ÿ<br>å¦‚æœä½ è¦åšä¸€ä¸ªJavaçš„æ¡Œé¢äº§å“ï¼Œéœ€è¦ç»‘å®šJREï¼Œä½†æ˜¯JREåˆå¾ˆå¤§ï¼Œä½ å¦‚ä½•åšä¸€ä¸‹JREçš„ç˜¦èº«å‘¢ï¼Ÿ</p><h2 id="Xmn"><a href="#Xmn" class="headerlink" title="Xmn"></a>Xmn</h2><p>è®¾ç½®æ–°ç”Ÿä»£å¤§å°ï¼ˆå¤§å°çš„ç»å¯¹å€¼ï¼Œæ¯”å¦‚æ˜¯5må°±æ˜¯5mï¼‰</p><h2 id="XX-NewRatio"><a href="#XX-NewRatio" class="headerlink" title="-XX:NewRatio"></a>-XX:NewRatio</h2><p>æ–°ç”Ÿä»£ï¼ˆeden+2*sï¼ˆeden+from+toï¼‰ï¼‰å’Œè€å¹´ä»£ï¼ˆä¸åŒ…å«æ°¸ä¹…åŒºï¼‰çš„æ¯”å€¼<br>4 è¡¨ç¤º æ–°ç”Ÿä»£:è€å¹´ä»£=1:4ï¼Œå³å¹´è½»ä»£å å †çš„1/5<br>NewRatioå’ŒXmnçš„åŒºåˆ«æ˜¯ï¼šä¸€ä¸ªæ˜¯æ¯”å€¼ï¼Œä¸€ä¸ªæ˜¯ç»å¯¹å€¼ã€‚</p><h2 id="XX-SurvivorRatio"><a href="#XX-SurvivorRatio" class="headerlink" title="-XX:SurvivorRatio"></a>-XX:SurvivorRatio</h2><p>è®¾ç½®ä¸¤ä¸ªSurvivoråŒºï¼ˆå¹¸å­˜åŒºï¼Œfrom+toï¼‰å’Œedençš„æ¯”<br>8è¡¨ç¤º ä¸¤ä¸ªSurvivor :eden=2:8ï¼Œå³ä¸€ä¸ªSurvivorå å¹´è½»ä»£çš„1/10</p><h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><h3 id="æ —å­ä¸€"><a href="#æ —å­ä¸€" class="headerlink" title="æ —å­ä¸€"></a>æ —å­ä¸€</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">   byte[] b=<span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">       b=<span class="keyword">new</span> byte[<span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼šä»¥ä¸Šä»£ç ä¸€å…±åˆ†é…10mçš„ç©ºé—´</font></strong><br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m -Xmn1m  -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p></p><p><img alt="" data-original="/images/15509788100159.png"></p><p>æ–°ç”Ÿä»£ï¼ˆeden+from+toï¼‰ä¸€å…±1mï¼Œä¸èƒ½å¤Ÿåˆ†é…10mï¼Œæ‰€ä»¥å…¨éƒ¨åˆ†é…åˆ°äº†å¹´è€ä»£ï¼Œå› ä¸ºæ²¡æœ‰åˆ°è¾¾gcçš„æ¡ä»¶ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ²¡æœ‰è§¦å‘GC</span><br><span class="line">å…¨éƒ¨åˆ†é…åœ¨è€å¹´ä»£</span><br></pre></td></tr></table></figure><p></p><h3 id="æ —å­äºŒ"><a href="#æ —å­äºŒ" class="headerlink" title="æ —å­äºŒ"></a>æ —å­äºŒ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m -Xmn15m  -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509788215168.png"></p><p>æ–°ç”Ÿä»£è°ƒæ•´åˆ°15mã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ²¡æœ‰è§¦å‘GC</span><br><span class="line">å…¨éƒ¨åˆ†é…åœ¨eden</span><br><span class="line">è€å¹´ä»£æ²¡æœ‰ä½¿ç”¨</span><br></pre></td></tr></table></figure><p></p><h3 id="æ —å­ä¸‰"><a href="#æ —å­ä¸‰" class="headerlink" title="æ —å­ä¸‰"></a>æ —å­ä¸‰</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m â€“Xmn7m  -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509788343265.png"></p><p>æ–°ç”Ÿä»£è°ƒæ•´åˆ°7mï¼Œfromå’Œtoéƒ½æ˜¯700kï¼Œè¿˜ä¸è¶³ä»¥æ”¾ä¸‹1mçš„å¯¹è±¡ï¼Œæ‰€ä»¥æœ‰å¯¹è±¡è¿›å…¥äº†è€å¹´ä»£ã€‚<br>gcç¬¬ä¸€æ¬¡å›æ”¶äº†3mï¼Œç¬¬äºŒæ¬¡å›æ”¶äº†4mï¼Œæ‰€ä»¥æœ€åè¿˜å‰©ä¸‹3mçš„ç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°å¹´è½»ä»£1mï¼Œå¹´è€ä»£2mã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>è¿›è¡Œäº†<span class="number">2</span>æ¬¡æ–°ç”Ÿä»£GC</span><br><span class="line"><span class="number">2.</span>s0 s1 å¤ªå°éœ€è¦è€å¹´ä»£æ‹…ä¿</span><br></pre></td></tr></table></figure><h3 id="æ —å­å››"><a href="#æ —å­å››" class="headerlink" title="æ —å­å››"></a>æ —å­å››</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m -Xmn7m   -XX:SurvivorRatio=<span class="number">2</span> -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509788447776.png"></p><p>è°ƒæ•´äº†å¹¸å­˜åŒºçš„å¤§å°fromå’Œtoæ¯ä¸ª1.7mï¼Œå› ä¸ºç©ºé—´è¶³å¤Ÿï¼Œæ‰€ä»¥è¿›è¡Œäº†ä¸‰æ¬¡gcï¼Œåœ¨å¹´è½»ä»£è¿›è¡Œäº†ä¸‰æ¬¡gcï¼Œæ‰€ä»¥å¹´è€ä»£å¹¶æ²¡æœ‰åˆ†é…å¤ªå¤šçš„ç©ºé—´ã€‚<br>å¹´è€ä»£çš„459kæ˜¯ç³»ç»Ÿçº§åˆ«çš„ï¼ˆæ¯”å¦‚classloaderã€çº¿ç¨‹å¯¹è±¡å®ä¾‹ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>è¿›è¡Œäº†<span class="number">3</span>æ¬¡æ–°ç”Ÿä»£GC</span><br><span class="line"><span class="number">2.</span>s0 s1 å¢å¤§</span><br></pre></td></tr></table></figure><h3 id="æ —å­äº”"><a href="#æ —å­äº”" class="headerlink" title="æ —å­äº”"></a>æ —å­äº”</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m -XX:NewRatio=<span class="number">1</span>   </span><br><span class="line">-XX:SurvivorRatio=<span class="number">2</span> -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509788557675.png"></p><p>åŠ å¤§å¹¸å­˜åŒºçš„æ¯”ä¾‹ï¼Œgcæ­£å¸¸ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ•°æ®åœ¨æ–°ç”Ÿä»£åšäº†å¤„ç†ï¼Œä¸€å…±å›æ”¶äº†7mçš„ç©ºé—´ï¼Œå‰©ä¸‹çš„3mè¿˜åœ¨æ–°ç”Ÿä»£ï¼Œæ²¡æœ‰è€å¹´ä»£çš„gcå‘ç”Ÿã€‚</p><h3 id="æ —å­å…­"><a href="#æ —å­å…­" class="headerlink" title="æ —å­å…­"></a>æ —å­å…­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xmx20m -Xms20m -XX:NewRatio=<span class="number">1</span>   </span><br><span class="line">-XX:SurvivorRatio=<span class="number">3</span> -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509788651915.png"></p><p>å¯¹æ–°ç”Ÿä»£åšä¸€å®šçš„è°ƒæ•´ï¼Œgcè¶Šå¤šï¼Œå¯¹ç³»ç»Ÿçš„å‹åŠ›è¶Šå¤§ã€‚å¹¸å­˜ä»£å¤§äº†ä¹‹åå®¹æ˜“å½¢æˆç©ºé—´æµªè´¹ï¼Œedenå˜å¤§ï¼Œå¹¸å­˜åŒºå˜å°ï¼Œgcæ¬¡æ•°å˜å°ï¼Œå¾ˆå¤šå¯¹è±¡æ²¡æœ‰æœºä¼šæ™‹å‡åˆ°è€å¹´ä»£ï¼Œè€å¹´ä»£æ‰€ä½¿ç”¨çš„ç©ºé—´å°±å˜æˆäº†0.</p><h2 id="XX-HeapDumpOnOutOfMemoryError"><a href="#XX-HeapDumpOnOutOfMemoryError" class="headerlink" title="-XX:+HeapDumpOnOutOfMemoryError"></a>-XX:+HeapDumpOnOutOfMemoryError</h2><p>OutOfMemoryçš„æ—¶å€™åšä¸€ä¸ªå †çš„è½¬å­˜ï¼Œä¸€èˆ¬ç³»ç»ŸOutOfMemoryä¹‹åä¼šé©¬ä¸Šdownæ‰ï¼Œä¸ºäº†ä¾¿äºåˆ†æï¼Œåœ¨ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œå°±è®©å †ä¿¡æ¯è½¬å­˜å‡ºæ¥ï¼Œåœ¨downæ‰ä¹‹åèƒ½å¤Ÿå¾—åˆ°æœ‰ç”¨çš„å †ä¿¡æ¯ï¼Œæ¨æµ‹å½“å‰ç³»ç»Ÿdownæ‰çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆã€‚<br>OOMæ—¶å¯¼å‡ºå †åˆ°æ–‡ä»¶</p><h2 id="XX-HeapDumpPath"><a href="#XX-HeapDumpPath" class="headerlink" title="-XX:+HeapDumpPath"></a>-XX:+HeapDumpPath</h2><p>å¯¼å‡ºOOMçš„è·¯å¾„</p><h2 id="Xmx20m-Xms5m-XX-HeapDumpOnOutOfMemoryError-XX-HeapDumpPath-d-a-dump"><a href="#Xmx20m-Xms5m-XX-HeapDumpOnOutOfMemoryError-XX-HeapDumpPath-d-a-dump" class="headerlink" title="-Xmx20m -Xms5m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=d:/a.dump"></a>-Xmx20m -Xms5m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=d:/a.dump</h2><p>Vector v=new Vector();<br>for(int i=0;i&lt;25;i++)<br>v.add(new byte[1<em>1024</em>1024]);<br><img alt="" data-original="/images/15509788859181.png"><br><img alt="" data-original="/images/15509788891192.png"></p><pre><code>ä¸Šé¢å°±æ˜¯dumpå‡ºæ¥çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»åˆ†é…äº†19ä¸ªbyteæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„1mï¼Œå†æ¬¡åˆ†é…è¶…è¿‡äº†-Xmx20mæœ€å¤§å †å†…å­˜ã€‚ é€šè¿‡ç±»ä¼¼äºä¸Šé¢çš„æ–‡ä»¶èƒ½å¤Ÿå¾ˆå¥½çš„è€ƒåˆ°é—®é¢˜å‡ºåœ¨äº†å“ªé‡Œã€‚</code></pre><h1 id="XX-OnOutOfMemoryError"><a href="#XX-OnOutOfMemoryError" class="headerlink" title="-XX:OnOutOfMemoryError"></a>-XX:OnOutOfMemoryError</h1><p>åœ¨OOMæ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªè„šæœ¬<br>â€œ-XX:OnOutOfMemoryError=D:/tools/jdk1.7_40/bin/printstack.bat %pâ€œ<br>%pæŒ‡çš„æ˜¯å½“å‰è¿™ä¸ªjavaç¨‹åºçš„ä¸€ä¸ªpidï¼Œè¿›ç¨‹idã€‚<br>printstack.batä¸­å®šä¹‰çš„å†…å®¹æ˜¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:<span class="regexp">/tools/</span>jdk1<span class="number">.7</span>_40/bin/jstack -F %<span class="number">1</span> &gt; D:<span class="regexp">/a.txt</span></span><br><span class="line"><span class="regexp">å°†jstackçš„ä¿¡æ¯æ‰“å°åˆ°D:/</span>a.txtä¸‹é¢ã€‚</span><br></pre></td></tr></table></figure><p>å½“ç¨‹åºOOMæ—¶ï¼Œåœ¨D:/a.txtä¸­å°†ä¼šç”Ÿæˆçº¿ç¨‹çš„dump<br>å¯ä»¥åœ¨OOMæ—¶ï¼Œå‘é€é‚®ä»¶ï¼Œç”šè‡³æ˜¯é‡å¯ç¨‹åº</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ ¹æ®å®é™…äº‹æƒ…è°ƒæ•´æ–°ç”Ÿä»£å’Œå¹¸å­˜ä»£çš„å¤§å°<br>å®˜æ–¹æ¨èæ–°ç”Ÿä»£å å †çš„3/8<br>å¹¸å­˜ä»£å æ–°ç”Ÿä»£çš„1/10<br>åœ¨OOMæ—¶ï¼Œè®°å¾—Dumpå‡ºå †ï¼Œç¡®ä¿å¯ä»¥æ’æŸ¥ç°åœºé—®é¢˜</p><h1 id="æ°¸ä¹…åŒºåˆ†é…å‚æ•°"><a href="#æ°¸ä¹…åŒºåˆ†é…å‚æ•°" class="headerlink" title="æ°¸ä¹…åŒºåˆ†é…å‚æ•°"></a>æ°¸ä¹…åŒºåˆ†é…å‚æ•°</h1><h2 id="XX-PermSize-XX-MaxPermSize"><a href="#XX-PermSize-XX-MaxPermSize" class="headerlink" title="-XX:PermSize  -XX:MaxPermSize"></a>-XX:PermSize -XX:MaxPermSize</h2><p>è®¾ç½®æ°¸ä¹…åŒºçš„åˆå§‹ç©ºé—´å’Œæœ€å¤§ç©ºé—´<br>ä»–ä»¬è¡¨ç¤ºï¼Œä¸€ä¸ªç³»ç»Ÿå¯ä»¥å®¹çº³å¤šå°‘ä¸ªç±»å‹</p><h2 id="ä½¿ç”¨CGLIBç­‰åº“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œè¿™äº›ç±»ï¼Œæœ‰å¯èƒ½æ’‘çˆ†æ°¸ä¹…åŒºå¯¼è‡´OOM"><a href="#ä½¿ç”¨CGLIBç­‰åº“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œè¿™äº›ç±»ï¼Œæœ‰å¯èƒ½æ’‘çˆ†æ°¸ä¹…åŒºå¯¼è‡´OOM" class="headerlink" title="ä½¿ç”¨CGLIBç­‰åº“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œè¿™äº›ç±»ï¼Œæœ‰å¯èƒ½æ’‘çˆ†æ°¸ä¹…åŒºå¯¼è‡´OOM"></a>ä½¿ç”¨CGLIBç­‰åº“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ç±»ï¼Œè¿™äº›ç±»ï¼Œæœ‰å¯èƒ½æ’‘çˆ†æ°¸ä¹…åŒºå¯¼è‡´OOM</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++)&#123;</span><br><span class="line">    CglibBean bean = <span class="keyword">new</span> CglibBean(<span class="string">"geym.jvm.ch3.perm.bean"</span>+i,<span class="keyword">new</span> HashMap());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡CGlibä¸æ–­äº§ç”Ÿæ–°çš„ç±»<br><img alt="" data-original="/images/15509789087280.png"></p><p>æ°¸ä¹…ä»£ä¸æ–­è§¦å‘full gcï¼Œfull gcåæ°¸ä¹…ä»£çš„ç©ºé—´æ²¡æœ‰åŠæ³•å›æ”¶ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´OOM<br>è€ŒOOmçš„æ—¶å€™å¹´è½»ä»£ç”¨äº†2%ï¼Œå¹´è€ä»£ç”¨äº†20%ï¼ŒæŒä¹…å¾…ç”¨äº†99%</p><h2 id="æ‰“å¼€å †çš„Dump"><a href="#æ‰“å¼€å †çš„Dump" class="headerlink" title="æ‰“å¼€å †çš„Dump"></a>æ‰“å¼€å †çš„Dump</h2><p>å †ç©ºé—´å®é™…å ç”¨éå¸¸å°‘<br>ä½†æ˜¯æ°¸ä¹…åŒºæº¢å‡º ä¸€æ ·æŠ›å‡ºOOM<br><img alt="" data-original="/images/15509789183444.png"></p><p>å¦‚æœå †ç©ºé—´æ²¡æœ‰ç”¨å®Œä¹ŸæŠ›å‡ºäº†OOMï¼Œæœ‰å¯èƒ½æ˜¯æ°¸ä¹…åŒºå¯¼è‡´çš„</p><h1 id="æ ˆå¤§å°åˆ†é…"><a href="#æ ˆå¤§å°åˆ†é…" class="headerlink" title="æ ˆå¤§å°åˆ†é…"></a>æ ˆå¤§å°åˆ†é…</h1><h2 id="Xss"><a href="#Xss" class="headerlink" title="-Xss"></a>-Xss</h2><p>é€šå¸¸åªæœ‰å‡ ç™¾K<br>å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æ·±åº¦ï¼ˆå¦‚æœçº¿ç¨‹ä¸­æœ‰åœ°æŸœï¼Œæ ˆçš„ç©ºé—´åˆå¤ªå°çš„è¯ï¼Œä¼šå¯¼è‡´æ ˆçš„æº¢å‡ºï¼Œï¼‰<br>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼ˆæ ˆçš„æ•°é‡*æ¯ä¸ªæ ˆçš„å¤§å°=ç³»ç»Ÿä¸­æ ˆçš„å¤§å°ï¼Œæ‰€ä»¥å¦‚æœæƒ³å¤šè·‘ä¸€äº›çº¿ç¨‹çš„è¯ï¼Œå°±åº”è¯¥å°±åº”è¯¥æŠŠæ ˆç©ºé—´å‡å°ï¼‰<br>å±€éƒ¨å˜é‡ã€å‚æ•° åˆ†é…åœ¨æ ˆä¸Š</p><h2 id="ä¸¾ä¸ªæ —å­-1"><a href="#ä¸¾ä¸ªæ —å­-1" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TestStackDeep</span> </span>&#123;</span><br><span class="line">private <span class="keyword">static</span> int count=<span class="number">0</span>;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> recursion(long a,long b,long c)&#123;</span><br><span class="line">long e=<span class="number">1</span>,f=<span class="number">2</span>,g=<span class="number">3</span>,h=<span class="number">4</span>,i=<span class="number">5</span>,k=<span class="number">6</span>,q=<span class="number">7</span>,x=<span class="number">8</span>,y=<span class="number">9</span>,z=<span class="number">10</span>;</span><br><span class="line">count++;</span><br><span class="line">recursion(a,b,c);</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[])&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">recursion(<span class="number">0</span>L,<span class="number">0</span>L,<span class="number">0</span>L);</span><br><span class="line">&#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">System.out.println(<span class="string">"deep of calling = "</span>+count);</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">é€’å½’è°ƒç”¨</span><br><span class="line">-Xss128K</span><br><span class="line">deep <span class="keyword">of</span> calling = <span class="number">701</span></span><br><span class="line">java.lang.StackOverflowError</span><br><span class="line"></span><br><span class="line">-Xss256K</span><br><span class="line">deep <span class="keyword">of</span> calling = <span class="number">1817</span> <span class="comment">//è°ƒç”¨çš„æ¬¡æ•°</span></span><br><span class="line">java.lang.StackOverflowError</span><br></pre></td></tr></table></figure><p>java.lang.StackOverflowErrorï¼Œå°±æ˜¯å‡½æ•°çš„è°ƒç”¨å±‚æ¬¡å¤ªæ·±ã€‚<br>å½“ç„¶å¦‚æœæƒ³è¦å¢åŠ è¿­ä»£çš„æ¬¡æ•°ï¼Œé€šè¿‡å‡å°æ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„å‚æ•°æˆ–è€…å±€éƒ¨å˜é‡ä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;Traceè·Ÿè¸ªå‚æ•°&quot;&gt;&lt;a href=&quot;#Traceè·Ÿè¸ªå‚æ•°&quot; class=&quot;headerlink&quot; title=
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ï¼šJVMè¿è¡Œæœºåˆ¶</title>
    <link href="http://mmmmmm.me/2019-02-24.html"/>
    <id>http://mmmmmm.me/2019-02-24.html</id>
    <published>2019-02-23T14:20:02.000Z</published>
    <updated>2019-02-24T03:25:31.749Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="JVMå¯åŠ¨æµç¨‹"><a href="#JVMå¯åŠ¨æµç¨‹" class="headerlink" title="JVMå¯åŠ¨æµç¨‹"></a>JVMå¯åŠ¨æµç¨‹</h1><p><img alt="" data-original="/images/15509785973941.png"></p><p>jvm.cfg JVMé…ç½®æ–‡ä»¶<br>JNIEnvæä¾›äº†å¤§é‡çš„å’ŒJVMäº¤äº’çš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚findClass<br><img alt="" data-original="/images/15509786089166.png"></p><h2 id="PCå¯„å­˜å™¨"><a href="#PCå¯„å­˜å™¨" class="headerlink" title="PCå¯„å­˜å™¨"></a>PCå¯„å­˜å™¨</h2><p>æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªPCå¯„å­˜å™¨<br>åœ¨çº¿ç¨‹åˆ›å»ºæ—¶ åˆ›å»º<br>æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€<br>æ‰§è¡Œæœ¬åœ°æ–¹æ³•æ—¶ï¼ŒPCçš„å€¼ä¸ºundefined</p><h2 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h2><p>æ³¨æ„ï¼š<br>JDK6æ—¶ï¼ŒStringç­‰å¸¸é‡ä¿¡æ¯ç½®äºæ–¹æ³•åŒº<br>JDK7æ—¶ï¼Œå·²ç»ç§»åŠ¨åˆ°äº†å †</p><h3 id="ä¿å­˜è£…è½½çš„ç±»ä¿¡æ¯"><a href="#ä¿å­˜è£…è½½çš„ç±»ä¿¡æ¯" class="headerlink" title="ä¿å­˜è£…è½½çš„ç±»ä¿¡æ¯"></a>ä¿å­˜è£…è½½çš„ç±»ä¿¡æ¯</h3><p>ç±»å‹çš„å¸¸é‡æ± <br>å­—æ®µï¼Œæ–¹æ³•ä¿¡æ¯<br>æ–¹æ³•å­—èŠ‚ç </p><h3 id="é€šå¸¸å’Œæ°¸ä¹…åŒº-Perm-å…³è”åœ¨ä¸€èµ·"><a href="#é€šå¸¸å’Œæ°¸ä¹…åŒº-Perm-å…³è”åœ¨ä¸€èµ·" class="headerlink" title="é€šå¸¸å’Œæ°¸ä¹…åŒº(Perm)å…³è”åœ¨ä¸€èµ·"></a>é€šå¸¸å’Œæ°¸ä¹…åŒº(Perm)å…³è”åœ¨ä¸€èµ·</h3><p>æ°¸ä¹…åŒº(Perm)ä¿å­˜ç›¸å¯¹é™æ­¢çš„æ•°æ®ï¼Œè™½ç„¶ç±»çš„æ•°æ®åœ¨è¿è¡Œçš„è¿‡ç¨‹å½“ä¸­å¯èƒ½ä¼šå‡ºç°è°ƒæ•´ï¼Œæ¯”å¦‚è¯´çƒ­åŠ è½½ï¼Œå¦‚æœæ˜¯çƒ­åŠ è½½çƒ­æ›¿æ¢çš„è¯ï¼Œæ˜¾ç„¶ä¼šæœ‰ä¸€ä¸ªåˆ é™¤ç„¶åé‡æ–°åŠ è½½çš„è¿‡ç¨‹ï¼Œè™½ç„¶è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šå‘ç”Ÿå˜åŠ¨ï¼Œä½†æ˜¯åº”ç”¨å±‚é¢çš„è½¯ä»¶ç›¸æ¯”æ˜¯æ¯”è¾ƒç¨³å®šçš„ï¼Œè¿™æ ·çš„ç¨³å®šå°±æ˜¯æ°¸ä¹…åŒºï¼Œä½†æ˜¯æ°¸ä¹…åŒºå¹¶ä¸æ˜¯æ°¸è¿œä¸ä¼šå˜çš„ã€‚</p><h2 id="Javaå †"><a href="#Javaå †" class="headerlink" title="Javaå †"></a>Javaå †</h2><p>è·Ÿæ–¹æ³•åŒºç›¸æ¯”ï¼Œæ–¹æ³•åŒºæ˜¯jvmæ¥ç»´æŠ¤çš„ï¼Œè€Œjavaå †æ‰€æœ‰ä»£ç ä¸­é€šè¿‡newå‡ºæ¥çš„å¯¹è±¡ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨javaå †å½“ä¸­</p><ul><li>å’Œç¨‹åºå¼€å‘å¯†åˆ‡ç›¸å…³</li><li>åº”ç”¨ç³»ç»Ÿå¯¹è±¡éƒ½ä¿å­˜åœ¨Javaå †ä¸­</li><li>æ‰€æœ‰çº¿ç¨‹å…±äº«Javaå †</li><li>å¯¹åˆ†ä»£GCæ¥è¯´ï¼Œå †ä¹Ÿæ˜¯åˆ†ä»£çš„</li><li>GCçš„ä¸»è¦å·¥ä½œåŒºé—´:<br>eden | s0 | s1 | tenured<br>edenå¯¹è±¡å‡ºç”Ÿçš„åœ°æ–¹ï¼Œs0 s1ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œtenuredè€å¹´ä»£ã€‚<h2 id="Javaæ ˆ"><a href="#Javaæ ˆ" class="headerlink" title="Javaæ ˆ"></a>Javaæ ˆ</h2>å †æ˜¯å…¨å±€å…±äº«çš„ï¼Œæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„</li><li>çº¿ç¨‹ç§æœ‰</li><li>æ ˆç”±ä¸€ç³»åˆ—å¸§ç»„æˆï¼ˆå› æ­¤Javaæ ˆä¹Ÿå«åšå¸§æ ˆï¼‰</li><li>å¸§ä¿å­˜ä¸€ä¸ªæ–¹æ³•çš„å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± æŒ‡é’ˆ</li><li>æ¯ä¸€æ¬¡æ–¹æ³•è°ƒç”¨åˆ›å»ºä¸€ä¸ªå¸§ï¼Œå¹¶å‹æ ˆ<h3 id="Javaæ ˆ-â€“-å±€éƒ¨å˜é‡è¡¨-åŒ…å«å‚æ•°å’Œå±€éƒ¨å˜é‡"><a href="#Javaæ ˆ-â€“-å±€éƒ¨å˜é‡è¡¨-åŒ…å«å‚æ•°å’Œå±€éƒ¨å˜é‡" class="headerlink" title="Javaæ ˆ â€“ å±€éƒ¨å˜é‡è¡¨   åŒ…å«å‚æ•°å’Œå±€éƒ¨å˜é‡   "></a>Javaæ ˆ â€“ å±€éƒ¨å˜é‡è¡¨ <strong><font color="red">åŒ…å«å‚æ•°å’Œå±€éƒ¨å˜é‡</font></strong></h3></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">StackDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> int runStatic(int i,long l,float  f,<span class="built_in">Object</span> o ,byte b)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">public int runInstance(char c,short s,boolean b)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//runStaticé™æ€æ–¹æ³•çš„æ ˆç¤ºæ„</span></span><br><span class="line"><span class="comment">//å› ä¸ºä¸€ä¸ªæ§½ä½åªèƒ½å®¹çº³32ä½çš„å¤§å°ï¼Œå³intï¼Œæ‰€ä»¥intå äº†ä¸€ä¸ªæ§½ä½ï¼Œlongï¼ˆ64ä½ï¼‰å äº†ä¸¤ä¸ªæ§½ä½</span></span><br><span class="line"><span class="comment">//å¯¹è±¡æ˜¯å¼•ç”¨referenceï¼ˆ32ä½ï¼‰</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">0</span> int int i</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">1</span> long long l</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">3</span> float float f</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">4</span> reference <span class="built_in">Object</span> o</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">5</span> int byte b</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//runInstanceæ–¹æ³•çš„ç¤ºæ„</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">0</span> reference <span class="keyword">this</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">1</span> int char c</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">2</span> int short s</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">3</span> int boolean b</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„: runInstanceå’ŒrunStaticçš„åŒºåˆ«æ˜¯runInstanceæ¯”runStaticå¤šäº†ä¸€ä¸ªè‡ªèº«çš„thiså¼•ç”¨ã€‚</font></strong></p><h3 id="Javaæ ˆ-â€“-å‡½æ•°è°ƒç”¨ç»„æˆå¸§æ ˆ"><a href="#Javaæ ˆ-â€“-å‡½æ•°è°ƒç”¨ç»„æˆå¸§æ ˆ" class="headerlink" title="Javaæ ˆ â€“ å‡½æ•°è°ƒç”¨ç»„æˆå¸§æ ˆ"></a>Javaæ ˆ â€“ å‡½æ•°è°ƒç”¨ç»„æˆå¸§æ ˆ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> int runStatic(int i,long l,float  f,<span class="built_in">Object</span> o ,byte b)&#123;</span><br><span class="line"><span class="keyword">return</span> runStatic(i,l,f,o,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">-----------------------</span><br><span class="line"><span class="number">0</span> int int i</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">1</span> long long l</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">3</span> float float f</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">4</span> reference <span class="built_in">Object</span> o</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">5</span> int byte b</span><br><span class="line">-----------------------</span><br><span class="line"><span class="comment">//ä¸Šé¢ä¸ºä¸€ä¸ªå¸§ï¼Œçœç•¥ï¼šæ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">0</span> int int i</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">1</span> long long l</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">3</span> float float f</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">4</span> reference <span class="built_in">Object</span> o</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">5</span> int byte b</span><br><span class="line">-----------------------</span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">0</span> int int i</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">1</span> long long l</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">3</span> float float f</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">4</span> reference <span class="built_in">Object</span> o</span><br><span class="line">-----------------------</span><br><span class="line"><span class="number">5</span> int byte b</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡æ–¹æ³•è°ƒç”¨å°±ä¼šæœ‰ä¸€ä¸ªå¸§è¢«å‹å…¥æ ˆï¼Œä¸Šé¢æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œä¸€ç›´å¾€ä¸Šé¢å‹ï¼Œä¸€ç›´åˆ°å¸§æ ˆæ»¡äº†ä¸ºæ­¢ï¼Œå‘ç”Ÿæº¢å‡ºï¼Œæ–¹æ³•è°ƒç”¨ç»“æŸäº†ï¼Œå¸§åˆä¼šè‡ªåŠ¨ä»å¸§æ ˆé‡Œé¢ç§»é™¤æ‰ã€‚</p><h3 id="Javaæ ˆ-â€“-æ“ä½œæ•°æ ˆ"><a href="#Javaæ ˆ-â€“-æ“ä½œæ•°æ ˆ" class="headerlink" title="Javaæ ˆ â€“ æ“ä½œæ•°æ ˆ"></a>Javaæ ˆ â€“ æ“ä½œæ•°æ ˆ</h3><p>Javaæ²¡æœ‰å¯„å­˜å™¨ï¼Œæ‰€æœ‰å‚æ•°ä¼ é€’ä½¿ç”¨æ“ä½œæ•°æ ˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> int add(int a,int b)&#123;</span><br><span class="line">int c=<span class="number">0</span>;</span><br><span class="line">c=a+b;</span><br><span class="line"><span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>:   iconst_0 <span class="comment">// 0å‹æ ˆ</span></span><br><span class="line"><span class="number">1</span>:   istore_2 <span class="comment">// å¼¹å‡ºintï¼Œå­˜æ”¾äºå±€éƒ¨å˜é‡2</span></span><br><span class="line"><span class="number">2</span>:   iload_0  <span class="comment">// æŠŠå±€éƒ¨å˜é‡0å‹æ ˆ</span></span><br><span class="line"><span class="number">3</span>:   iload_1 <span class="comment">// å±€éƒ¨å˜é‡1å‹æ ˆ</span></span><br><span class="line"><span class="number">4</span>:   iadd      <span class="comment">//å¼¹å‡º2ä¸ªå˜é‡ï¼Œæ±‚å’Œï¼Œç»“æœå‹æ ˆ</span></span><br><span class="line"><span class="number">5</span>:   istore_2 <span class="comment">//å¼¹å‡ºç»“æœï¼Œæ”¾äºå±€éƒ¨å˜é‡2</span></span><br><span class="line"><span class="number">6</span>:   iload_2  <span class="comment">//å±€éƒ¨å˜é‡2å‹æ ˆ</span></span><br><span class="line"><span class="number">7</span>:   ireturn   <span class="comment">//è¿”å›</span></span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15509786612826.png"></p><h3 id="Javaæ ˆ-â€“-æ ˆä¸Šåˆ†é…"><a href="#Javaæ ˆ-â€“-æ ˆä¸Šåˆ†é…" class="headerlink" title="Javaæ ˆ â€“ æ ˆä¸Šåˆ†é…"></a>Javaæ ˆ â€“ æ ˆä¸Šåˆ†é…</h3><h4 id="C-ä»£ç ç¤ºä¾‹"><a href="#C-ä»£ç ç¤ºä¾‹" class="headerlink" title="C++ ä»£ç ç¤ºä¾‹"></a>C++ ä»£ç ç¤ºä¾‹</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BcmBasicString</span></span>&#123;    ....&#125;</span><br></pre></td></tr></table></figure><h5 id="å †ä¸Šåˆ†é…ï¼Œæ¯æ¬¡éœ€è¦æ¸…ç†ç©ºé—´"><a href="#å †ä¸Šåˆ†é…ï¼Œæ¯æ¬¡éœ€è¦æ¸…ç†ç©ºé—´" class="headerlink" title="å †ä¸Šåˆ†é…ï¼Œæ¯æ¬¡éœ€è¦æ¸…ç†ç©ºé—´"></a>å †ä¸Šåˆ†é…ï¼Œæ¯æ¬¡éœ€è¦æ¸…ç†ç©ºé—´</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> method()&#123;    </span><br><span class="line">BcmBasicString* str=<span class="keyword">new</span> BcmBasicString;    ....    delete str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç newæ˜¯æ”¾åœ¨äº†å †é‡Œé¢ï¼Œæ¯æ¬¡ç”¨å®Œä¹‹åéœ€è¦deleteï¼Œå¦‚æœå¿˜è®°çš„ä¼šå°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œè¿™ç§é”™è¯¯æ˜¯å¾ˆéš¾å‘ç°çš„ã€‚</p><h5 id="æ ˆä¸Šåˆ†é…ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆè‡ªåŠ¨æ¸…ç†"><a href="#æ ˆä¸Šåˆ†é…ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆè‡ªåŠ¨æ¸…ç†" class="headerlink" title="æ ˆä¸Šåˆ†é…ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆè‡ªåŠ¨æ¸…ç†"></a>æ ˆä¸Šåˆ†é…ï¼Œå‡½æ•°è°ƒç”¨å®Œæˆè‡ªåŠ¨æ¸…ç†</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å£°æ˜å‡ºæ¥çš„å†™æ³•</span></span><br><span class="line">public <span class="keyword">void</span> method()&#123;    </span><br><span class="line">BcmBasicString str;  </span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="javaä»£ç "><a href="#javaä»£ç " class="headerlink" title="javaä»£ç "></a>javaä»£ç </h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OnStackTest</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> alloc()&#123;</span><br><span class="line">        byte[] b=<span class="keyword">new</span> byte[<span class="number">2</span>];</span><br><span class="line">        b[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">        long b=System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">100000000</span>;i++)&#123;</span><br><span class="line">            alloc();</span><br><span class="line">        &#125;</span><br><span class="line">        long e=System.currentTimeMillis();</span><br><span class="line">        System.out.println(e-b);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-server -Xmx10m -Xms10m</span><br><span class="line">-XX:+DoEscapeAnalysis -XX:+PrintGC</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼è¿è¡Œ<br>è¾“å‡ºç»“æœ 5<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-server -Xmx10m -Xms10m  </span><br><span class="line">-XX:-DoEscapeAnalysis -XX:+PrintGC</span><br></pre></td></tr></table></figure><p></p><p>è¿™ç§æ–¹å¼è¿è¡Œè¾“å‡ºå¦‚ä¸‹ç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â€¦â€¦</span><br><span class="line">[GC <span class="number">3550</span>K-&gt;<span class="number">478</span>K(<span class="number">10240</span>K), <span class="number">0.0000977</span> secs]</span><br><span class="line">[GC <span class="number">3550</span>K-&gt;<span class="number">478</span>K(<span class="number">10240</span>K), <span class="number">0.0001361</span> secs]</span><br><span class="line">[GC <span class="number">3550</span>K-&gt;<span class="number">478</span>K(<span class="number">10240</span>K), <span class="number">0.0000963</span> secs]</span><br><span class="line"><span class="number">564</span></span><br></pre></td></tr></table></figure><p>è¯´æ˜æ–¹å¼ä¸€æ˜¯åœ¨æ ˆä¸Šé¢åˆ†é…å†…å­˜ï¼Œæ–¹å¼äºŒæ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œjvmå†…éƒ¨æ˜¯æœ‰ç›¸å…³çš„ä¼˜åŒ–çš„ï¼Œå½“æ•°æ®é‡ä¸æ˜¯å¾ˆå¤§çš„æ—¶å€™ï¼Œé€šè¿‡æ ˆçš„æ–¹å¼åˆ†é…ï¼Œèƒ½å¤Ÿå‡å°gcçš„å‹åŠ›ã€‚</p><h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><ul><li>å°å¯¹è±¡ï¼ˆä¸€èˆ¬å‡ åä¸ªbytesï¼‰ï¼Œåœ¨æ²¡æœ‰é€ƒé€¸çš„æƒ…å†µä¸‹ï¼ˆé€ƒé€¸ï¼Œå³åˆ†é…å‡ºæ¥ä¹‹åé™¤äº†æˆ‘çš„çº¿ç¨‹è¦ç”¨ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¹Ÿè¦ç”¨çš„æ—¶å€™ï¼Œå› ä¸ºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚ï¼‰ï¼Œå¯ä»¥ç›´æ¥åˆ†é…åœ¨æ ˆä¸Š</li><li>ç›´æ¥åˆ†é…åœ¨æ ˆä¸Šï¼Œå¯ä»¥è‡ªåŠ¨å›æ”¶ï¼Œå‡è½»GCå‹åŠ›ï¼ˆå‡½æ•°è°ƒç”¨å®Œæˆä¹‹åï¼‰</li><li>å¤§å¯¹è±¡æˆ–è€…é€ƒé€¸å¯¹è±¡æ— æ³•æ ˆä¸Šåˆ†é…<h3 id="æ ˆã€å †ã€æ–¹æ³•åŒºäº¤äº’"><a href="#æ ˆã€å †ã€æ–¹æ³•åŒºäº¤äº’" class="headerlink" title="æ ˆã€å †ã€æ–¹æ³•åŒºäº¤äº’"></a>æ ˆã€å †ã€æ–¹æ³•åŒºäº¤äº’</h3><h4 id="å°ä¾‹å­"><a href="#å°ä¾‹å­" class="headerlink" title="å°ä¾‹å­"></a>å°ä¾‹å­</h4><img alt="" data-original="/images/15509786748287.png"></li></ul><p>JVMé€šè¿‡æ ˆè°ƒç”¨mainæ–¹æ³•ï¼Œå±€éƒ¨å˜é‡test1å­˜æ”¾ç€Sampleå®ä¾‹çš„å¼•ç”¨ï¼Œç”¨è¿‡å®ä¾‹çš„å¼•ç”¨å»å †ä¸­æ‰¾åˆ°Sampleå®ä¾‹ï¼ŒSampleå®ä¾‹çš„ç›¸å…³ä¿¡æ¯åœ¨æ–¹æ³•åŒºä¸­å­˜æ”¾ç€ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public   <span class="class"><span class="keyword">class</span>  <span class="title">AppMain</span>     </span></span><br><span class="line"><span class="class"> //è¿è¡Œæ—¶, <span class="title">jvm</span> æŠŠ<span class="title">appmain</span>çš„ä¿¡æ¯éƒ½æ”¾å…¥æ–¹æ³•åŒº </span></span><br><span class="line"><span class="class"> </span>&#123; public   <span class="keyword">static</span>   <span class="keyword">void</span>  main(<span class="built_in">String</span>[] args)  </span><br><span class="line"><span class="comment">//main æ–¹æ³•æœ¬èº«æ”¾å…¥æ–¹æ³•åŒºã€‚ &#123;</span></span><br><span class="line"> Sample test1 = <span class="keyword">new</span>  Sample( <span class="string">" æµ‹è¯•1 "</span> );  </span><br><span class="line"> <span class="comment">//test1æ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥æ”¾åˆ°æ ˆåŒºé‡Œï¼Œ Sampleæ˜¯è‡ªå®šä¹‰å¯¹è±¡åº”è¯¥æ”¾åˆ°å †é‡Œé¢ </span></span><br><span class="line"> Sample test2 = <span class="keyword">new</span>  Sample( <span class="string">" æµ‹è¯•2 "</span> ); </span><br><span class="line"> test1.printName(); test2.printName(); &#125; </span><br><span class="line">public   <span class="class"><span class="keyword">class</span>  <span class="title">Sample</span>       </span></span><br><span class="line"><span class="class"> //è¿è¡Œæ—¶, <span class="title">jvm</span> æŠŠ<span class="title">appmain</span>çš„ä¿¡æ¯éƒ½æ”¾å…¥æ–¹æ³•åŒº </span></span><br><span class="line"><span class="class"> </span>&#123; private  name;     </span><br><span class="line"> <span class="comment">//new Sampleå®ä¾‹åï¼Œ name å¼•ç”¨æ”¾å…¥æ ˆåŒºé‡Œï¼Œ  name å¯¹è±¡æ”¾å…¥å †é‡Œ </span></span><br><span class="line"> public  Sample(<span class="built_in">String</span> name) </span><br><span class="line"> &#123; <span class="keyword">this</span> .name = name; &#125; </span><br><span class="line"> <span class="comment">//printæ–¹æ³•æœ¬èº«æ”¾å…¥ æ–¹æ³•åŒºé‡Œã€‚public   void  printName()    </span></span><br><span class="line"> &#123; System.out.println(name); &#125; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="JVMåŸºæœ¬ç»“æ„"><a href="#JVMåŸºæœ¬ç»“æ„" class="headerlink" title="JVMåŸºæœ¬ç»“æ„"></a>JVMåŸºæœ¬ç»“æ„</h1><h2 id="å†…å­˜æ¨¡å‹"><a href="#å†…å­˜æ¨¡å‹" class="headerlink" title="å†…å­˜æ¨¡å‹"></a>å†…å­˜æ¨¡å‹</h2><ul><li>æ¯ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªå·¥ä½œå†…å­˜å’Œä¸»å­˜ç‹¬ç«‹<br>è¿™é‡Œçš„ä¸»å­˜æŒ‡çš„æ˜¯å †å†…å­˜ï¼Œå…±äº«å†…å­˜</li><li>å·¥ä½œå†…å­˜å­˜æ”¾ä¸»å­˜ä¸­å˜é‡çš„å€¼çš„æ‹·è´<br><img alt="" data-original="/images/15509786946574.png"></li></ul><p>å½“æ•°æ®ä»ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå­˜å‚¨æ—¶ï¼Œå¿…é¡»å‡ºç°ä¸¤ä¸ªåŠ¨ä½œï¼šç¬¬ä¸€ï¼Œç”±ä¸»å†…å­˜æ‰§è¡Œçš„è¯»ï¼ˆreadï¼‰æ“ä½œï¼›ç¬¬äºŒï¼Œç”±å·¥ä½œå†…å­˜æ‰§è¡Œçš„ç›¸åº”çš„loadæ“ä½œï¼›å½“æ•°æ®ä»å·¥ä½œå†…å­˜æ‹·è´åˆ°ä¸»å†…å­˜æ—¶ï¼Œä¹Ÿå‡ºç°ä¸¤ä¸ªæ“ä½œï¼šç¬¬ä¸€ä¸ªï¼Œç”±å·¥ä½œå†…å­˜æ‰§è¡Œçš„å­˜å‚¨ï¼ˆstoreï¼‰æ“ä½œï¼›ç¬¬äºŒï¼Œç”±ä¸»å†…å­˜æ‰§è¡Œçš„ç›¸åº”çš„å†™ï¼ˆwriteï¼‰æ“ä½œ</p><p>æ¯ä¸€ä¸ªæ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œå³æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«ä¸­æ–­<br><strong><font color="red">å¯¹äºæ™®é€šå˜é‡ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­æ›´æ–°çš„å€¼ï¼Œä¸èƒ½é©¬ä¸Šååº”åœ¨å…¶ä»–å˜é‡ä¸­<br>å¦‚æœéœ€è¦åœ¨å…¶ä»–çº¿ç¨‹ä¸­ç«‹å³å¯è§ï¼Œéœ€è¦ä½¿ç”¨ volatile å…³é”®å­—</font></strong><br>å¯ä»¥çœ‹åˆ°ä»å·¥ä½œå†…å­˜åˆ°ä¸»å­˜ä¸­æ˜¯éœ€è¦ä¸€å®šçš„æ—¶é—´çš„ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªçº¿ç¨‹ä¸­æ›´æ–°äº†å€¼çš„æ—¶å€™ï¼Œä¸èƒ½å¤Ÿåœ¨å…¶ä»–çš„çº¿ç¨‹ä¸­ç«‹å³å¯è§ã€‚</p><p><img alt="" data-original="/images/15509787076064.png"></p><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">VolatileStopThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">private volatile boolean stop = <span class="literal">false</span>;</span><br><span class="line">public <span class="keyword">void</span> stopMe()&#123;</span><br><span class="line">stop=<span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">int i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(!stop)&#123;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">    System.out.println(<span class="string">"Stop thread"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) throws InterruptedException&#123;</span><br><span class="line">VolatileStopThread t=<span class="keyword">new</span> VolatileStopThread();</span><br><span class="line">t.start();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">t.stopMe();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰volatile -server è¿è¡Œ æ— æ³•åœæ­¢<br>volatile ä¸èƒ½ä»£æ›¿é”<br>ä¸€èˆ¬è®¤ä¸ºvolatile æ¯”é”æ€§èƒ½å¥½ï¼ˆä¸ç»å¯¹ï¼‰</p><p>é€‰æ‹©ä½¿ç”¨volatileçš„æ¡ä»¶æ˜¯ï¼š<br>è¯­ä¹‰æ˜¯å¦æ»¡è¶³åº”ç”¨</p><h2 id="å†…å­˜æ¨¡å‹çš„å‡ ä¸ªé‡è¦æ¦‚å¿µ"><a href="#å†…å­˜æ¨¡å‹çš„å‡ ä¸ªé‡è¦æ¦‚å¿µ" class="headerlink" title="å†…å­˜æ¨¡å‹çš„å‡ ä¸ªé‡è¦æ¦‚å¿µ"></a>å†…å­˜æ¨¡å‹çš„å‡ ä¸ªé‡è¦æ¦‚å¿µ</h2><h3 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h3><p>ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å˜é‡ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çŸ¥é“</p><h3 id="ä¿è¯å¯è§æ€§çš„æ–¹æ³•"><a href="#ä¿è¯å¯è§æ€§çš„æ–¹æ³•" class="headerlink" title="ä¿è¯å¯è§æ€§çš„æ–¹æ³•"></a>ä¿è¯å¯è§æ€§çš„æ–¹æ³•</h3><p>volatile<br>synchronized ï¼ˆunlockä¹‹å‰ï¼Œå†™å˜é‡å€¼å›ä¸»å­˜ï¼‰<br>final(ä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå…¶ä»–çº¿ç¨‹å°±å¯è§)</p><h3 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h3><p>åœ¨æœ¬çº¿ç¨‹å†…ï¼Œæ“ä½œéƒ½æ˜¯æœ‰åºçš„<br>åœ¨çº¿ç¨‹å¤–è§‚å¯Ÿï¼Œæ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚ï¼ˆæŒ‡ä»¤é‡æ’ æˆ– ä¸»å†…å­˜åŒæ­¥å»¶æ—¶ï¼‰</p><h3 id="æŒ‡ä»¤é‡æ’"><a href="#æŒ‡ä»¤é‡æ’" class="headerlink" title="æŒ‡ä»¤é‡æ’"></a>æŒ‡ä»¤é‡æ’</h3><p>çº¿ç¨‹å†…ä¸²è¡Œè¯­ä¹‰<br>å†™åè¯» a = 1;b = a; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†è¯»è¿™ä¸ªä½ç½®ã€‚<br>å†™åå†™ a = 1;a = 2; å†™ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚<br>è¯»åå†™ a = b;b = 1; è¯»ä¸€ä¸ªå˜é‡ä¹‹åï¼Œå†å†™è¿™ä¸ªå˜é‡ã€‚<br>ä»¥ä¸Šè¯­å¥ä¸å¯é‡æ’<br>ç¼–è¯‘å™¨ä¸è€ƒè™‘å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰<br>å¯é‡æ’ï¼š a=1;b=2;</p><h4 id="æŒ‡ä»¤é‡æ’-â€“-ç ´åçº¿ç¨‹é—´çš„æœ‰åºæ€§"><a href="#æŒ‡ä»¤é‡æ’-â€“-ç ´åçº¿ç¨‹é—´çš„æœ‰åºæ€§" class="headerlink" title="æŒ‡ä»¤é‡æ’ â€“ ç ´åçº¿ç¨‹é—´çš„æœ‰åºæ€§"></a>æŒ‡ä»¤é‡æ’ â€“ ç ´åçº¿ç¨‹é—´çš„æœ‰åºæ€§</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderExample</span> </span>&#123;</span><br><span class="line">int a = <span class="number">0</span>;</span><br><span class="line">boolean flag = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> writer() &#123;</span><br><span class="line">    a = <span class="number">1</span>;                   </span><br><span class="line">    flag = <span class="literal">true</span>;           </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> reader() &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;                </span><br><span class="line">        int i =  a +<span class="number">1</span>;      </span><br><span class="line">        â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹Aé¦–å…ˆæ‰§è¡Œwriter()æ–¹æ³•<br>çº¿ç¨‹Bçº¿ç¨‹æ¥ç€æ‰§è¡Œreader()æ–¹æ³•<br>çº¿ç¨‹Båœ¨int i=a+1 æ˜¯ä¸ä¸€å®šèƒ½çœ‹åˆ°aå·²ç»è¢«èµ‹å€¼ä¸º1<br>å› ä¸ºåœ¨writerä¸­ï¼Œä¸¤å¥è¯é¡ºåºå¯èƒ½æ‰“ä¹±</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹A</span><br><span class="line">flag=<span class="literal">true</span></span><br><span class="line">a=<span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹B</span><br><span class="line">flag=<span class="literal">true</span>(æ­¤æ—¶a=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h4 id="æŒ‡ä»¤é‡æ’-â€“-ä¿è¯æœ‰åºæ€§çš„æ–¹æ³•"><a href="#æŒ‡ä»¤é‡æ’-â€“-ä¿è¯æœ‰åºæ€§çš„æ–¹æ³•" class="headerlink" title="æŒ‡ä»¤é‡æ’ â€“ ä¿è¯æœ‰åºæ€§çš„æ–¹æ³•"></a>æŒ‡ä»¤é‡æ’ â€“ ä¿è¯æœ‰åºæ€§çš„æ–¹æ³•</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderExample</span> </span>&#123;</span><br><span class="line">int a = <span class="number">0</span>;</span><br><span class="line">boolean flag = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">public synchronized <span class="keyword">void</span> writer() &#123;</span><br><span class="line">    a = <span class="number">1</span>;                   </span><br><span class="line">    flag = <span class="literal">true</span>;           </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public synchronized <span class="keyword">void</span> reader() &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;                </span><br><span class="line">        int i =  a +<span class="number">1</span>;      </span><br><span class="line">        â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ­¥åï¼Œå³ä½¿åšäº†writeré‡æ’ï¼Œå› ä¸ºäº’æ–¥çš„ç¼˜æ•…ï¼Œreader çº¿ç¨‹çœ‹writerçº¿ç¨‹ä¹Ÿæ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚åœ¨çº¿ç¨‹Aæ‰§è¡Œå®Œä¹‹å‰ï¼Œçº¿ç¨‹Bæ˜¯è¿›ä¸æ¥çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹A</span><br><span class="line">flag=<span class="literal">true</span></span><br><span class="line">a=<span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹B</span><br><span class="line">flag=<span class="literal">true</span>(æ­¤æ—¶a=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h4 id="æŒ‡ä»¤é‡æ’çš„åŸºæœ¬åŸåˆ™"><a href="#æŒ‡ä»¤é‡æ’çš„åŸºæœ¬åŸåˆ™" class="headerlink" title="æŒ‡ä»¤é‡æ’çš„åŸºæœ¬åŸåˆ™"></a>æŒ‡ä»¤é‡æ’çš„åŸºæœ¬åŸåˆ™</h4><p>ç¨‹åºé¡ºåºåŸåˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ä¿è¯è¯­ä¹‰çš„ä¸²è¡Œæ€§<br>volatileè§„åˆ™ï¼švolatileå˜é‡çš„å†™ï¼Œå…ˆå‘ç”Ÿäºè¯»<br>é”è§„åˆ™ï¼šè§£é”(unlock)å¿…ç„¶å‘ç”Ÿåœ¨éšåçš„åŠ é”(lock)å‰<br>ä¼ é€’æ€§ï¼šAå…ˆäºBï¼ŒBå…ˆäºC é‚£ä¹ˆAå¿…ç„¶å…ˆäºC<br>çº¿ç¨‹çš„startæ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ<br>çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“ï¼ˆThread.join()ï¼‰<br>çº¿ç¨‹çš„ä¸­æ–­ï¼ˆinterrupt()ï¼‰å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç <br>å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäºfinalize()æ–¹æ³•</p><h1 id="ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µï¼ˆå­—èŠ‚ç è¿è¡Œçš„ä¸¤ç§æ–¹å¼ï¼‰"><a href="#ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µï¼ˆå­—èŠ‚ç è¿è¡Œçš„ä¸¤ç§æ–¹å¼ï¼‰" class="headerlink" title="ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µï¼ˆå­—èŠ‚ç è¿è¡Œçš„ä¸¤ç§æ–¹å¼ï¼‰"></a>ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µï¼ˆå­—èŠ‚ç è¿è¡Œçš„ä¸¤ç§æ–¹å¼ï¼‰</h1><h2 id="è§£é‡Šè¿è¡Œ"><a href="#è§£é‡Šè¿è¡Œ" class="headerlink" title="è§£é‡Šè¿è¡Œ"></a>è§£é‡Šè¿è¡Œ</h2><p>è§£é‡Šæ‰§è¡Œä»¥è§£é‡Šæ–¹å¼è¿è¡Œå­—èŠ‚ç <br>è§£é‡Šæ‰§è¡Œçš„æ„æ€æ˜¯ï¼šè¯»ä¸€å¥æ‰§è¡Œä¸€å¥</p><h2 id="ç¼–è¯‘è¿è¡Œï¼ˆJITâ€“just-in-timeï¼‰"><a href="#ç¼–è¯‘è¿è¡Œï¼ˆJITâ€“just-in-timeï¼‰" class="headerlink" title="ç¼–è¯‘è¿è¡Œï¼ˆJITâ€“just in timeï¼‰"></a>ç¼–è¯‘è¿è¡Œï¼ˆJITâ€“just in timeï¼‰</h2><p>å°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç <br>ç›´æ¥æ‰§è¡Œæœºå™¨ç <br>è¿è¡Œæ—¶ç¼–è¯‘<br>ç¼–è¯‘åæ€§èƒ½æœ‰æ•°é‡çº§çš„æå‡<br>ç¼–è¯‘æ‰§è¡Œå’Œè§£é‡Šæ‰§è¡Œæ€§èƒ½åº”è¯¥å·®åå€ä»¥ä¸Šã€‚</p><h1 id="ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µ"><a href="#ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µ" class="headerlink" title="ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µ"></a>ç¼–è¯‘å’Œè§£é‡Šè¿è¡Œçš„æ¦‚å¿µ</h1><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;JVMå¯åŠ¨æµç¨‹&quot;&gt;&lt;a href=&quot;#JVMå¯åŠ¨æµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;JVM
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šåˆè¯†JVM</title>
    <link href="http://mmmmmm.me/2019-02-23.html"/>
    <id>http://mmmmmm.me/2019-02-23.html</id>
    <published>2019-02-23T11:20:02.000Z</published>
    <updated>2019-02-23T12:28:46.769Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="JVMçš„æ¦‚å¿µ"><a href="#JVMçš„æ¦‚å¿µ" class="headerlink" title="JVMçš„æ¦‚å¿µ"></a>JVMçš„æ¦‚å¿µ</h1><h2 id="JVMæ˜¯Java-Virtual-Machineçš„ç®€ç§°ã€‚æ„ä¸ºJavaè™šæ‹Ÿæœº"><a href="#JVMæ˜¯Java-Virtual-Machineçš„ç®€ç§°ã€‚æ„ä¸ºJavaè™šæ‹Ÿæœº" class="headerlink" title="JVMæ˜¯Java Virtual Machineçš„ç®€ç§°ã€‚æ„ä¸ºJavaè™šæ‹Ÿæœº"></a>JVMæ˜¯Java Virtual Machineçš„ç®€ç§°ã€‚æ„ä¸ºJavaè™šæ‹Ÿæœº</h2><h2 id="è™šæ‹Ÿæœº"><a href="#è™šæ‹Ÿæœº" class="headerlink" title="è™šæ‹Ÿæœº"></a>è™šæ‹Ÿæœº</h2><p>æŒ‡é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿçš„å…·æœ‰å®Œæ•´ç¡¬ä»¶ç³»ç»ŸåŠŸèƒ½çš„ã€è¿è¡Œåœ¨ä¸€ä¸ªå®Œå…¨éš”ç¦»ç¯å¢ƒä¸­çš„å®Œæ•´è®¡ç®—æœºç³»ç»Ÿ</p><h2 id="æœ‰å“ªäº›è™šæ‹Ÿæœº"><a href="#æœ‰å“ªäº›è™šæ‹Ÿæœº" class="headerlink" title="æœ‰å“ªäº›è™šæ‹Ÿæœº"></a>æœ‰å“ªäº›è™šæ‹Ÿæœº</h2><ul><li>VMWare</li><li>Visual Box</li><li>JVM</li></ul><h2 id="VMWareæˆ–è€…Visual-Boxéƒ½æ˜¯ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿç‰©ç†CPUçš„æŒ‡ä»¤é›†"><a href="#VMWareæˆ–è€…Visual-Boxéƒ½æ˜¯ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿç‰©ç†CPUçš„æŒ‡ä»¤é›†" class="headerlink" title="VMWareæˆ–è€…Visual Boxéƒ½æ˜¯ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿç‰©ç†CPUçš„æŒ‡ä»¤é›†"></a>VMWareæˆ–è€…Visual Boxéƒ½æ˜¯ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿç‰©ç†CPUçš„æŒ‡ä»¤é›†</h2><p>æ¯”å¦‚å®ƒä»¬æ¨¡æ‹Ÿçš„cpuã€ç¡¬ç›˜ã€å†…å­˜ï¼Œç­‰éƒ½æ˜¯ç°å®å­˜åœ¨çš„ï¼Œèƒ½å¤Ÿåœ¨ç°å®ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¡ˆä¾‹çš„ã€‚</p><h2 id="JVMä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸJava-å­—èŠ‚ç çš„æŒ‡ä»¤é›†"><a href="#JVMä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸJava-å­—èŠ‚ç çš„æŒ‡ä»¤é›†" class="headerlink" title="JVMä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸJava å­—èŠ‚ç çš„æŒ‡ä»¤é›†"></a>JVMä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸJava å­—èŠ‚ç çš„æŒ‡ä»¤é›†</h2><p>JVMæ¨¡æ‹Ÿçš„å¯¹è±¡æ˜¯ç°å®ä¸­æ²¡æœ‰çš„ï¼Œç°å®ä¸­æ²¡æœ‰ä»»ä½•ä¸€ä¸ªè®¡ç®—æœºèƒ½å¤Ÿè¿è¡ŒJavaå­—èŠ‚ç ï¼Œå•çº¯ä»ä»è½¯ä»¶ä¸Šåšçš„ä¸€ä¸ªè®¾è®¡ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªç¡¬ä»¶çš„è¡Œä¸ºï¼Œæ¯”å¦‚jvmè¿è¡Œçš„çš„æ˜¯javaå­—èŠ‚ç æŒ‡ä»¤é›†ï¼Œä¸ºäº†è®¾è®¡ä¸Šçš„ç²¾ç®€ï¼Œæˆ‘ä»¬çŸ¥é“æ­£å¸¸çš„cpuä¸­æœ‰è‹¥å¹²ä¸ªå¯„å­˜å™¨ï¼Œjvmä¸­é™¤äº†pcå¯„å­˜å™¨å¤–ï¼Œå…¶ä»–çš„å¯„å­˜å™¨éƒ½åšäº†è£å‰ªï¼Œå› ä¸ºå¯„å­˜å™¨çš„ä¸»è¦åŠŸèƒ½æ˜¯åŠ å¿«æ•°æ®è®¿é—®çš„é€Ÿåº¦ï¼Œå› ä¸ºåœ¨jvmä¸­æ˜¯çº¯ç²¹ç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„ï¼Œé€Ÿåº¦ä½¿ç”¨å¯„å­˜å™¨åå¹¶ä¸ä¼šæœ‰å¾ˆå¥½çš„æå‡ï¼Œå¹¶ä¸”å¼•å…¥å¯„å­˜å™¨åï¼Œä¹Ÿä¸ºjvmçš„è®¾è®¡ä»¥åŠå®ç°å¸¦æ¥å¾ˆå¤§çš„å›°éš¾ï¼Œæ‰€ä»¥æŠŠè¿™äº›åŠŸèƒ½å»æ‰äº†ã€‚ç»¼ä¸Šï¼Œjvmæ˜¯ä¸€ä¸ªè¢«å®šåˆ¶è¿‡çš„ç°å®ä¸­ä¸å­˜åœ¨çš„è®¡ç®—æœºã€‚</p><h1 id="JVMå‘å±•å†å²"><a href="#JVMå‘å±•å†å²" class="headerlink" title="JVMå‘å±•å†å²"></a>JVMå‘å±•å†å²</h1><h2 id="1996å¹´-SUN-JDK-1-0-Classic-VM"><a href="#1996å¹´-SUN-JDK-1-0-Classic-VM" class="headerlink" title="1996å¹´ SUN JDK 1.0 Classic VM"></a>1996å¹´ SUN JDK 1.0 Classic VM</h2><p>çº¯è§£é‡Šè¿è¡Œï¼Œä½¿ç”¨å¤–æŒ‚è¿›è¡ŒJITï¼Œæ²¡æœ‰å†…ç½®çš„å³æ—¶ç¼–è¯‘çš„æ¨¡å—ï¼Œä¸€æ—¦å¼€å¯å¤–æŒ‚ï¼Œè§£é‡Šè¿è¡Œçš„åŠŸèƒ½å°±æ²¡æœ‰äº†ã€‚<br>Classic VMç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ï¼Œåœ¨1.3 ã€1.4çš„æ—¶å€™æ‰è¢«æ·˜æ±°</p><h2 id="1997å¹´-JDK1-1-å‘å¸ƒ"><a href="#1997å¹´-JDK1-1-å‘å¸ƒ" class="headerlink" title="1997å¹´ JDK1.1 å‘å¸ƒ"></a>1997å¹´ JDK1.1 å‘å¸ƒ</h2><p>-AWTã€å†…éƒ¨ç±»ã€JDBCã€RMIã€åå°„</p><h2 id="1998å¹´-JDK1-2-Solaris-Exact-VM"><a href="#1998å¹´-JDK1-2-Solaris-Exact-VM" class="headerlink" title="1998å¹´ JDK1.2 Solaris Exact VM"></a>1998å¹´ JDK1.2 Solaris Exact VM</h2><p>JIT è§£é‡Šå™¨æ··åˆ<br>Accurate Memory Management ç²¾ç¡®å†…å­˜ç®¡ç†ï¼Œæ•°æ®ç±»å‹æ•æ„Ÿ<br>æå‡çš„GCæ€§èƒ½<br>JDK1.2å¼€å§‹ ç§°ä¸ºJava 2<br>J2SE J2EE J2ME çš„å‡ºç°<br>åŠ å…¥Swing Collections</p><p>Solaris Exact VMç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒçŸ­ã€‚</p><h2 id="2000å¹´-JDK-1-3-Hotspot-ä½œä¸ºé»˜è®¤è™šæ‹Ÿæœºå‘å¸ƒ"><a href="#2000å¹´-JDK-1-3-Hotspot-ä½œä¸ºé»˜è®¤è™šæ‹Ÿæœºå‘å¸ƒ" class="headerlink" title="2000å¹´ JDK 1.3 Hotspot ä½œä¸ºé»˜è®¤è™šæ‹Ÿæœºå‘å¸ƒ"></a>2000å¹´ JDK 1.3 Hotspot ä½œä¸ºé»˜è®¤è™šæ‹Ÿæœºå‘å¸ƒ</h2><p>åŠ å…¥JavaSoundåŠ å…¥äº†ä¸€äº›å£°éŸ³ä¸Šçš„api</p><h2 id="2002å¹´-JDK-1-4-Classic-VMé€€å‡ºå†å²èˆå°"><a href="#2002å¹´-JDK-1-4-Classic-VMé€€å‡ºå†å²èˆå°" class="headerlink" title="2002å¹´ JDK 1.4 Classic VMé€€å‡ºå†å²èˆå°"></a>2002å¹´ JDK 1.4 Classic VMé€€å‡ºå†å²èˆå°</h2><p>Assert æ­£åˆ™è¡¨è¾¾å¼ NIO IPV6 æ—¥å¿—API åŠ å¯†ç±»åº“</p><h2 id="2004å¹´å‘å¸ƒ-JDK1-5-å³-JDK5-ã€J2SE-5-ã€Java-5ï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰"><a href="#2004å¹´å‘å¸ƒ-JDK1-5-å³-JDK5-ã€J2SE-5-ã€Java-5ï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰" class="headerlink" title="2004å¹´å‘å¸ƒ JDK1.5 å³ JDK5 ã€J2SE 5 ã€Java 5ï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰"></a>2004å¹´å‘å¸ƒ JDK1.5 å³ JDK5 ã€J2SE 5 ã€Java 5ï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰</h2><p>æ³›å‹<br>æ³¨è§£<br>è£…ç®±<br>æšä¸¾<br>å¯å˜é•¿çš„å‚æ•°<br>Foreachå¾ªç¯</p><h2 id="JDK1-6-JDK6"><a href="#JDK1-6-JDK6" class="headerlink" title="JDK1.6 JDK6"></a>JDK1.6 JDK6</h2><p>è„šæœ¬è¯­è¨€æ”¯æŒ<br>JDBC 4.0<br>Javaç¼–è¯‘å™¨ APIï¼ˆå¼€æ”¾äº†è¿™ä¸ªAPIï¼‰</p><h2 id="2011å¹´-JDK7å‘å¸ƒ"><a href="#2011å¹´-JDK7å‘å¸ƒ" class="headerlink" title="2011å¹´ JDK7å‘å¸ƒ"></a>2011å¹´ JDK7å‘å¸ƒ</h2><p>å»¶è¯¯é¡¹ç›®æ¨å‡ºåˆ°JDK8<br>G1ï¼ˆå…¨æ–°çš„gcæ”¶é›†å™¨ï¼‰<br>åŠ¨æ€è¯­è¨€å¢å¼ºï¼ˆåŠ¨æ€è¯­è¨€çš„ç«çƒ­ï¼‰<br>64ä½ç³»ç»Ÿä¸­çš„å‹ç¼©æŒ‡é’ˆ<br>NIO 2.0</p><h2 id="2014å¹´-JDK8å‘å¸ƒï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰"><a href="#2014å¹´-JDK8å‘å¸ƒï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰" class="headerlink" title="2014å¹´ JDK8å‘å¸ƒï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰"></a>2014å¹´ JDK8å‘å¸ƒï¼ˆé‡è¦ç‰ˆæœ¬ï¼‰</h2><p>Lambdaè¡¨è¾¾å¼ï¼ˆæ¨¡æ‹Ÿäº†å‡½æ•°å¼ç¼–ç¨‹ï¼‰<br>è¯­æ³•å¢å¼º Javaç±»å‹æ³¨è§£</p><h2 id="2016å¹´JDK9"><a href="#2016å¹´JDK9" class="headerlink" title="2016å¹´JDK9"></a>2016å¹´JDK9</h2><p>æ¨¡å—åŒ–</p><h2 id="å¤§äº‹ä»¶"><a href="#å¤§äº‹ä»¶" class="headerlink" title="å¤§äº‹ä»¶"></a>å¤§äº‹ä»¶</h2><h3 id="ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„JVMä¸ºHotSpot"><a href="#ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„JVMä¸ºHotSpot" class="headerlink" title="ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„JVMä¸ºHotSpot"></a>ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„JVMä¸ºHotSpot</h3><h3 id="HotSpot-ä¸ºLongview-Technologieså¼€å‘-è¢«SUNæ”¶è´­"><a href="#HotSpot-ä¸ºLongview-Technologieså¼€å‘-è¢«SUNæ”¶è´­" class="headerlink" title="HotSpot ä¸ºLongview Technologieså¼€å‘ è¢«SUNæ”¶è´­"></a>HotSpot ä¸ºLongview Technologieså¼€å‘ è¢«SUNæ”¶è´­</h3><h3 id="2006å¹´-Javaå¼€æº-å¹¶å»ºç«‹OpenJDK"><a href="#2006å¹´-Javaå¼€æº-å¹¶å»ºç«‹OpenJDK" class="headerlink" title="2006å¹´ Javaå¼€æº å¹¶å»ºç«‹OpenJDK"></a>2006å¹´ Javaå¼€æº å¹¶å»ºç«‹OpenJDK</h3><p>HotSpot æˆä¸ºSun JDKå’ŒOpenJDKä¸­æ‰€å¸¦çš„è™šæ‹Ÿæœº</p><h3 id="2008-å¹´-Oracleæ”¶è´­BEA"><a href="#2008-å¹´-Oracleæ”¶è´­BEA" class="headerlink" title="2008 å¹´ Oracleæ”¶è´­BEA"></a>2008 å¹´ Oracleæ”¶è´­BEA</h3><p>å¾—åˆ°JRockit VM</p><h3 id="2010å¹´Oracle-æ”¶è´­-Sun"><a href="#2010å¹´Oracle-æ”¶è´­-Sun" class="headerlink" title="2010å¹´Oracle æ”¶è´­ Sun"></a>2010å¹´Oracle æ”¶è´­ Sun</h3><p>å¾—åˆ°Hotspot</p><h3 id="Oracleå®£å¸ƒåœ¨JDK8æ—¶æ•´åˆJRockitå’ŒHotspotï¼Œä¼˜åŠ¿äº’è¡¥"><a href="#Oracleå®£å¸ƒåœ¨JDK8æ—¶æ•´åˆJRockitå’ŒHotspotï¼Œä¼˜åŠ¿äº’è¡¥" class="headerlink" title="Oracleå®£å¸ƒåœ¨JDK8æ—¶æ•´åˆJRockitå’ŒHotspotï¼Œä¼˜åŠ¿äº’è¡¥"></a>Oracleå®£å¸ƒåœ¨JDK8æ—¶æ•´åˆJRockitå’ŒHotspotï¼Œä¼˜åŠ¿äº’è¡¥</h3><p>åœ¨HotspotåŸºç¡€ä¸Šï¼Œç§»æ¤JRockitä¼˜ç§€ç‰¹æ€§<br>æ¨æµ‹ï¼šJRockitåœ¨ä¸ä¹…çš„å°†æ¥ä¼šé€€å‡ºå†å²èˆå°ï¼Œä½†æ˜¯HotSpotä¼šæ·±å—JRockitçš„å½±å“ã€‚</p><h1 id="JVMç§ç±»"><a href="#JVMç§ç±»" class="headerlink" title="JVMç§ç±»"></a>JVMç§ç±»</h1><h2 id="KVM"><a href="#KVM" class="headerlink" title="KVM"></a>KVM</h2><p>SUNå‘å¸ƒ<br>IOS Androidå‰ï¼Œå¹¿æ³›ç”¨äºæ‰‹æœºç³»ç»Ÿ</p><h2 id="CDC-CLDC-HotSpot"><a href="#CDC-CLDC-HotSpot" class="headerlink" title="CDC/CLDC HotSpot"></a>CDC/CLDC HotSpot</h2><p>æ‰‹æœºã€ç”µå­ä¹¦ã€PDAç­‰è®¾å¤‡ä¸Šå»ºç«‹ç»Ÿä¸€çš„Javaç¼–ç¨‹æ¥å£<br>J2MEçš„é‡è¦ç»„æˆéƒ¨åˆ†</p><h2 id="JRockit"><a href="#JRockit" class="headerlink" title="JRockit"></a>JRockit</h2><h2 id="IBM-J9-VM"><a href="#IBM-J9-VM" class="headerlink" title="IBM J9 VM"></a>IBM J9 VM</h2><p>IBMå†…éƒ¨</p><h2 id="Apache-Harmony"><a href="#Apache-Harmony" class="headerlink" title="Apache Harmony"></a>Apache Harmony</h2><p>å…¼å®¹äºJDK 1.5å’ŒJDK 1.6çš„Javaç¨‹åºè¿è¡Œå¹³å°<br>ä¸Oracleå…³ç³»æ¶åŠ£ é€€å‡ºJCP ï¼ŒJavaç¤¾åŒºçš„åˆ†è£‚<br>OpenJDKå‡ºç°åï¼Œå—åˆ°æŒ‘æˆ˜ 2011å¹´ é€€å½¹<br>æ²¡æœ‰å¤§è§„æ¨¡å•†ç”¨ç»å†<br>å¯¹Androidçš„å‘å±•æœ‰ç§¯æä½œç”¨<br>BEA</p><h1 id="Javaè¯­è¨€è§„èŒƒ"><a href="#Javaè¯­è¨€è§„èŒƒ" class="headerlink" title="Javaè¯­è¨€è§„èŒƒ"></a>Javaè¯­è¨€è§„èŒƒ</h1><h2 id="è¯­æ³•å®šä¹‰"><a href="#è¯­æ³•å®šä¹‰" class="headerlink" title="è¯­æ³•å®šä¹‰"></a>è¯­æ³•å®šä¹‰</h2><h3 id="IfThenStatement"><a href="#IfThenStatement" class="headerlink" title="IfThenStatement:"></a>IfThenStatement:</h3><p>if ( Expression ) Statement</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="literal">true</span>)&#123;<span class="keyword">do</span> sth;&#125;</span><br></pre></td></tr></table></figure><h3 id="ArgumentList"><a href="#ArgumentList" class="headerlink" title="ArgumentList:"></a>ArgumentList:</h3><p>Argument<br>ArgumentList , Argument</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(a,b,c,d);</span><br></pre></td></tr></table></figure><h2 id="è¯æ³•ç»“æ„"><a href="#è¯æ³•ç»“æ„" class="headerlink" title="è¯æ³•ç»“æ„"></a>è¯æ³•ç»“æ„</h2><p>\u + 4ä¸ª16è¿›åˆ¶æ•°å­— è¡¨ç¤ºUTF-16<br>è¡Œç»ˆç»“ç¬¦ï¼š CR, or LF, or CR LF.<br>ç©ºç™½ç¬¦<br>ç©ºæ ¼ tab \t æ¢é¡µ \f è¡Œç»ˆç»“ç¬¦<br>æ³¨é‡Š<br>æ ‡è¯†ç¬¦<br>å…³é”®å­—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ‡è¯†ç¬¦ï¼šæ ‡è¯†ç¬¦å­—ç¬¦ä¸²ä¸èƒ½ä½¿å…³é”®å­—æˆ–è€…å¸ƒå°”å€¼æˆ–è€…null</span></span><br><span class="line">Identifier:    IdentifierChars but not a Keyword or BooleanLiteral or NullLiteral</span><br><span class="line"><span class="comment">//æ ‡è¯†ç¬¦ä¸²ï¼šjavaå­—ç¬¦</span></span><br><span class="line">IdentifierChars:    JavaLetter    IdentifierChars JavaLetterOrDigit</span><br><span class="line"><span class="comment">//javaå­—ç¬¦ï¼šä»»ä½•ä¸€ä¸ªunicode</span></span><br><span class="line">JavaLetter:    any Unicode character that is a Java letter (see below)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">JavaLetterOrDigit:    any Unicode character that is a Java letter-or-digit (see below)</span><br></pre></td></tr></table></figure><h3 id="å°ä¾‹å­"><a href="#å°ä¾‹å­" class="headerlink" title="å°ä¾‹å­"></a>å°ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> æ‰“å°()&#123;</span><br><span class="line">System.out.println(<span class="string">"ä¸­æ–‡æ–¹æ³•å“¦"</span>);</span><br><span class="line">&#125;</span><br><span class="line">public  <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">æ‰“å°();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ„æ€çš„æ˜¯ï¼Œä»£ç ä¸­æœ‰ä¸­æ–‡</p><h3 id="æ•°å­—ç›¸å…³"><a href="#æ•°å­—ç›¸å…³" class="headerlink" title="æ•°å­—ç›¸å…³"></a>æ•°å­—ç›¸å…³</h3><p>åœ¨jdk1.7ä¸­ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ”¹å˜æ˜¯å…è®¸æœ‰ä¸‹åˆ’çº¿ï¼Œå¥½å¤„æ˜¯å½“æ•°å­—æ¯”è¾ƒå¤§çš„æ—¶å€™çœ‹çš„æ¯”è¾ƒæ¸…æ¥šä¸€äº›ã€‚</p><ul><li>Int<br>0 2 0372 0xDada_Cafe 1996 0x00_FF__00_FF</li><li>Long<br>0l 0777L 0x100000000L 2_147_483_648L 0xC0B0L</li><li>Float<br>1e1f 2.f .3f 0f 3.14f 6.022137e+23f</li><li>Double<br>1e1 2. .3 0.0 3.14 1e-9d 1e137</li><li>æ“ä½œ<br>+= -= *= /= &amp;= |= ^= %= &lt;&lt;= &gt;&gt;= &gt;&gt;&gt;=<h3 id="å“ªäº›æ˜¯åˆæ³•çš„æ•°å­—å‘¢ï¼Ÿ"><a href="#å“ªäº›æ˜¯åˆæ³•çš„æ•°å­—å‘¢ï¼Ÿ" class="headerlink" title="å“ªäº›æ˜¯åˆæ³•çš„æ•°å­—å‘¢ï¼Ÿ"></a>å“ªäº›æ˜¯åˆæ³•çš„æ•°å­—å‘¢ï¼Ÿ</h3>private int a=0xDada_Cafe;<br>private float b=0x1.fffffeP+127f;<br>private float c=1996;<br>private float d=1996.3;<br>private int f=9999e2;<br>private double g=33e2;<br>private float h=0x1.fffep-12f;<br>private float i=1.fffep-12f;<br>private long p=0b1_1_1_0_1;<br>private long q=0b1_1_1_0_2;</li></ul><h2 id="ç±»å‹å’Œå˜é‡"><a href="#ç±»å‹å’Œå˜é‡" class="headerlink" title="ç±»å‹å’Œå˜é‡"></a>ç±»å‹å’Œå˜é‡</h2><ul><li>å…ƒç±»å‹<br>byte short int long float char</li><li>å˜é‡åˆå§‹å€¼<br>boolean false<br>char \u0000</li><li>æ³›å‹</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Value</span> </span>&#123; int val; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">        int i1 = <span class="number">3</span>;</span><br><span class="line">        int i2 = i1;</span><br><span class="line">        i2 = <span class="number">4</span>;</span><br><span class="line">        System.out.print(<span class="string">"i1=="</span> + i1);</span><br><span class="line">        System.out.println(<span class="string">" but i2=="</span> + i2);</span><br><span class="line">        Value v1 = <span class="keyword">new</span> Value();</span><br><span class="line">        v1.val = <span class="number">5</span>;</span><br><span class="line">        Value v2 = v1;</span><br><span class="line">        v2.val = <span class="number">6</span>;</span><br><span class="line">        System.out.print(<span class="string">"v1.val=="</span> + v1.val);</span><br><span class="line">        System.out.println(<span class="string">" and v2.val=="</span> + v2.val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>i1==3 but i2==4<br>v1.val==6 and v2.val==6<br>i1 i2ä¸ºä¸åŒçš„å˜é‡<br>v1 v2ä¸ºå¼•ç”¨åŒä¸€ä¸ªå®ä¾‹</p><h2 id="ç•¥"><a href="#ç•¥" class="headerlink" title="ç•¥"></a>ç•¥</h2><p>Javaå†…å­˜æ¨¡å‹<br>ç±»åŠ è½½é“¾æ¥çš„è¿‡ç¨‹<br>public static final abstractçš„å®šä¹‰<br>å¼‚å¸¸<br>æ•°ç»„çš„ä½¿ç”¨<br>â€¦â€¦.</p><h1 id="JVMè§„èŒƒ"><a href="#JVMè§„èŒƒ" class="headerlink" title="JVMè§„èŒƒ"></a>JVMè§„èŒƒ</h1><p>Javaè¯­è¨€è§„èŒƒå®šä¹‰äº†ä»€ä¹ˆæ˜¯Javaè¯­è¨€<br>Javaè¯­è¨€å’ŒJVMç›¸å¯¹ç‹¬ç«‹<br>ç¬¦åˆJVMè§„èŒƒçš„å°±èƒ½å¤Ÿåœ¨JVMä¸Šè¿è¡Œï¼Œæ¯”å¦‚ï¼š</p><ul><li>Groovy</li><li>Clojure</li><li><p>Scala<br>JVMä¸»è¦å®šä¹‰äºŒè¿›åˆ¶classæ–‡ä»¶å’ŒJVMæŒ‡ä»¤é›†ç­‰</p></li><li><p>Class æ–‡ä»¶æ ¼å¼</p></li><li>æ•°å­—çš„å†…éƒ¨è¡¨ç¤ºå’Œå­˜å‚¨<br>Byte -128 to 127 (-27 to 27 - 1)</li><li>returnAddress æ•°æ®ç±»å‹å®šä¹‰<br>æŒ‡å‘æ“ä½œç çš„æŒ‡é’ˆã€‚ä¸å¯¹åº”Javaæ•°æ®ç±»å‹ï¼Œä¸èƒ½åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€‚Finallyå®ç°éœ€è¦</li><li>å®šä¹‰PC</li><li>å †</li><li>æ ˆ</li><li>æ–¹æ³•åŒº</li></ul><h2 id="æ•´æ•°çš„è¡¨è¾¾"><a href="#æ•´æ•°çš„è¡¨è¾¾" class="headerlink" title="æ•´æ•°çš„è¡¨è¾¾"></a>æ•´æ•°çš„è¡¨è¾¾</h2><ul><li>åŸç ï¼šç¬¬ä¸€ä½ä¸ºç¬¦å·ä½ï¼ˆ0ä¸ºæ­£æ•°ï¼Œ1ä¸ºè´Ÿæ•°ï¼‰</li><li>åç ï¼šç¬¦å·ä½ä¸åŠ¨ï¼ŒåŸç å–å</li><li>è´Ÿæ•°è¡¥ç ï¼šç¬¦å·ä½ä¸åŠ¨ï¼Œåç åŠ 1</li><li>æ­£æ•°è¡¥ç ï¼šå’ŒåŸç ç›¸åŒ<ul><li>æ‰“å°æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤º</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int a=<span class="number">-6</span>;</span><br><span class="line"><span class="comment">//å› ä¸ºæ•´æ•°æœ‰32ä½ï¼Œæ‰€ä»¥è¿›è¡Œ32æ¬¡å¾ªç¯ã€‚</span></span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line"><span class="comment">//0x80000000è¡¨ç¤ºæœ€é«˜ä½ä¸º1çš„æ•°å­—ï¼Œæ‰€ä»¥a &amp; 0x80000000åªæœ‰ä¸€ä½æ˜¯1ï¼Œ</span></span><br><span class="line"><span class="comment">//ç¬¬ä¸€æ¬¡i=0ï¼Œå°±æ˜¯æŠŠaçš„ç¬¬ä¸€ä½å–å‡ºæ¥ï¼Œæ— ç¬¦å·å³ç§»(31-i)ä½ã€‚</span></span><br><span class="line"><span class="comment">//ä¾æ¬¡å¾ªç¯ï¼Œå°†æ¯ä¸€ä½æ‰“å°å‡ºæ¥</span></span><br><span class="line">int t=(a &amp; <span class="number">0x80000000</span>&gt;&gt;&gt;i)&gt;&gt;&gt;(<span class="number">31</span>-i);</span><br><span class="line">System.out.print(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">00000101</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-6</span></span><br><span class="line">åŸç ï¼š <span class="number">10000110</span></span><br><span class="line">åç ï¼š <span class="number">11111001</span></span><br><span class="line">è¡¥ç ï¼š <span class="number">11111010</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span></span><br><span class="line">åŸç ï¼š <span class="number">10000001</span></span><br><span class="line">åç ï¼š <span class="number">11111110</span></span><br><span class="line">è¡¥ç ï¼š <span class="number">11111111</span></span><br></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆè¦ç”¨è¡¥ç ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨è¡¥ç ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨è¡¥ç ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ç”¨è¡¥ç ï¼Ÿ</h3><p>0æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æ•°å­—ï¼Œæ—¢ä¸å±äºæ­£æ•°ï¼Œä¹Ÿä¸å±äºè´Ÿæ•°<br>è®¡ç®—0çš„è¡¨ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line">æ­£æ•°ï¼š<span class="number">00000000</span></span><br><span class="line">è´Ÿæ•°ï¼š<span class="number">10000000</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line">æ­£æ•°ï¼š<span class="number">00000000</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line">è´Ÿæ•°ï¼š<span class="number">10000000</span></span><br><span class="line">åç ï¼š<span class="number">11111111</span></span><br><span class="line">è¡¥ç ï¼š<span class="number">00000000</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œè¡¥ç çš„å¥½å¤„æ˜¯ä¸ºäº†æ²¡æœ‰æ­§ä¹‰çš„è¡¨ç¤ºé›¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-6</span>+<span class="number">5</span></span><br><span class="line">    <span class="number">11111010</span></span><br><span class="line">+ <span class="number">00000101</span></span><br><span class="line">= <span class="number">11111111</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-4</span>+<span class="number">5</span></span><br><span class="line">    <span class="number">11111100</span></span><br><span class="line">+ <span class="number">00000101</span></span><br><span class="line">= <span class="number">00000001</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-3</span>+<span class="number">5</span></span><br><span class="line">    <span class="number">11111101</span></span><br><span class="line">+ <span class="number">00000101</span></span><br><span class="line">= <span class="number">00000010</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œï¼Œè¡¥ç è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯æ–¹ä¾¿çš„è®¡ç®—ä¸¤ä¸ªæ•°å­—ä¹‹å’Œï¼ˆä¸¤ä¸ªè¡¥ç ä¹‹å’Œï¼Œç¬¦å·ä½ç›´æ¥å‚ä¸è¿ç®—ï¼Œå¾—åˆ°çš„è®°è¿‡å°±æ˜¯æ­£ç¡®çš„ç»“æœã€‚å¦‚æœæ˜¯æºç åšè®¡ç®—ï¼Œç¬¦å·ä½å‚ä¸è¿ç®—å¾—ä¸åˆ°æ­£ç¡®çš„ç»“æœã€‚ï¼‰ï¼Œå½“ç„¶å‡æ³•æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åŠ æ³•ã€‚</p><h2 id="Floatçš„è¡¨ç¤ºä¸å®šä¹‰"><a href="#Floatçš„è¡¨ç¤ºä¸å®šä¹‰" class="headerlink" title="Floatçš„è¡¨ç¤ºä¸å®šä¹‰"></a>Floatçš„è¡¨ç¤ºä¸å®šä¹‰</h2><p>æ”¯æŒ IEEE 754<br>s eeeeeeee mmmmmmmmmmmmmmmmmmmmmmm<br>sç¬¦å·ä½ eeeeeeee æŒ‡æ•°ï¼š8 mmmmmmmmmmmmmmmmmmmmmmm å°¾æ•°ï¼š23</p><p>eå…¨0 å°¾æ•°é™„åŠ ä½ä¸º0 å¦åˆ™å°¾æ•°é™„åŠ ä½ä¸º1ï¼Œæ‰€ä»¥è¿™é‡Œçš„å°¾æ•°çœ‹ä¼¼æ˜¯23ä½ï¼Œå®è´¨ä¸Šæ˜¯24ä½ã€‚<br>è¡¨è¾¾å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s*m*<span class="number">2</span>^(e<span class="number">-127</span>)</span><br></pre></td></tr></table></figure><p>mæŒ‡çš„æ˜¯åé¢çš„23ä½</p><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-5</span></span><br><span class="line"><span class="number">1</span> <span class="number">10000001</span> <span class="number">01000000000000000000000</span></span><br><span class="line"><span class="number">-1</span>*<span class="number">2</span>^(<span class="number">129</span><span class="number">-127</span>)*(<span class="number">2</span>^<span class="number">0</span>+<span class="number">2</span>^<span class="number">-2</span>)</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•"><a href="#ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•" class="headerlink" title="ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•"></a>ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•</h2><p>clinit ç±»çš„åˆå§‹åŒ–æ–¹æ³•<br>init å®ä¾‹çš„åˆå§‹åŒ–æ–¹æ³•</p><h2 id="JVMæŒ‡ä»¤é›†"><a href="#JVMæŒ‡ä»¤é›†" class="headerlink" title="JVMæŒ‡ä»¤é›†"></a>JVMæŒ‡ä»¤é›†</h2><ul><li>ç±»å‹è½¬åŒ–<br>l2i</li><li>å‡ºæ ˆå…¥æ ˆæ“ä½œ<br>å› ä¸ºè™šæ‹Ÿæœºæ²¡æœ‰å¯„å­˜å™¨ï¼Œæ‰€ä»¥å¾ˆå¤šçš„æŒ‡ä»¤éƒ½æ˜¯é€šè¿‡æ ˆçš„æ–¹å¼æ¥æ“ä½œçš„ï¼Œæ‰€ä»¥æœ‰ä¸€ç³»åˆ—çš„æŒ‡ä»¤æ¥å®šä¹‰å‡ºæ ˆå’Œå…¥æ ˆçš„æ“ä½œã€‚<br>aload astore</li><li>è¿ç®—<br>iaddï¼ˆ+ï¼‰ isubï¼ˆ-ï¼‰</li><li>æµç¨‹æ§åˆ¶<br>ifeqï¼ˆç›¸ç­‰ï¼‰ ifneï¼ˆä¸ç›¸ç­‰ï¼‰</li><li><p>å‡½æ•°è°ƒç”¨<br>invokevirtualï¼ˆè°ƒç”¨è™šå‡½æ•°ï¼‰ invokeinterface ï¼ˆè°ƒç”¨æ¥å£ï¼‰ invokespecial invokestatic ï¼ˆè°ƒç”¨é™æ€ï¼‰</p><h2 id="JVMéœ€è¦å¯¹Java-Library-æä¾›ä»¥ä¸‹æ”¯æŒï¼š"><a href="#JVMéœ€è¦å¯¹Java-Library-æä¾›ä»¥ä¸‹æ”¯æŒï¼š" class="headerlink" title="JVMéœ€è¦å¯¹Java Library æä¾›ä»¥ä¸‹æ”¯æŒï¼š"></a>JVMéœ€è¦å¯¹Java Library æä¾›ä»¥ä¸‹æ”¯æŒï¼š</h2><p>å› ä¸ºè¿™äº›åŠŸèƒ½æ²¡æœ‰åŠæ³•é€šè¿‡javaè¯­è¨€æœ¬èº«æ”¯æŒï¼Œæ‰€ä»¥é€šè¿‡JVMå®ç°ã€‚</p></li><li><p>åå°„ java.lang.reflect</p></li><li>ClassLoader</li><li>åˆå§‹åŒ–classå’Œinterface</li><li>å®‰å…¨ç›¸å…³ java.security</li><li>å¤šçº¿ç¨‹</li><li>å¼±å¼•ç”¨<h2 id="JVMçš„ç¼–è¯‘"><a href="#JVMçš„ç¼–è¯‘" class="headerlink" title="JVMçš„ç¼–è¯‘"></a>JVMçš„ç¼–è¯‘</h2>æºç åˆ°JVMæŒ‡ä»¤çš„å¯¹åº”æ ¼å¼<br>Javap åç¼–è¯‘<br>JVMåæ±‡ç¼–çš„æ ¼å¼ï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;index&gt; &lt;opcode&gt; [ &lt;operand1&gt; [ &lt;operand2&gt;... ]] [&lt;comment&gt;]</span><br></pre></td></tr></table></figure><p>ç´¢å¼•ï¼ˆåç§»é‡ï¼‰ æ“ä½œç ï¼ˆ+-*/å…¥ç«™å‡ºç«™ï¼‰ æ³¨è§£</p><h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> spin() &#123;</span><br><span class="line">  int i; </span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123; ;</span><br><span class="line">     <span class="comment">// Loop body is empty</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>   iconst_0       <span class="comment">// Push int constant 0</span></span><br><span class="line"><span class="number">1</span>   istore_1       <span class="comment">// Store into local variable 1 (i=0)</span></span><br><span class="line"><span class="number">2</span>   goto <span class="number">8</span>         <span class="comment">// First time through don't increment</span></span><br><span class="line"><span class="number">5</span>   iinc <span class="number">1</span> <span class="number">1</span>       <span class="comment">// Increment local variable 1 by 1 (i++)</span></span><br><span class="line"><span class="number">8</span>   iload_1        <span class="comment">// Push local variable 1 (i)</span></span><br><span class="line"><span class="number">9</span>   bipush <span class="number">100</span>     <span class="comment">// Push int constant 100</span></span><br><span class="line"><span class="number">11</span>  if_icmplt <span class="number">5</span>    <span class="comment">// Compare and loop if less than (i &lt; 100)</span></span><br><span class="line"><span class="number">14</span>  <span class="keyword">return</span>         <span class="comment">// Return void when done</span></span><br></pre></td></tr></table></figure><p>åœ¨JVMä¸­ç›´æ¥æ‰§è¡Œçš„æ˜¯JVMæŒ‡ä»¤ä»£ç ï¼ˆå¦‚ä¸Šï¼‰ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;JVMçš„æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#JVMçš„æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;JVMçš„æ¦‚
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="JVMå†…æ ¸-åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/JVM%E5%86%85%E6%A0%B8-%E5%8E%9F%E7%90%86%E3%80%81%E8%AF%8A%E6%96%AD%E4%B8%8E%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="JVM" scheme="http://mmmmmm.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šJettyåˆ†æ</title>
    <link href="http://mmmmmm.me/2019-02-22.html"/>
    <id>http://mmmmmm.me/2019-02-22.html</id>
    <published>2019-02-22T11:20:02.000Z</published>
    <updated>2019-02-22T15:39:09.109Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p>æœ¬æ¬¡ç¬”è®°æ˜¯å¯¹jettyï¼Œä¸€ä¸ªservletå®¹å™¨ï¼Œä¸€ä¸ªhttpServer,å†…éƒ¨çš„å®ç°ï¼Œå› ä¸ºä»£ç é‡é‡æ¯”è¾ƒå¤šï¼Œä¸ä¼šä»æ¶æ„çš„æ–¹å‘ä»‹ç»ï¼Œä½œä¸ºä¸€ä¸ªservletå®¹å™¨ï¼Œä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨jspï¼Œè€Œæ˜¯é€šè¿‡å¤šçº¿ç¨‹çš„æ–¹å‘ï¼Œä»ä»£ç è§¦å‘ï¼Œçœ‹ç©¶ç«Ÿæ˜¯å¦‚ä½•æé«˜å¹¶å‘é‡çš„ã€‚<br>ç»¼ä¸Šæœ¬æ¬¡ç¬”è®°å¹¶æ²¡æœ‰å¯¹jettyå…·ä½“æ˜¯å¦‚ä½•ç”¨çš„åšä»‹ç»ï¼Œä¸»è¦æ˜¯å­¦ä¹ jettyé«˜å¹¶å‘çš„å¤„ç†æ‰‹æ®µã€‚</p><h1 id="new-Server"><a href="#new-Server" class="headerlink" title="new Server()"></a>new Server()</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public Server(@Name(<span class="string">"port"</span>)int port) &#123;</span><br><span class="line">    <span class="keyword">this</span>((ThreadPool)<span class="literal">null</span>);</span><br><span class="line">    ServerConnector connector=<span class="keyword">new</span> ServerConnector(<span class="keyword">this</span>); connector.setPort(port);</span><br><span class="line">    setConnectors(<span class="keyword">new</span> Connector[]&#123;connector&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–çº¿ç¨‹æ± "><a href="#åˆå§‹åŒ–çº¿ç¨‹æ± " class="headerlink" title="åˆå§‹åŒ–çº¿ç¨‹æ± "></a>åˆå§‹åŒ–çº¿ç¨‹æ± </h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Server(@Name(<span class="string">"threadpool"</span>) ThreadPool pool) &#123;</span><br><span class="line">    _threadPool=pool!=<span class="literal">null</span>?pool:<span class="keyword">new</span> QueuedThreadPool(); addBean(_threadPool);</span><br><span class="line">    setServer(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="QueuedThreadPool"><a href="#QueuedThreadPool" class="headerlink" title="QueuedThreadPool"></a>QueuedThreadPool</h3><p>å¹¶ä¸æ˜¯åˆå§‹åŒ–jdkçš„çº¿ç¨‹æ± ï¼Œè€Œæ˜¯newè‡ªå·±çš„QueuedThreadPoolï¼ŒQueuedThreadPoolå®ç°äº†SizedThreadPool</p><h3 id="execute-æ–¹æ³•"><a href="#execute-æ–¹æ³•" class="headerlink" title="execute()æ–¹æ³•"></a>execute()æ–¹æ³•</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> execute(Runnable job) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isRunning() || !_jobs.offer(job)) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"&#123;&#125; rejected &#123;&#125;"</span>, <span class="keyword">this</span>, job);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(job.toString()); &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Make sure there is at least one thread executing the job. if (getThreads() == 0)</span></span><br><span class="line">        startThreads(<span class="number">1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ ¸å¿ƒæ˜¯å°†ä»»åŠ¡å‹å…¥é˜Ÿåˆ— ï¼š _jobs.offer(job)</p><h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>è¿™é‡Œçš„_jobsæ˜¯BlockingQueueï¼Œä¿å­˜çº¿ç¨‹æ± æ‰§è¡Œçš„æ‰€æœ‰çš„ä»»åŠ¡ã€‚<br>å°†ä»»åŠ¡æ¨å…¥<br>BlockingQueue<runnable>org.eclipse.jetty.util.thread.QueuedThreadPool._jobs</runnable></p><p>BlockingQueueä¸æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ï¼Œæ‰€ä»¥executeä¸å¤ªå¯èƒ½è¢«éå¸¸é¢‘ç¹çš„è°ƒç”¨ã€‚</p><h2 id="åˆå§‹åŒ–ServerConnector"><a href="#åˆå§‹åŒ–ServerConnector" class="headerlink" title="åˆå§‹åŒ–ServerConnector"></a>åˆå§‹åŒ–ServerConnector</h2><p>å¤„ç†ä¸€äº›httpçš„è¿æ¥ä»¥åŠNIOã€Selectorä¸€äº›çš„ä¸œè¥¿ã€‚<br>HTTP connector using NIO ByteChannels and Selectors<br>ç»§æ‰¿è‡ª AbstractConnector</p><h3 id="åˆå§‹åŒ–ScheduledExecutorScheduler"><a href="#åˆå§‹åŒ–ScheduledExecutorScheduler" class="headerlink" title="åˆå§‹åŒ–ScheduledExecutorScheduler"></a>åˆå§‹åŒ–ScheduledExecutorScheduler</h3><p>è°ƒåº¦å™¨<br>based on JDKâ€™s {@link ScheduledThreadPoolExecutor}.<br>æœ‰äº›ä»»åŠ¡æ˜¯éœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡Œä¸€æ¬¡çš„ï¼Œæ¯”å¦‚æ¯ä¸€åˆ†é’Ÿéœ€è¦æ£€æŸ¥ä¸€äº›ä¸œè¥¿ï¼Œè¯¸å¦‚æ­¤ç±»çš„ä»»åŠ¡å°±æ˜¯ç”±scheduleæ¥è°ƒåº¦çš„ã€‚</p><h3 id="åˆå§‹åŒ–ByteBufferPool"><a href="#åˆå§‹åŒ–ByteBufferPool" class="headerlink" title="åˆå§‹åŒ–ByteBufferPool"></a>åˆå§‹åŒ–ByteBufferPool</h3><p>ByteBufferæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ†ä¸ºä¸¤ç§_indirect ByteBufferï¼ˆåˆ†é…åœ¨å †å½“ä¸­ï¼‰å’Œ_directByteBufferï¼ˆåˆ†é…åœ¨å†…å­˜å½“ä¸­ï¼‰ï¼Œç›¸å½“äºä¸€ä¸ªå¯¹è±¡æ± ï¼Œè¿™å…¶ä¸­çš„byteBufferå®é™…ä¸Šæ˜¯å¯ä»¥å¤ç”¨çš„ã€‚å¯¹è±¡æ± çš„å¥½å¤„å°±æ˜¯å¯ä»¥å‡å°‘gcï¼Œå‡å°‘newã€‚åœ¨javaä¸­newæ˜¯ç»è¿‡äº†ç»å¯¹çš„ä¼˜åŒ–çš„ï¼Œæ€§èƒ½è¿˜æ˜¯æ¯”è¾ƒé«˜ï¼Œå…³é”®æ˜¯å›æ”¶ï¼Œæ–°ç”Ÿä»£çš„å›æ”¶ä¼šæ›´åŠ çš„é¢‘ç¹ã€‚å¦‚æœè‡ªå·±å†™ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿˜ä¸å¦‚é€šè¿‡newã€gcçš„æ–¹å¼ï¼Œå› ä¸ºçº¿ç¨‹æ± å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¥½å¤šçº¿ç¨‹åœ¨ç”¨ï¼Œæ‹¿åˆ°å¯¹è±¡å’Œå½’è¿˜å¯¹è±¡çš„æ—¶å€™å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœç®€å•çš„åŠ synchronizeï¼Œé™¤éæ˜¯ç‰¹åˆ«å¤§çš„è¶…çº§å¯¹è±¡ï¼Œæ€§èƒ½å¯èƒ½æ¯”newï¼Œå¥½ä¸€ç‚¹ï¼Œå¦åˆ™ï¼Œå¦‚æœç”¨synchronizeæ„é€ çš„çº¿ç¨‹æ± æ€§èƒ½è¿˜ä¸å¦‚newå‡ºæ¥çš„ã€‚</p><h4 id="ArrayByteBufferPool"><a href="#ArrayByteBufferPool" class="headerlink" title="ArrayByteBufferPool"></a>ArrayByteBufferPool</h4><p>æ™®é€šå¯¹è±¡æ± ä¸­çš„å¯¹è±¡éƒ½æ˜¯å¯¹ç«‹çš„ï¼Œæˆ‘å»æ‹¿ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯ByteBufferPoolä¸åŒï¼Œå› ä¸ºä½ å¯èƒ½éœ€è¦2kçš„bytebufferï¼Œä¹Ÿå¯èƒ½éœ€è¦ä¸€ä¸ª2mçš„bytebuffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public ArrayByteBufferPool(int minSize, int increment, int maxSize)</span><br><span class="line">public ArrayByteBufferPool() &#123;</span><br><span class="line"><span class="keyword">this</span>(<span class="number">0</span>,<span class="number">1024</span>,<span class="number">64</span>*<span class="number">1024</span>);</span><br><span class="line">&#125;</span><br><span class="line">_direct=<span class="keyword">new</span> Bucket[maxSize/increment];</span><br><span class="line">_indirect=<span class="keyword">new</span> Bucket[maxSize/increment];</span><br></pre></td></tr></table></figure><p>minSizeå…¶å®å¤§å°ï¼ˆæœ€å°çš„å®¹é‡ï¼‰ï¼Œincrementå¢é‡ï¼ŒmaxSizeæœ€å¤§çš„å¤§å°</p><h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p>Bucketç†è§£ä¸ºç¯®å­ï¼Œä¸€ä¸ªç¯®å­é‡Œé¢åªæ”¾ä¸€ä¸­å¤§å°çš„buffer<br>å› ä¸º1-63kä¸å¯èƒ½æ¯ä¸€ä¸ªéƒ½æœ‰ï¼Œä¹Ÿè®¸ç³»ç»Ÿä¸­åªéœ€è¦32kï¼Œè¿™ä¸ªæ—¶å€™1kã€2kç­‰ç­‰éƒ½ä¸éœ€è¦ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå»¶è¿ŸåŠ è½½çš„åŠŸèƒ½<br>_direct Bucketæ•°ç»„ _indirect Bucketæ•°ç»„<br>ä¸ºæ¯ä¸€ä¸ªå¤§å°ï¼Œæ–°å»ºä¸€ä¸ªBucket ä½†ä¸åˆå§‹åŒ–ByteBuffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int size=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (int i=<span class="number">0</span>;i&lt;_direct.length;i++) &#123;</span><br><span class="line">    size+=_inc;</span><br><span class="line">    _direct[i]=<span class="keyword">new</span> Bucket(size);</span><br><span class="line">    _indirect[i]=<span class="keyword">new</span> Bucket(size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªBucektå­˜æ”¾å¤§å°ç›¸åŒçš„æ‰€æœ‰çš„ByteBuffer<br>_size<br>bytebufferå¤§å°<br>_queue<br>public final Queue<bytebuffer>_queue= new ConcurrentLinkedQueue&lt;&gt;();<br>åˆå§‹åŒ–ByteBuPoolçš„æ—¶å€™æ‰€æœ‰çš„Bucketéƒ½åˆ›å»ºä¸€éï¼Œä½†æ˜¯Bucketé‡Œé¢çš„Queueé‡Œé¢çš„å†…å®¹éƒ½æ˜¯å»¶è¿ŸåŠ è½½çš„</bytebuffer></p><h4 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h4><p>è¯·æ±‚çº¿ç¨‹æ± ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public ByteBuffer acquire(int size, boolean direct)</span><br></pre></td></tr></table></figure><p>sizeå¤šå¤§çš„å†…å­˜ï¼Œdirectç›´æ¥å†…å­˜è¿˜æ˜¯å †ã€‚<br>å–å¾—åˆé€‚çš„Bucket æ¯ä¸ªBucketçš„å¤§å°ä¸åŒï¼Œè¿™é‡Œæ‰¾åˆ°æœ€åˆé€‚çš„ï¼Œå–æœ€æ¥è¿‘çš„Buketå¤§å°<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bucket bucket = bucketFor(size,direct);</span><br></pre></td></tr></table></figure><p></p><p>ä»Bucketä¸­å–å¾—ByteBuffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = bucket==<span class="literal">null</span>?<span class="literal">null</span>:bucket._queue.poll();</span><br></pre></td></tr></table></figure><p>ä¸å­˜åœ¨åˆ™æ–°å»º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buffer == <span class="literal">null</span>) &#123;</span><br><span class="line">    int capacity = bucket==<span class="literal">null</span>?size:bucket._size;</span><br><span class="line">    buffer = direct ? BufferUtil.allocateDirect(capacity) : BufferUtil.allocate(capacity); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><p>ç”¨å®Œäº†é‡Šæ”¾æ‰ï¼Œè¿˜ç»™çº¿ç¨‹æ± ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> release(ByteBuffer buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer!=<span class="literal">null</span>) &#123;</span><br><span class="line">        Bucket bucket = bucketFor(buffer.capacity(),buffer.isDirect()); </span><br><span class="line">        <span class="keyword">if</span> (bucket!=<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BufferUtil.clear(buffer);</span><br><span class="line">            bucket._queue.offer(buffer); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å–å¾—åˆé€‚çš„Bucket</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bucket bucket = bucketFor(buffer.capacity(),buffer.isDirect());</span><br></pre></td></tr></table></figure><p>æ¸…ç©ºBuffer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferUtil.clear(buffer);</span><br></pre></td></tr></table></figure><p>å½’è¿˜Pool</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bucket._queue.offer(buffer);</span><br></pre></td></tr></table></figure><h4 id="ä¾‹å¤–å¤„ç†"><a href="#ä¾‹å¤–å¤„ç†" class="headerlink" title="ä¾‹å¤–å¤„ç†"></a>ä¾‹å¤–å¤„ç†</h4><p>å¦‚æœç”³è¯·çš„ByteBufferè¿‡å¤§æˆ–è€…è¿‡å°ï¼Œæ— æ³•åœ¨POOLä¸­æ»¡è¶³ï¼Œåˆ™å¯ä»¥ç”³è¯·æˆåŠŸï¼Œä½†æ— æ³•å½’è¿˜ç»™POOLã€‚<br>åŠ å…¥ç›®å‰åªæœ‰1-64kçš„bytebufferï¼Œä½†æ˜¯æˆ‘éœ€è¦120kå¤§å°çš„bytebufferï¼Œå°±éœ€è¦ç”³è¯·ã€‚<br>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„requireæ²¡æœ‰çš„è¯ä¼šåˆ›å»ºï¼Œä½†æ˜¯å› ä¸ºæ— æ³•å½’è¿˜ï¼Œæ‰€ä»¥æœ€åä¼šè¢«gc</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é€šè¿‡å­¦ä¹ ByteBufferPoolï¼Œé¦–å…ˆæ˜¯å¯¹äºæ‰€æœ‰çš„å¯¹è±¡æ± éƒ½åº”è¯¥æ— é”çš„ï¼Œå¦‚æœæœ‰é”ï¼Œè¿˜ä¸å¦‚newå‡ºæ¥ï¼Œç¬¬äºŒä¸ªå°±æ˜¯bucketï¼Œå› ä¸ºbytebufferå¤§å°æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€åšçš„ç›¸åº”çš„å¤„ç†ã€‚</p><h3 id="ç»´æŠ¤ConnectionFactory"><a href="#ç»´æŠ¤ConnectionFactory" class="headerlink" title="ç»´æŠ¤ConnectionFactory"></a>ç»´æŠ¤ConnectionFactory</h3><p>HttpConnectionFactory<br>ç”¨äºåˆ›å»ºè¿æ¥ï¼Œ æ¯”å¦‚Acceptåï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºè¿æ¥çš„å¯¹è±¡</p><h3 id="å–å¾—å¯ç”¨CPUæ•°é‡"><a href="#å–å¾—å¯ç”¨CPUæ•°é‡" class="headerlink" title="å–å¾—å¯ç”¨CPUæ•°é‡"></a>å–å¾—å¯ç”¨CPUæ•°é‡</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int cores = Runtime.getRuntime().availableProcessors();</span><br></pre></td></tr></table></figure><p>æˆ‘çš„ç³»ç»Ÿä¸­åº”è¯¥ä½¿ç”¨å¤šå°‘acceptçº¿ç¨‹ï¼Œåº”è¯¥ä½¿ç”¨å¤šå°‘ä¸ªselectorçº¿ç¨‹ï¼Œéƒ½è¦ç”±coresç®—å‡ºæ¥çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯å¯¹äºé«˜å¹¶å‘çš„ç¨‹åºæ¥è®²ï¼Œä½ å¿…é¡»è‡ªé€‚åº”cpuçš„æ•°é‡ï¼Œå¦åˆ™åœ¨2æ ¸çš„cpuä¸Šå’Œ64æ ¸çš„cpuä¸Šï¼Œå®Œå…¨æ²¡æœ‰åŠæ³•å¾ˆå¥½çš„åè°ƒï¼Œ</p><h3 id="æ›´æ–°acceptoræ•°é‡"><a href="#æ›´æ–°acceptoræ•°é‡" class="headerlink" title="æ›´æ–°acceptoræ•°é‡"></a>æ›´æ–°acceptoræ•°é‡</h3><p>æ ¹æ®cpuçš„æ•°é‡æ›´æ–°acceptoræ•°é‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (acceptors &lt; <span class="number">0</span>)</span><br><span class="line">acceptors=<span class="built_in">Math</span>.max(<span class="number">1</span>, <span class="built_in">Math</span>.min(<span class="number">4</span>,cores/<span class="number">8</span>));</span><br></pre></td></tr></table></figure><p>å®ƒè®¤ä¸ºacceptçš„æ•°é‡åº”è¯¥æ˜¯æ¯”è¾ƒå°çš„ï¼Œä¸Šé¢å¯ä»¥å‘ç°ä¸ä¼šè¶…è¿‡å››ä¸ªã€‚</p><h3 id="åˆ›å»ºacceptorçº¿ç¨‹ç»„"><a href="#åˆ›å»ºacceptorçº¿ç¨‹ç»„" class="headerlink" title="åˆ›å»ºacceptorçº¿ç¨‹ç»„"></a>åˆ›å»ºacceptorçº¿ç¨‹ç»„</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_acceptors = <span class="keyword">new</span> Thread[acceptors];</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–ServerConnectorManager"><a href="#åˆå§‹åŒ–ServerConnectorManager" class="headerlink" title="åˆå§‹åŒ–ServerConnectorManager"></a>åˆå§‹åŒ–ServerConnectorManager</h3><p>ç»§æ‰¿è‡ª SelectorManager</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_manager = <span class="keyword">new</span> ServerConnectorManager(getExecutor(), getScheduler(), selectors&gt;<span class="number">0</span>?selectors:<span class="built_in">Math</span>.max(<span class="number">1</span>,<span class="built_in">Math</span>.min(<span class="number">4</span>,Runtime.getRuntime().availableProcessors()/<span class="number">2</span>)));</span><br></pre></td></tr></table></figure><h4 id="ä¿å­˜selectorçº¿ç¨‹æ•°é‡"><a href="#ä¿å­˜selectorçº¿ç¨‹æ•°é‡" class="headerlink" title="ä¿å­˜selectorçº¿ç¨‹æ•°é‡"></a>ä¿å­˜selectorçº¿ç¨‹æ•°é‡</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Math</span>.min(<span class="number">4</span>,Runtime.getRuntime().availableProcessors()/<span class="number">2</span>))</span><br></pre></td></tr></table></figure><p>æœ€å¤šä¹Ÿä¸è¶…è¿‡å››ä¸ª</p><h2 id="è®¾ç½®port"><a href="#è®¾ç½®port" class="headerlink" title="è®¾ç½®port"></a>è®¾ç½®port</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connector.setPort(port);</span><br></pre></td></tr></table></figure><h2 id="å…³è”Severå’ŒConnector"><a href="#å…³è”Severå’ŒConnector" class="headerlink" title="å…³è”Severå’ŒConnector"></a>å…³è”Severå’ŒConnector</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setConnectors(<span class="keyword">new</span> Connector[]&#123;connector&#125;);</span><br></pre></td></tr></table></figure><h1 id="Server-start"><a href="#Server-start" class="headerlink" title="Server.start()"></a>Server.start()</h1><p>org.eclipse.jetty.server.Server<br>å¯åŠ¨webæœåŠ¡å™¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WebAppContext context = <span class="keyword">new</span> WebAppContext();</span><br><span class="line">context.setContextPath(<span class="string">"/"</span>);</span><br><span class="line">context.setResourceBase(<span class="string">"./web/"</span>); context.setClassLoader(Thread.currentThread().getContextClassLoader()); server.setHandler(context);</span><br><span class="line">server.start();</span><br></pre></td></tr></table></figure><h2 id="è®¾ç½®å¯åŠ¨çŠ¶æ€"><a href="#è®¾ç½®å¯åŠ¨çŠ¶æ€" class="headerlink" title="è®¾ç½®å¯åŠ¨çŠ¶æ€"></a>è®¾ç½®å¯åŠ¨çŠ¶æ€</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AbstractLifeCycle</span><br><span class="line">private <span class="keyword">void</span> setStarting() &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) LOG.debug(<span class="string">"starting &#123;&#125;"</span>,<span class="keyword">this</span>);</span><br><span class="line">    _state = __STARTING;</span><br><span class="line">    <span class="keyword">for</span> (Listener listener : _listeners)</span><br><span class="line">    listener.lifeCycleStarting(<span class="keyword">this</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨è¿‡ç¨‹doStart"><a href="#å¯åŠ¨è¿‡ç¨‹doStart" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹doStart()"></a>å¯åŠ¨è¿‡ç¨‹doStart()</h2><p>Server<br>å¯åŠ¨æ•´ä¸ªserver</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">void</span> doStart() throws Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//If the Server should be stopped when the jvm exits, register //with the shutdown handler thread.</span></span><br><span class="line">    <span class="keyword">if</span> (getStopAtShutdown())</span><br><span class="line">        ShutdownThread.register(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//Register the Server with the handler thread for receiving //remote stop commands</span></span><br><span class="line">    ShutdownMonitor.register(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//Start a thread waiting to receive "stop" commands. ShutdownMonitor.getInstance().start(); // initialize</span></span><br><span class="line">    LOG.info(<span class="string">"jetty-"</span> + getVersion()); HttpGenerator.setJettyVersion(HttpConfiguration.SERVER_VERSION); MultiException mex=<span class="keyword">new</span> MultiException();</span><br><span class="line">    <span class="comment">// check size of thread pool</span></span><br><span class="line">    SizedThreadPool pool = getBean(SizedThreadPool.class); int max=pool==<span class="literal">null</span>?<span class="number">-1</span>:pool.getMaxThreads();</span><br><span class="line">    int selectors=<span class="number">0</span>;</span><br><span class="line">    int acceptors=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mex.size()==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector : _connectors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connector <span class="keyword">instanceof</span> AbstractConnector) acceptors+=((AbstractConnector)connector).getAcceptors();</span><br><span class="line">            <span class="keyword">if</span> (connector <span class="keyword">instanceof</span> ServerConnector) selectors+=((ServerConnector)connector).getSelectorManager().getSelectorCount();</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    int needed=<span class="number">1</span>+selectors+acceptors; <span class="keyword">if</span> (max&gt;<span class="number">0</span> &amp;&amp; needed&gt;max)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="built_in">String</span>.format(<span class="string">"Insufficient threads: max=%d &lt; needed(acceptors=%d + selectors=%d + request=1)"</span>,max,acceptors,selectors));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">super</span>.doStart();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">        mex.add(e); &#125;</span><br><span class="line">    <span class="comment">// start connectors last</span></span><br><span class="line">    <span class="keyword">for</span> (Connector connector : _connectors) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connector.start(); </span><br><span class="line">            &#125;<span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">                mex.add(e); </span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isDumpAfterStart()) dumpStdErr();</span><br><span class="line">    mex.ifExceptionThrow();</span><br><span class="line">    LOG.info(<span class="built_in">String</span>.format(<span class="string">"Started @%dms"</span>,Uptime.getUptime())); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨å†ŒShutdownMonitor"><a href="#æ³¨å†ŒShutdownMonitor" class="headerlink" title="æ³¨å†ŒShutdownMonitor"></a>æ³¨å†ŒShutdownMonitor</h3><p>è¿œç¨‹æ§åˆ¶æ¥å£</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Register the Server with the handler thread for receiving //remote stop commands</span></span><br><span class="line">ShutdownMonitor.register(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//Start a thread waiting to receive "stop" commands. ShutdownMonitor.getInstance().start(); // initialize</span></span><br></pre></td></tr></table></figure><p>å…è®¸è¿œç¨‹çš„å°†jettyçš„serverå…³æ‰ã€‚</p><h3 id="è·å–åŒ–çº¿ç¨‹æ± "><a href="#è·å–åŒ–çº¿ç¨‹æ± " class="headerlink" title="è·å–åŒ–çº¿ç¨‹æ± "></a>è·å–åŒ–çº¿ç¨‹æ± </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check size of thread pool</span></span><br><span class="line">SizedThreadPool pool = getBean(SizedThreadPool.class);</span><br></pre></td></tr></table></figure><p>QueuedThreadPool</p><h3 id="è®¾ç½®selectoræ•°é‡"><a href="#è®¾ç½®selectoræ•°é‡" class="headerlink" title="è®¾ç½®selectoræ•°é‡"></a>è®¾ç½®selectoræ•°é‡</h3><p>æ ¹æ®Connectoræ•°é‡è¿›è¡Œç´¯è®¡ å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªServerConnectorï¼Œå› ä¸ºæ¯ä¸ªconnectoréƒ½æœ‰selector</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Connector connector : _connectors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (connector <span class="keyword">instanceof</span> AbstractConnector) acceptors+=((AbstractConnector)connector).getAcceptors();</span><br><span class="line">    <span class="keyword">if</span> (connector <span class="keyword">instanceof</span> ServerConnector) selectors+=((ServerConnector)connector).getSelectorManager().getSelectorCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç´¯è®¡æ‰€æœ‰Connectorçš„éœ€æ±‚</p><h3 id="è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰çº¿ç¨‹æ•°é‡"><a href="#è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰çº¿ç¨‹æ•°é‡" class="headerlink" title="è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰çº¿ç¨‹æ•°é‡"></a>è®¡ç®—æ‰€éœ€çš„æ‰€æœ‰çº¿ç¨‹æ•°é‡</h3><p>int needed=1+selectors+acceptors;</p><h4 id="å¦‚æœå¤§äºé»˜è®¤çš„200åˆ™ä¸­æ–­ç¨‹åº"><a href="#å¦‚æœå¤§äºé»˜è®¤çš„200åˆ™ä¸­æ–­ç¨‹åº" class="headerlink" title="å¦‚æœå¤§äºé»˜è®¤çš„200åˆ™ä¸­æ–­ç¨‹åº"></a>å¦‚æœå¤§äºé»˜è®¤çš„200åˆ™ä¸­æ–­ç¨‹åº</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (max&gt;<span class="number">0</span> &amp;&amp; needed&gt;max)</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="built_in">String</span>.format(<span class="string">"Insufficient threads: max=%d &lt; needed(acceptors=%d</span></span><br><span class="line"><span class="string">+ selectors=%d + request=1)"</span>,max,acceptors,selectors));</span><br></pre></td></tr></table></figure><p>å› ä¸ºå¦‚æœå…‰acceptå’Œselectorçº¿ç¨‹éƒ½è¶…è¿‡200è¯´æ˜æ€§èƒ½å¾ˆå·®äº†ï¼Œæ²¡æœ‰å¿…è¦å†ç»§ç»­å¾€ä¸‹è·‘äº†ã€‚</p><h3 id="ç»´æŠ¤Bean"><a href="#ç»´æŠ¤Bean" class="headerlink" title="ç»´æŠ¤Bean"></a>ç»´æŠ¤Bean</h3><h4 id="å¯åŠ¨QueuedThreadPool"><a href="#å¯åŠ¨QueuedThreadPool" class="headerlink" title="å¯åŠ¨QueuedThreadPool"></a>å¯åŠ¨QueuedThreadPool</h4><p>doStart()<br>startThreads()å»ºç«‹éœ€è¦çš„çº¿ç¨‹</p><h4 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h4><p>Thread thread = newThread(_runnable);<br>_runnable _jobsä¸­å–ä»»åŠ¡å¹¶æ‰§è¡Œ</p><h5 id="è®¾ç½®çº¿ç¨‹çš„å±æ€§"><a href="#è®¾ç½®çº¿ç¨‹çš„å±æ€§" class="headerlink" title="è®¾ç½®çº¿ç¨‹çš„å±æ€§"></a>è®¾ç½®çº¿ç¨‹çš„å±æ€§</h5><p>thread.setDaemon(isDaemon()); thread.setPriority(getThreadsPriority()); thread.setName(_name + â€œ-â€œ + thread.getId()); _threads.add(thread);</p><h5 id="å¯åŠ¨çº¿ç¨‹-thread-start"><a href="#å¯åŠ¨çº¿ç¨‹-thread-start" class="headerlink" title="å¯åŠ¨çº¿ç¨‹ thread.start();"></a>å¯åŠ¨çº¿ç¨‹ thread.start();</h5><h4 id="å¯åŠ¨WebAppContext"><a href="#å¯åŠ¨WebAppContext" class="headerlink" title="å¯åŠ¨WebAppContext"></a>å¯åŠ¨WebAppContext</h4><p>å¦‚æœéœ€è¦ä½¿ç”¨ï¼Œåœ¨æ­¤å¤„å¯åŠ¨ï¼Œå»åšservletè§„èŒƒæ‰€åšçš„å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ã€‚</p><h3 id="å¯åŠ¨Connector"><a href="#å¯åŠ¨Connector" class="headerlink" title="å¯åŠ¨Connector"></a>å¯åŠ¨Connector</h3><h4 id="å–å¾—ConnectionFactory"><a href="#å–å¾—ConnectionFactory" class="headerlink" title="å–å¾—ConnectionFactory"></a>å–å¾—ConnectionFactory</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_defaultConnectionFactory = getConnectionFactory(_defaultProtocol);</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºselectorçº¿ç¨‹å¹¶å¯åŠ¨"><a href="#åˆ›å»ºselectorçº¿ç¨‹å¹¶å¯åŠ¨" class="headerlink" title="åˆ›å»ºselectorçº¿ç¨‹å¹¶å¯åŠ¨"></a>åˆ›å»ºselectorçº¿ç¨‹å¹¶å¯åŠ¨</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _selectors.length; i++) &#123;</span><br><span class="line">    ManagedSelector selector = newSelector(i); _selectors[i] = selector;</span><br><span class="line">    selector.start();</span><br><span class="line">    execute(<span class="keyword">new</span> NonBlockingThread(selector));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>newSelector()</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected ManagedSelector newSelector(int id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ManagedSelector(id); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºAcceptorçº¿ç¨‹"><a href="#åˆ›å»ºAcceptorçº¿ç¨‹" class="headerlink" title="åˆ›å»ºAcceptorçº¿ç¨‹"></a>åˆ›å»ºAcceptorçº¿ç¨‹</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå‡ ä¸ªacceptçº¿ç¨‹</span></span><br><span class="line">_stopping=<span class="keyword">new</span> CountDownLatch(_acceptors.length); </span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; _acceptors.length; i++)</span><br><span class="line">&#123;</span><br><span class="line">    Acceptor a = <span class="keyword">new</span> Acceptor(i); </span><br><span class="line">    addBean(a); </span><br><span class="line">    <span class="comment">//æ‰§è¡Œ</span></span><br><span class="line">    getExecutor().execute(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Acceptor</p><h5 id="è®¾ç½®çº¿ç¨‹åå­—"><a href="#è®¾ç½®çº¿ç¨‹åå­—" class="headerlink" title="è®¾ç½®çº¿ç¨‹åå­—"></a>è®¾ç½®çº¿ç¨‹åå­—</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">final Thread thread = Thread.currentThread(); </span><br><span class="line"><span class="built_in">String</span> name=thread.getName(); </span><br><span class="line">_name=<span class="built_in">String</span>.format(<span class="string">"%s-acceptor-%d@%x-</span></span><br><span class="line"><span class="string">%s"</span>,name,_acceptor,hashCode(),AbstractConnector.this.toString()); thread.setName(_name);</span><br></pre></td></tr></table></figure><h5 id="è®¾ç½®ä¼˜å…ˆçº§"><a href="#è®¾ç½®ä¼˜å…ˆçº§" class="headerlink" title="è®¾ç½®ä¼˜å…ˆçº§"></a>è®¾ç½®ä¼˜å…ˆçº§</h5><h5 id="å°†è‡ªå·±æ”¾å…¥-acceptorsæ•°ç»„"><a href="#å°†è‡ªå·±æ”¾å…¥-acceptorsæ•°ç»„" class="headerlink" title="å°†è‡ªå·±æ”¾å…¥_acceptorsæ•°ç»„"></a>å°†è‡ªå·±æ”¾å…¥_acceptorsæ•°ç»„</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">synchronized (AbstractConnector.this) &#123;</span><br><span class="line">    _acceptors[_acceptor] = thread; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ç›‘å¬ç«¯å£"><a href="#ç›‘å¬ç«¯å£" class="headerlink" title="ç›‘å¬ç«¯å£"></a>ç›‘å¬ç«¯å£</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (isAccepting()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            accept(_acceptor); &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAccepting())</span><br><span class="line">        LOG.warn(e);</span><br><span class="line">        <span class="keyword">else</span> LOG.ignore(e);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    thread.setName(name);</span><br><span class="line">    <span class="keyword">if</span> (_acceptorPriorityDelta!=<span class="number">0</span>) thread.setPriority(priority);</span><br><span class="line">    synchronized (AbstractConnector.this) &#123;</span><br><span class="line">        _acceptors[_acceptor] = <span class="literal">null</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    CountDownLatch stopping=_stopping; </span><br><span class="line">    <span class="keyword">if</span> (stopping!=<span class="literal">null</span>)</span><br><span class="line">    stopping.countDown(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerConnector.accept()<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> accept(int acceptorID) throws IOException &#123;</span><br><span class="line">ServerSocketChannel serverChannel = _acceptChannel; <span class="keyword">if</span> (serverChannel != <span class="literal">null</span> &amp;&amp; serverChannel.isOpen()) &#123;</span><br><span class="line">    SocketChannel channel =serverChannel.accept();</span><br><span class="line">    accepted(channel); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨acceptçš„åœ°æ–¹ç­‰å¾…</p><h4 id="æ²¡æœ‰Acceptorçš„æƒ…å†µ"><a href="#æ²¡æœ‰Acceptorçš„æƒ…å†µ" class="headerlink" title="æ²¡æœ‰Acceptorçš„æƒ…å†µ"></a>æ²¡æœ‰Acceptorçš„æƒ…å†µ</h4><p>channleé»˜è®¤æ˜¯blockingçš„<br>å¦‚æœacceptoræ•°é‡ä¸º0ï¼Œæ²¡æœ‰å®‰æ’çº¿ç¨‹ä¸“é—¨è¿›è¡Œacceptï¼Œåˆ™è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ è‹¥æ˜¯é0ï¼Œæœ‰ä¸“é—¨çº¿ç¨‹è¿›è¡Œacceptï¼Œå› æ­¤ï¼Œä¸ºé˜»å¡æ¨¡å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">void</span> doStart() throws Exception &#123;</span><br><span class="line">    <span class="keyword">super</span>.doStart();</span><br><span class="line">    <span class="keyword">if</span> (getAcceptors()==<span class="number">0</span>) &#123;</span><br><span class="line">        _acceptChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        _manager.acceptor(_acceptChannel); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨å®Œæ¯•"><a href="#å¯åŠ¨å®Œæ¯•" class="headerlink" title="å¯åŠ¨å®Œæ¯•"></a>å¯åŠ¨å®Œæ¯•</h2><h1 id="Httpè¯·æ±‚"><a href="#Httpè¯·æ±‚" class="headerlink" title="Httpè¯·æ±‚"></a>Httpè¯·æ±‚</h1><h2 id="AcceptæˆåŠŸ"><a href="#AcceptæˆåŠŸ" class="headerlink" title="AcceptæˆåŠŸ"></a>AcceptæˆåŠŸ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">void</span> accepted(SocketChannel channel) throws IOException &#123;</span><br><span class="line">    channel.configureBlocking(<span class="literal">false</span>); </span><br><span class="line">    Socket socket = channel.socket(); </span><br><span class="line">    configure(socket); </span><br><span class="line">    _manager.accept(channel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼"><a href="#è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼" class="headerlink" title="è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼"></a>è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.configureBlocking(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure><h3 id="é…ç½®Socket"><a href="#é…ç½®Socket" class="headerlink" title="é…ç½®Socket"></a>é…ç½®Socket</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Socket socket = channel.socket();</span><br><span class="line">configure(socket);</span><br></pre></td></tr></table></figure><h3 id="æ­£å¼å¤„ç†"><a href="#æ­£å¼å¤„ç†" class="headerlink" title="æ­£å¼å¤„ç†"></a>æ­£å¼å¤„ç†</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SelectorManager _manager;</span><br><span class="line">_manager.accept(channel);</span><br></pre></td></tr></table></figure><h4 id="é€‰æ‹©å¯ç”¨çš„ManagedSelectorçº¿ç¨‹"><a href="#é€‰æ‹©å¯ç”¨çš„ManagedSelectorçº¿ç¨‹" class="headerlink" title="é€‰æ‹©å¯ç”¨çš„ManagedSelectorçº¿ç¨‹"></a>é€‰æ‹©å¯ç”¨çš„ManagedSelectorçº¿ç¨‹</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private ManagedSelector chooseSelector() &#123;</span><br><span class="line">  <span class="comment">//The ++ increment here not atomic, but does not matter,</span></span><br><span class="line"><span class="comment">// so long as the value chages sometimes,then connections will</span></span><br><span class="line"><span class="comment">//be distributed over the available selectors</span></span><br><span class="line">    long s = _selectorIndex++;</span><br><span class="line">    int index = (int)(s % getSelectorCount());</span><br><span class="line">    <span class="keyword">return</span> _selectors[index]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æ³¨é‡Šï¼Œ++å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œä½†æ˜¯ä¸å½±å“ï¼Œå› ä¸ºè¿™é‡Œåªéœ€è¦++å°±å¯ä»¥äº†ï¼Œå¹¶ä¸éœ€è¦æ¯æ¬¡çš„æ•°å­—æœä¸ä¸€æ ·ã€‚</p><h4 id="ManagedSelectorå¤„ç†"><a href="#ManagedSelectorå¤„ç†" class="headerlink" title="ManagedSelectorå¤„ç†"></a>ManagedSelectorå¤„ç†</h4><p>ManagedSelector æ˜¯ä¸€ä¸ªçº¿ç¨‹ å°è£…äº†Selector çš„ä½¿ç”¨</p><h5 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a>æäº¤ä»»åŠ¡</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">selector.submit(selector.new Accept(channel, attachment));</span><br></pre></td></tr></table></figure><p>æäº¤è¿™ä¸ªå¤„ç†ä»»åŠ¡åˆ°ManagedSelector:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private final Queue&lt;Runnable&gt; _changes = <span class="keyword">new</span> ConcurrentArrayQueue&lt;&gt;(); _changes.offer(change);</span><br></pre></td></tr></table></figure><p>ä»»åŠ¡æäº¤åˆ°äº†_chagesè¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼ŒConcurrentArrayQueueè¿™ä¸ªé˜Ÿåˆ—æ˜¯jettyä¸­è‡ªå·±å®ç°çš„ã€‚<br>ConcurrentArrayQueue<br>ä¸ConcurrentLinkedQueueç›¸ä¼¼çš„æ€§èƒ½ï¼Œä½†ç›´æ¥ä¿å­˜å…ƒç´  è€Œä¸æ˜¯nodeï¼Œå› æ­¤éœ€è¦æ›´å°‘çš„å¯¹è±¡ï¼Œæ›´å°‘çš„GC<br>å› ä¸ºConcurrentLinkedQueueæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€ä»¥è¦æœ‰nodeï¼Œå¹¶ä¸”æŒ‡å‘ä¸‹ä¸€ä¸ªnodeï¼Œè€ŒConcurrentArrayQueueä¸æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€ä»¥éœ€è¦æ›´å°‘çš„å¯¹è±¡ï¼Œæ›´å°‘çš„GC</p><h2 id="è¯·æ±‚å¤„ç†"><a href="#è¯·æ±‚å¤„ç†" class="headerlink" title="è¯·æ±‚å¤„ç†"></a>è¯·æ±‚å¤„ç†</h2><h3 id="ManagedSelector-run"><a href="#ManagedSelector-run" class="headerlink" title="ManagedSelector.run()"></a>ManagedSelector.run()</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (isRunning()) </span><br><span class="line">    select();</span><br></pre></td></tr></table></figure><h4 id="select"><a href="#select" class="headerlink" title="select()"></a>select()</h4><p>å‘ç°æœ‰ä»»åŠ¡å°±æ‰§è¡Œ</p><h5 id="runChanges"><a href="#runChanges" class="headerlink" title="runChanges();"></a>runChanges();</h5><p>å‚è§: æäº¤ä»»åŠ¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    private <span class="keyword">void</span> runChanges() &#123;</span><br><span class="line">    Runnable change;</span><br><span class="line">    <span class="keyword">while</span> ((change = _changes.poll()) != <span class="literal">null</span>)</span><br><span class="line">        runChange(change); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†_changesä¸­çš„ä»»åŠ¡æ‹¿å‡ºæ¥åšæ‰§è¡Œã€‚<br>runChange()<br>change.run();</p><p>Accept.run</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey key = channel.register(_selector, <span class="number">0</span>, attachment); </span><br><span class="line">EndPoint endpoint = createEndPoint(channel, key); </span><br><span class="line">key.attach(endpoint);</span><br></pre></td></tr></table></figure><p>æ³¨å†Œselectorå¹¶å°†endpointä¼ ç»™åé¢ã€‚</p><h5 id="select-1"><a href="#select-1" class="headerlink" title="select()"></a>select()</h5><p>runChangeså®è´¨ä¸Šæ˜¯å°†selectorå’Œchannelè¿æ¥åˆ°ä¸€èµ·ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç­‰å¾…readæˆ–è€…writeå‡†å¤‡å¥½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int selected = _selector.select();</span><br></pre></td></tr></table></figure><h5 id="å¤„ç†SelectionKey"><a href="#å¤„ç†SelectionKey" class="headerlink" title="å¤„ç†SelectionKey"></a>å¤„ç†SelectionKey</h5><p>å½“å‘ç°ä»»ä½•ä¸€ä¸ªselectorå¯ç”¨çš„æ—¶å€™å°±ä¼šå¤„ç†SelectionKey</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>&lt;SelectionKey&gt; selectedKeys = _selector.selectedKeys(); <span class="keyword">for</span> (SelectionKey key : selectedKeys)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (key.isValid()) &#123;</span><br><span class="line">        processKey(key); </span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (debug)</span><br><span class="line">        LOG.debug(<span class="string">"Selector loop ignoring invalid key for channel &#123;&#125;"</span>, key.channel());</span><br><span class="line">        <span class="built_in">Object</span> attachment = key.attachment(); </span><br><span class="line">        <span class="keyword">if</span> (attachment <span class="keyword">instanceof</span> EndPoint)</span><br><span class="line">        ((EndPoint)attachment).close(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">selectedKeys.clear();</span><br></pre></td></tr></table></figure><p>processKey()</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">void</span> processKey(SelectionKey key) &#123;</span><br><span class="line">    <span class="built_in">Object</span> attachment = key.attachment(); <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (attachment <span class="keyword">instanceof</span> SelectableEndPoint) &#123;</span><br><span class="line">        ((SelectableEndPoint)attachment).onSelected(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (key.isConnectable()) &#123;</span><br><span class="line">        processConnect(key, (Connect)attachment); </span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (key.isAcceptable())</span><br><span class="line">    &#123;</span><br><span class="line">        processAccept(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (CancelledKeyException x) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Ignoring cancelled key for channel &#123;&#125;"</span>, key.channel()); </span><br><span class="line">        <span class="keyword">if</span> (attachment <span class="keyword">instanceof</span> EndPoint)</span><br><span class="line">        closeNoExceptions((EndPoint)attachment); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">        LOG.warn(<span class="string">"Could not process key for channel "</span> + key.channel(), x); </span><br><span class="line">        <span class="keyword">if</span> (attachment <span class="keyword">instanceof</span> EndPoint)</span><br><span class="line">        closeNoExceptions((EndPoint)attachment); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onSelected()<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> onSelected() &#123;</span><br><span class="line">    assert _selector.isSelectorThread();</span><br><span class="line">    int oldInterestOps = _key.interestOps();</span><br><span class="line">    int readyOps = _key.readyOps();</span><br><span class="line">    int newInterestOps = oldInterestOps &amp; ~readyOps; setKeyInterests(oldInterestOps, newInterestOps); </span><br><span class="line">    updateLocalInterests(readyOps, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (_key.isReadable())</span><br><span class="line">    getFillInterest().fillable(); <span class="keyword">if</span> (_key.isWritable())</span><br><span class="line">    getWriteFlusher().completeWrite(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¼šä½¿ç”¨æ–°çš„çº¿ç¨‹è¿›è¡ŒHTTPä¸šåŠ¡å¤„ç† (æäº¤åˆ°çº¿ç¨‹æ± )</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;æœ¬æ¬¡ç¬”è®°æ˜¯å¯¹jettyï¼Œä¸€ä¸ªservletå®¹å™¨ï¼Œä¸€ä¸ªhttpServer,å†…éƒ¨çš„å®ç°ï¼Œå› ä¸ºä»£ç é‡é‡æ¯”è¾ƒå¤šï¼Œä¸ä¼šä»æ¶æ„çš„æ–¹å‘ä»‹
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆåï¼‰ï¼šå¹¶å‘è°ƒè¯•å’ŒJDK8æ–°ç‰¹æ€§</title>
    <link href="http://mmmmmm.me/2019-02-21.html"/>
    <id>http://mmmmmm.me/2019-02-21.html</id>
    <published>2019-02-21T02:20:02.000Z</published>
    <updated>2019-02-23T09:08:38.508Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•"><a href="#å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•" class="headerlink" title="å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•"></a>å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•</h1><h2 id="ä½¿ç”¨Eclipseè¿›è¡Œå¤šçº¿ç¨‹è°ƒè¯•"><a href="#ä½¿ç”¨Eclipseè¿›è¡Œå¤šçº¿ç¨‹è°ƒè¯•" class="headerlink" title="ä½¿ç”¨Eclipseè¿›è¡Œå¤šçº¿ç¨‹è°ƒè¯•"></a>ä½¿ç”¨Eclipseè¿›è¡Œå¤šçº¿ç¨‹è°ƒè¯•</h2><p>çœ‹å¦‚ä¸‹ä¸€æ®µä»£ç ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UnsafeArrayList</span> </span>&#123;</span><br><span class="line"><span class="keyword">static</span> ArrayList al=<span class="keyword">new</span> ArrayList();</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddTask</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++) </span><br><span class="line">al.add(<span class="keyword">new</span> <span class="built_in">Object</span>());</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123; </span><br><span class="line">Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> AddTask(),<span class="string">"t1"</span>);</span><br><span class="line">Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> AddTask(),<span class="string">"t2"</span>);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line">Thread t3=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>); </span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;,<span class="string">"t3"</span>);</span><br><span class="line">t3.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br><img alt="" data-original="/images/15507583046171.png">))</p><p>æŠŠæ–­ç‚¹æ‰“åˆ°ArrayListçš„addæ–¹æ³•å¤„ï¼Œå‘ç°è¿˜æ˜¯åœ¨classLoaderå±‚é¢ä¸Šçš„ï¼Œå¹¶æ²¡æœ‰åˆ°è¾¾æˆ‘ä»¬çš„åº”ç”¨å±‚çš„å®ç°ã€‚</p><p><img alt="" data-original="/images/15507583180697.png"><br>ä¸Šé¢çš„æ¡ä»¶æ–­ç‚¹åªæœ‰å½“ä¸æ˜¯ä¸»çº¿ç¨‹çš„æ—¶å€™æ‰ä¼šç”Ÿæ•ˆï¼Œé€šè¿‡ä¸Šé¢çš„ç¨‹åºä¸éš¾çœ‹å‡ºï¼Œæ•´ä¸ªåº”ç”¨å±‚é¢å’Œä¸»çº¿ç¨‹å¹¶æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œä¸»è¦å’Œçº¿ç¨‹t1 t2æœ‰å…³ç³»</p><p><img alt="" data-original="/images/15507583423100.png"><br><img alt="" data-original="/images/15507583487268.png"><br><img alt="" data-original="/images/15507583554360.png"></p><p>é€šè¿‡æ‰“æ–­ç‚¹çš„æ–¹å¼å¤ç°é—®é¢˜å‘ç°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">       ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">       elementData[size++] = e;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æ˜¯åœ¨ensureCapacityInternal(size + 1);è¿™è¡Œå‡ºç°äº†é—®é¢˜ï¼Œt1ä¸­sizeå˜æˆäº†9ï¼Œt2size++ï¼Œè¿™ä¸ªæ—¶å€™t1å¹¶ä¸çŸ¥æƒ…ï¼Œå¯¼è‡´sizeä¸ä¸€è‡´ï¼ŒÂ·8å¯¼è‡´æŠ¥é”™ã€‚</p><h1 id="çº¿ç¨‹dumpåŠåˆ†æ"><a href="#çº¿ç¨‹dumpåŠåˆ†æ" class="headerlink" title="çº¿ç¨‹dumpåŠåˆ†æ"></a>çº¿ç¨‹dumpåŠåˆ†æ</h1><p>jstack 3992 å¯ä»¥å¯¼å‡ºå½“å‰è™šæ‹Ÿæœºæ‰€æœ‰è¿è¡Œçš„çº¿ç¨‹ã€‚<br>åœ¨%JAVA_HOME%/binç›®å½•ä¸‹é¢ï¼ˆjstack 3992 ï¼‰</p><h2 id="åˆ†ææ­»é”æ¡ˆä¾‹"><a href="#åˆ†ææ­»é”æ¡ˆä¾‹" class="headerlink" title="åˆ†ææ­»é”æ¡ˆä¾‹"></a>åˆ†ææ­»é”æ¡ˆä¾‹</h2><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>ä»£ç ç®€ä»‹ï¼šä¸œè¥¿å—åŒ—å››ä¸ªå°è½¦å½¢æˆçš„æ­»é”<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DeadLock</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">protected <span class="built_in">Object</span> myDirect;</span><br><span class="line"><span class="keyword">static</span> ReentrantLock south = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">static</span> ReentrantLock north = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">static</span> ReentrantLock west = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="keyword">static</span> ReentrantLock east = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">public DeadLock(<span class="built_in">Object</span> obj)&#123;</span><br><span class="line"><span class="keyword">this</span>.myDirect = obj;</span><br><span class="line"><span class="keyword">if</span> (myDirect == south) &#123;</span><br><span class="line"><span class="keyword">this</span>.setName(<span class="string">"south"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == north) &#123;</span><br><span class="line"><span class="keyword">this</span>.setName(<span class="string">"north"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == west) &#123;</span><br><span class="line"><span class="keyword">this</span>.setName(<span class="string">"west"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == east) &#123;</span><br><span class="line"><span class="keyword">this</span>.setName(<span class="string">"east"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">if</span> (myDirect == south) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">west.lockInterruptibly();</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">south.lockInterruptibly();</span><br><span class="line">System.out.println(<span class="string">"car to south has passed"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">System.out.println(<span class="string">"car to south is killed"</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (west.isHeldByCurrentThread())</span><br><span class="line">west.unlock();</span><br><span class="line"><span class="keyword">if</span> (south.isHeldByCurrentThread())</span><br><span class="line">south.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == north) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">east.lockInterruptibly();</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">north.lockInterruptibly();</span><br><span class="line">System.out.println(<span class="string">"car to south has passed"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">System.out.println(<span class="string">"car to south is killed"</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (east.isHeldByCurrentThread())</span><br><span class="line">east.unlock();</span><br><span class="line"><span class="keyword">if</span> (north.isHeldByCurrentThread())</span><br><span class="line">north.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == west) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">north.lockInterruptibly();</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">west.lockInterruptibly();</span><br><span class="line">System.out.println(<span class="string">"car to south has passed"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">System.out.println(<span class="string">"car to south is killed"</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (north.isHeldByCurrentThread())</span><br><span class="line">north.unlock();</span><br><span class="line"><span class="keyword">if</span> (west.isHeldByCurrentThread())</span><br><span class="line">west.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (myDirect == east) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">south.lockInterruptibly();</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">east.lockInterruptibly();</span><br><span class="line">System.out.println(<span class="string">"car to south has passed"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">System.out.println(<span class="string">"car to south is killed"</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (south.isHeldByCurrentThread())</span><br><span class="line">south.unlock();</span><br><span class="line"><span class="keyword">if</span> (east.isHeldByCurrentThread())</span><br><span class="line">east.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">DeadLock car2South = <span class="keyword">new</span> DeadLock(south);</span><br><span class="line">DeadLock car2North = <span class="keyword">new</span> DeadLock(north);</span><br><span class="line">DeadLock car2West = <span class="keyword">new</span> DeadLock(west);</span><br><span class="line">DeadLock car2East = <span class="keyword">new</span> DeadLock(east);</span><br><span class="line">car2South.start();</span><br><span class="line">car2East.start();</span><br><span class="line">car2North.start();</span><br><span class="line">car2West.start();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»€ä¹ˆä¹Ÿæ²¡æœ‰è¾“å‡ºï¼Œç¨‹åºè¿˜åœ¨ä¸æ–­çš„è¿è¡Œç€ã€‚</p><h3 id="jstackè°ƒè¯•"><a href="#jstackè°ƒè¯•" class="headerlink" title="jstackè°ƒè¯•"></a>jstackè°ƒè¯•</h3><h4 id="jpså‘½ä»¤æ‰¾åˆ°å½“å‰è¿™ä¸ªjavaçš„è¿›ç¨‹å·"><a href="#jpså‘½ä»¤æ‰¾åˆ°å½“å‰è¿™ä¸ªjavaçš„è¿›ç¨‹å·" class="headerlink" title="jpså‘½ä»¤æ‰¾åˆ°å½“å‰è¿™ä¸ªjavaçš„è¿›ç¨‹å·"></a>jpså‘½ä»¤æ‰¾åˆ°å½“å‰è¿™ä¸ªjavaçš„è¿›ç¨‹å·</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ jps</span><br><span class="line"><span class="number">1682</span> Launcher</span><br><span class="line"><span class="number">1714</span> Jps</span><br><span class="line"><span class="number">1683</span> DeadLock</span><br><span class="line"><span class="number">1397</span> RemoteMavenServer</span><br><span class="line"><span class="number">1370</span></span><br></pre></td></tr></table></figure><h4 id="è¿è¡Œjstackå‘½ä»¤"><a href="#è¿è¡Œjstackå‘½ä»¤" class="headerlink" title="è¿è¡Œjstackå‘½ä»¤"></a>è¿è¡Œjstackå‘½ä»¤</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack <span class="number">1683</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack -h</span><br></pre></td></tr></table></figure><p>å‘ç°-lå‚æ•°å¯ä»¥çœ‹åˆ°æ›´å¤šçš„å‚æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack -l <span class="number">1683</span></span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">"west" #12 prio=5 os_prio=31 tid=0x00007ff6cc062000 nid=0x3d03 waiting on condition [0x0000700006ab7000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0x000000079578bda8</span>&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:<span class="number">175</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:<span class="number">836</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">897</span>)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:<span class="number">1222</span>)</span><br><span class="line">at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:<span class="number">335</span>)</span><br><span class="line">at DeadLock.run(DeadLock.java:<span class="number">65</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- <span class="xml"><span class="tag">&lt;<span class="name">0x000000079578bd78</span>&gt;</span> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">"north" #11 prio=5 os_prio=31 tid=0x00007ff6cd843800 nid=0x3f03 waiting on condition [0x00007000069b4000]</span></span><br><span class="line"><span class="xml">   java.lang.Thread.State: WAITING (parking)</span></span><br><span class="line"><span class="xml">at sun.misc.Unsafe.park(Native Method)</span></span><br><span class="line">- parking to wait for  &lt;0x000000079578bd78&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:897)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)</span><br><span class="line">at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)</span><br><span class="line">at DeadLock.run(DeadLock.java:49)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- &lt;0x000000079578bdd8&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line"></span><br><span class="line">"east" #13 prio=5 os_prio=31 tid=0x00007ff6cd843000 nid=0x4103 waiting on condition [0x00007000068b1000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait for  &lt;0x000000079578bdd8&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:897)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)</span><br><span class="line">at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)</span><br><span class="line">at DeadLock.run(DeadLock.java:81)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- &lt;0x000000079578bd48&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line"></span><br><span class="line">"south" #10 prio=5 os_prio=31 tid=0x00007ff6cd842000 nid=0x3b03 waiting on condition [0x00007000067ae000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait for  &lt;0x000000079578bd48&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:897)</span><br><span class="line">at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)</span><br><span class="line">at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)</span><br><span class="line">at DeadLock.run(DeadLock.java:33)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- &lt;0x000000079578bda8&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span><br><span class="line">- Found one Java-level deadlock:</span><br><span class="line">  =============================</span><br><span class="line">"west":</span><br><span class="line">  waiting for ownable synchronizer 0x000000079578bda8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by "south"</span><br><span class="line">"south":</span><br><span class="line">  waiting for ownable synchronizer 0x000000079578bd48, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by "east"</span><br><span class="line">"east":</span><br><span class="line">  waiting for ownable synchronizer 0x000000079578bdd8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by "north"</span><br><span class="line">"north":</span><br><span class="line">  waiting for ownable synchronizer 0x000000079578bd78, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by "west"</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br><span class="line">  ===================================================</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°eastä¸­æœ‰è¿™å¥è¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parking to wait <span class="keyword">for</span>  &lt;<span class="number">0x000000079578bdd8</span>&gt;</span><br><span class="line"> south ä¸­ Locked ownable synchronizers:<span class="xml"><span class="tag">&lt;<span class="name">0x000000079578bda8</span>&gt;</span> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“eaståœ¨ç­‰å¾…0x000000079578bdd8ï¼Œè€Œ0x000000079578bdd8æ˜¯è¢«southæŒæœ‰çš„ã€‚ä»¥æ­¤ç±»æ¨ã€‚</p><p>åŒæ ·<br>â€œwestâ€:waiting for ownable synchronizer 0x000000079578bda8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),<br>which is held by â€œsouthâ€<br>ä¹Ÿæ˜¯èƒ½çœ‹å‡ºå…·ä½“çš„åŸå› ã€‚</p><p>æœ«å°¾æ›´æ¸…æ¥šï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">=============================</span><br><span class="line"><span class="string">"west"</span>:</span><br><span class="line">  waiting <span class="keyword">for</span> ownable synchronizer <span class="number">0x000000079578bda8</span>, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by <span class="string">"south"</span></span><br><span class="line"><span class="string">"south"</span>:</span><br><span class="line">  waiting <span class="keyword">for</span> ownable synchronizer <span class="number">0x000000079578bd48</span>, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by <span class="string">"east"</span></span><br><span class="line"><span class="string">"east"</span>:</span><br><span class="line">  waiting <span class="keyword">for</span> ownable synchronizer <span class="number">0x000000079578bdd8</span>, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by <span class="string">"north"</span></span><br><span class="line"><span class="string">"north"</span>:</span><br><span class="line">  waiting <span class="keyword">for</span> ownable synchronizer <span class="number">0x000000079578bd78</span>, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),</span><br><span class="line">  which is held by <span class="string">"west"</span></span><br><span class="line"></span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br></pre></td></tr></table></figure><h1 id="JDK8å¯¹å¹¶å‘çš„æ–°æ”¯æŒ"><a href="#JDK8å¯¹å¹¶å‘çš„æ–°æ”¯æŒ" class="headerlink" title="JDK8å¯¹å¹¶å‘çš„æ–°æ”¯æŒ"></a>JDK8å¯¹å¹¶å‘çš„æ–°æ”¯æŒ</h1><h2 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h2><p>â€“ å’ŒAtomicIntegerç±»ä¼¼çš„ä½¿ç”¨æ–¹å¼<br>â€“ åœ¨AtomicIntegerä¸Šè¿›è¡Œäº†çƒ­ç‚¹åˆ†ç¦»<br>â€“ public void add(long x)<br>â€“ public void increment()å¢åŠ ä¸€<br>â€“ public void decrement()å‡ä¸€<br>â€“ public long sum() å› ä¸ºæ˜¯åˆ†ç¦»æˆ16ä»½ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ±‚å’Œçš„æ“ä½œ<br>â€“ public long longValue() åŒä¸Š<br>â€“ public int intValue() Longè½¬åŒ–æˆæ•´å½¢<br>æ€§èƒ½æ¯”AtomicLongé«˜å¾ˆå¤šï¼Œå› ä¸ºLongAdderæ˜¯ç±»ä¼¼äºHashMaoçš„çƒ­ç‚¹åˆ†ç¦»ã€‚<br>ç¤ºæ„ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">casæ›´æ–°</span><br><span class="line">çº¿ç¨‹ä¸€--------&gt;cell1 |</span><br><span class="line">çº¿ç¨‹äºŒ--------&gt;cell2 |---sum----&gt;</span><br><span class="line">çº¿ç¨‹ä¸‰--------&gt;cell3 |----æ±‚å’Œ---&gt;    value</span><br><span class="line">çº¿ç¨‹å››--------&gt;cell4 |</span><br></pre></td></tr></table></figure><p></p><p>åŸºæœ¬æ€æƒ³ï¼š<br>å¦‚ä¸Šï¼Œå½“é«˜å¹¶å‘çš„æ—¶å€™ï¼Œå°†ä¸€ä¸ªæ•°åˆ†è§£æˆå¤šä¸ªcellï¼Œçº¿ç¨‹ä¸€è®¿é—®cell1ï¼Œçº¿ç¨‹äºŒè®¿é—®cell2ï¼Œä»¥æ­¤ç±»æ¨ï¼Œä»è€Œå‡å°‘å†²çªçš„æ¦‚ç‡ï¼Œä½†æ˜¯å½“å¹¶å‘çš„çº¿ç¨‹æ•°æå°‘çš„æ—¶å€™ï¼Œå°†æ•°åˆ†æˆæ•°ç»„ï¼Œåˆ™ä¼šæ¶ˆè€—å¾ˆå¤§çš„æ€§èƒ½ï¼Œèµ·åˆ°ç›¸åçš„ä½œç”¨ï¼Œæ‰€ä»¥Longaddæœ¬èº«æ˜¯æœ‰ä¼˜åŒ–çš„ï¼Œæœ¬èº«é€šè¿‡baseæ•°æ®ï¼ˆç±»ä¼¼äºAtomicLongï¼‰ï¼Œå½“å‘ç°ä¸€æ¬¡å†²çªçš„æ—¶å€™å°±åˆ†æˆä¸¤ä¸ªï¼Œåœ¨å‘ç°ä¸€æ¬¡å†²çªåˆ†æˆå››ä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><h2 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h2><h3 id="åŸºæœ¬"><a href="#åŸºæœ¬" class="headerlink" title="åŸºæœ¬"></a>åŸºæœ¬</h3><p>â€“ å®ç°CompletionStageæ¥å£(40ä½™ä¸ªæ–¹æ³•)<br>â€“ Java 8ä¸­å¯¹Futureçš„å¢å¼ºç‰ˆ<br>â€“ æ”¯æŒæµå¼è°ƒç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stage.thenApply(x -&gt; square(x)).thenAccept(x -&gt; System.out.print(x)).thenRun(() -&gt; </span><br><span class="line">System.out.println())</span><br></pre></td></tr></table></figure><p>å®Œæˆåå¾—åˆ°é€šçŸ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AskThread</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">      CompletableFuture &lt;Integer&gt; re = <span class="literal">null</span>;</span><br><span class="line">      public AskThread(CompletableFuture &lt;Integer&gt; re) &#123;</span><br><span class="line">      <span class="keyword">this</span>.re = re</span><br><span class="line">  &#125;</span><br><span class="line">      @Override</span><br><span class="line">      public <span class="keyword">void</span> run() [</span><br><span class="line">      int myRe = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//è¿”å›futureå€¼çš„å¹³æ–¹</span></span><br><span class="line">      myRe = re.get) * re.get();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      System.out.println(myRe);</span><br><span class="line">      &#125;</span><br><span class="line">      public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">      final CompletableFuture &lt;Integer&gt; future = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">      <span class="comment">//å°†futureä¼ åˆ°çº¿ç¨‹ä¸­</span></span><br><span class="line">      <span class="keyword">new</span> Thread(<span class="keyword">new</span> AskThread(future)).start();</span><br><span class="line">      <span class="comment">//æ¨¡æ‹Ÿé•¿æ—¶é—´çš„è®¡ç®—è¿‡ç¨‹</span></span><br><span class="line">      Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"> <span class="comment">//å‘ŠçŸ¥å®Œæˆç»“æœ</span></span><br><span class="line">      future.complete(<span class="number">60</span>);</span><br></pre></td></tr></table></figure><p>è·Ÿå‰é¢çš„futureæ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œå‰é¢çš„futureæ¨¡å¼å®Œæˆæ˜¯ç³»ç»Ÿè‡ªå·±å®Œæˆçš„ï¼Œè¿™é‡Œçš„å®Œæˆæ˜¯èƒ½å¤Ÿå¼€å‘è€…è‡ªå·±å®šä¹‰çš„ï¼Œå¦‚ä¸Šé¢çš„ä»£ç future.complete(60);</p><h3 id="å¼‚æ­¥æ‰§è¡Œ"><a href="#å¼‚æ­¥æ‰§è¡Œ" class="headerlink" title="å¼‚æ­¥æ‰§è¡Œ"></a>å¼‚æ­¥æ‰§è¡Œ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> Integer calc(Integer para) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿä¸€ä¸ªé•¿æ—¶é—´çš„æ‰§è¡Œ</span></span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> para*para;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException, ExecutionException &#123; </span><br><span class="line">final CompletableFuture&lt;Integer&gt; future =</span><br><span class="line"><span class="comment">//supplyAsyncå·¥å‚æ–¹æ³•ï¼Œèƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªCompletableFutureçš„å®ä¾‹ï¼Œ</span></span><br><span class="line"><span class="comment">//å¹¶ä¸æ˜¯é€šè¿‡newå‡ºæ¥çš„ï¼Œå†…éƒ¨ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªï¼Œèƒ½å¤Ÿç›´æ¥å¾—åˆ°ä¸€ä¸ªå®ä¾‹ï¼Œç„¶åè°ƒåŠ¨calc</span></span><br><span class="line"><span class="comment">//calcä¸­çš„æ‰§è¡Œç±»ä¼¼ä¸Šé¢çš„ä»£ç ï¼Œreturnå¹³æ³•ã€‚</span></span><br><span class="line">CompletableFuture.supplyAsync(() -&gt; calc(<span class="number">50</span>)); </span><br><span class="line">System.out.println(future.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å·¥å‚æ–¹æ³•ï¼š"><a href="#å·¥å‚æ–¹æ³•ï¼š" class="headerlink" title="å·¥å‚æ–¹æ³•ï¼š"></a>å·¥å‚æ–¹æ³•ï¼š</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier);</span><br><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier, Executor executor); <span class="keyword">static</span> CompletableFuture&lt;Void&gt; runAsync(Runnable runnable);</span><br><span class="line"><span class="keyword">static</span> CompletableFuture&lt;Void&gt; runAsync(Runnable runnable, Executor executor);</span><br></pre></td></tr></table></figure><p>Executor executorå°±æ˜¯çº¿ç¨‹æ± ï¼ŒsupplyAsyncå’ŒrunAsyncçš„åŒºåˆ«æ˜¯supplyAsyncæ˜¯æœ‰è¿”å›å€¼çš„ï¼ŒrunAsyncå°±æ˜¯ä¸€ä¸ªå•çº¯Runnableæ¥å£ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚</p><h3 id="æµå¼è°ƒç”¨"><a href="#æµå¼è°ƒç”¨" class="headerlink" title="æµå¼è°ƒç”¨"></a>æµå¼è°ƒç”¨</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> Integer calc(Integer para) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿä¸€ä¸ªé•¿æ—¶é—´çš„æ‰§è¡Œ</span></span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> para*para;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException, ExecutionException &#123; </span><br><span class="line">CompletableFuture&lt;Void&gt; fu=CompletableFuture.supplyAsync(() -&gt; calc(<span class="number">50</span>))</span><br><span class="line">.thenApply((i)-&gt;Integer.toString(i)) .thenApply((str)-&gt;<span class="string">"\""</span>+str+<span class="string">"\""</span>) .thenAccept(System.out::println);</span><br><span class="line">fu.get(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>calcè¿”å›å¹³æ–¹æ“ä½œï¼ŒInteger.toStringè½¬åŒ–æˆStringï¼ŒthenApply((str)-&gt;â€\â€â€+str+â€\â€â€) åœ¨Stringä¸¤è¾¹åŠ å¼•å·ï¼ŒthenAccept(System.out::println)è¾“å‡ºç»“æœã€‚fu.get(); çœ‹çœ‹å¾—åˆ°ç»“æœäº†æ²¡æœ‰ã€‚</p><h3 id="ç»„åˆå¤šä¸ªCompletableFuture"><a href="#ç»„åˆå¤šä¸ªCompletableFuture" class="headerlink" title="ç»„åˆå¤šä¸ªCompletableFuture"></a>ç»„åˆå¤šä¸ªCompletableFuture</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(<span class="built_in">Function</span>&lt;? <span class="keyword">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> Integer calc(Integer para) &#123;</span><br><span class="line"><span class="keyword">return</span> para/<span class="number">2</span>; </span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException, ExecutionException &#123; </span><br><span class="line">CompletableFuture&lt;Void&gt; fu =</span><br><span class="line">CompletableFuture.supplyAsync(() -&gt; calc(<span class="number">50</span>)) .thenCompose((i)-&gt;CompletableFuture.supplyAsync(() -&gt; calc(i))) .thenApply((str)-&gt;<span class="string">"\""</span> + str + <span class="string">"\""</span>).thenAccept(System.out::println);</span><br><span class="line">fu.get(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>thenComposeé™¤ä»¥å››ï¼Œå°±æ˜¯äº”åå…ˆé™¤ä»¥å››ï¼Œå†é™¤ä»¥å››ã€‚<br>ç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"12"</span></span><br></pre></td></tr></table></figure><h2 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h2><p>â€“ è¯»å†™é”çš„æ”¹è¿›<br>â€“ è¯»ä¸é˜»å¡å†™<br>è¯»çš„æ—¶å€™å‘ç”Ÿäº†å†™ï¼Œä¸åº”è¯¥ä¸è®©å†™æ“ä½œï¼Œè€Œåº”è¯¥é‡è¯»ã€‚<br>å› ä¸ºï¼š<br>å½“è¯»å¤ªå¤šçš„æ—¶å€™ï¼Œå¯èƒ½å‡ºç°å†™ä¸è¿›å»çš„ç°è±¡ï¼Œå†™é¥¥é¥¿ã€‚<br>stempæ—¶é—´æˆ³</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">private double x, y;</span><br><span class="line">private final StampedLock sl = <span class="keyword">new</span> StampedLock();</span><br><span class="line"><span class="keyword">void</span> move(double deltaX, double deltaY) &#123; <span class="comment">// an exclusively locked method long stamp = sl.writeLock();</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">x += deltaX;</span><br><span class="line">y += deltaY;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">sl.unlockWrite(stamp);</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">double distanceFromOrigin() &#123; <span class="comment">// A read-only method </span></span><br><span class="line"><span class="comment">//tryOptimisticReadä¹è§‚è¯»ï¼Œå³ä¸Šé¢æåˆ°çš„æ€æƒ³</span></span><br><span class="line">long stamp = sl.tryOptimisticRead();</span><br><span class="line">double currentX = x, currentY = y; </span><br><span class="line"><span class="comment">//éªŒè¯stempï¼Œå¦‚æœè¯»çš„è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œäº†å†™æ“ä½œï¼Œè¿”å›é›¶æˆ–è€…å…¶ä»–çš„æ•°ï¼Œæ‹’ç»æ“ä½œ</span></span><br><span class="line"><span class="comment">//å¦‚æœåœ¨è¯»xçš„è¿‡ç¨‹ä¸­ä¿®æ”¹äº†yï¼Œçœ‹åˆ°ä¸Šé¢çš„moveå‡½æ•°ï¼Œå¯¹slåŠ é”è§£é”ï¼Œæ¯æ¬¡çš„stempå€¼éƒ½æ˜¯ä¸ä¸€æ ·çš„</span></span><br><span class="line"><span class="comment">//å’Œè¿™é‡Œçš„å¯¹æ¯”</span></span><br><span class="line"><span class="keyword">if</span> (!sl.validate(stamp)) &#123;</span><br><span class="line"><span class="comment">//å¦‚æœä¸æ”¯æŒä¹è§‚è¯»ï¼Œå°±ç”¨æœ€åŸå§‹çš„è¯»å†™é”çš„æ–¹æ³•ã€‚</span></span><br><span class="line">stamp = sl.readLock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">currentX = x;</span><br><span class="line">currentY = y; </span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">sl.unlockRead(stamp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(currentX * currentX + currentY * currentY);</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="StampedLockçš„å®ç°æ€æƒ³"><a href="#StampedLockçš„å®ç°æ€æƒ³" class="headerlink" title="StampedLockçš„å®ç°æ€æƒ³"></a>StampedLockçš„å®ç°æ€æƒ³</h3><p>â€“ CLHè‡ªæ—‹é”<br>â€“ é”ç»´æŠ¤ä¸€ä¸ªç­‰å¾…çº¿ç¨‹é˜Ÿåˆ—ï¼Œæ‰€æœ‰ç”³è¯·é”ï¼Œä½†æ˜¯æ²¡æœ‰æˆåŠŸçš„çº¿ç¨‹éƒ½è®°å½•åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹(ä¸€ä¸ª èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹)ï¼Œä¿å­˜ä¸€ä¸ªæ ‡è®°ä½(locked)ï¼Œç”¨äºåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»é‡Šæ”¾é”ã€‚<br>â€“ å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å¾—é”æ—¶ï¼Œå–å¾—å½“å‰ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨èŠ‚ç‚¹ä½œä¸ºå…¶å‰åºèŠ‚ç‚¹ã€‚å¹¶ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹ä»£ç åˆ¤æ–­å‰ åºèŠ‚ç‚¹æ˜¯å¦å·²ç»æˆåŠŸé‡Šæ”¾é”:<br>ç¤ºæ„ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (pred.locked) &#123; &#125;</span><br></pre></td></tr></table></figure><p>StampedLockçš„å®ç°æ€æƒ³<br>â€“ ä¸ä¼šè¿›è¡Œæ— ä¼‘æ­¢çš„è‡ªæ—‹ï¼Œä¼šåœ¨åœ¨è‹¥å¹²æ¬¡è‡ªæ—‹åæŒ‚èµ·çº¿ç¨‹<br>ä¸Šé¢ï¼ˆwhileï¼‰åªæ˜¯ä¸€ä¸ªç¤ºæ„çš„ä»£ç ï¼Œä¸ä¼šæ— ä¼‘æ­¢çš„è‡ªæ—‹<br><img alt="" data-original="/images/15507583741088.png"></p><p>ç®€å•æ¥è¯´å°±æ˜¯æ¯æ¬¡æ‰§è¡Œè‡ªå·±çš„æ—¶å€™å…ˆçœ‹çœ‹å‰é¢çš„é”é‡Šæ”¾äº†æ²¡æœ‰ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•&quot;&gt;&lt;a href=&quot;#å¤šçº¿ç¨‹è°ƒè¯•çš„æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;å¤š
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰ï¼šé”çš„ä¼˜åŒ–å’Œæ³¨æ„äº‹é¡¹</title>
    <link href="http://mmmmmm.me/2019-02-18.html"/>
    <id>http://mmmmmm.me/2019-02-18.html</id>
    <published>2019-02-18T11:20:02.000Z</published>
    <updated>2019-02-18T09:21:19.875Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><strong><font color="red">æ³¨æ„ï¼šåªè¦æ˜¯æŒæœ‰é”çš„ï¼Œæ€§èƒ½å°±ä¼šæ¯”æ— é”è¦å·®ï¼Œä¸è®ºå¦‚ä½•ä¼˜åŒ–ã€‚</font></strong></p><h1 id="é”ä¼˜åŒ–çš„æ€è·¯å’Œæ–¹æ³•"><a href="#é”ä¼˜åŒ–çš„æ€è·¯å’Œæ–¹æ³•" class="headerlink" title="é”ä¼˜åŒ–çš„æ€è·¯å’Œæ–¹æ³•"></a>é”ä¼˜åŒ–çš„æ€è·¯å’Œæ–¹æ³•</h1><p>æ³¨æ„tryLockæ˜¯æ— é”çš„ï¼Œåªæ˜¯å»å°è¯•ä¸‹ï¼Œæ‹¿ä¸åˆ°å°±ä¼šæ¥ç€åšå…¶ä»–çš„äº‹æƒ…ï¼ŒLockæ˜¯æœ‰é”çš„æ“ä½œã€‚</p><h2 id="å‡å°‘é”æŒæœ‰æ—¶é—´"><a href="#å‡å°‘é”æŒæœ‰æ—¶é—´" class="headerlink" title="å‡å°‘é”æŒæœ‰æ—¶é—´"></a>å‡å°‘é”æŒæœ‰æ—¶é—´</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public synchronized <span class="keyword">void</span> syncMethod()&#123; </span><br><span class="line">othercode1();</span><br><span class="line">mutextMethod();</span><br><span class="line">othercode2(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬åŒ–ä¸ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> syncMethod2()&#123; </span><br><span class="line">othercode1();</span><br><span class="line">synchronized(<span class="keyword">this</span>)&#123;</span><br><span class="line">mutextMethod(); </span><br><span class="line">&#125;</span><br><span class="line">othercode2(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼åŒæ­¥ç›¸å…³çš„ä»£ç ï¼Œæ— å…³çš„ä»£ç å°±ä¸è¦åŒæ­¥ã€‚</p><h2 id="å‡å°é”ç²’åº¦"><a href="#å‡å°é”ç²’åº¦" class="headerlink" title="å‡å°é”ç²’åº¦"></a>å‡å°é”ç²’åº¦</h2><p>å°†å¤§å¯¹è±¡ï¼Œæ‹†æˆå°å¯¹è±¡ï¼Œå¤§å¤§å¢åŠ å¹¶è¡Œåº¦ï¼Œé™ä½é”ç«äº‰ ï¼ŒåŸæ¥å¯èƒ½æ˜¯å¯¹ä¸€ä¸ªå¾ˆå¤§çš„å¯¹è±¡åŠ é”ã€‚<br>åå‘é”ï¼Œè½»é‡çº§é”æˆåŠŸç‡æé«˜<br>ConcurrentHashMapï¼ˆå°±æ˜¯å°†å¤§å¯¹è±¡æ‹†åˆ†æˆå°å¯¹è±¡ï¼‰<br>HashMapçš„åŒæ­¥å®ç°<br>â€“ Collections.synchronizedMap(Map&lt;K,V&gt; m)<br>â€“ è¿”å›SynchronizedMapå¯¹è±¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public V get(<span class="built_in">Object</span> key) &#123;</span><br><span class="line">synchronized (mutex) &#123;<span class="keyword">return</span> m.get(key);&#125; </span><br><span class="line">&#125;</span><br><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">synchronized (mutex) &#123;<span class="keyword">return</span> m.put(key, value);&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConcurrentHashMap<br>â€“ è‹¥å¹²ä¸ªSegment :Segment&lt;K,V&gt;[] segments<br>â€“ Segmentä¸­ç»´æŠ¤HashEntry&lt;K,V&gt;<br>â€“ putæ“ä½œæ—¶<br>â€¢ å…ˆå®šä½åˆ°Segmentï¼Œé”å®šä¸€ä¸ªSegmentï¼Œæ‰§è¡Œput<br>åœ¨å‡å°é”ç²’åº¦åï¼Œ ConcurrentHashMapå…è®¸è‹¥å¹²ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥<br>å°±æ˜¯è®²hashmapæ‹†åˆ†æˆå¤šä¸ªhashMapï¼Œå³æ‹†åˆ†æˆå¤šä¸ªå¯¹è±¡ã€‚</p><h2 id="é”åˆ†ç¦»"><a href="#é”åˆ†ç¦»" class="headerlink" title="é”åˆ†ç¦»"></a>é”åˆ†ç¦»</h2><p>å³è¯»å†™åˆ†ç¦»<br>æ ¹æ®åŠŸèƒ½è¿›è¡Œé”åˆ†ç¦»<br>ReadWriteLock<br>è¯»å¤šå†™å°‘çš„æƒ…å†µï¼Œå¯ä»¥æé«˜æ€§èƒ½<br>| | è¯»é” |å†™é”|<br>|â€“|â€“|â€“|<br>| è¯»é” | å¯è®¿é—® |ä¸å¯è®¿é—®<br>|å†™é”|ä¸å¯è®¿é—®|ä¸å¯è®¿é—®<br>è¯»æ“ä½œå’Œè¯»æ“ä½œæ˜¯ä¸éœ€è¦é˜»å¡çš„ï¼Œå°†é˜»å¡çš„å¹¶å‘å˜æˆäº†æ— ç­‰å¾…çš„å¹¶å‘ã€‚</p><p>è¯»å†™åˆ†ç¦»æ€æƒ³å¯ä»¥å»¶ä¼¸ï¼Œåªè¦æ“ä½œäº’ä¸å½±å“ï¼Œé”å°±å¯ä»¥åˆ†ç¦»<br>LinkedBlockingQueue<br>â€“ é˜Ÿåˆ—<br>â€“ é“¾è¡¨<br>å°±åƒé˜Ÿåˆ—putå’Œtakeæ“ä½œï¼Œä¸€ä¸ªåœ¨å¤´éƒ¨ä¸€ä¸ªåœ¨å°¾éƒ¨äº’ä¸å½±å“</p><h2 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯å¤šçº¿ç¨‹é—´çš„æœ‰æ•ˆå¹¶å‘ï¼Œä¼šè¦æ±‚æ¯ä¸ªçº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´å°½é‡çŸ­ï¼Œå³åœ¨ä½¿ç”¨å®Œ å…¬å…±èµ„æºåï¼Œåº”è¯¥ç«‹å³é‡Šæ”¾é”ã€‚åªæœ‰è¿™æ ·ï¼Œç­‰å¾…åœ¨è¿™ä¸ªé”ä¸Šçš„å…¶ä»–çº¿ç¨‹æ‰èƒ½å°½æ—©çš„è·å¾—èµ„æºæ‰§è¡Œ ä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œå‡¡äº‹éƒ½æœ‰ä¸€ä¸ªåº¦ï¼Œå¦‚æœå¯¹åŒä¸€ä¸ªé”ä¸åœçš„è¿›è¡Œè¯·æ±‚ã€åŒæ­¥å’Œé‡Šæ”¾ï¼Œå…¶æœ¬èº«ä¹Ÿä¼šæ¶ˆè€— ç³»ç»Ÿå®è´µçš„èµ„æºï¼Œåè€Œä¸åˆ©äºæ€§èƒ½çš„ä¼˜åŒ–</p><h3 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> demoMethod()&#123; </span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"> <span class="comment">//do sth.</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//åšå…¶ä»–ä¸éœ€è¦çš„åŒæ­¥çš„å·¥ä½œï¼Œä½†èƒ½å¾ˆå¿«æ‰§è¡Œå®Œæ¯• </span></span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line"><span class="comment">//do sth. </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”è¯¥è½¬åŒ–æˆ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> demoMethod()&#123; <span class="comment">//æ•´åˆæˆä¸€æ¬¡é”è¯·æ±‚</span></span><br><span class="line">synchronized(lock)&#123; </span><br><span class="line"><span class="comment">//do sth.</span></span><br><span class="line"><span class="comment">//åšå…¶ä»–ä¸éœ€è¦çš„åŒæ­¥çš„å·¥ä½œï¼Œä½†èƒ½å¾ˆå¿«æ‰§è¡Œå®Œæ¯• </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸æ–­çš„åŠ é”é‡Šæ”¾é”ä¹Ÿæ˜¯ä¼šæ¶ˆè€—å¾ˆå¤§çš„æ€§èƒ½çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±åº”è¯¥é”ç²—åŒ–ï¼Œä½†æ˜¯å‰æä¸Šé¢çš„ä»£ç ä¸­çš„å…¶ä»–ä¸éœ€è¦åŒæ­¥çš„å·¥ä½œæ˜¯èƒ½å¤Ÿå¾ˆå¿«çš„æ‰§è¡Œå®Œæ¯•çš„ï¼Œå¦åˆ™ä¸åº”è¯¥æ‰€ç²—åŒ–ã€‚</p><h3 id="ä¸¾ä¸ªæ —å­-1"><a href="#ä¸¾ä¸ªæ —å­-1" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;CIRCLE;i++)&#123; </span><br><span class="line">synchronized(lock)&#123;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">synchronized(lock)&#123; </span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;CIRCLE;i++)&#123;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h2><p>åœ¨å³æ—¶ç¼–è¯‘å™¨æ—¶ï¼Œå¦‚æœå‘ç°ä¸å¯èƒ½è¢«å…±äº«çš„å¯¹è±¡ï¼Œåˆ™å¯ä»¥æ¶ˆé™¤è¿™äº›å¯¹è±¡çš„é”æ“ä½œï¼ˆjdkè‡ªèº«çš„ä¼˜åŒ–ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) throws InterruptedException &#123; </span><br><span class="line">long start = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; CIRCLE; i++) &#123;</span><br><span class="line">craeteStringBuffer(<span class="string">"JVM"</span>, <span class="string">"Diagnosis"</span>); </span><br><span class="line">&#125;</span><br><span class="line">long bufferCost = System.currentTimeMillis() - start;</span><br><span class="line">System.out.println(<span class="string">"craeteStringBuffer: "</span> + bufferCost + <span class="string">" ms"</span>); </span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">String</span> craeteStringBuffer(<span class="built_in">String</span> s1, <span class="built_in">String</span> s2) &#123; </span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">sb.append(s1);</span><br><span class="line">sb.append(s2);</span><br><span class="line"><span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œåœ¨jdkä¸­æœ‰è®¸å¤šç±»ä¼¼StringBufferè¿™æ ·çš„ç±»ï¼Œæœ¬èº«å°±æ˜¯åœ¨é”çš„åŸºç¡€ä¸Šå°è£…çš„ï¼Œè‡ªå·±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ç”¨äº†å®ƒçš„æŸäº›æ–¹æ³•ï¼ˆappendç­‰ï¼‰åï¼Œå‘ç°sbè¿™ä¸ªå˜é‡æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šè¢«å…¶ä»–çš„çº¿ç¨‹è®¿é—®åˆ°ï¼Œå¹¶ä¸éœ€è¦ä¸ºäº†çº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿›è¡Œé”çš„æ“ä½œã€‚</p><p>è§£å†³åŠæ³•:<br>CIRCLE= 2000000</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-server -XX:+DoEscapeAnalysis -XX:+EliminateLocks</span><br><span class="line">   craeteStringBuffer: <span class="number">187</span> ms</span><br><span class="line">-server -XX:+DoEscapeAnalysis -XX:-EliminateLocks</span><br><span class="line">craeteStringBuffer: <span class="number">254</span> ms</span><br></pre></td></tr></table></figure><p>è‡ªç§serveræ¨¡å¼ä¸‹èƒ½æœ‰æ›´å¤šçš„æ“ä½œï¼Œ-XX:+DoEscapeAnalysis ï¼šé€ƒé€¸åˆ†æï¼Œåˆ†æsbè¿™ä¸ªå˜é‡ä¼šä¸ä¼šè¢«å…¶ä»–çš„çº¿ç¨‹è®¿é—®åˆ°ï¼Œå¦‚æœä¼šæ€æ ·ï¼Œå¦‚æœä¼šä¸æ€æ ·ï¼Œ+EliminateLocksï¼šç»è¿‡é€ƒé€¸åˆ†æï¼Œçœ‹æ˜¯å¦æ‰“å¼€é”æ¶ˆé™¤ã€‚<br>é€šè¿‡ä¸Šé¢çš„æ—¶é—´æ˜¾ç¤ºï¼Œè¿›è¡Œäº†é”æ¶ˆé™¤ï¼Œç¡®å®æ€§èƒ½æœ‰å¾ˆå¤§çš„æå‡ã€‚</p><h1 id="è™šæ‹Ÿæœºå†…éƒ¨çš„é”ä¼˜åŒ–-å½“ä½¿ç”¨synchronizeå…³é”®å­—çš„æ—¶å€™é‡Œé¢ä¼šåšé‚£äº›äº‹æƒ…"><a href="#è™šæ‹Ÿæœºå†…éƒ¨çš„é”ä¼˜åŒ–-å½“ä½¿ç”¨synchronizeå…³é”®å­—çš„æ—¶å€™é‡Œé¢ä¼šåšé‚£äº›äº‹æƒ…" class="headerlink" title="è™šæ‹Ÿæœºå†…éƒ¨çš„é”ä¼˜åŒ–(å½“ä½¿ç”¨synchronizeå…³é”®å­—çš„æ—¶å€™é‡Œé¢ä¼šåšé‚£äº›äº‹æƒ…)"></a>è™šæ‹Ÿæœºå†…éƒ¨çš„é”ä¼˜åŒ–(å½“ä½¿ç”¨synchronizeå…³é”®å­—çš„æ—¶å€™é‡Œé¢ä¼šåšé‚£äº›äº‹æƒ…)</h1><h2 id="å¯¹è±¡å¤´Mark"><a href="#å¯¹è±¡å¤´Mark" class="headerlink" title="å¯¹è±¡å¤´Mark"></a>å¯¹è±¡å¤´Mark</h2><p>æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡å¤´<br>Mark Wordï¼Œå¯¹è±¡å¤´çš„æ ‡è®°ï¼Œ32ä½ï¼ˆ32ä½æ“ä½œç³»ç»Ÿä¸­ï¼‰<br>æè¿°å¯¹è±¡çš„hashã€é”ä¿¡æ¯ï¼Œåƒåœ¾å›æ”¶æ ‡è®°ï¼Œå¹´é¾„<br>â€“ æŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ<br>â€“ æŒ‡å‘monitorçš„æŒ‡é’ˆ<br>â€“ GCæ ‡è®°<br>â€“ åå‘é”çº¿ç¨‹ID</p><h2 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h2><p>å¤§éƒ¨åˆ†æƒ…å†µæ˜¯æ²¡æœ‰ç«äº‰çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡åå‘æ¥æé«˜æ€§èƒ½<br>æ‰€è°“çš„åå‘ï¼Œå°±æ˜¯åå¿ƒï¼Œå³é”ä¼šåå‘äºå½“å‰å·²ç»å æœ‰é”çš„çº¿ç¨‹<br>å°†å¯¹è±¡å¤´Markçš„æ ‡è®°è®¾ç½®ä¸ºåå‘ï¼Œå¹¶å°†çº¿ç¨‹IDå†™å…¥å¯¹è±¡å¤´Mark<br>åªè¦æ²¡æœ‰ç«äº‰ï¼Œè·å¾—åå‘é”çš„çº¿ç¨‹ï¼Œåœ¨å°†æ¥è¿›å…¥åŒæ­¥å—ï¼Œä¸éœ€è¦åšåŒæ­¥<br>å½“å…¶ä»–çº¿ç¨‹è¯·æ±‚ç›¸åŒçš„é”æ—¶ï¼Œåå‘æ¨¡å¼ç»“æŸ<br>-XX:+UseBiasedLocking â€“ é»˜è®¤å¯ç”¨<br>åœ¨ç«äº‰æ¿€çƒˆçš„åœºåˆï¼Œåå‘é”ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…ï¼Œå°±åƒå¦‚æœæ¯æ¬¡éƒ½åå‘ç„¶åç´§æ¥ç€åˆç»“æŸäº†ï¼Œä»»ä½•äº‹æƒ…éƒ½æ˜¯æœ‰ä¸¤é¢æ€§çš„ã€‚</p><h3 id="ä¸¾ä¸ªæ —å­-2"><a href="#ä¸¾ä¸ªæ —å­-2" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> List&lt;Integer&gt; numberList =<span class="keyword">new</span> Vector&lt;Integer&gt;(); public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">long begin=System.currentTimeMillis(); </span><br><span class="line">int count=<span class="number">0</span>;</span><br><span class="line">int startnum=<span class="number">0</span>; <span class="keyword">while</span>(count&lt;<span class="number">10000000</span>)&#123;</span><br><span class="line">numberList.add(startnum); startnum+=<span class="number">2</span>;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">long end=System.currentTimeMillis(); </span><br><span class="line">System.out.println(end-begin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ¬ä¾‹ä¸­ï¼Œä½¿ç”¨å å‘é”ï¼Œå¯ä»¥è·å¾— 5%ä»¥ä¸Šçš„æ€§èƒ½ æå‡</span></span><br><span class="line">-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=<span class="number">0</span></span><br><span class="line">-XX:-UseBiasedLocking</span><br></pre></td></tr></table></figure><p>BiasedLockingStartupDelayæ˜¯ç³»ç»Ÿå¯åŠ¨çš„å‡ ç§’ä¹‹å†…é‡‘ç«¥åå‘é”ï¼Œå› ä¸ºåœ¨ç³»ç»Ÿåˆšåˆšå¯åŠ¨çš„æ—¶å€™ç¡®å®ä¼šæœ‰è®¸å¤šçš„é”ç«äº‰ï¼Œè™šæ‹Ÿæœºä¼šæä¾›ä¸€ä¸ªé»˜è®¤çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®ä¸º0ï¼Œæ˜¯å› ä¸ºéœ€è¦å†™çš„ä»£ç å¾ˆå°‘ï¼Œèƒ½å¤Ÿåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥å°†BiasedLockingStartupDelayè®¾ç½®ä¸º0ã€‚</p><h2 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h2><p>BasicObjectLock<br>â€“ åµŒå…¥åœ¨çº¿ç¨‹æ ˆä¸­çš„å¯¹è±¡<br>å¦‚æœåå‘é”å¤±è´¥ï¼Œå°±ä¼šå»æ‰§è¡Œè½»é‡çº§é”çš„æ“ä½œã€‚<br>æ™®é€šçš„é”å¤„ç†æ€§èƒ½ä¸å¤Ÿç†æƒ³ï¼Œè½»é‡çº§é”æ˜¯ä¸€ç§å¿«é€Ÿçš„é”å®šæ–¹æ³•ã€‚<br><strong><font color="red">æ“ä½œç³»ç»Ÿå±‚é¢çš„é”æ€§èƒ½æ˜¯æ¯”è¾ƒå·®çš„ï¼Œjvmç›¸å½“äºæ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ä¸ªåº”ç”¨ï¼Œjvmçº§åˆ«çš„é”èƒ½å¤Ÿæé«˜æ€§èƒ½ã€‚</font></strong><br>å¦‚æœå¯¹è±¡æ²¡æœ‰è¢«é”å®š<br>â€“ å°†å¯¹è±¡å¤´çš„MarkæŒ‡é’ˆä¿å­˜åˆ°é”å¯¹è±¡ä¸­<br>â€“ å°†å¯¹è±¡å¤´è®¾ç½®ä¸ºæŒ‡å‘é”çš„æŒ‡é’ˆ(åœ¨çº¿ç¨‹æ ˆç©ºé—´ä¸­)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lock-&gt;set_displaced_header(mark);</span><br><span class="line"><span class="keyword">if</span> (mark == (markOop) Atomic::cmpxchg_ptr(lock, obj()-&gt;mark_addr(), mark))</span><br><span class="line">&#123;</span><br><span class="line">TEVENT (slow_enter: release stacklock) ;</span><br><span class="line"><span class="keyword">return</span> ; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lockä½äºçº¿ç¨‹æ ˆä¸­<br><strong><font color="red">æ³¨æ„ä¸Šé¢è¯´çš„ï¼Œå¯¹è±¡å¤´markä¿å­˜åœ¨é”ä¸­ï¼Œé”ä½äºçº¿ç¨‹æ ˆä¸­ï¼Œå¯¹è±¡å¤´è®¾ç½®ä¸ºé”çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœå¯¹è±¡å¤´æŒ‡å‘äº†çº¿ç¨‹æ ˆä¸­ï¼Œåˆ™è¡¨ç¤ºæŒæœ‰è¿™æŠŠé”ï¼Œä¸Šé¢çš„æŒ‡ä»¤åŒæ ·æ˜¯casæ“ä½œã€‚</font></strong></p><p>å¦‚æœè½»é‡çº§é”å¤±è´¥ï¼Œè¡¨ç¤ºå­˜åœ¨ç«äº‰ï¼Œå‡çº§ä¸ºé‡é‡çº§é”(å¸¸è§„é”ï¼Œæ“ä½œç³»ç»Ÿå±‚é¢çš„é”)<br>åœ¨æ²¡æœ‰é”ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿé”ä½¿ç”¨OSäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æŸè€—<br>åœ¨ç«äº‰æ¿€çƒˆæ—¶ï¼Œè½»é‡çº§é”ä¼šå¤šåšå¾ˆå¤šé¢å¤–æ“ä½œï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™</p><h2 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h2><h3 id="ä¸¾ä¸ªæ —å­-3"><a href="#ä¸¾ä¸ªæ —å­-3" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h3><p>concurrentHashMaoä¸­çš„putå°±æ˜¯çº¿ç¨‹çš„é”è¢«å…¶ä»–äººæ‹¿èµ°ä¹‹åï¼Œä¸æ€¥ç€æŒ‚èµ·è‡ªå·±ï¼Œè€Œæ˜¯æ‰§è¡Œå‡ æ¬¡trylocakæ“ä½œï¼Œå› ä¸ºä¸€æ—¦æŒ‚èµ·ä¼šæ¶ˆè€—å…«ä¸‡ä¸ªæ—¶å…‰å‘¨æœŸã€‚ä¸æ–­çš„å¾ªç¯trylockï¼Œå½“å¤šæ¬¡å¾ªç¯ä¹‹åè¿˜æ˜¯æ²¡æœ‰æ‹¿åˆ°ï¼Œå°±æŒ‚èµ·ã€‚</p><p>å½“ç«äº‰å­˜åœ¨æ—¶ï¼Œå¦‚æœçº¿ç¨‹å¯ä»¥å¾ˆå¿«è·å¾—é”ï¼Œé‚£ä¹ˆå¯ä»¥ä¸åœ¨OSå±‚æŒ‚èµ·çº¿ç¨‹ï¼Œè®©çº¿ç¨‹åšå‡ ä¸ªç©ºæ“ä½œ( è‡ªæ—‹)<br>JDK1.6ä¸­-XX:+UseSpinningå¼€å¯<br>JDK1.7ä¸­ï¼Œå»æ‰æ­¤å‚æ•°ï¼Œæ”¹ä¸ºå†…ç½®å®ç°<br>å¦‚æœåŒæ­¥å—å¾ˆé•¿ï¼Œè‡ªæ—‹å¤±è´¥ï¼Œä¼šé™ä½ç³»ç»Ÿæ€§èƒ½<br>å¦‚æœåŒæ­¥å—å¾ˆçŸ­ï¼Œè‡ªæ—‹æˆåŠŸï¼ŒèŠ‚çœçº¿ç¨‹æŒ‚èµ·åˆ‡æ¢æ—¶é—´ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½</p><h2 id="åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“"><a href="#åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“" class="headerlink" title="åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“"></a>åå‘é”ï¼Œè½»é‡çº§é”ï¼Œè‡ªæ—‹é”æ€»ç»“</h2><p>ä¸æ˜¯Javaè¯­è¨€å±‚é¢çš„é”ä¼˜åŒ–æ–¹æ³•ï¼Œæ˜¯è™šæ‹Ÿæœºå±‚é¢çš„ä¼˜åŒ–<br>å†…ç½®äºJVMä¸­çš„è·å–é”çš„ä¼˜åŒ–æ–¹æ³•å’Œè·å–é”çš„æ­¥éª¤<br>â€“ åå‘é”å¯ç”¨ä¼šå…ˆå°è¯•åå‘é”<br>â€“ è½»é‡çº§é”å¯ç”¨ä¼šå…ˆå°è¯•è½»é‡çº§é”<br>â€“ ä»¥ä¸Šéƒ½å¤±è´¥ï¼Œå°è¯•è‡ªæ—‹é”<br>â€“ å†å¤±è´¥ï¼Œå°è¯•æ™®é€šé”ï¼Œä½¿ç”¨OSäº’æ–¥é‡åœ¨æ“ä½œç³»ç»Ÿå±‚æŒ‚èµ·</p><h1 id="ä¸€ä¸ªé”™è¯¯ä½¿ç”¨é”çš„æ¡ˆä¾‹"><a href="#ä¸€ä¸ªé”™è¯¯ä½¿ç”¨é”çš„æ¡ˆä¾‹" class="headerlink" title="ä¸€ä¸ªé”™è¯¯ä½¿ç”¨é”çš„æ¡ˆä¾‹"></a>ä¸€ä¸ªé”™è¯¯ä½¿ç”¨é”çš„æ¡ˆä¾‹</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">IntegerLock</span> </span>&#123; </span><br><span class="line"><span class="keyword">static</span> Integer i=<span class="number">0</span>;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123; </span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">for</span>(int k=<span class="number">0</span>;k&lt;<span class="number">100000</span>;k++)&#123; </span><br><span class="line">synchronized(i)&#123;</span><br><span class="line">i++; </span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123; AddThread t1=<span class="keyword">new</span> AddThread();</span><br><span class="line">AddThread t2=<span class="keyword">new</span> AddThread(); </span><br><span class="line">t1.start();</span><br><span class="line">t2.start(); </span><br><span class="line">t1.join();</span><br><span class="line">t2.join(); </span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™å¥è¯ï¼šsynchronized(i)<br>å…¶ä¸­çš„iæ˜¯Integerç±»å‹çš„ï¼Œi++æ“ä½œä¸€èˆ¬æ˜¯åœ¨intç±»å‹ä¸Šï¼ŒIntegerç±»å‹ä¼šæœ‰è‡ªåŠ¨çš„æ‹†ç®±è£…ç®±çš„æ“ä½œï¼Œå¹¶ä¸æ˜¯å°†i++çš„å€¼ç›´æ¥èµ‹å€¼ç»™äº†iï¼Œè€Œæ˜¯newäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†iæŒ‡å‘å®ƒï¼Œæ‰€ä»¥è¿™é‡Œsynchronized(i)ä¸­çš„iä¸èƒ½ç¡®å®šæ˜¯ä»£ç ä¸­çš„iè¿˜æ˜¯newçš„ä¸€ä¸ªæ–°çš„Integerå¯¹è±¡ï¼Œä»è€Œä¸èƒ½ä¿è¯æ‹¿åˆ°çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥è¿™æ®µä»£ç å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h1 id="ThreadLocalåŠå…¶æºç åˆ†æ"><a href="#ThreadLocalåŠå…¶æºç åˆ†æ" class="headerlink" title="ThreadLocalåŠå…¶æºç åˆ†æ"></a>ThreadLocalåŠå…¶æºç åˆ†æ</h1><p>æŠŠé”å»æ‰ï¼Œä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æä¾›ä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼Œä¸åŒçš„çº¿ç¨‹ï¼Œéƒ½å»è®¿é—®è‡ªå·±çš„å¯¹è±¡ï¼Œè€Œä¸å»è®¿é—®åˆ«äººçš„å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™é”å°±å®Œå…¨æ²¡æœ‰å¿…è¦ç­‰å¾…ã€‚</p><h2 id="ä¸¾ä¸ªæ —å­-4"><a href="#ä¸¾ä¸ªæ —å­-4" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> final SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>); </span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseDate</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">int i=<span class="number">0</span>;</span><br><span class="line">public ParseDate(int i)&#123;<span class="keyword">this</span>.i=i;&#125; public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="built_in">Date</span> t=sdf.parse(<span class="string">"2015-03-29 19:29:"</span>+i%<span class="number">60</span>); </span><br><span class="line">System.out.println(i+<span class="string">":"</span>+t);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ExecutorService es=Executors.newFixedThreadPool(<span class="number">10</span>); </span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">es.execute(<span class="keyword">new</span> ParseDate(i));</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SimpleDateFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¢«å¤šçº¿ç¨‹è®¿é—®æ˜¯å®¹æ˜“æŠ›å‡ºä¸€äº›å¼‚å¸¸ï¼Œä¸èƒ½æ­£å¸¸çš„å·¥ä½œã€‚</p><h3 id="ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå®ä¾‹"><a href="#ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå®ä¾‹" class="headerlink" title="ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå®ä¾‹"></a>ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå®ä¾‹</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ThreadLocal&lt;SimpleDateFormat&gt; tl=<span class="keyword">new</span> ThreadLocal&lt;SimpleDateFormat&gt;(); public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseDate</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">int i=<span class="number">0</span>;</span><br><span class="line">public ParseDate(int i)&#123;<span class="keyword">this</span>.i=i;&#125; public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span>(tl.get()==<span class="literal">null</span>)&#123;</span><br><span class="line">tl.set(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Date</span> t=tl.get().parse(<span class="string">"2015-03-29 19:29:"</span>+i%<span class="number">60</span>); </span><br><span class="line">System.out.println(i+<span class="string">":"</span>+t);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ExecutorService es=Executors.newFixedThreadPool(<span class="number">10</span>); </span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">es.execute(<span class="keyword">new</span> ParseDate(i));</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¦‚æœä½¿ç”¨å…±äº«å®ä¾‹ï¼Œèµ·ä¸åˆ°æ•ˆæœ"><a href="#å¦‚æœä½¿ç”¨å…±äº«å®ä¾‹ï¼Œèµ·ä¸åˆ°æ•ˆæœ" class="headerlink" title="å¦‚æœä½¿ç”¨å…±äº«å®ä¾‹ï¼Œèµ·ä¸åˆ°æ•ˆæœ"></a>å¦‚æœä½¿ç”¨å…±äº«å®ä¾‹ï¼Œèµ·ä¸åˆ°æ•ˆæœ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ThreadLocal&lt;SimpleDateFormat&gt; tl=<span class="keyword">new</span> ThreadLocal&lt;SimpleDateFormat&gt;();</span><br><span class="line">private <span class="keyword">static</span> final SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>); public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseDate</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">int i=<span class="number">0</span>;</span><br><span class="line">public ParseDate(int i)&#123;<span class="keyword">this</span>.i=i;&#125; </span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span>(tl.get()==<span class="literal">null</span>)&#123;</span><br><span class="line">tl.set(sdf ); </span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Date</span> t=tl.get().parse(<span class="string">"2015-03-29 19:29:"</span>+i%<span class="number">60</span>);</span><br><span class="line">System.out.println(i+<span class="string">":"</span>+t); </span><br><span class="line">&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">e.printStackTrace();&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ExecutorService es=Executors.newFixedThreadPool(<span class="number">10</span>); </span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">es.execute(<span class="keyword">new</span> ParseDate(i));</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šè¿°ä»£ç ä¸­tl.set(sdf ); æ­£ç¡®çš„åº”è¯¥æ˜¯tl.set(new SimpleDateFormat(â€œyyyy-MM-dd HH:mm:ssâ€));<br>æ¯æ¬¡éƒ½newä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½èµ·åˆ°ä½œç”¨ï¼Œå¦åˆ™é”ä¸€ä¸ªçš„threadlocalé‡Œé¢å­˜çš„è¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„ç°è±¡ã€‚</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="keyword">void</span> set(T value) &#123;</span><br><span class="line">        Thread t = Thread.currentThread();</span><br><span class="line">        <span class="comment">//æ‹¿åˆ°ThreadlocalMap</span></span><br><span class="line">        ThreadLocalMap map = getMap(t);</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">            map.set(<span class="keyword">this</span>, value);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ThreadLocalMap getMap(Thread t) &#123;</span><br><span class="line"><span class="comment">//å¯ä»¥çœ‹åˆ°Threadlocalæœ¬èº«å°±éš¶å±äºè¿™ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åœ¨å½“å‰çš„çº¿ç¨‹ä¸­ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰è‡ªå·±çš„map</span></span><br><span class="line"> ThreadLocal.ThreadLocalMap threadLocals = <span class="literal">null</span>;</span><br><span class="line"> <span class="comment">//keyæ˜¯ThreadLocalæœ¬èº«ï¼Œvalueå°±æ˜¯è®¾è¿›å»çš„å€¼</span></span><br><span class="line"> private <span class="keyword">void</span> set(ThreadLocal&lt;?&gt; key, <span class="built_in">Object</span> value) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We don't use a fast path as with get() because it is at</span></span><br><span class="line">            <span class="comment">// least as common to use set() to create new entries as</span></span><br><span class="line">            <span class="comment">// it is to replace existing ones, in which case, a fast</span></span><br><span class="line">            <span class="comment">// path would fail more often than not.</span></span><br><span class="line"></span><br><span class="line">            Entry[] tab = table;</span><br><span class="line">            int len = tab.length;</span><br><span class="line">            int i = key.threadLocalHashCode &amp; (len<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">                 e != <span class="literal">null</span>;</span><br><span class="line">                 e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">                ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">                    e.value = value;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                    replaceStaleEntry(key, value, i);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">            int sz = ++size;</span><br><span class="line">            <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">                rehash();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//nextIndexå…¶å®æ˜¯i++çš„æ“ä½œï¼Œå› ä¸ºgetå‡ºæ¥ï¼Œå‘ç°å¦‚æœæœ‰äº†ä¼šæœ‰hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™</span></span><br><span class="line">  <span class="comment">//ä¸‹æ ‡åŠ ä¸€ï¼Œå†èµ‹å€¼ã€‚</span></span><br><span class="line">  private <span class="keyword">static</span> int nextIndex(int i, int len) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="comment">//æ‰§è¡Œæ¸…ç†çš„å·¥ä½œï¼Œå¯ä»¥çœ‹åˆ°å¹¶ä¸æ˜¯å…¨éƒ¨æ¸…ç†ï¼Œåªæ˜¯n &gt;&gt;&gt;= 1å³ç§»æ“ä½œï¼Œæ¸…ç†éƒ¨åˆ†ã€‚</span></span><br><span class="line">  <span class="comment">//å‰é¢çŸ¥é“Entryæ˜¯å¼±å¼•ç”¨çš„ï¼Œåªæœ‰å½“entryï¼=nullå¹¶ä¸”e.getï¼ˆï¼‰--ã€‹ThreadLocalæ˜¯nullçš„æ—¶å€™</span></span><br><span class="line">  <span class="comment">//é€šè¿‡expungeStaleEntryæ–¹æ³•å°†tab[staleSlot].value = null;</span></span><br><span class="line">  <span class="comment">//tab[staleSlot] = null;è¿™ä¸¤ä¸ªç½®ä¸ºnull</span></span><br><span class="line">private boolean cleanSomeSlots(int i, int n) &#123;</span><br><span class="line">            boolean removed = <span class="literal">false</span>;</span><br><span class="line">            Entry[] tab = table;</span><br><span class="line">            int len = tab.length;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                i = nextIndex(i, len);</span><br><span class="line">                Entry e = tab[i];</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">                    n = len;</span><br><span class="line">                    removed = <span class="literal">true</span>;</span><br><span class="line">                    i = expungeStaleEntry(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> ( (n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> removed;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//å¯ä»¥çœ‹åˆ° ThreadLocalMap.Entry e = map.getEntry(this);</span></span><br><span class="line"><span class="comment">//ä¹Ÿæ˜¯ä¼ çš„ThreadLocalæœ¬èº«</span></span><br><span class="line">public T get() &#123;</span><br><span class="line">        Thread t = Thread.currentThread();</span><br><span class="line">        ThreadLocalMap map = getMap(t);</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">                T result = (T)e.value;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œæ³¨æ„Entryæ˜¯ç»§æ‰¿äºå¼±å¼•ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ•°æ®å¼•ç”¨åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«ç³»ç»Ÿé‡Šæ”¾æ‰ã€‚</span></span><br><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">            <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">            <span class="built_in">Object</span> value;</span><br><span class="line"></span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, <span class="built_in">Object</span> v) &#123;</span><br><span class="line">                <span class="keyword">super</span>(k);</span><br><span class="line">                value = v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;strong&gt;&lt;font color=&quot;red&quot;&gt;æ³¨æ„ï¼šåªè¦æ˜¯æŒæœ‰é”çš„ï¼Œæ€§èƒ½å°±ä¼šæ¯”æ— é”è¦å·®ï¼Œä¸è®ºå¦‚ä½•ä¼˜åŒ–ã€‚&lt;/font&gt;&lt;
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆå…«ï¼‰ï¼šNIOå’ŒAIO</title>
    <link href="http://mmmmmm.me/2019-02-16.html"/>
    <id>http://mmmmmm.me/2019-02-16.html</id>
    <published>2019-02-16T11:20:02.000Z</published>
    <updated>2019-02-18T09:21:22.357Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä»€ä¹ˆæ˜¯NIO"><a href="#ä»€ä¹ˆæ˜¯NIO" class="headerlink" title="ä»€ä¹ˆæ˜¯NIO"></a>ä»€ä¹ˆæ˜¯NIO</h1><p>NIOæ˜¯New I/Oçš„ç®€ç§°ï¼Œä¸æ—§å¼çš„åŸºäºæµçš„I/Oæ–¹æ³•ç›¸å¯¹ï¼Œä»åå­—çœ‹ï¼Œå®ƒè¡¨ç¤ºæ–°çš„ä¸€å¥—Java I/Oæ ‡ å‡†ã€‚å®ƒæ˜¯åœ¨Java 1.4ä¸­è¢«çº³å…¥åˆ°JDKä¸­çš„ï¼Œå¹¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§:<br>â€“ NIOæ˜¯åŸºäºå—(Block,ç¡¬ç›˜ä¸Šçš„å—)çš„ï¼Œå®ƒä»¥å—ä¸ºåŸºæœ¬å•ä½å¤„ç†æ•°æ®ï¼Œä¼ ç»Ÿçš„æ˜¯åŸºäºå­—èŠ‚çš„ï¼Œæœ€å°å•ä½æ˜¯å­—èŠ‚ï¼ŒNIOæœ€å°å•ä½æ˜¯å—ã€‚<br>â€“ ä¸ºæ‰€æœ‰çš„åŸå§‹ç±»å‹æä¾›(Buffer)ç¼“å­˜æ”¯æŒ<br>â€“ å¢åŠ é€šé“(Channel)å¯¹è±¡ï¼Œä½œä¸ºæ–°çš„åŸå§‹ I/O æŠ½è±¡<br>â€“ æ”¯æŒé”å’Œå†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–‡ä»¶è®¿é—®æ¥å£ï¼Œæ‹¿æ–‡ä»¶ç³»ç»Ÿæ¥å®ç°é”ï¼Œå°±æ˜¯æˆ‘ä»¬å¹³å¸¸çš„.logæ–‡ä»¶ã€‚<br>â€“ æä¾›äº†åŸºäºSelectorçš„å¼‚æ­¥ç½‘ç»œI/O</p><h1 id="Buffer-amp-amp-Channel"><a href="#Buffer-amp-amp-Channel" class="headerlink" title="Buffer &amp;&amp; Channel"></a>Buffer &amp;&amp; Channel</h1><p><img alt="" data-original="/images/15503116585564.png"></p><p>æ–‡ä»¶çš„è¯»å†™éƒ½æ˜¯é€šè¿‡Bufferè¯»å†™åˆ°Channelï¼Œç„¶åå†åˆ°æ–‡ä»¶ã€‚Channelå·¦è¾¹å°±æ˜¯å¯¹åº”çš„æˆ‘ä»¬çš„æ–‡ä»¶ã€‚</p><h1 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h1><p>æ¯ä¸ªåŸºæœ¬ç±»å‹éƒ½æœ‰å¯¹åº”çš„buffer<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span></span><br><span class="line">-Buffer</span><br><span class="line">-ByteBuffer</span><br><span class="line">-CharBuffer</span><br><span class="line">-DoubleBuffer</span><br><span class="line">-FloatBUffer</span><br><span class="line">-IntBuffer</span><br><span class="line">-LongBuffer</span><br><span class="line">-ShortBuffer</span><br></pre></td></tr></table></figure><p></p><h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fin = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"d:\\temp_buffer.tmp"</span>)); </span><br><span class="line"><span class="comment">//é€šè¿‡InputStreamå¾—åˆ°channelã€‚</span></span><br><span class="line">FileChannel fc=fin.getChannel();</span><br><span class="line"><span class="comment">//é€šè¿‡ByteBufferåˆ†é…1kçš„å¤§å°çš„buffer</span></span><br><span class="line">ByteBuffer byteBuffer=ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"><span class="comment">//é€šè¿‡channelå°†1kå¤§å°çš„æ•°æ®è¯»åˆ°bufferä¸­ </span></span><br><span class="line">fc.read(byteBuffer);</span><br><span class="line">fc.close(); </span><br><span class="line"><span class="comment">//å¯¹bufferä¸­çš„æ•°æ®è¿›è¡Œè¯»å†™è½¬æ¢ï¼Œåé¢å¯èƒ½è¦å¯¹bufferä¸­çš„æ•°æ®è¿›è¡Œè¯»å–ã€‚</span></span><br><span class="line">byteBuffer.flip();</span><br></pre></td></tr></table></figure><h2 id="NIOå¤åˆ¶æ–‡ä»¶"><a href="#NIOå¤åˆ¶æ–‡ä»¶" class="headerlink" title="NIOå¤åˆ¶æ–‡ä»¶"></a>NIOå¤åˆ¶æ–‡ä»¶</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> nioCopyFile(<span class="built_in">String</span> resource, <span class="built_in">String</span> destination) throws IOException &#123;</span><br><span class="line">FileInputStream fis = <span class="keyword">new</span> FileInputStream(resource); </span><br><span class="line">FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(destination); </span><br><span class="line">FileChannel readChannel = fis.getChannel();<span class="comment">//è¯»æ–‡ä»¶é€šé“</span></span><br><span class="line">FileChannel writeChannel = fos.getChannel();<span class="comment">//å†™æ–‡ä»¶é€šé“</span></span><br><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>); <span class="comment">//è¯»å…¥æ•°æ®ç¼“å­˜</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">buffer.clear();</span><br><span class="line">int len = readChannel.read(buffer); <span class="comment">//è¯»å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">//lenè¯»åˆ°æ•°æ®çš„å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> (len == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="comment">//è¯»å–å®Œæ¯• </span></span><br><span class="line">&#125;</span><br><span class="line">buffer.flip();</span><br><span class="line">writeChannel.write(buffer); </span><br><span class="line"><span class="comment">//å†™å…¥æ–‡ä»¶</span></span><br><span class="line">&#125; </span><br><span class="line">readChannel.close(); </span><br><span class="line">writeChannel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Bufferä¸­æœ‰3ä¸ªé‡è¦çš„å‚æ•°"><a href="#Bufferä¸­æœ‰3ä¸ªé‡è¦çš„å‚æ•°" class="headerlink" title="Bufferä¸­æœ‰3ä¸ªé‡è¦çš„å‚æ•°:"></a>Bufferä¸­æœ‰3ä¸ªé‡è¦çš„å‚æ•°:</h2><p>ä½ç½®(position)ã€å®¹é‡(capactiy)å’Œä¸Šé™(limit)<br>|å‚æ•° |å†™æ¨¡å¼ | è¯»æ¨¡å¼|<br>|â€“|â€“|â€“|<br>|ä½ç½® |å½“å‰ç¼“å†²åŒºçš„ä½ç½®ï¼Œå°†ä»positionçš„ä¸‹ä¸€ä¸ªä½ç½®å†™æ•°æ® |å½“å‰ç¼“å†²åŒºè¯»å–çš„ä½ç½®ï¼Œå°†ä»æ­¤ä½ç½®åï¼Œè¯»å–æ•°æ®|<br>|å®¹é‡|ç¼“å­˜åŒºçš„æ€»å®¹é‡ä¸Šé™|ç¼“å­˜åŒºçš„æ€»å®¹é‡ä¸Šé™|<br>|ä¸Šé™|ç¼“å†²åŒºçš„å®é™…ä¸Šçº¿ï¼Œä»–æ€»æ˜¯å°äºç­‰äºå®¹é‡ã€‚é€šå¸¸æƒ…å†µä¸‹å’Œå®¹é‡ç›¸ç­‰|ä»£è¡¨åˆ»åº¦çš„æ€»å®¹é‡ï¼Œå’Œä¸Šæ¬¡å†™å…¥çš„æ•°æ®é‡ç›¸ç­‰|</p><h3 id="ä»£ç å±•ç¤º"><a href="#ä»£ç å±•ç¤º" class="headerlink" title="ä»£ç å±•ç¤º"></a>ä»£ç å±•ç¤º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer b=ByteBuffer.allocate(<span class="number">15</span>); <span class="comment">//15ä¸ªå­—èŠ‚å¤§å°çš„ç¼“å†²åŒº </span></span><br><span class="line">System.out.println(<span class="string">"limit="</span>+b.limit()+<span class="string">" capacity="</span>+b.capacity()+<span class="string">" position="</span>+b.position()); </span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123; <span class="comment">//å­˜å…¥10ä¸ªå­—èŠ‚æ•°æ®</span></span><br><span class="line">b.put((byte)i); </span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"limit="</span>+b.limit()+<span class="string">" capacity="</span>+b.capacity()+<span class="string">" position="</span>+b.position());</span><br><span class="line">b.flip(); <span class="comment">//é‡ç½®position </span></span><br><span class="line">System.out.println(<span class="string">"limit="</span>+b.limit()+<span class="string">" capacity="</span>+b.capacity()+<span class="string">" position="</span>+b.position());</span><br><span class="line"><span class="keyword">for</span>(int i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">System.out.print(b.get());</span><br><span class="line">&#125;</span><br><span class="line">System.out.println();</span><br><span class="line">System.out.println(<span class="string">"limit="</span>+b.limit()+<span class="string">" capacity="</span>+b.capacity()+<span class="string">" position="</span>+b.position()); b.flip();</span><br><span class="line">System.out.println(<span class="string">"limit="</span>+b.limit()+<span class="string">" capacity="</span>+b.capacity()+<span class="string">" position="</span>+b.position());</span><br></pre></td></tr></table></figure><h3 id="å›¾è§£"><a href="#å›¾è§£" class="headerlink" title="å›¾è§£"></a>å›¾è§£</h3><h4 id="æ–°å»º"><a href="#æ–°å»º" class="headerlink" title="æ–°å»º"></a>æ–°å»º</h4><p><img alt="" data-original="/images/15503116715775.png"></p><h4 id="å­˜å…¥10byte"><a href="#å­˜å…¥10byte" class="headerlink" title="å­˜å…¥10byte"></a>å­˜å…¥10byte</h4><p><img alt="" data-original="/images/15503116881176.png"></p><h4 id="flip"><a href="#flip" class="headerlink" title="flip"></a>flip</h4><p><img alt="" data-original="/images/15503117143136.png"></p><p>è¯¥æ“ä½œä¼šé‡ç½®positionï¼Œé€šå¸¸ï¼Œå°†bufferä»å†™æ¨¡å¼è½¬æ¢ä¸ºè¯» æ¨¡å¼æ—¶éœ€è¦æ‰§è¡Œæ­¤æ–¹æ³• flip()æ“ä½œä¸ä»…é‡ç½®äº†å½“å‰çš„positionä¸º0ï¼Œè¿˜å°†limitè®¾ç½®åˆ°å½“ å‰positionçš„ä½ç½®</p><h4 id="äº”æ¬¡è¯»æ“ä½œ"><a href="#äº”æ¬¡è¯»æ“ä½œ" class="headerlink" title="äº”æ¬¡è¯»æ“ä½œ"></a>äº”æ¬¡è¯»æ“ä½œ</h4><p><img alt="" data-original="/images/15503117236806.png"></p><h4 id="flip-1"><a href="#flip-1" class="headerlink" title="flip"></a>flip</h4><p><img alt="" data-original="/images/15503117513822.png"></p><h2 id="å‡ ä¸ªé‡è¦çš„å‡½æ•°"><a href="#å‡ ä¸ªé‡è¦çš„å‡½æ•°" class="headerlink" title="å‡ ä¸ªé‡è¦çš„å‡½æ•°"></a>å‡ ä¸ªé‡è¦çš„å‡½æ•°</h2><p>public final Buffer rewind()<br>â€“ å°†positionç½®é›¶ï¼Œå¹¶æ¸…é™¤æ ‡å¿—ä½(mark)<br>public final Buffer clear()<br>â€“ å°†positionç½®é›¶ï¼ŒåŒæ—¶å°†limitè®¾ç½®ä¸ºcapacityçš„å¤§å°ï¼Œå¹¶æ¸…é™¤äº†æ ‡å¿—mark<br>public final Buffer flip()<br>â€“ å…ˆå°†limitè®¾ç½®åˆ°positionæ‰€åœ¨ä½ç½®ï¼Œç„¶åå°†positionç½®é›¶ï¼Œå¹¶æ¸…é™¤æ ‡å¿—ä½mark â€“ é€šå¸¸åœ¨è¯»å†™è½¬æ¢æ—¶ä½¿ç”¨</p><h2 id="æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜"><a href="#æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜" class="headerlink" title="æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜"></a>æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(<span class="string">"C:\\mapfile.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">FileChannel fc = raf.getChannel();</span><br><span class="line"><span class="comment">//å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</span></span><br><span class="line">MappedByteBuffer mbb = fc.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, raf.length()); </span><br><span class="line"><span class="keyword">while</span>(mbb.hasRemaining())&#123;</span><br><span class="line">System.out.print((char)mbb.get()); </span><br><span class="line">&#125;</span><br><span class="line">mbb.put(<span class="number">0</span>,(byte)<span class="number">98</span>); <span class="comment">//ä¿®æ”¹æ–‡ä»¶</span></span><br><span class="line">raf.close();</span><br></pre></td></tr></table></figure><h1 id="ç½‘ç»œç¼–ç¨‹"><a href="#ç½‘ç»œç¼–ç¨‹" class="headerlink" title="ç½‘ç»œç¼–ç¨‹"></a>ç½‘ç»œç¼–ç¨‹</h1><h2 id="å¤šçº¿ç¨‹ç½‘ç»œæœåŠ¡å™¨çš„ä¸€èˆ¬ç»“æ„"><a href="#å¤šçº¿ç¨‹ç½‘ç»œæœåŠ¡å™¨çš„ä¸€èˆ¬ç»“æ„" class="headerlink" title="å¤šçº¿ç¨‹ç½‘ç»œæœåŠ¡å™¨çš„ä¸€èˆ¬ç»“æ„"></a>å¤šçº¿ç¨‹ç½‘ç»œæœåŠ¡å™¨çš„ä¸€èˆ¬ç»“æ„</h2><p><img alt="" data-original="/images/15503117616100.png"></p><h2 id="ç®€å•æ¡ˆä¾‹-EchoServer"><a href="#ç®€å•æ¡ˆä¾‹-EchoServer" class="headerlink" title="ç®€å•æ¡ˆä¾‹ EchoServer"></a>ç®€å•æ¡ˆä¾‹ EchoServer</h2><h3 id="EchoServer"><a href="#EchoServer" class="headerlink" title="EchoServer"></a>EchoServer</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span> args[]) &#123; </span><br><span class="line">ServerSocket echoServer = <span class="literal">null</span>; </span><br><span class="line">Socket clientSocket = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">echoServer = <span class="keyword">new</span> ServerSocket(<span class="number">8000</span>); </span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">System.out.println(e); &#125;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123; </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">clientSocket = echoServer.accept(); System.out.println(clientSocket.getRemoteSocketAddress() + <span class="string">" connect!"</span>); </span><br><span class="line">tp.execute(<span class="keyword">new</span> HandleMsg(clientSocket));</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">System.out.println(e); &#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»çº¿ç¨‹åœ¨è¿™é‡Œåˆ¶ä½œä¸€ä¸ªæ¥æ”¶acceptçš„åŠŸèƒ½ã€‚</p><h3 id="HandleMsg"><a href="#HandleMsg" class="headerlink" title="HandleMsg"></a>HandleMsg</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HandleMsg</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="comment">//çœç•¥éƒ¨åˆ†ä¿¡æ¯</span></span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">is = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(clientSocket.getInputStream()));</span><br><span class="line">os = <span class="keyword">new</span> PrintWriter(clientSocket.getOutputStream(), <span class="literal">true</span>); </span><br><span class="line"><span class="comment">// ä»InputStreamå½“ä¸­è¯»å–å®¢æˆ·ç«¯æ‰€å‘é€çš„æ•°æ®</span></span><br><span class="line"><span class="built_in">String</span> inputLine = <span class="literal">null</span>;</span><br><span class="line">long b=System.currentTimeMillis();</span><br><span class="line"><span class="keyword">while</span> ((inputLine = is.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">os.println(inputLine); </span><br><span class="line">&#125;</span><br><span class="line">long e=System.currentTimeMillis();</span><br><span class="line">System.out.println(<span class="string">"spend:"</span>+(e-b)+<span class="string">"ms"</span>); </span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace(); &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line"><span class="comment">//å…³é—­èµ„æº</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»åˆ°ä»€ä¹ˆå°±å›å†™ä»€ä¹ˆ</p><h3 id="EchoServerçš„å®¢æˆ·ç«¯"><a href="#EchoServerçš„å®¢æˆ·ç«¯" class="headerlink" title="EchoServerçš„å®¢æˆ·ç«¯"></a>EchoServerçš„å®¢æˆ·ç«¯</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException &#123;</span><br><span class="line">Socket client = <span class="literal">null</span>;</span><br><span class="line">PrintWriter writer = <span class="literal">null</span>;</span><br><span class="line">BufferedReader reader = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">client = <span class="keyword">new</span> Socket();</span><br><span class="line">client.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">8000</span>)); writer = <span class="keyword">new</span> PrintWriter(client.getOutputStream(), <span class="literal">true</span>); writer.println(<span class="string">"Hello!"</span>);</span><br><span class="line">writer.flush();</span><br><span class="line">reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(client.getInputStream()));</span><br><span class="line">System.out.println(<span class="string">"from server: "</span> + reader.readLine());</span><br><span class="line">&#125; <span class="keyword">catch</span>&#123;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//çœç•¥èµ„æºå…³é—­ </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜:"></a>é—®é¢˜:</h3><p>â€“ ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœå®¢æˆ·ç«¯å‡ºç°å»¶æ—¶ç­‰å¼‚å¸¸ï¼Œçº¿ç¨‹å¯èƒ½ä¼šè¢«å ç”¨å¾ˆé•¿æ—¶é—´ã€‚å› ä¸ºæ•°æ®çš„å‡†å¤‡å’Œè¯»å–éƒ½åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ã€‚<br>â€“ æ­¤æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯æ•°é‡ä¼—å¤šï¼Œå¯èƒ½ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æº</p><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>â€“ éé˜»å¡çš„NIO<br>â€“ æ•°æ®å‡†å¤‡å¥½äº†åœ¨å·¥ä½œ<br><strong><font color="red">æ³¨æ„ï¼šioçœŸæ­£çš„å·¥ä½œåˆ†ä¸ºå‡†å¤‡å’Œè¯»å–ä¸¤ä¸ªéƒ¨åˆ†ã€‚nioå°±æ˜¯åœ¨å‡†å¤‡ç©äº†ä¹‹åæ‰ä¼šåˆ†é…è¯»å–çš„æ“ä½œã€‚</font></strong></p><h2 id="æ¨¡æ‹Ÿä½æ•ˆçš„å®¢æˆ·ç«¯"><a href="#æ¨¡æ‹Ÿä½æ•ˆçš„å®¢æˆ·ç«¯" class="headerlink" title="æ¨¡æ‹Ÿä½æ•ˆçš„å®¢æˆ·ç«¯"></a>æ¨¡æ‹Ÿä½æ•ˆçš„å®¢æˆ·ç«¯</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> ExecutorService tp=Executors.newCachedThreadPool(); private <span class="keyword">static</span> final int sleep_time=<span class="number">1000</span>*<span class="number">1000</span>*<span class="number">1000</span>;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123; </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">client = <span class="keyword">new</span> Socket();</span><br><span class="line">client.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"localhost"</span>, <span class="number">8000</span>)); </span><br><span class="line">writer = <span class="keyword">new</span> PrintWriter(client.getOutputStream(), <span class="literal">true</span>); writer.print(<span class="string">"H"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.print(<span class="string">"e"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.print(<span class="string">"l"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.print(<span class="string">"l"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.print(<span class="string">"o"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.print(<span class="string">"!"</span>);</span><br><span class="line">LockSupport.parkNanos(sleep_time);</span><br><span class="line">writer.println();</span><br><span class="line">writer.flush();</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡å™¨è¾“å‡º"><a href="#æœåŠ¡å™¨è¾“å‡º" class="headerlink" title="æœåŠ¡å™¨è¾“å‡º"></a>æœåŠ¡å™¨è¾“å‡º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spend:<span class="number">6000</span>ms </span><br><span class="line">spend:<span class="number">6000</span>ms </span><br><span class="line">spend:<span class="number">6000</span>ms </span><br><span class="line">spend:<span class="number">6001</span>ms </span><br><span class="line">spend:<span class="number">6002</span>ms</span><br><span class="line">spend:<span class="number">6002</span>ms </span><br><span class="line">spend:<span class="number">6002</span>ms </span><br><span class="line">spend:<span class="number">6002</span>ms </span><br><span class="line">spend:<span class="number">6003</span>ms </span><br><span class="line">spend:<span class="number">6003</span>ms</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„6ç§’èŠ±åœ¨äº†å“ªé‡Œï¼Ÿ<br>æ³¨æ„ä¸Šé¢çš„ä»£ç å—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">long b=System.currentTimeMillis();</span><br><span class="line"><span class="keyword">while</span> ((inputLine = is.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">os.println(inputLine); </span><br><span class="line">&#125;</span><br><span class="line">long e=System.currentTimeMillis();</span><br><span class="line">System.out.println(<span class="string">"spend:"</span>+(e-b)+<span class="string">"ms"</span>);</span><br></pre></td></tr></table></figure><p>è¯»å’Œå†™ä¸€å…±èŠ±äº†å…­ç§’ï¼Œè¯»çš„æ—¶å€™èŠ±äº†å¾ˆå¤šæ—¶é—´è¯»ä¸åˆ°</p><h1 id="ç½‘ç»œç¼–ç¨‹NIO"><a href="#ç½‘ç»œç¼–ç¨‹NIO" class="headerlink" title="ç½‘ç»œç¼–ç¨‹NIO"></a>ç½‘ç»œç¼–ç¨‹NIO</h1><p><img alt="" data-original="/images/15503117817368.png"></p><p><strong><font color="red">æŠŠæ•°æ®å‡†å¤‡å¥½äº†å†é€šçŸ¥æˆ‘ </font></strong>Channelæœ‰ç‚¹ç±»ä¼¼äºæµï¼Œä¸€ä¸ªChannelå¯ä»¥å’Œæ–‡ä»¶æˆ–è€…ç½‘ç»œSocketå¯¹åº”<br>Selectorï¼šå¤šè·¯å¤ç”¨é€‰æ‹©å™¨ Selectorï¼Œå®ƒæ˜¯NIOç¼–ç¨‹çš„åŸºç¡€ï¼Œéå¸¸é‡è¦ï¼Œå¤šè·¯å¤ç”¨å™¨æä¾›é€‰æ‹©å·²ç»å°±ç»ªçš„ä»»åŠ¡çš„èƒ½åŠ›ã€‚ç®€å•è¯´ï¼Œå°±æ˜¯Selectorä¼šä¸æ–­åœ°è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„é€šé“ï¼ˆChannelï¼‰ å‡å¦‚æŸä¸ªé€šé“å‘ç”Ÿäº†è¯»å†™æ“ä½œï¼Œè¿™ä¸ªé€šé“å°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢«Selectorè½®è¯¢å‡ºæ¥ï¼Œç„¶åé€šè¿‡SelectionKeyå¯ä»¥å–å¾—å°±ç»ªçš„Channelé›†åˆï¼Œä»è€Œè¿›è¡Œåç»­çš„IOæ“ä½œã€‚ä¸€ä¸ªSelectorå¯ä»¥è´Ÿè´£æˆåƒä¸Šä¸‡Channelé€šé“ï¼Œæ²¡æœ‰ä¸Šçº¿ï¼Œè¿™ä¹Ÿæ˜¯JDKä½¿ç”¨äº†epollä»£æ›¿äº†ä¼ ç»Ÿçš„selectå®ç°ï¼Œè·å¾—è¿æ¥å¥æŸ„æ²¡æœ‰é™åˆ¶ã€‚è¿™å°±æ„å‘³ç€ æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£Selectorçš„è½®è¯¢ï¼Œå°±å¯ä»¥æ¥å…¥æˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯ã€‚<br>Selectorå‡†å¤‡å¥½æ•°æ®åï¼Œè¿”å›SelectionKey SelectionKeyè¡¨ç¤ºä¸€å¯¹Selectorå’ŒChannelçš„å…³ç³»ï¼Œ ä»SelectionKeyä¸­å¯ä»¥å¾—åˆ°Channnel(æ•°æ®å·²ç»å‡†å¤‡)ï¼Œ å¹¶è¯»å–æ•°æ®<br>select()å’ŒselectNow()ï¼š<br>selectæ–¹æ³•å¦‚æœæ²¡æœ‰ä¸€ä¸ªchannelå‡†å¤‡å¥½æ•°æ®çš„è¯ï¼Œå°±ä¼šå‡ºç°é˜»å¡ï¼ŒselectNowä¸è®ºæœ‰æ²¡æœ‰å‡†å¤‡å¥½ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ä¼šå‡ºç°é˜»å¡ã€‚</p><h1 id="å‚è€ƒä»£ç "><a href="#å‚è€ƒä»£ç " class="headerlink" title="å‚è€ƒä»£ç "></a>å‚è€ƒä»£ç </h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.spi.SelectorProvider;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">NioTest</span> </span>&#123;</span><br><span class="line">private <span class="keyword">void</span> StartServer ()throws Exception&#123;</span><br><span class="line">final Selector selector = SelectorProvider.provider().openSelector();</span><br><span class="line">ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line"><span class="comment">//å°†ServerSocketChannelè®¾ç½®ä¸ºéé˜»å¡çš„ï¼Œacceptä¸ä¼šä¸€ç›´ç­‰å¾…ï¼Œå³æ•°æ®å‡†å¤‡å¥½äº†ï¼Œç»™ä¸ªé€šçŸ¥ã€‚</span></span><br><span class="line">ssc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">InetSocketAddress isa = <span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>);</span><br><span class="line">ssc.socket().bind(isa);</span><br><span class="line"><span class="comment">//ç»™channelæ³¨å†Œä¸€ä¸ªæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå³acceptäº‹ä»¶ï¼Œå¦‚æœæœ‰äººacceptï¼Œselectorå°±å‘Šè¯‰ssc</span></span><br><span class="line">SelectionKey acceptKey = ssc.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"><span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line"><span class="comment">//å·²ç»æœ‰æ•°æ®å‡†å¤‡å¥½äº†ï¼ˆè¯»ã€å†™ã€acceptï¼‰</span></span><br><span class="line">selector.select();</span><br><span class="line"><span class="comment">//if (selector.selectNow() == 0) &#123;</span></span><br><span class="line"><span class="comment">//continue;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="built_in">Set</span> readyKeys = selector.selectedKeys();</span><br><span class="line">Iterator i = readyKeys.iterator();</span><br><span class="line">long e = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">SelectionKey sk = (SelectionKey) i.next();</span><br><span class="line"><span class="comment">//removeæ‰ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åé¢é‡å¤å¤„ç†ã€‚</span></span><br><span class="line">i.remove();</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªacceptçš„äº‹ä»¶</span></span><br><span class="line"><span class="keyword">if</span> (sk.isAcceptable()) &#123;</span><br><span class="line">doAccept(sk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªè¯»çš„äº‹ä»¶ï¼Œè¯»å·²ç»å‡†å¤‡å¥½äº†</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(sk.isValid()&amp;&amp;sk.isReadable())&#123;</span><br><span class="line"><span class="comment">//å°†æ—¶é—´åšä¸€ä¸ªè®°å½•</span></span><br><span class="line"><span class="keyword">if</span> (!geym_time_stat.containsKey(((SocketChannel) sk.channel()).socket())) &#123;</span><br><span class="line">geym_time_stat.put(((SocketChannel) sk.channel()).socket(),System.currentTimeMillis() );</span><br><span class="line">doRead(sk);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªå†™çš„äº‹ä»¶</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (sk.isValid() &amp;&amp; sk.isWritable()) &#123;</span><br><span class="line">doWrite(sk);</span><br><span class="line">e = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//è€—æ—¶çš„ç»Ÿè®¡</span></span><br><span class="line">long b = geym_time_stat.remove(((SocketChannel) sk.channel()).socket());</span><br><span class="line">System.out.println(<span class="string">"spendï¼š"</span>+(e-b)+<span class="string">"ms"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HandleMsg</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">SelectionKey sk;</span><br><span class="line">ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">public HandleMsg(SelectionKey sk,ByteBuffer bb)&#123;</span><br><span class="line"><span class="keyword">this</span>.sk= sk;</span><br><span class="line"><span class="keyword">this</span>.bb = bb;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="comment">//å°†ä¹‹å‰æ·»åŠ çš„é™„ä»¶æ‹¿å‡ºæ¥</span></span><br><span class="line">EchoClient echoClient = (EchoClient) sk.attachment();</span><br><span class="line">echoClient.enqueue(bb);</span><br><span class="line"><span class="comment">//å°†SelectionKeyæ„Ÿå…´è¶£çš„äº‹ä»¶ä¿®æ”¹ä¸ºOP_READå’ŒOP_WRITEï¼›</span></span><br><span class="line">sk.interestOps(SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line"><span class="comment">//å¼ºè¿«Selectorç«‹å³è¿”å›</span></span><br><span class="line">selector.wakeup();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">void</span> doRead(SelectionKey sk)&#123;</span><br><span class="line">SocketChannel channel = (SocketChannel) sk.channel();</span><br><span class="line">ByteBuffer bb = ByteBuffer.allocate(<span class="number">8192</span>);</span><br><span class="line">int len;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">len = channel.read(bb);</span><br><span class="line"><span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">disconnect(sk);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"Field to read from client"</span>);</span><br><span class="line">e.printStackTrace();</span><br><span class="line">disconnect(sk);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">bb.flip();</span><br><span class="line">tp.excute(<span class="keyword">new</span> HandleMsg(sk, bb));</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">void</span> doWrite(SelectionKey sk)&#123;</span><br><span class="line">SelectableChannel channel = sk.channel();</span><br><span class="line">EchoClient echoClient = (EchoClient) sk.attachment();</span><br><span class="line">LinkedList&lt;ByteBuffer&gt; outq =  echoClient.getOutputQueue();</span><br><span class="line">ByteBuffer bb = outq.getLast();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//å›å†™åˆ°channelä¸­</span></span><br><span class="line">int len = channel.write(bb);</span><br><span class="line"><span class="keyword">if</span> (len == <span class="number">-1</span>) &#123;</span><br><span class="line">disconnect(sk);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bb.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">outq.removeLast();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(<span class="string">"Faild to write to client ."</span>);</span><br><span class="line">e.printStackTrace();</span><br><span class="line">disconnect(sk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é˜Ÿåˆ—ä¸­çš„æ•°æ®å·²ç»å›å†™å®Œæ¯•çš„è¯</span></span><br><span class="line"><span class="keyword">if</span> (outq.size() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//å°†å¯¹å†™äº‹ä»¶æ„Ÿå…´è¶£å»æ‰ã€‚</span></span><br><span class="line">sk.interestOps(SelectionKey.OP_READ);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">void</span> doAccept(SelectionKey sk)&#123;</span><br><span class="line">ServerSocketChannel server = (ServerSocketChannel) sk.channel();</span><br><span class="line">SocketChannel clientChannel;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">clientChannel = server.accept();</span><br><span class="line">clientChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//å¸Œæœ›èƒ½è¯»æ•°æ®</span></span><br><span class="line">SelectionKey clientKey = clientChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">EchoClient echoClient = <span class="keyword">new</span> EchoClient();</span><br><span class="line"><span class="comment">//å¢åŠ ä¸€ä¸ªé™„ä»¶ç»™Key</span></span><br><span class="line">clientKey.attach(echoClient);</span><br><span class="line">InetAddress clientAddress = clientChannel.socket().getInetAddress();</span><br><span class="line">System.out.println(<span class="string">"Accepted connection from "</span>+clientAddress.getHostAddress());</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(<span class="string">"Faild to accept new client"</span>);</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span></span>&#123;</span><br><span class="line">LinkedList&lt;ByteBuffer&gt; outq;</span><br><span class="line">EchoClient()&#123;</span><br><span class="line">outq = <span class="keyword">new</span> LinkedList&lt;ByteBuffer&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¯»åˆ°æ•°æ®å°±å¾€é‡Œé¢å¡</span></span><br><span class="line">public <span class="keyword">void</span> enqueue(ByteBuffer bb)&#123;</span><br><span class="line">outq.addFirst(bb);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯é€šè¿‡nioçš„æ–¹å¼å®ç°ä¸Šé¢çš„åŠŸèƒ½ï¼Œä»6så¤šå˜ä¸ºäº†å‡ æ¯«ç§’ï¼Œå› ä¸ºåªæ˜¯éƒ¨åˆ†ä»£ç ï¼Œæ‰€ä»¥æ²¡æœ‰è¿è¡Œç»“æœã€‚<br>æ€»ç»“:<br>â€“ NIOä¼šå°†æ•°æ®å‡†å¤‡å¥½åï¼Œå†äº¤ç”±åº”ç”¨è¿›è¡Œå¤„ç†ï¼Œæ•°æ®å¦‚æœæ²¡æœ‰å‡†å¤‡å¥½ï¼Œæ˜¯ä¸ä¼šè¿›å…¥åˆ°åº”ç”¨ä¸­çš„ï¼Œæ•°æ®çš„è¯»å–è¿‡ç¨‹ä¾ç„¶åœ¨åº”ç”¨çº¿ç¨‹ä¸­å®Œæˆ ï¼Œç­‰å¾…çš„æ—¶é—´å‰¥ç¦»åˆ°ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­å»ç­‰å¾…ï¼ˆselector.select();ï¼‰ã€‚<br>â€“ èŠ‚çœæ•°æ®å‡†å¤‡æ—¶é—´(å› ä¸ºSelectorå¯ä»¥å¤ç”¨)</p><h1 id="AIO"><a href="#AIO" class="headerlink" title="AIO"></a>AIO</h1><p>å¼‚æ­¥io<br>ä¸Šé¢çš„NIOåªæ˜¯å°†ç­‰å¾…çš„æ—¶é—´å‰¥ç¦»åˆ°å°‘æ•°çš„çº¿ç¨‹ä¸­ï¼Œé¿å…å¤§é‡çš„çº¿ç¨‹ç­‰å¾…ï¼Œé€ æˆçš„èµ„æºæµªè´¹ï¼ŒAIOç­‰ä½ å†™å®Œäº†æˆ–è€…è¯»å®Œäº†å†é€šçŸ¥æˆ‘ã€‚ä¸éœ€è¦è¯»ï¼Œä¹Ÿä¸éœ€è¦å†™ï¼Œåªéœ€è¦ç­‰ç³»ç»ŸæŠŠæ•°æ®éƒ½å¤„ç†å®Œäº†ä¹‹åï¼ŒæŠŠå›è°ƒå‡½æ•°æ”¾è¿›å»ï¼Œå°±ä¼šæ‰§è¡Œï¼ŒAIOä¸ä¼šåŠ å¿«ioï¼Œioæœ¬èº«çš„é€Ÿåº¦å¹¶æ²¡æœ‰åŠ å¿«ï¼Œåªæ˜¯æ”¹å˜äº†åŸæ¥çš„çº¿ç¨‹å¯¹ioçš„å¤„ç†æ–¹å¼ï¼Œçœ‹èµ·æ¥æ˜¯å˜å¿«äº†ã€‚</p><h2 id="ç‰¹ç‚¹æ€»ç»“ï¼š"><a href="#ç‰¹ç‚¹æ€»ç»“ï¼š" class="headerlink" title="ç‰¹ç‚¹æ€»ç»“ï¼š"></a>ç‰¹ç‚¹æ€»ç»“ï¼š</h2><p>è¯»å®Œäº†å†é€šçŸ¥æˆ‘<br>ä¸ä¼šåŠ å¿«IOï¼Œåªæ˜¯åœ¨è¯»å®Œåè¿›è¡Œé€šçŸ¥<br>ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†</p><h2 id="åŸºæœ¬æ€æƒ³"><a href="#åŸºæœ¬æ€æƒ³" class="headerlink" title="åŸºæœ¬æ€æƒ³"></a>åŸºæœ¬æ€æƒ³</h2><p>ç”¨åˆ°çš„ç±»<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AsynchronousServerSocketChannel</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server = AsynchronousServerSocketChannel.open().bind(<span class="keyword">new</span> InetSocketAddress(PORT));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨serverä¸Šçš„acceptæ–¹æ³•<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public abstract &lt;A&gt; <span class="keyword">void</span> accept(A attachment,</span><br><span class="line">CompletionHandler&lt;AsynchronousSocketChannel,? <span class="keyword">super</span> A&gt;handler);</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºAIOæ˜¯å¼‚æ­¥çš„ï¼Œå°†acceptè°ƒç”¨äº†ä¹‹åç«‹å³è¿”å›ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£æ‹¿åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼ŒCompletionHandler&lt;AsynchronousSocketChannel,? super A&gt;handlerè¿™ä¸ªæ¥å£çš„ä½œç”¨å°±æ˜¯åœ¨çœŸæ­£acceptçš„æ—¶å€™ï¼Œå°†acceptå¾—åˆ°çš„æ•°æ®ä¼ ç»™handlerï¼Œä¾›åé¢çš„ç›¸å…³æ“ä½œä½¿ç”¨ã€‚</p><h2 id="å…¶ä»–çš„æ–¹æ³•"><a href="#å…¶ä»–çš„æ–¹æ³•" class="headerlink" title="å…¶ä»–çš„æ–¹æ³•"></a>å…¶ä»–çš„æ–¹æ³•</h2><p>AsynchronousSocketChannel<br>å› ä¸ºæ˜¯å¼‚æ­¥çš„ï¼Œè‚¯å®šä¸èƒ½è¯»å®Œäº†ä¹‹åå†è¿”å›ï¼Œæ‰€ä»¥æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ç«‹å³è¿”å›çš„<br>â€“ read</p><p><img alt="" data-original="/images/15503118004273.png"><br>TimeUnitæ˜¯è¶…æ—¶æ—¶é—´<br>ç¬¬ä¸‰ä¸ªå‡½æ•°åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯ä¼šè¿”å›ä¸€ä¸ªfutureï¼Œå‘ŠçŸ¥è¯»åˆ°äº†ç¬¬å‡ ä¸ªå­—èŠ‚<br>ç¬¬å››ä¸ªå‡½æ•°æ˜¯è¯»åˆ°äº†ByteBufferæ•°ç»„ä¸­ï¼Œå› ä¸ºç½‘ç»œæŠ¥æ–‡çš„å‰äºŒåï¼ˆä¸¾ä¾‹ï¼‰ä¸ªå­—èŠ‚æ˜¯æ— ç”¨çš„ï¼Œç›´æ¥å‰¥ç¦»æ‰ï¼Œèƒ½ç›´æ¥æ‹¿åˆ°æœ‰ç”¨çš„æ•°æ®ã€‚<br>â€“ write<br><img alt="" data-original="/images/15503118085609.png"></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server.accept(<span class="literal">null</span>, <span class="keyword">new</span> CompletionHandler&lt;AsynchronousSocketChannel, <span class="built_in">Object</span>&gt;() &#123;</span><br><span class="line">final ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">  ç½‘ç»œç¼–ç¨‹ AIO</span><br><span class="line">public <span class="keyword">void</span> completed(AsynchronousSocketChannel result, <span class="built_in">Object</span> attachment) &#123;</span><br><span class="line">System.out.println(Thread.currentThread().getName());   Future&lt;Integer&gt; writeResult=<span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">buffer.clear();</span><br><span class="line">result.read(buffer).get(<span class="number">100</span>, TimeUnit.SECONDS); </span><br><span class="line">buffer.flip();</span><br><span class="line">writeResult=result.write(buffer);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123; e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (TimeoutException e) &#123; e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123; <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//æ‰§è¡Œå®Œäº†ä¹‹åå†æ¬¡æ‰§è¡Œacceptï¼Œé˜²æ­¢æ‰§è¡Œå®Œäº†æ²¡äº‹å¹²äº†ã€‚</span></span><br><span class="line">server.accept(<span class="literal">null</span>, <span class="keyword">this</span>);</span><br><span class="line">writeResult.get(); </span><br><span class="line">result.close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(e.toString()); &#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> failed(Throwable exc, <span class="built_in">Object</span> attachment) &#123;</span><br><span class="line">System.out.println(<span class="string">"failed: "</span> + exc); </span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯acceptçš„ä»£ç å®ç°ï¼Œ</p><h1 id="ä¸ºä»€ä¹ˆéœ€è¦äº†è§£NIOå’ŒAIO"><a href="#ä¸ºä»€ä¹ˆéœ€è¦äº†è§£NIOå’ŒAIO" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦äº†è§£NIOå’ŒAIO?"></a>ä¸ºä»€ä¹ˆéœ€è¦äº†è§£NIOå’ŒAIO?</h1><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯NIO&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯NIO&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯NI
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šå¹¶è¡Œè®¾è®¡æ¨¡å¼</title>
    <link href="http://mmmmmm.me/2019-02-13.html"/>
    <id>http://mmmmmm.me/2019-02-13.html</id>
    <published>2019-02-13T11:20:02.000Z</published>
    <updated>2019-02-18T09:21:21.336Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼"><a href="#ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼" class="headerlink" title="ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼"></a>ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼</h1><p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œè®¾è®¡æ¨¡å¼(design pattern)æ˜¯å¯¹è½¯ä»¶è®¾è®¡ä¸­æ™®éå­˜åœ¨(åå¤å‡ºç°)çš„å„ç§é—®é¢˜ ï¼Œæ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªæœ¯è¯­æ˜¯ç”±åŸƒé‡Œå¸ŒÂ·ä¼½ç›(Erich Gamma)ç­‰äººåœ¨1990å¹´ä»£ä»å»ºç­‘è®¾è®¡é¢† åŸŸå¼•å…¥åˆ°è®¡ç®—æœºç§‘å­¦çš„ã€‚<br>Richard Helm, Ralph Johnson ,John Vlissides (Gof) å’ŒGammaåˆç§°å››äººå¸®<br>ã€Šè®¾è®¡æ¨¡å¼:å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ æ”¶å½• 23ç§æ¨¡å¼<br>â€“ è§‚å¯Ÿè€…æ¨¡å¼<br>â€“ ç­–ç•¥æ¨¡å¼<br>â€“ è£…é¥°è€…æ¨¡å¼<br>â€“ äº«å…ƒæ¨¡å¼<br>â€“ æ¨¡æ¿æ–¹æ³•<br>â€“ â€¦..</p><h2 id="æ¶æ„æ¨¡å¼"><a href="#æ¶æ„æ¨¡å¼" class="headerlink" title="æ¶æ„æ¨¡å¼"></a>æ¶æ„æ¨¡å¼</h2><p>â€“ MVC<br>â€“ åˆ†å±‚</p><h2 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h2><p>â€“ æç‚¼ç³»ç»Ÿä¸­çš„ç»„ä»¶</p><h2 id="ä»£ç æ¨¡å¼-æˆä¾‹-Idiom"><a href="#ä»£ç æ¨¡å¼-æˆä¾‹-Idiom" class="headerlink" title="ä»£ç æ¨¡å¼(æˆä¾‹ Idiom)"></a>ä»£ç æ¨¡å¼(æˆä¾‹ Idiom)</h2><p>â€“ ä½å±‚æ¬¡ï¼Œä¸ç¼–ç ç›´æ¥ç›¸å…³<br>â€“ å¦‚DCL</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123; </span><br><span class="line"><span class="built_in">String</span> name; </span><br><span class="line">int birthYear; </span><br><span class="line">byte[] raw;</span><br><span class="line">public boolean equals(<span class="built_in">Object</span> obj)&#123; </span><br><span class="line"><span class="keyword">if</span> (!obj <span class="keyword">instanceof</span> Person)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">Person other = (Person)obj; </span><br><span class="line"><span class="keyword">return</span> name.equals(other.name)</span><br><span class="line">&amp;&amp; birthYear == other.birthYear</span><br><span class="line">&amp;&amp; Arrays.equals(raw, other.raw); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int hashCode()&#123; </span><br><span class="line">... </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h1><p>å•ä¾‹å¯¹è±¡çš„ç±»å¿…é¡»ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨ã€‚è®¸å¤šæ—¶å€™æ•´ä¸ªç³»ç»Ÿåªéœ€è¦æ‹¥æœ‰ä¸€ä¸ªçš„å…¨å±€å¯¹è±¡ï¼Œè¿™æ · æœ‰åˆ©äºæˆ‘ä»¬åè°ƒç³»ç»Ÿæ•´ä½“çš„è¡Œä¸º<br>æ¯”å¦‚:å…¨å±€ä¿¡æ¯é…ç½®<br>åœ¨å¤šçº¿ç¨‹ä¸­é€šè¿‡å•ä¾‹æ¨¡å¼ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å¤šæ¬¡åˆ›å»ºå¯¹è±¡ã€‚</p><h2 id="æ™®é€šå•ä¾‹"><a href="#æ™®é€šå•ä¾‹" class="headerlink" title="æ™®é€šå•ä¾‹"></a>æ™®é€šå•ä¾‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">private Singleton()&#123;</span><br><span class="line">System.out.println(<span class="string">"Singleton is create"</span>);</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">public <span class="keyword">static</span> Singleton getInstance() &#123;</span><br><span class="line"><span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½•æ—¶äº§ç”Ÿå®ä¾‹ ä¸å¥½æ§åˆ¶</p><h2 id="å‡å¦‚å•ä¾‹ä¸­æœ‰æŸä¸ªå­—æ®µ"><a href="#å‡å¦‚å•ä¾‹ä¸­æœ‰æŸä¸ªå­—æ®µ" class="headerlink" title="å‡å¦‚å•ä¾‹ä¸­æœ‰æŸä¸ªå­—æ®µ"></a>å‡å¦‚å•ä¾‹ä¸­æœ‰æŸä¸ªå­—æ®µ</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œäº§ç”Ÿå®ä¾‹çš„æ—¶é—´æ˜¯è°ƒç”¨getinstanceæ–¹æ³•çš„æ—¶å€™ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯Singletonå¯¹è±¡ç¬¬ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶å€™ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> int STATUS=<span class="number">1</span>;</span><br><span class="line">private Singleton()&#123;</span><br><span class="line">System.out.println(<span class="string">"Singleton is create"</span>); </span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton(); </span><br><span class="line">public <span class="keyword">static</span> Singleton getInstance() &#123;</span><br><span class="line"><span class="keyword">return</span> instance; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Singleton.STATUS);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton is create <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦è¾“å‡ºSTATUSè¿™ä¸ªå­—æ®µï¼Œå»è®¿é—®äº†Singletonè¿™ä¸ªç±»ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¥½çš„åœ°æ–¹ã€‚</p><h2 id="æ”¹è¿›çš„å•ä¾‹"><a href="#æ”¹è¿›çš„å•ä¾‹" class="headerlink" title="æ”¹è¿›çš„å•ä¾‹"></a>æ”¹è¿›çš„å•ä¾‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</span><br><span class="line">private LazySingleton() &#123;</span><br><span class="line">System.out.println(<span class="string">"LazySingleton is create"</span>); </span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">static</span> LazySingleton instance = <span class="literal">null</span>;</span><br><span class="line">public <span class="keyword">static</span> synchronized LazySingleton getInstance() &#123;</span><br><span class="line"><span class="keyword">if</span> (instance == <span class="literal">null</span>)</span><br><span class="line">instance = <span class="keyword">new</span> LazySingleton();</span><br><span class="line"><span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸Šé¢çš„ä¸€ç‚¹å°bugï¼Œæ‰€ä»¥è¡ç”Ÿå‡ºäº†è¿™ç§å•ä¾‹æ¨¡å¼ï¼Œåªæœ‰æ˜¯ç¬¬ä¸€æ¬¡ï¼ˆinstance=nullï¼‰çš„æ—¶å€™æ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œæ˜¯ä¸€ä¸ªå»¶è¿ŸåŠ è½½çš„è¿‡ç¨‹ï¼ŒåŒæ—¶é˜²æ­¢å¤šçº¿ç¨‹è¿›å…¥æ­¤ç±»è€Œåˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œæ‰€ä»¥åœ¨æ–¹æ³•ä¸ŠåŠ å…¥äº†synchronizedå…³é”®å­—ï¼Œä¿è¯å½“æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›æ¥çš„æ—¶å€™ï¼Œå…¶ä»–çš„çº¿ç¨‹è¿›ä¸æ¥ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¿›å…¥if (instance == null)è¿™å¥è¯ï¼Œä¸ä¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œåˆ¤æ–­ã€‚ä½†æ˜¯synchronizedè¿™ä¸ªé”ï¼Œå¯èƒ½å¯¹äºé«˜å¹¶å‘ï¼Œå¯èƒ½æœ‰ç‚¹å½±å“ã€‚</p><h2 id="ä»£ç†æ¨¡å¼å†å‡çº§"><a href="#ä»£ç†æ¨¡å¼å†å‡çº§" class="headerlink" title="ä»£ç†æ¨¡å¼å†å‡çº§"></a>ä»£ç†æ¨¡å¼å†å‡çº§</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">StaticSingleton</span> </span>&#123;</span><br><span class="line">private StaticSingleton()&#123;</span><br><span class="line">System.out.println(<span class="string">"StaticSingleton is create"</span>); </span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">private <span class="keyword">static</span> StaticSingleton instance = <span class="keyword">new</span> StaticSingleton(); </span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> StaticSingleton getInstance() &#123; </span><br><span class="line"><span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…ä¸Šé¢çš„synchronizedå¸¦æ¥çš„é«˜å¹¶å‘çš„æ€§èƒ½é—®é¢˜ï¼Œè¡ç”Ÿå‡ºäº†è¿™ç§æ–¹å¼ã€‚<br>å°†new StaticSingletonæ”¾åˆ°å†…éƒ¨ç±»ä¸­ï¼Œè°ƒç”¨getInstanceæ–¹æ³•çš„æ—¶å€™å†è®¿é—®StaticSingletonç±»ä¸­çš„instanceï¼Œå†new StaticSingletonæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœæœ‰ä¸€ä¸ªstaticçš„STATUSçš„å˜é‡çš„æ—¶å€™ï¼Œå»è®¿é—®å®ƒï¼Œæ˜¯ä¸ä¼šåˆ›å»ºæœ¬ç±»çš„å®ä¾‹çš„ï¼Œå› ä¸ºå¹¶æ²¡æœ‰å¯¹å†…éƒ¨ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥ï¼Œåªæœ‰é€šè¿‡è®¿é—®getInstanceï¼ˆï¼‰è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™æ‰ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚<br>é€šè¿‡è¿™ç§æ–¹æ³•ä¹Ÿèµ·åˆ°ä¸€ç§å»¶è¿ŸåŠ è½½çš„æ•ˆæœï¼Œè€Œä¸”æ²¡æœ‰é«˜å¹¶å‘çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå¹¶æ²¡æœ‰åŠ é”ã€‚</p><h1 id="ä¸å˜æ¨¡å¼"><a href="#ä¸å˜æ¨¡å¼" class="headerlink" title="ä¸å˜æ¨¡å¼"></a>ä¸å˜æ¨¡å¼</h1><p>ä¸€ä¸ªç±»çš„å†…éƒ¨çŠ¶æ€åˆ›å»ºåï¼Œåœ¨æ•´ä¸ªç”Ÿå‘½æœŸé—´éƒ½ä¸ä¼šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±æ˜¯ä¸å˜ç±»<br>ä¸å˜æ¨¡å¼ä¸éœ€è¦åŒæ­¥ï¼Œå› ä¸ºä¸å˜æ¨¡å¼æ˜¯ä¸€ä¸ªåªè¯»çš„å¯¹è±¡ã€‚</p><h2 id="ä¸å˜æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„"><a href="#ä¸å˜æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="ä¸å˜æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„"></a>ä¸å˜æ¨¡å¼æ˜¯å¦‚ä½•å®ç°çš„</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public final <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123; </span><br><span class="line"><span class="comment">//ç¡®ä¿æ— å­ç±»</span></span><br><span class="line">private final <span class="built_in">String</span> no; </span><br><span class="line"><span class="comment">//ç§æœ‰å±æ€§ï¼Œä¸ä¼šè¢«å…¶ä»–å¯¹è±¡è·å– </span></span><br><span class="line">private final <span class="built_in">String</span> name;</span><br><span class="line"><span class="comment">//finalä¿è¯å±æ€§ä¸ä¼šè¢«2æ¬¡èµ‹å€¼ </span></span><br><span class="line">private final double price;</span><br><span class="line">public Product(<span class="built_in">String</span> no, <span class="built_in">String</span> name, double price) &#123;<span class="comment">//åœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¿…é¡»æŒ‡å®šæ•°æ®</span></span><br><span class="line"><span class="keyword">super</span>();</span><br><span class="line"><span class="comment">//å› ä¸ºåˆ›å»ºä¹‹åï¼Œæ— æ³•è¿›è¡Œä¿®æ”¹ this.no = no;</span></span><br><span class="line"><span class="keyword">this</span>.name = name; <span class="keyword">this</span>.price = price;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getNo() &#123;</span><br><span class="line"><span class="keyword">return</span> no;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getName() &#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line">public double getPrice() &#123;</span><br><span class="line"><span class="keyword">return</span> price;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ç±»å˜æˆfinalçš„ï¼Œä¿è¯æ²¡æœ‰å­ç±»ï¼Œé˜²æ­¢å­ç±»ç»§æ‰¿å®ƒï¼Œå˜æˆå¯å˜çš„ã€‚<br>å°†æ‰€æœ‰çš„å±æ€§å˜æˆfinalçš„ï¼Œä¿è¯æ‰€æœ‰çš„å­—æ®µåªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ã€‚</p><h2 id="ä¸å˜æ¨¡å¼çš„æ¡ˆä¾‹"><a href="#ä¸å˜æ¨¡å¼çš„æ¡ˆä¾‹" class="headerlink" title="ä¸å˜æ¨¡å¼çš„æ¡ˆä¾‹"></a>ä¸å˜æ¨¡å¼çš„æ¡ˆä¾‹</h2><p>java.lang.String<br>æ‰€æœ‰åƒæ˜¯ä¿®æ”¹Stringçš„æ“ä½œï¼ˆreplaceï¼Œsubstringç­‰ï¼‰ï¼Œå®é™…ä¸Šæ˜¯ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„Stringå¯¹è±¡<br>java.lang.Boolean<br>java.lang.Byte<br>java.lang.Character<br>java.lang.Double<br>java.lang.Float<br>java.lang.Integer<br>java.lang.Long<br>java.lang.Short<br>ä»¥ä¸Šæ‰€æœ‰çš„çœ‹ä¼¼æ”¹å˜äº†åŸæ¥å¯¹è±¡çš„æ“ä½œéƒ½æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p><h1 id="Futureæ¨¡å¼"><a href="#Futureæ¨¡å¼" class="headerlink" title="Futureæ¨¡å¼"></a>Futureæ¨¡å¼</h1><h2 id="æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨"><a href="#æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨" class="headerlink" title="æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨"></a>æ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨</h2><p>è¢«é›†æˆåœ¨å¯jdkçš„å¼€å‘åŒ…ä¸­ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚<br><img alt="" data-original="/images/15500674888163.png"><br><img alt="" data-original="/images/15500674940045.png"></p><p>å¦‚ä¸Šå›¾æ›´åŠ æ¸…æ¥šçš„é˜è¿°äº†è¿™ä¸€è¿‡ç¨‹ï¼Œfuturedateå’Œrealdataéƒ½ç»§æ‰¿è‡ªDataæ¥å£ï¼Œå‡½æ•°è°ƒç”¨çš„æ—¶å€™è¿”å›Dataæ¥å£ï¼Œè€Œä¸ç®¡ç©¶ç«Ÿæ˜¯futuredateè¿˜æ˜¯realdataï¼Œå°†futuredateï¼ˆç±»ä¼¼ä¸Šé¢çš„è®¢å•ï¼Œåªæ˜¯ä¸€ä¸ªç©ºå£³ï¼‰è¿…é€Ÿçš„è¿”å›ï¼Œç„¶åç­‰çœŸæ­£çš„æ•°æ®æ„é€ å®Œæˆä¹‹åå†è¿”å›realdataï¼Œå¹¶ä¸”åœ¨futuredateä¸­å…·æœ‰realdataçš„å‚æ•°ï¼Œæ¥åˆ¤æ–­æ—¶å€™å·²ç»å°†çœŸå®çš„æ•°æ®è¿”å›ã€‚</p><h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Data &#123;</span><br><span class="line">public <span class="built_in">String</span> getResult (); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FutureData</span> <span class="title">implements</span> <span class="title">Data</span> </span>&#123;</span><br><span class="line">protected RealData realdata = <span class="literal">null</span>;<span class="comment">//FutureDataæ˜¯RealDataçš„åŒ…è£…</span></span><br><span class="line">protected boolean isReady = <span class="literal">false</span>;</span><br><span class="line">public synchronized <span class="keyword">void</span> setRealData(RealData realdata) &#123;</span><br><span class="line"><span class="keyword">if</span> (isReady) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.realdata = realdata; isReady = <span class="literal">true</span>; notifyAll();<span class="comment">//RealDataå·²ç»è¢«æ³¨å…¥ï¼Œé€šçŸ¥getResult()</span></span><br><span class="line">&#125;</span><br><span class="line">public synchronized <span class="built_in">String</span> getResult() &#123;<span class="comment">//ä¼šç­‰å¾…RealDataæ„é€ å®Œæˆ</span></span><br><span class="line"><span class="keyword">while</span> (!isReady) &#123; </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">wait();<span class="comment">//ä¸€ç›´ç­‰å¾…ï¼ŒçŸ¥é“RealDataè¢«æ³¨å…¥</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> realdata.result;<span class="comment">//ç”±RealDataå®ç°</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RealData</span> <span class="title">implements</span> <span class="title">Data</span> </span>&#123; </span><br><span class="line">protected final <span class="built_in">String</span> result;</span><br><span class="line">public RealData(<span class="built_in">String</span> para) &#123;</span><br><span class="line"><span class="comment">//RealDataçš„æ„é€ å¯èƒ½å¾ˆæ…¢ï¼Œéœ€è¦ç”¨æˆ·ç­‰å¾…å¾ˆä¹…ï¼Œè¿™é‡Œä½¿ç”¨sleepæ¨¡æ‹Ÿ</span></span><br><span class="line">StringBuffer sb=<span class="keyword">new</span> StringBuffer(); <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">sb.append(para); </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œä½¿ç”¨sleepï¼Œä»£æ›¿ä¸€ä¸ªå¾ˆæ…¢çš„æ“ä½œè¿‡ç¨‹ Thread.sleep(100);</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">result =sb.toString(); </span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getResult() &#123;</span><br><span class="line"><span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">public Data request(final <span class="built_in">String</span> queryStr) &#123;</span><br><span class="line">final FutureData future = <span class="keyword">new</span> FutureData();</span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;<span class="comment">// RealDataçš„æ„å»ºå¾ˆæ…¢ï¼Œ</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¿›è¡Œ</span></span><br><span class="line">RealData realdata = <span class="keyword">new</span> RealData(queryStr); future.setRealData(realdata);</span><br><span class="line">&#125; </span><br><span class="line">&#125;.start();</span><br><span class="line"><span class="keyword">return</span> future; <span class="comment">// FutureDataä¼šè¢«ç«‹å³è¿”å› </span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ–°å¼€å¯ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒsetRealDataï¼Œä½†æ˜¯ç«‹å³è¿”å›futureï¼Œä¾›ä½¿ç”¨ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">Client client = <span class="keyword">new</span> Client(); <span class="comment">//è¿™é‡Œä¼šç«‹å³è¿”å›ï¼Œå› ä¸ºå¾—åˆ°çš„æ˜¯FutureDataè€Œä¸æ˜¯RealData</span></span><br><span class="line">Data data = client.request(<span class="string">"name"</span>);</span><br><span class="line">System.out.println(<span class="string">"è¯·æ±‚å®Œæ¯•"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ªsleepä»£æ›¿äº†å¯¹å…¶ä»–ä¸šåŠ¡é€»è¾‘çš„å¤„ç† //åœ¨å¤„ç†è¿™äº›ä¸šåŠ¡é€»è¾‘çš„è¿‡ç¨‹ä¸­ï¼ŒRealDataè¢«åˆ›å»ºï¼Œä»è€Œå……åˆ†åˆ©ç”¨äº†ç­‰å¾…æ—¶é—´</span></span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä½¿ç”¨çœŸå®çš„æ•°æ®</span></span><br><span class="line">System.out.println(<span class="string">"æ•°æ® = "</span> + data.getResult()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœåˆšæ‰§è¡Œäº†Data data = client.request(â€œnameâ€)è¿”å›çš„å¹¶ä¸æ˜¯çœŸæ­£çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å»getResultä¸€å®šä¼šå‡ºç°é˜»å¡ï¼Œä½†æ˜¯ä¸­é—´æ‰§è¡Œäº†sleepï¼ˆ2000ï¼‰æˆ–åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼Œå¹¶ä¸ä¼šå½±å“å…¶ä»–çš„ä¸šåŠ¡ï¼Œåœ¨çœŸæ­£éœ€è¦æ•°æ®çš„æ—¶å€™ï¼Œåœ¨getResultï¼Œèƒ½å¤Ÿç¬é—´è¿”å›çœŸæ­£éœ€è¦çš„æ•°æ®ã€‚</p><h2 id="JDKå¯¹Futureæ¨¡å¼çš„æ”¯æŒ"><a href="#JDKå¯¹Futureæ¨¡å¼çš„æ”¯æŒ" class="headerlink" title="JDKå¯¹Futureæ¨¡å¼çš„æ”¯æŒ"></a>JDKå¯¹Futureæ¨¡å¼çš„æ”¯æŒ</h2><p><img alt="" data-original="/images/15500675136116.png"></p><p>æ ¸å¿ƒæ˜¯FutureTaskï¼Œä¸€ä¸ªå¸¦æœ‰FutureåŠŸèƒ½çš„Runnable</p><h3 id="é€šè¿‡callableå®ç°future"><a href="#é€šè¿‡callableå®ç°future" class="headerlink" title="é€šè¿‡callableå®ç°future"></a>é€šè¿‡callableå®ç°future</h3><p>è¿™é‡Œé€šè¿‡implements Callableæ¥å®ç°futureçš„åŠŸèƒ½ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RealData</span> <span class="title">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123; </span><br><span class="line">private <span class="built_in">String</span> para;</span><br><span class="line">public RealData(<span class="built_in">String</span> para)&#123;</span><br><span class="line"><span class="keyword">this</span>.para=para;</span><br><span class="line">&#125;</span><br><span class="line"> @Override</span><br><span class="line">public <span class="built_in">String</span> call() throws Exception &#123;</span><br><span class="line">StringBuffer sb=<span class="keyword">new</span> StringBuffer(); </span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">sb.append(para);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sb.toString(); </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FutureMain</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line"><span class="comment">//æ„é€ FutureTask</span></span><br><span class="line">FutureTask&lt;<span class="built_in">String</span>&gt; future = <span class="keyword">new</span> FutureTask&lt;<span class="built_in">String</span>&gt;(<span class="keyword">new</span> RealData(<span class="string">"a"</span>));</span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">1</span>); </span><br><span class="line"><span class="comment">//æ‰§è¡ŒFutureTaskï¼Œç›¸å½“äºä¸Šä¾‹ä¸­çš„ client.request("a") å‘é€è¯·æ±‚ </span></span><br><span class="line"><span class="comment">//åœ¨è¿™é‡Œå¼€å¯çº¿ç¨‹è¿›è¡ŒRealDataçš„call()æ‰§è¡Œ </span></span><br><span class="line">executor.submit(future);</span><br><span class="line">System.out.println(<span class="string">"è¯·æ±‚å®Œæ¯•"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123; <span class="comment">//è¿™é‡Œä¾ç„¶å¯ä»¥åšé¢å¤–çš„æ•°æ®æ“ä½œï¼Œè¿™é‡Œä½¿ç”¨sleepä»£æ›¿å…¶ä»–ä¸šåŠ¡é€»è¾‘çš„å¤„ç†</span></span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç›¸å½“äºdata.getResult ()ï¼Œå–å¾—call()æ–¹æ³•çš„è¿”å›å€¼ </span></span><br><span class="line"><span class="comment">//å¦‚æœæ­¤æ—¶call()æ–¹æ³•æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œåˆ™ä¾ç„¶ä¼šç­‰å¾… </span></span><br><span class="line">System.out.println(<span class="string">"æ•°æ® = "</span> + future.get());</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç ï¼š<br>FutureTask<string>future = new FutureTask<string>(new RealData(â€œaâ€));<br>ä¸Šé¢è¯´åˆ°jdkä¸­å¯¹futureçš„æ”¯æŒï¼Œå…¶æ ¸å¿ƒå°±æ˜¯FutureTaskï¼Œè¿™é‡Œæ„é€ FutureTask<br>executor.submit(future);<br>System.out.println(â€œæ•°æ® = â€œ + future.get());<br>è¿™é‡Œå¦‚æœï¼Œåœ¨submitå’Œgetä¹‹é—´æ²¡æœ‰å…¶ä»–çš„æ“ä½œç›´æ¥è¿›è¡Œgetè¿˜æ˜¯ä¼šå½¢æˆé˜»å¡çš„ã€‚</string></string></p><h3 id="æ›´åŠ ç®€ä¾¿çš„æ–¹å¼å®ç°future"><a href="#æ›´åŠ ç®€ä¾¿çš„æ–¹å¼å®ç°future" class="headerlink" title="æ›´åŠ ç®€ä¾¿çš„æ–¹å¼å®ç°future"></a>æ›´åŠ ç®€ä¾¿çš„æ–¹å¼å®ç°future</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FutureMain2</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//æ‰§è¡ŒFutureTaskï¼Œç›¸å½“äºä¸Šä¾‹ä¸­çš„ client.request("a") å‘é€è¯·æ±‚</span></span><br><span class="line"><span class="comment">//åœ¨è¿™é‡Œå¼€å¯çº¿ç¨‹è¿›è¡ŒRealDataçš„call()æ‰§è¡Œ</span></span><br><span class="line">Future&lt;<span class="built_in">String</span>&gt; future=executor.submit(<span class="keyword">new</span> RealData(<span class="string">"a"</span>));</span><br><span class="line">System.out.println(<span class="string">"è¯·æ±‚å®Œæ¯•"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line"><span class="comment">//è¿™é‡Œä¾ç„¶å¯ä»¥åšé¢å¤–çš„æ•°æ®æ“ä½œï¼Œè¿™é‡Œä½¿ç”¨sleepä»£æ›¿å…¶ä»–ä¸šåŠ¡é€»è¾‘çš„å¤„ç†</span></span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç›¸å½“äºdata.getResult ()ï¼Œå–å¾—call()æ–¹æ³•çš„è¿”å›å€¼ </span></span><br><span class="line"><span class="comment">//å¦‚æœæ­¤æ—¶call()æ–¹æ³•æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œåˆ™ä¾ç„¶ä¼šç­‰å¾… </span></span><br><span class="line">System.out.println(<span class="string">"æ•°æ® = "</span> + future.get());</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç ï¼š<br>Future<string>future=executor.submit(new RealData(â€œaâ€));<br>System.out.println(â€œæ•°æ® = â€œ + future.get());<br>å› ä¸ºcallableæ˜¯èƒ½å¤Ÿæœ‰è¿”å›å€¼çš„ï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥å¾—åˆ°futureï¼Œè¿›ä¸€æ­¥ç®€åŒ–äº†æ“ä½œã€‚</string></p><h1 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…</h1><p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ˜¯ä¸€ä¸ªç»å…¸çš„å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ã€‚å®ƒä¸ºå¤šçº¿ç¨‹é—´çš„åä½œæä¾›äº†è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆã€‚ åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œé€šå¸¸ç”±ä¸¤ç±»çº¿ç¨‹ï¼Œå³è‹¥å¹²ä¸ªç”Ÿäº§è€…çº¿ç¨‹å’Œè‹¥å¹²ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ã€‚ç”Ÿäº§è€…çº¿ ç¨‹è´Ÿè´£æäº¤ç”¨æˆ·è¯·æ±‚ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹åˆ™è´Ÿè´£å…·ä½“å¤„ç†ç”Ÿäº§è€…æäº¤çš„ä»»åŠ¡ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´åˆ™é€š è¿‡å…±äº«å†…å­˜ç¼“å†²åŒºè¿›è¡Œé€šä¿¡ã€‚</p><p>çº¿ç¨‹aéœ€è¦çŸ¥é“çº¿ç¨‹bçš„å­˜åœ¨ï¼Œçº¿ç¨‹béœ€è¦çŸ¥é“çº¿ç¨‹açš„å­˜åœ¨ï¼Œå¦‚æœæ›´æ¢äº†åå­—å‘¢ï¼Ÿä»è½¯ä»¶å·¥ç¨‹çš„è§’åº¦è®²ï¼Œä¸€ä¸ªæ¨¡å—ï¼Œå¯¹å¤–æœ€å¥½æ˜¯è¢«çŸ¥é“çš„è¶Šå°‘è¶Šå¥½ï¼Œä¸€æ— æ‰€çŸ¥æœ€å¥½ï¼Œæ„å‘³ç€å¤–éƒ¨çš„ç¨‹åºä¸è®ºæ€ä¹ˆæ”¹ï¼Œå¯¹æˆ‘éƒ½æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œèƒ½å¾ˆå¥½çš„é™ä½è€¦åˆæ€§ã€‚<br><img alt="" data-original="/images/15500675290878.png"></p><table><thead><tr><th>è§’è‰²</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ç”Ÿäº§è€…</td><td>ç”¨äºæäº¤ç”¨æˆ·è¯·æ±‚ï¼Œæå–ç”¨æˆ·ä»»åŠ¡ï¼Œå¹¶è£…å…¥å†…å­˜ç¼“å†²åŒº</td></tr><tr><td>æ¶ˆè´¹è€…</td><td>åœ¨å†…å­˜ç¼“å†²åŒºä¸­æå–å¹¶å¤„ç†ä»»åŠ¡</td></tr><tr><td>å†…å­˜ç¼“å†²åŒº</td><td>ç¼“å­˜ç”Ÿäº§è€…æäº¤çš„ä»»åŠ¡æˆ–æ•°æ®ï¼Œä¾›æ¶ˆè´¹è€…ä½¿ç”¨</td></tr><tr><td>ä»»åŠ¡</td><td>ç”Ÿæˆè€…å‘å†…å­˜ç¼“å†²åŒºæäº¤çš„æ•°æ®ç»“æ„ã€‚</td></tr><tr><td>Main</td><td>ä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å®¢æˆ·ç«¯</td></tr></tbody></table><h2 id="ç®€å•ä»£ç å®ç°"><a href="#ç®€å•ä»£ç å®ç°" class="headerlink" title="ç®€å•ä»£ç å®ç°"></a>ç®€å•ä»£ç å®ç°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (isRunning) &#123; </span><br><span class="line">Thread.sleep(r.nextInt(SLEEPTIME));</span><br><span class="line">data = <span class="keyword">new</span> PCData(count.incrementAndGet()); <span class="comment">//æ„é€ ä»»åŠ¡æ•°æ®</span></span><br><span class="line">System.out.println(data+<span class="string">" is put into queue"</span>); </span><br><span class="line"><span class="keyword">if</span> (!queue.offer(data, <span class="number">2</span>, TimeUnit.SECONDS)) &#123; </span><br><span class="line"><span class="comment">//æäº¤æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">System.err.println(<span class="string">"failed to put data:"</span> + data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">PCData data = queue.take();</span><br><span class="line"><span class="comment">//æå–ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> != data) &#123;</span><br><span class="line">int re = data.getData() * data.getData(); <span class="comment">//è®¡ç®—å¹³æ–¹</span></span><br><span class="line">System.out.println(MessageFormat.format(<span class="string">"&#123;0&#125;*&#123;1&#125;=&#123;2&#125;"</span>,</span><br><span class="line">data.getData(), re));</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆå…­ï¼‰ï¼šJDKå¹¶å‘åŒ…(çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨ã€ForkJoin)</title>
    <link href="http://mmmmmm.me/2019-02-12.html"/>
    <id>http://mmmmmm.me/2019-02-12.html</id>
    <published>2019-02-12T11:20:02.000Z</published>
    <updated>2019-02-12T13:58:07.512Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="1-çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨"><a href="#1-çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="1. çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨"></a>1. çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨</h1><h2 id="1-1-ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± "><a href="#1-1-ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± " class="headerlink" title="1.1. ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± "></a>1.1. ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± </h2><p><strong><font color="red">ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ</font></strong><br>çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦å¯¹çº¿ç¨‹è¿›è¡Œåˆ›å»ºå’Œé”€æ¯ï¼Œè¿™ä¸¤ä¸ªæ“ä½œï¼Œå¯¹äºçº¿ç¨‹æœ¬èº«çš„ä¸šåŠ¡æ¥è¯´å…¶å®æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œæˆ‘åªå…³å¿ƒçº¿ç¨‹æ‰€æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¸Œæœ›å§å°½å¯èƒ½å¤šçš„cpuç”¨åœ¨ä»»åŠ¡çš„æ‰§è¡Œä¸Šï¼Œè€Œä¸æ˜¯è¾…åŠ©æ€§è´¨çš„çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ä¸Šé¢ï¼Œæ‰€ä»¥çº¿ç¨‹æ± åº”è¿è€Œç”Ÿã€‚</p><p><strong><font color="red">çº¿ç¨‹æ± çš„ä½œç”¨ï¼Ÿ</font></strong><br>å®ƒçš„ä½œç”¨å°±æ˜¯æŠŠçº¿ç¨‹è¿›è¡Œå¤ç”¨ï¼Œæ¯”å¦‚æ‰§è¡Œä¸€ç™¾ä¸ªä»»åŠ¡ï¼Œå¦‚æœåˆ†åæ¬¡æ‰¹é‡æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰çº¿ç¨‹æ± å°±éœ€è¦åˆ›å»ºé”€æ¯ä¸€ç™¾æ¬¡ï¼Œå¦‚æœæœ‰çº¿ç¨‹æ± ï¼ˆå‡å¦‚çº¿ç¨‹æ± ä¸­æœ‰åä¸ªçº¿ç¨‹ï¼‰ï¼Œè¿™åä¸ªçº¿ç¨‹æ˜¯ä¸é€€å‡ºçš„ï¼Œå¸¸é©»çº¿ç¨‹çš„ï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡çš„è¯æ˜¯ä¸€ä¸ªç­‰å¾…çš„çŠ¶æ€ï¼Œä»»åŠ¡å¼€å§‹çš„æ—¶å€™å°±ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œå½“å‰åä¸ªä»»åŠ¡æäº¤çš„æ—¶å€™ï¼Œä»–ä»¬åœ¨çº¿ç¨‹æ± é‡Œè·‘ï¼Œå› ä¸ºçº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥å‰åä¸ªä»»åŠ¡è·‘å®Œä¹‹åï¼Œé©¬ä¸Šå°±èƒ½æ‰§è¡Œä¸‹é¢çš„åä¸ªä»»åŠ¡ï¼Œä»å§‹è‡³ç»ˆåªå…³æ³¨çº¿ç¨‹çš„ä¸šåŠ¡ï¼Œè€Œåªåˆ›å»ºäº†ä¸€æ¬¡åä¸ªçº¿ç¨‹ï¼ŒèŠ‚çœcpuçš„æ—¶é—´ã€‚</p><p>ç®€å•çš„çº¿ç¨‹æ± å®ç°<br>ç•¥</p><h2 id="1-2-JDKä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›æ”¯æŒ-å†…ç½®çº¿ç¨‹æ± "><a href="#1-2-JDKä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›æ”¯æŒ-å†…ç½®çº¿ç¨‹æ± " class="headerlink" title="1.2. JDKä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›æ”¯æŒ å†…ç½®çº¿ç¨‹æ± "></a>1.2. JDKä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›æ”¯æŒ å†…ç½®çº¿ç¨‹æ± </h2><h2 id="1-2-1"><a href="#1-2-1" class="headerlink" title="1.2.1."></a>1.2.1.</h2><p><img alt="" data-original="/images/15499794818047.png"></p><h2 id="1-3-çº¿ç¨‹æ± çš„ä½¿ç”¨"><a href="#1-3-çº¿ç¨‹æ± çš„ä½¿ç”¨" class="headerlink" title="1.3. çº¿ç¨‹æ± çš„ä½¿ç”¨"></a>1.3. çº¿ç¨‹æ± çš„ä½¿ç”¨</h2><h3 id="1-3-1-çº¿ç¨‹æ± çš„ç§ç±»"><a href="#1-3-1-çº¿ç¨‹æ± çš„ç§ç±»" class="headerlink" title="1.3.1. çº¿ç¨‹æ± çš„ç§ç±»"></a>1.3.1. çº¿ç¨‹æ± çš„ç§ç±»</h3><p>newFixedThreadPool å›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯å›ºå®šçš„<br>newSingleThreadExecutor å•ä¸€çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹<br>newCachedThreadPool ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œå½“ä¸€ä¸‹å­å¥½å¤šä»»åŠ¡çš„æ—¶å€™ï¼Œå°±å¼€å¥½å¤šçº¿ç¨‹å»åšï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œçº¿ç¨‹ç©ºé—²ä¸‹æ¥çš„æ—¶å€™ï¼Œæ…¢æ…¢çº¿ç¨‹çš„æ•°é‡å°±ä¼šå‡å°‘ï¼Œè‡ªç„¶æ¶ˆäº¡ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯çº¿ç¨‹çš„æ•°é‡åœ¨æŸæ®µæ—¶é—´å†…æ˜¯ä¼šæ‰©å¼ æˆ–è€…æ”¶ç¼©çš„<br>newScheduledThreadPoolå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œï¼Œæ¯”å¦‚æ¯ä¸ªäº”åˆ†é’Ÿè°ƒä¸€ä¸ªä»€ä¹ˆä»»åŠ¡ã€‚</p><h3 id="1-3-2-ä¸åŒçº¿ç¨‹æ± çš„å…±åŒæ€§-çº¿ç¨‹æ± æ„é€ å‡½æ•°è¯¦è§£"><a href="#1-3-2-ä¸åŒçº¿ç¨‹æ± çš„å…±åŒæ€§-çº¿ç¨‹æ± æ„é€ å‡½æ•°è¯¦è§£" class="headerlink" title="1.3.2. ä¸åŒçº¿ç¨‹æ± çš„å…±åŒæ€§ çº¿ç¨‹æ± æ„é€ å‡½æ•°è¯¦è§£"></a>1.3.2. ä¸åŒçº¿ç¨‹æ± çš„å…±åŒæ€§ çº¿ç¨‹æ± æ„é€ å‡½æ•°è¯¦è§£</h3><p>è¿›å…¥Executorsç±»ä¸­<br>æ³¨æ„ï¼šä»£ç ä¸­çš„å‚æ•°è¯¦ç»†æ„æ€ï¼Œå†å¾€ä¸‹é¢çš„ä»£ç ä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> ExecutorService newFixedThreadPool(int nThreads) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                     <span class="number">0</span>L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                     <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">   &#125;</span><br><span class="line">   public <span class="keyword">static</span> ExecutorService newSingleThreadExecutor() &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">           (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                   <span class="number">0</span>L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                   <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">   &#125;</span><br><span class="line">public <span class="keyword">static</span> ExecutorService newCachedThreadPool() &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                     <span class="number">60</span>L, TimeUnit.SECONDS,</span><br><span class="line">                                     <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆçº¿ç¨‹æ± æ ‡å‡†å®¹é‡ã€åˆå§‹å®¹é‡ï¼‰ä¸€å¼€å§‹æ˜¯é›¶ï¼Œå½“ä»»åŠ¡è¿›æ¥å°±æ‰©å®¹ï¼Œ</span></span><br><span class="line">   <span class="comment">//SynchronousQueueå®¹é‡æ˜¯é›¶å½“è¯•å›¾å¾€queueä¸­</span></span><br><span class="line">   <span class="comment">//å¡ä»»åŠ¡çš„æ—¶å€™ï¼Œæ˜¯ä¼šå¤±è´¥çš„ï¼Œå°±ä¼šçº¿ç¨‹æ± çº¿ç¨‹æ•°ä»é›¶å¼€å§‹å¾€ä¸Šå¢åŠ åˆ°MAX_VALUEä¸ºæ­¢ï¼Œ</span></span><br><span class="line">   <span class="comment">//60ç§’æ˜¯è¶…æ—¶æ—¶é—´ï¼Œ60ç§’æ²¡è¢«ä½¿ç”¨å°±ä¼šè¢«ç§»é™¤æ‰</span></span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">å‘ç°éƒ½æ˜¯new ThreadPoolExecutorï¼ˆï¼‰ï¼Œåªæ˜¯ä¼ å…¥äº†ä¸åŒçš„å‚æ•°<br>ç ”ç©¶ä¸€ä¸‹ThreadPoolExecutorè¿™ä¸ªæ„é€ å‡½æ•°</font></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public ThreadPoolExecutor(int corePoolSize,<span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆæ ‡å‡†ï¼‰</span></span><br><span class="line">                             int maximumPoolSize,<span class="comment">//æœ€å¤§çš„çº¿ç¨‹æ•°</span></span><br><span class="line">                             long keepAliveTime,<span class="comment">//å¦‚æœæ²¡æœ‰äº‹æƒ…åšï¼Œè¿˜èƒ½åœ¨å½“å‰çº¿ç¨‹å­˜æ´»å¤šå°‘æ—¶é—´</span></span><br><span class="line">                             <span class="comment">//è¶…è¿‡æŒ‡å®šçš„æ—¶é—´ï¼Œå°†ä¼šè¢«æ€æ‰</span></span><br><span class="line">                             TimeUnit unit,<span class="comment">//ä¸Šé¢éœ€è¦çš„æ—¶é—´çš„å•ä½</span></span><br><span class="line">                             BlockingQueue&lt;Runnable&gt; workQueue<span class="comment">//é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚æœå½“å‰æ²¡æœ‰å¤šä½™çº¿ç¨‹æ¥åšä»»åŠ¡ï¼Œç°åœ¨queueä¸­æ’é˜Ÿï¼Œç”¨æ¥ä¿å­˜ä»»åŠ¡ã€‚</span></span><br><span class="line">                             <span class="comment">//æ³¨æ„è¿™ä¸ªqueueçš„å®¹é‡æ˜¯æœ‰é™åº¦çš„ã€‚</span></span><br><span class="line">                             ) &#123;</span><br><span class="line">       <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">            Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å¤´æ¥æ¥ç€çœ‹ä¸Šé¢çš„æ„é€ å‡½æ•°å°±æœ‰äº†å¾ˆå¤šçœ‰ç›®ã€‚</p><h2 id="1-4-çº¿ç¨‹æ± ä½¿ç”¨çš„å°ä¾‹å­"><a href="#1-4-çº¿ç¨‹æ± ä½¿ç”¨çš„å°ä¾‹å­" class="headerlink" title="1.4. çº¿ç¨‹æ± ä½¿ç”¨çš„å°ä¾‹å­"></a>1.4. çº¿ç¨‹æ± ä½¿ç”¨çš„å°ä¾‹å­</h2><h3 id="1-4-1-ç®€å•çº¿ç¨‹æ± "><a href="#1-4-1-ç®€å•çº¿ç¨‹æ± " class="headerlink" title="1.4.1. ç®€å•çº¿ç¨‹æ± "></a>1.4.1. ç®€å•çº¿ç¨‹æ± </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolDemo</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":Thread ID:"</span>+Thread.currentThread().getId());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">MyTask task = <span class="keyword">new</span> MyTask();</span><br><span class="line">ExecutorService es = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">es.submit(task);</span><br><span class="line"><span class="comment">//es.execute(task);</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1549114075211</span>Thread ID:<span class="number">9</span></span><br><span class="line"><span class="number">1549114075213</span>Thread ID:<span class="number">10</span></span><br><span class="line"><span class="number">1549114085211</span>Thread ID:<span class="number">11</span></span><br><span class="line"><span class="number">1549114075211</span>Thread ID:<span class="number">12</span></span><br><span class="line"><span class="number">1549114075210</span>Thread ID:<span class="number">13</span></span><br><span class="line"><span class="number">1549114075213</span>hread ID:<span class="number">10</span></span><br><span class="line"><span class="number">1549114075415</span>Thread ID:<span class="number">9</span></span><br><span class="line"><span class="number">1549114075219</span>Thread ID:<span class="number">13</span></span><br><span class="line"><span class="number">1549114675217</span>Thread ID:<span class="number">12</span></span><br><span class="line"><span class="number">1549114075208</span>hread ID:<span class="number">11</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯äº”ä¸ªäº”ä¸ªæ‰§è¡Œçš„ã€‚es.submit(task);es.execute(task);ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ã€‚</p><h3 id="1-4-2-ScheduledThreadPool"><a href="#1-4-2-ScheduledThreadPool" class="headerlink" title="1.4.2. ScheduledThreadPool"></a>1.4.2. ScheduledThreadPool</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ScheduledExecutirServiceDemo</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ScheduledExecutorService ses = Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//å¦‚æœå‰é¢çš„ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œåˆ™è°ƒåº¦ä¹Ÿä¸ä¼šå¯åŠ¨</span></span><br><span class="line">ses.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">System.out.println(System.currentTimeMillis()/<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="number">0</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1548114424</span></span><br><span class="line"><span class="number">1548114425</span></span><br><span class="line"><span class="number">1548114427</span></span><br><span class="line"><span class="number">1548114428</span></span><br><span class="line"><span class="number">1548114420</span></span><br><span class="line"><span class="number">1548114422</span></span><br><span class="line"><span class="number">1548114423</span></span><br><span class="line"><span class="number">1548114426</span></span><br><span class="line"><span class="number">1548114429</span></span><br><span class="line"><span class="number">1548114430</span></span><br><span class="line"><span class="number">1548114432</span></span><br><span class="line"><span class="number">1548114433</span></span><br><span class="line"><span class="number">1548114434</span></span><br><span class="line"><span class="number">1548114435</span></span><br><span class="line"><span class="number">1548114436</span></span><br><span class="line"><span class="number">1548114437</span></span><br><span class="line"><span class="number">1548114438</span></span><br><span class="line"><span class="number">1548114439</span></span><br><span class="line"><span class="number">1548114430</span></span><br></pre></td></tr></table></figure><p>æ¯è¿‡ä¸‰ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/20190122075216822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"><br>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€æ¬¡å„å¤šå°‘æ—¶é—´å»è°ƒï¼Œç¬¬äºŒä¸ªå‚æ•°åé¢å‘¨æœŸæ€§çš„å¤šé•¿æ—¶é—´å»è°ƒï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯äº‹ä»¶çš„ä¸‰å›´ã€‚</p><h1 id="2-æ‰©å±•å’Œå¢å¼ºçº¿ç¨‹æ± "><a href="#2-æ‰©å±•å’Œå¢å¼ºçº¿ç¨‹æ± " class="headerlink" title="2. æ‰©å±•å’Œå¢å¼ºçº¿ç¨‹æ± "></a>2. æ‰©å±•å’Œå¢å¼ºçº¿ç¨‹æ± </h1><h2 id="2-1-å›è°ƒæ¥å£"><a href="#2-1-å›è°ƒæ¥å£" class="headerlink" title="2.1. å›è°ƒæ¥å£"></a>2.1. å›è°ƒæ¥å£</h2><p>beforeExecute afterExecute terminated<br>æ•è·çº¿ç¨‹æ± è¿è¡Œæ—¶ä¸€äº›ä¿¡æ¯ï¼Œæ•è·å½“æ—¶çš„å·¥ä½œçŠ¶æ€ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ExtThreadPool</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Mytask</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="built_in">String</span> name;</span><br><span class="line"></span><br><span class="line">public Mytask(<span class="built_in">String</span> name) &#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">System.out.println(<span class="string">"æ­£åœ¨æ‰§è¡Œ"</span>+<span class="string">":Thread ID:"</span>+Thread.currentThread().getId()+<span class="string">",Task Name = "</span>+name);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">ThreadPoolExecutor es = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">5</span>, <span class="number">0</span>L, TimeUnit.MICROSECONDS,</span><br><span class="line"><span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;()) &#123;</span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> beforeExecute(Thread t, Runnable r) &#123;</span><br><span class="line">System.out.println(<span class="string">"å‡†å¤‡æ‰§è¡Œï¼š"</span>+((Mytask)r).name);</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> afterExecute(Runnable r,Throwable t ) &#123;</span><br><span class="line">System.out.println(<span class="string">"æ‰§è¡Œå®Œæˆï¼š"</span>+((Mytask)r).name);</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">protected <span class="keyword">void</span> terminated() &#123;</span><br><span class="line">System.out.println(<span class="string">"çº¿ç¨‹æ± é€€å‡º"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">Mytask mytask = <span class="keyword">new</span> Mytask(<span class="string">"TASK_GEYM_"</span> + i);</span><br><span class="line">es.execute(mytask);</span><br><span class="line">Thread.sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line">es.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">å‡†å¤‡æ‰§è¡Œï¼šTASK_CEYM_0</span><br><span class="line">æ­£åœ¨æ‰§è¡ŒThread IDï¼š<span class="number">9</span>ï¼ŒTASK Name = TASK_CEYM_0</span><br><span class="line">å‡†å¤‡æ‰§è¡Œï¼šTASK_CEYM_1</span><br><span class="line">æ­£åœ¨æ‰§è¡ŒThread IDï¼š<span class="number">9</span>ï¼ŒTASK Name = TASK_CEYM_1</span><br><span class="line">å‡†å¤‡æ‰§è¡Œï¼šTASK_CEYM_2</span><br><span class="line">æ­£åœ¨æ‰§è¡ŒThread IDï¼š<span class="number">9</span>ï¼ŒTASK Name = TASK_CEYM_2</span><br><span class="line">å‡†å¤‡æ‰§è¡Œï¼šTASK_CEYM_3</span><br><span class="line">æ­£åœ¨æ‰§è¡ŒThread IDï¼š<span class="number">9</span>ï¼ŒTASK Name = TASK_CEYM_3</span><br><span class="line">å‡†å¤‡æ‰§è¡Œï¼šTASK_CEYM_4</span><br><span class="line">æ­£åœ¨æ‰§è¡ŒThread IDï¼š<span class="number">9</span>ï¼ŒTASK Name = TASK_CEYM_4</span><br><span class="line">æ‰§è¡Œå®Œæˆï¼šTASK_CEYM_0</span><br><span class="line">æ‰§è¡Œå®Œæˆï¼šTASK_CEYM_1</span><br><span class="line">æ‰§è¡Œå®Œæˆï¼šTASK_CEYM_2</span><br><span class="line">æ‰§è¡Œå®Œæˆï¼šTASK_CEYM_3</span><br><span class="line">æ‰§è¡Œå®Œæˆï¼šTASK_CEYM_4</span><br><span class="line">çº¿ç¨‹æ± é€€å‡º</span><br></pre></td></tr></table></figure><p>beforeExecute çº¿ç¨‹æ‰§è¡Œå‰åšçš„äº‹<br>afterExecute çº¿ç¨‹æ‰§è¡Œå®Œäº†ä¹‹ååšçš„äº‹<br>terminated çº¿ç¨‹æ± é€€å‡ºååšçš„äº‹</p><h2 id="2-2-æ‹’ç»ç­–ç•¥"><a href="#2-2-æ‹’ç»ç­–ç•¥" class="headerlink" title="2.2. æ‹’ç»ç­–ç•¥"></a>2.2. æ‹’ç»ç­–ç•¥</h2><p>ä¸èƒ½æœ‰æ— é™å¤§å°çš„ç¼“å­˜é˜Ÿåˆ—ï¼Œå› ä¸ºå¦‚æœæœ‰å¤§é‡çš„ä»»åŠ¡è¿›æ¥ï¼Œä¼šå¯¼è‡´å†…å­˜çš„æ¿€å¢ï¼Œå¦‚æœä¸€ç›´æ¿€å¢è€Œæ²¡æœ‰é‡Šæ”¾ï¼Œä¼šå¯¼è‡´å†…å­˜å¼‚å¸¸ã€‚<br>æ‰€ä»¥å½“å‘ç°è´Ÿè½½åˆ°äº†ä¸€å®šçš„ç¨‹åº¦åï¼Œåº”è¯¥é€‰æ‹©ä¸¢å¼ƒä¸€äº›ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ”¾åœ¨å†…å­˜ä¸­ï¼Œçœ‹ç€å†…å­˜è¢«è€—æ‰ï¼Œä¸¢å¼ƒçš„æ—¶å€™å¸Œæœ›æŠŠè¿™äº›ä¸¢æ‰çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°é‡ï¼Œå…·ä½“æ˜¯é‚£äº›ï¼‰è®°å½•ä¸‹æ¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public ThreadPoolExecutor(int corePoolSize,</span><br><span class="line">                             int maximumPoolSize,</span><br><span class="line">                             long keepAliveTime,</span><br><span class="line">                             TimeUnit unit,</span><br><span class="line">                             BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">                             ThreadFactory threadFactory,</span><br><span class="line">                             RejectedExecutionHandler handler) &#123;</span><br><span class="line">       <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">           maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">           maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">           keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">       <span class="keyword">if</span> (workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">       <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">       <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">       <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">       <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">       <span class="keyword">this</span>.handler = handler;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°ä¸­å¤šäº†ä¸¤ä¸ªå‚æ•°<br>ThreadFactory//çº¿ç¨‹å·¥å‚ï¼ˆç¨åä»‹ç»ï¼‰<br>RejectedExecutionHandler//æ‹’ç»ç­–ç•¥//å¦‚æœä»»åŠ¡ä¸èƒ½æ‰§è¡Œäº†æˆ‘åº”è¯¥æ€ä¹ˆåš<br>å…·ä½“çš„å®ç°åŒ…æ‹¬<br><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" data-original="https://img-blog.csdnimg.cn/2019012208435337.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70"></p><h3 id="æ‹’ç»ç­–ç•¥ä¸¾ä¾‹ï¼š"><a href="#æ‹’ç»ç­–ç•¥ä¸¾ä¾‹ï¼š" class="headerlink" title="æ‹’ç»ç­–ç•¥ä¸¾ä¾‹ï¼š"></a>æ‹’ç»ç­–ç•¥ä¸¾ä¾‹ï¼š</h3><h4 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbortPolicy</span> <span class="title">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates an &#123;@code AbortPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public AbortPolicy() &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Always throws RejectedExecutionException.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * @param e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         * @throws RejectedExecutionException always.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">void</span> rejectedExecution(Runnable r, ThreadPoolExecutor e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"Task "</span> + r.toString() +</span><br><span class="line">                                                 <span class="string">" rejected from "</span> +</span><br><span class="line">                                                 e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç­–ç•¥æ˜¯å¦‚æœä¸èƒ½æ‰§è¡Œäº†ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”å°†å…·ä½“çš„ä»»åŠ¡ä¿¡æ¯æ‰“å°å‡ºå•¦ã€‚</p><h4 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardPolicy</span> <span class="title">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;@code DiscardPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public DiscardPolicy() &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Does nothing, which has the effect of discarding task r.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * @param e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">void</span> rejectedExecution(Runnable r, ThreadPoolExecutor e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç­–ç•¥æ˜¯å¦‚æœä¸æ‰§è¡Œäº†ï¼Œå°±ç›´æ¥ä¸¢å¼ƒæ‰ï¼Œè®¾ä¹ˆä¹Ÿä¸åšã€‚</p><h4 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerRunsPolicy</span> <span class="title">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;@code CallerRunsPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public CallerRunsPolicy() &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Executes task r in the caller's thread, unless the executor</span></span><br><span class="line"><span class="comment">         * has been shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * @param e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">void</span> rejectedExecution(Runnable r, ThreadPoolExecutor e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>if (!e.isShutdown()) {<br>r.run();<br>}<br>å¦‚æœçº¿ç¨‹æ± è¿˜æ´»ç€ï¼Œå°±è®©è°ƒç”¨è€…æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªç±»æœ¬èº«è‡ªå·±ä¸åšå¤„ç†ã€‚</p><h4 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardOldestPolicy</span> <span class="title">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Creates a &#123;@code DiscardOldestPolicy&#125; for the given executor.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       public DiscardOldestPolicy() &#123; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Obtains and ignores the next task that the executor</span></span><br><span class="line"><span class="comment">        * would otherwise execute, if one is immediately available,</span></span><br><span class="line"><span class="comment">        * and then retries execution of task r, unless the executor</span></span><br><span class="line"><span class="comment">        * is shut down, in which case task r is instead discarded.</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * @param r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">        * @param e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       public <span class="keyword">void</span> rejectedExecution(Runnable r, ThreadPoolExecutor e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">               e.getQueue().poll();</span><br><span class="line">               e.execute(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å°†é˜Ÿåˆ—ä¸­æœ€è€çš„ä¸¢å¼ƒæ‰ã€‚</p><h3 id="å°ä¾‹å­"><a href="#å°ä¾‹å­" class="headerlink" title="å°ä¾‹å­"></a>å°ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.omg.PortableServer.THREAD_POLICY_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RejectThreadPoolDemo</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":Thread Id:"</span>+Thread.currentThread().getId());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">MyTask task = <span class="keyword">new</span> MyTask();</span><br><span class="line">ExecutorService es = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">5</span>, <span class="number">0</span>L, TimeUnit.MILLISECONDS,</span><br><span class="line"><span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),<span class="comment">//æ°¸è¿œéƒ½æ”¾ä¸è¿›å»çš„å¯¹äº†ï¼Œåªæœ‰å½“æˆ‘å»æ‹¿çš„æ—¶å€™æ‰èƒ½æ”¾è¿›å»ï¼Œ</span></span><br><span class="line"><span class="comment">// å› ä¸ºæ”¾ä¸è¿›å»ï¼Œæ‰€ä»¥èµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">Executors.defaultThreadFactory(),</span><br><span class="line"><span class="keyword">new</span> RejectedExecutionHandler() &#123;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> rejectedExecution(final Runnable r, final ThreadPoolExecutor executor) &#123;</span><br><span class="line">System.out.println(r.toString()+<span class="string">"is discard"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;Integer.MAX_VALUE ; i++) &#123;</span><br><span class="line">es.submit(task);</span><br><span class="line">Thread.sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1548893374312</span>:Thread Id:<span class="number">9</span></span><br><span class="line"><span class="number">1548893374323</span>:Thread Id:<span class="number">10</span></span><br><span class="line"><span class="number">1548893374333</span>:Thread Id:<span class="number">11</span></span><br><span class="line"><span class="number">1548893374345</span>:Thread Id:<span class="number">12</span></span><br><span class="line"><span class="number">1548893374356</span>:Thread Id:<span class="number">13</span></span><br><span class="line">java.util.concurrent.FutureTask@<span class="number">655538e5</span>is discard</span><br><span class="line">java.util.concurrent.FutureTask@<span class="number">3e0</span>a765cis discard</span><br><span class="line">java.util.concurrent.FutureTask@<span class="number">20e0</span>b1d6is discard</span><br><span class="line">java.util.concurrent.FutureTask@<span class="number">7</span>fbb6976is discard</span><br><span class="line"><span class="number">1548893374418</span>:Thread Id:<span class="number">9</span></span><br><span class="line"><span class="number">1548893374433</span>:Thread Id:<span class="number">10</span></span><br><span class="line"><span class="number">1548893374446</span>:Thread Id:<span class="number">11</span></span><br><span class="line"><span class="number">1548893374456</span>:Thread Id:<span class="number">12</span></span><br><span class="line"><span class="number">1548893374466</span>:Thread Id:<span class="number">13</span></span><br><span class="line">java.util.concurrent.FutureTask@<span class="number">6</span>c2fdbb1is discard</span><br></pre></td></tr></table></figure><p></p><p>å¦‚ä¸Šé¢ï¼Œå› ä¸ºé˜Ÿåˆ—æ”¾ä¸è¿›å»ä¸œè¥¿ï¼Œä»»åŠ¡æ¯10msæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œæ¯ä¸ªä»»åŠ¡è¦sleep 100msï¼Œæ‰€ä»¥ï¼Œå¿…å®šä¼šå‡ºç°ä»»åŠ¡å †ç§¯ï¼Œè¿™ä¸ªæ—¶å€™å°±èµ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥ã€‚</p><h2 id="2-3-è‡ªå®šä¹‰ThreadFactory"><a href="#2-3-è‡ªå®šä¹‰ThreadFactory" class="headerlink" title="2.3. è‡ªå®šä¹‰ThreadFactory"></a>2.3. è‡ªå®šä¹‰ThreadFactory</h2><p>èƒ½å¤Ÿåœ¨åˆ›é€ Threadçš„æ—¶å€™ç»™Threadå‘½åï¼Œæˆ–è€…ä½¿å…¶å˜æˆå®ˆæŠ¤çº¿ç¨‹çš„æ“ä½œã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TheadF</span></span>&#123;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="title">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">private <span class="keyword">static</span> final AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">private final ThreadGroup group;</span><br><span class="line">private final AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">private final <span class="built_in">String</span> namePrefix;</span><br><span class="line"></span><br><span class="line">DefaultThreadFactory()&#123;</span><br><span class="line">SecurityManager s = System.getSecurityManager();</span><br><span class="line">group = (s != <span class="literal">null</span>) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();</span><br><span class="line">namePrefix = <span class="string">"pool-"</span> + poolNumber.getAndIncrement() + <span class="string">"-thread-"</span>;</span><br><span class="line">&#125;</span><br><span class="line">DefaultThreadFactory(final ThreadGroup group, final <span class="built_in">String</span> namePrefix) &#123;</span><br><span class="line"><span class="keyword">this</span>.group = group;</span><br><span class="line"><span class="keyword">this</span>.namePrefix = namePrefix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Thread newThread(final Runnable r) &#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(group, r, namePrefix + threadNumber.getAndIncrement(),<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">t.setDaemon(<span class="literal">false</span>);</span><br><span class="line"><span class="keyword">if</span> (t.getPriority()!=Thread.NORM_PRIORITY)</span><br><span class="line">t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="ç®€å•çš„çº¿ç¨‹æ± å®ç°çš„åŸç†"><a href="#ç®€å•çš„çº¿ç¨‹æ± å®ç°çš„åŸç†" class="headerlink" title="ç®€å•çš„çº¿ç¨‹æ± å®ç°çš„åŸç†"></a>ç®€å•çš„çº¿ç¨‹æ± å®ç°çš„åŸç†</h2><p>executeæ–¹æ³•ï¼ˆThreadPollExecutorç±»ä¸­ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> execute(Runnable command) &#123;</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Proceed in 3 steps:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 1. If fewer than corePoolSize threads are running, try to</span></span><br><span class="line"><span class="comment">         * start a new thread with the given command as its first</span></span><br><span class="line"><span class="comment">         * task.  The call to addWorker atomically checks runState and</span></span><br><span class="line"><span class="comment">         * workerCount, and so prevents false alarms that would add</span></span><br><span class="line"><span class="comment">         * threads when it shouldn't, by returning false.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 2. If a task can be successfully queued, then we still need</span></span><br><span class="line"><span class="comment">         * to double-check whether we should have added a thread</span></span><br><span class="line"><span class="comment">         * (because existing ones died since last checking) or that</span></span><br><span class="line"><span class="comment">         * the pool shut down since entry into this method. So we</span></span><br><span class="line"><span class="comment">         * recheck state and if necessary roll back the enqueuing if</span></span><br><span class="line"><span class="comment">         * stopped, or start a new thread if there are none.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 3. If we cannot queue task, then we try to add a new</span></span><br><span class="line"><span class="comment">         * thread.  If it fails, we know we are shut down or saturated</span></span><br><span class="line"><span class="comment">         * and so reject the task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            int recheck = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">            reject(command);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯å°†çº¿ç¨‹æ”¾åˆ°äº†workqueueä¸­ï¼ŒworkQueueæ˜¯ä¸€ä¸ªblockingQueueï¼Œå¦‚æœé‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œå°±ä¸æ‹¿ï¼Œå¦‚æœæ»¡äº†ï¼Œå°±ç­‰å¾…ï¼Œæ„é€ å‚æ•°ä¸­çš„long keepAliveTimeå°±æ˜¯å¦‚æœè§„å®šæ—¶é—´å†…ä¸€ç›´åœ¨ç­‰å¾…ï¼Œè¶…å‡ºä¹‹åå°±é€€å‡º<br>ä¸Šè¿°ä»£ç ä¸­çš„ctlæ˜¯ä»€ä¹ˆï¼Ÿ</p><pre><code> * The main pool control state, ctl, is an atomic integer packing * ä»–æ˜¯ä¸€ä¸ªåŸå­çš„æ•´æ•° * two conceptual fieldsåŒ…è£…äº†ä¸¤ä¸ªé€»è¾‘ä¸Šçš„å­—æ®µï¼š *   workerCount, indicating the effective number of threadsçº¿ç¨‹æ€»æ•° *   runState,    indicating whether running, shutting down etcçº¿ç¨‹æ± æœ¬èº«çš„çŠ¶æ€ * The runState provides the main lifecyle control, taking on values:ä¸€äº› çº¿ç¨‹æ± çš„çŠ¶æ€ * *   RUNNING:  Accept new tasks and process queued taskså¯ä»¥æ·»åŠ æ–°çš„taskä¹Ÿå¯ä»¥å¤„ç†ä¸€äº›ä»»åŠ¡ *   SHUTDOWN: Don&apos;t accept new tasks, but process queued tasksä¸æ¥å—taskä½†æ˜¯æ¥å—task *   STOP:     Don&apos;t accept new tasks, don&apos;t process queued tasks, *             and interrupt in-progress tasksä¸æ¥å—taskï¼Œä¸å¤„ç†task *   TIDYING:  All tasks have terminated, workerCount is zero, *             the thread transitioning to state TIDYING *             will run the terminated() hook method *   TERMINATED: terminated() has completed</code></pre><p>ä¸‹é¢è¿™é‡Œï¼šäº†è§£å³å¯ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">é€šè¿‡control+jçœ‹åˆ°CAPACITYæ˜¯ä¸€ä¸ª<span class="number">29</span>ä½çš„æ•°ï¼Œå·¦ç§»ä¸€ä½ï¼Œå†å‡ä¸€ï¼Œå°±æ˜¯å‰äºŒåå…«ä½</span><br><span class="line">    private <span class="keyword">static</span> final int CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"> <span class="comment">//cå’ŒCAPACITYçš„æŒ‰ä½å–åï¼Œæœ€åå†å–ä¸ï¼Œå°±æ˜¯å‰ä¸‰ä½ï¼Œè¡¨ç¤ºçº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">    private <span class="keyword">static</span> int runStateOf(int c)     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">    <span class="comment">//cå’ŒCAPACITYæŒ‰ä½å–ä¸ï¼ˆéƒ½è½¬åŒ–æˆäºŒè¿›åˆ¶ï¼Œæ¯ä½è¿›è¡Œä¸çš„æ“ä½œï¼‰ï¼Œå¾—åˆ°cçš„å‰äºŒåå…«ä½</span></span><br><span class="line">    <span class="comment">//å¾—åˆ°äº†å½“å‰æœ‰å¤šå°‘ä¸ªçº¿ç¨‹</span></span><br><span class="line">    private <span class="keyword">static</span> int workerCountOf(int c)  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€å¾€ä¸‹çœ‹<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int c = ctl.get();</span><br><span class="line"><span class="comment">//å¦‚æœå½“å‰çº¿ç¨‹çš„æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="comment">//åŠ å…¥è¿›å»</span></span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// å¦‚æœåŠ å…¥å¤±è´¥äº†ï¼Œå°±å°†è¿™ä¸ªæ“ä½œæ”¾åˆ°workqueueä¸­ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            int recheck = ctl.get();</span><br><span class="line">            <span class="comment">//å¦‚æœåœ¨å¾€queueé‡Œé¢åŠ çš„è¿‡ç¨‹ä¸­ï¼Œç®€ç§°çº¿ç¨‹æ± ï¼Œå‘ç°ä¸å†æ˜¯runningçš„çŠ¶æ€</span></span><br><span class="line">            <span class="comment">//å°±æ‹’ç»æ‰è¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">                <span class="comment">//å¦‚æœæ£€æŸ¥å‘ç°æ­£åœ¨è·‘çš„çº¿ç¨‹æ˜¯é›¶ï¼Œå°±addworkè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é¦–é€‰çš„ä¸æ˜¯rejectè€Œæ˜¯å…ˆè¿›è¡Œä¸Šé¢çš„æ”¾å…¥queue</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸Šé¢åˆ¤æ–­åŠ å¦‚é˜Ÿåˆ—æ²¡æœ‰é˜Ÿåˆ—æ»¡äº†ï¼Œå¡ä¸è¿›å»äº†ï¼Œåœ¨è¿™é‡Œå†å°è¯•åŠ å…¥ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯falseï¼Œçº¿ç¨‹çš„æ•°é‡ä¸åœ¨æ”¶åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°é‡çš„é™åˆ¶ï¼Œè€Œæ˜¯å—åˆ°</span></span><br><span class="line">        <span class="comment">//æœ€å¤§çº¿ç¨‹æ•°çš„é™åˆ¶ã€‚å¦‚æœè¿™æ ·éƒ½å¤±è´¥äº†ï¼Œå°±è¿›è¡Œrejectæ‹’ç»ç­–ç•¥ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">            reject(command);</span><br></pre></td></tr></table></figure><p></p><h1 id="4-ForkJoin"><a href="#4-ForkJoin" class="headerlink" title="4. ForkJoin"></a>4. ForkJoin</h1><p>ä¸€ä¸ªæ¯”è¾ƒæ–°çš„çº¿ç¨‹æ± </p><h2 id="4-1-æ€æƒ³"><a href="#4-1-æ€æƒ³" class="headerlink" title="4.1. æ€æƒ³"></a>4.1. æ€æƒ³</h2><h3 id="4-1-1"><a href="#4-1-1" class="headerlink" title="4.1.1."></a>4.1.1.</h3><p><img alt="" data-original="/images/15499797945926.png"></p><p>å°†å¤§ä»»åŠ¡åˆ†æˆå°ä»»åŠ¡ï¼Œjoinç­‰å¾…æ‰€æœ‰çš„å°ä»»åŠ¡ç»“æŸå†æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œforkå°†å°ä»»åŠ¡æ¨å‘çº¿ç¨‹æ± ã€‚</p><h2 id="4-2-ä½¿ç”¨æ¥å£"><a href="#4-2-ä½¿ç”¨æ¥å£" class="headerlink" title="4.2. ä½¿ç”¨æ¥å£"></a>4.2. ä½¿ç”¨æ¥å£</h2><h3 id="4-2-1-RecursiveAction"><a href="#4-2-1-RecursiveAction" class="headerlink" title="4.2.1. RecursiveAction"></a>4.2.1. RecursiveAction</h3><p>æ— è¿”å›å€¼</p><h3 id="4-2-2-RecursiveTask"><a href="#4-2-2-RecursiveTask" class="headerlink" title="4.2.2. RecursiveTask"></a>4.2.2. RecursiveTask</h3><p>æœ‰è¿”å›å€¼</p><h2 id="4-3-ç®€å•ä¾‹å­"><a href="#4-3-ç®€å•ä¾‹å­" class="headerlink" title="4.3. ç®€å•ä¾‹å­"></a>4.3. ç®€å•ä¾‹å­</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinTask;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CountTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">private <span class="keyword">static</span> final int ThRESHOLD = <span class="number">10000</span>;</span><br><span class="line">private long start;</span><br><span class="line">private long end;</span><br><span class="line">public CountTask(long start,long end)&#123;</span><br><span class="line"><span class="keyword">this</span>.start = start;</span><br><span class="line"><span class="keyword">this</span>.end = end;</span><br><span class="line">&#125;</span><br><span class="line">protected Long compute() &#123;</span><br><span class="line">long sum = <span class="number">0</span>;</span><br><span class="line">boolean canCompute = (end - start) &lt; ThRESHOLD;</span><br><span class="line"><span class="keyword">if</span> (canCompute) &#123;</span><br><span class="line"><span class="keyword">for</span> (long i = start; i &lt;= end; i++) &#123;</span><br><span class="line">sum += i;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">//åˆ†æˆ100ä¸ªå°ä»»åŠ¡</span></span><br><span class="line">long step = (start + end) / <span class="number">100</span>;</span><br><span class="line">ArrayList&lt;CountTask&gt; subTasks = <span class="keyword">new</span> ArrayList&lt;CountTask&gt;();</span><br><span class="line">long pos = start;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">100</span> ; i++) &#123;</span><br><span class="line">long lastOne = pos + step;</span><br><span class="line"><span class="keyword">if</span> (lastOne&gt;end) &#123;</span><br><span class="line">lastOne  = end;</span><br><span class="line">&#125;</span><br><span class="line">CountTask subTask = <span class="keyword">new</span> CountTask(pos, lastOne);</span><br><span class="line">pos += step + <span class="number">1</span>;</span><br><span class="line">subTasks.add(subTask);</span><br><span class="line"><span class="comment">//å°†ç°ä»»åŠ¡åŠ è¿›å»</span></span><br><span class="line">subTask.fork();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (CountTask t : subTasks) &#123;</span><br><span class="line"><span class="comment">//ç­‰å¾…æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆåå†ç»§ç»­ç›¸åº”çš„æ“ä½œ</span></span><br><span class="line">sum += t.join();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">CountTask task = <span class="keyword">new</span> CountTask(<span class="number">0</span>, <span class="number">20000</span>L);</span><br><span class="line">ForkJoinTask&lt;Long&gt; result = forkJoinPool.submit(task);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">long res = result.get();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"sum="</span>+res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum=<span class="number">200010000</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­è¦å®ç°çš„æ˜¯å°† CountTask task = new CountTask(0, 20000L);<br>è¿™å¥è¯ä¸­çš„startåˆ°endè¿›è¡Œç´¯åŠ è¿ç®—ï¼Œå¦‚æœend-start&lt;ThRESHOLD,å°±ç›´æ¥ç´¯åŠ ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªé˜ˆå€¼å°±é€šè¿‡ForkJoinå°†ä»»åŠ¡åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œè¿›è¡Œç´¯åŠ ï¼Œæ‰€æœ‰çš„å­ä»»åŠ¡å®Œæˆä¹‹åå†æ±‚å’Œã€‚</p><h2 id="4-4-å®ç°è¦ç´ "><a href="#4-4-å®ç°è¦ç´ " class="headerlink" title="4.4. å®ç°è¦ç´ "></a>4.4. å®ç°è¦ç´ </h2><p>æºç è§£æ<br>åœ¨ForkJoinä¸­æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„å·¥ä½œé˜Ÿåˆ—WorkQueueåœ¨ForkJoinPoolä¸­æœ‰è¿™ä¸ªå†…éƒ¨ç±»</p><h3 id="workQueue"><a href="#workQueue" class="headerlink" title="workQueue"></a>workQueue</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@sun.misc.Contended</span><br><span class="line">    <span class="keyword">static</span> final <span class="class"><span class="keyword">class</span> <span class="title">WorkQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Capacity of work-stealing queue array upon initialization.</span></span><br><span class="line"><span class="comment">         * Must be a power of two; at least 4, but should be larger to</span></span><br><span class="line"><span class="comment">         * reduce or eliminate cacheline sharing among queues.</span></span><br><span class="line"><span class="comment">         * Currently, it is much larger, as a partial workaround for</span></span><br><span class="line"><span class="comment">         * the fact that JVMs often place arrays in locations that</span></span><br><span class="line"><span class="comment">         * share GC bookkeeping (especially cardmarks) such that</span></span><br><span class="line"><span class="comment">         * per-write accesses encounter serious memory contention.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> final int INITIAL_QUEUE_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Maximum size for queue arrays. Must be a power of two less</span></span><br><span class="line"><span class="comment">         * than or equal to 1 &lt;&lt; (31 - width of array entry) to ensure</span></span><br><span class="line"><span class="comment">         * lack of wraparound of index calculations, but defined to a</span></span><br><span class="line"><span class="comment">         * value a bit less than this to help users trap runaway</span></span><br><span class="line"><span class="comment">         * programs before saturating systems.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> final int MAXIMUM_QUEUE_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">26</span>; <span class="comment">// 64M</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Instance fields</span></span><br><span class="line">        volatile int scanState;    <span class="comment">// versioned, &lt;0: inactive; odd:scanning</span></span><br><span class="line">        int stackPred;            <span class="comment">// è®°å½•å‰ä¸€ä¸ªæ ˆé¡¶çš„ctl</span></span><br><span class="line"></span><br><span class="line">        int nsteals;               <span class="comment">// number of steals</span></span><br><span class="line">        int hint;                  <span class="comment">// randomization and stealer index hint</span></span><br><span class="line">        int config;                <span class="comment">// pool index and mode</span></span><br><span class="line">        volatile int qlock;        <span class="comment">// 1: locked, &lt; 0: terminate; else 0</span></span><br><span class="line">        volatile int base;         <span class="comment">// index of next slot for poll</span></span><br><span class="line">        int top;                   <span class="comment">// index of next slot for push</span></span><br><span class="line">        ForkJoinTask&lt;?&gt;[] array;   <span class="comment">// the elements (initially unallocated)</span></span><br><span class="line">        final ForkJoinPool pool;   <span class="comment">// the containing pool (may be null)</span></span><br><span class="line">        final ForkJoinWorkerThread owner; <span class="comment">// owning thread or null if shared</span></span><br><span class="line">        volatile Thread parker;    <span class="comment">// == owner during call to park; else null</span></span><br><span class="line">        volatile ForkJoinTask&lt;?&gt; currentJoin;  <span class="comment">// task being joined in awaitJoin</span></span><br><span class="line">        volatile ForkJoinTask&lt;?&gt; currentSteal; <span class="comment">// mainly used by helpStealer</span></span><br><span class="line"></span><br><span class="line">        WorkQueue(ForkJoinPool pool, ForkJoinWorkerThread owner) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pool = pool;</span><br><span class="line">            <span class="keyword">this</span>.owner = owner;</span><br><span class="line">            <span class="comment">// Place indices in the center of array (that is not yet allocated)</span></span><br><span class="line">            base = top = INITIAL_QUEUE_CAPACITY &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns an exportable index (used by ForkJoinWorkerThread).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        final int getPoolIndex() &#123;</span><br><span class="line">            <span class="keyword">return</span> (config &amp; <span class="number">0xffff</span>) &gt;&gt;&gt; <span class="number">1</span>; <span class="comment">// ignore odd/even tag bit</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns the approximate number of tasks in the queue.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        final int queueSize() &#123;</span><br><span class="line">            int n = base - top;       <span class="comment">// non-owner callers must read base first</span></span><br><span class="line">            <span class="keyword">return</span> (n &gt;= <span class="number">0</span>) ? <span class="number">0</span> : -n; <span class="comment">// ignore transient negative</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Provides a more accurate estimate of whether this queue has</span></span><br><span class="line"><span class="comment">         * any tasks than does queueSize, by checking whether a</span></span><br><span class="line"><span class="comment">         * near-empty queue has at least one unclaimed task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        final boolean isEmpty() &#123;</span><br><span class="line">            ForkJoinTask&lt;?&gt;[] a; int n, m, s;</span><br><span class="line">            <span class="keyword">return</span> ((n = base - (s = top)) &gt;= <span class="number">0</span> ||</span><br><span class="line">                    (n == <span class="number">-1</span> &amp;&amp;           <span class="comment">// possibly one task</span></span><br><span class="line">                     ((a = array) == <span class="literal">null</span> || (m = a.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                      U.getObject</span><br><span class="line">                      (a, (long)((m &amp; (s - <span class="number">1</span>)) &lt;&lt; ASHIFT) + ABASE) == <span class="literal">null</span>)));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><strong><font color="red">æ³¨æ„ï¼šä¸Šé¢çš„ä»£ç å‡ºè‡ªæˆ‘æœ¬äººidea jdk1.8ï¼Œä½†æ˜¯å’Œè§†é¢‘ä¸­è®²è§£çš„jdk1.8ä»£ç ç‰‡ä¸ä¸€æ ·ï¼Œä¸»è¦è®²è§£äº†workqueueä¸­çš„æŸäº›å­—æ®µï¼Œçº¿é¢çš„è®²è§£æ˜¯è§†é¢‘ä¸­çš„å­—æ®µï¼Œå¹¶éä¸Šé¢çš„ä»£ç ç‰‡ã€‚</font></strong></p><p>ä¸æ˜¯æ‰€æœ‰çš„çº¿ç¨‹ä¸€ç›´éƒ½åœ¨å·¥ä½œï¼Œæœ‰çš„çº¿ç¨‹æœ‰æ—¶å€™ä¼šè¢«æŒ‚èµ·ï¼ŒæŒ‚èµ·çš„æ—¶å€™çº¿ç¨‹æ± éœ€è¦çŸ¥é“è°è¢«æŒ‚èµ·ï¼Œè¿™æ ·å°±å¯ä»¥æ–°çš„ä»»åŠ¡æ¥çš„æ—¶å€™ï¼Œå°±ä»æŒ‚èµ·çš„çº¿ç¨‹é‡Œé¢å”¤é†’ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œforkjoinå°±åšè¿™ä»¶äº‹æƒ…ï¼Œæ‰€æœ‰è¢«æŒ‚èµ·çš„çº¿ç¨‹ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªæ ˆï¼ˆå…ˆè¿›åå‡ºï¼‰é‡Œé¢ï¼Œæ ˆçš„å†…éƒ¨æ˜¯é€šè¿‡é“¾è¡¨å®ç°çš„ï¼Œnextwaitå°±æ˜¯é“¾è¡¨ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œpoolindexï¼Œå½“å‰çº¿ç¨‹åœ¨çº¿ç¨‹æ± ä¸­çš„idç¼–å·ï¼Œeventcountï¼Œå½“å‰çš„çº¿ç¨‹è¢«æŒ‚èµ·äº†å¤šå°‘æ¬¡ï¼Œæ¯æ¬¡è¢«æŒ‚èµ·éƒ½ä¼šåšä¸€ä¸ªç´¯åŠ å¦‚æœå°äº0ï¼Œå°±æ˜¯inactiveçš„çŠ¶æ€ï¼ˆæ²¡æœ‰è¢«æ¿€æ´»ï¼Œï¼‰eventcountè¿˜æœ‰ä¸€ä¸ªå«ä¹‰ï¼Œå°±æ˜¯å½“å‰çš„poolindexæ˜¯å¤šå°‘ï¼Œåœ¨ç›¸å…³çš„ä»£ç ç‰‡ä¸­ï¼ˆæˆ‘è¿™é‡Œå®åœ¨æ˜¯æ‰¾ä¸åˆ°ï¼‰åœ¨æ³¨å†Œçš„æ—¶å€™poolindexå’Œeventactiveæ˜¯èµ‹äºˆäº†åŒä¸€ä¸ªå€¼ï¼Œeventcountæ˜¯ä¸€ä¸ª32ä½çš„æ•°å­—ï¼Œç¬¬ä¸€ä¸ªbiteè¡¨ç¤ºæ˜¯å¦è¢«æ¿€æ´»ï¼Œå…¶ä»–çš„biteè¡¨ç¤ºpoolindexï¼Œæ‰€æœ‰çš„å†…å®¹æ”¾åœ¨arrayä¸­ï¼Œarrayä¸­çš„baseå’Œtopä¸­é—´ä½¿æˆ‘ä»¬çš„çº¿ç¨‹</p><h3 id="ctl"><a href="#ctl" class="headerlink" title="ctl"></a>ctl</h3><p>åœ¨ForkJoinPoolä¸­åŒæ ·æœ‰å’Œä¸Šé¢çš„threadPoolä¸€æ ·çš„ctlçš„å­—æ®µ<br>å¹¶ä¸æ˜¯åŸå­çš„æ•´æ•°ï¼Œæ˜¯langå‹çš„<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//* Bits and masks for field ctl, packed with 4 16 bit subfields:</span></span><br><span class="line">     <span class="comment">//* AC: Number of active running workers minus target parallelism æ´»è·ƒçš„çº¿ç¨‹æ•°å‡å»ç›®æ ‡å¹¶è¡Œåº¦ï¼ˆå¤§æ¦‚å°±æ˜¯å‡ ä¸ªcpuå°±æ˜¯å‡ ä¸ªå¹¶è¡Œåº¦ï¼‰</span></span><br><span class="line">     <span class="comment">//* TC: Number of total workers minus target parallelismæ€»çš„çº¿ç¨‹æ•°å‡å»ç›®æ ‡å¹¶è¡Œåº¦ï¼ˆå¤§æ¦‚å°±æ˜¯å‡ ä¸ªcpuå°±æ˜¯å‡ ä¸ªå¹¶è¡Œåº¦ï¼‰</span></span><br><span class="line">     <span class="comment">//* SS: version count and status of top waiting threadçº¿ç¨‹æ± æœ¬èº«æ˜¯å¦æ˜¯æ¿€æ´»çš„</span></span><br><span class="line">     <span class="comment">//EC eventcounté¡¶éƒ¨ç­‰å¾…çš„å †æ ˆé¡¶ç«¯çš„çº¿ç¨‹çš„eventcountçš„å€¼</span></span><br><span class="line">     <span class="comment">//* ID: poolIndex of top of Treiber stack of waiters poolIndexé¡¶éƒ¨ç­‰å¾…çš„å †æ ˆé¡¶ç«¯çš„çº¿ç¨‹çš„poolIndexçš„å€¼</span></span><br><span class="line">     <span class="comment">//æ³¨æ„tc ss  idä¸‰ä¸ªç›¸åŠ æ°å¥½æ˜¯ä¸€ä¸ªintï¼Œè¿™é‡Œå°±æ˜¯åˆšæ‰æ‰€è¯´çš„eventcount</span></span><br><span class="line">volatile long ctl;                   <span class="comment">// main pool control</span></span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">å£°æ˜ä¸€ä¸‹ï¼š<br>æ˜æ˜æœ‰äº”ä¸ªå˜é‡ï¼Œä¸ºä»€ä¹ˆä¸åˆ†æˆäº”ä¸ªï¼Œä¸€å®šè¦æ‰“åŒ…åœ¨ctlä¸­å‘¢ï¼Ÿçœ‹èµ·æ¥å¢åŠ äº†æ•°æ®çš„å¤æ‚æ€§ï¼Œå¯è¯»æ€§ä¹Ÿå˜å·®äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</font></strong></p><p>å› ä¸ºåŠ å…¥å¤šä¸ªçº¿ç¨‹æ¥æ“ä½œForkJoinï¼Œä¸€ä¸ªæ“ä½œäº†ACï¼Œä¸€ä¸ªæ“ä½œäº†TCï¼Œè¿™æ ·å¦‚ä½•ä¿è¯ACå’ŒTCæ˜¯å±äºä¸€ä¸ªçš„ï¼Ÿç”¨é”å—ï¼Ÿè¿™æ ·å¯¹æ•ˆç‡æœ‰å¾ˆå¤§çš„é™ä½ï¼Œä½†æ˜¯å¦‚æœå°†æ‰€æœ‰çš„æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œæ•°æ®çš„ä¸€è‡´æ€§æ˜¯ä¸€å®šèƒ½å¤Ÿä¿è¯çš„ï¼Œè¯»å†™çš„æ—¶å€™æ˜¯åŸå­æ€§çš„ï¼Œä¸€æ¬¡casï¼ˆæ— é”ï¼‰ï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰çš„æ•°æ®è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼Œå¹¶ä¸”ä¿è¯ä¸ä¼šå’Œå…¶ä»–çº¿ç¨‹äº§ç”Ÿå†²çªï¼Œåœ¨æ€§èƒ½ä¸Šèƒ½å¾—åˆ°å¤§å¤§çš„æå‡ã€‚é€šè¿‡æ— é”çš„æ“ä½œï¼Œä»£æ›¿äº†å¤šä¸ªSynchronizeæ“ä½œ<br>ç›®å‰æ˜¯ä¸æ”¯æŒå¯¹å¤šä¸ªå˜é‡è¿›è¡Œcasæ“ä½œçš„ã€‚<br>å°±åƒå¦‚ä¸‹ä»£ç <br>tryAddWorkerï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">void</span> tryAddWorker(long c) &#123;</span><br><span class="line">        boolean add = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            long nc = ((AC_MASK &amp; (c + AC_UNIT)) |</span><br><span class="line">                       (TC_MASK &amp; (c + TC_UNIT)));</span><br><span class="line">            <span class="keyword">if</span> (ctl == c) &#123;</span><br><span class="line">                int rs, stop;                 <span class="comment">// check if terminating</span></span><br><span class="line">                <span class="keyword">if</span> ((stop = (rs = lockRunState()) &amp; STOP) == <span class="number">0</span>)</span><br><span class="line">                    add = U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc);</span><br><span class="line">                unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">                <span class="keyword">if</span> (stop != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (add) &#123;</span><br><span class="line">                    createWorker();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (((c = ctl) &amp; ADD_WORKER) != <span class="number">0</span>L &amp;&amp; (int)c == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>å…ˆå°†ctlä¸­çš„æ¯ä¸€ä¸ªå–å‡ºæ¥åšç›¸åº”çš„æ“ä½œï¼Œåœ¨å åŠ åˆ°ä¸€èµ·è¿›è¡Œcasçš„æ“ä½œã€‚</p><h3 id="4-4-1-å·¥ä½œçªƒå–"><a href="#4-4-1-å·¥ä½œçªƒå–" class="headerlink" title="4.4.1. å·¥ä½œçªƒå–"></a>4.4.1. å·¥ä½œçªƒå–</h3><p><img alt="" data-original="/images/15499798120897.png"></p><p>scanæ–¹æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">private ForkJoinTask&lt;?&gt; scan(WorkQueue w, int r) &#123;</span><br><span class="line">        WorkQueue[] ws; int m;</span><br><span class="line">        <span class="keyword">if</span> ((ws = workQueues) != <span class="literal">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt; <span class="number">0</span> &amp;&amp; w != <span class="literal">null</span>) &#123;</span><br><span class="line">            int ss = w.scanState;                     <span class="comment">// initially non-negative</span></span><br><span class="line">            <span class="keyword">for</span> (int origin = r &amp; m, k = origin, oldSum = <span class="number">0</span>, checkSum = <span class="number">0</span>;;) &#123;</span><br><span class="line">                WorkQueue q; ForkJoinTask&lt;?&gt;[] a; ForkJoinTask&lt;?&gt; t;</span><br><span class="line">                int b, n; long c;</span><br><span class="line">                <span class="keyword">if</span> ((q = ws[k]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((n = (b = q.base) - q.top) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        (a = q.array) != <span class="literal">null</span>) &#123;      <span class="comment">// non-empty</span></span><br><span class="line">                        long i = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                        <span class="keyword">if</span> ((t = ((ForkJoinTask&lt;?&gt;)</span><br><span class="line">                                  U.getObjectVolatile(a, i))) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                            q.base == b) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (ss &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (U.compareAndSwapObject(a, i, t, <span class="literal">null</span>)) &#123;</span><br><span class="line">                                    q.base = b + <span class="number">1</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)       <span class="comment">// signal others</span></span><br><span class="line">                                        signalWork(ws, q);</span><br><span class="line">                                        runtaskï¼ˆï¼‰;</span><br><span class="line">                                    <span class="comment">//ä¸‹é¢è§£é‡Š</span></span><br><span class="line">                                    <span class="keyword">return</span> t;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span> (oldSum == <span class="number">0</span> &amp;&amp;   <span class="comment">// try to activate</span></span><br><span class="line">                                     w.scanState &lt; <span class="number">0</span>)</span><br><span class="line">                                tryRelease(c = ctl, ws[m &amp; (int)c], AC_UNIT);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (ss &lt; <span class="number">0</span>)                   <span class="comment">// refresh</span></span><br><span class="line">                            ss = w.scanState;</span><br><span class="line">                        r ^= r &lt;&lt; <span class="number">1</span>; r ^= r &gt;&gt;&gt; <span class="number">3</span>; r ^= r &lt;&lt; <span class="number">10</span>;</span><br><span class="line">                        origin = k = r &amp; m;           <span class="comment">// move and rescan</span></span><br><span class="line">                        oldSum = checkSum = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    checkSum += b;</span><br><span class="line">                &#125;</span><br><span class="line">               <span class="comment">//å¦‚æœscanæ“ä½œæ²¡æœ‰ä»»åŠ¡çš„è¯ï¼Œactivecountå°±å‡ä¸€ï¼Œç„¶åå°†poolindexï¼Œnextwaitï¼Œç­‰å †æ ˆä¿¡æ¯ï¼Œ</span></span><br><span class="line">               <span class="comment">//ä¿å­˜åˆ°ctlä¸­ï¼Œå¹¶æŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚</span></span><br><span class="line">             </span><br><span class="line">                <span class="keyword">if</span> ((k = (k + <span class="number">1</span>) &amp; m) == origin) &#123;    <span class="comment">// continue until stable</span></span><br><span class="line">                    <span class="keyword">if</span> ((ss &gt;= <span class="number">0</span> || (ss == (ss = w.scanState))) &amp;&amp;</span><br><span class="line">                        oldSum == (oldSum = checkSum)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ss &lt; <span class="number">0</span> || w.qlock &lt; <span class="number">0</span>)    <span class="comment">// already inactive</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        int ns = ss | INACTIVE;       <span class="comment">// try to inactivate</span></span><br><span class="line">                        <span class="comment">//UC_MASK &amp; ((c = ctl) - AC_UNIT)ï¼Œactivecount-1ï¼Œactivecountæ˜¯å‰åå…­ä½ï¼Œæ‰€ä»¥å‡å»10000000000000ï¼Œå°±æ˜¯</span></span><br><span class="line">                        long nc = ((SP_MASK &amp; ns) |</span><br><span class="line">                                   (UC_MASK &amp; ((c = ctl) - AC_UNIT)));</span><br><span class="line">                        w.stackPred = (int)c;         <span class="comment">// hold prev stack top</span></span><br><span class="line">                        U.putInt(w, QSCANSTATE, ns);</span><br><span class="line">                        <span class="comment">//ç„¶åé€šè¿‡racæ“ä½œå°†ncèµ‹å€¼åˆ°ctlä¸Š</span></span><br><span class="line">                        <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc))</span><br><span class="line">                            ss = ns;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            w.scanState = ss;         <span class="comment">// back out</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    checkSum = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå¥½çš„ä½“ç°å‡ºforkjoinæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œ<br>å¯ä»¥çœ‹åˆ°ï¼Œscanæ–¹æ³• è™½ç„¶æ˜¯åœ¨æœ¬çº¿ç¨‹ï¼Œä½†æ˜¯ï¼Œæ˜¯åœ¨æ‰§è¡Œå…¶ä»–çš„workqueueä¸­çš„baseï¼Œä¸Šé¢è¯´åˆ°çº¿ç¨‹éƒ½ä¿å­˜åœ¨äº†workqueueä¸­ï¼Œå°±æ˜¯è¯´ä¸æ˜¯ç›²ç›®çš„åšè‡ªå·±çš„ä»»åŠ¡ï¼Œè¿˜çœ‹ä¸€çœ‹å‘¨å›´çš„çº¿ç¨‹çš„ä»»åŠ¡æ˜¯å¦é¥¥é¥¿ï¼Œä¼šæœ‰æ•ˆçš„é¿å…é¥¥é¥¿çš„ç°è±¡å‘ç”Ÿã€‚<br>runtaskï¼ˆï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">      * Executes the given task and any remaining local tasks.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     final <span class="keyword">void</span> runTask(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">         <span class="keyword">if</span> (task != <span class="literal">null</span>) &#123;</span><br><span class="line">             scanState &amp;= ~SCANNING; <span class="comment">// mark as busy</span></span><br><span class="line">             (currentSteal = task).doExec();</span><br><span class="line">             U.putOrderedObject(<span class="keyword">this</span>, QCURRENTSTEAL, <span class="literal">null</span>); <span class="comment">// release for GC</span></span><br><span class="line">             execLocalTasks();</span><br><span class="line">             ForkJoinWorkerThread thread = owner;</span><br><span class="line">             <span class="keyword">if</span> (++nsteals &lt; <span class="number">0</span>)      <span class="comment">// collect on overflow</span></span><br><span class="line">                 transferStealCount(pool);</span><br><span class="line">             scanState |= SCANNING;</span><br><span class="line">             <span class="keyword">if</span> (thread != <span class="literal">null</span>)</span><br><span class="line">                 thread.afterTopLevelExec();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15499798252052.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”t1é˜Ÿåˆ—ï¼Œå®ƒéœ€è¦çœ‹å…¶ä»–é˜Ÿåˆ—ï¼ˆt2ï¼‰çš„baseèŠ‚ç‚¹ï¼Œç„¶åä»è‡ªå·±çš„topèŠ‚ç‚¹å¼€å§‹å¤„ç†ï¼Œå…¶ä»–çº¿ç¨‹å¯¹åº”t2é˜Ÿåˆ—ï¼Œåˆ™åŒç†ï¼Œè¿™æ ·èƒ½å¾ˆå¥½çš„é¿å…å†²çªã€‚<br>å¸®åŠ©åˆ«äººåšå¯èƒ½æ¯”è‡ªå·±åšè‡ªå·±çš„æ€§èƒ½è¦å¥½ä¸€ç‚¹ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;1-çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#1-çº¿ç¨‹æ± çš„åŸºæœ¬ä½¿ç”¨&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>é€šè¿‡JAVAä¸­çš„httpclientåˆ·å–CSDNåšå®¢è®¿é—®é‡</title>
    <link href="http://mmmmmm.me/2019-02-08.html"/>
    <id>http://mmmmmm.me/2019-02-08.html</id>
    <published>2019-02-08T11:20:01.000Z</published>
    <updated>2019-02-09T08:54:43.419Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="config-properties"><a href="#config-properties" class="headerlink" title="config.properties"></a>config.properties</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">The_home_page=https:<span class="comment">//blog.csdn.net/dataiyangu</span></span><br><span class="line">IP_And_Port=<span class="number">171.41</span><span class="number">.81</span><span class="number">.5</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">218.60</span><span class="number">.8</span><span class="number">.98</span>:<span class="number">3129</span>,\</span><br><span class="line">  <span class="number">218.60</span><span class="number">.8</span><span class="number">.99</span>:<span class="number">3129</span>,\</span><br><span class="line">  <span class="number">113.200</span><span class="number">.56</span><span class="number">.13</span>:<span class="number">8010</span>,\</span><br><span class="line">  <span class="number">171.41</span><span class="number">.82</span><span class="number">.89</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">1.48</span><span class="number">.150</span><span class="number">.228</span>:<span class="number">8118</span>,\</span><br><span class="line">  <span class="number">171.41</span><span class="number">.82</span><span class="number">.169</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">115.151</span><span class="number">.2</span><span class="number">.133</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">59.62</span><span class="number">.167</span><span class="number">.5</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">110.52</span><span class="number">.235</span><span class="number">.121</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">124.235</span><span class="number">.135</span><span class="number">.87</span>:<span class="number">80</span>,\</span><br><span class="line">  <span class="number">171.41</span><span class="number">.86</span><span class="number">.55</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">125.123</span><span class="number">.141</span><span class="number">.4</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">111.177</span><span class="number">.179</span><span class="number">.9</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">121.61</span><span class="number">.3</span><span class="number">.130</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">116.209</span><span class="number">.56</span><span class="number">.53</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">110.52</span><span class="number">.235</span><span class="number">.241</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">124.206</span><span class="number">.234</span><span class="number">.126</span>:<span class="number">3128</span>,\</span><br><span class="line">  <span class="number">110.52</span><span class="number">.235</span><span class="number">.150</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">218.204</span><span class="number">.204</span><span class="number">.90</span>:<span class="number">8118</span>,\</span><br><span class="line">  <span class="number">125.123</span><span class="number">.139</span><span class="number">.235</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">116.209</span><span class="number">.58</span><span class="number">.107</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">116.209</span><span class="number">.57</span><span class="number">.207</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">121.61</span><span class="number">.27</span><span class="number">.200</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">110.52</span><span class="number">.235</span><span class="number">.146</span>:<span class="number">9999</span>,\</span><br><span class="line">  <span class="number">121.254</span><span class="number">.214</span><span class="number">.219</span>:<span class="number">80</span>,\</span><br><span class="line">  <span class="number">66.70</span><span class="number">.147</span><span class="number">.197</span>:<span class="number">3128</span>,\</span><br><span class="line">  <span class="number">152.231</span><span class="number">.81</span><span class="number">.122</span>:<span class="number">53281</span>,\</span><br><span class="line">  <span class="number">91.134</span><span class="number">.137</span><span class="number">.31</span>:<span class="number">8118</span>,\</span><br><span class="line">  <span class="number">71.13</span><span class="number">.112</span><span class="number">.152</span>:<span class="number">3128</span>,\</span><br><span class="line">  <span class="number">223.93</span><span class="number">.172</span><span class="number">.248</span>:<span class="number">3128</span>,\</span><br><span class="line">  <span class="number">218.60</span><span class="number">.8</span><span class="number">.98</span>:<span class="number">3129</span>,\</span><br><span class="line">  <span class="number">218.207</span><span class="number">.212</span><span class="number">.86</span>:<span class="number">80</span>,\</span><br><span class="line">  <span class="number">218.60</span><span class="number">.8</span><span class="number">.99</span>:<span class="number">3129</span>,\</span><br><span class="line">  <span class="number">205.204</span><span class="number">.248</span><span class="number">.88</span>:<span class="number">9090</span>,\</span><br><span class="line">  <span class="number">109.236</span><span class="number">.89</span><span class="number">.172</span>:<span class="number">1080</span>,\</span><br><span class="line">  <span class="number">66.119</span><span class="number">.180</span><span class="number">.101</span>:<span class="number">80</span>,\</span><br><span class="line">  <span class="number">113.200</span><span class="number">.56</span><span class="number">.13</span>:<span class="number">8010</span> ,\</span><br><span class="line">  <span class="number">120.52</span><span class="number">.73</span><span class="number">.1</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">66.119</span><span class="number">.180</span><span class="number">.103</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">70.29</span><span class="number">.69</span><span class="number">.120</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">66.119</span><span class="number">.180</span><span class="number">.104</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">212.237</span><span class="number">.33</span><span class="number">.61</span>:<span class="number">3128</span> ,\</span><br><span class="line">  <span class="number">205.204</span><span class="number">.248</span><span class="number">.76</span>:<span class="number">9090</span> ,\</span><br><span class="line">  <span class="number">94.130</span><span class="number">.14</span><span class="number">.146</span>:<span class="number">31288</span> ,\</span><br><span class="line">  <span class="number">54.39</span><span class="number">.40</span><span class="number">.100</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">103.205</span><span class="number">.26</span><span class="number">.120</span>:<span class="number">80</span> ,\</span><br><span class="line">  <span class="number">51.254</span><span class="number">.92</span><span class="number">.205</span>:<span class="number">1080</span></span><br></pre></td></tr></table></figure><h1 id="CSDN"><a href="#CSDN" class="headerlink" title="CSDN"></a>CSDN</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketException;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketTimeoutException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CSDN</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> Properties getProperties() &#123;</span><br><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">InputStream resourceAsStream = CSDN.class.getResourceAsStream(<span class="string">"config.properties"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">properties.load(resourceAsStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> properties;</span><br><span class="line">&#125;</span><br><span class="line">private <span class="built_in">String</span> zhuye;</span><br><span class="line">private <span class="built_in">String</span> sousuo = <span class="string">"/article/details/"</span>;</span><br><span class="line">public CSDN() &#123;</span><br><span class="line">zhuye = getProperties().getProperty(<span class="string">"The_home_page"</span>);</span><br><span class="line">&#125;</span><br><span class="line">public CSDN(<span class="built_in">String</span> url) &#123;</span><br><span class="line">zhuye = url;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getZhuye() &#123;</span><br><span class="line"><span class="keyword">return</span> zhuye;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> setZhuye(<span class="built_in">String</span> zhuye) &#123;</span><br><span class="line"><span class="keyword">this</span>.zhuye = zhuye;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> getSousuo() &#123;</span><br><span class="line"><span class="keyword">return</span> sousuo;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> setSousuo(<span class="built_in">String</span> sousuo) &#123;</span><br><span class="line"><span class="keyword">this</span>.sousuo = sousuo;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="built_in">String</span> open(<span class="built_in">String</span> url) &#123;</span><br><span class="line">StringBuffer str = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">BufferedReader <span class="keyword">in</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">URL u = <span class="keyword">new</span> URL(url);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">/*åŸæ¥çš„ä»£ç */</span></span><br><span class="line"><span class="comment">//in = new BufferedReader(new InputStreamReader(u.openStream(), "UTF-8"));</span></span><br><span class="line">HttpURLConnection htpcon = (HttpURLConnection) u.openConnection();</span><br><span class="line">htpcon.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">htpcon.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">htpcon.setDoInput(<span class="literal">true</span>);</span><br><span class="line">htpcon.setUseCaches(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//æ²¡æœ‰çœ‹åˆ°è°ƒç”¨çš„åœ°æ–¹ï¼Œåº”è¯¥æ˜¯åœ¨å°†ä¹‹å‰çš„è¿æ¥åŠ¨æ€çš„æ’é™¤å¼‚å¸¸</span></span><br><span class="line">htpcon.setConnectTimeout(<span class="number">10000</span>);</span><br><span class="line">htpcon.setReadTimeout(<span class="number">10000</span>);</span><br><span class="line">InputStream inputStream = htpcon.getInputStream();</span><br><span class="line"><span class="keyword">in</span> = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, <span class="string">"UTF-8"</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"æœ¬æ¬¡è¯·æ±‚è¶…æ—¶äº†ï¼Œåˆ«è¦æ…Œå¼ ã€‚"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"è¶…æ—¶äº†"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">in</span> != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="built_in">String</span> s = <span class="keyword">in</span>.readLine();</span><br><span class="line"><span class="keyword">if</span> (s == <span class="literal">null</span>) <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">else</span> str.append(s);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"ä¸Šé¢çš„è¿™ä¸ªä»£ç†å¤±æ•ˆäº†ï¼Œè¯·æ›´æ¢ã€‚"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"ä¸Šé¢çš„è¿™ä¸ªä»£ç†å¤±æ•ˆäº†ï¼Œè¯·æ›´æ¢ã€‚"</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">in</span> != <span class="literal">null</span>) <span class="keyword">in</span>.close();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> str.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public HashSet&lt;<span class="built_in">String</span>&gt; sousuoHTML(<span class="built_in">String</span> str) &#123;</span><br><span class="line">HashSet&lt;<span class="built_in">String</span>&gt; set = <span class="keyword">new</span> HashSet&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line">int st, end;</span><br><span class="line"><span class="keyword">while</span> ((st = str.indexOf(zhuye + sousuo)) != <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> ((end = str.indexOf(<span class="string">"\""</span>, st)) != <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="built_in">String</span> s = str.substring(st, end);</span><br><span class="line"><span class="keyword">if</span> (s.indexOf(<span class="string">"#comments"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">s = s.substring(<span class="number">0</span>, s.indexOf(<span class="string">"#comments"</span>));</span><br><span class="line">&#125;</span><br><span class="line">set.add(s);</span><br><span class="line">str = str.substring(end);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int getFangke() &#123;</span><br><span class="line"><span class="built_in">String</span> str = open(zhuye);</span><br><span class="line">int i;</span><br><span class="line"><span class="keyword">if</span> ((i = str.indexOf(<span class="string">"è®¿é—®ï¼š"</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">str = str.substring(i);</span><br><span class="line">str = str.substring(str.indexOf(<span class="string">"\""</span>) + <span class="number">1</span>);</span><br><span class="line">str = str.substring(<span class="number">0</span>, str.indexOf(<span class="string">"\""</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((i = str.indexOf(<span class="string">"personal_list"</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">str = str.substring(i);</span><br><span class="line">str.substring(str.indexOf(<span class="string">"&lt;em&gt;"</span>) + <span class="number">4</span>, str.indexOf(<span class="string">"&lt;/em&gt;"</span>));</span><br><span class="line">&#125;</span><br><span class="line">int ii = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ii = Integer.parseInt(str);</span><br><span class="line">&#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ii;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> daili(<span class="built_in">String</span> ip, <span class="built_in">String</span> dk) &#123;</span><br><span class="line">Properties prop = System.getProperties();</span><br><span class="line"><span class="comment">// è®¾ç½®httpè®¿é—®è¦ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨çš„åœ°å€</span></span><br><span class="line">prop.setProperty(<span class="string">"http.proxyHost"</span>, ip);</span><br><span class="line"><span class="comment">// è®¾ç½®httpè®¿é—®è¦ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨çš„ç«¯å£</span></span><br><span class="line">prop.setProperty(<span class="string">"http.proxyPort"</span>, dk);</span><br><span class="line"><span class="comment">// è®¾ç½®ä¸éœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®çš„ä¸»æœºï¼Œå¯ä»¥ä½¿ç”¨*é€šé…ç¬¦ï¼Œå¤šä¸ªåœ°å€ç”¨|åˆ†éš”</span></span><br><span class="line">prop.setProperty(<span class="string">"http.nonProxyHosts"</span>, <span class="string">"localhost|192.168.168.*"</span>);</span><br><span class="line"><span class="comment">// è®¾ç½®å®‰å…¨è®¿é—®ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨åœ°å€ä¸ç«¯å£</span></span><br><span class="line"><span class="comment">// å®ƒæ²¡æœ‰https.nonProxyHostså±æ€§ï¼Œå®ƒæŒ‰ç…§http.nonProxyHosts ä¸­è®¾ç½®çš„è§„åˆ™è®¿é—®</span></span><br><span class="line">prop.setProperty(<span class="string">"https.proxyHost"</span>, ip);</span><br><span class="line">prop.setProperty(<span class="string">"https.proxyPort"</span>, dk);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ftpä»£ç†æœåŠ¡å™¨çš„ä¸»æœºã€ç«¯å£ä»¥åŠä¸éœ€è¦ä½¿ç”¨ftpä»£ç†æœåŠ¡å™¨çš„ä¸»æœº</span></span><br><span class="line">prop.setProperty(<span class="string">"ftp.proxyHost"</span>, ip);</span><br><span class="line">prop.setProperty(<span class="string">"ftp.proxyPort"</span>, dk);</span><br><span class="line">prop.setProperty(<span class="string">"ftp.nonProxyHosts"</span>, <span class="string">"localhost|192.168.168.*"</span>);</span><br><span class="line"><span class="comment">// socksä»£ç†æœåŠ¡å™¨çš„åœ°å€ä¸ç«¯å£</span></span><br><span class="line">prop.setProperty(<span class="string">"socksProxyHost"</span>, ip);</span><br><span class="line">prop.setProperty(<span class="string">"socksProxyPort"</span>, dk);</span><br><span class="line">System.out.println(<span class="string">"å³å°†å¼€å§‹ä»£ç†è¿›è¡Œè®¿é—® ip:"</span> + ip + <span class="string">" port:"</span> + dk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">String</span>[] dl = getProperties().getProperty(<span class="string">"IP_And_Port"</span>).split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Main_thread</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">atomicInteger.set(<span class="number">1</span>);</span><br><span class="line">int i = <span class="number">0</span>;</span><br><span class="line">CSDN csdn = <span class="keyword">new</span> CSDN();</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">System.out.println(<span class="string">"å½“å‰åšå®¢è®¿é—®é‡ï¼š"</span> + csdn.getFangke()+<span class="string">""</span>);</span><br><span class="line">long a = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dl.length; i++) &#123;</span><br><span class="line"><span class="built_in">String</span>[] dd = dl[i].split(<span class="string">":"</span>);</span><br><span class="line">csdn.daili(dd[<span class="number">0</span>], dd[<span class="number">1</span>]);</span><br><span class="line">HashSet&lt;<span class="built_in">String</span>&gt; set = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">set = csdn.sousuoHTML(csdn.open(csdn.getZhuye()));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">System.out.println(<span class="string">"ä¸Šé¢çš„è¿™ä¸ªä»£ç†å¤±æ•ˆäº†ï¼Œè¯·æ›´æ¢ã€‚ã€‚ã€‚"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">String</span> url : set) &#123;</span><br><span class="line">csdn.open(url);</span><br><span class="line">System.out.println(<span class="string">"æ­£åœ¨æ‰“å¼€ï¼š"</span> + url);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"---------------------------------------------------------------------------"</span>);</span><br><span class="line">System.out.println(<span class="string">" "</span>);</span><br><span class="line">System.out.println(<span class="string">"æ‰€æœ‰çš„ä»£ç†å·²ç»è®¿é—®ï¼š"</span> + atomicInteger.getAndIncrement()+<span class="string">"æ¬¡"</span>);</span><br><span class="line"><span class="keyword">if</span> (csdn.getFangke() != <span class="number">0</span>) &#123;</span><br><span class="line">System.out.println(<span class="string">"å½“å‰åšå®¢è®¿é—®é‡ï¼š"</span> + csdn.getFangke()+<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line">long b = System.currentTimeMillis();</span><br><span class="line">long c = b - a;</span><br><span class="line">System.out.println(<span class="string">"æœ¬æ¬¡ä»£ç†è¯·æ±‚è€—æ—¶ï¼š"</span>+c+<span class="string">"ç§’"</span>);</span><br><span class="line"><span class="keyword">if</span>(c&gt;<span class="number">10000</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">double v = <span class="built_in">Math</span>.random() * <span class="number">10</span>;</span><br><span class="line">System.out.println(<span class="string">"å³å°†ä¼‘æ¯ï¼š"</span>+(long) (v*<span class="number">1000</span>)+<span class="string">"æ¯«ç§’"</span>);</span><br><span class="line">Thread.sleep((long) (v*<span class="number">1000</span>));</span><br><span class="line">System.out.println(<span class="string">"ä¼‘æ¯å®Œæˆï¼Œå³å°†å¼€å§‹ä¸‹è½®è®¿é—®ã€‚"</span>);</span><br><span class="line">System.out.println(<span class="string">" "</span>);</span><br><span class="line">System.out.println(<span class="string">"---------------------------------------------------------------------------"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">1</span> );</span><br><span class="line">Main_thread main_thread = <span class="keyword">new</span> Main_thread();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++) &#123;</span><br><span class="line">executorService.execute(main_thread);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h1><p>åªéœ€è¦å°†ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶æ”¾åœ¨javaé¡¹ç›®ä¸­çš„åŒä¸€ç›®å½•ä¸‹ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„åšå®¢åœ°å€å’Œä»£ç†ipã€portå³å¯ã€‚<br>ç„¶åå°†é¡¹ç›®æ‰“æˆjaråŒ…ï¼Œæ”¾åˆ°è‡ªå·±æœåŠ¡å™¨ä¸Š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar xxx.jar</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;config-properties&quot;&gt;&lt;a href=&quot;#config-properties&quot; class=&quot;he
      
    
    </summary>
    
      <category term="æŠ˜è…¾" scheme="http://mmmmmm.me/categories/%E6%8A%98%E8%85%BE/"/>
    
    
      <category term="æŠ˜è…¾" scheme="http://mmmmmm.me/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(åä¸€)ï¼Œnextä¸»é¢˜ä¸­åŠ å…¥scrollReveal.jsï¼Œè®©æ–‡ç« éšç€é¼ æ ‡çš„æ»šåŠ¨ï¼Œå‡ºç°ç‚¹å°åŠ¨ä½œã€‚</title>
    <link href="http://mmmmmm.me/2019-02-07.html"/>
    <id>http://mmmmmm.me/2019-02-07.html</id>
    <published>2019-02-07T11:20:01.000Z</published>
    <updated>2019-02-08T13:50:18.809Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h1><p><a href="https://mmmmmm.me">https://mmmmmm.me</a></p><h1 id="scrollRevealç®€å•ä»‹ç»ä»¥åŠç®€å•æ“ä½œ"><a href="#scrollRevealç®€å•ä»‹ç»ä»¥åŠç®€å•æ“ä½œ" class="headerlink" title="scrollRevealç®€å•ä»‹ç»ä»¥åŠç®€å•æ“ä½œ"></a>scrollRevealç®€å•ä»‹ç»ä»¥åŠç®€å•æ“ä½œ</h1><p>å°±æ˜¯åœ¨é¼ æ ‡æ»‘åŠ¨çš„æ—¶å€™ï¼Œé¡µé¢ä¸­çš„æŸä¸ªæ¨¡å—ä¼šåŠ¨æ€çš„åŠ è½½å‡ºæ¥ï¼Œä¸ä¼šæ˜¾å¾—é‚£ä¹ˆçªå…€ï¼Œå¢åŠ é¡µé¢çš„åŠ¨æ€æ•ˆæœã€‚</p><h2 id="å‚è€ƒæ–‡æ¡£ï¼š"><a href="#å‚è€ƒæ–‡æ¡£ï¼š" class="headerlink" title="å‚è€ƒæ–‡æ¡£ï¼š"></a>å‚è€ƒæ–‡æ¡£ï¼š</h2><p><a href="http://www.dowebok.com/134.html" target="_blank" rel="noopener">http://www.dowebok.com/134.html</a><br><a href="https://blog.csdn.net/lp2659359879/article/details/52582892" target="_blank" rel="noopener">https://blog.csdn.net/lp2659359879/article/details/52582892</a></p><h1 id="nextä¸»é¢˜ä¸­åŠ å…¥scrollReveal"><a href="#nextä¸»é¢˜ä¸­åŠ å…¥scrollReveal" class="headerlink" title="nextä¸»é¢˜ä¸­åŠ å…¥scrollReveal"></a>nextä¸»é¢˜ä¸­åŠ å…¥scrollReveal</h1><h2 id="ç»™articleæ ‡ç­¾æ·»åŠ å±æ€§"><a href="#ç»™articleæ ‡ç­¾æ·»åŠ å±æ€§" class="headerlink" title="ç»™articleæ ‡ç­¾æ·»åŠ å±æ€§"></a>ç»™articleæ ‡ç­¾æ·»åŠ å±æ€§</h2><p>è¿›å…¥ç›®å½•themes/next/layout/_macro/post.swig<br>æœç´¢åˆ°articleæ ‡ç­¾çš„ä½ç½®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;article data-scroll-reveal=<span class="string">"enter bottom move 60px over 0.6s after 0.05s"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"&#123;&#123; post_class &#125;&#125;"</span> itemscope itemtype=<span class="string">"http://schema.org/Article"</span>&gt;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé¢çš„ä»£ç data-scroll-reveal=â€enter bottom move 60px over 0.6s after 0.05sâ€ï¼Œå…·ä½“çš„å€¼è‡ªè¡Œä¿®æ”¹ã€‚</p><h2 id="ç»™åº•éƒ¨çš„ä¸è’œå­æ·»åŠ å±æ€§"><a href="#ç»™åº•éƒ¨çš„ä¸è’œå­æ·»åŠ å±æ€§" class="headerlink" title="ç»™åº•éƒ¨çš„ä¸è’œå­æ·»åŠ å±æ€§"></a>ç»™åº•éƒ¨çš„ä¸è’œå­æ·»åŠ å±æ€§</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> theme.busuanzi_count.enable %&#125;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"busuanzi-count"</span>&gt;</span><br><span class="line">  &lt;script <span class="keyword">async</span> src=<span class="string">"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">  &#123;% <span class="keyword">if</span> theme.busuanzi_count.site_uv %&#125;</span><br><span class="line">    &lt;span data-scroll-reveal=<span class="string">"enter left move 60px over 1s after 0.05s"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"site-uv"</span>&gt;</span><br><span class="line">      &#123;&#123; theme.busuanzi_count.site_uv_header &#125;&#125;</span><br><span class="line">      &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"busuanzi-value"</span> id=<span class="string">"busuanzi_value_site_uv"</span>&gt;&lt;/span&gt;</span><br><span class="line">      &#123;&#123; theme.busuanzi_count.site_uv_footer &#125;&#125;</span><br><span class="line">    &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">  &#123;% endif %&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  &#123;% if theme.busuanzi_count.site_pv %&#125;</span></span><br><span class="line"><span class="regexp">    &lt;span data-scroll-reveal="enter right move 60px over 1s after 0.05s" class="site-pv"&gt;</span></span><br><span class="line"><span class="regexp">      &#123;&#123; theme.busuanzi_count.site_pv_header &#125;&#125;</span></span><br><span class="line"><span class="regexp">      &lt;span class="busuanzi-value" id="busuanzi_value_site_pv"&gt;&lt;/</span>span&gt;</span><br><span class="line">      &#123;&#123; theme.busuanzi_count.site_pv_footer &#125;&#125;</span><br><span class="line">    &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">  &#123;% endif %&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œæœ€å¥½è®¾ç½®ä¸º60pxï¼Œå› ä¸ºå¤ªå¤§çš„è¯ä¼šå¯¼è‡´ç§»åŠ¨ç«¯çš„ç›’å­å˜å¤§ï¼Œå®½åº¦å°±ä¼šè¢«æ’‘å¼€äº†ã€‚</p><h2 id="æœ¬åœ°å¼•å…¥ä¾èµ–å¹¶ä¸”ç¼–å†™å¯åŠ¨å‡½æ•°"><a href="#æœ¬åœ°å¼•å…¥ä¾èµ–å¹¶ä¸”ç¼–å†™å¯åŠ¨å‡½æ•°" class="headerlink" title="æœ¬åœ°å¼•å…¥ä¾èµ–å¹¶ä¸”ç¼–å†™å¯åŠ¨å‡½æ•°"></a>æœ¬åœ°å¼•å…¥ä¾èµ–å¹¶ä¸”ç¼–å†™å¯åŠ¨å‡½æ•°</h2><p>ç›®å½•å¦‚å›¾ï¼š<br><img alt="" data-original="/images/15495295478467.png"></p><p>scrollRevealæ˜¯æˆ‘ä»¬éœ€è¦å¼•å…¥çš„å®˜æ–¹çš„js<br>my_scrollReveal.jsï¼ˆæˆ‘è‡ªå®šä¹‰çš„å¯åŠ¨å‡½æ•°ï¼‰å¦‚ä¸‹<br>tip:è¿™é‡Œæˆ‘å°è¯•é€šè¿‡jså°†data-scroll-revealåŠ¨æ€çš„åŠ å…¥åˆ°articleä¸­ï¼Œå¯èƒ½æ˜¯å› ä¸º window.scrollReveal åˆå§‹åŒ–çš„æ“ä½œï¼Œä¼šå¯¼è‡´æŠ¥é”™ï¼ˆæ•°ç»„è¶Šç•Œï¼‰ï¼Œæ‰€ä»¥æœ€åé€šè¿‡ç›´æ¥åœ¨post.swigæ–‡ä»¶ä¸­æ·»åŠ å±æ€§ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœåˆ·æ–°çš„é¡µé¢ä¸æ˜¯é¦–é¡µï¼Œå³ç‚¹è¿›å»çš„æ–‡ç« çš„è¯ï¼Œå°±ä¸è¿›è¡ŒscrollRevealçš„æ“ä½œ</span></span><br><span class="line"><span class="comment">//å› ä¸ºåœ¨ç‚¹è¿›å»çš„æ–‡ç« è¿˜æ˜¯articleæ ‡ç­¾åŒ…ç€çš„ã€‚</span></span><br><span class="line"><span class="comment">//æˆ‘è¿™é‡Œæ˜¯æ ¹æ®pathnameå³æµè§ˆå™¨è®¿é—®åœ°å€è¿›è¡Œåˆ¤æ–­çš„</span></span><br><span class="line"><span class="keyword">var</span> pathname = <span class="built_in">window</span>.location.pathname</span><br><span class="line"><span class="keyword">if</span> (pathname.indexOf(<span class="string">"html"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//configé»˜è®¤é…ç½®ï¼Œä¸è¿‡æˆ‘ç”¨ç€å¥½åƒä¸èµ·ä½œç”¨ï¼Œè¿™é‡Œæ²¡æœ‰ç ”ç©¶æ˜ç™½</span></span><br><span class="line">  <span class="keyword">var</span> config = &#123;</span><br><span class="line">    enter: <span class="string">'right'</span>,</span><br><span class="line">    move: <span class="string">'40px'</span>,</span><br><span class="line">    over: <span class="string">'3s'</span>,</span><br><span class="line">    after: <span class="string">'5'</span>,</span><br><span class="line">    reset: <span class="literal">true</span>,</span><br><span class="line">    init: <span class="literal">true</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//æ ¹æ®åˆå§‹åŒ–é…ç½®åˆ›å»ºä¸€ä¸ªscrollRevealå¯¹è±¡</span></span><br><span class="line">  <span class="built_in">window</span>.scrollReveal = <span class="keyword">new</span> scrollReveal(config);</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–ï¼Œä¼šè‡ªåŠ¨å»é¡µé¢ä¸­æ‰¾åˆ°å«æœ‰ data-scroll-reveal å±æ€§çš„åœ°æ–¹è¿›è¡Œç›¸å…³çš„æ“ä½œã€‚</span></span><br><span class="line">  scrollReveal.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="ä¿®æ”¹require-jsä¸»å‡½æ•°"><a href="#ä¿®æ”¹require-jsä¸»å‡½æ•°" class="headerlink" title="ä¿®æ”¹require.jsä¸»å‡½æ•°"></a>ä¿®æ”¹require.jsä¸»å‡½æ•°</h2><p>å› ä¸ºåœ¨æˆ‘çš„nextä¸­æˆ‘åº”ç”¨äº†requireï¼Œæ‰€ä»¥ç»å¼•ç”¨ä¸Šé¢ä¸¤ä¸ªjsçš„æ“ä½œæ”¾åˆ°äº†è¿™é‡Œã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»å‡½æ•°</span></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">  waitSeconds: <span class="number">0</span>,</span><br><span class="line">  paths: &#123;</span><br><span class="line">    <span class="string">"music"</span>: <span class="string">"/dist/music"</span>,</span><br><span class="line">    <span class="comment">//ç›®å‰ä¼šæ¶ˆè€—è¾ƒå¤šçš„æ€§èƒ½ï¼Œä»¥åå¯èƒ½ä¼šå»æ‰ã€‚</span></span><br><span class="line">    <span class="string">"aplayer"</span>: <span class="string">"/js/src/aplayer"</span>,</span><br><span class="line">    <span class="string">"backgroudLine"</span>: <span class="string">"/js/src/backgroudLine"</span>,</span><br><span class="line">    <span class="string">"category"</span>: <span class="string">"/js/src/category"</span>,</span><br><span class="line">    <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">    <span class="comment">/*ä¸æ˜¾ç¤ºå›¾æ ‡çš„è¯æ›¿æ¢fonts*/</span></span><br><span class="line">    <span class="string">"share"</span>:<span class="string">"/js/src/pjax/share"</span>,</span><br><span class="line">    <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span>,</span><br><span class="line">    <span class="string">"comments"</span>:<span class="string">"/js/src/pjax/comments_git"</span>,</span><br><span class="line">    <span class="string">"love"</span>:<span class="string">"/js/src/love"</span>,</span><br><span class="line">    <span class="string">"eye"</span>:<span class="string">"/js/src/pjax/eye"</span>,</span><br><span class="line">    <span class="string">"header_left"</span>:<span class="string">"/js/src/pjax/header_left"</span>,</span><br><span class="line">    <span class="string">"article_top"</span>:<span class="string">"/js/src/pjax/article_top"</span>,</span><br><span class="line">    <span class="string">"easing"</span>:<span class="string">"/js/src/pjax/easing/jquery.easing.1.3"</span>,</span><br><span class="line">    <span class="string">"scrollReveal"</span>:<span class="string">"/js/src/pjax/scrollReveal/scrollReveal"</span>,</span><br><span class="line">    <span class="string">"my_scrollReveal"</span>:<span class="string">"/js/src/pjax/scrollReveal/my_scrollReveal"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  shim: &#123;</span><br><span class="line">    <span class="string">'share'</span>: &#123;</span><br><span class="line">      deps: [</span><br><span class="line">        <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'comments'</span>: &#123;</span><br><span class="line">      deps: [</span><br><span class="line">        <span class="string">'css!/js/src/pjax/comments/gitalk'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'header_left'</span>: &#123;</span><br><span class="line">      deps: [</span><br><span class="line">        <span class="string">'easing'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'my_scrollReveal'</span>:&#123;</span><br><span class="line">      deps:[</span><br><span class="line">        <span class="string">'scrollReveal'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>([<span class="string">'backgroudLine'</span>,<span class="string">'music'</span>,<span class="string">'aplayer'</span>,<span class="string">'category'</span>,<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>,<span class="string">'comments'</span>,<span class="string">'love'</span>,<span class="string">'eye'</span>,</span><br><span class="line"><span class="string">'header_left'</span>,<span class="string">'article_top'</span>,<span class="string">'easing'</span>,<span class="string">'scrollReveal'</span>,<span class="string">'my_scrollReveal'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>åœ¨æœ€ååŠ å…¥äº†scrollRevealå’Œmy_scrollRevealè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«å¯¹åº”äºå¼•å…¥å®˜æ–¹çš„jså’Œè‡ªå®šä¹‰çš„å¯åŠ¨å‡½æ•°ã€‚</p><h1 id="ä¿®æ”¹pjaxçš„å‡½æ•°"><a href="#ä¿®æ”¹pjaxçš„å‡½æ•°" class="headerlink" title="ä¿®æ”¹pjaxçš„å‡½æ•°"></a>ä¿®æ”¹pjaxçš„å‡½æ•°</h1><p>å¦‚æœæ²¡æœ‰åŠ å…¥pjaxçš„çœ‹åˆ°ä¸Šé¢å°±ç»“æŸäº†ï¼Œæˆ‘è¿™é‡Œåº”ç”¨çš„pjaxæ‰€ä»¥è®°å½•ä¸‹ã€‚<br>é€šè¿‡requireå¼•å…¥çš„æ–¹å¼ï¼Œå‘ç°å¹¶ä¸èƒ½æˆåŠŸï¼Œ<br>å¹¶ä¸”æŠ¥é”™ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pjaxMain.js:<span class="number">78</span> Uncaught <span class="built_in">TypeError</span>: scrollReveal is not a <span class="keyword">constructor</span></span><br><span class="line">    at pjaxMain.js:78</span><br><span class="line">    at Object.execCb (require.js:30)</span><br><span class="line">    at $.check (require.js:19)</span><br><span class="line">    at $.enable (require.js:24)</span><br><span class="line">    at $.init (require.js:18)</span><br><span class="line">    at require.js:27</span><br></pre></td></tr></table></figure><p></p><p>ä¹Ÿæ˜¯æ˜¯è¯´å¹¶æ²¡æœ‰å®šä¹‰ï¼Œè€Œä¸”æœ‰æ—¶å€™ä¼šå‡ºç°pjaxå¤„ç†åç¬¬ä¸€æ¬¡æ²¡é—®é¢˜ï¼Œç¬¬äºŒæ¬¡å°±åˆä¼šæŠ¥å‡ºåŒæ ·çš„é”™è¯¯ã€‚<br>æœ€åè§£å†³çš„æ–¹æ³•æ˜¯å°†ä¸Šé¢å®˜æ–¹çš„jså’Œè‡ªå·±å†™çš„jså°è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ç„¶åé€šè¿‡æˆ‘çš„pjaxå‡½æ•°è¿›è¡Œå¼•ç”¨ï¼ˆè·³è½¬å’Œå›é€€ï¼‰ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*pjaxä¸»å‡½æ•°*/</span></span><br><span class="line">$(<span class="built_in">document</span>).pjax(<span class="string">'a[target!=_blank]'</span>, <span class="string">'#pjax-container'</span>, &#123;</span><br><span class="line">  fragment: <span class="string">'#pjax-container'</span>,</span><br><span class="line">  timeout: <span class="number">5000</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//ç”¨æˆ·é€šè¿‡æµè§ˆå™¨çš„å‰è¿›åé€€æŒ‰é’®ï¼Œéœ€è¦åŠ è½½çš„js</span></span><br><span class="line">$(<span class="built_in">window</span>).on(<span class="string">'popstate.pjax'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*å¿…é¡»åŠ */</span></span><br><span class="line">  <span class="comment">// $(document).on('pjax:complete',</span></span><br><span class="line">  <span class="comment">//   function () &#123;</span></span><br><span class="line">      pjax();</span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="built_in">document</span>).unbind(<span class="string">'keyup'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:complete'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>.config(&#123;</span><br><span class="line">      waitSeconds: <span class="number">0</span>,</span><br><span class="line">      paths: &#123;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">        <span class="comment">// "share":"/js/src/pjax/share",</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªä¹Ÿæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span>,</span><br><span class="line">        <span class="string">"pjax_function_public"</span>:<span class="string">"/js/src/pjax/pjax_function_public"</span>,</span><br><span class="line">        <span class="string">"comments"</span>:<span class="string">"/js/src/pjax/comments_git"</span>,</span><br><span class="line">        <span class="string">"love"</span>:<span class="string">"/js/src/love"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      shim: &#123;</span><br><span class="line">        <span class="string">'share'</span>: &#123;</span><br><span class="line">          deps: [</span><br><span class="line">            <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'comments'</span>: &#123;</span><br><span class="line">          deps: [</span><br><span class="line">            <span class="string">'css!/js/src/pjax/comments/gitalk'</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>([<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>,<span class="string">'pjax_function_public'</span>,<span class="string">'comments'</span></span><br><span class="line">    ], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      pjax();</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjax</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*æ¥å¿…åŠ›è¯„è®º*/</span></span><br><span class="line"> <span class="comment">//    comments_js();</span></span><br><span class="line"><span class="comment">/*gitalkè¯„è®º*/</span></span><br><span class="line">  gitalk();</span><br><span class="line">  <span class="comment">//æŠ¤çœ¼</span></span><br><span class="line">  eye_js()</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯æ–‡ç« ï¼Œå®ç°æ»šåŠ¨æ•ˆæœ</span></span><br><span class="line">  article_top_js();</span><br><span class="line"><span class="comment">//ä¸è’œå­</span></span><br><span class="line">  busuanzi_js();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è‡ªå·±å†™çš„åˆ†äº«</span></span><br><span class="line">  pjaxshare();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç±»çš„js</span></span><br><span class="line">  category_js();</span><br><span class="line"><span class="comment">// å±€éƒ¨åˆ·æ–°åæ–‡ç« å†…å®¹ä¸æ˜¾ç¤ºbugçš„js</span></span><br><span class="line">  opacity_js()</span><br><span class="line"><span class="comment">//ç‚¹å‡»æœ‰ç›®å½•çš„æ–‡ç« sidebarä¸æ˜¾ç¤ºçš„bugè§£å†³</span></span><br><span class="line">  motion_js()</span><br><span class="line">  scrollspy_js()</span><br><span class="line">  <span class="comment">//utils_js()</span></span><br><span class="line">  postdetails_js()</span><br><span class="line"><span class="comment">//leanæ•°é‡ç»Ÿè®¡çš„jsï¼ŒåŸæ¥çš„jsæ˜¯åœ¨themes/next/layout/_third-party/analytics/lean-analytics.swigæ–‡ä»¶ä¸­</span></span><br><span class="line">  lean_analytics();</span><br><span class="line">  <span class="comment">//ç™¾åº¦æ¨é€js</span></span><br><span class="line">  baidutuisong();</span><br><span class="line"><span class="comment">//     //å³è¾¹sidebaræ»šè½®æ•ˆæœæ¶ˆå¤±äº†ã€‚</span></span><br><span class="line">  initSidebarDimension()</span><br><span class="line">  <span class="comment">//æ‡’åŠ è½½</span></span><br><span class="line">  lazyLoad();</span><br><span class="line">  <span class="comment">//æèµ çš„å‡½æ•°</span></span><br><span class="line">  donate();</span><br><span class="line">  <span class="comment">//éšé¼ æ ‡çš„æ»šåŠ¨æ–‡ç« åŠ¨æ€å‡ºç°çš„åŠ¨ç”»</span></span><br><span class="line">  my_scrollReveal_js();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;æ•ˆæœ&quot;&gt;&lt;a href=&quot;#æ•ˆæœ&quot; class=&quot;headerlink&quot; title=&quot;æ•ˆæœ&quot;&gt;&lt;/a&gt;æ•ˆæœ&lt;/h
      
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆäº”ï¼‰ï¼šJDKå¹¶å‘åŒ…(å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨ã€å¹¶å‘å®¹å™¨åŠå…¸å‹æºç åˆ†æï¼ˆHashmapç­‰ï¼‰)</title>
    <link href="http://mmmmmm.me/2019-01-31-3.html"/>
    <id>http://mmmmmm.me/2019-01-31-3.html</id>
    <published>2019-01-18T11:20:04.000Z</published>
    <updated>2019-01-30T23:48:37.688Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="1-å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨"><a href="#1-å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨" class="headerlink" title="1. å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨"></a>1. å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨</h1><h2 id="1-1-ReentrantLock"><a href="#1-1-ReentrantLock" class="headerlink" title="1.1. ReentrantLock"></a>1.1. ReentrantLock</h2><p>åœ¨synchronizeçš„åŸºç¡€ä¸Šæ–°åŠ äº†åŠŸèƒ½ï¼Œå¦‚æœæ˜¯ç‰¹åˆ«ç®€å•çš„åœºæ™¯ï¼Œä¸¤è€…æ˜¯æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«çš„ã€‚</p><h3 id="1-1-1-å¯é‡å…¥"><a href="#1-1-1-å¯é‡å…¥" class="headerlink" title="1.1.1.å¯é‡å…¥"></a>1.1.1.å¯é‡å…¥</h3><p>å•çº¿ç¨‹å¯ä»¥é‡å¤è¿›å…¥ï¼Œä½†è¦é‡å¤é€€å‡º<br>å¯¹äºåŒä¸€ä¸ªçº¿ç¨‹ï¼Œè‡ªå·±æ˜¯å¯ä»¥é‡å¤è¿›å…¥çš„ï¼Œå¦åˆ™ä¼šæŠŠè‡ªå·±å¡æ­»ã€‚<br>ç»“è®ºï¼š<br>é‡å…¥é”æ˜¯å¯é‡å¤è·å¾—èµ„æºçš„é”ï¼Œå·²ç»è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å¯¹å½“å‰çš„èµ„æºé‡å…¥åŠ é”è€Œä¸ä¼šå¼•èµ·é˜»å¡ï¼›ä¸å¯é‡å…¥é”æ˜¯ä¸å¯é‡å¤è·å¾—èµ„æºçš„é”ï¼Œå½“å·²ç»è·å¾—é”çš„çº¿ç¨‹å¯¹å½“å‰èµ„æºå†æ¬¡åŠ é”æ—¶ï¼Œä¼šæŠŠè‡ªå·±é˜»å¡</p><p>å¹¿ä¹‰ä¸Šçš„å¯é‡å…¥é”æŒ‡çš„æ˜¯å¯é‡å¤å¯é€’å½’è°ƒç”¨çš„é”ï¼Œåœ¨å¤–å±‚ä½¿ç”¨é”ä¹‹åï¼Œåœ¨å†…å±‚ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸å‘ç”Ÿæ­»é”ï¼ˆå‰æå¾—æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…classï¼‰ï¼Œè¿™æ ·çš„é”å°±å«åšå¯é‡å…¥é”ã€‚ReentrantLockå’Œsynchronizedéƒ½æ˜¯å¯é‡å…¥é”ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç”¨synchronizedå®ç°çš„ä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ReentrantTest</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public synchronized <span class="keyword">void</span> get() &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        set();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public synchronized <span class="keyword">void</span> set() &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">void</span> run() &#123;</span><br><span class="line">        get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">        ReentrantTest rt = <span class="keyword">new</span> ReentrantTest();</span><br><span class="line">        <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(rt).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰å‘ç”Ÿæ­»é”çš„æƒ…å†µï¼Œæˆªå–ä¸€éƒ¨åˆ†è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Thread<span class="number">-8492</span></span><br><span class="line">Thread<span class="number">-8492</span></span><br><span class="line">Thread<span class="number">-8494</span></span><br><span class="line">Thread<span class="number">-8494</span></span><br><span class="line">Thread<span class="number">-8495</span></span><br><span class="line">Thread<span class="number">-8495</span></span><br><span class="line">Thread<span class="number">-8493</span></span><br><span class="line">Thread<span class="number">-8493</span></span><br></pre></td></tr></table></figure><p>set()å’Œget()åŒæ—¶è¾“å‡ºäº†çº¿ç¨‹åç§°ï¼Œè¡¨æ˜å³ä½¿é€’å½’ä½¿ç”¨synchronizedä¹Ÿæ²¡æœ‰å‘ç”Ÿæ­»é”ï¼Œè¯æ˜å…¶æ˜¯å¯é‡å…¥çš„ã€‚</p><p>ä»¥ä¸ŠåŸæ–‡ï¼š<a href="https://blog.csdn.net/rickiyeat/article/details/78314451" target="_blank" rel="noopener">https://blog.csdn.net/rickiyeat/article/details/78314451</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Lock</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">public <span class="keyword">static</span> int i = <span class="number">0</span>;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (int j = <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++) &#123;</span><br><span class="line">lock.lock();</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">i++;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//ä¸è®ºå¦‚ä½•éƒ½è¿›è¡Œunlock</span></span><br><span class="line"><span class="comment">//åŠ ä¸¤æ¬¡é”å¿…é¡»è§£é”ä¸¤æ¬¡ã€‚</span></span><br><span class="line">lock.unlock();</span><br><span class="line">lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//synchronizeåªè¦åœ¨å¤§æ‹¬å·å¤–é¢ï¼Œå‡ºäº†å¤§æ‹¬å·ï¼Œè™šæ‹Ÿæœºä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œå¯æ˜¯lockæ˜¯é€šè¿‡unlockæ¥æ§åˆ¶ä»€ä¹ˆæ—¶å€™é‡Šæ”¾é”</span></span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Lock tl = <span class="keyword">new</span> Lock();</span><br><span class="line"><span class="comment">//åŒæ—¶å¼€ä¸¤ä¸ªä¸€æ ·çš„çº¿ç¨‹</span></span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(tl);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(tl);</span><br><span class="line">t1.start();t2.start();</span><br><span class="line">t1.join();t2.join();</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20000</span></span><br></pre></td></tr></table></figure><h3 id="1-1-2-å¯ä¸­æ–­-lockInterruptibly"><a href="#1-1-2-å¯ä¸­æ–­-lockInterruptibly" class="headerlink" title="1.1.2. å¯ä¸­æ–­ lockInterruptibly()"></a>1.1.2. å¯ä¸­æ–­ lockInterruptibly()</h3><p>åœ¨å‘ç”Ÿæ­»é”æˆ–è€…å…¶ä»–çš„å¯¼è‡´é•¿æœŸç­‰å¾…çš„æƒ…å†µï¼Œå¸Œæœ›é”åœä¸‹æ¥çš„åŠŸèƒ½ï¼Œsynchronizeæ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ï¼ŒReentrantLockæä¾›äº†å¯ä¸­æ–­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Interruptible</span>  <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="keyword">static</span> ReentrantLock lock1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">public <span class="keyword">static</span> ReentrantLock lock2 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">int lock;</span><br><span class="line">public Interruptible(int lock)&#123;</span><br><span class="line"><span class="keyword">this</span>.lock = lock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//lock=1çš„æ—¶å€™lock1ä¸Šé”,lock=2çš„æ—¶å€™lock2ä¸Šé”ï¼Œåˆšæ‰çš„lock1ä¸Šäº†é”</span></span><br><span class="line"><span class="comment">//ä¹‹åè¿˜è¦ç»™lock2ä¸Šé”,lock2ä¸Šäº†é”ä¹‹åè¿˜è¦ç»™lock1ä¸Šé”ï¼Œ</span></span><br><span class="line"><span class="comment">// å¯æ˜¯lock2åœ¨lock=2çš„æ—¶å€™è¢«locl=2æ‹¿åˆ°äº†ï¼Œlock1åœ¨lock=1çš„æ—¶å€™</span></span><br><span class="line"><span class="comment">//è¢«locl=1æ‹¿åˆ°äº†æ‰€ä»¥å½¢æˆäº†æ­»é”</span></span><br><span class="line"><span class="keyword">if</span> (lock == <span class="number">1</span>)&#123;</span><br><span class="line">lock1.lockInterruptibly();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">lock2.lockInterruptibly();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">lock2.lockInterruptibly();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">500</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">lock1.lockInterruptibly();</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//å¦‚æœlock1è¿˜æ‹¿ç€è¿™æŠŠé”çš„è¯ï¼Œå°±è§£æ‰ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (lock1.isHeldByCurrentThread())</span><br><span class="line">lock1.unlock();</span><br><span class="line"><span class="keyword">if</span> (lock2.isHeldByCurrentThread())</span><br><span class="line">lock2.unlock();</span><br><span class="line">System.out.println(Thread.currentThread().getId()+<span class="string">":çº¿ç¨‹é€€å‡º"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Interruptible interruptible1 = <span class="keyword">new</span> Interruptible(<span class="number">1</span>);</span><br><span class="line">Interruptible interruptible2 = <span class="keyword">new</span> Interruptible(<span class="number">2</span>);</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(interruptible1);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(interruptible2);</span><br><span class="line">t1.start();t2.start();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">DeadlockChecker.check();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DeadlockChecker.check();å¦‚æœå°†è¿™å¥è¯æ³¨é‡Šï¼Œå°†ä¼šè¿›è¡Œæ— é™æœŸçš„æ­»é”ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ThreadInfo;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ThreadMXBean;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DeadLockChecker</span> </span>&#123;</span><br><span class="line">private final <span class="keyword">static</span> ThreadMXBean mbean = ManagementFactory.getThreadMXBean();</span><br><span class="line">final  <span class="keyword">static</span>  Runnable deadLockCheck = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">long [] deadLockedThreadIds = mbean.findDeadlockedThreads();</span><br><span class="line"><span class="keyword">if</span> (deadLockedThreadIds != <span class="literal">null</span>) &#123;</span><br><span class="line">ThreadInfo[] threadInfos = mbean.getThreadInfo(deadLockedThreadIds);</span><br><span class="line"><span class="keyword">for</span> (Thread t : Thread.getAllStackTraces().keySet()) &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i&lt;threadInfos.length ; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (t.getId() == threadInfos[i].getThreadId()) &#123;</span><br><span class="line">t.interrupt();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> check()&#123;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(deadLockCheck);</span><br><span class="line">t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">t.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="1-1-3-å¯é™æ—¶"><a href="#1-1-3-å¯é™æ—¶" class="headerlink" title="1.1.3. å¯é™æ—¶"></a>1.1.3. å¯é™æ—¶</h3><p>è¶…æ—¶ä¸èƒ½è·å¾—é”ï¼Œå°±è¿”å›falseï¼Œä¸ä¼šæ°¸ä¹…ç­‰å¾…æ„æˆæ­»é”</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TimeLock</span> <span class="title">implements</span>  <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//å¦‚æœçº¿ç¨‹åœ¨5ç§’ä¹‹å†…æ²¡æœ‰æ‹¿åˆ°é”å°±èµ°elseé‡Œé¢çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">if</span> (lock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"get lock failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">TimeLock tl = <span class="keyword">new</span> TimeLock();</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(tl);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(t1);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-4-å…¬å¹³é”"><a href="#1-1-4-å…¬å¹³é”" class="headerlink" title="1.1.4. å…¬å¹³é”"></a>1.1.4. å…¬å¹³é”</h3><p>ä»€ä¹ˆæ˜¯å…¬å¹³é”ï¼Ÿ<br>å…ˆæ¥å…ˆå¾—ï¼Œé¿å…äº§ç”Ÿé¥¥é¥¿ç°è±¡ï¼Œä½†æ˜¯æ€§èƒ½å·®å¾ˆå¤šã€‚æ‰€ä»¥ä¸æ˜¯ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œä¸è¦ä½¿ç”¨å…¬å¹³é”ã€‚<br>public ReentrantLock(boolean fair)<br>public static ReentrantLock fairLock = new ReentrantLock(true);</p><h2 id="1-2-Condition"><a href="#1-2-Condition" class="headerlink" title="1.2. Condition"></a>1.2. Condition</h2><h3 id="1-2-1-æ¦‚è¿°"><a href="#1-2-1-æ¦‚è¿°" class="headerlink" title="1.2.1. æ¦‚è¿°"></a>1.2.1. æ¦‚è¿°</h3><p>ç±»ä¼¼äº Object.wait()å’ŒObject.notify() ä¸ReentrantLockç»“åˆä½¿ç”¨</p><h3 id="1-2-2-ä¸»è¦æ¥å£"><a href="#1-2-2-ä¸»è¦æ¥å£" class="headerlink" title="1.2.2. ä¸»è¦æ¥å£"></a>1.2.2. ä¸»è¦æ¥å£</h3><p>void await() throws InterruptedException;//ç­‰å¾…<br>void awaitUninterruptibly();<br>long awaitNanos(long nanosTimeout) throws InterruptedException; boolean await(long time, TimeUnit unit) throws InterruptedException; boolean awaitUntil(Date deadline) throws InterruptedException;<br>void signal();//é€šçŸ¥ç»§ç»­å¾€ä¸‹èµ°<br>void signalAll();</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ReenTerLockCondition</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">public <span class="keyword">static</span> Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">lock.lock();</span><br><span class="line">condition.await();</span><br><span class="line">System.out.println(<span class="string">"Thread is going on "</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">ReenTerLockCondition tl = <span class="keyword">new</span> ReenTerLockCondition();</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(tl);</span><br><span class="line">t1.start();</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">lock.lock();</span><br><span class="line">condition.signal();</span><br><span class="line">lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¿…é¡»åœ¨lockå’Œunlockæ‰§è¡Œå®Œäº†ä¹‹åæ‰ä¼šåˆ°ä¸Šé¢å°†t1çš„é”è§£å¼€ã€‚</span></span><br><span class="line"><span class="comment">//ç±»ä¼¼äºä¹‹å‰çš„Synchronizeä»£ç å—ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="1-2-3-APIè¯¦è§£"><a href="#1-2-3-APIè¯¦è§£" class="headerlink" title="1.2.3. APIè¯¦è§£"></a>1.2.3. APIè¯¦è§£</h3><p>await()æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹ç­‰å¾…ï¼ŒåŒæ—¶é‡Šæ”¾å½“å‰é”ï¼Œå½“å…¶ä»–çº¿ç¨‹ä¸­ä½¿ç”¨signal()æ—¶æˆ–è€…signalAll()æ–¹æ³•æ—¶ï¼Œçº¿<br>ç¨‹ä¼šé‡æ–°è·å¾—é”å¹¶ç»§ç»­æ‰§è¡Œã€‚æˆ–è€…å½“çº¿ç¨‹è¢«ä¸­æ–­æ—¶ï¼Œä¹Ÿèƒ½è·³å‡ºç­‰å¾…ã€‚è¿™å’ŒObject.wait()æ–¹æ³•å¾ˆç›¸ä¼¼ã€‚</p><p>awaitUninterruptibly()æ–¹æ³•ä¸await()æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä¼šå†ç­‰å¾…è¿‡ç¨‹ä¸­å“åº”ä¸­æ–­ã€‚ä¸ä¼šè¢«ä¸­æ–­ã€‚<br>singal()æ–¹æ³•ç”¨äºå”¤é†’ä¸€ä¸ªåœ¨ç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚ç›¸å¯¹çš„singalAll()æ–¹æ³•ä¼šå”¤é†’æ‰€æœ‰åœ¨ç­‰å¾…ä¸­çš„çº¿ç¨‹ã€‚è¿™å’ŒObej ct.notify()æ–¹æ³•å¾ˆç±»ä¼¼ã€‚</p><h2 id="1-3-Semaphore"><a href="#1-3-Semaphore" class="headerlink" title="1.3. Semaphore"></a>1.3. Semaphore</h2><p><strong><font color="red">ä¿¡å·é‡<br>äº’æ–¥çš„ã€æ’ä»–çš„<br>å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å»å…±äº«è¿™ä¸ªä¸´ç•ŒåŒºï¼Œå¹¿ä¹‰ä¸Šçš„é”ï¼Œæ¯”å¦‚æ¯ä¸ªä¿¡å·é‡æŒ‡å®šåä¸ªè®¸å¯ï¼Œæ¯ä¸ªè®¸å¯åˆ†é…è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œå½“ç„¶æ¯ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥æŒæœ‰å¤šä¸ªè®¸å¯ï¼Œå¦‚æœæœ‰å¤šä½™çš„è®¸å¯å°±å¯ä»¥è¿›å…¥ï¼Œå¦‚æœæ²¡æœ‰è®¸å¯ï¼Œåé¢çš„çº¿ç¨‹å°±å¿…é¡»ç­‰å¾…ï¼Œä¸èƒ½è¿›å…¥ã€‚<br>ä¿¡å·é‡å…è®¸å¤šä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¿¡å·é‡çš„è®¸å¯ç­‰äºä¸€çš„æ—¶å€™å°±ç›¸å½“äºä¸€æŠŠé”ã€‚</font></strong></p><h3 id="1-3-1-æ¦‚è¿°"><a href="#1-3-1-æ¦‚è¿°" class="headerlink" title="1.3.1. æ¦‚è¿°"></a>1.3.1. æ¦‚è¿°</h3><p>å…±äº«é” è¿è¡Œå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¸´ç•ŒåŒº</p><h3 id="1-3-2-ä¸»è¦æ¥å£"><a href="#1-3-2-ä¸»è¦æ¥å£" class="headerlink" title="1.3.2. ä¸»è¦æ¥å£"></a>1.3.2. ä¸»è¦æ¥å£</h3><p>public void acquire()//è·å¾—ä¿¡å·é‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> acquire() throws InterruptedException &#123;</span><br><span class="line">       sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//ä¹Ÿå¯ä»¥æ‹¿åˆ°å¤šä¸ªè®¸å¯</span></span><br><span class="line">public <span class="keyword">void</span> acquire(int permits) throws InterruptedException &#123;</span><br><span class="line">       <span class="keyword">if</span> (permits &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">       sync.acquireSharedInterruptibly(permits);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>public void acquireUninterruptibly()//ä¸æ”¯æŒä¸­æ–­çš„è·å¾—ä¿¡å·é‡<br>public boolean tryAcquire()//ä¸ä¼šç­‰å¾…ï¼Œåªæ˜¯è¯•ä¸€è¯•ï¼Œæ‹¿ä¸åˆ°å°±è¿”å›false<br>public boolean tryAcquire(long timeout, TimeUnit unit)//tryçš„æ—¶é—´ï¼Œç­‰å¾…çš„æ—¶é—´ï¼Œå’Œä¸Šçº¿åŠŸèƒ½å·®å·®ä¸å¤š<br>public void release()é‡Šæ”¾ã€‚<br>ä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span>  <span class="title">SemapDemo</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">final Semaphore semp = <span class="keyword">new</span> Semaphore(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//ä¹Ÿå¯ä»¥semp.acquire(2);ä¸‹é¢å°†ä¼šæ¯ä¸¤ä¸ªçº¿ç¨‹è¾“å‡ºä¸€æ¬¡</span></span><br><span class="line">semp.acquire();</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">System.out.println(Thread.currentThread().getId()+<span class="string">":done!"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">semp.release();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">ExecutorService exec = Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line">final SemapDemo demo = <span class="keyword">new</span> SemapDemo();</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">20</span> ; i++) &#123;</span><br><span class="line">exec.submit(demo);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:done!</span><br><span class="line"><span class="number">19</span>:done!</span><br><span class="line"><span class="number">12</span>:done!</span><br><span class="line"><span class="number">10</span>:done!</span><br><span class="line"><span class="number">13</span>:done!</span><br><span class="line"><span class="number">14</span>:done!</span><br><span class="line"><span class="number">15</span>:done!</span><br><span class="line"><span class="number">18</span>:done!</span><br><span class="line"><span class="number">17</span>:done!</span><br><span class="line"><span class="number">16</span>:done!</span><br><span class="line"><span class="number">20</span>:done!</span><br><span class="line"><span class="number">22</span>:done!</span><br><span class="line"><span class="number">23</span>:done!</span><br><span class="line"><span class="number">21</span>:done!</span><br><span class="line"><span class="number">19</span>:done!</span><br><span class="line"><span class="number">25</span>:done!</span><br><span class="line"><span class="number">28</span>:done!</span><br><span class="line"><span class="number">24</span>:done!</span><br><span class="line"><span class="number">27</span>:done!</span><br><span class="line"><span class="number">26</span>:done!</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¯äº”ä¸ªçº¿ç¨‹è¾“å‡ºä¸€æ¬¡ï¼Œæ¯æ¬¡åœç•™ä¸¤ç§’ï¼ŒåŒæ ·çš„å¦‚æœsemp.acquire(2);æ¯ä¸ªçº¿ç¨‹æ‹¿åˆ°ä¸¤ä¸ªè®¸å¯ï¼Œä¸€å…±æœ‰äº”ä¸ªè®¸å¯ï¼Œreleaseï¼ˆ2ï¼‰ï¼Œæ‰€ä»¥æ¯æ¬¡åªæœ‰ä¸¤ä¸ªçº¿ç¨‹è¾“å‡ºã€‚</p><h2 id="1-4-ReadWriteLock"><a href="#1-4-ReadWriteLock" class="headerlink" title="1.4. ReadWriteLock"></a>1.4. ReadWriteLock</h2><p>å†™ä¼šä¿®æ”¹æ•°æ®ï¼Œè¯»ä¸ä¼šä¿®æ”¹æ•°æ®ï¼Œä»æ€§èƒ½ä¸Šæ¥çœ‹ï¼Œå¦‚æœä¸ç®¡è¯»è¿˜æ˜¯å†™éƒ½åŠ é”ï¼Œä¼šååˆ†å½±å“æ€§èƒ½ï¼Œsynchronizedå¹¶è¡Œåº¦åªæœ‰ä¸€ï¼Œä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹ç»è¿‡ã€‚å¦‚æœæ²¡æœ‰å†™æ“ä½œï¼Œè¿™ä¸ªæ‰€æœ‰çš„readçº¿ç¨‹å¿…ç„¶æ˜¯æ— ç­‰å¾…çš„ã€‚</p><h3 id="1-4-1-æ¦‚è¿°"><a href="#1-4-1-æ¦‚è¿°" class="headerlink" title="1.4.1. æ¦‚è¿°"></a>1.4.1. æ¦‚è¿°</h3><p>ReadWriteLockæ˜¯JDK5ä¸­æä¾›çš„è¯»å†™åˆ†ç¦»é”</p><h3 id="1-4-2-è®¿é—®æƒ…å†µ"><a href="#1-4-2-è®¿é—®æƒ…å†µ" class="headerlink" title="1.4.2. è®¿é—®æƒ…å†µ"></a>1.4.2. è®¿é—®æƒ…å†µ</h3><p>è¯»-è¯»ä¸äº’æ–¥:è¯»è¯»ä¹‹é—´ä¸é˜»å¡ã€‚<br>è¯»-å†™äº’æ–¥:è¯»é˜»å¡å†™ï¼Œå†™ä¹Ÿä¼šé˜»å¡è¯»ã€‚<br>å†™-å†™äº’æ–¥:å†™å†™é˜»å¡ã€‚<br><img alt="" data-original="/images/15488916638470.png"></p><h3 id="1-4-3-ä¸»è¦æ¥å£"><a href="#1-4-3-ä¸»è¦æ¥å£" class="headerlink" title="1.4.3. ä¸»è¦æ¥å£"></a>1.4.3. ä¸»è¦æ¥å£</h3><p>private static ReentrantReadWriteLock readWriteLock=newReentrantReadWriteLock();<br>private static Lock readLock = readWriteLock.readLock();<br>è·å¾—readLockï¼Œç„¶åé€šè¿‡readLock.lock()æƒŠé†’æ“ä½œ<br>private static Lock writeLock = readWriteLock.writeLock();<br>è·å¾—readLockï¼Œç„¶åé€šè¿‡readLock.lock()æƒŠé†’æ“ä½œ</p><h2 id="1-5-CountDownLatch"><a href="#1-5-CountDownLatch" class="headerlink" title="1.5. CountDownLatch"></a>1.5. CountDownLatch</h2><h3 id="1-5-1-æ¦‚è¿°"><a href="#1-5-1-æ¦‚è¿°" class="headerlink" title="1.5.1. æ¦‚è¿°"></a>1.5.1. æ¦‚è¿°</h3><p>å€’æ•°è®¡æ—¶å™¨ ä¸€ç§å…¸å‹çš„åœºæ™¯å°±æ˜¯ç«ç®­å‘å°„ã€‚åœ¨ç«ç®­å‘å°„å‰ï¼Œä¸ºäº†ä¿è¯ä¸‡æ— ä¸€å¤±ï¼Œå¾€å¾€è¿˜è¦è¿›è¡Œå„é¡¹è®¾å¤‡ã€ä»ªå™¨çš„æ£€æŸ¥ã€‚ åªæœ‰ç­‰æ‰€æœ‰æ£€æŸ¥å®Œæ¯•åï¼Œå¼•æ“æ‰èƒ½ç‚¹ç«ã€‚è¿™ç§åœºæ™¯å°±éå¸¸é€‚åˆä½¿ç”¨CountDownLatchã€‚å®ƒå¯ä»¥ä½¿å¾—ç‚¹ç«çº¿ç¨‹ ï¼Œç­‰å¾…æ‰€æœ‰æ£€æŸ¥çº¿ç¨‹å…¨éƒ¨å®Œå·¥åï¼Œå†æ‰§è¡Œ</p><h3 id="1-5-2-ä¸»è¦æ¥å£"><a href="#1-5-2-ä¸»è¦æ¥å£" class="headerlink" title="1.5.2. ä¸»è¦æ¥å£"></a>1.5.2. ä¸»è¦æ¥å£</h3><p>static final CountDownLatch end = new CountDownLatch(10); //åŠ å…¥æœ‰åä¸ªæ£€æŸ¥é¡¹ï¼ˆåä¸ªçº¿ç¨‹ï¼‰<br>end.countDown();//æ²¡é€šè¿‡ä¸€ä¸ªå°±å‡ä¸€<br>end.await();//è§åˆ°æœ€åå°±è¿”å›ï¼Œæ‰§è¡Œæ¯”å¦‚å‘å°„ç«ç®­çš„æ“ä½œ</p><h3 id="1-5-3-ç¤ºæ„å›¾"><a href="#1-5-3-ç¤ºæ„å›¾" class="headerlink" title="1.5.3. ç¤ºæ„å›¾"></a>1.5.3. ç¤ºæ„å›¾</h3><p><img alt="" data-original="/images/15488916716971.png"></p><p>ä¸»çº¿ç¨‹åœ¨è¿™é‡Œç­‰å¾…ï¼Œç­‰åˆ°æ‰€æœ‰çš„æ£€æŸ¥ä»»åŠ¡éƒ½åˆ°è¾¾ä¸´ç•Œç‚¹ä¹‹åï¼Œä¸»çº¿ç¨‹å°±ç»§ç»­æ‰§è¡Œã€‚</p><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"><span class="keyword">static</span> final CountDownLatch end = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);<span class="comment">//å¼€å¯åä¸ªçº¿ç¨‹æ¥è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">static</span> final CountDownLatchDemo demo = <span class="keyword">new</span> CountDownLatchDemo();</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">10</span>)*<span class="number">1000</span>);</span><br><span class="line">System.out.println(<span class="string">"check complete"</span>);</span><br><span class="line">end.countDown();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">ExecutorService exec = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">exec.submit(demo);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç­‰å¾…æ£€æŸ¥</span></span><br><span class="line">end.await();</span><br><span class="line"><span class="comment">//å‘å°„ç«ç®­</span></span><br><span class="line">System.out.println(<span class="string">"Fire"</span>);</span><br><span class="line">exec.shutdown();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">check complete</span><br><span class="line">Fire</span><br></pre></td></tr></table></figure><h2 id="1-6-CyclicBarrier"><a href="#1-6-CyclicBarrier" class="headerlink" title="1.6. CyclicBarrier"></a>1.6. CyclicBarrier</h2><h3 id="1-6-1-æ¦‚è¿°"><a href="#1-6-1-æ¦‚è¿°" class="headerlink" title="1.6.1. æ¦‚è¿°"></a>1.6.1. æ¦‚è¿°</h3><p>å¾ªç¯æ …æ  Cyclicæ„ä¸ºå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè®¡æ•°å™¨å¯ä»¥åå¤ä½¿ç”¨ã€‚æ¯”å¦‚ï¼Œå‡è®¾æˆ‘ä»¬å°†è®¡æ•°å™¨è®¾ç½®ä¸º10ã€‚é‚£ä¹ˆå‡‘é½ç¬¬ä¸€æ‰¹1 0ä¸ªçº¿ç¨‹åï¼Œè®¡æ•°å™¨å°±ä¼šå½’é›¶ï¼Œç„¶åæ¥ç€å‡‘é½ä¸‹ä¸€æ‰¹10ä¸ªçº¿ç¨‹<br>å®ƒå’ŒCountDownLatchçš„åŒºåˆ«æ˜¯CountDownLatchçš„è®¡æ•°å™¨åªèƒ½æœ‰ä¸€æ¬¡ï¼Œè€ŒCyclicBarrierå¯ä»¥å†é‡å¤åˆ©ç”¨ã€‚</p><h3 id="1-6-2-ä¸»è¦æ¥å£"><a href="#1-6-2-ä¸»è¦æ¥å£" class="headerlink" title="1.6.2. ä¸»è¦æ¥å£"></a>1.6.2. ä¸»è¦æ¥å£</h3><p>public CyclicBarrier(int partiesï¼ˆå‡ ä¸ªå‚ä¸è€…ç›¸å½“äºä¸Šä¸€èŠ‚ä¸­çš„10ï¼‰, Runnable barrierActionï¼ˆæ‰€æœ‰çš„çº¿ç¨‹åˆ°äº†ä¹‹åï¼Œæ …æ ï¼ˆç³»ç»Ÿï¼‰æ‰§è¡Œçš„åŠ¨ä½œï¼‰)<br>barrierActionå°±æ˜¯å½“è®¡æ•°å™¨ä¸€æ¬¡è®¡æ•°å®Œæˆåï¼Œç³»ç»Ÿä¼šæ‰§è¡Œçš„åŠ¨ä½œ<br>await() //éƒ½åˆ°äº†ä¹‹åå†å¾€ä¸‹æ‰§è¡Œ</p><h3 id="1-6-3-ç¤ºæ„å›¾"><a href="#1-6-3-ç¤ºæ„å›¾" class="headerlink" title="1.6.3. ç¤ºæ„å›¾"></a>1.6.3. ç¤ºæ„å›¾</h3><p><img alt="" data-original="/images/15488917438815.png"></p><h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierDemo</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span>  <span class="class"><span class="keyword">class</span> <span class="title">Soldier</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">private <span class="built_in">String</span> soldier;</span><br><span class="line">private final CyclicBarrier cyclic;</span><br><span class="line"></span><br><span class="line">Soldier(CyclicBarrier cyclic,<span class="built_in">String</span> soldierName) &#123;</span><br><span class="line"><span class="keyword">this</span>.soldier = soldierName;</span><br><span class="line"><span class="keyword">this</span>.cyclic = cyclic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">cyclic.await();</span><br><span class="line">doWork();</span><br><span class="line">cyclic.await();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> doWork()&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="built_in">Math</span>.abs(<span class="keyword">new</span> Random().nextInt()%<span class="number">10000</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(soldier+<span class="string">":ä»»åŠ¡å®Œæˆ"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BarrierRun</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">boolean flag;</span><br><span class="line">int N;</span><br><span class="line"></span><br><span class="line">public BarrierRun(boolean flag, int N) &#123;</span><br><span class="line"><span class="keyword">this</span>.flag = flag;</span><br><span class="line"><span class="keyword">this</span>.N = N;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">if</span> (flag) &#123;</span><br><span class="line">System.out.println(<span class="string">"å¸ä»¤:[å£«å…µ"</span>+N+<span class="string">"ä¸ªï¼Œä»»åŠ¡å®Œæˆï¼]"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"å¸ä»¤:[å£«å…µ"</span>+N+<span class="string">"ä¸ªï¼Œé›†åˆå®Œæ¯•ï¼]"</span>);</span><br><span class="line">flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">final int N = <span class="number">10</span>;</span><br><span class="line">Thread[] allSoldier = <span class="keyword">new</span> Thread[N];</span><br><span class="line">boolean flag = <span class="literal">false</span>;</span><br><span class="line">CyclicBarrier cyclic = <span class="keyword">new</span> CyclicBarrier(N, <span class="keyword">new</span> BarrierRun(flag, N));</span><br><span class="line">System.out.println(<span class="string">"é›†åˆé˜Ÿä¼!"</span>);</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;N ; i++) &#123;</span><br><span class="line">System.out.println(<span class="string">"å£«å…µ"</span>+i+<span class="string">"æŠ¥é“ï¼"</span>);</span><br><span class="line">allSoldier[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Soldier(cyclic, <span class="string">"å£«å…µ"</span> + i));</span><br><span class="line">allSoldier[i].start();</span><br><span class="line"><span class="comment">//if (i == 5) &#123;</span></span><br><span class="line"><span class="comment">//allSoldier[0].interrupt();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">é›†åˆé˜Ÿä¼ï¼</span><br><span class="line">å£«å…µ<span class="number">0</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">1</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">2</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">3</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">4</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">5</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">6</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">7</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">8</span>æŠ¥é“</span><br><span class="line">å£«å…µ<span class="number">9</span>æŠ¥é“</span><br><span class="line">å¸ä»¤[å£«å…µ<span class="number">10</span>ä¸ªï¼Œé›†åˆå®Œæ¯•ï¼]</span><br><span class="line">å£«å…µ<span class="number">2</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">7</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">0</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">4</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">3</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">9</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">6</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">8</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">1</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å£«å…µ<span class="number">5</span>ï¼šä»»åŠ¡å®Œæˆ</span><br><span class="line">å¸ä»¤ï¼š[å£«å…µ<span class="number">10</span>ä¸ªï¼Œä»»åŠ¡å®Œæˆï¼]</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//if (i == 5) &#123;</span></span><br><span class="line"><span class="comment">//allSoldier[0].interrupt();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸ªæ³¨é‡Šæ‰“å¼€çš„è¯<br><img alt="" data-original="/images/15488919151578.png"></p><p>ç¬¬é›¶ä¸ªç»ˆç«¯ä¹‹åï¼Œå°†ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ï¼Œå‰©ä¸‹çš„ä¹ä¸ªçº¿ç¨‹å°†ä¼šæŠ›å‡ºBrokenBarrierExceptionå¼‚å¸¸ã€‚</p><h2 id="1-7-LockSupport"><a href="#1-7-LockSupport" class="headerlink" title="1.7. LockSupport"></a>1.7. LockSupport</h2><h3 id="1-7-1-æ¦‚è¿°"><a href="#1-7-1-æ¦‚è¿°" class="headerlink" title="1.7.1. æ¦‚è¿°"></a>1.7.1. æ¦‚è¿°</h3><p>æ¯”è¾ƒååº•å±‚ã€‚<br>æä¾›çº¿ç¨‹é˜»å¡åŸè¯­<br>æŒ‚èµ·</p><h3 id="1-7-2-ä¸»è¦æ¥å£"><a href="#1-7-2-ä¸»è¦æ¥å£" class="headerlink" title="1.7.2. ä¸»è¦æ¥å£"></a>1.7.2. ä¸»è¦æ¥å£</h3><p>LockSupport.park(); //åœä¸‹æ¥ã€æŒ‚èµ·ï¼Œå°†çº¿ç¨‹æŒ‚èµ·ï¼Œé™¤éè®¸å¯æ˜¯å¯ç”¨çš„ã€‚<br>LockSupport.unpark(t1);//å°†t1ç»§ç»­æ‰§è¡Œï¼Œä½¿å¾—è®¸å¯æ˜¯å¯ç”¨çš„</p><h3 id="1-7-3-ä¸suspend-æ¯”è¾ƒ"><a href="#1-7-3-ä¸suspend-æ¯”è¾ƒ" class="headerlink" title="1.7.3. ä¸suspend()æ¯”è¾ƒ"></a>1.7.3. ä¸suspend()æ¯”è¾ƒ</h3><p>LockSupportä¸å®¹æ˜“å¼•èµ·çº¿ç¨‹å†»ç»“ï¼Œsuspendå°†æ¥å¯èƒ½ä¼šè¢«åºŸå¼ƒã€‚<br>æœ‰ç‚¹ç±»ä¼¼äºä¿¡å·é‡ä¸­çš„è®¸å¯ï¼Œå¦‚æœunparkå‘ç”Ÿåœ¨parkä¹‹å‰ï¼Œparkå¹¶ä¸ä¼šå°†çº¿ç¨‹é˜»å¡ä½ã€‚<br>å¦‚æœrewiewå‘ç”Ÿåœ¨suspendä¹‹å‰ï¼Œsuspendå°±ä¸èƒ½å†ç»§ç»­æ‰§è¡Œäº†ï¼Œæ°¸ä¹…æŒ‚èµ·ã€‚</p><h3 id="1-7-4-ä¸­æ–­å“åº”"><a href="#1-7-4-ä¸­æ–­å“åº”" class="headerlink" title="1.7.4. ä¸­æ–­å“åº”"></a>1.7.4. ä¸­æ–­å“åº”</h3><p>waitç­‰æ˜¯èƒ½å¤Ÿtry catch ç»ˆç«¯å¼‚å¸¸çš„ï¼Œä½†æ˜¯parkæ˜¯æ²¡æœ‰æ•è·è¿™ä¸ªå¼‚å¸¸çš„ï¼Œæ‰€ä»¥ï¼š<br>èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼Œä½†ä¸æŠ›å‡ºå¼‚å¸¸ã€‚<br>ä¸­æ–­å“åº”çš„ç»“æœæ˜¯ï¼Œpark()å‡½æ•°çš„è¿”å›ï¼Œå¯ä»¥ä»Thread.interrupted()å¾—åˆ°ä¸­æ–­æ ‡å¿—</p><h3 id="ä¾‹å­-2"><a href="#ä¾‹å­-2" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LockSupportDemo</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">Object</span> u = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line"><span class="keyword">static</span> ChangeObjectThread t1 = <span class="keyword">new</span> ChangeObjectThread(<span class="string">"t1"</span>);</span><br><span class="line"><span class="keyword">static</span> ChangeObjectThread t2 = <span class="keyword">new</span> ChangeObjectThread(<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeObjectThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public ChangeObjectThread(<span class="built_in">String</span> name) &#123;</span><br><span class="line"><span class="keyword">super</span>.setName(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">synchronized (u)&#123;</span><br><span class="line">System.out.println(<span class="string">"in"</span>+getName());</span><br><span class="line">LockSupport.park();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">t1.start();</span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line">t2.start();</span><br><span class="line">LockSupport.unpark(t1);</span><br><span class="line">LockSupport.unpark(t2);</span><br><span class="line">t1.join();</span><br><span class="line">t2.join();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int <span class="number">1</span> </span><br><span class="line">int <span class="number">2</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸è®ºunparkåœ¨parkçš„å‰é¢è¿˜æ˜¯åé¢éƒ½ä¸ä¼šé˜»å¡ã€‚</p><h2 id="1-8-ReentrantLock-çš„å®ç°"><a href="#1-8-ReentrantLock-çš„å®ç°" class="headerlink" title="1.8. ReentrantLock çš„å®ç°"></a>1.8. ReentrantLock çš„å®ç°</h2><h3 id="1-8-1-CASçŠ¶æ€"><a href="#1-8-1-CASçŠ¶æ€" class="headerlink" title="1.8.1. CASçŠ¶æ€"></a>1.8.1. CASçŠ¶æ€</h3><p>é”åˆ°åº•æœ‰æ²¡æœ‰è¢«äººå ç”¨ï¼Œé€šè¿‡æ˜¯å¦åˆ°è¾¾æœŸæœ›å€¼ï¼Œé€šè¿‡å€¼æ˜¯å¦æ”¹å˜æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥æ‹¿åˆ°é”ã€‚</p><h3 id="1-8-2-ç­‰å¾…é˜Ÿåˆ—"><a href="#1-8-2-ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="1.8.2. ç­‰å¾…é˜Ÿåˆ—"></a>1.8.2. ç­‰å¾…é˜Ÿåˆ—</h3><p>å¦‚æœæ²¡æœ‰æ‹¿åˆ°é”ï¼Œçº¿ç¨‹åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Œåº”è¯¥è¿›å…¥ç­‰å¾…çš„é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¿›æ¥ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œç­‰å¾…ã€‚</p><h3 id="1-8-3-park"><a href="#1-8-3-park" class="headerlink" title="1.8.3. park()"></a>1.8.3. park()</h3><p>åœ¨é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éƒ½è¿›è¡Œparkæ“ä½œã€‚unlockçš„æ—¶å€™ï¼Œä»ç­‰å¾…çš„é˜Ÿåˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå‡ºæ¥è¿›è¡Œunparkæ“ä½œã€‚</p><h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Performs lock.  Try immediate barge, backing up to normal</span></span><br><span class="line"><span class="comment">         * acquire on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        final <span class="keyword">void</span> lock() &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))<span class="comment">//æœŸæœ›å€¼æ˜¯0ï¼Œæ›´æ–°æˆ1</span></span><br><span class="line">            <span class="comment">//å¦‚æœæˆåŠŸäº†ï¼Œä¾¿èƒ½æ‹¿åˆ°é”ï¼Œå°±èƒ½ç»§ç»­å¾€ä¸‹èµ°ã€‚</span></span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            <span class="comment">//å¦åˆ™å°±å°è¯•å»åšç”³è¯·ã€‚</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        protected final boolean compareAndSetState(int expect, int update) &#123;</span><br><span class="line">        <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line">     public final <span class="keyword">void</span> acquire(int arg) &#123;</span><br><span class="line">     <span class="comment">//åœ¨å°è¯•ä¸€ä¸‹ï¼Œä¸‡ä¸€åˆ«äººé‡Šæ”¾äº†å‘¢ï¼Ÿ</span></span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœå°è¯•äº†è¿˜æ˜¯ä¸è¡Œå°±æŠŠè‡ªå·±æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">      private Node addWaiter(Node mode) &#123;</span><br><span class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">        <span class="comment">//æ”¾åˆ°é˜Ÿåˆ—çš„å°¾å·´ä¸Šå»ã€‚</span></span><br><span class="line">        Node pred = tail;</span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//è¿”å›çš„nodeç„¶åå†å»å°è¯•è¯·æ±‚é”</span></span><br><span class="line">    final boolean acquireQueued(final Node node, int arg) &#123;</span><br><span class="line">        boolean failed = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            boolean interrupted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                final Node p = node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">               <span class="comment">//å¦‚æœç¡®å®æ˜¯æ‹¿ä¸åˆ°å°±ä¼šåœ¨è¿™é‡ŒæŒ‚èµ·ï¼Œä¸‹é¢ä¼šæœ‰è¯¦ç»†</span></span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€šè¿‡parkè¿›è¡ŒæŒ‚èµ·</span></span><br><span class="line"> private final boolean parkAndCheckInterrupt() &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//unlockæ“ä½œ</span></span><br><span class="line"> public <span class="keyword">void</span> unlock() &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line"> &#125;</span><br><span class="line">  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">    public final boolean release(int arg) &#123;</span></span><br><span class="line"><span class="regexp">        if (tryRelease(arg)) &#123;</span></span><br><span class="line"><span class="regexp">            Node h = head;</span></span><br><span class="line"><span class="regexp">            if (h != null &amp;&amp; h.waitStatus != 0)</span></span><br><span class="line"><span class="regexp">            /</span><span class="regexp">/å°†é˜Ÿåˆ—å¤´éƒ¨çš„nodeè¿›è¡Œunparkæ“ä½œ</span></span><br><span class="line"><span class="regexp">                unparkSuccessor(h);</span></span><br><span class="line"><span class="regexp">            return true;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        return false;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">private void unparkSuccessor(Node node) &#123;</span></span><br><span class="line"><span class="regexp">        /</span>*</span><br><span class="line">         * If status is negative (i.e., possibly needing signal) <span class="keyword">try</span></span><br><span class="line">         * to clear <span class="keyword">in</span> anticipation <span class="keyword">of</span> signalling.  It is OK <span class="keyword">if</span> <span class="keyword">this</span></span><br><span class="line">         * fails or <span class="keyword">if</span> status is changed by waiting thread.</span><br><span class="line">         *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">        int ws = node.waitStatus;</span></span><br><span class="line"><span class="regexp">        if (ws &lt; 0)</span></span><br><span class="line"><span class="regexp">            compareAndSetWaitStatus(node, ws, 0);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span>*</span><br><span class="line">         * Thread to unpark is held <span class="keyword">in</span> successor, which is normally</span><br><span class="line">         * just the next node.  But <span class="keyword">if</span> cancelled or apparently <span class="literal">null</span>,</span><br><span class="line">         * traverse backwards <span class="keyword">from</span> tail to find the actual</span><br><span class="line">         * non-cancelled successor.</span><br><span class="line">         *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">        Node s = node.next;</span></span><br><span class="line"><span class="regexp">        if (s == null || s.waitStatus &gt; 0) &#123;</span></span><br><span class="line"><span class="regexp">            s = null;</span></span><br><span class="line"><span class="regexp">            for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)</span></span><br><span class="line"><span class="regexp">                if (t.waitStatus &lt;= 0)</span></span><br><span class="line"><span class="regexp">                    s = t;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        if (s != null)</span></span><br><span class="line"><span class="regexp">            LockSupport.unpark(s.thread);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br></pre></td></tr></table></figure><h1 id="2-å¹¶å‘å®¹å™¨åŠå…¸å‹æºç åˆ†æ"><a href="#2-å¹¶å‘å®¹å™¨åŠå…¸å‹æºç åˆ†æ" class="headerlink" title="2. å¹¶å‘å®¹å™¨åŠå…¸å‹æºç åˆ†æ"></a>2. å¹¶å‘å®¹å™¨åŠå…¸å‹æºç åˆ†æ</h1><h2 id="2-1-é›†åˆåŒ…è£…"><a href="#2-1-é›†åˆåŒ…è£…" class="headerlink" title="2.1. é›†åˆåŒ…è£…"></a>2.1. é›†åˆåŒ…è£…</h2><h3 id="2-1-1-HashMap"><a href="#2-1-1-HashMap" class="headerlink" title="2.1.1. HashMap"></a>2.1.1. HashMap</h3><p>HashMapä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹æ³•å˜æˆçº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯åªé€‚ç”¨äºå¹¶å‘é‡æ¯”è¾ƒå°çš„æƒ…å†µã€‚<br>Collections.synchronizedMap<br><img alt="" data-original="/images/15488921053227.png"></p><h3 id="æºç -1"><a href="#æºç -1" class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="title">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        private <span class="keyword">static</span> final long serialVersionUID = <span class="number">1978198479659022715</span>L;</span><br><span class="line"></span><br><span class="line">        private final <span class="built_in">Map</span>&lt;K,V&gt; m;     <span class="comment">// Backing Map</span></span><br><span class="line">        final <span class="built_in">Object</span>      mutex;        <span class="comment">// Object on which to synchronize</span></span><br><span class="line"></span><br><span class="line">        SynchronizedMap(<span class="built_in">Map</span>&lt;K,V&gt; m) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m==<span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">this</span>.m = m;</span><br><span class="line">            mutex = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SynchronizedMap(<span class="built_in">Map</span>&lt;K,V&gt; m, <span class="built_in">Object</span> mutex) &#123;</span><br><span class="line">            <span class="keyword">this</span>.m = m;</span><br><span class="line">            <span class="keyword">this</span>.mutex = mutex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int size() &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.size();&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public boolean isEmpty() &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.isEmpty();&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public boolean containsKey(<span class="built_in">Object</span> key) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.containsKey(key);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public boolean containsValue(<span class="built_in">Object</span> value) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.containsValue(value);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public V get(<span class="built_in">Object</span> key) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.get(key);&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public V put(K key, V value) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.put(key, value);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public V remove(<span class="built_in">Object</span> key) &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.remove(key);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public <span class="keyword">void</span> putAll(<span class="built_in">Map</span>&lt;? extends K, ? extends V&gt; map) &#123;</span><br><span class="line">            synchronized (mutex) &#123;m.putAll(map);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public <span class="keyword">void</span> clear() &#123;</span><br><span class="line">            synchronized (mutex) &#123;m.clear();&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private transient <span class="built_in">Set</span>&lt;K&gt; keySet = <span class="literal">null</span>;</span><br><span class="line">        private transient <span class="built_in">Set</span>&lt;<span class="built_in">Map</span>.Entry&lt;K,V&gt;&gt; entrySet = <span class="literal">null</span>;</span><br><span class="line">        private transient Collection&lt;V&gt; values = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        public <span class="built_in">Set</span>&lt;K&gt; keySet() &#123;</span><br><span class="line">            synchronized (mutex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (keySet==<span class="literal">null</span>)</span><br><span class="line">                    keySet = <span class="keyword">new</span> SynchronizedSet&lt;&gt;(m.keySet(), mutex);</span><br><span class="line">                <span class="keyword">return</span> keySet;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public <span class="built_in">Set</span>&lt;<span class="built_in">Map</span>.Entry&lt;K,V&gt;&gt; entrySet() &#123;</span><br><span class="line">            synchronized (mutex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entrySet==<span class="literal">null</span>)</span><br><span class="line">                    entrySet = <span class="keyword">new</span> SynchronizedSet&lt;&gt;(m.entrySet(), mutex);</span><br><span class="line">                <span class="keyword">return</span> entrySet;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Collection&lt;V&gt; values() &#123;</span><br><span class="line">            synchronized (mutex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (values==<span class="literal">null</span>)</span><br><span class="line">                    values = <span class="keyword">new</span> SynchronizedCollection&lt;&gt;(m.values(), mutex);</span><br><span class="line">                <span class="keyword">return</span> values;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public boolean equals(<span class="built_in">Object</span> o) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.equals(o);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public int hashCode() &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.hashCode();&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public <span class="built_in">String</span> toString() &#123;</span><br><span class="line">            synchronized (mutex) &#123;<span class="keyword">return</span> m.toString();&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        private <span class="keyword">void</span> writeObject(ObjectOutputStream s) throws IOException &#123;</span><br><span class="line">            synchronized (mutex) &#123;s.defaultWriteObject();&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿåˆ†æï¼Œæ˜¯å°†mapå°è£…åˆ°äº†synchronizeMapä¸­ï¼Œå¹¶ä¸”ï¼Œå°†get put ç­‰æ“ä½œéƒ½æ”¾åœ¨äº†Synchronizeä»£ç å—ä¸­ï¼Œä¸‹é¢çš„Listå’ŒSetåŒç†ï¼Œå› ä¸ºæ˜¯æ”¾åœ¨äº†synchronizeä»£ç å—ä¸­æ‰€ä»¥æ˜¯ä¸²è¡Œçš„ä¸æ˜¯å¹¶è¡Œçš„ï¼Œåªèƒ½é€‚ç”¨äºå¹¶å‘é‡æ¯”è¾ƒå°çš„åœºæ™¯ã€‚</p><h3 id="2-1-2-List"><a href="#2-1-2-List" class="headerlink" title="2.1.2. List"></a>2.1.2. List</h3><p>synchronizedList</p><h3 id="2-1-3-Set"><a href="#2-1-3-Set" class="headerlink" title="2.1.3. Set"></a>2.1.3. Set</h3><p>synchronizedSet</p><h2 id="2-2-ConcurrentHashMap"><a href="#2-2-ConcurrentHashMap" class="headerlink" title="2.2. ConcurrentHashMap"></a>2.2. ConcurrentHashMap</h2><p>é«˜æ€§èƒ½HashMapï¼ˆè§£å†³synchronizeåªé€‚ç”¨äºå¹¶å‘é‡å°çš„åœºæ™¯ï¼‰</p><h3 id="2-2-1HashMapæºç åˆ†æ"><a href="#2-2-1HashMapæºç åˆ†æ" class="headerlink" title="2.2.1HashMapæºç åˆ†æ"></a>2.2.1HashMapæºç åˆ†æ</h3><p>HashMapå†…éƒ¨æ˜¯ä¸€ä¸ªæ•°ç»„<br>æ‹¿putæ–¹æ³•æ¥çœ‹<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">            inflateTable(threshold);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">        int hash = hash(key);</span><br><span class="line">        int i = indexFor(hash, table.length);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="built_in">Object</span> k;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                e.value = value;</span><br><span class="line">                e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        modCount++;</span><br><span class="line">        addEntry(hash, key, value, i);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿›å…¥inflateTableæ–¹æ³•</span></span><br><span class="line">  private <span class="keyword">void</span> inflateTable(int toSize) &#123;</span><br><span class="line">        <span class="comment">// Find a power of 2 &gt;= toSize</span></span><br><span class="line">        int capacity = roundUpToPowerOf2(toSize);</span><br><span class="line"></span><br><span class="line">        threshold = (int) <span class="built_in">Math</span>.min(capacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">        table = <span class="keyword">new</span> Entry[capacity];</span><br><span class="line">        initHashSeedAsNeeded(capacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çœ‹åˆ°æ˜¯å°†ç–æµšå­˜åˆ°äº†tableä¸­</span></span><br><span class="line">    transient Entry&lt;K,V&gt;[] table = (Entry&lt;K,V&gt;[]) EMPTY_TABLE;</span><br><span class="line">    <span class="comment">//æ¯ä¸€ä¸ªtableä¸­æ˜¯entryè¡¨è±¡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="title">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//æ¯ä¸ªentryé‡Œé¢æ˜¯key value next hash</span></span><br><span class="line">        final K key;</span><br><span class="line">        V value;</span><br><span class="line">        Entry&lt;K,V&gt; next;</span><br><span class="line">        int hash;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates new entry.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Entry(int h, K k, V v, Entry&lt;K,V&gt; n) &#123;</span><br><span class="line">            value = v;</span><br><span class="line">            next = n;</span><br><span class="line">            key = k;</span><br><span class="line">            hash = h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final K getKey() &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final V getValue() &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final V setValue(V newValue) &#123;</span><br><span class="line">            V oldValue = value;</span><br><span class="line">            value = newValue;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final boolean equals(<span class="built_in">Object</span> o) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> <span class="built_in">Map</span>.Entry))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">Map</span>.Entry e = (<span class="built_in">Map</span>.Entry)o;</span><br><span class="line">            <span class="built_in">Object</span> k1 = getKey();</span><br><span class="line">            <span class="built_in">Object</span> k2 = e.getKey();</span><br><span class="line">            <span class="keyword">if</span> (k1 == k2 || (k1 != <span class="literal">null</span> &amp;&amp; k1.equals(k2))) &#123;</span><br><span class="line">                <span class="built_in">Object</span> v1 = getValue();</span><br><span class="line">                <span class="built_in">Object</span> v2 = e.getValue();</span><br><span class="line">                <span class="keyword">if</span> (v1 == v2 || (v1 != <span class="literal">null</span> &amp;&amp; v1.equals(v2)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final int hashCode() &#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(getKey()) ^ Objects.hashCode(getValue());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final <span class="built_in">String</span> toString() &#123;</span><br><span class="line">            <span class="keyword">return</span> getKey() + <span class="string">"="</span> + getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * This method is invoked whenever the value in an entry is</span></span><br><span class="line"><span class="comment">         * overwritten by an invocation of put(k,v) for a key k that's already</span></span><br><span class="line"><span class="comment">         * in the HashMap.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> recordAccess(HashMap&lt;K,V&gt; m) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * This method is invoked whenever the entry is</span></span><br><span class="line"><span class="comment">         * removed from the table.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> recordRemoval(HashMap&lt;K,V&gt; m) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p><img alt="" data-original="/images/15488919681106.png"></p><p>getï¼ˆkeyï¼‰æ˜¯é€šè¿‡å“ˆå¸Œç®—æ³•æ¥åˆ¤æ–­åº”è¯¥æ˜ å°„åˆ°å“ªä¸ªæ§½ä½çš„<br>ä¸¤ä¸ªä¸åŒçš„keyæ¯”å¦‚ï¼Œkey1 key2å¯èƒ½è¢«æ˜ å°„åˆ°åŒä¸€ä¸ªæ§½ä½ä¸­ï¼Œè¿™é‡Œå«åšå“ˆå¸Œå†²çª<br>ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼Œæ—¢ç„¶ä½ æ˜ å°„åˆ°äº†åŒä¸€ä¸ªæ§½ä½ä¸­ï¼Œæˆ‘å°±æŠŠä½ æ–¹æ³•åŒä¸€ä¸ªæ§½ä½ä¸­ï¼Œå¯æ˜¯åœ¨ä¸€ä¸ªentryçš„æ•°ç»„ä¸­å¦‚ä½•æ”¾ä¸¤ä¸ªentryå‘¢ï¼Ÿï¼Ÿé€šè¿‡entryä¸­çš„nextæŒ‡å‘ä¸‹ä¸€ä¸ªentry</p><p>äº‹å®ä¸ŠHashMapçš„å†…éƒ¨ä¸»è¦å®ç°æ˜¯æ•°ç»„ï¼Œæ•°ç»„ä¸­æ”¾ç€entryï¼Œæ¯ä¸ªentryéƒ½æ˜¯é“¾è¡¨ä¸­çš„ä¸€ç¯ï¼Œé“¾è¡¨çš„å¤´éƒ¨ï¼Œå½“å‘ç”Ÿå¤§é‡çš„hashå†²çªçš„æ—¶å€™èœ•åŒ–æˆä¸€ä¸ªé“¾è¡¨ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹HashMapä¸ä¼šæ”¾æ»¡ï¼Œå› ä¸ºæ”¾æ»¡ä¹‹åå¿…ç„¶äº§ç”Ÿå†²çªï¼Œæ‰€ä»¥ä¸€èˆ¬HashMapéœ€è¦é¢„ç•™ç©ºé—´</p><h3 id="2-2-2-ConcurrentHashMapæºç åˆ†æ"><a href="#2-2-2-ConcurrentHashMapæºç åˆ†æ" class="headerlink" title="2.2.2. ConcurrentHashMapæºç åˆ†æ"></a>2.2.2. ConcurrentHashMapæºç åˆ†æ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">       Segment&lt;K,V&gt; s;</span><br><span class="line">       <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       int hash = hash(key);</span><br><span class="line">       int j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</span><br><span class="line">       <span class="keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          <span class="comment">// nonvolatile; recheck</span></span><br><span class="line">            (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="literal">null</span>) <span class="comment">//  in ensureSegment</span></span><br><span class="line">           s = ensureSegment(j);</span><br><span class="line">       <span class="keyword">return</span> s.put(key, hash, value, <span class="literal">false</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>Segment æ®µ<br>å¦‚æœå¤§é‡çº¿ç¨‹è¿›æ¥ï¼Œä¼šä¸€èµ·ç«äº‰HashMapçš„èµ‹å€¼æ“ä½œ<br>æŠŠå¤§çš„HashMapåˆ‡å‰²æˆè‹¥å¹²ä¸ªå°çš„HashMapï¼Œæ¯ä¸ªçº¿ç¨‹è¿›æ¥çš„æ—¶å€™ï¼Œå…ˆæŠŠå½“å‰çš„keyæ˜ å°„åˆ°å…¶ä¸­çš„ä¸€ä¸ªå°HashMapä¸­å»ï¼Œåœ¨å°HashMapä¸­åšä¸€ä¸ªæ™®é€šHashMapåº”è¯¥åšçš„äº‹æƒ…ï¼Œå‡å¦‚å¤§çš„HashMapä¸­æœ‰åå…­ä¸ªå°çš„HashMapï¼Œæ„å‘³ç€å¤§çš„HashMapå¯ä»¥åŒæ—¶æ¥å—åå…­ä¸ªçº¿ç¨‹çš„èµ‹å€¼æ“ä½œï¼Œç›¸æ¯”äºä¹‹å‰åªæœ‰ä¸€ä¸ªHasnMapï¼Œæ€§èƒ½æé«˜äº†åå…­å€ã€‚</p><p>è¿™é‡Œçš„Segmentå°±æ˜¯ä¸Šé¢è¯´çš„å°HashMapï¼Œé€šè¿‡ç§»ä½æ“ä½œæ‹¿åˆ°å½“å‰çš„åç§»é‡å¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private Segment&lt;K,V&gt; ensureSegment(int k) &#123;</span><br><span class="line">       final Segment&lt;K,V&gt;[] ss = <span class="keyword">this</span>.segments;</span><br><span class="line">       long u = (k &lt;&lt; SSHIFT) + SBASE; <span class="comment">// raw offset</span></span><br><span class="line">       Segment&lt;K,V&gt; seg;</span><br><span class="line">       <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == <span class="literal">null</span>) &#123;</span><br><span class="line">           Segment&lt;K,V&gt; proto = ss[<span class="number">0</span>]; <span class="comment">// use segment 0 as prototype</span></span><br><span class="line">           int cap = proto.table.length;</span><br><span class="line">           float lf = proto.loadFactor;</span><br><span class="line">           int threshold = (int)(cap * lf);</span><br><span class="line">           HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])<span class="keyword">new</span> HashEntry[cap];</span><br><span class="line">           <span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">               == <span class="literal">null</span>) &#123; <span class="comment">// recheck</span></span><br><span class="line">               Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">               <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                      == <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="literal">null</span>, seg = s))</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> seg;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å°†ç¬¬é›¶ä¸ªSegmentä½œä¸ºåŸå‹å°†ç¬¬kä¸ªSegmentè®¾ç½®å‡ºæ¥ã€‚</p><p><strong><font color="red">æ³¨æ„è¿™é‡Œçš„putè™½ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ä½†æ˜¯å¹¶æ²¡æœ‰ä½¿ç”¨é”ã€‚<br></font></strong><br>ä¸Šé¢çš„s.put():</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> final V put(K key, int hash, V value, boolean onlyIfAbsent) &#123;</span><br><span class="line"> <span class="comment">//è¿™é‡Œçš„tryLockè¿˜æ˜¯ä¸€ä¸ªCASæ“ä½œtryLockä¸ä¼šç­‰å¾…ï¼ŒLockæ‰ä¼šç­‰å¾…</span></span><br><span class="line">            HashEntry&lt;K,V&gt; node = tryLock() ? <span class="literal">null</span> :</span><br><span class="line">            <span class="comment">//å¦‚æœtrylockå¤±è´¥ï¼Œä»£ç åœ¨çº¿é¢è¯¦ç»†è§£é‡Šè¿™ä¸ªå‡½æ•°</span></span><br><span class="line">                scanAndLockForPut(key, hash, value);</span><br><span class="line">            V oldValue;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">                int index = (tab.length - <span class="number">1</span>) &amp; hash;</span><br><span class="line">                æ§½ä½æ˜ å°„åˆ°indexä¸Šï¼Œæ‹¿å‡ºindexä¸­çš„ç¬¬ä¸€ä¸ª</span><br><span class="line">                HashEntry&lt;K,V&gt; first = entryAt(tab, index);</span><br><span class="line">                <span class="comment">//å°è¯•å°†firstæ’åˆ°entryä¸­</span></span><br><span class="line">                <span class="keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæœ‰hashå†²çª</span></span><br><span class="line">                    <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                        K k;</span><br><span class="line">                        <span class="keyword">if</span> ((k = e.key) == key ||</span><br><span class="line">                            (e.hash == hash &amp;&amp; key.equals(k))) &#123;</span><br><span class="line">                            oldValue = e.value;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent) &#123;</span><br><span class="line">                                e.value = value;</span><br><span class="line">                                ++modCount;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//æœ‰Hashå†²çªå°±å°†valueä¸²èµ·æ¥</span></span><br><span class="line">                        e = e.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//å¦‚æœæ²¡æœ‰hashå†²çª</span></span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (node != <span class="literal">null</span>)</span><br><span class="line">                            node.setNext(first);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, first);</span><br><span class="line">                        int c = count + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                            rehash(node);</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">//å°±å°†entry setåˆ°æ•°ç»„ä¸­å»</span></span><br><span class="line">                            setEntryAt(tab, index, node);</span><br><span class="line">                        ++modCount;</span><br><span class="line">                        count = c;</span><br><span class="line">                        oldValue = <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">private HashEntry&lt;K,V&gt; scanAndLockForPut(K key, int hash, V value) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt; first = entryForHash(<span class="keyword">this</span>, hash);</span><br><span class="line">            HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">            HashEntry&lt;K,V&gt; node = <span class="literal">null</span>;</span><br><span class="line">            int retries = <span class="number">-1</span>; <span class="comment">// negative while locating node</span></span><br><span class="line">            <span class="comment">//ä¸æ–­çš„trylock</span></span><br><span class="line">            <span class="keyword">while</span> (!tryLock()) &#123;</span><br><span class="line">                HashEntry&lt;K,V&gt; f; <span class="comment">// to recheck first below</span></span><br><span class="line">                <span class="keyword">if</span> (retries &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="comment">// speculatively create node</span></span><br><span class="line">                            node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                        retries = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(e.key))</span><br><span class="line">                        retries = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        e = e.next;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœtrylockè¶…è¿‡äº†ä¸€å®šçš„æ¬¡æ•°ï¼Œå°±ä¼šæŒ‚èµ·</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">                    lock();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((retries &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                <span class="comment">//è¿™é‡Œå¯èƒ½æ˜¯hashè¿›è¡Œäº†æ‰©å®¹é‡hashç­‰æ“ä½œï¼Œå°†retrueså¤åˆ¶ä¸º-1ï¼Œ</span></span><br><span class="line">                <span class="comment">//å†ä¸æ–­çš„è¿›è¡Œtrylock</span></span><br><span class="line">                         (f = entryForHash(<span class="keyword">this</span>, hash)) != first) &#123;</span><br><span class="line">                    e = first = f; <span class="comment">// re-traverse if entry changed</span></span><br><span class="line">                    retries = <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><strong><font color="red">è¿™é‡Œçš„ä¸æ–­çš„trylockï¼Œå¦‚æœåˆ°è¾¾ä¸€å®šçš„æ¬¡æ•°åœ¨æŒ‚èµ·ï¼Œæ˜¯concurrentHashMapçš„æ ¸å¿ƒä¼˜åŒ–</font></strong><br>ä½†æ˜¯æ³¨æ„åœ¨concurrentHashMapä¸­æœ‰ä¸€ä¸ªsizeæ“ä½œä¸­çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public int size() &#123;</span><br><span class="line">        <span class="comment">// Try a few times to get accurate count. On failure due to</span></span><br><span class="line">        <span class="comment">// continuous async changes in table, resort to locking.</span></span><br><span class="line">        final Segment&lt;K,V&gt;[] segments = <span class="keyword">this</span>.segments;</span><br><span class="line">        int size;</span><br><span class="line">        boolean overflow; <span class="comment">// true if size overflows 32 bits</span></span><br><span class="line">        long sum;         <span class="comment">// sum of modCounts</span></span><br><span class="line">        long last = <span class="number">0</span>L;   <span class="comment">// previous sum</span></span><br><span class="line">        int retries = <span class="number">-1</span>; <span class="comment">// first iteration isn't retry</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (int j = <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                        ensureSegment(j).lock(); <span class="comment">// force creation</span></span><br><span class="line">                &#125;</span><br><span class="line">                sum = <span class="number">0</span>L;</span><br><span class="line">                size = <span class="number">0</span>;</span><br><span class="line">                overflow = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (int j = <span class="number">0</span>; j &lt; segments.length; ++j) &#123;</span><br><span class="line">                    Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">                    <span class="keyword">if</span> (seg != <span class="literal">null</span>) &#123;</span><br><span class="line">                        sum += seg.modCount;</span><br><span class="line">                        int c = seg.count;</span><br><span class="line">                        <span class="keyword">if</span> (c &lt; <span class="number">0</span> || (size += c) &lt; <span class="number">0</span>)</span><br><span class="line">                            overflow = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (sum == last)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                last = sum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">                <span class="keyword">for</span> (int j = <span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line">                    segmentAt(segments, j).unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> overflow ? Integer.MAX_VALUE : size;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸­é‡å¤è¿›è¡Œäº†lockå’Œunlockï¼Œå› ä¸ºåœ¨æƒ³è¦å¾—åˆ°mapçš„sizeçš„æ—¶å€™æ˜¯ä¸èƒ½å¤Ÿå†è¿›è¡Œä¿®æ”¹çš„ï¼Œæ‰€ä»¥åŠ ä¸Šé”ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œå¯æ˜¯sizeæ“ä½œç”¨çš„å¹¶ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥ã€‚</p><p>rehashæ“ä½œï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨putæ“ä½œä¸­</span></span><br><span class="line"><span class="comment">//å¦‚æœå¤§äºäº†hashçš„é˜ˆå€¼ï¼Œå°±ä¼šè¿›è¡Œrehash</span></span><br><span class="line"><span class="keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                            rehash(node);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Doubles size of table and repacks entries, also adding the</span></span><br><span class="line"><span class="comment">         * given node to new table</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"> private <span class="keyword">void</span> rehash(HashEntry&lt;K,V&gt; node) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">            int oldCapacity = oldTable.length;</span><br><span class="line">            int newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            threshold = (int)(newCapacity * loadFactor);</span><br><span class="line">            HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">                (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">            int sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">                HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                    HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">                    int idx = e.hash &amp; sizeMask;</span><br><span class="line">                    <span class="keyword">if</span> (next == <span class="literal">null</span>)   <span class="comment">//  Single node on list</span></span><br><span class="line">                        newTable[idx] = e;</span><br><span class="line">                    <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                        HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                        int lastIdx = idx;</span><br><span class="line">                        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                             last != <span class="literal">null</span>;</span><br><span class="line">                             last = last.next) &#123;</span><br><span class="line">                            int k = last.hash &amp; sizeMask;</span><br><span class="line">                            <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                                lastIdx = k;</span><br><span class="line">                                lastRun = last;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        newTable[lastIdx] = lastRun;</span><br><span class="line">                        <span class="comment">// Clone remaining nodes</span></span><br><span class="line">                        <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            V v = p.value;</span><br><span class="line">                            int h = p.hash;</span><br><span class="line">                            int k = h &amp; sizeMask;</span><br><span class="line">                            HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                            newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            int nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">            node.setNext(newTable[nodeIndex]);</span><br><span class="line">            newTable[nodeIndex] = node;</span><br><span class="line">            table = newTable;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>rehashä¼šå°†ç©ºé—´å®¹é‡ç¿»å€ï¼Œå°†nodeæ”¾è¿›å»ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œåšäº†ä¸€ç‚¹æ²¹ç”»ï¼Œå°½é‡é‡ç”¨ç°æœ‰çš„å…ƒç´ ï¼Œä¸å»æ–°å»ºå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¿»å€å‰å’Œç¿»å€åï¼ŒåŒä¸€ä¸ªå…ƒç´ ï¼Œå¾ˆå¯èƒ½åœ¨ç”¨ä¸€ä¸ªä½ç½®</p><h2 id="2-3-BlockingQueue"><a href="#2-3-BlockingQueue" class="headerlink" title="2.3. BlockingQueue"></a>2.3. BlockingQueue</h2><p>é˜»å¡é˜Ÿåˆ—</p><p>é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å¾€é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…å­˜æ”¾å…ƒç´ çš„å®¹å™¨ï¼Œè€Œæ¶ˆè´¹è€…ä¹Ÿåªä»å®¹å™¨é‡Œæ‹¿å…ƒç´ ã€‚<br><img alt="" data-original="/images/15488919944790.png"></p><p>ä»¥ä¸Šä¸¤æ®µå†…å®¹è½¬è‡ªï¼š<a href="http://ifeve.com/java-blocking-queue/" target="_blank" rel="noopener">http://ifeve.com/java-blocking-queue/</a><br><img alt="" data-original="/images/15488920002086.png"></p><p>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸æ˜¯ä¸€ä¸ªå®é™…çš„ç±»ï¼Œæ˜¯ä¸€ä¸ªå¹¶å‘å®¹å™¨ï¼Œä½†ä¸æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¹¶å‘å®¹å™¨ï¼Œå’ŒconcurrentHashMapï¼ˆé«˜æ€§èƒ½ï¼‰ä¸ä¸€æ ·ï¼Œä½†å®ƒæœ¬èº«çš„å¥½å¤„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹å…±äº«æ•°æ®çš„å®¹å™¨</p><p>å¦‚ä¸Šå›¾ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿˜è¯•å›¾å¾€é˜Ÿåˆ—é‡Œé¢è¯»æ•°æ®ï¼Œè¯»çš„çº¿ç¨‹å°±ä¼šç­‰å¾…ï¼Œç­‰å¾…æœ‰å…¶ä»–çš„çº¿ç¨‹å¾€é‡Œé¢å†™æ•°æ®çš„æ—¶å€™ï¼Œæ‰ä¼šå”¤é†’ï¼Œå¹¶ä¸”å»æ‹¿åˆ°æ•°æ®ã€‚å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œè¿˜æƒ³å¾€é˜Ÿåˆ—ä¸­å­˜æ•°æ®ï¼Œå†™çš„çº¿ç¨‹å°±ä¼šç­‰å¾…ï¼Œç­‰æœ‰äººå°†æ•°æ®æ‹¿æ‰ä¹‹åæ‰ä¼šå†™è¿›å»ã€‚</p><p>æ‰€ä»¥ä¼šå¼•èµ·çº¿ç¨‹çš„é˜»å¡ã€‚</p><h3 id="ArrayBlockingQueueæºç "><a href="#ArrayBlockingQueueæºç " class="headerlink" title="ArrayBlockingQueueæºç "></a>ArrayBlockingQueueæºç </h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Main lock guarding all access */</span></span><br><span class="line">    final ReentrantLock lock;<span class="comment">//ä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="comment">/** Condition for waiting takes */</span></span><br><span class="line">    private final Condition notEmpty;<span class="comment">//æç¤ºè¯»æ“ä½œä¸ä¸ºç©º</span></span><br><span class="line">    <span class="comment">/** Condition for waiting puts */</span></span><br><span class="line">    private final Condition notFull;<span class="comment">//æç¤ºå†™æ“ä½œä¸ä¸ºæ»¡</span></span><br><span class="line"></span><br><span class="line"> public <span class="keyword">void</span> put(E e) throws InterruptedException &#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        final ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        <span class="comment">//putæ“ä½œç›´æ¥åŠ é”ï¼Œæ‰€ä»¥æ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ã€‚</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == items.length)</span><br><span class="line">            <span class="comment">//å¦‚æœæ˜¯æ»¡çš„ä¼šè¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°ä¸‹é¢çš„takeæ“ä½œ</span></span><br><span class="line">                notFull.await();</span><br><span class="line">            insert(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">public E take() throws InterruptedException &#123;</span><br><span class="line">        final ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//è¿™é‡Œæ˜¯ä¸ºäº†è¯»æ“ä½œ</span></span><br><span class="line">                notEmpty.await();</span><br><span class="line">                <span class="comment">//å»æ‰å†™æ“ä½œçš„é”ï¼Œå…·ä½“ä»£ç å¾€ä¸‹çœ‹</span></span><br><span class="line">            <span class="keyword">return</span> extract();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> private E extract() &#123;</span><br><span class="line">        final <span class="built_in">Object</span>[] items = <span class="keyword">this</span>.items;</span><br><span class="line">        E x = <span class="keyword">this</span>.&lt;E&gt;cast(items[takeIndex]);</span><br><span class="line">        items[takeIndex] = <span class="literal">null</span>;</span><br><span class="line">        takeIndex = inc(takeIndex);</span><br><span class="line">        --count;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œè®²é”æ‰“å¼€</span></span><br><span class="line">        notFull.signal();</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-4-ConcurrentLinkedQueue"><a href="#2-4-ConcurrentLinkedQueue" class="headerlink" title="2.4. ConcurrentLinkedQueue"></a>2.4. ConcurrentLinkedQueue</h2><p>é«˜æ€§èƒ½çš„é“¾è¡¨é˜Ÿåˆ—ï¼Œå¤„ç†ç±»ä¼¼äºconcurrentHashMapï¼Œå†…éƒ¨ä½¿ç”¨å¤§é‡çš„æ— é”çš„ç®—æ³•ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;1-å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#1-å„ç§åŒæ­¥æ§åˆ¶å·¥å…·çš„ä½¿ç”¨&quot; class=&quot;headerlink
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆå››ï¼‰ï¼šæ— é”</title>
    <link href="http://mmmmmm.me/2019-01-31-2.html"/>
    <id>http://mmmmmm.me/2019-01-31-2.html</id>
    <published>2019-01-18T11:20:03.000Z</published>
    <updated>2019-01-30T23:37:42.131Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="1-æ— é”ç±»çš„åŸç†è¯¦è§£"><a href="#1-æ— é”ç±»çš„åŸç†è¯¦è§£" class="headerlink" title="1. æ— é”ç±»çš„åŸç†è¯¦è§£"></a>1. æ— é”ç±»çš„åŸç†è¯¦è§£</h1><h2 id="ç®€ä»‹ï¼š"><a href="#ç®€ä»‹ï¼š" class="headerlink" title="ç®€ä»‹ï¼š"></a>ç®€ä»‹ï¼š</h2><p>å‰é¢å·²ç»ä»‹ç»è¿‡æ— é”ï¼š<br>â€“ æ— éšœç¢<br>æ— éšœç¢æ˜¯ä¸€ç§æœ€å¼±çš„éé˜»å¡è°ƒåº¦<br>è‡ªç”±å‡ºå…¥ä¸´ç•ŒåŒº<br>æ— ç«äº‰æ—¶ï¼Œæœ‰é™æ­¥å†…å®Œæˆæ“ä½œ<br>æœ‰ç«äº‰æ—¶ï¼Œå›æ»šæ•°æ®æœ‰ç«äº‰æ—¶ï¼Œå›æ»šæ•°æ®<br>å¥½è¿›ä¸å¥½å‡ºï¼Œå¾ˆå®¹æ˜“è¿›å»ï¼Œä½†æ˜¯è¿›å»å‘ç°å¾ˆå¤šçº¿ç¨‹ç«äº‰ç›¸åŒçš„èµ„æºçš„æ—¶å€™ï¼Œä¼šéœ€è¦å›æ»šæ•°æ®ï¼Œæ¯”å¦‚è¦è¯»å–xyï¼Œå·²ç»è¯»è¿‡äº†xï¼Œè¯»åˆ°yçš„æ—¶å€™å‘ç°åœ¨ç«äº‰ï¼Œä¼šä»xé‡æ–°è¯»ã€‚</p><p>â€“ æ— é”<br>æ˜¯æ— éšœç¢çš„<br>ä¿è¯æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥èƒœå‡º<br>while (!atomicVar.compareAndSet(localVar, localVar+1)) {<br>localVar = atomicVar.get();<br>}<br>å› ä¸ºæ— éšœç¢ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸æ–­çš„ç«äº‰ï¼Œå°†ä¼šæ‰€æœ‰çš„éƒ½å‡ºä¸æ¥ï¼Œæ‰€ä»¥æ— é”å°±éœ€è¦æ¯æ¬¡ç«äº‰éƒ½èƒ½èƒœå‡ºä¸€ä¸ªï¼Œè¿™æ ·ä¿è¯ç¨‹åºèƒ½å¤Ÿé¡ºç•…çš„æ‰§è¡Œä¸‹å»ã€‚</p><h2 id="1-1-CAS"><a href="#1-1-CAS" class="headerlink" title="1.1. CAS"></a>1.1. CAS</h2><p>CASç®—æ³•çš„è¿‡ç¨‹æ˜¯è¿™æ ·:å®ƒåŒ…å«3ä¸ªå‚æ•°CAS(V,E,N)ã€‚Vè¡¨ç¤ºè¦æ›´æ–°çš„å˜é‡ï¼ŒEè¡¨ç¤ºé¢„æœŸå€¼ï¼ŒNè¡¨ç¤ºæ–°å€¼ã€‚ä»…å½“V å€¼ç­‰äºEå€¼æ—¶ï¼Œæ‰ä¼šå°†Vçš„å€¼è®¾ä¸ºNï¼Œå¦‚æœVå€¼å’ŒEå€¼ä¸åŒï¼Œåˆ™è¯´æ˜å·²ç»æœ‰å…¶ä»–çº¿ç¨‹åšäº†æ›´æ–°ï¼Œåˆ™å½“å‰çº¿ç¨‹ä»€ä¹ˆ éƒ½ä¸åšã€‚æœ€åï¼ŒCASè¿”å›å½“å‰Vçš„çœŸå®å€¼ã€‚CASæ“ä½œæ˜¯æŠ±ç€ä¹è§‚çš„æ€åº¦è¿›è¡Œçš„ï¼Œå®ƒæ€»æ˜¯è®¤ä¸ºè‡ªå·±å¯ä»¥æˆåŠŸå®Œæˆ æ“ä½œã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨CASæ“ä½œä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰ä¸€ä¸ªä¼šèƒœå‡ºï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œå…¶ä½™å‡ä¼šå¤±è´¥ã€‚å¤±è´¥çš„çº¿ç¨‹ ä¸ä¼šè¢«æŒ‚èµ·ï¼Œä»…æ˜¯è¢«å‘ŠçŸ¥å¤±è´¥ï¼Œå¹¶ä¸”å…è®¸å†æ¬¡å°è¯•ï¼Œå½“ç„¶ä¹Ÿå…è®¸å¤±è´¥çš„çº¿ç¨‹æ”¾å¼ƒæ“ä½œã€‚åŸºäºè¿™æ ·çš„åŸç†ï¼ŒCAS æ“ä½œå³æ—¶æ²¡æœ‰é”ï¼Œä¹Ÿå¯ä»¥å‘ç°å…¶ä»–çº¿ç¨‹å¯¹å½“å‰çº¿ç¨‹çš„å¹²æ‰°ï¼Œå¹¶è¿›è¡Œæ°å½“çš„å¤„ç†ã€‚</p><p>CASæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œæ˜¯ç”±ä¸€æ¡cpuæŒ‡ä»¤å®Œæˆçš„ã€‚</p><p>javaä¸­æä¾›äº†å¾ˆå¤šæ— æ‰€ç±»çš„ä½¿ç”¨ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œå°†ä¼šæ¶ˆè€—å…«ä¸‡ä¸ªæ—¶å…‰å‘¨æœŸï¼Œä½†æ˜¯å¦‚æœæ˜¯æ— é”çš„ï¼Œæœ€å¤šåªæ˜¯å¾ªç¯ï¼Œä¹Ÿå°±åªä¼šæ¶ˆè€—å‡ ä¸ªæ—¶å…‰å‘¨æœŸï¼Œæ‰€ä»¥æ— é”çš„æ–¹å¼æ¯”é˜»å¡çš„æ–¹å¼è¦å¥½å¾ˆå¤šã€‚</p><h2 id="1-2-CPUæŒ‡ä»¤"><a href="#1-2-CPUæŒ‡ä»¤" class="headerlink" title="1.2. CPUæŒ‡ä»¤"></a>1.2. CPUæŒ‡ä»¤</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmpxchg</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">accumulator = AL, AX, or EAX, depending on whether</span></span><br><span class="line"><span class="comment">a byte, word, or doubleword comparison is being performed */</span></span><br><span class="line"><span class="keyword">if</span>(accumulator == Destination) &#123;</span><br><span class="line">ZF = <span class="number">1</span>;         <span class="comment">//åˆ¤æ–­æ˜¯å¦å’ŒæœŸæœ›å€¼ç›¸ç­‰ï¼Œç›¸ç­‰çš„è¯å°±ç»™ä¸€ä¸ªè½¬æ¢æ ‡å¿—ã€‚åŒæ—¶è¿›è¡Œè½¬æ¢ã€‚</span></span><br><span class="line">Destination = Source; &#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">ZF = <span class="number">0</span>;         <span class="comment">//ä¸ç›¸ç­‰çš„è¯å°±ç»™ä¸€ä¸ªä¸è½¬æ¢çš„æ ‡å¿—ã€‚åŒæ—¶ä¸è½¬æ¢ã€‚</span></span><br><span class="line">accumulator = Destination; &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªåŸå­æ“ä½œæ˜¯å®‰å…¨çš„ã€‚</p><h1 id="2-æ— é”ç±»çš„ä½¿ç”¨"><a href="#2-æ— é”ç±»çš„ä½¿ç”¨" class="headerlink" title="2. æ— é”ç±»çš„ä½¿ç”¨"></a>2. æ— é”ç±»çš„ä½¿ç”¨</h1><h2 id="2-1-AtomicInteger"><a href="#2-1-AtomicInteger" class="headerlink" title="2.1. AtomicInteger"></a>2.1. AtomicInteger</h2><h3 id="2-1-1-æ¦‚è¿°"><a href="#2-1-1-æ¦‚è¿°" class="headerlink" title="2.1.1. æ¦‚è¿°"></a>2.1.1. æ¦‚è¿°</h3><p>Number</p><h3 id="2-1-2-ä¸»è¦æ¥å£"><a href="#2-1-2-ä¸»è¦æ¥å£" class="headerlink" title="2.1.2. ä¸»è¦æ¥å£"></a>2.1.2. ä¸»è¦æ¥å£</h3><p>public final int get()//å–å¾—å½“å‰å€¼<br>public final void set(int newValue)//è®¾ç½®å½“å‰å€¼<br>public final int getAndSet(int newValue)//è®¾ç½®æ–°å€¼ï¼Œå¹¶è¿”å›æ—§å€¼<br>public final boolean compareAndSet(int expect, int u)//å¦‚æœå½“å‰å€¼ä¸ºexpectï¼Œåˆ™è®¾ç½®ä¸ºu<br>public final int getAndIncrement() //å½“å‰å€¼åŠ 1ï¼Œè¿”å›æ—§å€¼<br>public final int getAndDecrement()//å½“å‰å€¼å‡1ï¼Œè¿”å›æ—§å€¼<br>public final int getAndAdd(int delta)//å½“å‰å€¼å¢åŠ deltaï¼Œè¿”å›æ—§å€¼<br>public final int incrementAndGet() //å½“å‰å€¼åŠ 1ï¼Œè¿”å›æ–°å€¼<br>public final int decrementAndGet() //å½“å‰å€¼å‡1ï¼Œè¿”å›æ–°å€¼<br>public final int addAndGet(int delta)//å½“å‰å€¼å¢åŠ deltaï¼Œè¿”å›æ–°å€¼</p><h3 id="2-1-3-ä¸»è¦æ¥å£çš„å®ç°"><a href="#2-1-3-ä¸»è¦æ¥å£çš„å®ç°" class="headerlink" title="2.1.3. ä¸»è¦æ¥å£çš„å®ç°"></a>2.1.3. ä¸»è¦æ¥å£çš„å®ç°</h3><p>compareAndSetæ–¹æ³•<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//expectæœŸæœ›å€¼ï¼Œupdateæ›´æ–°çš„æ–°å€¼ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</span></span><br><span class="line">  public final boolean compareAndSet(int expect, int update) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//unsafeæ˜¯ä¸å®‰å…¨çš„ï¼Œjavaå°†æŒ‡é’ˆè¿›è¡Œäº†å±è”½å°è£…ï¼Œè€Œunsafeä¼šæä¾›ç±»ä¼¼æŒ‡é’ˆçš„æ“ä½œï¼Œå¯¹è¿™ä¸ªç±»çš„åç§»é‡ä¸Šçš„æœŸæœ›å€¼</span></span><br></pre></td></tr></table></figure><p></p><p>åç§»é‡valueOffsetå“ªé‡Œæ¥çš„ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valueOffset = unsafe.objectFieldOffset</span><br></pre></td></tr></table></figure><p>getAndIncrementæ–¹æ³•<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›å½“å‰å€¼ï¼Œå¹¶ä¸”åŠ ä¸€</span></span><br><span class="line">    public final int getAndIncrement() &#123;</span><br><span class="line">        <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        int current = get();</span><br><span class="line">        int next = current + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(compareAndSet(current,next))</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>getæ˜¯å¾—åˆ°å½“å‰è¿™ä¸ªç±»çš„private volatile int value;è¿™ä¸ªå€¼åŠ ä¸€ï¼Œç„¶åcompareAndSetï¼Œå¦‚æœå½“å‰çš„å€¼å’ŒæœŸæœ›å€¼ç›¸ç­‰çš„æ—¶å€™è¿”å›å½“å‰çš„è¿™ä¸ªå€¼ï¼Œå¦åˆ™ï¼Œç»§ç»­å¾ªç¯ï¼Œå’Œæ— é”çš„æœºåˆ¶æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœåœ¨åˆ¤æ–­ä¹‹å‰æœ‰å…¶ä»–çš„çº¿ç¨‹æ‹¿åˆ°äº†currentå€¼ï¼Œåœ¨ä¸‹é¢çš„ifå°†ä¼šå¤±è´¥</p><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"><span class="keyword">static</span> AtomicInteger i = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="title">implements</span>  <span class="title">Runnable</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">for</span> (int j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">i.incrementAndGet();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread[] ts = <span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span> (int k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123;</span><br><span class="line">ts[k] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AddThread());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (int k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123;</span><br><span class="line">ts[k].start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (int k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123;</span><br><span class="line">ts[k].join();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100000</span></span><br></pre></td></tr></table></figure><h2 id="2-2-Unsafe"><a href="#2-2-Unsafe" class="headerlink" title="2.2. Unsafe"></a>2.2. Unsafe</h2><h3 id="2-2-1-æ¦‚è¿°"><a href="#2-2-1-æ¦‚è¿°" class="headerlink" title="2.2.1. æ¦‚è¿°"></a>2.2.1. æ¦‚è¿°</h3><p>éå®‰å…¨çš„æ“ä½œï¼Œæ¯”å¦‚: æ ¹æ®åç§»é‡è®¾ç½®å€¼ ã€park() ã€åº•å±‚çš„CASæ“ä½œ<br>éå…¬å¼€APIï¼Œåœ¨ä¸åŒç‰ˆæœ¬çš„JDKä¸­ï¼Œ å¯èƒ½æœ‰è¾ƒå¤§å·®å¼‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ex); &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°valueè¿™ä¸ªå­—æ®µåœ¨æœ¬ç±»ï¼ˆç›¸å½“äºcä¸­çš„é¦–åœ°å€ï¼‰ä¸­çš„åç§»é‡æ˜¯å¤šå°‘ã€‚</p><h3 id="2-2-2-ä¸»è¦æ¥å£"><a href="#2-2-2-ä¸»è¦æ¥å£" class="headerlink" title="2.2.2. ä¸»è¦æ¥å£"></a>2.2.2. ä¸»è¦æ¥å£</h3><p>//è·å¾—ç»™å®šå¯¹è±¡åç§»é‡ä¸Šçš„intå€¼<br>public native int getInt(Object o, long offset); //è®¾ç½®ç»™å®šå¯¹è±¡åç§»é‡ä¸Šçš„intå€¼<br>public native void putInt(Object o, long offset, int x); //è·å¾—å­—æ®µåœ¨å¯¹è±¡ä¸­çš„åç§»é‡<br>public native long objectFieldOffset(Field f); //è®¾ç½®ç»™å®šå¯¹è±¡çš„intå€¼ï¼Œä½¿ç”¨volatileè¯­ä¹‰<br>public native void putIntVolatile(Object o, long offset, int x); //è·å¾—ç»™å®šå¯¹è±¡å¯¹è±¡çš„intå€¼ï¼Œä½¿ç”¨volatileè¯­ä¹‰<br>public native int getIntVolatile(Object o, long offset); //å’ŒputIntVolatile()ä¸€æ ·ï¼Œä½†æ˜¯å®ƒè¦æ±‚è¢«æ“ä½œå­—æ®µå°±æ˜¯volatileç±»å‹çš„ public native void putOrderedInt(Object o, long offset, int x);</p><h2 id="2-3-AtomicReference"><a href="#2-3-AtomicReference" class="headerlink" title="2.3. AtomicReference"></a>2.3. AtomicReference</h2><h3 id="2-3-1-æ¦‚è¿°"><a href="#2-3-1-æ¦‚è¿°" class="headerlink" title="2.3.1. æ¦‚è¿°"></a>2.3.1. æ¦‚è¿°</h3><p>å¯¹è±¡çš„å¼•ç”¨<br>å¯¹å¼•ç”¨è¿›è¡Œä¿®æ”¹ æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼ŒæŠ½è±¡åŒ–äº†æ•°æ®ç±»å‹</p><h3 id="2-3-2-ä¸»è¦æ¥å£"><a href="#2-3-2-ä¸»è¦æ¥å£" class="headerlink" title="2.3.2. ä¸»è¦æ¥å£"></a>2.3.2. ä¸»è¦æ¥å£</h3><p>get()<br>set(V) compareAndSet() getAndSet(V)<br>å¤§éƒ¨åˆ†çš„æ–¹æ³•å’ŒcompareAndSetå·®ä¸å¤šã€‚<br>ä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">public final <span class="keyword">static</span> AtomicReference&lt;<span class="built_in">String</span>&gt; atomicStr = <span class="keyword">new</span> AtomicReference&lt;<span class="built_in">String</span>&gt;(<span class="string">"abc"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">final int num = i;</span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="built_in">Math</span>.abs((int)<span class="built_in">Math</span>.random()*<span class="number">100</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (atomicStr.compareAndSet((<span class="string">"abc"</span>), <span class="string">"def"</span>)) &#123;</span><br><span class="line">System.out.println(<span class="string">"Thread"</span>+Thread.currentThread().getId()+<span class="string">"change value to"</span>+atomicStr.compareAndSet((<span class="string">"abc"</span>), <span class="string">"def"</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">System.out.println(<span class="string">"Thread"</span>+Thread.currentThread().getId()+<span class="string">"FALED"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread10change value tofalse</span><br><span class="line">Thread1FALED</span><br><span class="line">Thread2FALED</span><br><span class="line">Thread3FALED</span><br><span class="line">Thread4FALED</span><br><span class="line">Thread5FALED</span><br><span class="line">Thread6FALED</span><br><span class="line">Thread7FALED</span><br><span class="line">Thread8FALED</span><br><span class="line">Thread9FALED</span><br></pre></td></tr></table></figure><h2 id="2-4-AtomicStampedReference"><a href="#2-4-AtomicStampedReference" class="headerlink" title="2.4. AtomicStampedReference"></a>2.4. AtomicStampedReference</h2><p>å’Œå¯¹è±¡çš„å¼•ç”¨å·®ä¸å¤š<br>stampedè¡¨ç¤ºæ—¶é—´æˆ³ã€å”¯ä¸€æ€§ç­‰</p><h3 id="2-4-1-æ¦‚è¿°"><a href="#2-4-1-æ¦‚è¿°" class="headerlink" title="2.4.1. æ¦‚è¿°"></a>2.4.1. æ¦‚è¿°</h3><p>ABAé—®é¢˜</p><p><img alt="" data-original="/images/15488913529012.png"></p><p>å¦‚å›¾ï¼Œä¸€ä¸ªå€¼ä¸ºAï¼ŒæœŸåˆä¸€ä¸ªçº¿ç¨‹1æ‹¿åˆ°å®ƒï¼Œç„¶ååšç›¸å…³çš„æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹2æ‹¿åˆ°è¿™ä¸ªAå¹¶ä¸”æ”¹ä¸ºäº†Bï¼Œçº¿ç¨‹3æ‹¿åˆ°äº†Bæ”¹ä¸ºäº†Aï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹1å°†æ‹¿åˆ°çš„Aå’Œè®²è¿‡äº†çº¿ç¨‹2 çº¿ç¨‹3åçš„Aè¿›è¡Œæ¯”è¾ƒï¼Œç›¸åŒçš„è¯Aå°±æ”¹ä¸ºCã€‚<br>å‘ç°æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºAè¿˜æ˜¯å˜ä¸ºäº†Aï¼Œå¦‚æœæ˜¯åŠ æ³•ï¼Œæ²¡é—®é¢˜ï¼Œå¯æ˜¯å¦‚æœæ¯”è¾ƒå…³æ³¨ä¸­é—´çš„è¿‡ç¨‹å‘¢ï¼Ÿæ¯”å¦‚ç½‘å§å……é’±ï¼Œæ²¡é’±æœºå™¨å°±è‡ªåŠ¨å†²ï¼Œå¯æ˜¯åªèƒ½è‡ªåŠ¨å……å€¼ä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬äºŒæ¬¡è¿˜æ˜¯åˆ°äº†ä¸´ç•Œç‚¹å‘¢ï¼Ÿï¼Ÿ<br>è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç»™ä¸€ä¸ªæ—¶é—´æˆ³æˆ–è€…å”¯ä¸€çš„æ ‡è¯†ã€‚æ¯æ¬¡æ”¹å˜çš„æ—¶å€™éƒ½ä¼ é€’ä¸€ä¸ªåŒ…å«Aå’Œæ—¶é—´æˆ³çš„å¯¹è±¡ï¼Œæ¯æ¬¡åœ¨æ¯”ä»·Açš„åŒæ—¶æ¯”è¾ƒæ—¶é—´æˆ³ã€‚<br>æºç è§£æï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†åŸæ¥çš„valueåšäº†ä¸€å±‚å°è£…åˆ†ä¸ºäº†referenceå’Œstamp</span></span><br><span class="line">private <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        final T reference;</span><br><span class="line">        final int stamp;</span><br><span class="line">        private Pair(T reference, int stamp) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reference = reference;</span><br><span class="line">            <span class="keyword">this</span>.stamp = stamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> &lt;T&gt; Pair&lt;T&gt; <span class="keyword">of</span>(T reference, int stamp) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Pair&lt;T&gt;(reference, stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//compareAndSetçš„å‚æ•°ä¹Ÿç”±åŸæ¥çš„ä¸¤ä¸ªï¼Œå˜ä¸ºäº†å››ä¸ªï¼ŒåŒ…æ‹¬æœŸæœ›å€¼å’Œæ–°çš„å€¼</span></span><br><span class="line">public boolean compareAndSet(V   expectedReference,</span><br><span class="line">                                 V   newReference,</span><br><span class="line">                                 int expectedStamp,</span><br><span class="line">                                 int newStamp) &#123;</span><br><span class="line">        Pair&lt;V&gt; current = pair;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        <span class="comment">//å½“ä¸¤ä¸ªéƒ½ç›¸ç­‰çš„æ—¶å€™æ‰æœ‰æœºä¼šå‘ä¸‹æ‰§è¡Œ</span></span><br><span class="line">            expectedReference == current.reference &amp;&amp;</span><br><span class="line">            expectedStamp == current.stamp &amp;&amp;</span><br><span class="line">            ((newReference == current.reference &amp;&amp;</span><br><span class="line">              newStamp == current.stamp) ||</span><br><span class="line">             casPair(current, Pair.of(newReference, newStamp)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//jdkä¸­ç»å¸¸ä¼šæœ‰å‡½æ•°å«åšcas...æ¥æ›´æ–°åˆ—è¡¨çš„å¤´éƒ¨ã€å°¾éƒ¨ç­‰æ“ä½œ</span></span><br><span class="line"><span class="comment">//pairOffsetå°±æ˜¯</span></span><br><span class="line">private boolean casPair(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, pairOffset, cmp, val);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-AtomicIntegerArray"><a href="#2-5-AtomicIntegerArray" class="headerlink" title="2.5. AtomicIntegerArray"></a>2.5. AtomicIntegerArray</h2><h3 id="2-5-1-æ¦‚è¿°"><a href="#2-5-1-æ¦‚è¿°" class="headerlink" title="2.5.1. æ¦‚è¿°"></a>2.5.1. æ¦‚è¿°</h3><p>æ”¯æŒæ— é”çš„æ•°ç»„</p><h3 id="2-5-2-ä¸»è¦æ¥å£"><a href="#2-5-2-ä¸»è¦æ¥å£" class="headerlink" title="2.5.2. ä¸»è¦æ¥å£"></a>2.5.2. ä¸»è¦æ¥å£</h3><p>//è·å¾—æ•°ç»„ç¬¬iä¸ªä¸‹æ ‡çš„å…ƒç´ <br>public final int get(int i)<br>//è·å¾—æ•°ç»„çš„é•¿åº¦<br>public final int length()<br>//å°†æ•°ç»„ç¬¬iä¸ªä¸‹æ ‡è®¾ç½®ä¸ºnewValueï¼Œå¹¶è¿”å›æ—§çš„å€¼<br>public final int getAndSet(int i, int newValue) //è¿›è¡ŒCASæ“ä½œï¼Œå¦‚æœç¬¬iä¸ªä¸‹æ ‡çš„å…ƒç´ ç­‰äºexpectï¼Œåˆ™è®¾ç½®ä¸ºupdateï¼Œè®¾ç½®æˆåŠŸè¿”å›true public final boolean compareAndSet(int i, int expect, int update)<br>//å°†ç¬¬iä¸ªä¸‹æ ‡çš„å…ƒç´ åŠ 1<br>public final int getAndIncrement(int i) //å°†ç¬¬iä¸ªä¸‹æ ‡çš„å…ƒç´ å‡1<br>public final int getAndDecrement(int i) //å°†ç¬¬iä¸ªä¸‹æ ‡çš„å…ƒç´ å¢åŠ delta(deltaå¯ä»¥æ˜¯è´Ÿæ•°) public final int getAndAdd(int i, int delta)</p><h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"><span class="keyword">static</span> AtomicIntegerArray arr = <span class="keyword">new</span> AtomicIntegerArray(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">arr.getAndIncrement(i % arr.length());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread[] ts = <span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">ts[i] = <span class="keyword">new</span> Thread((<span class="keyword">new</span> AddThread()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">ts[i].start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">ts[i].join();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">System.out.println(arr);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ä¸å®‰å…¨çš„è¯ï¼Œä¸ä¼šæ¯ä¸ªéƒ½æ˜¯1000ï¼Œåº”è¯¥æ¯”è¿™ä¸ªå°ã€‚<br>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>,<span class="number">10000</span>]</span><br></pre></td></tr></table></figure><h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">static</span> final int base = unsafe.arrayBaseOffset(int[].class);</span><br><span class="line"></span><br><span class="line">public final int get(int i) &#123;</span><br><span class="line">        <span class="keyword">return</span> getRaw(checkedByteOffset(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">private int getRaw(long offset) &#123;</span><br><span class="line"><span class="comment">//æ•°ç»„æ‰€åœ¨çš„åŸºåœ°å€å¼€å§‹å–offsetçš„åç§»é‡</span></span><br><span class="line">        <span class="keyword">return</span> unsafe.getIntVolatile(array, offset);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿”å›ç¬¬iä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­çš„åç§»é‡æ˜¯å¤šå°‘</span></span><br><span class="line">private long checkedByteOffset(int i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= array.length)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"index "</span> + i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteOffset(i);</span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">static</span> long byteOffset(int i) &#123;</span><br><span class="line"><span class="comment">//iåç§»äº†shiftçš„æ•°å€¼</span></span><br><span class="line">        <span class="keyword">return</span> ((long) i &lt;&lt; shift) + base;</span><br><span class="line">        <span class="comment">//é€šè¿‡ä¸‹é¢çš„è®¡ç®— iå·¦ç§»ä¸¤ä½ï¼ˆäºŒè¿›åˆ¶ï¼Œå³åœ¨æœ«å°¾åŠ ä¸¤ä¸ªé›¶</span></span><br><span class="line">        <span class="comment">//ï¼Œå¦‚æœæ˜¯åè¿›åˆ¶å°±æ˜¯ä¹˜ä»¥4ï¼‰</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æœ‰å¤šå®½ï¼Œintå°±æ˜¯4ï¼ˆæ¯ä¸ªintæ˜¯4ä¸ªbyteï¼‰</span></span><br><span class="line">        int scale = unsafe.arrayIndexScale(int[].class);</span><br><span class="line">        <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">            <span class="comment">//shiftçš„å€¼</span></span><br><span class="line">            <span class="comment">//numberOfLeadingZeroså‰å¯¼é›¶ï¼Œä¸€ä¸ªæ•°å­—åŒ–æˆäºŒè¿›åˆ¶</span></span><br><span class="line">            <span class="comment">//å‰é¢çš„é›¶çš„ä¸ªæ•°</span></span><br><span class="line">            <span class="comment">//4------&gt;   00000....100       32-3=29</span></span><br><span class="line">            <span class="comment">//4çš„å‰å¯¼é›¶å°±æ˜¯29</span></span><br><span class="line">        shift = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        <span class="comment">//æ‰€ä»¥shift=2</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-AtomicIntegerFieldUpdater"><a href="#2-6-AtomicIntegerFieldUpdater" class="headerlink" title="2.6. AtomicIntegerFieldUpdater"></a>2.6. AtomicIntegerFieldUpdater</h2><h3 id="2-6-1-æ¦‚è¿°"><a href="#2-6-1-æ¦‚è¿°" class="headerlink" title="2.6.1. æ¦‚è¿°"></a>2.6.1. æ¦‚è¿°</h3><p>è®©æ™®é€šå˜é‡ä¹Ÿäº«å—åŸå­æ“ä½œ<br>å¸Œæœ›æ‹¥æœ‰åŸå­æ“ä½œï¼Œä½†æ˜¯ä¸æ”¹å˜åŸåŸå­çš„ç±»å‹ã€‚<br>ä½¿ç”¨å°½é‡å°‘çš„ä»£ç ã€åœ¨ä¸æ”¹å˜åŸæ¥ç±»å‹çš„åŸºç¡€ä¸Šã€åšå‡ºè¾ƒå°‘çš„æ”¹å˜æ¥å®ç°åŸå­æ“ä½œã€‚</p><h3 id="2-6-2-ä¸»è¦æ¥å£-AtomicIntegerFieldUpdater-newUpdater"><a href="#2-6-2-ä¸»è¦æ¥å£-AtomicIntegerFieldUpdater-newUpdater" class="headerlink" title="2.6.2. ä¸»è¦æ¥å£ AtomicIntegerFieldUpdater.newUpdater()"></a>2.6.2. ä¸»è¦æ¥å£ AtomicIntegerFieldUpdater.newUpdater()</h3><p>AtomicIntegerFieldUpdate.newUpdate()<br>incrementAndGet()</p><h3 id="ä¾‹å­-2"><a href="#ä¾‹å­-2" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Candidate</span></span>&#123;</span><br><span class="line">int id;</span><br><span class="line">volatile  int score;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public final <span class="keyword">static</span> AtomicIntegerFieldUpdater&lt;Candidate&gt; scoreUpdater =</span><br><span class="line">AtomicIntegerFieldUpdater.newUpdater(Candidate.class, <span class="string">"score"</span>);</span><br><span class="line">public <span class="keyword">static</span> AtomicInteger allScore = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">final Candidate stu  = <span class="keyword">new</span> Candidate();</span><br><span class="line">Thread[] threads = <span class="keyword">new</span> Thread[<span class="number">10000</span>];</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">10000</span> ; i++) &#123;</span><br><span class="line">threads[i] = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Math</span>.random()&gt;<span class="number">0.4</span>)&#123;</span><br><span class="line">scoreUpdater.incrementAndGet(stu);</span><br><span class="line">allScore.incrementAndGet();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">threads[i].start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt;<span class="number">10000</span> ; i++) &#123;</span><br><span class="line">threads[i].join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"sore="</span>+stu.score);</span><br><span class="line">System.out.println(<span class="string">"allScore="</span>+allScore);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡AtomicIntegeræ¥éªŒè¯ï¼Œå‘ç°æ˜¯ç›¸åŒçš„å®‰å…¨çš„ç»“æœï¼Œä¸»è¦å°±æ˜¯ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œé€šè¿‡åå°„å®ç°çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sore=<span class="number">5948</span></span><br><span class="line">allScore=<span class="number">5948</span></span><br></pre></td></tr></table></figure><h3 id="2-6-3-å°è¯´æ˜"><a href="#2-6-3-å°è¯´æ˜" class="headerlink" title="2.6.3. å°è¯´æ˜"></a>2.6.3. å°è¯´æ˜</h3><ol><li>Updateråªèƒ½ä¿®æ”¹å®ƒå¯è§èŒƒå›´å†…çš„å˜é‡ã€‚å› ä¸ºUpdaterä½¿ç”¨åå°„å¾—åˆ°è¿™ä¸ªå˜é‡ã€‚å¦‚æœå˜é‡ä¸å¯è§ï¼Œå°±ä¼šå‡ºé”™ã€‚<br>æ¯”å¦‚å¦‚æœscoreç”³æ˜ä¸ºprivateï¼Œå°±æ˜¯ä¸å¯è¡Œçš„ã€‚</li><li>ä¸ºäº†ç¡®ä¿å˜é‡è¢«æ­£ç¡®çš„è¯»å–ï¼Œå®ƒå¿…é¡»æ˜¯volatileç±»å‹çš„ã€‚å¦‚æœæˆ‘ä»¬åŸæœ‰ä»£ç ä¸­æœªç”³æ˜è¿™ä¸ªç±»å‹ï¼Œé‚£ä¹ˆç®€å•å¾— ç”³æ˜ä¸€ä¸‹å°±è¡Œï¼Œè¿™ä¸ä¼šå¼•èµ·ä»€ä¹ˆé—®é¢˜ã€‚</li><li>ç”±äºCASæ“ä½œä¼šé€šè¿‡å¯¹è±¡å®ä¾‹ä¸­çš„åç§»é‡ç›´æ¥è¿›è¡Œèµ‹å€¼ï¼Œå› æ­¤ï¼Œå®ƒä¸æ”¯æŒstaticå­—æ®µ(Unsafe. objectFieldOffset()ä¸æ”¯æŒé™æ€å˜é‡)ã€‚<h1 id="3-æ— é”ç®—æ³•è¯¦è§£"><a href="#3-æ— é”ç®—æ³•è¯¦è§£" class="headerlink" title="3. æ— é”ç®—æ³•è¯¦è§£"></a>3. æ— é”ç®—æ³•è¯¦è§£</h1></li></ol><p>jdkä¸­çš„vectoræ˜¯æœ‰é”çš„ã€‚<br>æºç è§£æï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appends the specified element to the end of this Vector.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param e element to be appended to this Vector</span></span><br><span class="line"><span class="comment">     * @return &#123;@code true&#125; (as specified by &#123;@link Collection#add&#125;)</span></span><br><span class="line"><span class="comment">     * @since 1.2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public synchronized boolean add(E e) &#123;</span><br><span class="line">    <span class="comment">//è®°å½•vectorè¢«ä¿®æ”¹çš„æ¬¡æ•°</span></span><br><span class="line">        modCount++;</span><br><span class="line">       <span class="comment">// vectoråº•å±‚æ˜¯æ•°ç»„</span></span><br><span class="line">       <span class="comment">// åˆ¤æ–­æ—¶å€™è¶Šç•Œï¼Œå¦‚æœè¶Šç•Œäº†å°±è¿›è¡Œæ‰©å±•ï¼Œæ‰©å±•ä»£ç åœ¨ä¸‹é¢</span></span><br><span class="line">        ensureCapacityHelper(elementCount + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//ä¸è¶Šç•Œå°±å°†eåŠ åœ¨åé¢</span></span><br><span class="line">        elementData[elementCount++] = e;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ–¹æ³•ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›è¡Œaddæ“ä½œï¼Œæ‰€æœ‰çš„å…ƒç´ éƒ½ä¿å­˜åœ¨elementData</span></span><br><span class="line">    ä¸­</span><br><span class="line">    private <span class="keyword">void</span> ensureCapacityHelper(int minCapacity) &#123;</span><br><span class="line">        <span class="comment">// overflow-conscious code</span></span><br><span class="line">        <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">            grow(minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">private <span class="keyword">void</span> grow(int minCapacity) &#123;</span><br><span class="line">        <span class="comment">// overflow-conscious code</span></span><br><span class="line">        int oldCapacity = elementData.length;</span><br><span class="line">        <span class="comment">//æ‰©å±•å¢é‡ï¼ˆæ‰©å®¹ï¼‰capacityIncrementå¯ä»¥è‡ªå·±åˆ¶å®šï¼Œå¦‚æœè‡ªå·±ä¸æŒ‡å®šçš„è¯å°±</span></span><br><span class="line">        <span class="comment">//æ˜¯é»˜è®¤çš„oldCapacity+oldCapacity------&gt;newCapacityä¹Ÿå°±æ˜¯</span></span><br><span class="line">        <span class="comment">//ä¹˜ä»¥äºŒ</span></span><br><span class="line">        int newCapacity = oldCapacity + ((capacityIncrement &gt; <span class="number">0</span>) ?</span><br><span class="line">                                         capacityIncrement : oldCapacity);</span><br><span class="line">        <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            newCapacity = minCapacity;</span><br><span class="line">        <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">            newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">            <span class="comment">//æŠŠè€å…ƒç´ æ”¾åˆ°æ–°çš„å…ƒç´ ä¸­å»</span></span><br><span class="line">        elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒæŠŠåŸæ¥çš„æ•°ç»„å¤åˆ¶è¿‡å»ã€‚</span></span><br><span class="line"> public <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType) &#123;</span><br><span class="line">        @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">        T[] copy = ((<span class="built_in">Object</span>)newType == (<span class="built_in">Object</span>)<span class="built_in">Object</span>[].class)</span><br><span class="line">            ? (T[]) <span class="keyword">new</span> <span class="built_in">Object</span>[newLength]</span><br><span class="line">            : (T[]) <span class="built_in">Array</span>.newInstance(newType.getComponentType(), newLength);</span><br><span class="line">        System.arraycopy(original, <span class="number">0</span>, copy, <span class="number">0</span>,</span><br><span class="line">                         <span class="built_in">Math</span>.min(original.length, newLength));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹é‡Œé¢çš„æ³¨é‡Šå¾ˆé‡è¦ï¼š<br>æå–å‡ºæ¥å‡ ä¸ª<br><strong><font color="red">vectoråº•å±‚æ˜¯æ•°ç»„<br>åˆ¤æ–­æ—¶å€™è¶Šç•Œï¼Œå¦‚æœè¶Šç•Œäº†å°±è¿›è¡Œæ‰©å±•ï¼Œ<br>addæ˜¯ä¸€ä¸ªåŒæ­¥çš„æ–¹æ³•ï¼ˆæœ‰é”çš„ï¼‰ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›è¡Œaddæ“ä½œ<br>æ‰©å±•å¢é‡ï¼ˆæ‰©å®¹ï¼‰capacityIncrementå¯ä»¥è‡ªå·±åˆ¶å®šï¼Œå¦‚æœè‡ªå·±ä¸æŒ‡å®šçš„è¯å°±<br>æ˜¯é»˜è®¤çš„oldCapacity+oldCapacityâ€”â€”&gt;newCapacityä¹Ÿå°±æ˜¯<br>ä¹˜ä»¥äºŒï¼ˆæœ‰æ¬¡é¢è¯•æˆ‘è¢«é—®è¿‡ï¼‰!!!!!!!!!!!!æ‰€ä»¥å½“æ‰©å®¹çš„æ•°å­—å¾ˆå¤§çš„æ—¶å€™ï¼Œå»ºè®®ç»™ä¸ªæ‰©å®¹çš„å¤§å°<br>æŠŠè€å…ƒç´ æ”¾åˆ°æ–°çš„å…ƒç´ ä¸­å»<br>åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒæŠŠåŸæ¥çš„æ•°ç»„å¤åˆ¶è¿‡å»ã€‚</font></strong></p><h2 id="3-1-æ— é”çš„Vectorå®ç°"><a href="#3-1-æ— é”çš„Vectorå®ç°" class="headerlink" title="3.1. æ— é”çš„Vectorå®ç°"></a>3.1. æ— é”çš„Vectorå®ç°</h2><p>è¿™é‡Œåªå°†æºç è´´å‡ºæ¥<br>å’Œæ™®é€šçš„vectorå®ç°çš„åŒºåˆ«æ˜¯åŸæ¥çš„vectoræ˜¯ä¸€ç»´æ•°ç»„ï¼Œè€Œè¿™é‡Œçš„æ•°ç»„æ˜¯äºŒç»´çš„æ•°ç»„ï¼Œä¸ºä»€ä¹ˆç”¨äºŒç»´æ•°ç»„ï¼ŸäºŒç»´æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå®¹é‡æ˜¯nï¼Œç¬¬äºŒä¸ªå°±æ˜¯2nï¼Œç¬¬ä¸‰ä¸ªå°±æ˜¯4nã€‚ã€‚ã€‚ã€‚ä»¥æ­¤ç±»æ¨ï¼Œå°±åƒæ˜¯ä¸€ä¸ªä¸ªä¸åŒå®¹é‡çš„ç¯®å­ã€‚<br>FIRST_BUCKET_SIZEç»™å®šç¬¬ä¸€ä¸ªç¯®å­çš„å¤§å°<br>N_BUCKETæœ‰å¤šå°‘ä¸ªç¯®å­<br>private final AtomicReferenceArray&lt;AtomicReferenceArray<e>&gt; buckets;<br>é€šè¿‡AtomicReferenceArrayçš„äºŒé‡æ•°ç»„æ¥å°è£…è¿™äº›ç¯®å­ã€‚AtomicReferenceArrayå’ŒAtomicArrayå·®ä¸å¤šåªæ˜¯å°†arrayçš„å€¼æ¢æˆäº†å¯¹è±¡ã€‚</e></p><p><strong><font color="red">æœ‰ä¸ªåˆ†æçš„å¾ˆä¸é”™çš„åšæ–‡ï¼š</font></strong><br><a href="http://reimuwang.org/2018/05/17/Java%20%E5%B9%B6%E5%8F%91-%E6%97%A0%E9%94%81%E7%9A%84Vector%E5%AE%9E%E7%8E%B0/" target="_blank" rel="noopener">http://reimuwang.org/2018/05/17/Java%20%E5%B9%B6%E5%8F%91-%E6%97%A0%E9%94%81%E7%9A%84Vector%E5%AE%9E%E7%8E%B0/</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2007 IBM Corporation</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">package main.java.org.amino.ds.lockfree;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.AbstractList;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReferenceArray;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * It is a thread safe and lock-free vector.</span></span><br><span class="line"><span class="comment"> * This class implement algorithm from:&lt;br&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Lock-free Dynamically Resizable Arrays &lt;br&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Damian Dechev, Peter Pirkelbauer, and Bjarne Stroustrup&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * Texas A&amp;M University College Station, TX 77843-3112&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * &#123;dechev, peter.pirkelbauer&#125;@tamu.edu, bs@cs.tamu.edu</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author Zhi Gan</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &lt;E&gt; type of element in the vector</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LockFreeVector</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    private <span class="keyword">static</span> final boolean debug = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Size of the first bucket. sizeof(bucket[i+1])=2*sizeof(bucket[i])</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> final int FIRST_BUCKET_SIZE = <span class="number">8</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * number of buckets. 30 will allow 8*(2^30-1) elements</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private <span class="keyword">static</span> final int N_BUCKET = <span class="number">30</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * We will have at most N_BUCKET number of buckets. And we have</span></span><br><span class="line"><span class="comment">     * sizeof(buckets.get(i))=FIRST_BUCKET_SIZE**(i+1)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private final AtomicReferenceArray&lt;AtomicReferenceArray&lt;E&gt;&gt; buckets;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author ganzhi</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param &lt;E&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteDescriptor</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        public E oldV;</span><br><span class="line">        public E newV;</span><br><span class="line">        public AtomicReferenceArray&lt;E&gt; addr;</span><br><span class="line">        public int addr_ind;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creating a new descriptor.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param addr Operation address</span></span><br><span class="line"><span class="comment">         * @param addr_ind  Index of address</span></span><br><span class="line"><span class="comment">         * @param oldV old operand</span></span><br><span class="line"><span class="comment">         * @param newV new operand</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public WriteDescriptor(AtomicReferenceArray&lt;E&gt; addr, int addr_ind,</span><br><span class="line">                E oldV, E newV) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addr = addr;</span><br><span class="line">            <span class="keyword">this</span>.addr_ind = addr_ind;</span><br><span class="line">            <span class="keyword">this</span>.oldV = oldV;</span><br><span class="line">            <span class="keyword">this</span>.newV = newV;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * set newV.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">void</span> doIt() &#123;</span><br><span class="line">            addr.compareAndSet(addr_ind, oldV, newV);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @author ganzhi</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param &lt;E&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Descriptor</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        public int size;</span><br><span class="line">        volatile WriteDescriptor&lt;E&gt; writeop;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Create a new descriptor.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param size Size of the vector</span></span><br><span class="line"><span class="comment">         * @param writeop Executor write operation</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public Descriptor(int size, WriteDescriptor&lt;E&gt; writeop) &#123;</span><br><span class="line">            <span class="keyword">this</span>.size = size;</span><br><span class="line">            <span class="keyword">this</span>.writeop = writeop;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        public <span class="keyword">void</span> completeWrite() &#123;</span><br><span class="line">            WriteDescriptor&lt;E&gt; tmpOp = writeop;</span><br><span class="line">            <span class="keyword">if</span> (tmpOp != <span class="literal">null</span>) &#123;</span><br><span class="line">                tmpOp.doIt();</span><br><span class="line">                writeop = <span class="literal">null</span>; <span class="comment">// this is safe since all write to writeop use</span></span><br><span class="line">                <span class="comment">// null as r_value.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private AtomicReference&lt;Descriptor&lt;E&gt;&gt; descriptor;</span><br><span class="line">    private <span class="keyword">static</span> final int zeroNumFirst = Integer</span><br><span class="line">            .numberOfLeadingZeros(FIRST_BUCKET_SIZE);;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public LockFreeVector() &#123;</span><br><span class="line">        buckets = <span class="keyword">new</span> AtomicReferenceArray&lt;AtomicReferenceArray&lt;E&gt;&gt;(N_BUCKET);</span><br><span class="line">        buckets.set(<span class="number">0</span>, <span class="keyword">new</span> AtomicReferenceArray&lt;E&gt;(FIRST_BUCKET_SIZE));</span><br><span class="line">        descriptor = <span class="keyword">new</span> AtomicReference&lt;Descriptor&lt;E&gt;&gt;(<span class="keyword">new</span> Descriptor&lt;E&gt;(<span class="number">0</span>,</span><br><span class="line">                <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * add e at the end of vector.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param e</span></span><br><span class="line"><span class="comment">     *            element added</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">void</span> push_back(E e) &#123;</span><br><span class="line">        Descriptor&lt;E&gt; desc;</span><br><span class="line">        Descriptor&lt;E&gt; newd;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            desc = descriptor.get();</span><br><span class="line">            desc.completeWrite();</span><br><span class="line">            <span class="comment">//desc.size   Vector æœ¬èº«çš„å¤§å°</span></span><br><span class="line">            <span class="comment">//FIRST_BUCKET_SIZE  ç¬¬ä¸€ä¸ªä¸€ä½æ•°ç»„çš„å¤§å°</span></span><br><span class="line">            int pos = desc.size + FIRST_BUCKET_SIZE;</span><br><span class="line">            int zeroNumPos = Integer.numberOfLeadingZeros(pos);  <span class="comment">// å–å‡ºpos çš„å‰å¯¼é¢†</span></span><br><span class="line">            <span class="comment">//zeroNumFirst  ä¸ºFIRST_BUCKET_SIZE çš„å‰å¯¼é¢†</span></span><br><span class="line">            int bucketInd = zeroNumFirst - zeroNumPos;  <span class="comment">//å“ªä¸ªä¸€ä½æ•°ç»„</span></span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¿™ä¸ªä¸€ç»´æ•°ç»„æ˜¯å¦å·²ç»å¯ç”¨</span></span><br><span class="line">            <span class="keyword">if</span> (buckets.get(bucketInd) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//newLen  ä¸€ç»´æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">                int newLen = <span class="number">2</span> * buckets.get(bucketInd - <span class="number">1</span>).length();</span><br><span class="line">                <span class="keyword">if</span> (debug)</span><br><span class="line">                    System.out.println(<span class="string">"New Length is:"</span> + newLen);</span><br><span class="line">                buckets.compareAndSet(bucketInd, <span class="literal">null</span>,</span><br><span class="line">                        <span class="keyword">new</span> AtomicReferenceArray&lt;E&gt;(newLen));</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            int idx = (<span class="number">0x80000000</span>&gt;&gt;&gt;zeroNumPos) ^ pos;   <span class="comment">//åœ¨è¿™ä¸ªä¸€ä½æ•°ç»„ä¸­ï¼Œæˆ‘åœ¨å“ªä¸ªä½ç½®</span></span><br><span class="line">            newd = <span class="keyword">new</span> Descriptor&lt;E&gt;(desc.size + <span class="number">1</span>, <span class="keyword">new</span> WriteDescriptor&lt;E&gt;(</span><br><span class="line">                    buckets.get(bucketInd), idx, <span class="literal">null</span>, e));</span><br><span class="line">        &#125; <span class="keyword">while</span> (!descriptor.compareAndSet(desc, newd));</span><br><span class="line">        descriptor.get().completeWrite();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove the last element in the vector.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return element removed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public E pop_back() &#123;</span><br><span class="line">        Descriptor&lt;E&gt; desc;</span><br><span class="line">        Descriptor&lt;E&gt; newd;</span><br><span class="line">        E elem;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            desc = descriptor.get();</span><br><span class="line">            desc.completeWrite();</span><br><span class="line"> </span><br><span class="line">            int pos = desc.size + FIRST_BUCKET_SIZE - <span class="number">1</span>;</span><br><span class="line">            int bucketInd = Integer.numberOfLeadingZeros(FIRST_BUCKET_SIZE)</span><br><span class="line">                    - Integer.numberOfLeadingZeros(pos);</span><br><span class="line">            int idx = Integer.highestOneBit(pos) ^ pos;</span><br><span class="line">            elem = buckets.get(bucketInd).get(idx);</span><br><span class="line">            newd = <span class="keyword">new</span> Descriptor&lt;E&gt;(desc.size - <span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!descriptor.compareAndSet(desc, newd));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> elem;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get element with the index.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param index</span></span><br><span class="line"><span class="comment">     *            index</span></span><br><span class="line"><span class="comment">     * @return element with the index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Override</span><br><span class="line">    public E get(int index) &#123;</span><br><span class="line">        int pos = index + FIRST_BUCKET_SIZE;</span><br><span class="line">        int zeroNumPos = Integer.numberOfLeadingZeros(pos);</span><br><span class="line">        int bucketInd = zeroNumFirst - zeroNumPos;</span><br><span class="line">        int idx = (<span class="number">0x80000000</span>&gt;&gt;&gt;zeroNumPos) ^ pos;</span><br><span class="line">        <span class="keyword">return</span> buckets.get(bucketInd).get(idx);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the element with index to e.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param index</span></span><br><span class="line"><span class="comment">     *            index of element to be reset</span></span><br><span class="line"><span class="comment">     * @param e</span></span><br><span class="line"><span class="comment">     *            element to set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * &#123;@inheritDoc&#125;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    public E set(int index, E e) &#123;</span><br><span class="line">        int pos = index + FIRST_BUCKET_SIZE;</span><br><span class="line">        int bucketInd = Integer.numberOfLeadingZeros(FIRST_BUCKET_SIZE)</span><br><span class="line">                - Integer.numberOfLeadingZeros(pos);</span><br><span class="line">        int idx = Integer.highestOneBit(pos) ^ pos;</span><br><span class="line">        AtomicReferenceArray&lt;E&gt; bucket = buckets.get(bucketInd);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            E oldV = bucket.get(idx);</span><br><span class="line">            <span class="keyword">if</span> (bucket.compareAndSet(idx, oldV, e))</span><br><span class="line">                <span class="keyword">return</span> oldV;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * reserve more space.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param newSize</span></span><br><span class="line"><span class="comment">     *            new size be reserved</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public <span class="keyword">void</span> reserve(int newSize) &#123;</span><br><span class="line">        int size = descriptor.get().size;</span><br><span class="line">        int pos = size + FIRST_BUCKET_SIZE - <span class="number">1</span>;</span><br><span class="line">        int i = Integer.numberOfLeadingZeros(FIRST_BUCKET_SIZE)</span><br><span class="line">                - Integer.numberOfLeadingZeros(pos);</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">1</span>)</span><br><span class="line">            i = <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">        int initialSize = buckets.get(i - <span class="number">1</span>).length();</span><br><span class="line">        <span class="keyword">while</span> (i &lt; Integer.numberOfLeadingZeros(FIRST_BUCKET_SIZE)</span><br><span class="line">                - Integer.numberOfLeadingZeros(newSize + FIRST_BUCKET_SIZE - <span class="number">1</span>)) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            initialSize *= FIRST_BUCKET_SIZE;</span><br><span class="line">            buckets.compareAndSet(i, <span class="literal">null</span>, <span class="keyword">new</span> AtomicReferenceArray&lt;E&gt;(</span><br><span class="line">                    initialSize));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * size of vector.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return size of vector</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public int size() &#123;</span><br><span class="line">        <span class="keyword">return</span> descriptor.get().size;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * &#123;@inheritDoc&#125;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    @Override</span><br><span class="line">    public boolean add(E object) &#123;</span><br><span class="line">        push_back(object);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;1-æ— é”ç±»çš„åŸç†è¯¦è§£&quot;&gt;&lt;a href=&quot;#1-æ— é”ç±»çš„åŸç†è¯¦è§£&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šJavaå†…å­˜æ¨¡å‹å’Œçº¿ç¨‹å®‰å…¨</title>
    <link href="http://mmmmmm.me/2019-01-31-1.html"/>
    <id>http://mmmmmm.me/2019-01-31-1.html</id>
    <published>2019-01-18T11:20:02.000Z</published>
    <updated>2019-01-31T05:48:53.467Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h1><p>åŸå­æ€§æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°± ä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹å¹²æ‰°ã€‚<br>i++æ˜¯åŸå­æ“ä½œå—?<br>ä¸æ˜¯ï¼Œå› ä¸ºåŒ…å«äº†ä¸‰æ¬¡æ“ä½œï¼šè¯»iï¼Œi+1ï¼Œæ–°å€¼å†™åˆ°iä¸­ã€‚<br>æ¯”å¦‚i=1ï¼Œiæ˜¯staticçš„ï¼Œä¸€ä¸ªçº¿ç¨‹aè¯»åˆ°äº†1ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹båœ¨çº¿ç¨‹ä¸€åšåŠ æ³•ä¹‹å‰ä¹Ÿè¯»åˆ°äº†i=1, açº¿ç¨‹å’Œbçº¿ç¨‹åŒæ—¶æ‹¿åˆ°äº†iï¼Œåši++çš„æ“ä½œï¼Œaçº¿ç¨‹i++åå˜æˆäº†2ï¼Œbçº¿ç¨‹i++åä¹Ÿå˜æˆäº†2ï¼Œ <strong><font color="red">æ‰€ä»¥æœ€åçš„içš„å€¼æ˜¯2ï¼Œä½†æ˜¯å®é™…ä¸Šiçš„å€¼åº”è¯¥æ˜¯3</font></strong></p><h1 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h1><p>åœ¨å¹¶å‘æ—¶ï¼Œç¨‹åºçš„æ‰§è¡Œå¯èƒ½å°±ä¼šå‡ºç°ä¹±åº</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderExample</span> </span>&#123; int a = <span class="number">0</span>;</span><br><span class="line">boolean flag = <span class="literal">false</span>; public <span class="keyword">void</span> writer() &#123;</span><br><span class="line">a = <span class="number">1</span>;</span><br><span class="line">flag = <span class="literal">true</span>; &#125;</span><br><span class="line">public <span class="keyword">void</span> reader() &#123; <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">inti= a+<span class="number">1</span>;</span><br><span class="line">...... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img alt="" data-original="/images/15488909175833.png"></p><p>ä¸€æ¡æŒ‡ä»¤ï¼ˆæ±‡ç¼–æŒ‡ä»¤ï¼‰çš„æ‰§è¡Œæ˜¯å¯ä»¥åˆ†ä¸ºå¾ˆå¤šæ­¥éª¤çš„<br>â€“ å–æŒ‡IF ï¼ˆæŠŠæŒ‡ä»¤å–å‡ºæ¥ï¼‰<br>â€“ è¯‘ç å’Œå–å¯„å­˜å™¨æ“ä½œæ•° ID ï¼ˆå‚æ•°å–å‡ºæ¥ï¼‰<br>â€“ æ‰§è¡Œæˆ–è€…æœ‰æ•ˆåœ°å€è®¡ç®— EX ï¼ˆæ‰§è¡Œï¼‰<br>â€“ å­˜å‚¨å™¨è®¿é—® MEM ï¼ˆå­˜å‚¨å™¨è®¿é—®ï¼‰<br>â€“ å†™å›WB ï¼ˆæ•°æ®å†™ä¼šåˆ°å¯„å­˜å™¨ä¸­å»ï¼‰<br><strong><font color="red">æ³¨æ„ï¼šæ¯ä¸€ä¸ªéƒ¨åˆ†ä¼šå ç”¨è®¡ç®—æœºä¸åŒçš„ç¡¬ä»¶</font></strong><br><img alt="" data-original="/images/15488909301951.png"></p><p>å¤æ‚ä¸€ç‚¹çš„ï¼š<br><img alt="" data-original="/images/15488909358761.png"></p><p>å‘ç°åŠ äº†å¾ˆå¤šçš„æ°”æ³¡è¿›å»<br><img alt="" data-original="/images/15488909482711.png"><br><img alt="" data-original="/images/15488909498914.png"></p><h1 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h1><p>å¯è§æ€§æ˜¯æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸€ä¸ªå…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯å¦èƒ½å¤Ÿç«‹å³çŸ¥é“è¿™ä¸ªä¿®æ”¹ã€‚</p><h2 id="â€“-ç¼–è¯‘å™¨ä¼˜åŒ–"><a href="#â€“-ç¼–è¯‘å™¨ä¼˜åŒ–" class="headerlink" title="â€“ ç¼–è¯‘å™¨ä¼˜åŒ–"></a>â€“ ç¼–è¯‘å™¨ä¼˜åŒ–</h2><p>æ¯”å¦‚ä¸Šé¢çš„é‡æ’ï¼Œå¹¶ä¸çŸ¥é“å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„å€¼æ˜¯å¤šå°‘ï¼Œæˆ–è€…ç¼–è¯‘æœŸï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªå€¼ä¼˜åŒ–åˆ°äº†æŸä¸ªå¯„å­˜å™¨ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸­å°†è¿™ä¸ªå€¼æ”¾åˆ°äº†é«˜é€Ÿç¼“å­˜cacheä¸­ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¸èƒ½å†åŒä¸€æ—¶é—´çŸ¥é“å¯¹æ–¹ä¿®æ”¹äº†å€¼ã€‚å¤šæ ¸cpuï¼Œæ¯ä¸€ä¸ªcpuä¸­éƒ½æœ‰è‡ªå·±çš„å¯„å­˜å™¨ï¼Œå˜é‡è¢«ä¸åŒçš„cpuä¸åŒçš„å¯„å­˜å™¨ä¸åŒçš„cacheä¸­ä¿å­˜ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯å¯è§ã€‚</p><h2 id="â€“-ç¡¬ä»¶ä¼˜åŒ–-å¦‚å†™å¸æ”¶ï¼Œæ‰¹æ“ä½œ"><a href="#â€“-ç¡¬ä»¶ä¼˜åŒ–-å¦‚å†™å¸æ”¶ï¼Œæ‰¹æ“ä½œ" class="headerlink" title="â€“ ç¡¬ä»¶ä¼˜åŒ–(å¦‚å†™å¸æ”¶ï¼Œæ‰¹æ“ä½œ)"></a>â€“ ç¡¬ä»¶ä¼˜åŒ–(å¦‚å†™å¸æ”¶ï¼Œæ‰¹æ“ä½œ)</h2><p>cpuæƒ³æŠŠæ•°æ®å†™åˆ°å†…å­˜é‡Œçš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½ä¸ä¼šæ˜¯ç›´æ¥æŠŠæ•°æ®å†™åˆ°å†…å­˜é‡Œé¢ï¼Œå› ä¸ºè¿™æ ·å¾ˆæ…¢ï¼Œå…ˆæŠŠæ•°æ®å†™åˆ°ç¡¬ä»¶é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åé€šè¿‡æ‰¹é‡æ“ä½œçš„æ–¹å¼æ‰¹é‡å†™åˆ°å†…å­˜é‡Œé¢å»ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒå¿«ä¸€äº›ï¼Œè¿˜ä¼šåšä¼˜åŒ–ï¼Œæ¯”å¦‚å¯¹åŒä¸€ä¸ªå†…å­˜åœ°å€å¤šæ¬¡åšäº†ä¸åŒçš„è¯»å†™ï¼Œè®¤ä¸ºæ˜¯æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºæ˜¯ä»¥æœ€åä¸€ä¸ªä¸ºå‡†ï¼Œæ‰€ä»¥å¹²è„†å°±æŠŠè€çš„è¯»å†™ï¼Œå°±ä¸è¯»å†™è¿›å»ï¼Œåªå°†æœ€åçš„åœ°å€è¯»å†™è¿›å»<br><img alt="" data-original="/images/15488909591307.png"></p><p><strong><font color="red">å¦‚æœä¸åšä¼˜åŒ–ï¼Œå°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜ï¼Œå¯æ˜¯ä¸åšä¼˜åŒ–çš„è¯ï¼Œæ€§èƒ½å°±ä¼šå¾ˆå·®ã€‚</font></strong></p><h2 id="Javaè™šæ‹Ÿæœºå±‚é¢çš„å¯è§æ€§"><a href="#Javaè™šæ‹Ÿæœºå±‚é¢çš„å¯è§æ€§" class="headerlink" title="Javaè™šæ‹Ÿæœºå±‚é¢çš„å¯è§æ€§"></a>Javaè™šæ‹Ÿæœºå±‚é¢çš„å¯è§æ€§</h2><p>åšæ–‡ï¼š<a href="http://hushi55.github.io/2015/01/05/volatile-assembly" target="_blank" rel="noopener">http://hushi55.github.io/2015/01/05/volatile-assembly</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">VisibilityTest</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123; private boolean stop;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line">int i = <span class="number">0</span>; <span class="keyword">while</span>(!stop) &#123;</span><br><span class="line">i++; &#125;</span><br><span class="line">System.out.println(<span class="string">"finish loop,i="</span> + i); &#125;</span><br><span class="line">public <span class="keyword">void</span> stopIt() &#123; stop = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">public boolean getStop()&#123; <span class="keyword">return</span> stop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123; VisibilityTest v = <span class="keyword">new</span> VisibilityTest();</span><br><span class="line">v.start();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">v.stopIt();</span><br><span class="line">Thread.sleep(<span class="number">2000</span>); System.out.println(<span class="string">"finish main"</span>); System.out.println(v.getStop());</span><br><span class="line">DATAGURUä¸“ä¸šæ•°æ®åˆ†æç¤¾åŒº</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><font color="red">å°±æ˜¯å¸Œæœ›åœ¨v.stopIt();ä¹‹åè®©stop=trueï¼Œè¾“å‡ºSystem.out.println(â€œfinish loop,i=â€ + i); }<br>å¯æ˜¯å®é™…çš„æ“ä½œï¼Œæ˜¯å¹¶æ²¡æœ‰è¾“å‡ºè¿™å¥è¯çš„ã€‚<br></font></strong></p><p><img alt="" data-original="/images/15488909684910.png"></p><p>å¦‚ä½•æŸ¥çœ‹æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Ÿ<br><img alt="" data-original="/images/15488909800340.png"></p><p>è™šæ‹Ÿæœºæ‰§è¡Œæœ‰ä¸¤ç§æ–¹å¼clientæ–¹å¼å’Œserveræ¨¡å¼ï¼Œclientä¸ä¼šåšå¤ªå¤šçš„ä¼˜åŒ–ï¼Œå°±æ˜¯ç³»ç»Ÿå¯åŠ¨çš„æ¯”è¾ƒå¿«ï¼Œserveræ¨¡å¼ç³»ç»Ÿå¯åŠ¨çš„æ…¢ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šçš„ä¼˜åŒ–ï¼Œç°åœ¨64ä½çš„æœºå™¨éƒ½æ˜¯serveræ¨¡å¼ã€‚<br>é€šè¿‡serveræ¨¡å¼å‘ç°æ˜¯æ°¸è¿œä¸ä¼šæ‰§è¡Œå®Œã€‚<br><strong><font color="red">å¦‚ä½•è¿›è¡ŒæŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤ ï¼Ÿ</font></strong><br>1ã€å¯ä»¥ä½¿ç”¨å‘½ä»¤</p><blockquote><p>java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly Main<br>(Mainæ˜¯classæ–‡ä»¶)</p></blockquote><p>2ã€åœ¨IDEAé…ç½®VM optionsï¼Œæ‰“å°æ±‡ç¼–æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾ã€‚</p><blockquote><p>-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly</p></blockquote><p>åŸæ–‡ï¼š<a href="https://blog.csdn.net/ljheee/article/details/82218156" target="_blank" rel="noopener">https://blog.csdn.net/ljheee/article/details/82218156</a></p><p>ä¸Šå›¾æ˜¯åšå®¢ä½œè€…æ•´ç†çš„æ±‡ç¼–ä»£ç ï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼š<br><strong><font color="red">å› ä¸ºjvmçš„å†…éƒ¨ä¼˜åŒ–ï¼Œå¯¼è‡´ä¸æ–­çš„åœ¨çº¢è‰²çš„ä»£ç éƒ¨åˆ†è¿›è¡Œå¾ªç¯ï¼Œå¹¶æ²¡æœ‰èµ°!stopçš„è¿™ä¸ªè€Œåˆ¤æ–­æŒ‡ä»¤ï¼Œè¿™ä¸ªåˆ¤æ–­åªæ˜¯åœ¨åˆšåˆšè¿›æ¥çš„æ—¶å€™å›è¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ï¼Œæ‰€ä»¥ä¼šä¸æ–­çš„æ‰§è¡Œä¸‹å»ã€‚ä¹Ÿå°±å‡ºç°äº†ä¸Šé¢çš„ç»“æœã€‚</font></strong></p><p>å¼•ç”¨åšæ–‡ä¸­çš„ä¸€å¥è¯ï¼š<br>ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¸åœçš„å¯¹å±€éƒ¨å˜é‡åšè‡ªå¢æ“ä½œï¼Œä¸»çº¿ç¨‹ä¼‘çœ  1 ç§’ä¸­åæ”¹å˜å¯åŠ¨çº¿ç¨‹çš„å¾ªç¯æ§åˆ¶å˜é‡ï¼Œæƒ³è®©å®ƒåœæ­¢å¾ªç¯ã€‚è¿™ä¸ªç¨‹åºåœ¨ client æ¨¡å¼ä¸‹æ˜¯èƒ½åœæ­¢çº¿ç¨‹åšè‡ªå¢æ“ä½œçš„ï¼Œä½†æ˜¯åœ¨ server æ¨¡å¼å…ˆå°†æ˜¯æ— é™å¾ªç¯ã€‚è‹¥æ˜¯æ”¹æˆ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private volatile boolean stop;</span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">ç”¨ volatile ä¿®é¥° stop å˜é‡ï¼Œå°†ä¸ä¼šå‡ºç°æ­»å¾ªç¯ã€‚</font></strong><br>æˆ‘ä»¬çŸ¥é“ volatile åœ¨ JVM å†…å­˜æ¨¡å‹ä¸­æ˜¯ä¿è¯ä¿®é¥°å˜é‡çš„å¯è§æ€§ï¼Œè¿™ä¸ªä¸æ˜¯æˆ‘ä»¬ä»Šå¤©è®¨è®ºçš„é‡ç‚¹ï¼Œæˆ‘ä»¬ä»Šå¤©æƒ³çœ‹çœ‹åœ¨ volatile ä¿®é¥°ä¸‹å’Œä¸ä¿®é¥°ä»£ç ç¼–è¯‘æˆçš„æ±‡ç¼–ä»£ç çš„åŒºåˆ«ï¼Œä»¥ä¾¿æˆ‘ä»¬å­¦ä¹  JVM çš„å†…å­˜æ¨¡å‹ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­</p><p><img alt="" data-original="/images/15488909905972.png"><br><img alt="" data-original="/images/15488909965152.png"></p><p>ä¸Šå›¾æ˜¯ä»javaè¯­è¨€è§„èŒƒä¸­æ‹¿åˆ°çš„ï¼Œæè¿°å¯è§æ€§å’ŒæŒ‡ä»¤é‡æ’çš„ä¸€äº›é—®é¢˜</p><h1 id="Happen-Beforeè§„åˆ™ï¼ˆå…ˆè¡Œå‘ç”Ÿï¼‰"><a href="#Happen-Beforeè§„åˆ™ï¼ˆå…ˆè¡Œå‘ç”Ÿï¼‰" class="headerlink" title="Happen-Beforeè§„åˆ™ï¼ˆå…ˆè¡Œå‘ç”Ÿï¼‰"></a>Happen-Beforeè§„åˆ™ï¼ˆå…ˆè¡Œå‘ç”Ÿï¼‰</h1><h2 id="ç¨‹åºé¡ºåºåŸåˆ™"><a href="#ç¨‹åºé¡ºåºåŸåˆ™" class="headerlink" title="ç¨‹åºé¡ºåºåŸåˆ™:"></a>ç¨‹åºé¡ºåºåŸåˆ™:</h2><p>ä¸€ä¸ªçº¿ç¨‹å†…ä¿è¯è¯­ä¹‰çš„ä¸²è¡Œæ€§<br>å¯¹äºå•çº¿ç¨‹æ¥è¯´ï¼Œé‡æ’å‰å’Œé‡æ’åçš„ç»“æœå¿…é¡»ä¸€è‡´<br><img alt="" data-original="/images/15488910504012.png"></p><h2 id="volatileè§„åˆ™"><a href="#volatileè§„åˆ™" class="headerlink" title="volatileè§„åˆ™:"></a>volatileè§„åˆ™:</h2><p>volatileå˜é‡çš„å†™ï¼Œå…ˆå‘ç”Ÿäºè¯»ï¼Œè¿™ä¿è¯äº†volatileå˜é‡çš„å¯è§æ€§</p><h2 id="é”è§„åˆ™"><a href="#é”è§„åˆ™" class="headerlink" title="é”è§„åˆ™:"></a>é”è§„åˆ™:</h2><p>è§£é”(unlock)å¿…ç„¶å‘ç”Ÿåœ¨éšåçš„åŠ é”(lock)å‰<br>å¦‚æœåŠ é”è¢«é‡æ’åˆ°è§£é”å‰é¢ï¼Œå› ä¸ºè¿˜æ²¡æœ‰è§£é”ï¼Œè‚¯å®šæ˜¯è·å–ä¸åˆ°é”çš„</p><h2 id="ä¼ é€’æ€§"><a href="#ä¼ é€’æ€§" class="headerlink" title="ä¼ é€’æ€§:"></a>ä¼ é€’æ€§:</h2><p>Aå…ˆäºBï¼ŒBå…ˆäºCï¼Œé‚£ä¹ˆAå¿…ç„¶å…ˆäºC</p><h3 id="çº¿ç¨‹çš„start-æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ"><a href="#çº¿ç¨‹çš„start-æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ" class="headerlink" title="çº¿ç¨‹çš„start()æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ"></a>çº¿ç¨‹çš„start()æ–¹æ³•å…ˆäºå®ƒçš„æ¯ä¸€ä¸ªåŠ¨ä½œ</h3><h3 id="çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“-Thread-join"><a href="#çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“-Thread-join" class="headerlink" title="çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“(Thread.join())"></a>çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œå…ˆäºçº¿ç¨‹çš„ç»ˆç»“(Thread.join())</h3><h3 id="çº¿ç¨‹çš„ä¸­æ–­-interrupt-å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç "><a href="#çº¿ç¨‹çš„ä¸­æ–­-interrupt-å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç " class="headerlink" title="çº¿ç¨‹çš„ä¸­æ–­(interrupt())å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç "></a>çº¿ç¨‹çš„ä¸­æ–­(interrupt())å…ˆäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç </h3><h3 id="å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäºfinalize-æ–¹æ³•"><a href="#å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäºfinalize-æ–¹æ³•" class="headerlink" title="å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäºfinalize()æ–¹æ³•"></a>å¯¹è±¡çš„æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸå…ˆäºfinalize()æ–¹æ³•</h3><h1 id="çº¿ç¨‹å®‰å…¨çš„æ¦‚å¿µ"><a href="#çº¿ç¨‹å®‰å…¨çš„æ¦‚å¿µ" class="headerlink" title="çº¿ç¨‹å®‰å…¨çš„æ¦‚å¿µ"></a>çº¿ç¨‹å®‰å…¨çš„æ¦‚å¿µ</h1><p>æŒ‡æŸä¸ªå‡½æ•°ã€å‡½æ•°åº“åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«è°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°å¤„ç†å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œä½¿ç¨‹åºåŠŸ èƒ½æ­£ç¡®å®Œæˆã€‚</p><p>i++åœ¨å¤šçº¿ç¨‹ä¸‹è®¿é—®çš„æƒ…å†µ<br><img alt="" data-original="/images/15488910582903.png"></p><p>i++æ˜¯staticçš„ä¸€ä¸ªå˜é‡ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨è¯»çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨è¯»ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨å†™çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨å†™ï¼Œæ‰€ä»¥å†™å’Œè¯»çš„æ—¶å€™å€¼ä¼šè¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¦†ç›–æ‰ã€‚ç”šè‡³çº¿ç¨‹å¾ˆå¤šçš„æ—¶å€™ï¼Œiå¯èƒ½ä¼šè¶ŠåŠ è¶Šå°ï¼Œ</p><p>è§£å†³ï¼šé˜»å¡çš„æ–¹å¼<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AccountingSync</span> <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="keyword">static</span> AccountingSync instance=<span class="keyword">new</span> AccountingSync(); <span class="keyword">static</span> int i=<span class="number">0</span>;</span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span>(int j=<span class="number">0</span>;j&lt;<span class="number">10000000</span>;j++)&#123; synchronized(instance)&#123;</span><br><span class="line">  &#125; &#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;åŸå­æ€§&quot;&gt;&lt;a href=&quot;#åŸå­æ€§&quot; class=&quot;headerlink&quot; title=&quot;åŸå­æ€§&quot;&gt;&lt;/a&gt;åŸå­
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ï¼šå¤šçº¿ç¨‹åŸºç¡€</title>
    <link href="http://mmmmmm.me/2019-01-31.html"/>
    <id>http://mmmmmm.me/2019-01-31.html</id>
    <published>2019-01-18T11:20:01.000Z</published>
    <updated>2019-01-30T23:26:13.260Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ</h1><p>çº¿ç¨‹æ˜¯è¿›ç¨‹å†…çš„æ‰§è¡Œå•å…ƒã€‚<br>æ¯ä¸ªè¿›ç¨‹ä¸­æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åˆ‡æ¢æ˜¯éå¸¸é‡é‡å‹çš„ï¼Œæ‰€çº¿ç¨‹å¯ä»¥ä½œä¸ºè¾ƒä¸ºå¹¿æ³›çš„å¹¶å‘æ¶‰åŠ</p><p>javaä¸­è°ƒåŠ¨äº†çº¿ç¨‹ä¼šæ˜ å°„åˆ°æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸¤è€…æ˜¯ç­‰ä»·çš„</p><h1 id="çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ"><a href="#çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ"></a>çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ</h1><p><img alt="" data-original="/images/15488896735763.png"></p><h1 id="çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ-1"><a href="#çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ-1" class="headerlink" title="çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ"></a>çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ</h1><h2 id="æ–°å»ºçº¿ç¨‹"><a href="#æ–°å»ºçº¿ç¨‹" class="headerlink" title="æ–°å»ºçº¿ç¨‹"></a>æ–°å»ºçº¿ç¨‹</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread t1=<span class="keyword">new</span> Thread(); t1.start();</span><br><span class="line">æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯runableæ¥å£çš„å®ç°</span><br><span class="line">startæ–¹æ³•å°±èƒ½æŠŠè¿™ä¸ªçº¿ç¨‹è·‘èµ·æ¥ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">åœ¨ä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ä¸Šé¢è°ƒç”¨runæ–¹æ³•</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread t1=<span class="keyword">new</span> Thread(); t1.run(); </span><br><span class="line">ä¸èƒ½å¼€å¯çº¿ç¨‹</span><br></pre></td></tr></table></figure><p><strong><font color="red">è°ƒç”¨runæ–¹æ³•å’Œè°ƒç”¨startæ–¹æ³•åšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ ï¼Œä½†æ˜¯runå¹¶ä¸ä¼šå¼€å¯æ–°çš„çº¿ç¨‹è€Œæ˜¯åœ¨è°ƒç”¨runçš„å½“å‰çš„è¿™ä¸ªçº¿ç¨‹å½“ä¸­æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œåªæœ‰ä½¿ç”¨çš„startæ–¹æ³•æ‰æ˜¯åœ¨çœŸçš„ä¸€ä¸ªæ–°çš„çº¿ç¨‹å½“ä¸­æ‰§è¡Œrunä¸­çš„äº‹æƒ…</font></strong></p><p>Thread.run()çš„å®ç° target æ˜¯Runnableæ¥å£ï¼ˆrunæ˜¯runnableæ¥å£ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼‰<br>runæ–¹æ³•æºç <br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private Runnable target;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line"> target.run();</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p></p><p>Thread çš„initæ–¹æ³•ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Thread()&#123;</span><br><span class="line">init(<span class="literal">null</span>,<span class="literal">null</span>,<span class="string">"Thread-"</span>+nextThreadNum(),<span class="number">0</span>)</span><br><span class="line"><span class="comment">//initæ–¹æ³•æ˜¯åœ¨newå¯¹è±¡çš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œçš„</span></span><br><span class="line">&#125;</span><br><span class="line">private <span class="keyword">void</span> init(ThreadGroup g, Runnable target, <span class="built_in">String</span> name,</span><br><span class="line">                      long stackSize) &#123;</span><br><span class="line">        init(g, target, name, stackSize, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="è°ƒç”¨runçš„ä¸€ç§æ–¹å¼"><a href="#è°ƒç”¨runçš„ä¸€ç§æ–¹å¼" class="headerlink" title="è°ƒç”¨runçš„ä¸€ç§æ–¹å¼"></a>è°ƒç”¨runçš„ä¸€ç§æ–¹å¼</h2><p>è¿™é‡Œçš„targetæœ¬èº«å°±æ˜¯ä¼ çš„nullï¼Œæ‰€ä»¥å°±å¯ä»¥æŠŠrunæ–¹æ³•é‡è½½ï¼ŒæŠŠæˆ‘ä»¬çš„æ–¹æ³•å†™è¿›å»<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread t1=<span class="keyword">new</span> Thread()&#123; </span><br><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">System.out.println(<span class="string">"Hello, I am t1"</span>);</span><br><span class="line">&#125; &#125;;</span><br><span class="line">t1.start();</span><br></pre></td></tr></table></figure><p></p><h2 id="è°ƒç”¨runå¦çš„ä¸€ç§æ–¹å¼"><a href="#è°ƒç”¨runå¦çš„ä¸€ç§æ–¹å¼" class="headerlink" title="è°ƒç”¨runå¦çš„ä¸€ç§æ–¹å¼"></a>è°ƒç”¨runå¦çš„ä¸€ç§æ–¹å¼</h2><p>å°†targetä¼ åˆ°initæ–¹æ³•ä¸­ï¼Œæ¥è¿è¡Œrunæ–¹æ³•ã€‚å¦‚ä¸‹é¢CreateThread3ï¼ˆä¸€ä¸ªrunnableçš„å®ä¾‹ï¼‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡è½½runæ–¹æ³•ï¼Œt1.start()çš„æ—¶å€™ä¼šè‡ªåŠ¨å»è°ƒç”¨target.runã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> CreateThread3()); t1.start();</span><br></pre></td></tr></table></figure><p></p><h2 id="ç»ˆæ­¢çº¿ç¨‹-ï¼ˆå¼ƒç”¨ï¼‰"><a href="#ç»ˆæ­¢çº¿ç¨‹-ï¼ˆå¼ƒç”¨ï¼‰" class="headerlink" title="ç»ˆæ­¢çº¿ç¨‹  ï¼ˆå¼ƒç”¨ï¼‰"></a>ç»ˆæ­¢çº¿ç¨‹ <strong><font color="red">ï¼ˆå¼ƒç”¨ï¼‰</font></strong></h2><p>â€“ Thread.stop() ä¸æ¨èä½¿ç”¨ã€‚å®ƒä¼šé‡Šæ”¾æ‰€æœ‰monitor<br>è®°å½•1:ID=1ï¼ŒNAME=å°æ˜<br>è®°å½•2:ID=2ï¼ŒNAME=å°ç‹</p><p><img alt="" data-original="/images/15488896869599.png"></p><p>å¦‚ä¸Šå›¾ï¼Œåœ¨è¯»å’Œå†™çš„æ—¶å€™åŠ å…¥é”ï¼Œå½“å†™å®Œidï¼Œæ­£è¦å†™nameçš„æ—¶å€™ï¼Œstopæ‰äº†threadï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¼šæŠŠé”é‡Šæ”¾æ‰ï¼Œå¯¼è‡´å°†idå†™äº†è¿›å»ï¼Œnameæ²¡æœ‰å†™è¿›å»ï¼Œå‡ºç°æ•°æ®çš„ä¸ä¸€è‡´ã€‚</p><h2 id="ä¸­æ–­çº¿ç¨‹"><a href="#ä¸­æ–­çº¿ç¨‹" class="headerlink" title="ä¸­æ–­çº¿ç¨‹"></a>ä¸­æ–­çº¿ç¨‹</h2><p>public void Thread.interrupt() // ä¸­æ–­çº¿ç¨‹<br>public boolean Thread.isInterrupted() // åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­<br>public static boolean Thread.interrupted() // åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤å½“å‰ä¸­æ–­çŠ¶æ€<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> run()&#123; <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">Thread.yield();</span><br><span class="line">&#125; &#125;</span><br><span class="line">t1.interrupt();</span><br></pre></td></tr></table></figure><p></p><p>t1.interrupt();æˆ‘åªæ˜¯å‘Šè¯‰çº¿ç¨‹ä½ åº”è¯¥ç»ˆæ­¢äº†ï¼Œå¯¹çº¿ç¨‹æ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œè¿˜æ˜¯åœ¨è·‘ç€çš„ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> run()&#123; <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">System.out.println(<span class="string">"Interruted!"</span>); </span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">Thread.yield();</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡Thread.currentThread().isInterrupted()åˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ˜¯ä¸æ˜¯è¢«interruptï¼ˆï¼‰ï¼Œå‘ŠçŸ¥è¿‡è¦ä¸­æ–­ï¼Œæ˜¯çš„è¯å°±breakå‡ºwhileå¾ªç¯ï¼ŒåŒæ—¶ç»ˆæ­¢runæ–¹æ³•ï¼Œä¹Ÿå°±è‡ªåŠ¨ç»ˆæ­¢äº†threadï¼Œè¿™é‡Œä¸ä¼šå‡ºç°æ•°æ®çš„ä¸ä¸€è‡´ï¼Œå› ä¸ºæ˜¯åœ¨Thread.yield();ï¼ˆä¸‹ä¸€æ¬¡æ•°æ®å¤„ç†ä¹‹å‰ï¼‰å¯¹çº¿ç¨‹è¿›è¡Œç»ˆæ­¢çš„ã€‚<br><strong><font color="red">æ‹“å±•</font></strong></p><p>public static native void sleep(long millis) throws InterruptedException<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> run()&#123; <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(Thread.currentThread().isInterrupted())&#123; </span><br><span class="line">System.out.println(<span class="string">"Interruted!"</span>);</span><br><span class="line"><span class="keyword">break</span>; &#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"Interruted When Sleep"</span>); </span><br><span class="line"><span class="comment">//è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºå¼‚å¸¸åä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ä½ </span></span><br><span class="line">Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br><span class="line"> Thread.yield();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>sleepå³ä¼‘çœ æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆä¼‘çœ æ–¹æ³•éœ€è¦æŠ›å‡º throws InterruptedExceptionå¼‚å¸¸å‘¢ï¼Ÿ<br>å¦‚æœæˆ‘åœ¨ä¼‘çœ çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å‡ºç°äº†isInterruptedï¼ˆä¸­æ–­ï¼‰çš„è¯·æ±‚æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªæ—¶å€™å¦‚æœsleepä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼ŒåŒæ—¶è‡ªåŠ¨æ¸…é™¤interruptï¼ˆï¼‰è®¾ç½®çš„æ ‡å¿—ä½ï¼Œæ‰€ä»¥éœ€è¦åœ¨æŠ›å‡ºçš„å¼‚å¸¸ä¸­æ·»åŠ Thread.currentThread().interrupt();ä»¥ä¿è¯èƒ½å¤Ÿè¢«ä¸Šé¢çš„Thread.currentThread().isInterrupted()æ£€æµ‹åˆ°ä»è€Œä¸­æ–­çº¿ç¨‹ã€‚</p><h2 id="æŒ‚èµ·-suspend-å’Œç»§ç»­æ‰§è¡Œ-resume-çº¿ç¨‹-å¼ƒç”¨"><a href="#æŒ‚èµ·-suspend-å’Œç»§ç»­æ‰§è¡Œ-resume-çº¿ç¨‹-å¼ƒç”¨" class="headerlink" title="æŒ‚èµ·(suspend)å’Œç»§ç»­æ‰§è¡Œ(resume)çº¿ç¨‹     (å¼ƒç”¨)"></a>æŒ‚èµ·(suspend)å’Œç»§ç»­æ‰§è¡Œ(resume)çº¿ç¨‹ <strong><font color="red">(å¼ƒç”¨)</font></strong></h2><p><strong><font color="red">suspend()ä¸ä¼šé‡Šæ”¾é” </font></strong>ï¼Œå‘ç°suspendä¹‹åç°åœºç§°è¿˜æ˜¯runnableçš„çŠ¶æ€ï¼Œå½“ç„¶ä¸ä»£è¡¨æ‰€æœ‰çš„æŒ‚èµ·åçº¿ç¨‹ä¼šrunnableã€‚<br>å¦‚æœåŠ é”å‘ç”Ÿåœ¨resume()ä¹‹å‰ ï¼Œåˆ™æ­»é”å‘ç”Ÿ<br><img alt="" data-original="/images/15488897021929.png"></p><p>å¦‚ä¸Šå›¾ï¼Œçº¿ç¨‹1æŒ‚èµ·å¯ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰é‡Šæ”¾é”ï¼Œå¸Œæœ›é€šè¿‡çº¿ç¨‹2æ¥resumeé”ï¼Œä½†æ˜¯çº¿ç¨‹2çš„resumeå¯èƒ½æ„å¤–çš„å‘ç”Ÿåœ¨suspendä¹‹å‰ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹1å°†ä¼šæ°¸è¿œçš„æŒ‚ï¼Œå…¶ä»–çš„é”ï¼ˆå¦‚ä¸Šå›¾çº¿ç¨‹3ï¼‰å°†ä¼šæ— çº¿ç­‰å¾…çº¿ç¨‹1æ‹¿åˆ°çš„é”ã€‚</p><h2 id="ç­‰å¾…çº¿ç¨‹ç»“æŸ-join-å’Œè°¦è®©-yeild"><a href="#ç­‰å¾…çº¿ç¨‹ç»“æŸ-join-å’Œè°¦è®©-yeild" class="headerlink" title="ç­‰å¾…çº¿ç¨‹ç»“æŸ(join)å’Œè°¦è®©(yeild)"></a>ç­‰å¾…çº¿ç¨‹ç»“æŸ(join)å’Œè°¦è®©(yeild)</h2><h3 id="yeild"><a href="#yeild" class="headerlink" title="yeild"></a>yeild</h3><p>å½“å‰çº¿ç¨‹ä¼˜å…ˆçº§ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œå¸Œæœ›å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šäº‰å¤ºcpuæ—¶é—´ï¼Œæ‰€ä»¥è®²å½“å‰å ç”¨çš„cpuäº‹ä»¶é‡Šæ”¾æ‰ï¼Œä½¿å¾—å…¶ä»–çš„çº¿ç¨‹æœ‰æ›´å¤šçš„æœºä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä½†æ˜¯ä¸‹æ¬¡è¿˜æ˜¯æœ‰æœºä¼šæ‹¿åˆ°cpuæ—¶é—´ï¼Œä¸ä»£è¡¨æ°¸è¿œçš„è®©å‡ºå»ã€‚</p><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>çº¿ç¨‹aå¸Œæœ›çŸ¥é“çº¿ç¨‹bä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œå› ä¸ºéœ€è¦åœ¨çº¿ç¨‹bç»“æŸçš„æ—¶å€™æ¥ç«‹é©¬åšæŸäº›äº‹æƒ…ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JoinMain</span> </span>&#123;</span><br><span class="line">public volatile <span class="keyword">static</span> int i=<span class="number">0</span>;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">@Override public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10000000</span>;i++); &#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">AddThread at=<span class="keyword">new</span> AddThread();</span><br><span class="line"> at.start();</span><br><span class="line">at.join();</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚ä¸Šé¢çš„ä»£ç ï¼Œå¸Œæœ›åœ¨ä¸»çº¿ç¨‹ä¸­åŠ å…¥atæ–¹æ³•ï¼Œåœ¨atæ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åå†æ‰§è¡ŒSystem.out.println(i);è¿™å¥è¯ã€‚</p><p>joinï¼ˆæœ‰æ—¶é—´å’Œæ²¡æ—¶é—´çš„ï¼Œå¦‚æœæœ‰æ— å‚æ•°å°±æ˜¯æ— é™ç­‰å¾…ï¼Œæœ‰å‚æ•°ï¼Œå°±æ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´å¦‚æœè¿˜æ²¡æœ‰ç»“æŸå°±ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæˆ‘ç­‰ä¸èµ·ã€‚ï¼‰<br>joinçš„æœ¬è´¨<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">wait(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœçº¿ç¨‹æ˜¯isaliveï¼ˆæ²¡æ­»æ‰çš„ï¼‰ï¼Œå°±æ— çº¿ç­‰å¾…ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œ ç³»ç»Ÿä¼šè°ƒç”¨ notifyAll()ï¼Œæ³¨æ„ **<font color="red"> ä¸è¦åœ¨Threadå®ä¾‹ä¸Šä½¿ç”¨ wait()å’Œnotify()æ–¹æ³•</font></p><h2 id="å®ˆæŠ¤çº¿ç¨‹"><a href="#å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="å®ˆæŠ¤çº¿ç¨‹"></a>å®ˆæŠ¤çº¿ç¨‹</h2><p>åœ¨åå°é»˜é»˜åœ°å®Œæˆä¸€äº›ç³»ç»Ÿæ€§çš„æœåŠ¡ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€JITçº¿ç¨‹å°±å¯ä»¥ç†è§£ä¸ºå®ˆæŠ¤çº¿ç¨‹<br>å½“ä¸€ä¸ªJavaåº”ç”¨å†…ï¼Œåªæœ‰å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼ŒJavaè™šæ‹Ÿæœºå°±ä¼šè‡ªç„¶é€€å‡º<br>Thread t=new DaemonT(); t.setDaemon(true); t.start();<br>ä¸¾ä¾‹å­ï¼š<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  psvm()&#123;</span><br><span class="line">Thread t =<span class="keyword">new</span> DeamonT();</span><br><span class="line">t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">t.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¼šå‘ç°ï¼Œåˆšå¯åŠ¨ç¨‹åºï¼Œå°±è‡ªåŠ¨åœæ‰äº†ã€‚</p><h2 id="çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="çº¿ç¨‹ä¼˜å…ˆçº§"></a>çº¿ç¨‹ä¼˜å…ˆçº§</h2><p>public final static int MIN_PRIORITY = 1;<br>public final static int NORM_PRIORITY = 5;<br>public final static int MAX_PRIORITY = 10;<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread high=<span class="keyword">new</span> HightPriority(); LowPriority low=<span class="keyword">new</span> LowPriority(); </span><br><span class="line">high.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">low.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">low.start();</span><br><span class="line">high.start();</span><br></pre></td></tr></table></figure><p></p><p>lowçš„ä¼˜å…ˆçº§æ¯”highé«˜<br>é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ›´å®¹æ˜“å†ç«äº‰ä¸­è·èƒœ</p><h1 id="åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥æ“ä½œ"><a href="#åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥æ“ä½œ" class="headerlink" title="åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥æ“ä½œ"></a>åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥æ“ä½œ</h1><h2 id="synchronized-ï¼ˆæ³¨æ„æ‹¿åˆ°çš„ä¸œè¥¿å¿…é¡»æ˜¯åŒä¸€ä¸ª"><a href="#synchronized-ï¼ˆæ³¨æ„æ‹¿åˆ°çš„ä¸œè¥¿å¿…é¡»æ˜¯åŒä¸€ä¸ª" class="headerlink" title="synchronized     ï¼ˆæ³¨æ„æ‹¿åˆ°çš„ä¸œè¥¿å¿…é¡»æ˜¯åŒä¸€ä¸ª)"></a>synchronized <strong><font color="red">ï¼ˆæ³¨æ„æ‹¿åˆ°çš„ä¸œè¥¿å¿…é¡»æ˜¯åŒä¸€ä¸ª)</font></strong></h2><p>è¿™ä¸ªå…³é”®å­—æ˜¯javaå†…ç½®çš„ï¼Œæ‰€æœ‰çš„å®ç°æ˜¯åœ¨è™šæ‹Ÿæœºå†…éƒ¨åšçš„ï¼ŒåŒ…æ‹¬æ‹¿é”ã€çº¿ç¨‹æŒ‚èµ·ã€æŒ‚èµ·ä¹‹å‰åšçš„ä¼˜åŒ–ç­‰å¾…ç­‰ã€‚<br>â€“ æŒ‡å®šåŠ é”å¯¹è±¡:å¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AccoutingSync2</span>  <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="keyword">static</span> AccoutingSync2 instance = <span class="keyword">new</span> AccoutingSync2();</span><br><span class="line"><span class="keyword">static</span> int i =<span class="number">0</span> ;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">synchronized (instance) &#123;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line">t1.join();</span><br><span class="line">t2.join();</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>â€“ ç›´æ¥ä½œç”¨äºå®ä¾‹æ–¹æ³•:ç›¸å½“äºå¯¹å½“å‰å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å®ä¾‹çš„é”ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AccoutingSync2</span>  <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="comment">//static AccoutingSync2 instance = new AccoutingSync2();</span></span><br><span class="line"><span class="keyword">static</span> int i =<span class="number">0</span> ;</span><br><span class="line">public synchronized <span class="keyword">void</span> increase()&#123;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">increase();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line"><span class="comment">//Thread t1 = new Thread(new AccoutingSync2());</span></span><br><span class="line"><span class="comment">//Thread t2 = new Thread(new AccoutingSync2());</span></span><br><span class="line">AccoutingSync2 accoutingSync2 = <span class="keyword">new</span> AccoutingSync2();</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(accoutingSync2);</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(accoutingSync2);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line">t1.join();</span><br><span class="line">t2.join();</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">æ³¨æ„ä¸Šé¢çš„mianæ–¹æ³•çš„ä¸¤è¡Œæ³¨é‡Šï¼Œå¦‚æœnewä¸¤æ¬¡AccoutingSync2ï¼Œæ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œè¿™æ ·ä½œç”¨äºæ–¹æ³•ä¸Šçš„é”ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ä¸å¯¹çš„ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡æ‰èƒ½ç”¨è¿™ç§æ–¹æ³•ã€‚</font></strong></p><p>â€“ ç›´æ¥ä½œç”¨äºé™æ€æ–¹æ³•:ç›¸å½“äºå¯¹å½“å‰ç±»åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰ç±»çš„é”ã€‚<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="class"><span class="keyword">class</span> <span class="title">AccoutingSync2</span>  <span class="title">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="comment">//static AccoutingSync2 instance = new AccoutingSync2();</span></span><br><span class="line"><span class="keyword">static</span> int i =<span class="number">0</span> ;</span><br><span class="line">public synchronized <span class="keyword">void</span> increase()&#123;</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">void</span> run() &#123;</span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">increase();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AccoutingSync2());</span><br><span class="line">Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AccoutingSync2());</span><br><span class="line"><span class="comment">//AccoutingSync2 accoutingSync2 = new AccoutingSync2();</span></span><br><span class="line"><span class="comment">//Thread t1 = new Thread(accoutingSync2);</span></span><br><span class="line"><span class="comment">//Thread t2 = new Thread(accoutingSync2);</span></span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line">t1.join();</span><br><span class="line">t2.join();</span><br><span class="line">System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong><font color="red">å°†ä¸Šé¢çš„ä»£ç å¾®æ•´ï¼Œå°†synchronizedä¿®é¥°çš„æ–¹æ³•å˜ä¸ºstaticçš„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å±äºç±»çš„ï¼Œæ­¤æ—¶mainå‡½æ•°ä¸­çš„Threadå¯ä»¥é€šè¿‡new AccoutingSync2()çš„æ–¹å¼æ¥newã€‚</font></strong></p><h2 id="Object-wait-Obejct-notify"><a href="#Object-wait-Obejct-notify" class="headerlink" title="Object.wait() Obejct.notify()"></a>Object.wait() Obejct.notify()</h2><p>Object.wait()çº¿ç¨‹ç­‰å¾…åœ¨å½“å‰å¯¹è±¡ä¸Š<br>Obejct.notify()é€šçŸ¥ç­‰å¾…åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„waitï¼ˆï¼‰å‡½æ•°è¿”å›</p><p>Object.wait()å¿…é¡»è¦å…ˆè·å¾—å½“å‰objectçš„é”æ‰èƒ½å»è°ƒç”¨waitæ–¹æ³•<br>Obejct.notify()ä¹Ÿå¿…é¡»è·å¾—å½“å‰çš„object<br><strong><font color="red">æ³¨æ„ï¼šå…±æœ‰çš„é”å¿…é¡»åœ¨æ‰§è¡Œåˆ°synchronizedä»£ç ä¹‹åæ‰ä¼šè¢«å®Œå…¨çš„é‡Šæ”¾</font></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.SQLOutput;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">Object</span> object = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">synchronized (object)&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T1 start!"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T1 wait for object "</span>);</span><br><span class="line">object.wait();</span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">"T1 end"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">synchronized (object)&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T2 start! notify one thread!"</span>);</span><br><span class="line">object.notify();</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">"T2 end"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">Thread t1 = <span class="keyword">new</span> T1();</span><br><span class="line">Thread t2 = <span class="keyword">new</span> T2();</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><font color="red"><br>æ³¨æ„ä¸Šé¢çš„ä»£ç ä¸­waitå’Œnotifyä¸¤ä¸ªæ–¹æ³•æ‰§è¡Œä¹‹å‰éƒ½éœ€è¦è·å¾—objectè¿™ä¸ªé”ï¼ŒåŒ…æ‹¬waitçš„ç»§ç»­å‘ä¸‹ä¹Ÿéœ€è¦è¿™ä¸ªé”<br>æ¯”å¦‚ï¼Œæ‰“å°å‡ºSystem.out.println(System.currentTimeMillis()+â€T2 endâ€);è¿™å¥è¯ä¹‹åä¼šä¸ä¼šç«‹å³æ‰“å°å‡ºSystem.out.println(System.currentTimeMillis()+â€T1 endâ€);ï¼Ÿ<br>ç­”ï¼šä¸ä¼šå› ä¸ºwaitå’Œnotifyéƒ½åœ¨å…±ç”¨objectè¿™ä¸ªé”ï¼Œåœ¨è¾“å‡ºSystem.out.println(System.currentTimeMillis()+â€T2 endâ€);è¿™å¥è¯çš„æ—¶å€™è¿˜æ²¡æœ‰å®Œå…¨é‡Šæ”¾objectå¯¹è±¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä»£ç è¿˜åœ¨synchronized (object){}è¿™ä¸ªä»£ç å—ä¸­ï¼Œæ‰€ä»¥åªèƒ½åœ¨ç­‰å¾…sleep2000ä¹‹åå†é‡æ–°å›æ¥æ‰§è¡ŒT1 endçš„æ“ä½œã€‚</font><p>è¿è¡Œç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">154604567447</span>ï¼šT1 start</span><br><span class="line"><span class="number">154604567441</span>ï¼šT1  wait <span class="keyword">for</span> object</span><br><span class="line"><span class="number">154604567442</span>ï¼šT2 start ! notify one thread!</span><br><span class="line"><span class="number">154604567443</span>ï¼šT2 end</span><br><span class="line"><span class="number">154604567444</span>ï¼šT1 end</span><br></pre></td></tr></table></figure><p>å…·ä½“åœç•™ä¸¤ç§’çš„æ•ˆæœè¿˜éœ€è¦è¯»è€…è‡ªå·±å°è¯•</p><p><img alt="" data-original="/images/15488897542597.png"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.omg.PortableServer.THREAD_POLICY_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.SQLOutput;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">public <span class="keyword">static</span> <span class="built_in">Object</span> object = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">synchronized (object)&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T1 start!"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T1 wait for object "</span>);</span><br><span class="line">object.wait();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">"T1 end"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">public <span class="keyword">void</span> run()&#123;</span><br><span class="line">synchronized (object)&#123;</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">":T2 start! notify one thread!"</span>);</span><br><span class="line">object.notifyAll();</span><br><span class="line">System.out.println(System.currentTimeMillis()+<span class="string">"T2 end"</span>);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws InterruptedException &#123;</span><br><span class="line">Thread t1 = <span class="keyword">new</span> T1();</span><br><span class="line">Thread t2 = <span class="keyword">new</span> T2();</span><br><span class="line">Thread t3 = <span class="keyword">new</span> T1();</span><br><span class="line">t1.start();</span><br><span class="line">t3.start();</span><br><span class="line">Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">t2.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æè¿°ï¼š<br>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">object.wait();</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨waitæ–¹æ³•åè¿›è¡Œäº†sleepï¼Œåˆ›å»ºäº†ä¸¤ä¸ªt1ï¼Œå°†ä¸¤ä¸ªé‡Šæ”¾éƒ½é‡Šæ”¾çš„æ—¶å€™ï¼Œä¸­é—´ä¼šé—´æ–­ä¸€ç§’ï¼ŒåŒæ—¶å°è¯äº†ä¸Šé¢å¿…é¡»è¦è®©ç¨‹åºæ‰§è¡Œåˆ°synchronizeä»£ç å—å¤–é¢ä¹‹åå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚</p><p>è¿è¡Œç»“æœ<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">154604567447</span>ï¼šT1 start</span><br><span class="line"><span class="number">154604567441</span>ï¼šT1  wait <span class="keyword">for</span> object</span><br><span class="line"><span class="number">154604567442</span>ï¼šT1 start</span><br><span class="line"><span class="number">154604567443</span>ï¼šT1  wait <span class="keyword">for</span> object</span><br><span class="line"><span class="number">154604567444</span>ï¼šT2 start ! notify one thread!</span><br><span class="line"><span class="number">154604567445</span>ï¼šT2 end</span><br><span class="line"><span class="number">154604567446</span>ï¼šT1 end</span><br><span class="line"><span class="number">154604567448</span>ï¼šT1 end</span><br></pre></td></tr></table></figure><p></p><p>å…·ä½“åœç•™æ•ˆæœéœ€è¦è¯»è€…äº²è‡ªå°è¯•ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯çº¿ç¨‹
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šå¹¶è¡Œç®€ä»‹ä»¥åŠé‡è¦æ¦‚å¿µ</title>
    <link href="http://mmmmmm.me/2019-01-30.html"/>
    <id>http://mmmmmm.me/2019-01-30.html</id>
    <published>2019-01-18T11:20:00.000Z</published>
    <updated>2019-01-30T23:06:09.005Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><h1 id="ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ?"></a>ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ?</h1><p>â€“ ä¸šåŠ¡è¦æ±‚<br>â€“ æ€§èƒ½</p><h1 id="åå¯¹æ„è§"><a href="#åå¯¹æ„è§" class="headerlink" title="åå¯¹æ„è§"></a>åå¯¹æ„è§</h1><p>â€“ Linus Torvalds :å¿˜æ‰é‚£è¯¥æ­»çš„å¹¶è¡Œå§!<br>â€“ éœ€è¦æœ‰å¤šä¹ˆå¥‡è‘©çš„æƒ³è±¡åŠ›æ‰èƒ½æƒ³è±¡å‡ºå¹¶è¡Œè®¡ç®—çš„ç”¨æ­¦ä¹‹åœ°?<br>Linus Torvaldsç‚®è½°è¿‡çš„æŠ€æœ¯<br>â€“ GNU Emacs<br>â€“ GNOME<br>â€“ HFS+ (Mac OS æ–‡ä»¶ç³»ç»Ÿ)<br>â€“ Java<br>â€¢ â€œæœ¬è´¨ä¸Šæˆ‘çœ‹åˆ°çš„åªæ˜¯ Java å¼•æ“åœ¨èµ°ä¸‹å¡è·¯ï¼Œå› ä¸ºå®ƒåˆ«æ— å»å¤„ã€‚ â€1998å¹´8æœˆ<br>â€¢ â€œæˆ‘ä¸å…³å¿ƒJavaã€‚å¤šä¹ˆå¯æ€•çš„è¯­è¨€ã€‚â€œ2011å¹´11æœˆ<br>â€“ C++<br>â€¢ â€œäº‹å®æ˜¯ï¼ŒC++ç¼–è¯‘å™¨ä¸å€¼å¾—ä¿¡ä»»ã€‚æ•´ä¸ªC++å¼‚å¸¸å¤„ç†ä»æ ¹æœ¬ä¸Šæ˜¯é”™è¯¯çš„ã€‚â€œ2004å¹´1æœˆ19æ—¥ â€œ<br>â€¢ å°½ç®¡ C++ å¯ä»¥ç”¨äºåŸå‹æˆ–ç®€å•çš„ GUI ç¼–ç¨‹ï¼Œä½†å®ƒä¸èƒ½ä½¿äº‹æƒ…æ›´ç®€å•ã€‚C è¯­è¨€è™½ç„¶å¹¶ä¸ç²¾ç›Šäºç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œä½†å®ƒç§¯æé¼“åŠ±ä½ ä½¿ç”¨ç®€å•å’Œç›´æ¥çš„ç»“æ„ã€‚ â€œ2007å¹´9æœˆ7æ—¥<br>â€¢ â€œC ++ æ˜¯ä¸€ä¸ªå¯æ€•çš„è¯­è¨€ã€‚â€2007å¹´9æœˆ6æ—¥<br>â€“ XML<br>â€“ Solaris<br>â€“ MINIX</p><p>Linus Torvalds :å¹¶è¡Œè®¡ç®—åªæœ‰åœ¨å›¾åƒå¤„ç†å’ŒæœåŠ¡ç«¯ç¼–ç¨‹2ä¸ªé¢†åŸŸå¯ä»¥ä½¿ç”¨ï¼Œå¹¶ä¸”å®ƒåœ¨è¿™2ä¸ª é¢†åŸŸç¡®å®æœ‰ç€å¤§é‡å¹¿æ³›çš„ä½¿ç”¨ã€‚ä½†æ˜¯åœ¨å…¶å®ƒä»»ä½•åœ°æ–¹ï¼Œå¹¶è¡Œè®¡ç®—æ¯«æ— å»ºæ ‘!</p><h1 id="å¤§åŠ¿æ‰€è¶‹"><a href="#å¤§åŠ¿æ‰€è¶‹" class="headerlink" title="å¤§åŠ¿æ‰€è¶‹"></a>å¤§åŠ¿æ‰€è¶‹</h1><p>æ‘©å°”å®šå¾‹çš„å¤±æ•ˆ<br>â€“ é¢„è®¡18ä¸ªæœˆä¼šå°†èŠ¯ç‰‡çš„æ€§èƒ½æé«˜ä¸€å€<br>â€“ Intel CEO Barretå•è†ä¸‹è·ªå¯¹å–æ¶ˆ4GHzæ„Ÿåˆ°æŠ±æ­‰ â€¢ åœ¨2004å¹´ç§‹å­£ï¼ŒIntelå®£å¸ƒå½»åº•å–æ¶ˆ4GHzè®¡åˆ’<br>â€“ è™½ç„¶ç°åœ¨å·²ç»æœ‰äº†4GHZçš„èŠ¯ç‰‡ï¼Œä½†é¢‘ç‡æé™å·²ç»é€¼è¿‘ 10å¹´è¿‡å»äº†ï¼Œæˆ‘ä»¬è¿˜åœç•™åœ¨4GHZ</p><p>é¡¶çº§è®¡ç®—æœºç§‘å­¦å®¶å”çº³å¾·Â·å°”æ–‡Â·å…‹åŠªæ–¯<br>â€“ åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™ç§ç°è±¡(å¹¶å‘)æˆ–å¤šæˆ–å°‘æ˜¯ç”±äºç¡¬ä»¶è®¾è®¡è€… â€“ å·²ç»æ— è®¡å¯æ–½äº†å¯¼è‡´çš„ï¼Œä»–ä»¬å°†æ‘©å°”å®šå¾‹å¤±æ•ˆçš„è´£ä»» â€“ æ¨è„±ç»™è½¯ä»¶å¼€å‘è€…ã€‚</p><p>å¹¶è¡Œè®¡ç®—è¿˜å‡ºäºä¸šåŠ¡æ¨¡å‹çš„éœ€è¦<br>â€“ å¹¶ä¸æ˜¯ä¸ºäº†æé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œè€Œæ˜¯ç¡®å®åœ¨ä¸šåŠ¡ä¸Šéœ€è¦å¤šä¸ªæ‰§è¡Œå•å…ƒã€‚ â€“ æ¯”å¦‚HTTPæœåŠ¡å™¨ï¼Œä¸ºæ¯ä¸€ä¸ªSocketè¿æ¥æ–°å»ºä¸€ä¸ªå¤„ç†çº¿ç¨‹<br>â€“ è®©ä¸åŒçº¿ç¨‹æ‰¿æ‹…ä¸åŒçš„ä¸šåŠ¡å·¥ä½œ<br>â€“ ç®€åŒ–ä»»åŠ¡è°ƒåº¦</p><h1 id="å‡ ä¸ªé‡è¦çš„æ¦‚å¿µ"><a href="#å‡ ä¸ªé‡è¦çš„æ¦‚å¿µ" class="headerlink" title="å‡ ä¸ªé‡è¦çš„æ¦‚å¿µ"></a>å‡ ä¸ªé‡è¦çš„æ¦‚å¿µ</h1><h2 id="åŒæ­¥-synchronous-å’Œå¼‚æ­¥-asynchronous"><a href="#åŒæ­¥-synchronous-å’Œå¼‚æ­¥-asynchronous" class="headerlink" title="åŒæ­¥(synchronous)å’Œå¼‚æ­¥(asynchronous)"></a>åŒæ­¥(synchronous)å’Œå¼‚æ­¥(asynchronous)</h2><p><img alt="" data-original="/images/15488603988188.png"></p><p>åŒæ­¥å¼‚æ­¥æ˜¯å¯¹äºæ–¹æ³•è°ƒç”¨è€Œè¨€çš„ã€‚<br>åŒæ­¥è°ƒç”¨ä¼šç­‰å¾…æ–¹æ³•çš„è¿”å›ï¼Œæ–¹æ³•æ‰§è¡Œå¤šä¹…å°±è¦ç­‰å¾…å¤šä¹…ã€‚<br>å¼‚æ­¥è°ƒç”¨ç¬é—´è¿”å›ï¼Œä½†æ˜¯è°ƒç”¨å¹¶æ²¡æœ‰å®Œæˆï¼Œä¼šåœ¨åå°èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸å½±å“åšä¸‹é¢çš„äº‹æƒ…ã€‚</p><h2 id="å¹¶å‘å’Œå¹¶è¡Œ"><a href="#å¹¶å‘å’Œå¹¶è¡Œ" class="headerlink" title="å¹¶å‘å’Œå¹¶è¡Œ"></a>å¹¶å‘å’Œå¹¶è¡Œ</h2><p><img alt="" data-original="/images/15488604073805.png"></p><p>å¹¶å‘å’Œå¹¶è¡Œçš„å¤–åœ¨è¡¨è±¡åŸºæœ¬ä¸Šæ˜¯ä¸€è‡´çš„ã€‚<br>å¹¶è¡Œï¼šä¸¤ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹åŒæ—¶è¿›è¡Œ<br>å¹¶å‘ï¼šä¸€ä¼šåšäº‹ä»¶aä¸€ä¼šåšäº‹ä»¶bï¼Œå¦‚æ­¤é‡å¤è°ƒåº¦<br>å¯¹äºå•æ ¸cpuæ¥è¯´åªèƒ½æ˜¯å¹¶å‘ï¼Œå¯¹äºå¤šæ ¸cpuæ¥è¯´æ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œä½†æ˜¯å¯¹äºå¤–åœ¨è¡¨è±¡æ¥çœ‹ï¼Œäº‹ä»¶aå’Œäº‹ä»¶bä¸è®ºæ˜¯å¹¶è¡Œè¿˜æ˜¯å¹¶å‘ï¼Œéƒ½æ˜¯åœ¨åŒæ—¶æ‰§è¡Œ</p><h2 id="ä¸´ç•ŒåŒº"><a href="#ä¸´ç•ŒåŒº" class="headerlink" title="  ä¸´ç•ŒåŒº  "></a><strong><font color="red"> ä¸´ç•ŒåŒº</font></strong></h2><p>â€“ ä¸´ç•ŒåŒºç”¨æ¥è¡¨ç¤ºä¸€ç§å…¬å…±èµ„æºæˆ–è€…è¯´æ˜¯å…±äº«æ•°æ®ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚ä½†æ˜¯æ¯ä¸€æ¬¡ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹<br>ä½¿ç”¨å®ƒï¼Œä¸€æ—¦ä¸´ç•ŒåŒºèµ„æºè¢«å ç”¨ï¼Œå…¶ä»–çº¿ç¨‹è¦æƒ³ä½¿ç”¨è¿™ä¸ªèµ„æºï¼Œå°±å¿…é¡»ç­‰å¾…ã€‚<br><img alt="" data-original="/images/15488604162301.png"></p><h2 id="é˜»å¡-Blocking-å’Œéé˜»å¡-Non-Blocking"><a href="#é˜»å¡-Blocking-å’Œéé˜»å¡-Non-Blocking" class="headerlink" title="é˜»å¡(Blocking)å’Œéé˜»å¡(Non-Blocking)"></a>é˜»å¡(Blocking)å’Œéé˜»å¡(Non-Blocking)</h2><p>â€“ é˜»å¡å’Œéé˜»å¡é€šå¸¸ç”¨æ¥å½¢å®¹å¤šçº¿ç¨‹é—´çš„ç›¸äº’å½±å“ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å ç”¨äº†ä¸´ç•ŒåŒºèµ„æºï¼Œé‚£ä¹ˆå…¶å®ƒæ‰€æœ‰éœ€è¦ è¿™ä¸ªèµ„æºçš„çº¿ç¨‹å°±å¿…é¡»åœ¨è¿™ä¸ªä¸´ç•ŒåŒºä¸­è¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…ä¼šå¯¼è‡´çº¿ç¨‹æŒ‚èµ·ã€‚è¿™ç§æƒ…å†µå°±æ˜¯é˜»å¡ã€‚æ­¤æ—¶ï¼Œå¦‚ æœå ç”¨èµ„æºçš„çº¿ç¨‹ä¸€ç›´ä¸æ„¿æ„é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå…¶å®ƒæ‰€æœ‰é˜»å¡åœ¨è¿™ä¸ªä¸´ç•ŒåŒºä¸Šçš„çº¿ç¨‹éƒ½ä¸èƒ½å·¥ä½œã€‚<br>â€“ éé˜»å¡å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒº</p><p>é˜»å¡æ˜¯åœ¨æ“ä½œç³»ç»Ÿå±‚é¢è¢«æŒ‚èµ·ï¼Œé˜»å¡çš„æ–¹å¼æ€§èƒ½æ¯”è¾ƒå·®ï¼Œæ®ç»Ÿè®¡ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿå±‚é¢è¢«æŒ‚èµ·ï¼Œåšäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œéœ€è¦å…«ä¸‡ä¸ªæ—¶é—´å‘¨æœŸæ¥åšè¿™ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥ä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œä½†æ˜¯æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œè™½ç„¶æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ã€‚</p><h2 id="æ­»é”-Deadlock-ã€é¥¥é¥¿-Starvation-å’Œæ´»é”-Livelock"><a href="#æ­»é”-Deadlock-ã€é¥¥é¥¿-Starvation-å’Œæ´»é”-Livelock" class="headerlink" title="æ­»é”(Deadlock)ã€é¥¥é¥¿(Starvation)å’Œæ´»é”(Livelock)"></a>æ­»é”(Deadlock)ã€é¥¥é¥¿(Starvation)å’Œæ´»é”(Livelock)</h2><p><img alt="" data-original="/images/15488604280104.png"></p><ol><li><p>æ­»é”ï¼šaå µä½äº†dï¼Œdå µä½äº†cï¼Œcå µä½äº†bï¼Œbå µä½äº†aï¼Œaéœ€è¦bå¼€åŠ¨ï¼Œbéœ€è¦cå¼€åŠ¨ï¼Œcéœ€è¦då¼€åŠ¨ï¼Œdéœ€è¦aå¼€åŠ¨â€”â€“è°ä¹Ÿä¸èƒ½åŠ¨ã€‚<br>æ­»é”è™½ç„¶ä¸å¥½ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªé™æ€çš„é—®é¢˜ï¼Œä¸€æ—¦æ­»é”ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœæ­¢ï¼Œcpuçš„å ç”¨ç‡æ˜¯é›¶</p></li><li><p>æ´»é”ï¼šç”µæ¢¯é‡Œäººæƒ³å‡ºæ¥ï¼Œå¤–é¢çš„äººæƒ³è¿›å»ï¼Œéƒ½æƒ³é¿å¼€ï¼Œé‡Œé¢çš„äººå¾€å·¦é¢é ï¼Œå¤–é¢çš„äººå¾€å³è¾¹é ï¼Œè¿˜æ˜¯ä¸èƒ½é¿å¼€ï¼Œé‡Œé¢çš„äººå¾€å³é¢é ï¼Œå¤–é¢çš„äººå¾€å·¦è¾¹é ï¼Œå¦‚æ­¤å¾€å¤ã€‚<br>åˆæˆ–è€…açº¿ç¨‹éœ€è¦èµ„æº1ã€2ï¼Œbçº¿ç¨‹éœ€è¦èµ„æº1ã€2ï¼Œè¿™ä¸ªæ—¶å€™aæŠ¢åˆ°äº†1ï¼ŒbæŠ¢åˆ°äº†2ï¼Œéƒ½ä¸èƒ½å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™éƒ½é‡Šæ”¾å‡ºæ¥ï¼Œaåˆå»æŠ¢åˆ°äº†2ï¼ŒbæŠ¢åˆ°äº†1ï¼Œå¦‚æ­¤å¾€å¤ã€‚<br>ç®€è¨€ä¹‹ï¼Œå°±æ˜¯èµ„æºæ¥çº¿ç¨‹ä¹‹é—´è·³æ¥è·³å»ï¼Œä¹Ÿæ— æ³•è¿›è¡Œä¸‹å»ã€‚<br>æ´»é”æ¯”æ­»é”æ›´éš¾æŸ¥æ‰¾ï¼Œå› ä¸ºæ˜¯åŠ¨æ€çš„é—®é¢˜ã€‚</p></li><li><p>é¥¥é¥¿ï¼šaçº¿ç¨‹ä¼˜å…ˆçº§æ¯”bä½ï¼Œæ‰€ä»¥è°ƒåº¦çš„æ—¶å€™è°ƒåº¦ä¸åˆ°aï¼Œå°±ä¸èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå°±ä¼šé¥¿æ­»ï¼Œæˆ–è€…èµ„æºç«äº‰ä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œä¹Ÿä¼šå¯¼è‡´é¥¿æ­»ã€‚<br>é¥¥é¥¿æ˜¯æŒ‡æŸä¸€ä¸ªæˆ– è€…å¤šä¸ªçº¿ç¨‹å› ä¸ºç§ ç§åŸå› æ— æ³•è·å¾—æ‰€ éœ€è¦çš„èµ„æºï¼Œå¯¼è‡´ ä¸€ç›´æ— æ³•æ‰§è¡Œã€‚</p><h2 id="å¹¶å‘çº§åˆ«"><a href="#å¹¶å‘çº§åˆ«" class="headerlink" title="å¹¶å‘çº§åˆ«"></a>å¹¶å‘çº§åˆ«</h2></li><li>é˜»å¡:å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºåï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…</li><li>éé˜»å¡ï¼ˆä¸‹é¢ä¸‰ä¸ªï¼‰</li></ol><h3 id="â€“-æ— éšœç¢"><a href="#â€“-æ— éšœç¢" class="headerlink" title="â€“ æ— éšœç¢"></a>â€“ æ— éšœç¢</h3><p>æ— éšœç¢æ˜¯ä¸€ç§æœ€å¼±çš„éé˜»å¡è°ƒåº¦<br>è‡ªç”±å‡ºå…¥ä¸´ç•ŒåŒº<br>æ— ç«äº‰æ—¶ï¼Œæœ‰é™æ­¥å†…å®Œæˆæ“ä½œ<br>æœ‰ç«äº‰æ—¶ï¼Œå›æ»šæ•°æ®æœ‰ç«äº‰æ—¶ï¼Œå›æ»šæ•°æ®<br>å¥½è¿›ä¸å¥½å‡ºï¼Œå¾ˆå®¹æ˜“è¿›å»ï¼Œä½†æ˜¯è¿›å»å‘ç°å¾ˆå¤šçº¿ç¨‹ç«äº‰ç›¸åŒçš„èµ„æºçš„æ—¶å€™ï¼Œä¼šéœ€è¦å›æ»šæ•°æ®ï¼Œæ¯”å¦‚è¦è¯»å–xyï¼Œå·²ç»è¯»è¿‡äº†xï¼Œè¯»åˆ°yçš„æ—¶å€™å‘ç°åœ¨ç«äº‰ï¼Œä¼šä»xé‡æ–°è¯»ã€‚</p><h3 id="â€“-æ— é”"><a href="#â€“-æ— é”" class="headerlink" title="â€“ æ— é”"></a>â€“ æ— é”</h3><p>æ˜¯æ— éšœç¢çš„<br>ä¿è¯æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥èƒœå‡º<br>while (!atomicVar.compareAndSet(localVar, localVar+1)) {<br>localVar = atomicVar.get();<br>}<br>å› ä¸ºæ— éšœç¢ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸æ–­çš„ç«äº‰ï¼Œå°†ä¼šæ‰€æœ‰çš„éƒ½å‡ºä¸æ¥ï¼Œæ‰€ä»¥æ— é”å°±éœ€è¦æ¯æ¬¡ç«äº‰éƒ½èƒ½èƒœå‡ºä¸€ä¸ªï¼Œè¿™æ ·ä¿è¯ç¨‹åºèƒ½å¤Ÿé¡ºç•…çš„æ‰§è¡Œä¸‹å»ã€‚</p><h3 id="â€“-æ— ç­‰å¾…"><a href="#â€“-æ— ç­‰å¾…" class="headerlink" title="â€“   æ— ç­‰å¾…"></a>â€“ æ— ç­‰å¾…</h3><p>æ— é”çš„<br>è¦æ±‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»åœ¨æœ‰é™æ­¥å†…å®Œæˆ ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½åœ¨æœ‰çº¿çš„äº‹ä»¶å†…éƒ½ä»ä¸´ç•ŒåŒºå‡ºæ¥ã€‚<br>æ— é¥¥é¥¿çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»åœ¨æœ‰é™æ­¥å†…å®Œæˆ ï¼Œæ‰€ä»¥æ˜¯æ— é¥¥é¥¿çš„ã€‚<br>ä¸¾ä¾‹å­ï¼š<br>åªæœ‰è¯»çº¿ç¨‹æ²¡æœ‰å†™çº¿ç¨‹ï¼Œå°±æ˜¯æ— ç­‰å¾…çš„ã€‚<br>å¦‚æœæœ‰å†™çº¿ç¨‹çš„è¯ï¼Œå°±ä¼šå‡ºç°èµ„æºç«äº‰ä¹Ÿå°±æ˜¯ä¸Šé¢çš„æ— éšœç¢çš„çŠ¶æ€ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿåœ¨æ¯æ¬¡å†™ä¹‹å‰æŠŠæ•°æ®æ‹·è´ä¸€æ¬¡å‰¯æœ¬ï¼Œåœ¨å†™çº¿ç¨‹ä¸­æ‹¿åˆ°å‰¯æœ¬ï¼Œä¿®æ”¹å‰¯æœ¬ï¼Œä¿®æ”¹æ•°æ®çš„è¿‡ç¨‹å¯èƒ½éœ€è¦ç‚¹æ—¶é—´ï¼Œå¯æ˜¯ä¿®æ”¹çš„æ˜¯å‰¯æœ¬ä¸æ˜¯åŸå§‹çš„æ•°æ®ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­çš„è¯»çº¿ç¨‹ä»ç„¶æ˜¯æ— ç­‰å¾…çš„ã€‚å†™çº¿ç¨‹ä¹Ÿåªæ˜¯ä¸€ç›´åœ¨å†™ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æ— ç­‰å¾…çš„ã€‚<br>æœ€åéœ€è¦æ—¶å°±æ˜¯å°†å‰¯æœ¬è¦†ç›–åŸå§‹æ•°æ®è€Œå·²ã€‚</p><h1 id="æœ‰å…³å¹¶è¡Œçš„2ä¸ªé‡è¦å®šå¾‹"><a href="#æœ‰å…³å¹¶è¡Œçš„2ä¸ªé‡è¦å®šå¾‹" class="headerlink" title="æœ‰å…³å¹¶è¡Œçš„2ä¸ªé‡è¦å®šå¾‹"></a>æœ‰å…³å¹¶è¡Œçš„2ä¸ªé‡è¦å®šå¾‹</h1><p>Amdahlå®šå¾‹(é˜¿å§†è¾¾å°”å®šå¾‹)<br>Gustafsonå®šå¾‹(å¤æ–¯å¡”å¤«æ£®)</p><h2 id="Amdahlå®šå¾‹-é˜¿å§†è¾¾å°”å®šå¾‹"><a href="#Amdahlå®šå¾‹-é˜¿å§†è¾¾å°”å®šå¾‹" class="headerlink" title="Amdahlå®šå¾‹(é˜¿å§†è¾¾å°”å®šå¾‹)"></a>Amdahlå®šå¾‹(é˜¿å§†è¾¾å°”å®šå¾‹)</h2><p>â€“ å®šä¹‰äº†ä¸²è¡Œç³»ç»Ÿå¹¶è¡ŒåŒ–åçš„åŠ é€Ÿæ¯”çš„è®¡ç®—å…¬å¼å’Œç†è®ºä¸Šé™ â€“ åŠ é€Ÿæ¯”å®šä¹‰:åŠ é€Ÿæ¯”=ä¼˜åŒ–å‰ç³»ç»Ÿè€—æ—¶/ä¼˜åŒ–åç³»ç»Ÿè€—æ—¶<br><img alt="" data-original="/images/15488604384317.png"></p><p>åœ¨æ­¥éª¤äºŒå’Œæ­¥éª¤äº”çš„åœ°æ–¹è¿ç”¨äº†å¹¶è¡Œ<br>åŠ é€Ÿæ¯”=ä¼˜åŒ–å‰ç³»ç»Ÿè€—æ—¶/ä¼˜åŒ–åç³»ç»Ÿè€—æ—¶=500/400=1.25<br><img alt="" data-original="/images/15488604475199.png"></p><p>å°†ä¸Šé¢çš„ä¾‹å­ä»£å…¥å…¬å¼ï¼šfï¼ˆä¸²è¡Œæ¯”ä¾‹ï¼‰= äº”åˆ†ä¹‹ä¸‰ï¼Œè¿™é‡Œé»˜è®¤ä¸¤ä¸ªcpu<br><img alt="" data-original="/images/15488604582818.png"></p><p>ç”±ä¸Šé¢çš„å…¬å¼å¯ä»¥å¾—å‡ºï¼š<br>å¢åŠ CPUå¤„ç†å™¨çš„æ•°é‡ï¼ˆnï¼‰å¹¶ä¸ä¸€å®šèƒ½èµ·åˆ°æœ‰æ•ˆçš„ä½œç”¨ æé«˜ç³»ç»Ÿå†…å¯å¹¶è¡ŒåŒ–çš„æ¨¡å—æ¯”é‡ï¼Œåˆç†å¢åŠ å¹¶è¡Œå¤„ ç†å™¨æ•°é‡ï¼ˆ1-fï¼‰ï¼Œæ‰èƒ½ä»¥æœ€å°çš„æŠ•å…¥ï¼Œå¾—åˆ°æœ€å¤§çš„åŠ é€Ÿæ¯”</p><h2 id="Gustafsonå®šå¾‹-å¤æ–¯å¡”å¤«æ£®"><a href="#Gustafsonå®šå¾‹-å¤æ–¯å¡”å¤«æ£®" class="headerlink" title="Gustafsonå®šå¾‹(å¤æ–¯å¡”å¤«æ£®)"></a>Gustafsonå®šå¾‹(å¤æ–¯å¡”å¤«æ£®)</h2><p>â€“ è¯´æ˜å¤„ç†å™¨ä¸ªæ•°ï¼Œä¸²è¡Œæ¯”ä¾‹å’ŒåŠ é€Ÿæ¯”ä¹‹é—´çš„å…³ç³»<br><img alt="" data-original="/images/15488604673216.png"></p><p>åªè¦æœ‰è¶³å¤Ÿçš„å¹¶è¡ŒåŒ–ï¼Œé‚£ä¹ˆåŠ é€Ÿ æ¯”å’ŒCPUä¸ªæ•°æˆæ­£æ¯”</p><p>ç»“è®ºï¼šä¸¤ä¸ªç»“è®ºè™½ç„¶ä¸åŒï¼Œä½†æ˜¯æ€»çš„æ¥è¯´å°±æ˜¯è¦å¤„ç†å¥½nï¼ˆcpuçš„ä¸ªæ•°ï¼‰å’Œfï¼ˆä¸²è¡ŒåŒ–æ¯”ä¾‹ï¼‰ï¼Œå› ä¸ºå…¬å¼ä¸­åªå’Œè¿™ä¸¤ä¸ªå‚æ•°æœ‰å…³ç³»ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;h1 id=&quot;ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œ&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆ
      
    
    </summary>
    
      <category term="å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å­¦ä¹ ç¬”è®°" scheme="http://mmmmmm.me/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="é«˜å¹¶å‘" scheme="http://mmmmmm.me/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(å)ï¼Œåšæ–‡åŠ å¯†ï¼Œä¸éœ€è¦æ’ä»¶ï¼Œæç®€æ¨¡å¼ï¼Œç›¸å¯¹å®‰å…¨ï¼Œèåˆpjax</title>
    <link href="http://mmmmmm.me/hexo_shi_jiami.html"/>
    <id>http://mmmmmm.me/hexo_shi_jiami.html</id>
    <published>2018-12-20T14:52:00.000Z</published>
    <updated>2019-01-27T10:12:27.941Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_2.png"></p><blockquote><ul><li>å…³äºnextä¸»é¢˜ä¸­åŠ å…¥åšæ–‡åŠ å¯†åŠŸèƒ½çš„æ–‡ç« ï¼Œæˆ‘å°±æ˜¯æˆ‘ä¸ä¸€æ ·çš„çƒŸç«ã€‚</li></ul></blockquote><a id="more"></a><p>æœæƒ³è‡ªå®šä¹‰åŠŸèƒ½æ ·å¼çš„å¾€ä¸‹é¢çœ‹çœ‹ä¹Ÿè®¸ä¼šæœ‰ç‚¹æ”¶è·ï¼Œä¸ºäº†é¿å…è¯»è€…ä¸è€çƒ¦çš„çœ‹æˆ‘çš„åºŸè¯ï¼Œæ‰€ä»¥ç§»åˆ°äº†ä¸‹é¢ã€‚<br>æœ¬äººåšå®¢ï¼šmmmmmm.me</p><h1 id="æ•ˆæœï¼š"><a href="#æ•ˆæœï¼š" class="headerlink" title="æ•ˆæœï¼š"></a>æ•ˆæœï¼š</h1><p><img alt="upload successful" data-original="/images/my_blog_25.png"></p><h1 id="ä»£ç ï¼š"><a href="#ä»£ç ï¼š" class="headerlink" title="ä»£ç ï¼š"></a>ä»£ç ï¼š</h1><p>/blog/themes/next/layout/_layout.swigï¼Œæ‰¾åˆ°mainæ ‡ç­¾åœ¨åä¸‹ä»£ç å¤„æ·»åŠ è‡ªå®šä¹‰çš„swig<br>_layout.swigï¼š<br></p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"pjax-container"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">main</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">class</span>=<span class="string">"main"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main-inner"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content-wrap"</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> '_third-party/duoshuo-hot-articles.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> '_partials/comments.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> theme.sidebar.display !== 'remove' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> sidebar %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      //è¿™ä¸ªæ˜¯æˆ‘è‡ªå·±å†™çš„swigï¼Œå› ä¸ºéœ€è¦å¾—åˆ°postçš„passwordå‚æ•°ï¼Œåå­—è‡ªå·±éšä¾¿èµ·ã€‚</span></span><br><span class="line"><span class="xml">      //å¦‚æœåšå®¢ä¸­åŠ å…¥äº†pjaxéœ€è¦æ”¾åœ¨pjaxçš„containerä¸­ï¼Œæ¯æ¬¡åˆ·æ–°ä¼šé‡æ–°åŠ è½½containerä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±é»˜è®¤é‡æ–°åŠ è½½æˆ‘ä»¬è¿™ä¸ªç®€å•çš„jsäº†ï¼Œå¦‚æœæ²¡æœ‰åŠ å…¥pjaxçš„è¯ï¼Œä½ç½®å°±ä¸é‡è¦äº†</span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> 'password.swig' %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºswigï¼Œç›®å½•ï¼šthemes/next/layout/password.swigï¼ˆå’Œä¸Šé¢çš„_layout.swigåœ¨åŒçº§ç›®å½•ï¼Œå…·ä½“è·¯å¾„åœ¨ä¸Šé¢çš„includeä¸­å¯ä»¥è‡ªå®šä¹‰çš„ã€‚ï¼‰<br>password.swigï¼š<br></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">//æš‚æ—¶å‚¨å­˜æ–‡ç« ä¸­çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">var</span> div = $('.<span class="keyword">post</span>-body');</span><br><span class="line"><span class="comment">//æš‚æ—¶å‚¨å­˜ç›®å½•çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">var</span> toc=$('.<span class="keyword">post</span>-toc-wrap')</span><br><span class="line">function password() &#123;</span><br><span class="line">  <span class="keyword">if</span>('&#123;&#123; page.password &#125;&#125;')&#123;</span><br><span class="line">  <span class="comment">//å°†æ–‡ç« å†…å®¹åˆ é™¤</span></span><br><span class="line">    div.remove();</span><br><span class="line"> <span class="comment">//å°†ç›®å½•åˆ é™¤ </span></span><br><span class="line">    toc.remove();</span><br><span class="line">  <span class="comment">//å°†æ–‡ç« åˆ é™¤åï¼Œå‘åŸæ¥æ–‡ç« çš„åœ°æ–¹æ·»åŠ ï¼Œåº”è¯¥å‡ºç°çš„æç¤ºç”¨æˆ·è¾“å…¥å¯†ç çš„æ ·å¼</span></span><br><span class="line">  <span class="comment">//ä¸‹é¢è¿™é‡Œçš„ç¬¬ä¸€ä¸ªç”¨textareaæ˜¯å› ä¸ºå¦‚æœåœ¨æ‰‹æœºç«¯çš„æ—¶å€™åªèƒ½æ˜¾ç¤ºä¸€éƒ¨åˆ†æ–‡å­—ï¼Œ</span></span><br><span class="line">  <span class="comment">//åªæ˜¯æ‹“å±•:inputé‡Œé¢çš„å­—åªèƒ½æ˜¾ç¤ºä¸€è¡Œï¼Œä¸ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œç›®å‰ä¸Šç½‘æœç´¢æ²¡æœ‰å‘ç°å¥½çš„åŠæ³•ï¼Œæ‰€ä»¥ç”¨äº†textareaï¼Œå³ä¸‹è§’çš„å°ä¸‰è§’é€šè¿‡resize:none å»æ‰ã€‚</span></span><br><span class="line">   $('.<span class="keyword">post</span>-header').after('&lt;textarea <span class="keyword">class</span>=<span class="string">"description"</span> value=<span class="string">"Please enter your password and press enter to build"</span> style=<span class="string">"border: none;display: block;' +'width: 60%;margin: 0 auto;text-align: center;outline: none;margin-bottom: 50px;resize:none "</span>&gt;</span><br><span class="line">      Please enter your password and press enter to build&lt;/textarea&gt;' +</span><br><span class="line">      '&lt;div <span class="keyword">class</span>=<span class="string">"qiang"</span> style=<span class="string">"height: 100px;width: 60%;margin:0 auto"</span>&gt;' +</span><br><span class="line">      '&lt;<span class="keyword">input</span> <span class="keyword">class</span>=<span class="string">"password"</span>  <span class="keyword">type</span>=<span class="string">"text"</span> value=<span class="string">""</span> style="border: none;<span class="keyword">display</span>: block;border-bottom: 1px solid #ccc;' +</span><br><span class="line">      'margin: 0 auto;outline: none;width:95%"/&gt;' +</span><br><span class="line">      '&lt;/div&gt;')</span><br><span class="line">      <span class="comment">//ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¦‚æœæ˜¯ç‚¹å‡»çš„.password è¿™ä¸ªdivå°±æ”¹å˜æ ·å¼ï¼Œå¦‚æœæ˜¯documentä¸­é™¤äº†divä¹‹å¤–çš„å…¶ä»–ä»»ä½•å…ƒç´ ï¼Œå°±å˜å›åŸæ¥çš„æ ·å¼ã€‚</span></span><br><span class="line">    document.onclick = function (event) &#123;</span><br><span class="line">      <span class="keyword">var</span> <span class="keyword">e</span> = event || <span class="keyword">window</span>.event;</span><br><span class="line">      <span class="keyword">var</span> elem = <span class="keyword">e</span>.srcElement || <span class="keyword">e</span>.target;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (elem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (elem != document) &#123;</span><br><span class="line">          <span class="keyword">if</span> (elem.className == <span class="string">"password"</span>) &#123;</span><br><span class="line">            $(<span class="string">".password"</span>).animate(&#123;paddingTop:<span class="string">"30px"</span>,width:<span class="string">"100%"</span>,borderWidth:<span class="string">"2px"</span>&#125;,300)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          elem = elem.parentNode;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          $(<span class="string">".password"</span>).animate(&#123;paddingTop:<span class="string">"0px"</span>,width:<span class="string">"95%"</span>,borderWidth:<span class="string">"1px"</span>&#125;,300)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç»‘å®šenteré”®æŒ‰ä¸‹åç¦»å¼€çš„äº‹ä»¶</span></span><br><span class="line">    $(document).keyup(function(event)&#123;</span><br><span class="line">      <span class="keyword">if</span>(event.keyCode ==13&amp;&amp;$('.password').length&gt;0)&#123;</span><br><span class="line">        <span class="comment">//console.log($('.password').val())</span></span><br><span class="line">        <span class="comment">//console.log('&#123;&#123; page.password &#125;&#125;')</span></span><br><span class="line">        <span class="keyword">if</span> ($('.password').val() == '&#123;&#123; page.password &#125;&#125;') &#123;</span><br><span class="line">        <span class="comment">//æ¢å¤æ–‡ç« å†…å®¹</span></span><br><span class="line">          (div).appendTo($(<span class="string">".post-header"</span>))</span><br><span class="line">          <span class="comment">//æ¢å¤ç›®å½•</span></span><br><span class="line">          toc.appendTo($(<span class="string">".sidebar-inner"</span>))</span><br><span class="line">                 <span class="comment">//åˆ é™¤æœ¬é¡µé¢çš„è¾“å…¥å¯†ç ç»„ä»¶</span></span><br><span class="line">           $(<span class="string">".description"</span>).remove();</span><br><span class="line">          $(<span class="string">".qiang"</span>).remove();</span><br><span class="line">          $(<span class="string">".password"</span>).remove();</span><br><span class="line">          <span class="comment">//é‡æ–°å¤„ç†pjaxäº‹ä»¶,å¦‚æœæ²¡æœ‰åŠ pjaxçš„ä»ä¸‹é¢è¿™è¡Œèµ·åˆ°ä¸‹é¢çš„elseä¹‹é—´çš„ä»£ç éœ€è¦å»æ‰ã€‚</span></span><br><span class="line">          <span class="comment">//å›¾ç‰‡æ‡’åŠ è½½ï¼Œæ²¡æœ‰åŠ å…¥æ­¤åŠŸèƒ½çš„è¿™ä¸ªå‡½æ•°éœ€è¦å»æ‰</span></span><br><span class="line">          $('img').lazyload(&#123;</span><br><span class="line">             placeholder: '/images/loading.gif',</span><br><span class="line">             effect: 'fadeIn',</span><br><span class="line">             threshold : 100,</span><br><span class="line">             failure_limit : 20,</span><br><span class="line">             skip_invisible : false</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="comment">//pjaxåå‡ºç°æ–‡ç« ä¸æ˜¾ç¤ºï¼Œæ²¡æœ‰pjaxçš„ä¸‹é¢å››è¡Œéœ€è¦å»æ‰</span></span><br><span class="line">            $(<span class="string">".post-block"</span>).css(&#123;opacity:1&#125;);</span><br><span class="line">            $(<span class="string">".post-header"</span>).css(&#123;opacity:1&#125;);</span><br><span class="line">            $(<span class="string">".post-body"</span>).css(&#123;opacity:1&#125;);</span><br><span class="line">            $(<span class="string">".pagination"</span>).css(&#123;opacity:1&#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">          alert(<span class="string">"Sorry, the password is wrong."</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//å°†documentçš„keyupç§»é™¤ï¼Œé˜²æ­¢åœ¨pjaxçš„æƒ…å†µä¸‹ä¼šé‡å¤ç»‘å®šäº‹ä»¶</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">password();</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p></p><p>æ–°å»ºä¸€ä¸ªtest.md<br>test.md<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">æµ‹è¯•</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2019</span><span class="bullet">-03</span><span class="bullet">-30</span> <span class="number">21</span><span class="string">:18:02</span></span><br><span class="line"><span class="attr">password:</span> <span class="string">aaa</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># aaaaaa</span></span><br><span class="line"><span class="string">æˆ‘å°±å¾ˆåæ„Ÿå¤§å®¶è€æ˜¯é‚£ä¹ˆè¯´æˆ‘ï¼Œ</span></span><br><span class="line"><span class="comment">## bbbbbb</span></span><br><span class="line"><span class="string">é™¤äº†æœ‰æ‰ï¼Œå°±åªå‰©ä¸‹é‚£æ— å¯æ¯”æ‹Ÿçš„é¢œå€¼ã€‚</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„passwordåé¢çš„å€¼è‡ªå®šä¹‰ã€‚</p><h1 id="æ³¨æ„ï¼š"><a href="#æ³¨æ„ï¼š" class="headerlink" title="æ³¨æ„ï¼š"></a>æ³¨æ„ï¼š</h1><p>å¦‚æœè‡ªå·±çš„åšå®¢æºç ä¸­çš„è¿™ç¯‡æ–‡ç« ä¸Šä¼ åˆ°githubï¼Œå¯†ç ä¹Ÿå°±å…¬è¯¸äºä¸–äº†ï¼Œå¯ä»¥å†pushåˆ°githubçš„æ—¶å€™å°†è¿™ç¯‡æ–‡ç« å¿½ç•¥ã€‚</p><h1 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h1><p>é¢„ç»™è‡ªå·±åŠ å…¥æ–‡ç« åŠ å¯†çš„åŠŸèƒ½ã€‚</p><h1 id="æ€è·¯ï¼š"><a href="#æ€è·¯ï¼š" class="headerlink" title="æ€è·¯ï¼š"></a>æ€è·¯ï¼š</h1><h2 id="https-www-jianshu-com-p-90c0a15c6f36"><a href="#https-www-jianshu-com-p-90c0a15c6f36" class="headerlink" title="https://www.jianshu.com/p/90c0a15c6f36"></a><a href="https://www.jianshu.com/p/90c0a15c6f36" target="_blank" rel="noopener">https://www.jianshu.com/p/90c0a15c6f36</a></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> &lt;script&gt;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">'&#123;&#123; page.password &#125;&#125;'</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (prompt(<span class="string">'è¯·è¾“å…¥æŸ¥çœ‹å¯†ç '</span>) !== <span class="string">'&#123;&#123; page.password &#125;&#125;'</span>)&#123;</span><br><span class="line">                alert(<span class="string">'å¯†ç ä¸æ­£ç¡®,è¯·è¯¢é—®ä¸»ç¼–å¤§å¤§'</span>);</span><br><span class="line">                history.back();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸ç”¨è¯•çœ‹çœ‹ä¹ŸçŸ¥é“æ²¡é—®é¢˜ï¼Œå¯æ˜¯ç½‘ä¸Šè¯´è¿™ä¸ªå®¹æ˜“è¢«ç ´è§£ï¼Œå› ä¸ºåªæ˜¯åœ¨alertçš„æ—¶å€™ä¸æ˜¾ç¤ºï¼Œä½†æ˜¯æ‡‚ç¼–ç¨‹çš„äººåªè¦æ‰“å¼€å®¡æŸ¥å·¥å…·å°±èƒ½çœ‹åˆ°äº†ã€‚pass</p><h2 id="http-zhailiange-com-2017-07-06-hexo-encrypt"><a href="#http-zhailiange-com-2017-07-06-hexo-encrypt" class="headerlink" title="http://zhailiange.com/2017/07/06/hexo-encrypt/"></a><a href="http://zhailiange.com/2017/07/06/hexo-encrypt/" target="_blank" rel="noopener">http://zhailiange.com/2017/07/06/hexo-encrypt/</a></h2><p>hexo-blog-encryptæ’ä»¶å’Œhexo-encryptæ’ä»¶ï¼ŒåŒæ ·å°è¯•è¿‡ï¼Œå¦‚æœæ²¡æœ‰pjaxè‚¯å®šæ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘åŠ å…¥äº†pjaxåœ¨è·³è½¬é¡µé¢çš„æ—¶å€™æœ‰çš„jsä¼šä¸åŠ è½½ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼Œæ”¾å¼ƒ</p><h2 id="è‡ªå·±å†™"><a href="#è‡ªå·±å†™" class="headerlink" title="è‡ªå·±å†™"></a>è‡ªå·±å†™</h2><p>ä¸€å¼€å§‹é€šè¿‡ç½‘_layout.swigé‡Œé¢å¼•å…¥ scriptçš„æ–¹å¼ï¼Œå¯æ˜¯åœ¨jsæ–‡ä»¶ä¸­æ˜¯çš„ä¸åˆ°hexoè‡ªå®šä¹‰çš„pageå˜é‡çš„ï¼ˆhexoä¸­è¿˜æœ‰å¥½å¤šå˜é‡ï¼Œæ¯”å¦‚siteï¼Œthemeç­‰ï¼‰ï¼Œæ‰€ä»¥åœ¨swigä¸­èƒ½å¤Ÿå¾—åˆ°è¿™ä¸ªå˜é‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ–‡ç« ä¸­çš„passwordï¼Œå½“ç„¶ä½ è¿˜å¯ä»¥è‡ªå®šä¹‰è®¸å¤šå˜é‡ï¼Œæ¯”å¦‚åœ¨configæ–‡ä»¶ä¸­å®šä¹‰æ˜¯å¦ä½¿ç”¨passwordåŠŸèƒ½ï¼Œåœ¨æ–‡ç« ä¸­å¢åŠ messageï¼ˆç®€ç§°å°±æ˜¯è¾“å…¥å¯†ç ä¸Šæ–¹ç»™ç”¨æˆ·è¯´çš„è¯ï¼Œæˆ–è€…æ–‡ç« çš„ç®€å•æ¦‚è¦ç­‰ï¼Œè‡ªå®šä¹‰å³å¯ï¼‰æ ‡ç­¾ï¼Œç„¶åé€šè¿‡jsè¯»åˆ°æœ¬ç¯‡æ–‡ç« çš„messageï¼Œè‡ªå®šä¹‰çš„æ·»åŠ åˆ°é¡µé¢ä¸­å±•ç¤ºç»™ç”¨æˆ·ï¼Œç­‰ç­‰éƒ½å¯ä»¥é€šè¿‡æ¥å¾—åˆ°ã€‚<br>å½“ç„¶è‡ªå·±å†™çš„åˆè¡·å°±æ˜¯å› ä¸ºè‡ªå·±çš„pjaxï¼Œè¿™ä¸‹å­ï¼Œç»ˆäºå¯ä»¥æˆåŠŸçš„å®Œç¾èåˆåˆ°pjaxä¸­ï¼Œè¿˜å­¦åˆ°ä¸å°‘çš„åªæ˜¯å‘¢ã€‚</p><h1 id="2018-12-23ä»£ç æ›´æ–°"><a href="#2018-12-23ä»£ç æ›´æ–°" class="headerlink" title="2018.12.23ä»£ç æ›´æ–°"></a>2018.12.23ä»£ç æ›´æ–°</h1><h2 id="é—®é¢˜ä¸€"><a href="#é—®é¢˜ä¸€" class="headerlink" title="é—®é¢˜ä¸€"></a>é—®é¢˜ä¸€</h2><p>å‘ç°è¾“å…¥å¯†ç æˆåŠŸä¹‹åï¼Œåœ¨é¡µé¢çš„åº•éƒ¨è¿˜æœ‰è¯·è¾“å…¥å¯†ç çš„ç»„ä»¶,åœ¨æ¢å¤æ–‡ç« çš„åé¢åŠ ä¸‹é¢ä¸‰è¡Œï¼ˆå·²åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ›´æ–°ï¼‰<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">".description"</span>).remove();</span><br><span class="line">$(<span class="string">".qiang"</span>).remove();</span><br><span class="line">$(<span class="string">".password"</span>).remove();</span><br></pre></td></tr></table></figure><p></p><h2 id="é—®é¢˜äºŒ"><a href="#é—®é¢˜äºŒ" class="headerlink" title="é—®é¢˜äºŒ"></a>é—®é¢˜äºŒ</h2><p>å› ä¸ºåšå®¢ä¸­åŠ å…¥äº†pjaxï¼Œåœ¨å±€éƒ¨åˆ·æ–°çš„æ—¶å€™ï¼Œ$(document).keyupå¹¶æ²¡æœ‰ç§»é™¤ï¼Œæ‰€ä»¥å½“ç‚¹å‡»æŸæ–‡ç« çš„æ—¶å€™ç¬¬ä¸€æ¬¡æ²¡é—®é¢˜ï¼Œå†ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œå†æ¬¡è¿›å…¥ï¼Œç¬¬äºŒæ¬¡è¿›å…¥çš„æ—¶å€™æ˜¯é€šè¿‡pjaxè¿›å…¥çš„ï¼Œè¿™æ ·å°±ç»™$(document)ç»‘å®šäº†ä¸¤æ¬¡keyupäº‹ä»¶ï¼Œç¬¬ä¸‰æ¬¡çš„è¯å°±ä¼šç»‘å®šä¸‰æ¬¡ï¼Œç¬¬å››æ¬¡ç»‘å®šå››æ¬¡ï¼Œå¦‚æ­¤å¾€å¤ï¼Œå‡ºç°çš„ç°è±¡æ˜¯å‰å‡ æ¬¡æŠ¥å¯†ç é”™è¯¯ï¼Œæœ€åä¸€æ¬¡è¿›å…¥æ­£å¸¸ï¼Œè°ƒè¯•çš„æ—¶å€™å‰å‡ æ¬¡å¾—åˆ°çš„passwordçš„valueå€¼éƒ½æ˜¯undifined<br>è§£å†³ï¼š<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="built_in">document</span>).unbind(<span class="string">'keyup'</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p></p><p>åœ¨æ¯æ¬¡pjaxå‘é€è¯·æ±‚å¼€å§‹å°±ç§»é™¤äº‹ä»¶ã€‚</p><h2 id="é—®é¢˜ä¸‰"><a href="#é—®é¢˜ä¸‰" class="headerlink" title="é—®é¢˜ä¸‰"></a>é—®é¢˜ä¸‰</h2><p>å½“è¾“å…¥å¯†ç è¿›å…¥é¡µé¢ï¼ŒæŒ‰å›è½¦é”®ä¼šä¸æ–­çš„alert å¯†ç é”™è¯¯<br>åŠ å…¥åˆ¤æ–­ï¼ˆä¸Šé¢å·²ç»ä¿®æ”¹ï¼‰<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;&amp;$(<span class="string">'.password'</span>).length&gt;<span class="number">0</span></span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_2.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;å…³äºnextä¸»é¢˜ä¸­åŠ å…¥åšæ–‡åŠ å¯†åŠŸèƒ½çš„æ–‡ç« ï¼Œæˆ‘å°±æ˜¯æˆ‘ä¸ä¸€æ ·çš„çƒŸç«ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(ä¹)ï¼Œç»™åšå®¢åŠ å…¥ä¸»é¢˜ï¼ŒæŠ¤çœ¼ä¸»é¢˜ï¼ŒæŠ¤çœ¼è‰²</title>
    <link href="http://mmmmmm.me/hexo_jiu_eye.html"/>
    <id>http://mmmmmm.me/hexo_jiu_eye.html</id>
    <published>2018-12-18T12:37:00.000Z</published>
    <updated>2019-01-27T10:11:54.400Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_1.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥ä¿æŠ¤çœ¼ç›çš„æŠ¤çœ¼è‰²çš„åŠŸèƒ½ï¼Œåšè‡ªå·±çš„è´´å¿ƒå°æ£‰è¢„å§ã€‚</li></ul></blockquote><a id="more"></a><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æˆ‘ä»å°çˆ±æ‰“æ¸¸æˆï¼Œæ‰€ä»¥è§†åŠ›ä¸‹é™å‰å®³ï¼ŒåŠ ä¸Šç°åœ¨å·¥ä½œå¤©å¤©å¯¹ç€ç”µè„‘ï¼Œæ‰€ä»¥æƒ³ç»™è‡ªå·±çš„åšå®¢åŠ ä¸ŠæŠ¤çœ¼è‰²ã€‚</p><h1 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h1><p>åšå®¢ï¼šmmmmmm.me</p><p><img alt="upload successful" data-original="/images/my_blog_23.png"></p><p><img alt="upload successful" data-original="/images/my_blog_24.png"></p><h1 id="ç "><a href="#ç " class="headerlink" title="ç "></a>ç </h1><h2 id="layout-swig"><a href="#layout-swig" class="headerlink" title="_layout.swig"></a>_layout.swig</h2><p>åœ¨bodyä¸‹é¢<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"eye"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"eye1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"background-color:#C7EDCC"</span>&gt;</span>è±†æ²™ç»¿<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"background-color:#FAF9DE"</span>&gt;</span>æä»é»„ <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"background-color:#FFFFFF"</span>&gt;</span>é“¶æ²³ç™½<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">"background-color:#000000"</span>&gt;</span>æå…‰é»‘<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"eye2"</span>&gt;</span>æ»¡å¤©æ˜Ÿ<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h2 id="custom-styl"><a href="#custom-styl" class="headerlink" title="custom.styl"></a>custom.styl</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.eye</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">68px</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">height</span>: <span class="number">66px</span>;</span><br><span class="line">  <span class="comment">//background-color:transparent;</span></span><br><span class="line">  <span class="attribute">font-size</span> :<span class="number">12px</span>;</span><br><span class="line"><span class="attribute">line-height</span> :<span class="number">33px</span>;</span><br><span class="line">  <span class="attribute">text-align</span> :center;</span><br><span class="line">  <span class="attribute">z-index</span> :<span class="number">99</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.eye1</span>&#123;</span><br><span class="line">    <span class="attribute">float</span> :left;</span><br><span class="line"><span class="attribute">display</span> :none;</span><br><span class="line">  <span class="attribute">height</span> :<span class="number">50px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.eye1</span> <span class="selector-tag">ul</span> &#123;</span><br><span class="line">  <span class="attribute">height</span> :<span class="number">50px</span>;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">padding</span> :<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span> :<span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">.eye1 ul li&#123;</span><br><span class="line">  float :left;</span><br><span class="line">  <span class="attribute">width</span> :<span class="number">23px</span>;</span><br><span class="line">  <span class="attribute">line-height</span> :<span class="number">22px</span></span><br><span class="line">  text-align :center;</span><br><span class="line">  <span class="attribute">font-size</span> :<span class="number">12px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.eye1</span> <span class="selector-tag">ul</span> <span class="selector-tag">li</span>:hover &#123;</span><br><span class="line">  <span class="attribute">border-bottom</span> : <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">  -webkit-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">  -moz-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">  -ms-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">  -o-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">  <span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.eye2</span>&#123;</span><br><span class="line">  <span class="attribute">float</span> :left;</span><br><span class="line">  <span class="attribute">width</span> :<span class="number">18px</span>;</span><br><span class="line">  <span class="attribute">line-height</span> :<span class="number">22px</span></span><br><span class="line">  text-align :center;</span><br><span class="line">  <span class="attribute">font-size</span> :<span class="number">12px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>:<span class="number">#e6e6e6</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">  <span class="selector-class">.eye2</span>:hover&#123;</span><br><span class="line">    <span class="attribute">border-bottom</span> : <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#eee</span>;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">    -moz-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">    -ms-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">    -o-<span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">    <span class="attribute">transform</span>: scale(<span class="number">1.1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="eye-js"><a href="#eye-js" class="headerlink" title="eye.js"></a>eye.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">eye</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  $(<span class="string">".eye .eye2"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">".eye .eye1"</span>).slideToggle();</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  $(<span class="string">".eye ul li"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">".eye .eye1"</span>).slideToggle();</span><br><span class="line">    $color=$(<span class="keyword">this</span>).css(<span class="string">"background-color"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log($color);</span><br><span class="line">    $(<span class="string">".eye .eye1"</span>).css(<span class="string">"background"</span>,$color);</span><br><span class="line">      $(<span class="string">"#canvas"</span>).css(<span class="string">"background"</span>,$color);</span><br><span class="line">      $(<span class="string">"article"</span>).css(<span class="string">"background"</span>,$color);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">eye()</span><br></pre></td></tr></table></figure><h1 id="å¼•ç”¨eye-js"><a href="#å¼•ç”¨eye-js" class="headerlink" title="å¼•ç”¨eye.js"></a>å¼•ç”¨eye.js</h1><h2 id="ç›´æ¥å¼•ç”¨"><a href="#ç›´æ¥å¼•ç”¨" class="headerlink" title="ç›´æ¥å¼•ç”¨"></a>ç›´æ¥å¼•ç”¨</h2><p>åœ¨_layout.swig<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"xxxxxxxxxx.eye.js"</span>&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><p></p><p>æ²¡æœ‰ç”¨åˆ°require.jså’Œpjaxçš„åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç”¨äº†çš„å¾€ä¸‹çœ‹</p><hr><h2 id="main-js"><a href="#main-js" class="headerlink" title="main.js"></a>main.js</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">  paths: &#123;</span><br><span class="line">    <span class="string">"eye"</span>:<span class="string">"/js/src/pjax/eye"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>([<span class="string">'eye'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="pjaxçš„å‡½æ•°ä¸­é‡å†™"><a href="#pjaxçš„å‡½æ•°ä¸­é‡å†™" class="headerlink" title="pjaxçš„å‡½æ•°ä¸­é‡å†™"></a>pjaxçš„å‡½æ•°ä¸­é‡å†™</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eye_js</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  $color=$(<span class="string">"#canvas"</span>).css(<span class="string">"background"</span>);</span><br><span class="line">  $(<span class="string">"article"</span>).css(<span class="string">"background"</span>,$color);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_1.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥ä¿æŠ¤çœ¼ç›çš„æŠ¤çœ¼è‰²çš„åŠŸèƒ½ï¼Œåšè‡ªå·±çš„è´´å¿ƒå°æ£‰è¢„å§ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(å…«)ï¼Œå¾®åŠ é€Ÿ</title>
    <link href="http://mmmmmm.me/hexo_ba_jiasu.html"/>
    <id>http://mmmmmm.me/hexo_ba_jiasu.html</id>
    <published>2018-12-18T12:32:00.000Z</published>
    <updated>2019-01-27T09:48:42.788Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_3.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜åŠ é€Ÿçš„å°ç»†èŠ‚çš„æ–‡ç« ï¼Œå¥½å§æˆ‘æ‰¿è®¤æ•ˆæœä¸æ˜¯å¾ˆæ˜æ˜¾ã€‚</li></ul></blockquote><a id="more"></a><p>é€šè¿‡ä¸æ–­åœ°ä¸Šç½‘æŸ¥èµ„æ–™ï¼Œå¼•ç”¨çš„jsã€cssã€å›¾ç‰‡æ–‡ä»¶ï¼Œé€šè¿‡cdnçš„æ–¹å¼æ˜¯æ¯”ç›´æ¥æ”¾åˆ°æœ¬åœ°è¦æ…¢çš„ï¼Œæ‰€ä»¥å°†è‡ªå·±åšå®¢èƒ½æ‰¾åˆ°çš„cdnå…¨éƒ¨æ¢æˆæœ¬åœ°æ–‡ä»¶ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_3.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜åŠ é€Ÿçš„å°ç»†èŠ‚çš„æ–‡ç« ï¼Œå¥½å§æˆ‘æ‰¿è®¤æ•ˆæœä¸æ˜¯å¾ˆæ˜æ˜¾ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(ä¸ƒ)ï¼ŒcdnåŠ é€Ÿ</title>
    <link href="http://mmmmmm.me/hexo_qi_cdn.html"/>
    <id>http://mmmmmm.me/hexo_qi_cdn.html</id>
    <published>2018-12-18T12:27:00.000Z</published>
    <updated>2019-01-27T09:48:52.453Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_4.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥cdnçš„æ–‡ç« ï¼Œåƒä¸‡åˆ«ç‚¹å¼€ï¼Œåˆ«æ€ªæˆ‘æ²¡æé†’ä½ ï¼Œå™¢ã€‚</li></ul></blockquote><a id="more"></a><h1 id="æ³¨ï¼š"><a href="#æ³¨ï¼š" class="headerlink" title="æ³¨ï¼š"></a>æ³¨ï¼š</h1><p>åƒä¸‡ä¸è¦è¢«æˆ‘çš„æ ‡é¢˜è¿·æƒ‘ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªç»™åšå®¢åŠ cdnçš„åšæ–‡ã€‚</p><h1 id="æ­£é¢˜ï¼š"><a href="#æ­£é¢˜ï¼š" class="headerlink" title="æ­£é¢˜ï¼š"></a>æ­£é¢˜ï¼š</h1><p>æƒ³ç»™ç½‘ç«™å„ç§åŠ é€Ÿï¼Œç»ˆäºåˆ°äº†cdnè¿™å—ã€‚</p><h2 id="å…è´¹cdn"><a href="#å…è´¹cdn" class="headerlink" title="å…è´¹cdn"></a>å…è´¹cdn</h2><p>â€œå…è´¹çš„éƒ½æ˜¯æœ€è´µçš„â€ï¼Œç™¾åº¦çš„ç§»åŠ¨èŠ‚ç‚¹ä¸èƒ½ç”¨ï¼Œè¿˜æœ‰å¾ˆå¤šéƒ½æ˜¯å•èŠ‚ç‚¹ï¼Œå¾ˆå¤šéƒ½æ˜¯è‡ªå·±èƒ½è®¿é—®ï¼Œæœ‰çš„åœ°åŒºå°±è®¿é—®ä¸åˆ°ï¼Œåªæœ‰æ”¶è´¹æ‰èƒ½æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œéƒ½æ˜¯æ‰“ç€å…è´¹çš„å¹Œå­ï¼Œå˜ç›¸çš„æ”¶è´¹ï¼Œé‚æ”¾å¼ƒã€‚</p><h2 id="æ”¶è´¹cdn"><a href="#æ”¶è´¹cdn" class="headerlink" title="æ”¶è´¹cdn"></a>æ”¶è´¹cdn</h2><p>æœ‰ç‚¹è´µï¼Œè²Œä¼¼100æˆ–è€…200 1Mb/s,å¯¹äºæˆ‘çš„å°blogæœ‰ç‚¹è´µï¼Œä»¥åæµé‡å¤šäº†è‚¯å®šä¼šæ¥å…¥çš„ï¼Œç»è¿‡å‰é¢çš„ä¼˜åŒ–ï¼Œæ„Ÿè§‰é€Ÿåº¦å·²ç»ä¸Šå‡äº†ä¸€å¤§æˆªäº†ï¼Œå¸Œæœ›ä»¥åæœ‰æœºä¼šæå¤§å‹ç½‘ç«™ï¼Œè¿™æ ·å°±å¯ä»¥ä¸èŠ±è‡ªå·±çš„é’±ç©cdnäº†ï¼Œååå“’~</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_4.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥cdnçš„æ–‡ç« ï¼Œåƒä¸‡åˆ«ç‚¹å¼€ï¼Œåˆ«æ€ªæˆ‘æ²¡æé†’ä½ ï¼Œå™¢ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(å…­)ï¼Œä½¿ç”¨hexo-neatæ’ä»¶å‹ç¼©é¡µé¢ï¼Œå¤§å¹…åº¦æå‡é¡µé¢æ€§èƒ½å’Œå“åº”é€Ÿåº¦</title>
    <link href="http://mmmmmm.me/hexo_liu_yasuo.html"/>
    <id>http://mmmmmm.me/hexo_liu_yasuo.html</id>
    <published>2018-12-18T12:20:00.000Z</published>
    <updated>2019-01-27T09:49:02.572Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_5.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥å‘å¸ƒå‹ç¼©çš„æ’ä»¶ï¼Œæ˜¯ä¸æ˜¯é€Ÿåº¦åˆä¸Šäº†ä¸€ä¸ªå°é˜¶ï¼Ÿè¿˜æœ‰seiï¼Ÿ</li></ul></blockquote><a id="more"></a><h1 id="éš†é‡æ„Ÿè°¢ï¼š"><a href="#éš†é‡æ„Ÿè°¢ï¼š" class="headerlink" title="éš†é‡æ„Ÿè°¢ï¼š"></a>éš†é‡æ„Ÿè°¢ï¼š</h1><p><a href="https://blog.csdn.net/lewky_liu/article/details/82432003" target="_blank" rel="noopener">https://blog.csdn.net/lewky_liu/article/details/82432003</a><br><a href="https://blog.csdn.net/qq_21808961/article/details/84639472" target="_blank" rel="noopener">https://blog.csdn.net/qq_21808961/article/details/84639472</a></p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>hexo çš„æ–‡ç« æ˜¯é€šè¿‡mdæ ¼å¼çš„æ–‡ä»¶ç»è¿‡swigè½¬æ¢æˆçš„htmlï¼Œç”Ÿæˆçš„htmlä¼šæœ‰å¾ˆå¤šç©ºæ ¼ï¼Œè€Œä¸”è‡ªå·±å†™çš„jsä»¥åŠcssä¸­ä¼šæœ‰å¾ˆå¤šçš„ç©ºæ ¼å’Œæ³¨é‡Šã€‚<br>jså’Œjavaä¸ä¸€æ ·ï¼Œæ³¨é‡Šä¹Ÿä¼šå½±å“ä¸€éƒ¨åˆ†çš„æ€§èƒ½ï¼Œç©ºæ ¼åŒæ ·æ˜¯çš„ã€‚<br>ç»è¿‡ä¸Šç½‘æŸ¥é˜…ï¼Œå‘ç°hexoæœ‰è‡ªå¸¦çš„å‹ç¼©æ’ä»¶ã€‚</p><h1 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h1><h2 id="è¯•æ°´"><a href="#è¯•æ°´" class="headerlink" title="è¯•æ°´"></a>è¯•æ°´</h2><p>gulp<br>ä¸Šç½‘æŸ¥é˜…èµ„æ–™ï¼Œè‡ªå·±å°è¯•è¿‡ã€‚<br>npmä¸‹è½½æ’ä»¶éƒ½ä¸‹è½½ä¸­æ–­äº†ï¼Œå¯èƒ½æˆ‘æ“ä½œæœ‰è¯¯ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•ä¸€è¯•ã€‚</p><h2 id="æˆåŠŸçš„æ¡ˆä¾‹"><a href="#æˆåŠŸçš„æ¡ˆä¾‹" class="headerlink" title="æˆåŠŸçš„æ¡ˆä¾‹"></a>æˆåŠŸçš„æ¡ˆä¾‹</h2><h3 id="å®‰è£…æ’ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚"><a href="#å®‰è£…æ’ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚" class="headerlink" title="å®‰è£…æ’ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚"></a>å®‰è£…æ’ä»¶ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-neat <span class="comment">--save</span></span><br></pre></td></tr></table></figure><h3 id="hexo-config-ymlæ–‡ä»¶æ·»åŠ "><a href="#hexo-config-ymlæ–‡ä»¶æ·»åŠ " class="headerlink" title="hexo _config.ymlæ–‡ä»¶æ·»åŠ "></a>hexo _config.ymlæ–‡ä»¶æ·»åŠ </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hexo-neat</span></span><br><span class="line"><span class="comment"># åšæ–‡å‹ç¼©</span></span><br><span class="line"><span class="attr">neat_enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># å‹ç¼©html</span></span><br><span class="line"><span class="attr">neat_html:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  exclude:</span></span><br><span class="line"><span class="comment"># å‹ç¼©css  </span></span><br><span class="line"><span class="attr">neat_css:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  exclude:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'**/*.min.css'</span></span><br><span class="line"><span class="comment"># å‹ç¼©js</span></span><br><span class="line"><span class="attr">neat_js:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  mangle:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  output:</span></span><br><span class="line"><span class="attr">  compress:</span></span><br><span class="line"><span class="attr">  exclude:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'**/*.min.js'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'**/jquery.fancybox.pack.js'</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'**/index.js'</span></span><br></pre></td></tr></table></figure><h3 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h3><h4 id="è·³è¿‡å‹ç¼©æ–‡ä»¶çš„æ­£ç¡®é…ç½®æ–¹å¼"><a href="#è·³è¿‡å‹ç¼©æ–‡ä»¶çš„æ­£ç¡®é…ç½®æ–¹å¼" class="headerlink" title="è·³è¿‡å‹ç¼©æ–‡ä»¶çš„æ­£ç¡®é…ç½®æ–¹å¼"></a>è·³è¿‡å‹ç¼©æ–‡ä»¶çš„æ­£ç¡®é…ç½®æ–¹å¼</h4><p>å¦‚æœæŒ‰ç…§å®˜æ–¹æ’ä»¶çš„æ–‡æ¡£è¯´æ˜æ¥é…ç½®excludeï¼Œä½ ä¼šå‘ç°å®Œå…¨ä¸èµ·ä½œç”¨ã€‚è¿™æ˜¯å› ä¸ºé…ç½®çš„æ–‡ä»¶è·¯å¾„ä¸å¯¹ï¼Œå‹ç¼©æ—¶æ‰¾ä¸åˆ°ä½ é…ç½®çš„æ–‡ä»¶ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•è·³è¿‡äº†ã€‚ä½ éœ€è¦ç»™è¿™äº›æ–‡ä»¶æŒ‡å®šæ­£ç¡®çš„è·¯å¾„ï¼Œä¸‡èƒ½çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š<br>neat_css:<br>enable: true<br>exclude:</p><pre><code>- &apos;**/*.min.css&apos;</code></pre><h4 id="å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡-mdæ–‡ä»¶"><a href="#å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡-mdæ–‡ä»¶" class="headerlink" title="å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡.mdæ–‡ä»¶"></a>å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡.mdæ–‡ä»¶</h4><p>.mdæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬å†™æ–‡ç« æ—¶çš„markdownæ–‡ä»¶ï¼Œå¦‚æœè·³è¿‡å‹ç¼©.mdæ–‡ä»¶ï¼Œè€Œä½ åˆåˆšå¥½åœ¨æ–‡ç« ä¸­ä½¿ç”¨åˆ°äº†NexTè‡ªå¸¦çš„tabæ ‡ç­¾ï¼Œé‚£ä¹ˆå½“hexoåœ¨ç”Ÿæˆé™æ€é¡µé¢æ—¶å°±ä¼šå‘ç”Ÿè§£æé”™è¯¯ã€‚è¿™ä¼šå¯¼è‡´ä½¿ç”¨åˆ°äº†tabæ ‡ç­¾çš„é¡µé¢ç”Ÿæˆå¤±è´¥è€Œæ— æ³•è®¿é—®ã€‚</p><h4 id="å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡-swigæ–‡ä»¶"><a href="#å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡-swigæ–‡ä»¶" class="headerlink" title="å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡.swigæ–‡ä»¶"></a>å‹ç¼©htmlæ—¶ä¸è¦è·³è¿‡.swigæ–‡ä»¶</h4><p>.swigæ–‡ä»¶æ˜¯æ¨¡æ¿å¼•æ“æ–‡ä»¶ï¼Œç®€å•çš„è¯´hexoå¯ä»¥é€šè¿‡è¿™äº›æ–‡ä»¶æ¥ç”Ÿæˆå¯¹åº”çš„é¡µé¢ã€‚å¦‚æœè·³è¿‡è¿™äº›æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°†ä¼šå‘ç°ï¼Œä½ çš„æ‰€æœ‰é¡µé¢å®Œå…¨æ²¡æœ‰èµ·åˆ°å‹ç¼©çš„æ•ˆæœï¼Œé¡µé¢æºä»£ç é‡Œä¾ç„¶å­˜åœ¨ç€ä¸€å¤§å †ç©ºç™½ã€‚</p><h4 id="ç‚¹å‡»çš„æ¡ƒå¿ƒæ•ˆæœæ¶ˆå¤±"><a href="#ç‚¹å‡»çš„æ¡ƒå¿ƒæ•ˆæœæ¶ˆå¤±" class="headerlink" title="ç‚¹å‡»çš„æ¡ƒå¿ƒæ•ˆæœæ¶ˆå¤±"></a>ç‚¹å‡»çš„æ¡ƒå¿ƒæ•ˆæœæ¶ˆå¤±</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># å‹ç¼©js</span><br><span class="line">neat_js:</span><br><span class="line">  enable: true</span><br><span class="line">  mangle: true</span><br><span class="line">  output:</span><br><span class="line">  compress:</span><br><span class="line">  exclude:</span><br><span class="line">    -<span class="ruby"> <span class="string">'**/*.min.js'</span></span></span><br><span class="line"><span class="ruby">    - <span class="string">'**/jquery.fancybox.pack.js'</span></span></span><br><span class="line"><span class="ruby">    - <span class="string">'**/index.js'</span>  </span></span><br><span class="line"><span class="ruby">    - <span class="string">'**/love.js'</span></span></span><br></pre></td></tr></table></figure><h4 id="gitalk-jsæ–‡ä»¶æŠ¥é”™"><a href="#gitalk-jsæ–‡ä»¶æŠ¥é”™" class="headerlink" title="gitalk jsæ–‡ä»¶æŠ¥é”™"></a>gitalk jsæ–‡ä»¶æŠ¥é”™</h4><p>åœ¨ä¸Šé¢çš„ä»£ç åº•éƒ¨åŠ å…¥å¦‚ä¸‹ä»£ç </p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="string">'**/comments.gitalk.js'</span></span></span><br></pre></td></tr></table></figure><h4 id="jquery-pjax-min-jsæŠ¥é”™"><a href="#jquery-pjax-min-jsæŠ¥é”™" class="headerlink" title="jquery pjax min jsæŠ¥é”™"></a>jquery pjax min jsæŠ¥é”™</h4><p>æˆ‘è¿™é‡Œçš„ jquery pjax min jsæ˜¯æŒ‡çš„åŠ å…¥pjaxå‰éœ€è¦ä»¥æ¥çš„ä¸¤ä¸ªcdnæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯jqï¼Œä¸€ä¸ªæ˜¯å®ƒï¼Œæˆ‘å°†å®ƒä¸‹è½½åˆ°äº†æœ¬åœ°ï¼Œä¸è¦åœ¨æ„è¿™äº›ç»†èŠ‚~<br>åŒæ ·åŠ å…¥å¦‚ä¸‹ä»£ç <br></p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> <span class="string">'**/jquery_pjax_min_js.js'</span></span></span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_5.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥å‘å¸ƒå‹ç¼©çš„æ’ä»¶ï¼Œæ˜¯ä¸æ˜¯é€Ÿåº¦åˆä¸Šäº†ä¸€ä¸ªå°é˜¶ï¼Ÿè¿˜æœ‰seiï¼Ÿ&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(äº”)ï¼Œè¯„è®ºç³»ç»Ÿæ¢æˆgittalk</title>
    <link href="http://mmmmmm.me/hexo_wu_gitalk.html"/>
    <id>http://mmmmmm.me/hexo_wu_gitalk.html</id>
    <published>2018-12-18T12:19:00.000Z</published>
    <updated>2019-01-27T09:49:14.017Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_6.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥gitalkè¯„è®ºç³»ç»Ÿçš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢çš„æ¥å®¢å¦‚æ±Ÿæ°´æ»”æ»”è¿ç»µä¸ç»ï¼Œåˆå¦‚é»„æ²³ä¹‹æ°´ä¸€å‘ä¸å¯æ”¶æ‹¾ã€‚</li></ul></blockquote><a id="more"></a><h1 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h1><p>ä¹‹å‰ä¸€ç›´ç”¨çš„æ˜¯æ¥å¿…åŠ›çš„è¯„è®ºç³»ç»Ÿï¼Œè¿˜ä¸é”™ï¼Œä½†æ˜¯å› ä¸ºæˆ‘åŠ å…¥äº†pjaxï¼Œèƒ½åŠ›æœ‰é™ï¼Œè™½ç„¶é™æ¥å¿…åŠ›çš„jsé‡ç°ï¼Œä½†æ˜¯æ¯æ¬¡è¿”å›åˆ°é¦–é¡µéƒ½ä¼šæŠ¥é”™id notfound ï¼Œé˜…è¯»äº†æ¥å¿…åŠ›çš„apiï¼Œå…¨æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ°å¾ˆå¤šå¥½çš„ç­”æ¡ˆã€‚é‚æ¢æˆgittalkçš„è¯„è®ºç³»ç»Ÿã€‚</p><h1 id="å¼€å§‹ï¼š"><a href="#å¼€å§‹ï¼š" class="headerlink" title="å¼€å§‹ï¼š"></a>å¼€å§‹ï¼š</h1><h2 id="æ–°å»ºcomments-git-js"><a href="#æ–°å»ºcomments-git-js" class="headerlink" title="æ–°å»ºcomments_git.js"></a>æ–°å»ºcomments_git.js</h2><p>æ³¨ï¼šé…ç½®æ–‡ä»¶ä¸­çš„è¯¦ç»†ï¼Œè‡ªå·±ç½‘ä¸ŠæŸ¥æŸ¥ã€‚<br></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span>($(<span class="string">'#gitalk-container'</span>).length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">  var gitalk = <span class="keyword">new</span> Gitalk(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gitalkçš„ä¸»è¦å‚æ•°</span></span><br><span class="line"><span class="string">clientID:</span> `Github Application clientID`,</span><br><span class="line"><span class="string">clientSecret:</span> `Github Application clientSecret`,</span><br><span class="line"><span class="string">repo:</span> `Github ä»“åº“å`,<span class="comment">//å­˜å‚¨ä½ è¯„è®º issue çš„ Github ä»“åº“åï¼ˆå»ºè®®ç›´æ¥ç”¨ GitHub Page çš„ä»“åº“åï¼‰</span></span><br><span class="line"><span class="string">owner:</span> <span class="string">'Github ç”¨æˆ·å'</span>,</span><br><span class="line"><span class="string">admin:</span> [<span class="string">'Github ç”¨æˆ·å'</span>], <span class="comment">//è¿™ä¸ªä»“åº“çš„ç®¡ç†å‘˜ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨æ•°ç»„è¡¨ç¤ºï¼Œä¸€èˆ¬å†™è‡ªå·±,</span></span><br><span class="line"><span class="string">id:</span> <span class="string">'window.location.pathname'</span>, <span class="comment">//é¡µé¢çš„å”¯ä¸€æ ‡è¯†ï¼Œgitalk ä¼šæ ¹æ®è¿™ä¸ªæ ‡è¯†è‡ªåŠ¨åˆ›å»ºçš„issueçš„æ ‡ç­¾,æˆ‘ä»¬ä½¿ç”¨é¡µé¢çš„ç›¸å¯¹è·¯å¾„ä½œä¸ºæ ‡è¯†</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">  gitalk.render(<span class="string">'gitalk-container'</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="æ‰¾åˆ°comments-swigåœ¨æœ€åä¸€ä¸ªendifä¹‹å‰"><a href="#æ‰¾åˆ°comments-swigåœ¨æœ€åä¸€ä¸ªendifä¹‹å‰" class="headerlink" title="æ‰¾åˆ°comments.swigåœ¨æœ€åä¸€ä¸ªendifä¹‹å‰"></a>æ‰¾åˆ°comments.swigåœ¨æœ€åä¸€ä¸ªendifä¹‹å‰</h2><p>ï¼ˆç›®å½•ï¼šthemes/next/layout/_partials/comments.swigï¼‰<br></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="built_in">id</span>=<span class="string">"gitalk-container"</span>&gt;&lt;/<span class="keyword">div</span>&gt;</span><br></pre></td></tr></table></figure><p></p><h2 id="å¼•å…¥ä»£ç "><a href="#å¼•å…¥ä»£ç " class="headerlink" title="å¼•å…¥ä»£ç "></a>å¼•å…¥ä»£ç </h2><p>_layour.swig<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/comments/comments.gitalk.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨è¿™é‡Œå¼•å…¥è€Œä¸å†requireå¼•å…¥çš„åŸå› ï¼Œå°±åƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼Œdefineåªèƒ½å®šä¹‰ä¸€æ¬¡ï¼Œå¼•ä¸è¿›å»ã€‚<br>main.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">  paths: &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">"music"</span>: <span class="string">"/dist/music"</span>,</span><br><span class="line">    <span class="string">"aplayer"</span>: <span class="string">"/js/src/aplayer"</span>,</span><br><span class="line">    <span class="string">"backgroudLine"</span>: <span class="string">"/js/src/backgroudLine"</span>,</span><br><span class="line">    <span class="string">"category"</span>: <span class="string">"/js/src/category"</span>,</span><br><span class="line">    <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">    <span class="comment">/*ä¸æ˜¾ç¤ºå›¾æ ‡çš„è¯æ›¿æ¢fonts*/</span></span><br><span class="line">    <span class="string">"share"</span>:<span class="string">"/js/src/pjax/share"</span>,</span><br><span class="line">    <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span>,</span><br><span class="line">    <span class="string">"comments"</span>:<span class="string">"/js/src/pjax/comments_git"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  shim: &#123;</span><br><span class="line">    <span class="string">'share'</span>: &#123;</span><br><span class="line">      deps: [</span><br><span class="line">        <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'comments'</span>: &#123;</span><br><span class="line">      deps: [</span><br><span class="line">        <span class="string">'css!https://unpkg.com/gitalk/dist/gitalk'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>([<span class="string">'backgroudLine'</span>,<span class="string">'music'</span>,<span class="string">'aplayer'</span>,<span class="string">'category'</span>,<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>,<span class="string">'comments'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœæ²¡æœ‰ç”¨requireçš„ç›´æ¥åœ¨_layout.swig<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://imsun.github.io/gitment/style/default.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://imsun.github.io/gitment/dist/gitment.browser.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">//å†å¼•å…¥comments_git.js</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"xxxxxxxxxx/comments_git.js"</span>&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><p></p><h1 id="pjaxåŠ å…¥gitalk"><a href="#pjaxåŠ å…¥gitalk" class="headerlink" title="pjaxåŠ å…¥gitalk"></a>pjaxåŠ å…¥gitalk</h1><p>åŒæ ·é‡æ–°è°ƒç”¨comments_git.jså³å¯</p><h1 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h1><h2 id="æ‰€æœ‰çš„é¡µé¢å…±äº«çš„ä¸€ä¸ªè¯„è®ºissue"><a href="#æ‰€æœ‰çš„é¡µé¢å…±äº«çš„ä¸€ä¸ªè¯„è®ºissue" class="headerlink" title="æ‰€æœ‰çš„é¡µé¢å…±äº«çš„ä¸€ä¸ªè¯„è®ºissue"></a>æ‰€æœ‰çš„é¡µé¢å…±äº«çš„ä¸€ä¸ªè¯„è®ºissue</h2><p>è¿™ä¸ªå¥½åƒåˆ°ç°åœ¨çš„ç‰ˆæœ¬ï¼Œäººå®¶å·²ç»ä¼˜åŒ–çš„å¾ˆå¥½äº†ã€‚<br>æ³¨æ„ä¸Šå¹´çš„comments_git.js<br>ä¸­çš„é…ç½®id æ”¹ä¸ºlocation.pathnameï¼Œå³<br></p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">id:</span><span class="string"> location.pathname</span></span><br></pre></td></tr></table></figure><p></p><p>æ„æ€æ˜¯ï¼Œæ ¹æ®ç›®å½•åˆ›å»ºä¸åŒçš„iss</p><h2 id="æœ¬åœ°4000å¯åŠ¨æŠ¥é”™401-æ²¡æœ‰æƒé™"><a href="#æœ¬åœ°4000å¯åŠ¨æŠ¥é”™401-æ²¡æœ‰æƒé™" class="headerlink" title="æœ¬åœ°4000å¯åŠ¨æŠ¥é”™401 æ²¡æœ‰æƒé™"></a>æœ¬åœ°4000å¯åŠ¨æŠ¥é”™401 æ²¡æœ‰æƒé™</h2><p>pushåˆ°è¿œç«¯å°±æ²¡é—®é¢˜äº†ã€‚</p><h2 id="æœªæ‰¾åˆ°ç›¸å…³çš„Issues-è¿›è¡Œè¯„è®ºï¼Œè¯·è”ç³»xxxåˆå§‹åŒ–åˆ›å»º"><a href="#æœªæ‰¾åˆ°ç›¸å…³çš„Issues-è¿›è¡Œè¯„è®ºï¼Œè¯·è”ç³»xxxåˆå§‹åŒ–åˆ›å»º" class="headerlink" title="æœªæ‰¾åˆ°ç›¸å…³çš„Issues è¿›è¡Œè¯„è®ºï¼Œè¯·è”ç³»xxxåˆå§‹åŒ–åˆ›å»º"></a>æœªæ‰¾åˆ°ç›¸å…³çš„Issues è¿›è¡Œè¯„è®ºï¼Œè¯·è”ç³»xxxåˆå§‹åŒ–åˆ›å»º</h2><p>è¿™ä¸ªissueæ¯æ¬¡éœ€è¦ç®¡ç†å‘˜ï¼Œå³ä½œè€…ä½ åˆ›å»ºï¼Œæ€ä¹ˆåˆ›å»ºå‘¢ï¼Ÿåœ¨ä½ è‡ªå·±çš„åšå®¢è¿›å…¥è¯„è®ºï¼Œç™»å½•è‡ªå·±çš„githubè´¦å·ï¼Œè®¿é—®æ²¡æœ‰åˆ›å»ºissuesçš„åšå®¢ï¼Œå°±åˆå§‹åŒ–äº†ã€‚<br>è¿™æ ·å²‚ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Ÿ<br>è§£å†³åšå®¢ï¼š<a href="https://link.jianshu.com/?t=https%3A%2F%2Fdraveness.me%2Fgit-comments-initialize" target="_blank" rel="noopener">https://link.jianshu.com/?t=https%3A%2F%2Fdraveness.me%2Fgit-comments-initialize</a><br>è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘è¯•è¿‡ï¼Œæ²¡æœ‰æˆåŠŸï¼Œæ—¶é—´æœ‰é™ï¼Œå°±ä¸æ·±è¿½äº†~<br>tipsï¼šé‡Œé¢çš„sitmapåœ°å›¾ï¼Œå¦‚æœæ˜¯nextåœ°å›¾åœ¨ç½‘å€:https://ä½ çš„åšå®¢åœ°å€/sitemap.xml<br>ä»¥åæœ‰æ—¶é—´æˆ–è€…èƒ½åŠ›å…è®¸çš„è¯ï¼Œå¯èƒ½ä¼šå†™ä¸€ä¸ªç±»ä¼¼çˆ¬è™«çš„è„šæœ¬ï¼Œå®Œæˆè¿™ä¸€æ“ä½œ~</p><h3 id="å‘ç°è‡ªå·±çš„ç•™è¨€æ¿æ˜æ˜è¯„è®ºäº†å´ä¸æ˜¾ç¤º"><a href="#å‘ç°è‡ªå·±çš„ç•™è¨€æ¿æ˜æ˜è¯„è®ºäº†å´ä¸æ˜¾ç¤º" class="headerlink" title="å‘ç°è‡ªå·±çš„ç•™è¨€æ¿æ˜æ˜è¯„è®ºäº†å´ä¸æ˜¾ç¤º"></a>å‘ç°è‡ªå·±çš„ç•™è¨€æ¿æ˜æ˜è¯„è®ºäº†å´ä¸æ˜¾ç¤º</h3><p>åŸå› ï¼šè‡ªå·±åŠ å…¥äº†pjaxå¯¼è‡´<br>æ‰‹åŠ¨åˆ·æ–°çš„åœ°å€æ˜¯ï¼š<a href="https://mmmmmm.me/message/">https://mmmmmm.me/message/</a><br>pjaxåˆ·æ–°çš„åœ°å€æ˜¯ï¼š<a href="https://mmmmmm.me/message">https://mmmmmm.me/message</a><br>å› ä¸ºgitalkåˆ›å»ºissuesæ˜¯æ ¹æ®åœ°å€æ¥åˆ›å»ºçš„ï¼Œæ‰€ä»¥ä¸åŒçš„åœ°å€å½“ç„¶issuesæ˜¯ä¸ä¸€æ ·çš„å•Šã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_6.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥gitalkè¯„è®ºç³»ç»Ÿçš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢çš„æ¥å®¢å¦‚æ±Ÿæ°´æ»”æ»”è¿ç»µä¸ç»ï¼Œåˆå¦‚é»„æ²³ä¹‹æ°´ä¸€å‘ä¸å¯æ”¶æ‹¾ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(å››)ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªshareåŠŸèƒ½ï¼Œshare.js</title>
    <link href="http://mmmmmm.me/hexo_si_share.html"/>
    <id>http://mmmmmm.me/hexo_si_share.html</id>
    <published>2018-12-18T12:18:00.000Z</published>
    <updated>2019-01-27T10:08:57.588Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_7.png"></p><blockquote><ul><li>å…³äºnextä¸»é¢˜ä¸­åŠ å…¥è‡ªå·±å–œæ¬¢çš„åˆ†äº«æ ·å¼çš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢å¦‚æ˜Ÿç©ºèˆ¬ç’€ç’¨ã€‚</li></ul></blockquote><a id="more"></a><h1 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h1><p>ä¹‹å‰ä¸€ç›´ç”¨çš„addthisæˆ–è€…ç™¾åº¦åˆ†äº«ï¼Œå¯æ˜¯åŠ å…¥pjaxåå¤±æ•ˆï¼Œç›¸åº”çš„æ¥å£é‡å†™ä¹Ÿä¸è¡Œï¼Œæ•…è‡ªå·±é‡æ–°åŠ ä¸€ä¸ªåˆ†äº«çš„åŠŸèƒ½ã€‚</p><h1 id="å¼€å§‹ï¼š"><a href="#å¼€å§‹ï¼š" class="headerlink" title="å¼€å§‹ï¼š"></a>å¼€å§‹ï¼š</h1><h2 id="å¼•å…¥èµ„æºï¼š"><a href="#å¼•å…¥èµ„æºï¼š" class="headerlink" title="å¼•å…¥èµ„æºï¼š"></a>å¼•å…¥èµ„æºï¼š</h2><p><img alt="upload successful" data-original="/images/my_blog_20.png"></p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $config = &#123;</span><br><span class="line">  sites : [<span class="string">'weibo'</span>,<span class="string">'qq'</span>, <span class="string">'wechat'</span>,<span class="string">'tencent'</span>,<span class="string">'qzone'</span>,<span class="string">'douban'</span>, <span class="string">'facebook'</span>,  <span class="string">'google'</span>,<span class="string">'twitter'</span>],</span><br><span class="line">  disabled: [ <span class="string">'linkedin'</span>, <span class="string">'diandian'</span>],</span><br><span class="line">  wechatQrcodeTitle: <span class="string">"å¾®ä¿¡æ‰«ä¸€æ‰«"</span>,</span><br><span class="line">  wechatQrcodeHelper: <span class="string">'&lt;p&gt;å¾®ä¿¡æ‰«ä¸€æ‰«ï¼Œå³ä¸Šè§’åˆ†äº«&lt;/p&gt;'</span>,</span><br><span class="line">  source: <span class="string">'Leesin Dong'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$(<span class="string">'.post-spread'</span>).share($config);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjaxshare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  $(<span class="string">'.post-spread'</span>).share($config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³é”®çš„ä¸€æ­¥"><a href="#å…³é”®çš„ä¸€æ­¥" class="headerlink" title="å…³é”®çš„ä¸€æ­¥"></a>å…³é”®çš„ä¸€æ­¥</h2><p>å¾ˆå¤šæ—¶å€™å‡ºç°ï¼š</p><p><img alt="upload successful" data-original="/images/my_blog_21.png"><br>è¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ<br>ä¸‹è½½ç½‘ä¸Šçš„demoå‘ç°äº†é—®é¢˜ã€‚ç¼ºå°‘é›ªç¢§å›¾æŠŠï¼Ÿï¼ˆçŒœæƒ³ï¼‰<br>é€šè¿‡å¯¹æ¯”ï¼Œéœ€è¦å¼•å…¥demoä¸­çš„fontsç›®å½•ã€‚</p><p><img alt="upload successful" data-original="/images/my_blog_22.png"></p><h2 id="é™„ï¼šæ–¹ä¾¿å­¦ä¹ çš„å°demo"><a href="#é™„ï¼šæ–¹ä¾¿å­¦ä¹ çš„å°demo" class="headerlink" title="é™„ï¼šæ–¹ä¾¿å­¦ä¹ çš„å°demo"></a>é™„ï¼šæ–¹ä¾¿å­¦ä¹ çš„å°demo</h2><p><a href="https://github.com/overtrue/share.js/zipball/master" target="_blank" rel="noopener">https://github.com/overtrue/share.js/zipball/master</a></p><h2 id="ä¸€æ¬¡æˆåŠŸåè¿˜å‡ºç°ä¸Šé¢çš„bug"><a href="#ä¸€æ¬¡æˆåŠŸåè¿˜å‡ºç°ä¸Šé¢çš„bug" class="headerlink" title="ä¸€æ¬¡æˆåŠŸåè¿˜å‡ºç°ä¸Šé¢çš„bug"></a>ä¸€æ¬¡æˆåŠŸåè¿˜å‡ºç°ä¸Šé¢çš„bug</h2><p>å°†fontsç›®å½•åˆ æ‰ï¼Œé‡æ–°å¯¼å…¥</p><h1 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h1><h1 id="2018-12-23å‘ç°bugï¼ˆè¯»è€…å¯å¿½ç•¥ï¼‰"><a href="#2018-12-23å‘ç°bugï¼ˆè¯»è€…å¯å¿½ç•¥ï¼‰" class="headerlink" title="2018.12.23å‘ç°bugï¼ˆè¯»è€…å¯å¿½ç•¥ï¼‰"></a>2018.12.23å‘ç°bugï¼ˆè¯»è€…å¯å¿½ç•¥ï¼‰</h1><p>é‡Œé¢çš„å›¾æ ‡å˜æˆäº†ç°è‰²ï¼Œå› ä¸ºåœ¨æŠ¤çœ¼çš„jsä¸­å¯¹aæ ‡ç­¾çš„é¢œè‰²è¿›è¡Œäº†é‡æ–°å®šä¹‰ï¼ŒåŠ a:not()</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_7.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;å…³äºnextä¸»é¢˜ä¸­åŠ å…¥è‡ªå·±å–œæ¬¢çš„åˆ†äº«æ ·å¼çš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢å¦‚æ˜Ÿç©ºèˆ¬ç’€ç’¨ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(ä¸‰)ï¼Œå¼•å…¥require.js,é€‚é…pjax</title>
    <link href="http://mmmmmm.me/hexo_san_require.html"/>
    <id>http://mmmmmm.me/hexo_san_require.html</id>
    <published>2018-12-18T12:16:00.000Z</published>
    <updated>2019-01-27T10:08:03.916Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_8.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥require.jsçš„æ–‡ç« ï¼Œè®©ä½ çš„æ–‡ç« å¦‚é—ªç”µèˆ¬è¿…æ·ã€‚</li></ul></blockquote><a id="more"></a><h1 id="require-jsçš„å¥½å¤„ï¼Œ"><a href="#require-jsçš„å¥½å¤„ï¼Œ" class="headerlink" title="require.jsçš„å¥½å¤„ï¼Œ"></a>require.jsçš„å¥½å¤„ï¼Œ</h1><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š</p><ol><li>å‡å°‘jsæ–‡ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»</li><li>èƒ½å¤Ÿåœ¨é¡µé¢å‘ˆç°å‡ºæ¥ä¹‹åå†åŠ è½½js cssç­‰ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½</li><li>å¼‚æ­¥ï¼Œè·Ÿç¬¬äºŒæ­¥ä¸€ä¸ªæ„æ€<h1 id="hexo-nextä¸­åŠ å…¥require-js"><a href="#hexo-nextä¸­åŠ å…¥require-js" class="headerlink" title="hexo nextä¸­åŠ å…¥require.js"></a>hexo nextä¸­åŠ å…¥require.js</h1><h2 id="æ–°å»ºä¸€ä¸ªmain-jsä½œä¸ºæ‰€æœ‰jsçš„å…¥å£"><a href="#æ–°å»ºä¸€ä¸ªmain-jsä½œä¸ºæ‰€æœ‰jsçš„å…¥å£" class="headerlink" title="æ–°å»ºä¸€ä¸ªmain.jsä½œä¸ºæ‰€æœ‰jsçš„å…¥å£"></a>æ–°å»ºä¸€ä¸ªmain.jsä½œä¸ºæ‰€æœ‰jsçš„å…¥å£</h2>è¿™ä¸ªæˆ‘æ˜¯ç”¨æ¥åŠ è½½é¦–é¡µçš„jsçš„ï¼Œå› ä¸ºåŠ å…¥äº†pjax<br>ä¸‹é¢ä¼šå¼„pjax<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="selector-tag">require</span><span class="selector-class">.config</span>(&#123;</span><br><span class="line">  <span class="attribute">paths</span>: &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">"music"</span>: <span class="string">"/dist/music"</span>,</span><br><span class="line">    <span class="string">"aplayer"</span>: <span class="string">"/js/src/aplayer"</span>,</span><br><span class="line">    <span class="string">"backgroudLine"</span>: <span class="string">"/js/src/backgroudLine"</span>,</span><br><span class="line">    <span class="string">"category"</span>: <span class="string">"/js/src/category"</span>,</span><br><span class="line">    <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">    <span class="string">"share"</span>:<span class="string">"/js/src/pjax/share"</span>,</span><br><span class="line">    <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">//ä¸ºäº†åŠ¨æ€çš„å¢åŠ cssï¼Œrequire jsä¸­å¹¶æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œgithubä¸Šæœ‰ç›¸å…³çš„æ’ä»¶å’Œæ–‡æ¡£ï¼Œè‡ªè¡Œgoogle</span></span><br><span class="line">  <span class="attribute">shim</span>: &#123;</span><br><span class="line">    <span class="string">'share'</span>: &#123;</span><br><span class="line">      <span class="attribute">deps</span>: [</span><br><span class="line">        <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="selector-tag">require</span>([<span class="string">'backgroudLine'</span>,<span class="string">'music'</span>,<span class="string">'aplayer'</span>,<span class="string">'category'</span>,<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>], function ()&#123;</span><br><span class="line"> <span class="selector-tag">pjaxshare</span>()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ol><p>_layout.swig<br></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;#<span class="name">require</span>ä¸»å‡½æ•°#&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/require.js"</span> <span class="attr">defer</span> <span class="attr">async</span>=<span class="string">"true"</span> <span class="attr">data-main</span>=<span class="string">"/js/src/pjax/main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p></p><p>ç½‘ä¸Šè¯´å¿…é¡»åœ¨ç›¸åº”çš„jsæ–‡ä»¶ä¸­ç”¨defineåŒ…ä½ç±»ä¼¼äº<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">åŸæ¥çš„js</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>å¯æ˜¯æˆ‘å‘ç°å¹¶ä¸ç”¨å‘€</p><h2 id="pjaxçš„require-jså®ç°"><a href="#pjaxçš„require-jså®ç°" class="headerlink" title="pjaxçš„require.jså®ç°"></a>pjaxçš„require.jså®ç°</h2><p>_layout.swig<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/jquer_min_js.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/jquery_pjax_min_js.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/pjaxMain.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>pjaxmain.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).pjax(<span class="string">'a[target!=_blank]'</span>, <span class="string">'#pjax-container'</span>, &#123;</span><br><span class="line">  fragment: <span class="string">'#pjax-container'</span>,</span><br><span class="line">  timeout: <span class="number">5000</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//ç”¨æˆ·é€šè¿‡æµè§ˆå™¨çš„å‰è¿›åé€€æŒ‰é’®ï¼Œéœ€è¦åŠ è½½çš„js</span></span><br><span class="line">$(<span class="built_in">window</span>).on(<span class="string">'popstate.pjax'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*åŸæ¥ä¸è¡Œåæ¥åŠ åˆ°completeä¸­è¡Œäº†ï¼Œåæ¥åˆä¸è¡Œäº†*/</span></span><br><span class="line">    pjax();</span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:complete'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>.config(&#123;</span><br><span class="line">      paths: &#123;</span><br><span class="line">        <span class="comment">// "category_js": "/js/src/pjax/category_js",</span></span><br><span class="line">        <span class="comment">// "opacity_js":"/js/src/pjax/opacity_js",</span></span><br><span class="line">        <span class="comment">// "motion_js":"/js/src/pjax/motion_js",</span></span><br><span class="line">        <span class="comment">// "scrollspy_js":"/js/src/pjax/scrollspy_js",</span></span><br><span class="line">        <span class="comment">// "post-details_js":"/js/src/pjax/post-details_js",</span></span><br><span class="line">        <span class="comment">// "lean_analytics":"/js/src/pjax/lean_analytics",</span></span><br><span class="line">        <span class="comment">// "baidutuisong":"/js/src/pjax/baidutuisong",</span></span><br><span class="line">        <span class="comment">// "utils_js":"/js/src/pjax/utils_js",</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">        <span class="comment">// "share":"/js/src/pjax/share",</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªä¹Ÿæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span>,</span><br><span class="line">        <span class="string">"pjax_function_public"</span>:<span class="string">"/js/src/pjax/pjax_function_public"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      shim: &#123;</span><br><span class="line">        <span class="string">'share'</span>: &#123;</span><br><span class="line">          deps: [</span><br><span class="line">            <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>([<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>,<span class="string">'pjax_function_public'</span></span><br><span class="line">    ], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      pjax();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjax</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*å› ä¸ºä¸‹é¢çš„postdetails_jsä¸­çš„æœ‰ä¸ªåˆ¤æ–­ç©ºæŒ‡é’ˆçš„ï¼Œå¦‚æœåŠ ä¸Šå°±ä¸èƒ½å·¦ç§»ï¼Œå¦‚æœå»æ‰ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æŠŠè¿™ä¸ªæ”¾åœ¨é¦–è¡Œæ¥æ‰§è¡Œã€‚*/</span></span><br><span class="line">  <span class="comment">/*ç°åœ¨å·²ç»è§£å†³,å¯ä»¥æ”¾åœ¨ä»»æ„çš„ä½ç½®*/</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">      ä¹‹å‰ä¸€ç›´æ˜¯å¥½çš„çªç„¶æœ‰æ¬¡å°±ä¸å¥½äº†ï¼Œåæ¥è§£å†³äº†å³è¾¹sidebaræ»šè½®æ•ˆæœæ¶ˆå¤±çš„æ•ˆæœä¹‹åï¼Œçªç„¶åˆå¥½äº†ã€‚</span></span><br><span class="line"><span class="comment">      åŸå› æ˜¯å› ä¸ºï¼Œä¹‹å‰æ”¾åœ¨detail jsçš„ä¸‹é¢ï¼Œè€Œdetailçš„ä¸‹é¢undfindçš„åˆ¤æ–­æ—¶æŠ¥é”™çš„ï¼Œæ‰€ä»¥ä¸ä¼šå¾€ä¸‹èµ°ã€‚</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/*åˆ¤æ–­#lv-containeræ˜¯å¦ä¸ºç©ºï¼Œç›®å‰è¿™æ˜¯æˆ‘æ‰¾åˆ°æœ€å¥½çš„åŠæ³•ï¼Œå› ä¸ºä¸åˆ¤æ–­ï¼Œè¿›å…¥é¦–é¡µæˆ–å…¶ä»–çš„é¡µé¢ä¼šç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚*/</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ($(<span class="string">"#lv-container"</span>).length &gt; <span class="number">0</span> &amp;&amp;$(<span class="string">'comments'</span>).length&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    $(<span class="string">".comments"</span>).css(&#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;);</span><br><span class="line">    $.getScript(<span class="string">"https://cdn-city.livere.com/js/embed.dist.js"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ä¸è’œå­js</span></span><br><span class="line">  $.getScript(<span class="string">"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è‡ªå·±å†™çš„åˆ†äº«</span></span><br><span class="line">  pjaxshare();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç±»çš„js</span></span><br><span class="line">  category_js();</span><br><span class="line"><span class="comment">// å±€éƒ¨åˆ·æ–°åæ–‡ç« å†…å®¹ä¸æ˜¾ç¤ºbugçš„js</span></span><br><span class="line">  opacity_js()</span><br><span class="line"><span class="comment">//ç‚¹å‡»æœ‰ç›®å½•çš„æ–‡ç« sidebarä¸æ˜¾ç¤ºçš„bugè§£å†³</span></span><br><span class="line">  motion_js()</span><br><span class="line">  scrollspy_js()</span><br><span class="line">  <span class="comment">//utils_js()</span></span><br><span class="line">  postdetails_js()</span><br><span class="line"><span class="comment">//leanæ•°é‡ç»Ÿè®¡çš„jsï¼ŒåŸæ¥çš„jsæ˜¯åœ¨themes/next/layout/_third-party/analytics/lean-analytics.swigæ–‡ä»¶ä¸­</span></span><br><span class="line">  lean_analytics();</span><br><span class="line">  <span class="comment">//ç™¾åº¦æ¨é€js</span></span><br><span class="line">  baidutuisong();</span><br><span class="line"><span class="comment">//     //å³è¾¹sidebaræ»šè½®æ•ˆæœæ¶ˆå¤±äº†ã€‚</span></span><br><span class="line">  initSidebarDimension()</span><br><span class="line">  <span class="comment">//æ‡’åŠ è½½</span></span><br><span class="line">  lazyLoad();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="å…³äºrequire-jsé€‚é…è¿‡ç¨‹ä¸­æŠ¥çš„é”™è¯¯"><a href="#å…³äºrequire-jsé€‚é…è¿‡ç¨‹ä¸­æŠ¥çš„é”™è¯¯" class="headerlink" title="å…³äºrequire jsé€‚é…è¿‡ç¨‹ä¸­æŠ¥çš„é”™è¯¯"></a>å…³äºrequire jsé€‚é…è¿‡ç¨‹ä¸­æŠ¥çš„é”™è¯¯</h1><h2 id="aplayer-min-jsåªèƒ½åœ¨â€”â€”lauoutåŠ è½½"><a href="#aplayer-min-jsåªèƒ½åœ¨â€”â€”lauoutåŠ è½½" class="headerlink" title="aplayer.min.jsåªèƒ½åœ¨â€”â€”lauoutåŠ è½½"></a>aplayer.min.jsåªèƒ½åœ¨â€”â€”lauoutåŠ è½½</h2><p>è¿™ä¸ªåªèƒ½é€šè¿‡è¿™é‡ŒåŠ è½½ï¼Œå› ä¸ºRequireJS ä»‹ç»è¯´ä¸€ä¸ªJSæ–‡ä»¶é‡Œåªèƒ½æ”¾ä¸€ä¸ªDefineï¼Œè¿™ä¸ªä¼—æ‰€å‘¨çŸ¥ï¼Œä¸æ</p><h2 id="ä¸€ç›´æŠ¥é”™ï¼šMISMATCHED-ANONYMOUS-DEFINE-MODULES-â€¦"><a href="#ä¸€ç›´æŠ¥é”™ï¼šMISMATCHED-ANONYMOUS-DEFINE-MODULES-â€¦" class="headerlink" title="ä¸€ç›´æŠ¥é”™ï¼šMISMATCHED ANONYMOUS DEFINE() MODULES â€¦"></a>ä¸€ç›´æŠ¥é”™ï¼šMISMATCHED ANONYMOUS DEFINE() MODULES â€¦</h2><p>è§£å†³ï¼š<a href="https://blog.csdn.net/u011558902/article/details/53691627" target="_blank" rel="noopener">https://blog.csdn.net/u011558902/article/details/53691627</a></p><p>pjaxrequire è§£å†³<br>requireï¼ˆ[xxxxxxx]fuctionï¼ˆï¼‰{<br>pjax<br>}ï¼‰</p><h2 id="åœ¨åšå®¢ä¸­åŠ requre-jsæ—¶å€™ï¼Œå…³äºaplayerçš„æ’ä»¶éœ€è¦ã€‚"><a href="#åœ¨åšå®¢ä¸­åŠ requre-jsæ—¶å€™ï¼Œå…³äºaplayerçš„æ’ä»¶éœ€è¦ã€‚" class="headerlink" title="åœ¨åšå®¢ä¸­åŠ requre.jsæ—¶å€™ï¼Œå…³äºaplayerçš„æ’ä»¶éœ€è¦ã€‚"></a>åœ¨åšå®¢ä¸­åŠ requre.jsæ—¶å€™ï¼Œå…³äºaplayerçš„æ’ä»¶éœ€è¦ã€‚</h2><p>define aplayer å¯æ˜¯é‡Œé¢è¿˜æœ‰ä¸€ä¸ªdefineå®šä¹‰APlayerå‡½æ•°ï¼ˆé‡ç‚¹è®°å½• RequireJS ä»‹ç»è¯´ä¸€ä¸ªJSæ–‡ä»¶é‡Œåªèƒ½æ”¾ä¸€ä¸ªDefineï¼Œè¿™ä¸ªä¼—æ‰€å‘¨çŸ¥ï¼Œä¸æã€‚ï¼‰<br>è§£å†³æ–¹æ³•ï¼šå› ä¸ºRequireJS ä»‹ç»è¯´ä¸€ä¸ªJSæ–‡ä»¶é‡Œåªèƒ½æ”¾ä¸€ä¸ªDefineï¼Œè¿™ä¸ªä¼—æ‰€å‘¨çŸ¥ï¼Œä¸æã€‚ï¼Œåªèƒ½å°†è¿™ä¸ªæ’ä»¶ä¸é€šè¿‡requireæ¥è¿›è¡ŒåŠ è½½ã€‚è®©ç³»ç»Ÿä¸Šæ¥å°±åŠ è½½ã€‚</p><h2 id="å¦‚å›¾"><a href="#å¦‚å›¾" class="headerlink" title="å¦‚å›¾"></a>å¦‚å›¾</h2><p><img alt="upload successful" data-original="/images/my_blog_12.png"><br>è¿™æ˜¯å› ä¸ºæˆ‘çš„apler çš„jsåœ¨requerå’Œâ€”â€”layoutä¸­éƒ½è¿›è¡Œäº†å®šä¹‰</p><h2 id="velocityå‡½æ•°æŠ¥é”™"><a href="#velocityå‡½æ•°æŠ¥é”™" class="headerlink" title="velocityå‡½æ•°æŠ¥é”™"></a>velocityå‡½æ•°æŠ¥é”™</h2><p><img alt="upload successful" data-original="/images/my_blog_13.png"><br>è§£å†³ï¼šjqueryä»requireä¸­å»æ‰ï¼ŒåŸå› ä¸è¯¦ï¼Œå¥½åƒæœ‰ä»€ä¹ˆå¾ªç¯ä¾èµ–ã€‚<br>è§£å†³ï¼šjqueryä»requireä¸­å»æ‰ï¼ŒåŸå› ä¸è¯¦ï¼Œå¥½åƒæœ‰ä»€ä¹ˆå¾ªç¯ä¾èµ–ã€‚</p><h2 id="é’ˆå¯¹pjaxçš„requireï¼Œæˆ‘ç”¨è¿™ä¸ªrequreä¸»è¦å°±æ˜¯æ¥å®‰æ’pjaxçš„ï¼Œå› ä¸ºè¦ä¹‹å‰å§pjaxçš„å‡½æ•°åœ¨å®¶åœ¨ä¸€è¾¹ï¼Œæµªè´¹å¾ˆå¤§çš„åŠ è½½æ—¶é—´"><a href="#é’ˆå¯¹pjaxçš„requireï¼Œæˆ‘ç”¨è¿™ä¸ªrequreä¸»è¦å°±æ˜¯æ¥å®‰æ’pjaxçš„ï¼Œå› ä¸ºè¦ä¹‹å‰å§pjaxçš„å‡½æ•°åœ¨å®¶åœ¨ä¸€è¾¹ï¼Œæµªè´¹å¾ˆå¤§çš„åŠ è½½æ—¶é—´" class="headerlink" title="é’ˆå¯¹pjaxçš„requireï¼Œæˆ‘ç”¨è¿™ä¸ªrequreä¸»è¦å°±æ˜¯æ¥å®‰æ’pjaxçš„ï¼Œå› ä¸ºè¦ä¹‹å‰å§pjaxçš„å‡½æ•°åœ¨å®¶åœ¨ä¸€è¾¹ï¼Œæµªè´¹å¾ˆå¤§çš„åŠ è½½æ—¶é—´"></a>é’ˆå¯¹pjaxçš„requireï¼Œæˆ‘ç”¨è¿™ä¸ªrequreä¸»è¦å°±æ˜¯æ¥å®‰æ’pjaxçš„ï¼Œå› ä¸ºè¦ä¹‹å‰å§pjaxçš„å‡½æ•°åœ¨å®¶åœ¨ä¸€è¾¹ï¼Œæµªè´¹å¾ˆå¤§çš„åŠ è½½æ—¶é—´</h2><p>å‘ç°ï¼š<br>æˆ‘å¾ˆå¤šæ¨¡å—å¹¶æ²¡æœ‰ç”¨defineè¿›è¡Œå®šå®šä¹‰,ä½†æ˜¯ä»ç„¶æˆåŠŸäº†ï¼Œè¯´æ˜å¹¶ä¸æ˜¯ä¸€å®šè¦defineå®šä¹‰æ‰èƒ½ç”¨çš„ã€‚ï¼ˆæˆ‘é€šè¿‡å®é™…ç»éªŒæ€»ç»“çš„ï¼Œç»“è®ºä¸ä¸€å®šæ­£ç¡®ï¼Œæœ‰ä¸å¯¹çš„åœ°æ–¹è¿˜è¯·æŒ‡å‡ºï¼‰<br>è§£å†³ï¼š<br><img alt="upload successful" data-original="/images/my_blog_14.png"><br><img alt="upload successful" data-original="/images/my_blog_15.png"></p><p>åœ¨pjaxminé‡Œé¢å†™requireçš„ä¸œè¥¿ï¼Œå¯ä»¥å‘ç°æˆ‘å¹¶æ²¡æœ‰åœ¨â€”â€”ç±»ä¸­å†™</p><p>å¹¶æ²¡æœ‰æŒ‰ç…§requireçš„æ–¹å¼å¼•å…¥pjaxmainè¿™ä¸ªå‡½æ•°ï¼Œä½†è¿˜æ˜¯æˆåŠŸäº†ï¼Œ<br>è¯´æ˜ï¼Œé¡¹ç›®ä¸­åªéœ€è¦å¼•å…¥ä¸€æ¬¡requireè¿™ä¸ªjsï¼Œä¾¿å¯ä»¥å¤„å¤„ä½¿ç”¨ï¼ˆç›®å‰æ ¹æ®æˆ‘çš„å®é™…æ“ä½œå¾—å‡ºçš„ç»“è®ºï¼Œä¸ä¸€å®šæ­£ç¡®ã€‚ï¼‰</p><p>è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡pjax çš„compliteçš„å‡½æ•°æ‰§è¡Œå®Œäº†ä¹‹åæ‰ä¼šåŠ è½½éœ€è¦çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨é¦–é¡µï¼Œæˆ–è€…å…¶ä»–çš„é¡µé¢ï¼Œæ˜¯ä¸éœ€è¦åŠ è½½è¿™ä¸ªäº›ä¸ªæ–‡ä»¶çš„ï¼Œåœ¨é¦–é¡µçš„é¦–æ¬¡åŠ è½½ä¸­å¤§å¤§èŠ‚çœäº†æ—¶é—´å®Œç¾ï¼ï¼ï¼ï¼ï¼</p><h2 id="æŠ¥é”™"><a href="#æŠ¥é”™" class="headerlink" title="æŠ¥é”™"></a>æŠ¥é”™</h2><p><img alt="upload successful" data-original="/images/my_blog_16.png"></p><p>å®˜æ–¹è§£é‡Š</p><p><img alt="upload successful" data-original="/images/my_blog_17.png"><br>è¿™é‡Œçš„è„šæœ¬é”™è¯¯å¹¶ä¸æ˜¯æˆ‘ä»¬å¼•å…¥çš„jsè„šæœ¬é”™è¯¯ï¼Œè€Œæ˜¯å¯¹ç¼–å†™çš„config requireå‡½æ•°çš„è„šæœ¬é”™è¯¯ï¼Œ<br>æ¯”å¦‚æˆ‘å°±æ˜¯è·¯å¾„ä¸ä¼šçš„</p><h2 id="pajx-è¿”å›å¤±æ•ˆ"><a href="#pajx-è¿”å›å¤±æ•ˆ" class="headerlink" title="pajx è¿”å›å¤±æ•ˆ"></a>pajx è¿”å›å¤±æ•ˆ</h2><p>$(window).on(â€˜popstate.pjaxâ€™, function () {<br>$(â€˜imgâ€™).lazyload({<br>placeholder: â€˜/images/loading.gifâ€™,<br>effect: â€˜fadeInâ€™,<br>threshold : 100,<br>failure_limit : 20,<br>skip_invisible : false<br>});</p><pre><code>pjax();</code></pre><p>})<br>å’ŒcompliteåŒæ ·çš„ä»£ç ï¼Œé€šè¿‡æ‰“æ–­ç‚¹ï¼Œå‘ç°æˆ‘çš„ifï¼ˆxxx&gt;0ï¼‰{}å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œè¯´æ˜æ˜¯åœ¨é¡µé¢åŠ è½½å®Œä¹‹å‰å°±å¼€å§‹æ‰§è¡Œè¿™æ®µä»£ç äº†ï¼Œ<br>è§£å†³ï¼š<br>$(window).on(â€˜popstate.pjaxâ€™, function () {<br>$(document).on(â€˜pjax:completeâ€™,<br>function () {<br>//<br>$(â€˜imgâ€™).lazyload({<br>placeholder: â€˜/images/loading.gifâ€™,<br>effect: â€˜fadeInâ€™,<br>threshold : 100,<br>failure_limit : 20,<br>skip_invisible : false<br>});</p><pre><code>  pjax();})</code></pre><p>})</p><p>åœ¨ä¹‹å‰åŠ å…¥ï¼Œ<br>$(document).on(â€˜pjax:completeâ€™,ï¼‰<br>æ„æ€æ˜¯åœ¨pjaxè¯·æ±‚åŠ è½½å®Œäº†ä¹‹åå†è¿›è¡Œå¦‚ä¸‹çš„ä»£ç ã€‚</p><h2 id="pjaxshareå‡½æ•°ï¼ˆåˆ†äº«å‡½æ•°ï¼‰è€å¸ˆæŠ¥é”™pajaxshareï¼ˆï¼‰-not-defined"><a href="#pjaxshareå‡½æ•°ï¼ˆåˆ†äº«å‡½æ•°ï¼‰è€å¸ˆæŠ¥é”™pajaxshareï¼ˆï¼‰-not-defined" class="headerlink" title="pjaxshareå‡½æ•°ï¼ˆåˆ†äº«å‡½æ•°ï¼‰è€å¸ˆæŠ¥é”™pajaxshareï¼ˆï¼‰ not defined"></a>pjaxshareå‡½æ•°ï¼ˆåˆ†äº«å‡½æ•°ï¼‰è€å¸ˆæŠ¥é”™pajaxshareï¼ˆï¼‰ not defined</h2><p>è§£å†³ï¼šæƒ³ç€åœ¨pjaxshareå‡½æ•°ä¸Šé¢åŠ defineï¼ˆfunctionï¼ˆï¼‰{}ï¼‰,æŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹æ˜¯è¿™æ ·çš„ï¼Œå¯æ˜¯æˆ‘åŠ ä¸Šå°±æ˜¯ä¸è¡Œï¼Œå»æ‰åè€Œè¡Œäº†ã€‚</p><h2 id="require-css"><a href="#require-css" class="headerlink" title="require css"></a>require css</h2><p>ä»githubä¸Šä¸‹è½½<br>deps:[â€˜css!libs/css/color.minâ€™] è¿™é‡Œä¼šä¼˜å…ˆåŠ åœ¨cssè¿™ä¸ªæ¨¡å—åä¸‹çš„æ–‡ä»¶(libs/js/css.min.js) ç„¶åä¸€ä¸ª â€œ!â€åé¢ç´§æ¥ç€åœ¨åŸºç›®å½•ä¸‹åŠ åœ¨libs/css/color.min.css<br>æ‰€ä»¥css.jsæ–‡ä»¶ä¸‹è½½ä¸‹æ‹‰æ˜¯ä¸èƒ½æ”¹åçš„</p><p><img alt="upload successful" data-original="/images/my_blog_19.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_8.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºnextä¸»é¢˜ä¸­åŠ å…¥require.jsçš„æ–‡ç« ï¼Œè®©ä½ çš„æ–‡ç« å¦‚é—ªç”µèˆ¬è¿…æ·ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(äºŒ)ï¼Œæ‡’åŠ è½½</title>
    <link href="http://mmmmmm.me/hexo_er_lazy.html"/>
    <id>http://mmmmmm.me/hexo_er_lazy.html</id>
    <published>2018-12-18T12:15:00.000Z</published>
    <updated>2019-01-27T10:21:31.690Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_26.png"></p><blockquote><ul><li>å…³äºnextæ³¨æ„ä¸­åŠ å…¥æ‡’åŠ è½½æœºåˆ¶çš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢å¦‚ä¸èˆ¬é¡ºæ»‘ã€‚</li></ul></blockquote><a id="more"></a><h1 id="tipï¼šæ²¡æœ‰è€å¿ƒçš„å¯ä»¥ç›´æ¥çœ‹ï¼šæ­£å¼åœ¨hexo-nextä¸­åŠ å…¥æ‡’åŠ è½½ï¼ˆæœ€ä¸‹é¢ï¼‰"><a href="#tipï¼šæ²¡æœ‰è€å¿ƒçš„å¯ä»¥ç›´æ¥çœ‹ï¼šæ­£å¼åœ¨hexo-nextä¸­åŠ å…¥æ‡’åŠ è½½ï¼ˆæœ€ä¸‹é¢ï¼‰" class="headerlink" title="tipï¼šæ²¡æœ‰è€å¿ƒçš„å¯ä»¥ç›´æ¥çœ‹ï¼šæ­£å¼åœ¨hexo nextä¸­åŠ å…¥æ‡’åŠ è½½ï¼ˆæœ€ä¸‹é¢ï¼‰"></a>tipï¼šæ²¡æœ‰è€å¿ƒçš„å¯ä»¥ç›´æ¥çœ‹ï¼šæ­£å¼åœ¨hexo nextä¸­åŠ å…¥æ‡’åŠ è½½ï¼ˆæœ€ä¸‹é¢ï¼‰</h1><h1 id="åºŸè¯"><a href="#åºŸè¯" class="headerlink" title="åºŸè¯"></a>åºŸè¯</h1><p>æœ¬æ¥æƒ³å…¨éƒ¨ä¼˜åŒ–å®Œï¼Œä¸€èµ·å†™åšå®¢çš„ï¼Œå¤§åŠå¤œçš„ä¹Ÿä¸æƒ³å¤ªç´¯ï¼Œå¯æ˜¯å¯èƒ½å› ä¸ºå¹´çºªå¤§äº†å§ï¼ˆ23äº†ï¼‰ï¼Œæ€•éš”å¤©ç»™å¿˜è®°äº†ï¼Œåˆ°æ—¶å€™å›å¤´æ‰¾é”™è¯¯å²‚ä¸æ˜¯æµªè´¹æ›´å¤šçš„æ—¶é—´ï¼Œç´¢æ€§ï¼Œä»Šå¤©æ‹–ç€ç–²æƒ«çš„å¤§è„‘ï¼Œå†™ä¸‹è¿™ç¯‡åšæ–‡å§~</p><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ¬äººçš„åšå®¢mmmmmm.me ï¼ˆç›®å‰å¯èƒ½è¿˜æ˜¯é—®é¢˜å¾ˆå¤šçš„ï¼Œä¸ä»‹æ„çš„å¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹ï¼‰ pjaxåŸºæœ¬ä¼˜åŒ–å®Œäº†ï¼Œç›®å‰æˆ‘æ¶‰åŠåˆ°çš„ï¼Œç°åœ¨æƒ³ä¼˜åŒ–ä¸€ä¸‹ç½‘ç«™çš„åŠ è½½é€Ÿåº¦ï¼Œå› ä¸ºæˆ‘çš„ç½‘ç«™åˆšè¿›å»çš„æ—¶å€™ç™½å±å¤§åŠå¤©ï¼Œç„¶åæµè§ˆå™¨çš„è½¬ç›˜è½¬åŠå¤©ï¼Œï¼ˆå°±æ˜¯åˆ·æ–°é‚£ä¸ªæ ‡è¯†äº†ï¼Œä¸ä¼šè¡¨è¾¾ï¼‰ï¼Œä¹‹åå°±æ˜¯ä¸€å †æŸ¥çœ‹é€šè¿‡æµè§ˆå™¨çš„å®¡æŸ¥æ¨¡å¼çœ‹networkï¼Œå‘ç°é¦–é¡µçš„å¤§å›¾ç‰‡å äº†å¾ˆä¹…çš„å“åº”æ—¶é—´ï¼Œä¹‹åå‘ç°æˆ‘çš„hexoåå°ç®¡ç†å·¥å…·ï¼Œhexo-adminï¼ˆä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„åšå®¢å‘å¸ƒå·¥å…·ï¼Œæœ‰å…´è¶£çš„çœ‹æˆ‘å¦ä¸€ç¯‡åšå®¢ï¼Œç½‘ä¸Šä¸€æœä¸€å¤§å †ï¼‰ï¼Œæ¯æ¬¡ç›´æ¥å¤åˆ¶ç²˜è´´è¿›å»ï¼Œå®ƒé»˜è®¤ä¿å­˜çš„æ˜¯pngæ ¼å¼çš„ï¼Œå…³äºjpgå’Œpngçš„åŒºåˆ«ï¼Œå¸Œæœ›å¤§å®¶ä¹Ÿäº†è§£ä¸€ä¸‹ï¼Œä½¿å¾—æˆ‘çš„å›¾ç‰‡å¥½å‡ å…†ï¼Œæˆ‘å°±æ‰‹åŠ¨å¤åˆ¶æˆjpgæ ¼å¼çš„ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œçš„å‘€ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ä¸Šç½‘æŸ¥å„ç§ä¼˜åŒ–ï¼Œå‘ç°ï¼Œæœ‰ä¸ªæ‡’åŠ è½½è¿™ä¸ªä¸œä¸œï¼Œå®¢è§‚å¾€ä¸‹çœ‹ã€‚</p><h1 id="æ‡’åŠ è½½ç®€å•ä»‹ç»"><a href="#æ‡’åŠ è½½ç®€å•ä»‹ç»" class="headerlink" title="æ‡’åŠ è½½ç®€å•ä»‹ç»"></a>æ‡’åŠ è½½ç®€å•ä»‹ç»</h1><blockquote><p>ä½•ä¸ºæ‡’åŠ è½½ï¼Œç®€è¨€ä¹‹å°±æ˜¯åœ¨htmlåŠ è½½çš„æ—¶å€™ï¼Œè‹¥æœimgæ ‡ç­¾çš„srcæ˜¯æœ‰å†…å®¹çš„ï¼Œåœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œimgæ ‡ç­¾å°±å›å»è¯·æ±‚è¿™ä¸ªå›¾ç‰‡ï¼ŒçŸ¥é“åŠ è½½å®Œï¼Œæˆ‘ä»¬çš„æµè§ˆå™¨çš„åˆ·æ–°é‚£ä¸ªå›¾æ ‡æ‰ä¼šåœæ­¢è½¬åŠ¨ï¼Œä¹Ÿå°±æ˜¯æ‰ç®—è¯·æ±‚ç©ï¼Œè¿™ä¸ªæ—¶å€™æ‡’åŠ è½½å°±åº”è¿è€Œç”Ÿã€‚æ‡’åŠ è½½èƒ½å¤Ÿåœ¨ä½ é¼ æ ‡ä¸æ‡‚å¾—æ—¶å€™åªåŠ è½½ç›®å‰ç”µè„‘çª—å£å†…éœ€è¦å±•ç¤ºçš„å›¾ç‰‡ï¼Œç”µè„‘å±å¹•å†…éƒ¨éœ€è¦å±•ç¤ºçš„å›¾ç‰‡å°±æš‚æ—¶ä¸åŠ è½½ï¼Œå¯¹äºå›¾ç‰‡æ¯”è¾ƒå¤šçš„ç½‘ç«™æ˜¯ä¸æ˜¯å¾ˆå®ç”¨å‘¢ï¼Ÿ</p></blockquote><p>å…³äºæ‡’åŠ è½½çš„è¯­æ³•ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p><h2 id="å¼•å…¥js"><a href="#å¼•å…¥js" class="headerlink" title="å¼•å…¥js"></a>å¼•å…¥js</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"jquery.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">   &lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"jquery.lazyload.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="é‡ç‚¹ï¼æ•²é»‘æ¿äº†ï¼ï¼ï¼"><a href="#é‡ç‚¹ï¼æ•²é»‘æ¿äº†ï¼ï¼ï¼" class="headerlink" title="é‡ç‚¹ï¼æ•²é»‘æ¿äº†ï¼ï¼ï¼"></a>é‡ç‚¹ï¼æ•²é»‘æ¿äº†ï¼ï¼ï¼</h2><p>ä¿®æ”¹å›¾ç‰‡å±æ€§ï¼ˆå¢åŠ data-originalå±æ€§ï¼Œå»æ‰srcå±æ€§ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img alt=<span class="string">""</span> width=<span class="string">"640"</span> height=<span class="string">"480"</span> data-original=<span class="string">"img/example.jpg"</span> /&gt;</span><br></pre></td></tr></table></figure><h2 id="å®Œå–„æ‡’åŠ è½½å‡½æ•°"><a href="#å®Œå–„æ‡’åŠ è½½å‡½æ•°" class="headerlink" title="å®Œå–„æ‡’åŠ è½½å‡½æ•°"></a>å®Œå–„æ‡’åŠ è½½å‡½æ•°</h2><pre><code>&lt;script&gt;$(function() {    $(&quot;img&quot;).lazyload();});&lt;script&gt;</code></pre><h2 id="æ‡’åŠ è½½å‡½æ•°å¯é…ç½®çš„å‚æ•°"><a href="#æ‡’åŠ è½½å‡½æ•°å¯é…ç½®çš„å‚æ•°" class="headerlink" title="æ‡’åŠ è½½å‡½æ•°å¯é…ç½®çš„å‚æ•°"></a>æ‡’åŠ è½½å‡½æ•°å¯é…ç½®çš„å‚æ•°</h2><p>å¤‡æ³¨ï¼šè¿™é‡Œå¿…é¡»è®¾ç½®å›¾ç‰‡çš„widthå’Œheight,å¦åˆ™æ’ä»¶å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><p>ä¸Šé¢æ˜¯æœ€ç®€å•çš„è°ƒç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ï¼Œæ¯”å¦‚æƒ³è¦æå‰ä¸€ç‚¹ç‚¹åŠ è½½ï¼Œé¿å…ç½‘ç»œè¿‡æ…¢æ—¶åŠ è½½ç¼“æ…¢ï¼ŒåŠ è½½éšè—å›¾ç‰‡ç­‰ç­‰ï¼Œlazyloadéƒ½ä¸ºæˆ‘ä»¬æä¾›ç›¸åº”çš„å‚æ•°ã€‚</p><p>1.è®¾ç½®ä¸´ç•Œç‚¹</p><p>é»˜è®¤æƒ…å†µä¸‹å›¾ç‰‡ä¼šå‡ºç°åœ¨å±å¹•æ—¶åŠ è½½. å¦‚æœä½ æƒ³æå‰åŠ è½½å›¾ç‰‡, å¯ä»¥è®¾ç½®threshold é€‰é¡¹, å¦‚ï¼šè®¾ç½® threshold ä¸º 200 ä»¤å›¾ç‰‡åœ¨è·ç¦»å±å¹• 200 åƒç´ æ—¶æå‰åŠ è½½.</p><pre><code>$(&quot;img&quot;).lazyload({    threshold : 200});</code></pre><p>2.ä½¿ç”¨ç‰¹æ•ˆ</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾åƒå®Œå…¨åŠ è½½å¹¶è°ƒç”¨show()ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ æƒ³è¦çš„æ•ˆæœã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨fadeIn ï¼ˆæ·¡å…¥æ•ˆæœï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"img"</span>).lazyload(&#123;</span><br><span class="line">    effect : <span class="string">"fadeIn"</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>3.å½“å›¾ç‰‡ä¸è¿ç»­æ—¶</p><p>æ»šåŠ¨é¡µé¢çš„æ—¶å€™, Lazy Load ä¼šå¾ªç¯ä¸ºåŠ è½½çš„å›¾ç‰‡. åœ¨å¾ªç¯ä¸­æ£€æµ‹å›¾ç‰‡æ˜¯å¦åœ¨å¯è§†åŒºåŸŸå†…. é»˜è®¤æƒ…å†µä¸‹åœ¨æ‰¾åˆ°ç¬¬ä¸€å¼ ä¸åœ¨å¯è§åŒºåŸŸçš„å›¾ç‰‡æ—¶åœæ­¢å¾ªç¯. å›¾ç‰‡è¢«è®¤ä¸ºæ˜¯æµå¼åˆ†å¸ƒçš„, å›¾ç‰‡åœ¨é¡µé¢ä¸­çš„æ¬¡åºå’Œ HTML ä»£ç ä¸­æ¬¡åºç›¸åŒ. ä½†æ˜¯åœ¨ä¸€äº›å¸ƒå±€ä¸­, è¿™æ ·çš„å‡è®¾æ˜¯ä¸æˆç«‹çš„. ä¸è¿‡ä½ å¯ä»¥é€šè¿‡ failurelimit é€‰é¡¹æ¥æ§åˆ¶åŠ è½½è¡Œä¸º.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"img"</span>).lazyload(&#123;</span><br><span class="line">    failure_limit : <span class="number">20</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å°† failurelimit è®¾ä¸º 20 ï¼Œå½“æ’ä»¶æ‰¾åˆ° 20 ä¸ªä¸åœ¨å¯è§åŒºåŸŸçš„å›¾ç‰‡æ—¶åœæ­¢æœç´¢.</p><p>4.åŠ è½½éšè—å›¾ç‰‡</p><p>å½“ç•Œé¢æœ‰å¾ˆå¤šéšè—å›¾ç‰‡çš„æ—¶å€™å¹¶å¸Œæœ›åŠ è½½ä»–ä»¬çš„æ—¶å€™åˆ™ä½¿ç”¨kip_invisible å±æ€§ï¼Œå°†å…¶è®¾ç½®ä¸ºfalse</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"img"</span>).lazyload(&#123; </span><br><span class="line">     skip_invisible : <span class="literal">false</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œä¸Šé¢çš„æ–¹æ³•å·²ç»åŸºæœ¬æ»¡è¶³å¸¸è§„çš„æ‡’åŠ è½½ä½¿ç”¨äº†ï¼Œè¿˜æœ‰ç‰¹æ®Šçš„ä½¿ç”¨ï¼Œå¯æŸ¥çœ‹å®˜ç½‘APIã€‚</p><h1 id="æ­£å¼åœ¨hexo-nextä¸­åŠ å…¥æ‡’åŠ è½½"><a href="#æ­£å¼åœ¨hexo-nextä¸­åŠ å…¥æ‡’åŠ è½½" class="headerlink" title="æ­£å¼åœ¨hexo nextä¸­åŠ å…¥æ‡’åŠ è½½"></a>æ­£å¼åœ¨hexo nextä¸­åŠ å…¥æ‡’åŠ è½½</h1><p>ä¹‹å‰å°è¯•è¿‡å¾ˆå¤šæ–¹æ³•ï¼š</p><h2 id="1ï¼š"><a href="#1ï¼š" class="headerlink" title="1ï¼š"></a>1ï¼š</h2><p>å¦‚ä¸ŠæŸ¥çœ‹ç›¸å…³çš„æ‡’åŠ è½½apiæ–‡æ¡£ï¼Œè‡ªå®šä¹‰æ‡’åŠ è½½å‡½æ•°ï¼Œä½†æ˜¯å¿½ç•¥äº†ï¼Œimgä¸­éœ€è¦data-originalï¼Œå¹¶ä¸”å»æ‰srcå±æ€§ï¼Œä¹‹åå‘ç°ç„¶åå¼¥è¡¥ï¼Œæƒ³è¦é€šè¿‡jsçš„æ–¹å¼åŠ¨æ€çš„ç»™æˆ‘çš„imgåŠ å…¥è¿™ä¸ªå±æ€§ï¼Œç„¶åå»æ‰srcå±æ€§ï¼Œä½†æ˜¯jsåŠ å…¥çš„å‰ææ˜¯åŠ è½½å®Œdomæ¨¡å‹ï¼ŒåŠ è½½å®Œdomæ¨¡å‹çš„å‰ææ˜¯srcä¸­çš„å†…å®¹å·²ç»åŠ è½½äº†ï¼Œæ‰€ä»¥æ˜¯ä¸è¡Œçš„ï¼Œæ•…å°è¯•ä¿®æ”¹htmlï¼Œnextä¸»é¢˜ä¸­æ²¡æœ‰htmläº‹swigæ–‡ä»¶ï¼Œimgä¸­çš„å†…å®¹æ˜¯é€šè¿‡jsæ¸²æŸ“å‡ºæ¥çš„ã€‚æ•…æ”¾å¼ƒã€‚</p><h2 id="2ï¼š"><a href="#2ï¼š" class="headerlink" title="2ï¼š"></a>2ï¼š</h2><p>ä¸Šè°·æ­ŒæŸ¥çœ‹ï¼Œå‘ç°å¯ä»¥ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-lazyload --save</span><br></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹_config.ymlæ–‡ä»¶</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lazyload:</span><br><span class="line">     enable: <span class="literal">true</span></span><br><span class="line">     # className: #å¯é€‰ e.g. .J-lazyload-img</span><br><span class="line">     # loadingImg: #å¯é€‰ eg. ./images/loading.png</span><br></pre></td></tr></table></figure><p>å¯æ˜¯æˆ‘å‘ç°è²Œä¼¼æ˜¯ä¸è¡Œçš„ï¼Œåæ­£æŠ¥å„ç§é”™ï¼Œç½‘ä¸Šå¥½åƒæ˜¯æœ‰äººæˆåŠŸçš„ã€‚è¿™ä¸ªæ–¹æ³•å¾…å®šï¼Œé™„ä¸ŠåŸåšå®¢åœ°å€ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç ”ç©¶ã€‚<br><a href="http://www.zhaojun.im/hexo-lazyload/" target="_blank" rel="noopener">http://www.zhaojun.im/hexo-lazyload/</a></p><h2 id="3ï¼šæŒ‰æˆ‘çš„æ­¥éª¤æ¥ï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆã€‚"><a href="#3ï¼šæŒ‰æˆ‘çš„æ­¥éª¤æ¥ï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆã€‚" class="headerlink" title="3ï¼šæŒ‰æˆ‘çš„æ­¥éª¤æ¥ï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆã€‚"></a>3ï¼šæŒ‰æˆ‘çš„æ­¥éª¤æ¥ï¼Œä¸è¦é—®ä¸ºä»€ä¹ˆã€‚</h2><p>æˆ‘è‡ªå·±æˆåŠŸçš„æ–¹æ³•ï¼š<br>åœ¨ä¸»é¢˜æ–‡ä»¶å¤¹ä¸‹çš„scriptsæ–‡ä»¶å¤¹é‡Œï¼Œå†™ä¸€ä¸ª js æ–‡ä»¶ï¼Œåå­—ä¸é™ï¼Œxxxx.js,æ¯”å¦‚wohaoshuai.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">use strict<span class="string">';</span></span><br><span class="line"><span class="string">var cheerio = require('</span>cheerio<span class="string">'); </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">function lazyloadImg(source) &#123;</span></span><br><span class="line"><span class="string">    var LZ= cheerio.load(source, &#123;</span></span><br><span class="line"><span class="string">        decodeEntities: false</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    //éå†æ‰€æœ‰ img æ ‡ç­¾ï¼Œæ·»åŠ data-originalå±æ€§</span></span><br><span class="line"><span class="string">    LZ('</span>img<span class="string">').each(function(index, element) &#123;</span></span><br><span class="line"><span class="string">        var oldsrc = LZ(element).attr('</span>src<span class="string">');</span></span><br><span class="line"><span class="string">        if (oldsrc) &#123;</span></span><br><span class="line"><span class="string">            LZ(element).removeAttr('</span>src<span class="string">');</span></span><br><span class="line"><span class="string">            LZ(element).attr(&#123;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">                 '</span>data-original<span class="string">': oldsrc</span></span><br><span class="line"><span class="string">            &#125;);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    return LZ.html();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">//åœ¨æ¸²æŸ“ä¹‹å‰ï¼Œæ›´æ”¹ img æ ‡ç­¾</span></span><br><span class="line"><span class="string">hexo.extend.filter.register('</span>after_render:html<span class="string">', lazyloadImg);</span></span><br></pre></td></tr></table></figure><p>ç„¶åç½‘ä¸Šæ˜¯è¯´åœ¨headeræˆ–è€…footerä¸­å¼•å…¥js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"http://libs.baidu.com/jquery/1.11.1/jquery.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"> <span class="comment">//ä¹Ÿå¯æ›¿æ¢å…¶ä»–çš„lazyloadæº</span></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"http://apps.bdimg.com/libs/jquery-lazyload/1.9.5/jquery.lazyload.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">      $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">      <span class="comment">//å¯¹æ‰€æœ‰ img æ ‡ç­¾è¿›è¡Œæ‡’åŠ è½½        </span></span><br><span class="line">          $(<span class="string">"img"</span>).lazyload(&#123;</span><br><span class="line">          <span class="comment">//è®¾ç½®å ä½å›¾ï¼Œæˆ‘è¿™é‡Œé€‰ç”¨äº†ä¸€ä¸ª loading çš„åŠ è½½åŠ¨ç”»</span></span><br><span class="line">            placeholder:<span class="string">"/img/loading.gif"</span>,</span><br><span class="line">            <span class="comment">//åŠ è½½æ•ˆæœ</span></span><br><span class="line">              effect:<span class="string">"fadeIn"</span></span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘å‘ç°hexo nextä¸»é¢˜ä¸­æœ‰ä¸ªthemes/next/source/js/src/utils.jsæ–‡ä»¶ã€‚<br>æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">lazyLoadPostsImages: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// $('#posts').find('img').lazyload(&#123;</span></span><br><span class="line">      <span class="comment">//   placeholder: '/images/loading.gif',</span></span><br><span class="line">      <span class="comment">//   effect: 'fadeIn',</span></span><br><span class="line">      <span class="comment">//   threshold : 0</span></span><br><span class="line">      <span class="comment">// &#125;);</span></span><br><span class="line">      $(<span class="string">'img'</span>).lazyload(&#123;</span><br><span class="line">         placeholder: <span class="string">'/images/loading.gif'</span>,</span><br><span class="line">        effect: <span class="string">'fadeIn'</span>,</span><br><span class="line">        threshold : <span class="number">100</span>,</span><br><span class="line">        failure_limit : <span class="number">20</span>,</span><br><span class="line">        skip_invisible : <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å†…å®¹å³å¯ï¼Œä¹‹å‰æ˜¯æ³¨é‡Šæ‰çš„å†…å®¹ï¼Œæ„æ€æ˜¯åªå¯¹articleä¸­çš„å†…å®¹è¿›è¡Œæ‡’åŠ è½½ï¼Œå¯æ˜¯æˆ‘éœ€è¦çš„æ˜¯å…¨å±€çš„éƒ½æ‡’åŠ è½½ï¼Œå› ä¸ºä¸Šé¢çš„scriptsä¸­çš„jså·²ç»å°†å…¨å±€çš„imgéƒ½æ›¿æ¢äº†æ ‡ç­¾å†…å®¹ï¼Œä¸å…¨å±€æ‡’åŠ è½½çš„è¯ä¼šæœ‰çš„ä¸æ˜¾ç¤ºï¼Œ<br>ç„¶åå°±æ˜¯è¿™ä¸¤ä¸ªé…ç½®ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">threshold : <span class="number">100</span>,</span><br><span class="line"> ailure_limit : <span class="number">20</span>,</span><br></pre></td></tr></table></figure><p>æ„æ€ä¸Šé¢æœ‰å…³æ‡’åŠ è½½çš„è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œä¸ºäº†è§£å†³æœ‰çš„å›¾ç‰‡å¯èƒ½ä¼šä¸æ˜¾ç¤ºã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_26.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;å…³äºnextæ³¨æ„ä¸­åŠ å…¥æ‡’åŠ è½½æœºåˆ¶çš„æ–‡ç« ï¼Œè®©ä½ çš„åšå®¢å¦‚ä¸èˆ¬é¡ºæ»‘ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>hexo nextä¸»é¢˜æ·±åº¦ä¼˜åŒ–(ä¸€)ï¼ŒåŠ å…¥pjaxåŠŸèƒ½</title>
    <link href="http://mmmmmm.me/hexo_yi_pjax.html"/>
    <id>http://mmmmmm.me/hexo_yi_pjax.html</id>
    <published>2018-12-18T11:20:00.000Z</published>
    <updated>2019-01-28T05:44:41.363Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_10.png"></p><blockquote><ul><li>ä¸€ç¯‡å…³äºåœ¨nextä¸»é¢˜ä¸­åŠ å…¥pjaxçš„æ–‡ç« ï¼Œè®©ä½ çš„æ–‡ç« å¦‚é’»çŸ³èˆ¬å¤ºç›®ã€‚</li></ul></blockquote><a id="more"></a><p>ç‰¹åˆ«å£°æ˜ï¼š<br><strong>çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œå¾€ä¸‹è¯»ï¼Œå› ä¸ºæˆ‘å†™çš„é€»è¾‘å¯èƒ½ä¸æ˜¯å¾ˆæ¸…æ™°~<br>æœ¬äººæºç åœ¨githubä¸Šå®åœ¨ä¸æ‡‚çš„ git cloneè‡ªå·±æ‰£ä¸€æ‰£ï¼Œgithubåœ¨åšå®¢ä¸­æœ‰è¿æ¥<br>æœ¬äººåšå®¢mmmmmm.me</strong></p><h1 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a>èƒŒæ™¯ï¼š</h1><p>æˆ‘æœ‰å¼ºè¿«ç—‡ï¼Œé‡åˆ°å¥½çš„ä¸œè¥¿å°±æƒ³ç»™è‡ªå·±æ•´ä¸Šå»ï¼Œåœ¨è¿™é‡Œæƒ³å¿ è¯šçš„å¥‰åŠå¤§å®¶ä¸€å¥ï¼Œä¸è¦å†æ­å»ºè‡ªå·±çš„åšå®¢äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— åº•æ´ï¼Œå°±è·Ÿæ‰“æ¸¸æˆä¸€æ ·ï¼Œå½“ä½ åˆ°è¾¾å…­åçº§ä¹‹åï¼Œä½ å‘ç°ç‰ˆæœ¬æ›´æ–°äº†ï¼Œé¡¶çº§å˜æˆäº†å…«åçº§ï¼Œè€Œä¸”ï¼Œç›®å‰çœ‹æ¥ä½ è‡ªå·±åªæœ‰ä¸‰çº§ï¼Œåªæ˜¯è‡ªå·±æ„Ÿè§‰è‡ªå·±æ˜¯å…­åçº§<del>~~ å°±åƒæˆ‘ï¼Œè¿™ä¸ªä¸œè¥¿æˆ‘è¶³è¶³èŠ±äº†ä¸€å‘¨å¤šï¼Œå½“ç„¶ä¹Ÿæœ‰æˆ‘ç»å¸¸åŠ ç­çš„åŸå› å§ï¼Œå¥½äº†ä¸åæ§½äº†</del></p><h1 id="è¿›å…¥æ­£é¢˜"><a href="#è¿›å…¥æ­£é¢˜" class="headerlink" title="è¿›å…¥æ­£é¢˜"></a>è¿›å…¥æ­£é¢˜</h1><h2 id="pjaxåˆä½“éªŒâ€“instantclick"><a href="#pjaxåˆä½“éªŒâ€“instantclick" class="headerlink" title="pjaxåˆä½“éªŒâ€“instantclick"></a>pjaxåˆä½“éªŒâ€“instantclick</h2><p>é¦–å…ˆæœ¬äººåŠ äº†ä¸€ä¸ªä¸è’œå­çš„ç¾¤ï¼Œçœ‹åˆ°æœ‰äººè¯´instantclickèƒ½å¤Ÿå®ç°è‡ªå·±çš„åšå®¢å®ç°ä¸ä¸­æ–­çš„æ’­æ”¾ï¼ˆå¤§å®¶éƒ½çŸ¥é“åšå®¢ä¸€åˆ·æ–°ï¼Œä¸€æ¢é¡µï¼Œæ’­æ”¾çš„æ­Œæ›²æ’ä»¶è‚¯å®šä¹Ÿä¼šåˆ·æ–°ï¼Œæ­Œä¹Ÿå°±æ–­äº†ï¼‰ï¼Œçœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰æ„Ÿè§‰äº†~~ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘å°±å¼€å§‹æ‹¼å‘½çš„å¾€é‡Œé¢åŠ ï¼Œå¤§æ¦‚èŠ±äº†ä¸¤å¤©æ”¾å¼ƒäº†ï¼Œå¯æ˜¯æ— å¥ˆä¸­æ–‡æ–‡æ¡£ä¹Ÿæ¯”è¾ƒå°‘ï¼Œè€Œä¸”ï¼Œbugå·¨å¤šï¼Œæœ€å¤§çš„åŸå› ä¹Ÿæ˜¯bugå·¨å¤šï¼Œé€‚é…èµ·æ¥ååˆ†éº»çƒ¦ï¼Œæ¯”å¦‚å¤šè¯´è¯„è®ºç³»ç»Ÿç­‰ç­‰ã€‚ä½†æ˜¯é€Ÿåº¦ç¡®å®è›®å¿«çš„ï¼Œå› ä¸ºå¯ä»¥1é¼ æ ‡æ”¾åˆ°æ ‡ç­¾ä¸Šå®ç°é¢„åŠ è½½2é¼ æ ‡ç‚¹ä¸‹å»çš„ç¬é—´å®ç°é¢„åŠ è½½ï¼Œè€Œä¸”å¯ä»¥è‡ªå·±è®¾å®šé¢„åŠ è½½çš„æ—¶é—´ã€‚ï¼ˆå¥½åƒæ˜¯è¿™ä¹ˆå›äº‹ï¼Œæ—¶é—´å¤ªä¹…è¿œäº†ï¼‰<br>ä¸‹é¢è´´å‡ºæˆ‘æ‰¾åˆ°çš„å‡ ä¸ªæ•™ç¨‹ï¼Œå¯¹äºbugå¤šè¿™ç‚¹ä¸ä»‹æ„ï¼Œå–œæ¬¢é’»ç ”çš„åŒå­¦å¯ä»¥çœ‹çœ‹ï¼š<br><a href="https://www.ihewro.com/archives/515/" target="_blank" rel="noopener">https://www.ihewro.com/archives/515/</a><br><a href="https://qqdie.com/archives/instantclick.html" target="_blank" rel="noopener">https://qqdie.com/archives/instantclick.html</a><br><a href="https://www.jianshu.com/p/c306360e4270" target="_blank" rel="noopener">https://www.jianshu.com/p/c306360e4270</a><br><a href="https://www.songhaifeng.com/razt/32.html" target="_blank" rel="noopener">https://www.songhaifeng.com/razt/32.html</a><br>å¥½äº†å°±å…ˆè¿™ä¹ˆå¤šï¼Œgoogleä¸Šä¹Ÿæœ‰å¥½å¤šï¼Œèµ¶ç´§è®©æˆ‘ä»¬è¿›å…¥æ­£é¢˜å§~</p><h2 id="çœŸæ­£çš„pjax"><a href="#çœŸæ­£çš„pjax" class="headerlink" title="çœŸæ­£çš„pjax"></a>çœŸæ­£çš„pjax</h2><p>å®˜æ–¹ä»‹ç»ï¼špushState + ajax = pjax å¸¦æ¥æœ€ç›´è§‚çš„æ•ˆæœæ˜¯æ•´ä¸ªç½‘ç«™å˜æˆå•é¡µåº”ç”¨ã€‚è¿™æ ·çš„æ•ˆæœå°†ä¼šæå¤§çš„æå‡ç”¨æˆ·ä½“éªŒï¼Œå¹¶ä¸”å¯ä»¥å‡å°‘httpsçš„è¯·æ±‚çš„æ¬¡æ•°å’Œå†…å®¹ã€‚ä½¿ç”¨githubä¸Šé¢çš„ä¸€ä¸ªå¼€æºé¡¹ç›®defunkt/jquery-pjax å¯ä»¥å¾ˆè½»æ¾çš„å¸®åŠ©æˆ‘ä»¬å®ç°pjaxã€‚</p><p>è¿™æ ·å¯ä»¥å®ç°ï¼Œåˆ·æ–°çš„æ—¶å€™åªåŠ è½½å±€éƒ¨çš„htmlå’Œcss js å¤§å¤§åŠ å¿«é€Ÿåº¦ã€‚<br>çœŸè¯šæé†’ï¼šå¦‚æœå¯¹å‰ç«¯ä¸€ç‚¹ç‚¹åŸºç¡€éƒ½æ²¡æœ‰çš„è¯ï¼Œè¦ä¸å°±æ”¾å¼ƒå§ã€‚</p><h3 id="ç¬¬ä¸€æ­¥"><a href="#ç¬¬ä¸€æ­¥" class="headerlink" title="ç¬¬ä¸€æ­¥"></a>ç¬¬ä¸€æ­¥</h3><p>æ‰¾åˆ°theme-&gt;next-&gt;layout-&gt;_layout.swigæ–‡ä»¶<br>åœ¨å¼€å¤´åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/js/src/pjax/pjaxBase.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>è§£é‡Šä¸€ä¸‹ï¼šå‰ä¸¤è¡Œæ˜¯å¼•å…¥jqæ–‡ä»¶å’Œpjaxçš„jsæ–‡ä»¶ï¼Œjqæ–‡ä»¶å¿…é¡»åœ¨pjaxæ–‡ä»¶å‰é¢å¼•å…¥ï¼Œç¬¬ä¸‰è¡Œæ˜¯å¼•å…¥æˆ‘è‡ªå·±çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯æˆ‘è‡ªå·±diyçš„ç›®å½•å¦‚å›¾ã€‚åœ¨ç¬¬äºŒè¡Œä¸‹é¢<script></script>ä¸­é—´åŠ å…¥å†…å®¹æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</p></blockquote><h3 id="ç¬¬äºŒæ­¥"><a href="#ç¬¬äºŒæ­¥" class="headerlink" title="ç¬¬äºŒæ­¥"></a>ç¬¬äºŒæ­¥</h3><p>è¿˜æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åœ¨åº•éƒ¨åŠ å…¥</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;# åœ¨è¿™é‡Œä¾æ¬¡åŠ è½½<span class="name">pjax</span>éœ€è¦çš„jsæ–‡ä»¶ #&#125;</span><span class="xml">//swigæ–‡ä»¶ä¸­çš„æ³¨é‡Šæ˜¯è¿™æ ·å­çš„</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/category_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/opacity_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/motion_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/velocity.ui_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/velocity_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/bootstrap_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/scrollspy_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/utils_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>   <span class="attr">src</span>=<span class="string">"/js/src/pjax/post-details_js.js"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„æ–‡ä»¶æ˜¯æœ‰é¡ºåºçš„ï¼Œå…·ä½“çš„æˆ‘ä¼šåœ¨ä¸‹æ–‡è¯¦ç»†è®²è¿°ã€‚</p><h3 id="ç¬¬ä¸‰æ­¥"><a href="#ç¬¬ä¸‰æ­¥" class="headerlink" title="ç¬¬ä¸‰æ­¥"></a>ç¬¬ä¸‰æ­¥</h3><p>ç¬¬äºŒæ­¥ä¸­çš„è¿™äº›æ–‡ä»¶éƒ½æ˜¯æˆ‘è‡ªå·±åŠ å…¥çš„ï¼ŒåŸå› æ˜¯å› ä¸ºï¼ˆåˆ’é‡ç‚¹äº†ï¼ï¼ï¼ï¼‰<br><strong>åœ¨pjaxä¸­æ˜¯å±€éƒ¨åˆ·æ–°çš„ä¹Ÿå°±æ˜¯å±€éƒ¨åŠ è½½çš„ï¼Œè€Œä»¥ä¸Šçš„æ–‡ä»¶ï¼Œnextä¸»é¢˜ä¸­æœ¬èº«æ˜¯æ²¡æœ‰çš„ï¼ŒåŸæ¥çš„æ–‡ä»¶åç§°æ²¡æœ‰æˆ‘çš„_jsåç¼€ï¼Œåœ¨ç›®å½•next-&gt;source-&gt;js-&gt;srcä¸‹é¢ï¼Œ<br>æºæ–‡ä»¶å¤§éƒ¨åˆ†éƒ½æ˜¯$(document).ready()çš„ï¼Œè¿™ä¸ªå‡½æ•°ï¼Œå¤§å®¶å¯ä»¥ä¸Šç½‘å¥½å¥½æŸ¥æŸ¥ï¼Œæ˜¯åŠ è½½å®Œæ•´ä¸ªdomç»“æ„åè¿›è¡ŒåŠ è½½çš„ï¼Œå½“ç„¶äº†å’Œjsä¸­çš„Window.onloadæ˜¯ä¸ä¸€æ ·çš„ï¼Œåè€…æ˜¯åœ¨å›¾ç‰‡ç­‰å…¨éƒ¨åŠ è½½å®Œä¹‹åæ‰ä¼šåŠ è½½jsï¼Œå¥½äº†ä¸é—²æ‰¯äº†ï¼Œæ³¨æ„å°†è¿™äº›æ–‡ä»¶å¤åˆ¶åˆ°æˆ‘ä¸Šé¢çš„ç›®å½•ä¸‹å¹¶ä¸”é‡å‘½åä¾‹å¦‚ï¼š/js/src/pjax/bootstrap_js.jsç„¶åå°†æ‰€æœ‰çš„æ–‡ä»¶éƒ½æŠŠ$(document).ready()å»æ‰ï¼Œç„¶åç”¨function xxxåŒ…ä½ï¼Œè¿™æ ·å°±å¯ä»¥å¤–éƒ¨è°ƒç”¨äº†ï¼Œæˆ‘ä¼šåœ¨ä¸‹é¢è®²åˆ°ï¼Œå¾ˆæœ‰ç”¨å“¦ã€‚</strong></p><blockquote><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºnextçš„jsæ˜¯ç›¸äº’è°ƒç”¨çš„ï¼Œæœ¬äººæ¯”è¾ƒæ‡’ï¼Œå®åœ¨æ²¡æœ‰æ—¶é—´é˜…è¯»å…¨éƒ¨çš„æºç ã€‚</p></blockquote><p>ç›®å½•ï¼š</p><h3 id="ç¬¬å››æ­¥"><a href="#ç¬¬å››æ­¥" class="headerlink" title="ç¬¬å››æ­¥"></a>ç¬¬å››æ­¥</h3><p><img alt="upload successful" data-original="/images/my_blog_11.png"></p><p>å¦‚ä¸Šé¢çš„ç›®å½•ï¼Œè¿™äº›æœ‰çš„æ˜¯æˆ‘å¤åˆ¶çš„ç³»ç»Ÿæ ¸å¿ƒçš„ï¼Œå› ä¸ºåœ¨pæˆ‘å•ç‹¬è¿˜å»ºäº†ä¸€ä¸ª/js/src/pjax/pjaxBase.jsï¼Œä½ å¯èƒ½å°±æ‡‚äº†ç¬¬ä¸€æ­¥äº†ã€‚è¿™ä¸ªjsæ˜¯pjaxçš„æ ¸å¿ƒï¼Œä¸‹é¢è´´å‡ºæºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define(['jquery','jquery_pjax_min_js'],function () &#123;</span></span><br><span class="line">$(<span class="built_in">document</span>).pjax(<span class="string">'a[target!=_blank]'</span>, <span class="string">'#pjax-container'</span>, &#123;</span><br><span class="line">  fragment: <span class="string">'#pjax-container'</span>,</span><br><span class="line">  timeout: <span class="number">5000</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//ç”¨æˆ·é€šè¿‡æµè§ˆå™¨çš„å‰è¿›åé€€æŒ‰é’®ï¼Œéœ€è¦åŠ è½½çš„js</span></span><br><span class="line">$(<span class="built_in">window</span>).on(<span class="string">'popstate.pjax'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  $(<span class="built_in">document</span>).on(<span class="string">'pjax:complete'</span>,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      $(<span class="string">'img'</span>).lazyload(&#123;</span><br><span class="line">        placeholder: <span class="string">'/images/loading.gif'</span>,</span><br><span class="line">        effect: <span class="string">'fadeIn'</span>,</span><br><span class="line">        threshold : <span class="number">100</span>,</span><br><span class="line">        failure_limit : <span class="number">20</span>,</span><br><span class="line">        skip_invisible : <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line">      pjax();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:start'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">$(<span class="built_in">document</span>).on(<span class="string">'pjax:complete'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>.config(&#123;</span><br><span class="line">      paths: &#123;</span><br><span class="line">      <span class="comment">//ä¸‹é¢æ³¨é‡Šçš„è¿™å‡ ä¸ªjsæ˜¯ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå› ä¸ºç»™ä¸»é¢˜åŠ å…¥äº†require.jsæå‡æ€§èƒ½ï¼Œæ‰€ä»¥å°†ä»–ä»¬æ•´åˆåˆ°äº†ä¸‹é¢pjax_function_publicæ–‡ä»¶ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</span></span><br><span class="line">        <span class="comment">// "category_js": "/js/src/pjax/category_js",</span></span><br><span class="line">        <span class="comment">// "opacity_js":"/js/src/pjax/opacity_js",</span></span><br><span class="line">        <span class="comment">// "motion_js":"/js/src/pjax/motion_js",</span></span><br><span class="line">        <span class="comment">// "scrollspy_js":"/js/src/pjax/scrollspy_js",</span></span><br><span class="line">        <span class="comment">// "post-details_js":"/js/src/pjax/post-details_js",</span></span><br><span class="line">        <span class="comment">// "lean_analytics":"/js/src/pjax/lean_analytics",</span></span><br><span class="line">        <span class="comment">// "baidutuisong":"/js/src/pjax/baidutuisong",</span></span><br><span class="line">        <span class="comment">// "utils_js":"/js/src/pjax/utils_js",</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"jquery.share.min"</span>:<span class="string">"/js/src/pjax/share/jquery.share.min"</span>,</span><br><span class="line">        <span class="comment">// "share":"/js/src/pjax/share",</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªä¹Ÿæ˜¯å•ç‹¬çš„</span></span><br><span class="line">        <span class="string">"css"</span>:<span class="string">"/js/src/pjax/css"</span>,</span><br><span class="line">        <span class="comment">//æˆ‘å°†ä¸Šé¢æ³¨é‡Šçš„å†…å®¹æ•´åˆåˆ°äº†è¿™ä¸ªjsä¸­ï¼Œä¸ºäº†æ›´å¥½çš„æå‡æ€§èƒ½ï¼Œå› ä¸ºè™½ç„¶ä¸€æ ·çš„å†…å®¹ï¼Œå¤šæ¬¡è¯»å–æ–‡ä»¶ï¼Œå’Œè¯»ä¸€ä¸ªæ–‡ä»¶ï¼Œæ•ˆç‡è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å·®è·çš„ã€‚</span></span><br><span class="line">        <span class="string">"pjax_function_public"</span>:<span class="string">"/js/src/pjax/pjax_function_public"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      shim: &#123;</span><br><span class="line">        <span class="string">'share'</span>: &#123;</span><br><span class="line">          deps: [</span><br><span class="line">            <span class="string">'css!/js/src/pjax/share/share.min'</span>,<span class="string">'jquery.share.min'</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>([<span class="string">'jquery.share.min'</span>,<span class="string">'share'</span>,<span class="string">'css'</span>,<span class="string">'pjax_function_public'</span></span><br><span class="line">    ], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'img'</span>).lazyload(&#123;</span><br><span class="line">          placeholder: <span class="string">'/images/loading.gif'</span>,</span><br><span class="line">          effect: <span class="string">'fadeIn'</span>,</span><br><span class="line">          threshold : <span class="number">100</span>,</span><br><span class="line">          failure_limit : <span class="number">20</span>,</span><br><span class="line">          skip_invisible : <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      pjax();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjax</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*å› ä¸ºä¸‹é¢çš„postdetails_jsä¸­çš„æœ‰ä¸ªåˆ¤æ–­ç©ºæŒ‡é’ˆçš„ï¼Œå¦‚æœåŠ ä¸Šå°±ä¸èƒ½å·¦ç§»ï¼Œå¦‚æœå»æ‰ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æŠŠè¿™ä¸ªæ”¾åœ¨é¦–è¡Œæ¥æ‰§è¡Œã€‚*/</span></span><br><span class="line">  <span class="comment">/*ç°åœ¨å·²ç»è§£å†³,å¯ä»¥æ”¾åœ¨ä»»æ„çš„ä½ç½®*/</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">      ä¹‹å‰ä¸€ç›´æ˜¯å¥½çš„çªç„¶æœ‰æ¬¡å°±ä¸å¥½äº†ï¼Œåæ¥è§£å†³äº†å³è¾¹sidebaræ»šè½®æ•ˆæœæ¶ˆå¤±çš„æ•ˆæœä¹‹åï¼Œçªç„¶åˆå¥½äº†ã€‚</span></span><br><span class="line"><span class="comment">      åŸå› æ˜¯å› ä¸ºï¼Œä¹‹å‰æ”¾åœ¨detail jsçš„ä¸‹é¢ï¼Œè€Œdetailçš„ä¸‹é¢undfindçš„åˆ¤æ–­æ—¶æŠ¥é”™çš„ï¼Œæ‰€ä»¥ä¸ä¼šå¾€ä¸‹èµ°ã€‚</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="comment">/*åˆ¤æ–­#lv-containeræ˜¯å¦ä¸ºç©ºï¼Œç›®å‰è¿™æ˜¯æˆ‘æ‰¾åˆ°æœ€å¥½çš„åŠæ³•ï¼Œå› ä¸ºä¸åˆ¤æ–­ï¼Œè¿›å…¥é¦–é¡µæˆ–å…¶ä»–çš„é¡µé¢ä¼šç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚*/</span></span><br><span class="line">  <span class="keyword">if</span> ($(<span class="string">"#lv-container"</span>).length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">    $(<span class="string">".comments"</span>).css(&#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;);</span><br><span class="line">    $.getScript(<span class="string">"https://cdn-city.livere.com/js/embed.dist.js"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ä¸è’œå­js</span></span><br><span class="line">  $.getScript(<span class="string">"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è‡ªå·±å†™çš„åˆ†äº«</span></span><br><span class="line">  pjaxshare();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç±»çš„js</span></span><br><span class="line">  category_js();</span><br><span class="line"><span class="comment">// å±€éƒ¨åˆ·æ–°åæ–‡ç« å†…å®¹ä¸æ˜¾ç¤ºbugçš„js</span></span><br><span class="line">  opacity_js()</span><br><span class="line"><span class="comment">//ç‚¹å‡»æœ‰ç›®å½•çš„æ–‡ç« sidebarä¸æ˜¾ç¤ºçš„bugè§£å†³</span></span><br><span class="line">  motion_js()</span><br><span class="line">  scrollspy_js()</span><br><span class="line">  <span class="comment">//utils_js()</span></span><br><span class="line">  postdetails_js()</span><br><span class="line"><span class="comment">//leanæ•°é‡ç»Ÿè®¡çš„jsï¼ŒåŸæ¥çš„jsæ˜¯åœ¨themes/next/layout/_third-party/analytics/lean-analytics.swigæ–‡ä»¶ä¸­</span></span><br><span class="line">  lean_analytics();</span><br><span class="line">  <span class="comment">//ç™¾åº¦æ¨é€js</span></span><br><span class="line">  baidutuisong();</span><br><span class="line"><span class="comment">//     //å³è¾¹sidebaræ»šè½®æ•ˆæœæ¶ˆå¤±äº†ã€‚</span></span><br><span class="line">  initSidebarDimension()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹ï¼š<br>$(document).pjax(â€˜a[target!=_blank]â€™ â€˜#mainâ€™, {<br>fragment: â€˜#mainâ€™,<br>timeout: 5000,<br>});<br>è¿™ä¸ªå‡½æ•°æ˜¯pjaxçš„æ ¸å¿ƒï¼Œ<br>â€˜a[target!=_blank]â€™æ˜¯ä½ å°†ä¼šç‚¹å‡»çš„æ ‡ç­¾[target!=_blank]ï¼Œæ˜¯å½“ä½ çš„æ ‡ç­¾æ˜¯blankçš„æ—¶å€™å°±æ˜¯éœ€è¦ç‚¹å‡»å‡ºç°ä¸€ä¸ªæ–°çš„çª—å£ï¼Œæ¯”å¦‚å‹é“¾ä¹‹ç±»çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸è¿›è¡Œå±€éƒ¨åŠ è½½äº†ï¼Œæ²¡æœ‰ç±»ä¼¼aæ ‡ç­¾çš„å¯ä»¥çœç•¥ã€‚<br>â€˜#mainâ€™æ˜¯ä½ å°†ä¼šåˆ·æ–°çš„åœ°æ–¹<br>fragment: â€˜#mainâ€™,æ˜¯æŠŠé‚£ä¸ªåœ°æ–¹çš„ä»£ç åˆ·æ–°ç„¶åæ”¾åˆ°â€™#mainâ€™ä¸­<br>timeoutï¼Œæ‡‚jså¾—éƒ½æ‡‚å°±ä¸è§£é‡Šäº†ã€‚</p><p>$(document).on(â€˜pjax:completeâ€™,<br>function() {}<br>åˆ’é‡ç‚¹äº†ï¼šè¿™ä¸ªå‡½æ•°æ˜¯åœ¨å±€éƒ¨åŠ è½½å®Œä¹‹åè‡ªå·±éœ€è¦DIYçš„jsï¼Œå› ä¸ºpjaxæ˜¯å±€éƒ¨åŠ è½½æˆ‘å·²ç»å¼ºè°ƒäº†å¾ˆå¤šéäº†ï¼Œè¿™ä¸ªæ—¶å€™æœ‰çš„jsä¼šå¤±æ•ˆæ¯”å¦‚è¯´è¯„è®ºåŠŸèƒ½ã€‚<br>è¿™ä¸ªæ—¶å€™å¼•å…¥æˆ‘ä»¬ä¹‹å‰å®šä¹‰å¥½çš„å‡½æ•°ã€‚å®Œæˆï¼</p><p>è´´å‡ ä¸ªå¯¹æˆ‘å¾ˆæœ‰å¸®åŠ©çš„åšæ–‡å’Œhexo nextçš„åšå®¢å’Œä¸€ä¸ªgithubï¼Œå®åœ¨ä¸æ‡‚å¾—å¯ä»¥æ‰’ä¸€æ‰’åˆ«äººçš„githubæºç ï¼Œæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚<br><a href="https://www.ihewro.com/archives/354/comment-page-3#comments" target="_blank" rel="noopener">https://www.ihewro.com/archives/354/comment-page-3#comments</a><br><a href="https://www.jimoe.cn/archives/typecho-add-pjax.html" target="_blank" rel="noopener">https://www.jimoe.cn/archives/typecho-add-pjax.html</a><br><a href="http://yelog.org/2017/02/08/pjax/" target="_blank" rel="noopener">http://yelog.org/2017/02/08/pjax/</a><br><a href="https://www.jianshu.com/p/808a647dc324" target="_blank" rel="noopener">https://www.jianshu.com/p/808a647dc324</a><br><a href="https://blog.dyboy.cn/" target="_blank" rel="noopener">https://blog.dyboy.cn/</a><br><a href="https://blog.flysay.com/" target="_blank" rel="noopener">https://blog.flysay.com/</a><br><a href="https://github.com/DIYgod/hexo-theme-sagiri" target="_blank" rel="noopener">https://github.com/DIYgod/hexo-theme-sagiri</a><br><a href="http://www.qingpingshan.com/m/view.php?aid=355579" target="_blank" rel="noopener">http://www.qingpingshan.com/m/view.php?aid=355579</a><br><a href="https://diygod.me/" target="_blank" rel="noopener">https://diygod.me/</a><br>ä¸­é—´æœ‰ä¸ªå°æŠ€å·§:chromçš„å®¡æŸ¥å…ƒç´ é‡Œé¢çš„å†…å®¹æ˜¯å¯ä»¥ç§»åŠ¨å’Œåˆ é™¤çš„ï¼Œæ›´åˆ©äºæˆ‘ä»¬çš„æ£€æŸ¥ã€‚</p><h1 id="ä¸“é—¨åŸºäºhexo-nextä¸»é¢˜çš„pjaxï¼ˆå°†ä¸¢å¤±çš„jsæ•ˆæœé‡ç°ï¼‰"><a href="#ä¸“é—¨åŸºäºhexo-nextä¸»é¢˜çš„pjaxï¼ˆå°†ä¸¢å¤±çš„jsæ•ˆæœé‡ç°ï¼‰" class="headerlink" title="ä¸“é—¨åŸºäºhexo nextä¸»é¢˜çš„pjaxï¼ˆå°†ä¸¢å¤±çš„jsæ•ˆæœé‡ç°ï¼‰"></a>ä¸“é—¨åŸºäºhexo nextä¸»é¢˜çš„pjaxï¼ˆå°†ä¸¢å¤±çš„jsæ•ˆæœé‡ç°ï¼‰</h1><h2 id="å°†ä¸‹é¢è®²åˆ°çš„æå–å‡ºæ¥"><a href="#å°†ä¸‹é¢è®²åˆ°çš„æå–å‡ºæ¥" class="headerlink" title="å°†ä¸‹é¢è®²åˆ°çš„æå–å‡ºæ¥"></a>å°†ä¸‹é¢è®²åˆ°çš„æå–å‡ºæ¥</h2><p><strong>å› ä¸ºå¾ˆå¤šäº‹è¢«åŒ…è£…åœ¨$(documnent).ready(function(){})é‡Œé¢çš„ï¼Œæ‰€ä»¥pjaxä¸èƒ½åŠ è½½çš„åŸå› å°±åœ¨è¿™é‡Œã€‚è‡ªå·±æå–å‡ºæ¥ï¼Œå°è£…æˆå‡½æ•°è‡ªå·±è°ƒç”¨å³å¯</strong><br><strong>ä¸‹é¢çš„éœ€è¦å‰ç«¯åŸºç¡€ï¼Œä¼šé€šè¿‡æ–­ç‚¹è¿›è¡Œå®¡æŸ¥</strong></p><h2 id="ç‚¹å‡»å³è¾¹çš„sidebarï¼Œsidebarä¸å‡ºç°"><a href="#ç‚¹å‡»å³è¾¹çš„sidebarï¼Œsidebarä¸å‡ºç°" class="headerlink" title="ç‚¹å‡»å³è¾¹çš„sidebarï¼Œsidebarä¸å‡ºç°"></a>ç‚¹å‡»å³è¾¹çš„sidebarï¼Œsidebarä¸å‡ºç°</h2><p>ç»è¿‡é˜…è¯»æºç ï¼Œç‚¹å‡»äº‹ä»¶åœ¨motion.jsä¸­ï¼Œå°†ç›¸åº”çš„ä»£ç æå–å‡ºæ¥<br>motion.js<br></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">this</span>.toggleEl.on(<span class="string">'click'</span>, <span class="keyword">this</span>.clickHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.dimmerEl.on(<span class="string">'click'</span>, <span class="keyword">this</span>.clickHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.toggleEl.on(<span class="string">'mouseenter'</span>, <span class="keyword">this</span>.mouseEnterHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.toggleEl.on(<span class="string">'mouseleave'</span>, <span class="keyword">this</span>.mouseLeaveHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.sidebarEl.on(<span class="string">'touchstart'</span>, <span class="keyword">this</span>.touchstartHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.sidebarEl.on(<span class="string">'touchend'</span>, <span class="keyword">this</span>.touchendHandler.bind(<span class="keyword">this</span>));</span><br><span class="line">      <span class="keyword">this</span>.sidebarEl.on(<span class="string">'touchmove'</span>, function(e)&#123;e.preventDefault();&#125;);</span><br><span class="line">`</span><br></pre></td></tr></table></figure><p></p><p>post_detail.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TOC item animation navigate &amp; prevent #item selector in adress bar.</span></span><br><span class="line">  $(<span class="string">'.post-toc a'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">var</span> targetSelector = NexT.utils.escapeSelector(<span class="keyword">this</span>.getAttribute(<span class="string">'href'</span>));</span><br><span class="line">    <span class="keyword">var</span> offset = $(targetSelector).offset().top;</span><br><span class="line"></span><br><span class="line">    hasVelocity ?</span><br><span class="line">      html.velocity(<span class="string">'stop'</span>).velocity(<span class="string">'scroll'</span>, &#123;</span><br><span class="line">        offset: offset  + <span class="string">'px'</span>,</span><br><span class="line">        mobileHA: <span class="literal">false</span></span><br><span class="line">      &#125;) :</span><br><span class="line">      $(<span class="string">'html, body'</span>).stop().animate(&#123;</span><br><span class="line">        scrollTop: offset</span><br><span class="line">      &#125;, <span class="number">500</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ˜¯çº¿ç´¢ï¼Œåƒjavaä¸€æ ·ç‚¹åˆ°è‡ªå·±éœ€è¦çš„åœ°æ–¹ï¼Œå±•å¼€é€»è¾‘ã€‚</p><h3 id="sidebarè‡ªåŠ¨éšè—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»å‡ºç°ï¼Œç‚¹å‡»éšè—ï¼Œå›åˆ°é¦–é¡µï¼Œå›åˆ°ä¸­é—´ç­‰æ“ä½œ"><a href="#sidebarè‡ªåŠ¨éšè—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»å‡ºç°ï¼Œç‚¹å‡»éšè—ï¼Œå›åˆ°é¦–é¡µï¼Œå›åˆ°ä¸­é—´ç­‰æ“ä½œ" class="headerlink" title="sidebarè‡ªåŠ¨éšè—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»å‡ºç°ï¼Œç‚¹å‡»éšè—ï¼Œå›åˆ°é¦–é¡µï¼Œå›åˆ°ä¸­é—´ç­‰æ“ä½œ"></a>sidebarè‡ªåŠ¨éšè—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»å‡ºç°ï¼Œç‚¹å‡»éšè—ï¼Œå›åˆ°é¦–é¡µï¼Œå›åˆ°ä¸­é—´ç­‰æ“ä½œ</h3><p>é‡Œé¢å¦‚æœé‡åˆ°ä¸è®¤è¯†çš„å‡½æ•°ï¼Œå¯èƒ½æ˜¯hexoè‡ªå·±å°è£…çš„æ¯”å¦‚tocï¼Œ<br>hexoè‡ªå·±çš„è¾…åŠ©å‡½æ•°ï¼š<a href="https://hexo.io/zh-cn/docs/helpers.html" target="_blank" rel="noopener">https://hexo.io/zh-cn/docs/helpers.html</a><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ä¸‹é¢è¿™æ®µä»£ç æ˜¯å…³äºå³è¾¹çš„sidebarçš„jsçš„æ ¸å¿ƒåŒ…æ‹¬ï¼š</span></span><br><span class="line"><span class="comment">  è‡ªåŠ¨éšè—ï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»å‡ºç°ï¼Œç‚¹å‡»éšè—ï¼Œå›åˆ°é¦–é¡µï¼Œå›åˆ°ä¸­é—´ç­‰æ“ä½œ*/</span></span><br><span class="line">  <span class="comment">// Expand sidebar on post detail page by default, when post has a toc.</span></span><br><span class="line">  var $tocContent = $(<span class="string">'.post-toc-content'</span>);</span><br><span class="line">  var isSidebarCouldDisplay = CONFIG.sidebar.display === <span class="string">'post'</span> ||</span><br><span class="line">      CONFIG.sidebar.display === <span class="string">'always'</span>;</span><br><span class="line">  var hasTOC = $tocContent.length &gt; <span class="number">0</span> &amp;&amp; $tocContent.html().trim().length &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (isSidebarCouldDisplay &amp;&amp; hasTOC) &#123;</span><br><span class="line"></span><br><span class="line">      NexT.utils.displaySidebar();</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*åˆ¤æ–­this.sidebarElæ˜¯å¦ä¸ºnullï¼Œå› ä¸ºä»é¦–é¡µè¿›å…¥ç•™è¨€æ¿çš„æ—¶å€™å¹¶æ²¡æœ‰this.sidebarElè¿™ä¸ªå±æ€§ï¼Œå›æŠ¥ç±»ä¼¼äºç©ºæŒ‡é’ˆçš„å¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment"> ä¸‹é¢è¿™ä¸ªç©ºæŒ‡é’ˆçš„åˆ¤æ–­æš‚æ—¶æ³¨é‡Šæ‰å› ä¸ºï¼Œå¦‚æœæ‰“å¼€çš„ï¼Œè¿”å›åˆ°é¦–é¡µçš„æ—¶å€™å¹¶æ²¡æœ‰this.sidebarElï¼Œ</span></span><br><span class="line"><span class="comment">ä¸‹é¢çš„ä»£ç ä¸ä¼šè¿›è¡Œï¼Œä¸‹é¢çš„ï¼Œæ–‡ç« åœ¨å·¦é¢æ²¡å›å»çš„bugå°±æ— æ³•å¾—åˆ°è§£å†³ã€‚*/</span></span><br><span class="line"><span class="comment">/*å·²ç»å°†ç©ºæŒ‡é’ˆå¼‚å¸¸çš„åˆ¤æ–­æ‰“å¼€ï¼Œå› ä¸ºä¸‹é¢çš„æºç æ˜¯this.sidebarï¼Œè¿™é‡Œçš„thiså¯èƒ½å¹¶ä¸æ˜¯elementï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æœªå®šä¹‰ï¼Œå…¶å®åœ¨elementä¸­æ˜¯å®šä¹‰äº†çš„</span></span><br><span class="line"><span class="comment">* åœ¨è¿™é‡Œå°†thiså»æ‰å°±è§£å†³äº†*/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* ä¸‹é¢è¿™æ®µæºç åœ¨motion.jsä¸­çš„hideSidebaræ–¹æ³•ã€‚*/</span></span><br><span class="line">    var sidebarEl=$(<span class="string">'.sidebar'</span>)</span><br><span class="line">    <span class="keyword">if</span> (typeof(sidebarEl)!=  <span class="string">"undefined"</span>) &#123;</span><br><span class="line">      NexT.utils.isDesktop() &amp;&amp; $(<span class="string">'body'</span>).velocity(<span class="string">'stop'</span>).velocity(&#123;paddingRight: <span class="number">0</span>&#125;);</span><br><span class="line">      sidebarEl.find(<span class="string">'.motion-element'</span>).velocity(<span class="string">'stop'</span>).css(<span class="string">'display'</span>, <span class="string">'none'</span>);</span><br><span class="line">      sidebarEl.velocity(<span class="string">'stop'</span>).velocity(&#123;width: <span class="number">0</span>&#125;, &#123;display: <span class="string">'none'</span>&#125;);</span><br><span class="line">      <span class="comment">/*sidebarToggleLinesæ˜¯åœ¨motion jsé‡Œé¢çš„ï¼Œåœ¨è¿™é‡Œå›æŠ¥é”™ï¼Œåœ¨ä¸‹é¢è¿›è¡Œäº†å¼•ç”¨*/</span></span><br><span class="line">      sidebarToggleLines.init();</span><br><span class="line">      sidebarEl.removeClass(<span class="string">'sidebar-active'</span>);</span><br><span class="line">      sidebarEl.trigger(<span class="string">'sidebar.isHiding'</span>);</span><br><span class="line">      <span class="comment">// Prevent adding TOC to Overview if Overview was selected when close &amp; open sidebar.</span></span><br><span class="line">      <span class="comment">/*ä¸‹é¢çš„elseçš„jsæ˜¯æˆ‘è‡ªå·±åŠ çš„å› ä¸ºï¼Œç‚¹å‡»æœ‰ç›®å½•çš„æ–‡ç« åå³ä¾§sidebarä¼šè‡ªåŠ¨å‡ºæ¥ï¼Œæ–‡ç« ä¼šè‡ªåŠ¨å¾€å·¦é¢èµ°ï¼Œå› ä¸ºmarginæ˜¯0 autoçš„ã€‚è¿™ä¸ªæ—¶å€™ç‚¹å‡»ä¸»é¡µï¼Œ</span></span><br><span class="line"><span class="comment">      æ–‡ç« è¿˜æ˜¯åœ¨å·¦é¢çš„æ²¡æœ‰å›å»ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªbug*/</span></span><br><span class="line">      <span class="keyword">if</span> (!!$(<span class="string">'.post-toc-wrap'</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($(<span class="string">'.site-overview-wrap'</span>).css(<span class="string">'display'</span>) === <span class="string">'block'</span>) &#123;</span><br><span class="line">          $(<span class="string">'.post-toc-wrap'</span>).removeClass(<span class="string">'motion-element'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          $(<span class="string">'.post-toc-wrap'</span>).addClass(<span class="string">'motion-element'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">var sidebarToggleLines = &#123;</span><br><span class="line">  lines: [],</span><br><span class="line">  push: function (line) &#123;</span><br><span class="line">    <span class="keyword">this</span>.lines.push(line);</span><br><span class="line">  &#125;,</span><br><span class="line">  init: function () &#123;</span><br><span class="line">    <span class="keyword">this</span>.lines.forEach(function (line) &#123;</span><br><span class="line">      line.init();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  arrow: function () &#123;</span><br><span class="line">    <span class="keyword">this</span>.lines.forEach(function (line) &#123;</span><br><span class="line">      line.arrow();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  close: function () &#123;</span><br><span class="line">    <span class="keyword">this</span>.lines.forEach(function (line) &#123;</span><br><span class="line">      line.close();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">`</span><br></pre></td></tr></table></figure><p></p><h3 id="æ·»åŠ bootstrpå‡ºç°é—ªå±çš„ç°è±¡"><a href="#æ·»åŠ bootstrpå‡ºç°é—ªå±çš„ç°è±¡" class="headerlink" title="æ·»åŠ bootstrpå‡ºç°é—ªå±çš„ç°è±¡"></a>æ·»åŠ bootstrpå‡ºç°é—ªå±çš„ç°è±¡</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">.add</span><span class="params">(NexT.motion.middleWares.menu)</span>å·²ç»æ³¨é‡Šæ‰äº†</span><br></pre></td></tr></table></figure><p>è²Œä¼¼bootstrpä¸åŠ ä¹Ÿè¡Œ,æ²¡æœ‰å‘ç°å¤ªéœ€è¦é‡å†™çš„å‡½æ•°</p><h3 id="å³è¾¹çš„sidebaré¼ æ ‡æ»šåŠ¨ç›®å½•æ»‘åŠ¨äº‹ä»¶æ²¡äº†"><a href="#å³è¾¹çš„sidebaré¼ æ ‡æ»šåŠ¨ç›®å½•æ»‘åŠ¨äº‹ä»¶æ²¡äº†" class="headerlink" title="å³è¾¹çš„sidebaré¼ æ ‡æ»šåŠ¨ç›®å½•æ»‘åŠ¨äº‹ä»¶æ²¡äº†"></a>å³è¾¹çš„sidebaré¼ æ ‡æ»šåŠ¨ç›®å½•æ»‘åŠ¨äº‹ä»¶æ²¡äº†</h3><p>æ ¸å¿ƒä»£ç æ˜¯utils.jsä¸­çš„initSidebarDimensionï¼ˆï¼‰å‡½æ•°<br>ç›´æ¥è°ƒç”¨å³å¯ã€‚<br>**å¼ºçƒˆå»ºè®®ç”¨æœ‰é“è¯å…¸çœ‹çœ‹é‚£äº›ä¸ªå‡½æ•°çš„æ³¨é‡Šï¼Œè¿™ä¸ªæ³¨é‡Šå°±å†™çš„å¾ˆæ¸…æ¥šï¼Œä¸€å¼€å§‹æˆ‘æ‰¾äº†å¥½ä¹…æ²¡æœ‰è·Ÿåˆ°ç›¸å…³çš„ä»£ç ï¼Œæœ€åï¼Œå¶å°”çœ‹åˆ°äº†ï¼Œè¿˜å¥½æœ‰ç‚¹è‹±è¯­åŸºç¡€ã€‚<br>utils.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Init Sidebar &amp; TOC inner dimensions on all pages and for all schemes.</span></span><br><span class="line"><span class="comment">  * Need for Sidebar/TOC inner scrolling if content taller then viewport.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">initSidebarDimension</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> updateSidebarHeightTimer;</span><br><span class="line">   $(<span class="built_in">window</span>).on(<span class="string">'resize'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">     updateSidebarHeightTimer &amp;&amp; clearTimeout(updateSidebarHeightTimer);</span><br><span class="line">     updateSidebarHeightTimer = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> sidebarWrapperHeight = <span class="built_in">document</span>.body.clientHeight - NexT.utils.getSidebarSchemePadding();</span><br><span class="line">      updateSidebarHeight(sidebarWrapperHeight);</span><br><span class="line">     &#125;, <span class="number">0</span>);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure><p></p><h3 id="å±€éƒ¨åˆ·æ–°æ–‡ç« ä¸æ˜¾ç¤ºäº†ï¼Œæ–‡ç« é‚£é‡Œæ˜¯ç©ºç™½çš„ã€‚"><a href="#å±€éƒ¨åˆ·æ–°æ–‡ç« ä¸æ˜¾ç¤ºäº†ï¼Œæ–‡ç« é‚£é‡Œæ˜¯ç©ºç™½çš„ã€‚" class="headerlink" title="å±€éƒ¨åˆ·æ–°æ–‡ç« ä¸æ˜¾ç¤ºäº†ï¼Œæ–‡ç« é‚£é‡Œæ˜¯ç©ºç™½çš„ã€‚"></a>å±€éƒ¨åˆ·æ–°æ–‡ç« ä¸æ˜¾ç¤ºäº†ï¼Œæ–‡ç« é‚£é‡Œæ˜¯ç©ºç™½çš„ã€‚</h3><p>ç»è¿‡å®¡æŸ¥ï¼Œæ˜¯opacityå˜æˆäº†0ï¼Œæˆ‘è‡ªå®šä¹‰äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚<br>opacity.js<br></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> opacity_js() &#123;</span><br><span class="line">  /<span class="regexp">/ $(".post-block").css(&#123;visibility: 'visible',opacity:1&#125;);</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ $(".post-header").css(&#123;visibility: 'visible',opacity:1&#125;);</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ $(".post-body").css(&#123;visibility: 'visible',opacity:1&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  $(".post-block").css(&#123;opacity:1&#125;);</span></span><br><span class="line"><span class="regexp">  $(".post-header").css(&#123;opacity:1&#125;);</span></span><br><span class="line"><span class="regexp">  $(".post-body").css(&#123;opacity:1&#125;);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="è¯„è®ºæ²¡äº†"><a href="#è¯„è®ºæ²¡äº†" class="headerlink" title="è¯„è®ºæ²¡äº†"></a>è¯„è®ºæ²¡äº†</h3><p>æˆ‘ç”¨çš„æ˜¯æ¥å¿…åŠ›ï¼Œå…¶ä»–çš„è¯„è®ºç³»ç»Ÿéƒ½æ˜¯ä¸€æ ·çš„æ“ä½œï¼Œå»è¯„è®ºç³»ç»Ÿçš„å®˜ç½‘ï¼Œæˆ–è€…é˜…è¯»æºç ï¼Œè·Ÿåˆ°è°ƒç”¨çš„apié‡æ–°è°ƒç”¨å³å¯ã€‚<br><strong>æ³¨ï¼šä¸‹é¢ç´§è·Ÿç€è¿™ä¸ªæ˜¯ä¹‹å‰é”™è¯¯çš„ä»…ä¾›è®°å½•ï¼Œä¸‹é¢æä¾›äº†æ­£ç¡®çš„åšæ³•</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*åˆ¤æ–­#lv-containerã€commentsæ˜¯å¦ä¸ºç©ºï¼Œç›®å‰è¿™æ˜¯æˆ‘æ‰¾åˆ°æœ€å¥½çš„åŠæ³•ï¼Œå› ä¸ºä¸åˆ¤æ–­ï¼Œè¿›å…¥é¦–é¡µæˆ–å…¶ä»–çš„é¡µé¢ä¼šç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚*/</span></span><br><span class="line">  <span class="keyword">if</span> ($(<span class="string">"#lv-container"</span>).length &gt; <span class="number">0</span> &amp;&amp;$(<span class="string">'.comments'</span>).length&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    $(<span class="string">".comments"</span>).css(&#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;);</span><br><span class="line">    $.getScript(<span class="string">"https://cdn-city.livere.com/js/embed.dist.js"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>æ³¨ï¼šä¸Šé¢çš„ç‰ˆæœ¬æ˜¯ä¹‹å‰é”™è¯¯çš„ï¼Œç»è¿‡é˜…è¯»æºç </strong><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($(<span class="string">"#lv-container"</span>).length &gt; <span class="number">0</span> &amp;&amp;$(<span class="string">'.comments'</span>).length&gt;<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p></p><p>è¿™å¥è¯æ˜¯æ²¡ç”¨çš„,å› ä¸ºæ¯ä¸ªé¡µé¢é‡Œé¢æ˜“ç»ç†åŠ å…¥äº†è¿™ä¸ª,å¹¶ä¸”jsæ˜¯æ²¡æœ‰é‡å†™å®Œæ•´çš„<br><strong>æ­£ç¡®åšæ³•ï¼š</strong><br></p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">function</span>(<span class="name">d</span>, s) &#123;</span><br><span class="line">    var j, e = d.getElementsByTagName(<span class="name">s</span>)[<span class="name">0</span>]<span class="comment">;</span></span><br><span class="line">    if (<span class="name">typeof</span> LivereTower === <span class="symbol">'function</span>') &#123; return<span class="comment">; &#125;</span></span><br><span class="line">    j = d.createElement(<span class="name">s</span>)<span class="comment">;</span></span><br><span class="line">    j.src = <span class="symbol">'https://cdn-city.livere.com/js/embed.dist.js</span>'<span class="comment">;</span></span><br><span class="line">    j.async = true<span class="comment">;</span></span><br><span class="line">    e.parentNode.insertBefore(<span class="name">j</span>, e)<span class="comment">;</span></span><br><span class="line">  &#125;)(<span class="name">document</span>, <span class="symbol">'script</span>')<span class="comment">;</span></span><br></pre></td></tr></table></figure><p></p><p>403çš„é”™è¯¯æ˜¯localhostçš„åŸå› ï¼Œé€šè¿‡åŸŸåè®¿é—®å°±æ²¡äº‹äº†<br>ä¸æŠ¥é”™401å°±æ²¡é—®é¢˜<br>æ›´æ–°ï¼Œè™½ç„¶ç°å®æ²¡é—®é¢˜ï¼Œå¯æ˜¯æ¯æ¬¡åˆ°é¦–é¡µæ€»æ˜¯ä¼šæŠ¥é”™ï¼Œid notfoundï¼Œæ‰ç–å­¦æµ…ä¹…ä¹…ä¸èƒ½è§£å†³ï¼Œå†³å®šæ¢æˆgittalkè¯„è®ºã€‚<br>å‚çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€‚</p><h3 id="å±€éƒ¨ä¼šé—ªä¸€ä¸‹"><a href="#å±€éƒ¨ä¼šé—ªä¸€ä¸‹" class="headerlink" title="å±€éƒ¨ä¼šé—ªä¸€ä¸‹"></a>å±€éƒ¨ä¼šé—ªä¸€ä¸‹</h3><p>boostrap.js bootstrapæ˜¯å¿…é¡»æ³¨é‡Šæ‰çš„</p><h3 id="é˜…è¯»æ•°æ²¡äº†"><a href="#é˜…è¯»æ•°æ²¡äº†" class="headerlink" title="é˜…è¯»æ•°æ²¡äº†"></a>é˜…è¯»æ•°æ²¡äº†</h3><p>è‡ªå®šä¹‰äº†ä¸€ä¸ªjs<br><strong>æ³¨æ„æˆ‘ç¬¬ä¸€è¡Œçš„æ³¨é‡Š</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lean_analytics</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*é‡Œé¢çš„å‚æ•°åŸæ¥æ˜¯&#123;&#123;&#125;&#125;ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ç›´æ¥å°†appidå’Œkeyç²˜è´´è¿‡æ¥ï¼Œå…·ä½“é—®é¢˜æ˜¯ä»€ä¹ˆä¸è¯¦*/</span></span><br><span class="line">  AV.initialize(<span class="string">"6og9b7lpddMqazBCDe8z4HqL-gzGzoHsz"</span>, <span class="string">"faKN7dalSdXLmYYJTRq98B1f"</span>);</span><br><span class="line">  $.getScript(<span class="string">"https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">showTime</span>(<span class="params">Counter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> query = <span class="keyword">new</span> AV.Query(Counter);</span><br><span class="line">    <span class="keyword">var</span> entries = [];</span><br><span class="line">    <span class="keyword">var</span> $visitors = $(<span class="string">".leancloud_visitors"</span>);</span><br><span class="line"></span><br><span class="line">    $visitors.each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      entries.push( $(<span class="keyword">this</span>).attr(<span class="string">"id"</span>).trim() );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    query.containedIn(<span class="string">'url'</span>, entries);</span><br><span class="line">    query.find()</span><br><span class="line">      .done(<span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> COUNT_CONTAINER_REF = <span class="string">'.leancloud-visitors-count'</span>;</span><br><span class="line">        <span class="keyword">if</span> (results.length === <span class="number">0</span>) &#123;</span><br><span class="line">          $visitors.find(COUNT_CONTAINER_REF).text(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; results.length; i++) &#123;</span><br><span class="line">          <span class="keyword">var</span> item = results[i];</span><br><span class="line">          <span class="keyword">var</span> url = item.get(<span class="string">'url'</span>);</span><br><span class="line">          <span class="keyword">var</span> time = item.get(<span class="string">'time'</span>);</span><br><span class="line">          <span class="keyword">var</span> element = <span class="built_in">document</span>.getElementById(url);</span><br><span class="line">          $(element).find(COUNT_CONTAINER_REF).text(time);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; entries.length; i++) &#123;</span><br><span class="line">          <span class="keyword">var</span> url = entries[i];</span><br><span class="line">          <span class="keyword">var</span> element = <span class="built_in">document</span>.getElementById(url);</span><br><span class="line">          <span class="keyword">var</span> countSpan = $(element).find(COUNT_CONTAINER_REF);</span><br><span class="line">          <span class="keyword">if</span>( countSpan.text() == <span class="string">''</span>) &#123;</span><br><span class="line">            countSpan.text(<span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .fail(<span class="function"><span class="keyword">function</span> (<span class="params">object, error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Error: "</span> + error.code + <span class="string">" "</span> + error.message);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addCount</span>(<span class="params">Counter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $visitors = $(<span class="string">".leancloud_visitors"</span>);</span><br><span class="line">    <span class="keyword">var</span> url = $visitors.attr(<span class="string">'id'</span>).trim();</span><br><span class="line">    <span class="keyword">var</span> title = $visitors.attr(<span class="string">'data-flag-title'</span>).trim();</span><br><span class="line">    <span class="keyword">var</span> query = <span class="keyword">new</span> AV.Query(Counter);</span><br><span class="line"></span><br><span class="line">    query.equalTo(<span class="string">"url"</span>, url);</span><br><span class="line">    query.find(&#123;</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (results.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> counter = results[<span class="number">0</span>];</span><br><span class="line">          counter.fetchWhenSave(<span class="literal">true</span>);</span><br><span class="line">          counter.increment(<span class="string">"time"</span>);</span><br><span class="line">          counter.save(<span class="literal">null</span>, &#123;</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">counter</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">var</span> $element = $(<span class="built_in">document</span>.getElementById(url));</span><br><span class="line">              $element.find(<span class="string">'.leancloud-visitors-count'</span>).text(counter.get(<span class="string">'time'</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span>(<span class="params">counter, error</span>) </span>&#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'Failed to save Visitor num, with error message: '</span> + error.message);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">var</span> newcounter = <span class="keyword">new</span> Counter();</span><br><span class="line">          <span class="comment">/* Set ACL */</span></span><br><span class="line">          <span class="keyword">var</span> acl = <span class="keyword">new</span> AV.ACL();</span><br><span class="line">          acl.setPublicReadAccess(<span class="literal">true</span>);</span><br><span class="line">          acl.setPublicWriteAccess(<span class="literal">true</span>);</span><br><span class="line">          newcounter.setACL(acl);</span><br><span class="line">          <span class="comment">/* End Set ACL */</span></span><br><span class="line">          newcounter.set(<span class="string">"title"</span>, title);</span><br><span class="line">          newcounter.set(<span class="string">"url"</span>, url);</span><br><span class="line">          newcounter.set(<span class="string">"time"</span>, <span class="number">1</span>);</span><br><span class="line">          newcounter.save(<span class="literal">null</span>, &#123;</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span>(<span class="params">newcounter</span>) </span>&#123;</span><br><span class="line">              <span class="keyword">var</span> $element = $(<span class="built_in">document</span>.getElementById(url));</span><br><span class="line">              $element.find(<span class="string">'.leancloud-visitors-count'</span>).text(newcounter.get(<span class="string">'time'</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span>(<span class="params">newcounter, error</span>) </span>&#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">'Failed to create'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      error: <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Error:'</span> + error.code + <span class="string">" "</span> + error.message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> Counter = AV.Object.extend(<span class="string">"Counter"</span>);</span><br><span class="line">  <span class="keyword">if</span> ($(<span class="string">'.leancloud_visitors'</span>).length == <span class="number">1</span>) &#123;</span><br><span class="line">    addCount(Counter);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">'.post-title-link'</span>).length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    showTime(Counter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="ç™¾åº¦ç»Ÿè®¡-è§£å†³äº†footerè‡ªåŠ¨æ¨é€"><a href="#ç™¾åº¦ç»Ÿè®¡-è§£å†³äº†footerè‡ªåŠ¨æ¨é€" class="headerlink" title="ç™¾åº¦ç»Ÿè®¡(è§£å†³äº†footerè‡ªåŠ¨æ¨é€)"></a>ç™¾åº¦ç»Ÿè®¡(è§£å†³äº†footerè‡ªåŠ¨æ¨é€)</h3><p>baidutuisong.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baidutuisong</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> bp = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">  <span class="keyword">var</span> curProtocol = <span class="built_in">window</span>.location.protocol.split(<span class="string">':'</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (curProtocol === <span class="string">'https'</span>) &#123;</span><br><span class="line">    bp.src = <span class="string">'https://zz.bdstatic.com/linksubmit/push.js'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    bp.src = <span class="string">'http://push.zhanzhang.baidu.com/push.js'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> s = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"script"</span>)[<span class="number">0</span>];</span><br><span class="line">  s.parentNode.insertBefore(bp, s);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="ä¸è’œå­é˜…è¯»æ¬¡æ•°å¤±æ•ˆ-è§£å†³"><a href="#ä¸è’œå­é˜…è¯»æ¬¡æ•°å¤±æ•ˆ-è§£å†³" class="headerlink" title="ä¸è’œå­é˜…è¯»æ¬¡æ•°å¤±æ•ˆ(è§£å†³)"></a>ä¸è’œå­é˜…è¯»æ¬¡æ•°å¤±æ•ˆ(è§£å†³)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">.getScript(<span class="string">"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>);</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†ç±»åŠ¨æ€ï¼ˆcssæ ·å¼ï¼Œjsä¸è¡Œï¼‰"><a href="#åˆ†ç±»åŠ¨æ€ï¼ˆcssæ ·å¼ï¼Œjsä¸è¡Œï¼‰" class="headerlink" title="åˆ†ç±»åŠ¨æ€ï¼ˆcssæ ·å¼ï¼Œjsä¸è¡Œï¼‰"></a>åˆ†ç±»åŠ¨æ€ï¼ˆcssæ ·å¼ï¼Œjsä¸è¡Œï¼‰</h3><p>category.js<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">category_js</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//åœ¨aæ ‡ç­¾å‰é¢åŠ ä¸ª&gt;</span></span><br><span class="line">  <span class="keyword">if</span> ($(<span class="string">".jiantou"</span>).length==<span class="number">0</span>) &#123;</span><br><span class="line">    $(<span class="string">"&lt;div class='jiantou' style='float: left'&gt; &amp;nbsp&gt;&amp;nbsp &lt;/div&gt;"</span>).prependTo(<span class="string">".category-list-item"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//é¦–ç›¸å°†å­å…ƒç´ uléšè—</span></span><br><span class="line">  $(<span class="string">".category-list-child"</span>).css(<span class="string">"display"</span>,<span class="string">"none"</span>);</span><br><span class="line">  <span class="comment">//æ”¹å˜aæ ‡ç­¾çš„æ ·å¼ï¼Œ"display":"inline-block"åŒæ—¶æ‹¥æœ‰å—å…ƒç´ å’Œè¡Œå…ƒç´ çš„ä¸¤ç§ç‰¹æ€§ã€‚</span></span><br><span class="line">  <span class="comment">//æ”¾åˆ°äº†cssä¸­</span></span><br><span class="line">  <span class="comment">// $(".category-list-link").css(&#123;"width":"1000px","display":"inline-block"&#125;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//åŠ å…¥è¿‡æ»¤å™¨åŠŸèƒ½ï¼Œå› ä¸ºifè²Œä¼¼ä¸æ”¯æŒthisåŠŸèƒ½ï¼Œaæ ‡ç­¾å¦‚æœæœ‰åŒçº§å…ƒç´ ulçš„è¯ä¼šä½¿è·³è½¬åŠŸèƒ½å¤±æ•ˆï¼Œæ²¡æœ‰åŒçº§å…ƒç´ ulçš„è¯ç»§ç»­è·³è½¬</span></span><br><span class="line">  $(<span class="string">".category-list-link"</span>).filter(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $(<span class="keyword">this</span>).siblings(<span class="string">".category-list-child"</span>).length&gt;<span class="number">0</span></span><br><span class="line">  &#125;).attr(<span class="string">"href"</span>,<span class="string">"javascript:void(0)"</span>).css(&#123;<span class="string">"font-weight"</span>:<span class="string">"bold"</span>&#125;);</span><br><span class="line">  <span class="comment">//ç‚¹å‡»å‡ºç°éšè—åŠŸèƒ½ï¼Œaæ ‡ç­¾å¦‚æœæœ‰åŒçº§å…ƒç´ ulçš„è¯ä¼šä½¿è·³è½¬åŠŸèƒ½å¤±æ•ˆï¼Œæ²¡æœ‰åŒçº§å…ƒç´ ulçš„è¯ç»§ç»­è·³è½¬ï¼Œä¸Šé¢å·²ç»åšäº†å¤„ç†ã€‚</span></span><br><span class="line">  $(<span class="string">".category-list-link"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="keyword">this</span>).siblings(<span class="string">".category-list-child"</span>).slideToggle();</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  $(<span class="string">".posts-expand .post-body ul li "</span>).css(<span class="string">"list-style-type"</span>, <span class="string">"none"</span>);</span><br><span class="line">  <span class="comment">//å»æ‰ä¸‹åˆ’çº¿</span></span><br><span class="line">  $(<span class="string">".category-list-link "</span>).css(<span class="string">"border-bottom"</span>, <span class="string">"none"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="åˆ†äº«å¤±è´¥"><a href="#åˆ†äº«å¤±è´¥" class="headerlink" title="åˆ†äº«å¤±è´¥"></a>åˆ†äº«å¤±è´¥</h3><p>åŸæ¥ç”¨çš„addthisï¼Œä¸è¡Œï¼Œåˆæ¢ç™¾åº¦ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œå¹²è„†è‡ªå·±æ•´äº†ä¸€ä¸ª<br>ç½‘ä¸Šæœ‰share.js(æœ‰å…´è¶£çš„è‡ªå·±å­¦ä¹ ä¸€ä¸‹)<br>share.js<br></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// define([<span class="string">'jquery.share.min'</span>],<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> &#123;</span><br><span class="line">var $<span class="built_in">config</span> = &#123;</span><br><span class="line">  sites : [<span class="string">'weibo'</span>,<span class="string">'qq'</span>, <span class="string">'wechat'</span>,<span class="string">'tencent'</span>,<span class="string">'qzone'</span>,<span class="string">'douban'</span>, <span class="string">'facebook'</span>,  <span class="string">'google'</span>,<span class="string">'twitter'</span>],</span><br><span class="line">  disabled: [ <span class="string">'linkedin'</span>, <span class="string">'diandian'</span>],</span><br><span class="line">  wechatQrcodeTitle: <span class="string">"å¾®ä¿¡æ‰«ä¸€æ‰«"</span>,</span><br><span class="line">  wechatQrcodeHelper: <span class="string">'&lt;p&gt;å¾®ä¿¡æ‰«ä¸€æ‰«ï¼Œå³ä¸Šè§’åˆ†äº«&lt;/p&gt;'</span>,</span><br><span class="line">  source: <span class="string">'Leesin Dong'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$(<span class="string">'.post-spread'</span>).share($<span class="built_in">config</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pjaxshare</span><span class="params">()</span></span> &#123;</span><br><span class="line">  $(<span class="string">'.post-spread'</span>).share($<span class="built_in">config</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="è¯„åˆ†ç³»ç»Ÿï¼ˆå·²ç»èˆå¼ƒï¼Œæ„Ÿè§‰æ— ç”¨ï¼‰"><a href="#è¯„åˆ†ç³»ç»Ÿï¼ˆå·²ç»èˆå¼ƒï¼Œæ„Ÿè§‰æ— ç”¨ï¼‰" class="headerlink" title="è¯„åˆ†ç³»ç»Ÿï¼ˆå·²ç»èˆå¼ƒï¼Œæ„Ÿè§‰æ— ç”¨ï¼‰"></a>è¯„åˆ†ç³»ç»Ÿï¼ˆå·²ç»èˆå¼ƒï¼Œæ„Ÿè§‰æ— ç”¨ï¼‰</h3><h3 id="æ‡’åŠ è½½å‡½æ•°"><a href="#æ‡’åŠ è½½å‡½æ•°" class="headerlink" title="æ‡’åŠ è½½å‡½æ•°"></a>æ‡’åŠ è½½å‡½æ•°</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'img'</span>).lazyload(&#123;</span><br><span class="line"><span class="symbol">    placeholder:</span> <span class="string">'/images/loading.gif'</span>,</span><br><span class="line"><span class="symbol">    effect:</span> <span class="string">'fadeIn'</span>,</span><br><span class="line">    <span class="string">threshold :</span> <span class="number">100</span>,</span><br><span class="line">    <span class="string">failure_limit :</span> <span class="number">20</span>,</span><br><span class="line">    <span class="string">skip_invisible :</span> <span class="literal">false</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h1 id="å¿˜äº†æœ€åæœ€é‡è¦çš„ä¸€ç‚¹ä¸€ç‚¹ï¼Œç‚¹å‡»æµè§ˆå™¨çš„è¿”å›å‰è¿›æŒ‰é’®ï¼Œç‰¹æ•ˆè¿˜æ˜¯å¤±è´¥äº†"><a href="#å¿˜äº†æœ€åæœ€é‡è¦çš„ä¸€ç‚¹ä¸€ç‚¹ï¼Œç‚¹å‡»æµè§ˆå™¨çš„è¿”å›å‰è¿›æŒ‰é’®ï¼Œç‰¹æ•ˆè¿˜æ˜¯å¤±è´¥äº†" class="headerlink" title="å¿˜äº†æœ€åæœ€é‡è¦çš„ä¸€ç‚¹ä¸€ç‚¹ï¼Œç‚¹å‡»æµè§ˆå™¨çš„è¿”å›å‰è¿›æŒ‰é’®ï¼Œç‰¹æ•ˆè¿˜æ˜¯å¤±è´¥äº†"></a>å¿˜äº†æœ€åæœ€é‡è¦çš„ä¸€ç‚¹ä¸€ç‚¹ï¼Œç‚¹å‡»æµè§ˆå™¨çš„è¿”å›å‰è¿›æŒ‰é’®ï¼Œç‰¹æ•ˆè¿˜æ˜¯å¤±è´¥äº†</h1><p>è¾›è¾›è‹¦è‹¦googleäº†ä¸‰å¤©çš„ç»“æœã€‚<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">window</span>).on(<span class="string">'popstate.pjax'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  pjax();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>æš‚æ—¶å…ˆè¿™ä¹ˆå¤šå§~<br>å–œæ¬¢çš„ç‚¹ä¸ªæ˜Ÿæ˜Ÿï¼ŒåŠ ä¸ªå…³æ³¨ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_10.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;ä¸€ç¯‡å…³äºåœ¨nextä¸»é¢˜ä¸­åŠ å…¥pjaxçš„æ–‡ç« ï¼Œè®©ä½ çš„æ–‡ç« å¦‚é’»çŸ³èˆ¬å¤ºç›®ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="hexo" scheme="http://mmmmmm.me/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://mmmmmm.me/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>è‚–ç”³å…‹çš„æ•‘èµ</title>
    <link href="http://mmmmmm.me/To_myself.html"/>
    <id>http://mmmmmm.me/To_myself.html</id>
    <published>2018-10-15T06:57:00.000Z</published>
    <updated>2019-03-01T01:32:18.690Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --><p><img alt="upload successful" data-original="/images/my_blog_0.png"></p><blockquote><ul><li></li></ul></blockquote><a id="more"></a><h1 id="è‚–ç”³å…‹çš„æ•‘èµè¯»åæ„Ÿ"><a href="#è‚–ç”³å…‹çš„æ•‘èµè¯»åæ„Ÿ" class="headerlink" title="è‚–ç”³å…‹çš„æ•‘èµè¯»åæ„Ÿ"></a>è‚–ç”³å…‹çš„æ•‘èµè¯»åæ„Ÿ</h1><p>ä¸€éƒ¨å€¼å¾—ç»†ç»†å“å‘³çš„ç‰‡å­ã€‚</p><h2 id="é¢å¯¹æ— æ³•æ”¹å˜çš„ç°å®ï¼Œç ´å˜´å’†å“®ã€åšå••å¤§å“­å’Œææƒ§æ˜¯ä¸æ¯«æ²¡æœ‰ä½œç”¨çš„ï¼Œåªä¼šè®©ç»“æœæ›´åŠ ç³Ÿç³•ã€‚"><a href="#é¢å¯¹æ— æ³•æ”¹å˜çš„ç°å®ï¼Œç ´å˜´å’†å“®ã€åšå••å¤§å“­å’Œææƒ§æ˜¯ä¸æ¯«æ²¡æœ‰ä½œç”¨çš„ï¼Œåªä¼šè®©ç»“æœæ›´åŠ ç³Ÿç³•ã€‚" class="headerlink" title="é¢å¯¹æ— æ³•æ”¹å˜çš„ç°å®ï¼Œç ´å˜´å’†å“®ã€åšå••å¤§å“­å’Œææƒ§æ˜¯ä¸æ¯«æ²¡æœ‰ä½œç”¨çš„ï¼Œåªä¼šè®©ç»“æœæ›´åŠ ç³Ÿç³•ã€‚"></a>é¢å¯¹æ— æ³•æ”¹å˜çš„ç°å®ï¼Œç ´å˜´å’†å“®ã€åšå••å¤§å“­å’Œææƒ§æ˜¯ä¸æ¯«æ²¡æœ‰ä½œç”¨çš„ï¼Œåªä¼šè®©ç»“æœæ›´åŠ ç³Ÿç³•ã€‚</h2><p>å…¥ç‹±çš„ç¬¬ä¸€å¤©æ™šä¸Šï¼Œè€é¸Ÿæ‰å¼„èœé¸Ÿâ€è‚¥è‡€â€œï¼Œè‚¥è‡€åšå••å¤§å“­ï¼Œæ¢æ¥çš„æ˜¯ç›‘ç‹±æ‰€æœ‰äººçš„å˜²ç¬‘å’Œæ— è§†ï¼Œè­¦å«è¿›æ¥ï¼Œâ€œè‚¥è‡€â€ç ´å˜´å’†å“®ï¼Œæ¢æ¥çš„æ˜¯è¢«æ´»æ´»æ‰“æ­»ã€‚<br>çœŸæ­£çš„æ™ºè€…æ˜¯å®‰è¿ªï¼Œä¸€å£°æ²¡å‘ã€‚</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šäº‹å·²è‡³æ­¤ï¼Œä½ æˆ‘éƒ½æ²¡æœ‰é”™ï¼Œé¢å¯¹æ— æ³•æ”¹å˜çš„ç°å®ï¼Œåªèƒ½å»æ¥å—ï¼Œæƒ³åŠæ³•è§£å†³ï¼Œè€Œä¸æ˜¯å’†å“®ã€å¤§å“­äº¦æˆ–è€…ææƒ§ï¼Œå¦åˆ™ç»“æœä¼šæ›´åŠ çš„ç³Ÿç³•ã€‚</p><h2 id="æƒ³è¦æˆåŠŸï¼Œä¸€å®šè¦æœ‰åè¶³çš„è§„åˆ’ã€‚"><a href="#æƒ³è¦æˆåŠŸï¼Œä¸€å®šè¦æœ‰åè¶³çš„è§„åˆ’ã€‚" class="headerlink" title="æƒ³è¦æˆåŠŸï¼Œä¸€å®šè¦æœ‰åè¶³çš„è§„åˆ’ã€‚"></a>æƒ³è¦æˆåŠŸï¼Œä¸€å®šè¦æœ‰åè¶³çš„è§„åˆ’ã€‚</h2><p>æœ€åˆï¼Œå®‰è¿ªå¿ƒäº‹é‡é‡å¹¶ä¸æ€ä¹ˆä¸äººäº¤æµã€‚ç›´åˆ°ä¸€ä¸ªæœˆåï¼Œä»–æ‰¾åˆ°äº†ç‘å¾·ï¼Œå¸Œæœ›ä»–å¸®è‡ªå·±æåˆ°åœ°è´¨é”¤ã€‚ä»–ç”¨ä¸€ä¸ªæœˆçš„æ—¶é—´æ¥è§„åˆ’ï¼Œç­‰åˆ°æ—¶æœºæˆç†Ÿï¼Œæ‰è¿ˆå‡ºäº†ç¬¬ä¸€æ­¥ã€‚</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šä¸‡äº‹éƒ½è¦è§„åˆ’å¥½ï¼Œå†è¿›è¡Œã€‚</p><h2 id="åšä»»ä½•äº‹éƒ½è¦å­¦ä¼šéšè—è‡ªå·±æœ€åˆçš„æƒ³æ³•"><a href="#åšä»»ä½•äº‹éƒ½è¦å­¦ä¼šéšè—è‡ªå·±æœ€åˆçš„æƒ³æ³•" class="headerlink" title="åšä»»ä½•äº‹éƒ½è¦å­¦ä¼šéšè—è‡ªå·±æœ€åˆçš„æƒ³æ³•"></a>åšä»»ä½•äº‹éƒ½è¦å­¦ä¼šéšè—è‡ªå·±æœ€åˆçš„æƒ³æ³•</h2><p>å®‰è¿ªé€šè¿‡ä¹°åœ°è´¨é”¤ï¼Œå¹¶ä¸æ–­çš„åˆ»çŸ³å¤´ï¼Œè®©äººä»¬å–æ¶ˆå¯¹ä»–æƒ³è¶Šç‹±çš„é¡¾è™‘ï¼›åœ¨ä¸€ä¸ªåˆé€‚çš„æ—¶æœºï¼šçŠ¯äººçœ‹ç¾å¥³ç”µå½±çš„æ—¶å€™ï¼Œå‘ç‘å¾·è¦ç¾å¥³å£ç”»ï¼Œç”¨æ¥æ©ç›–é€šé“ï¼›é€šè¿‡é˜…è¯»åœ£ç»ï¼Œå°†åœ°è´¨é”¤éšè—åœ¨è‡ªå·±çš„åœ£ç»ä¸­ï¼Œæ²¡é”™â€œå¾—æ•‘ä¹‹é“ï¼Œå°±åœ¨å…¶ä¸­â€ï¼›é€šè¿‡å¸®åŠ©å…¸ç‹±é•¿æ´—é»‘é’±ï¼Œç”¨é‚®ä»¶å‘å„æ”¿åºœéƒ¨é—¨ç”³è¯·é—å¤±è¯ä»¶è¡¥å‘ï¼Œæ„å»ºäº†ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„äººï¼Œä¸ºä»–è¶Šç‹±æˆåŠŸä¹‹åçš„èº«ä»½æä¾›äº†å¾ˆå¥½çš„ä¿éšœ<br>å¦‚æœå®‰è¿ªæ¯å¤©åš·åš·ç€â€œæˆ‘è¦è¶Šç‹±äº†ï¼â€ï¼Œå®ƒä¼šæˆåŠŸå—ï¼Ÿæ¯æ¬¡å°†è‡ªå·±çš„çœŸå®ç›®çš„éšè—èµ·æ¥ï¼Œä»¥ä¸€ä¸ªéå¸¸æ™®é€šçš„ã€ä¸ä¼šè®©äººèµ·ç–‘å¿ƒçš„ç†ç”±ï¼Œå¹¶ä¸”åœ¨æ°å½“çš„æ—¶æœºã€‚</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šå¦‚æœæ¯å¤©è·ŸåŒäº‹è¯´â€œæˆ‘è¦è·³æ§½äº†â€ï¼Œé‚£ä½ æ°¸è¿œä¹Ÿåˆ«æƒ³èµ°ï¼</p><h2 id="è¦æŠ“ä½æ—¶æœºï¼Œä¸è¦çŠ¹è±«ï¼Œå“ªæ€•ç²‰èº«ç¢éª¨"><a href="#è¦æŠ“ä½æ—¶æœºï¼Œä¸è¦çŠ¹è±«ï¼Œå“ªæ€•ç²‰èº«ç¢éª¨" class="headerlink" title="è¦æŠ“ä½æ—¶æœºï¼Œä¸è¦çŠ¹è±«ï¼Œå“ªæ€•ç²‰èº«ç¢éª¨"></a>è¦æŠ“ä½æ—¶æœºï¼Œä¸è¦çŠ¹è±«ï¼Œå“ªæ€•ç²‰èº«ç¢éª¨</h2><p>åœ¨ä¿®å±‹é¡¶çš„æ—¶å€™ï¼Œç‹±è­¦æµ·åˆ©å“¥å“¥ç•™ä¸‹äº†ä¸‰ä¸‡äº”åƒç¾å…ƒè´¢äº§ï¼Œä½†æ˜¯è¿™ç¬”é’±è¦äº¤ç¨ï¼Œå®‰è¿ªå†’ç€è¢«æ¨ä¸‹å»çš„å±é™©ï¼Œå½“æœºç«‹æ–­çš„èµ°ä¸Šå»ï¼Œå¸®ä»–è§£å†³äº†é—®é¢˜ã€‚å¦‚æœå½“æ—¶å¾˜å¾Šä¸å®šï¼Œä¸ä¼šæœ‰åé¢çš„å›¾ä¹¦é¦†ã€å¸®å…¸ç‹±é•¿æ´—é»‘é’±çš„ç»å†ã€‚</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šä¸‡äº‹ä¸è¦çŠ¹è±«ä¸å®šï¼Œä¸€å®šè¦å½“æœºç«‹æ–­ï¼</p><h2 id="ä¸è®ºå½“å‰çš„å¤„å¢ƒå¤šä¹ˆçš„ç³Ÿç³•ï¼Œä¹Ÿè¦å……æ»¡å¸Œæœ›ï¼Œå……æ»¡å¯¹è‡ªç”±çš„æ¸´æœ›"><a href="#ä¸è®ºå½“å‰çš„å¤„å¢ƒå¤šä¹ˆçš„ç³Ÿç³•ï¼Œä¹Ÿè¦å……æ»¡å¸Œæœ›ï¼Œå……æ»¡å¯¹è‡ªç”±çš„æ¸´æœ›" class="headerlink" title="ä¸è®ºå½“å‰çš„å¤„å¢ƒå¤šä¹ˆçš„ç³Ÿç³•ï¼Œä¹Ÿè¦å……æ»¡å¸Œæœ›ï¼Œå……æ»¡å¯¹è‡ªç”±çš„æ¸´æœ›"></a>ä¸è®ºå½“å‰çš„å¤„å¢ƒå¤šä¹ˆçš„ç³Ÿç³•ï¼Œä¹Ÿè¦å……æ»¡å¸Œæœ›ï¼Œå……æ»¡å¯¹è‡ªç”±çš„æ¸´æœ›</h2><p>å½±ç‰‡ä¸­ï¼Œå¸®åŠ©é¢„è­¦æµ·åˆ©èº²è¿‡äº¤ç¨åï¼Œè¯·å¤§å®¶å–å•¤é…’ï¼›æ”¿åºœå‘å›¾ä¹¦é¦†å‘æ¥æ‹¨æ¬¾ä¸­æœ‰èƒ½ä½¿å¤§å®¶å¿«ä¹çš„éŸ³ç¢Ÿï¼Œå†’ç€å¾ˆå¤§çš„é£é™©ï¼Œè®©æ‰€æœ‰çš„äººéƒ½èƒ½å¬åˆ°è¿™ç¾å¦™çš„éŸ³ä¹ï¼Œè¿™çŸ­æš‚çš„è‡ªç”±ï¼Œå³ä½¿è¢«å…³ä¸€å‘¨çš„ç¦é—­ï¼›åœ¨ç›‘ç‹±å¼€è®¾å›¾ä¹¦é¦†ï¼Œå¸®åŠ©äººä»¬å–å¾—åˆç­‰æ•™è‚²è®¤è¯ç­‰ç­‰</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šä¸è®ºå¤„å¢ƒå¤šä¹ˆç³Ÿç³•ï¼Œä¹Ÿä¸è¦ä¸§å¤±å¯¹å¸Œæœ›ã€å¯¹è‡ªç”±çš„æ¸´æœ›</p><h2 id="ä¸è¦è¢«ä¸‡æ¶çš„å‘½è¿ä½“åˆ¶åŒ–"><a href="#ä¸è¦è¢«ä¸‡æ¶çš„å‘½è¿ä½“åˆ¶åŒ–" class="headerlink" title="ä¸è¦è¢«ä¸‡æ¶çš„å‘½è¿ä½“åˆ¶åŒ–"></a>ä¸è¦è¢«ä¸‡æ¶çš„å‘½è¿ä½“åˆ¶åŒ–</h2><p>å½±ç‰‡ä¸­å¤šæ¬¡å‡ºç°çš„ä¸€ä¸ªè¯å°±æ˜¯â€œä½“åˆ¶åŒ–â€ï¼Œè¿˜è¢«å¾ˆå¤šäººå˜²ç¬‘æ˜¯ç‘å¾·ç¼–é€ å‡ºæ¥çš„è¯è¯­ï¼Œå¾ˆå¥½çš„ä¾‹å­å°±æ˜¯å‡ºç‹±åçš„è€å¸ƒï¼Œæ— æ³•é€‚åº”å¤–é¢çš„ç”Ÿæ´»ï¼Œé€‰æ‹©è‡ªæ€ã€‚<br>ç”Ÿåä¸­äº¦æ˜¯å¦‚æ­¤ï¼šè¢«è‹¦éš¾æŠ˜ç£¨çš„å¤ªä¹…ï¼Œæˆ‘ä»¬éƒ½è¢«â€œä½“åˆ¶åŒ–â€äº†ï¼Œé€‰æ‹©å¦¥åï¼Œå½±ç‰‡ä¸­çš„ç‘å¾·æ˜¯ä¸€ä¸ªç°å®ç”Ÿæ´»ä¸­çš„è¡¨é¢çš„æ™ºè€…ï¼Œé€‰æ‹©å»æ¥å—ï¼Œä¸€å£°ä¸å­ï¼Œä½†æ˜¯çœŸæ­£çš„æ™ºè€…æ˜¯å®‰è¿ªï¼Œæ°¸è¿œéƒ½ä¸ä¼šä½“åˆ¶åŒ–ï¼Œå› ä¸ºäººå¿ƒæ˜¯å…³ä¸ä½çš„ã€‚</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šä½ è‡ªå·±éƒ½ä¸æƒ³æ•‘è‡ªå·±ï¼Œè°è¿˜èƒ½æ•‘ä½ ï¼Ÿ</p><h2 id="å­¦ä¼šå–„ç”¨é‚£äº›åˆ©ç”¨ä½ çš„äºº"><a href="#å­¦ä¼šå–„ç”¨é‚£äº›åˆ©ç”¨ä½ çš„äºº" class="headerlink" title="å­¦ä¼šå–„ç”¨é‚£äº›åˆ©ç”¨ä½ çš„äºº"></a>å­¦ä¼šå–„ç”¨é‚£äº›åˆ©ç”¨ä½ çš„äºº</h2><p>å®‰è¿ªå› ä¸ºè‡ªå·±çš„é•¿å¤„è¢«é¢„è­¦æµ·åˆ©å’Œå…¸ç‹±é•¿èµè¯†ï¼Œä¹Ÿæ˜¯ç”¨è¿‡è®¤è¯†äº†ä»–ä»¬ï¼Œä»–ä»¬å¸®ä»–æ‘†è„±äº†ï¼Œä¸€ç›´ä»¥æ¥éªšæ‰°ä»–çš„â€œä¸‰å§å¦¹â€ï¼Œå…¸ç‹±é•¿åˆ©ç”¨å®‰è¿ªæ´—é»‘é’±ï¼Œå®‰è¿ªæœ€åå°†é»‘é’±æ±‡åˆ°è‡ªå·±çš„å¸ä¸Šï¼Œä¸ºè‡ªå·±çš„é‡ç”Ÿåšäº†å¾ˆå¥½çš„â€œç»æµåŸºç¡€â€<br>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šäººç”Ÿæ¥å°±æ˜¯éœ€è¦å¸®åŠ©çš„ï¼Œåœ¨è¿™ä¸–ä¸Šï¼Œä¸€ä¸ªäººæ˜¯å¾ˆéš¾åŠæˆäº‹æƒ…çš„ã€‚</p><h2 id="åšæŒ"><a href="#åšæŒ" class="headerlink" title="åšæŒ"></a>åšæŒ</h2><p>å½±ç‰‡æœ€æƒ³çªå‡ºçš„æˆ‘æ„Ÿè§‰æ˜¯â€œåšæŒâ€ï¼Œè¿™ä¸ªå°±ä¸èµ˜è¿°äº†</p><p>ç”Ÿæ´»ä¸­äº¦æ˜¯å¦‚æ­¤ï¼šåšæŒ</p><h2 id="åæ­£äººåªæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå¿™ç€ç”Ÿæˆ–å¿™ç€æ­»"><a href="#åæ­£äººåªæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå¿™ç€ç”Ÿæˆ–å¿™ç€æ­»" class="headerlink" title="åæ­£äººåªæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå¿™ç€ç”Ÿæˆ–å¿™ç€æ­»"></a>åæ­£äººåªæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œå¿™ç€ç”Ÿæˆ–å¿™ç€æ­»</h2><h2 id="é‡ç”Ÿ"><a href="#é‡ç”Ÿ" class="headerlink" title="é‡ç”Ÿ"></a>é‡ç”Ÿ</h2><p>æ²¡é”™ï¼Œé‡ç”Ÿï¼</p><h1 id="çŸ­æš‚çš„ä¸€ç”Ÿ"><a href="#çŸ­æš‚çš„ä¸€ç”Ÿ" class="headerlink" title="çŸ­æš‚çš„ä¸€ç”Ÿ"></a>çŸ­æš‚çš„ä¸€ç”Ÿ</h1><blockquote><ul><li>äººè¿™ä¸€è¾ˆå­é™¤äº†æ­»ï¼Œä»€ä¹ˆéƒ½ä¸å®œè¿Ÿï¼Œä¸è¦å†å»ç­‰æ°¸è¿œï¼Œå†ä¹…çš„æ°¸è¿œä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå››æœˆï¼Œè¶é˜³å…‰æ­£å¥½ï¼Œè¶å¾®é£ä¸å™ªï¼Œ è¶ç¹èŠ±è¿˜æœªå¼€è‡³è¼è˜¼ï¼Œå¥½å¥½çš„å»çˆ±ï¼Œå°½æƒ…çš„å»åšï¼Œ<br>ä¸è¦ç­‰åˆ°è€äº†ï¼Œæ‰å‘è§‰ï¼Œè¯¥è¯´çš„è¯è¿˜æ²¡è¯´ï¼Œè¯¥åšçš„äº‹è¿˜æ²¡åšï¼Œè¯¥è§çš„äººè¿˜æ²¡è§ï¼Œè¯¥ç‰µçš„æ‰‹ï¼Œè¿˜æ²¡æœ‰ç‰µâ€¦</li></ul></blockquote><blockquote><ul><li>å¦‚æœä¸€ä¸ªäººåªæ˜¯åº¦è¿‡ä¸€å¤©ç®—ä¸€å¤©ï¼Œä»€ä¹ˆå¸Œæœ›ä¹Ÿæ²¡æœ‰ï¼Œä»–çš„ç”Ÿå‘½å®é™…ä¸Šä¹Ÿå°±åœæ­¢äº†ã€‚</li></ul></blockquote><blockquote><ul><li>äººç”Ÿä¸€ä¸–ä¸å°±æ˜¯ä¸ºäº†åŒ–çŸ­æš‚çš„äº‹ç‰©ä¸ºæ°¸ä¹…çš„å—ï¼Ÿè¦åšåˆ°è¿™ä¸€æ­¥ï¼Œå°±é¡»æ‡‚å¾—å¦‚ä½•çè§†è¿™çŸ­æš‚å’Œæ°¸ä¹…ã€‚</li></ul></blockquote><blockquote><ul><li>ä¸€ä¸ªäººå¦‚æœç¢Œç¢Œæ— ä¸ºï¼Œåªä¸ºè‡ªå·±æ¸ºå°çš„ç”Ÿå­˜è€Œè™šåº¦ä¸€ç”Ÿï¼Œé‚£ä¹ˆï¼Œå³ä½¿ä»–é«˜å¯¿æ´»åˆ°ä¸€ç™¾å²ï¼Œåˆæœ‰ä»€ä¹ˆä»·å€¼å’Œæ„ä¹‰å‘¢ï¼Ÿ</li></ul></blockquote><blockquote><ul><li>äººç”Ÿå°±åƒä¸€æœ¬ä¹¦ï¼Œå‚»ç“œä»¬èµ°é©¬çœ‹èŠ±ä¼¼åœ°éšæ‰‹ç¿»é˜…å®ƒï¼Œèªæ˜çš„äººç”¨å¿ƒåœ°é˜…è¯»å®ƒã€‚å› ä¸ºä»–çŸ¥é“è¿™æœ¬ä¹¦åªèƒ½è¯»ä¸€æ¬¡ã€‚</li></ul></blockquote><blockquote><ul><li>åšè‡ªå·±å–œæ¬¢çš„äº‹æƒ…å§ï¼å»æ¥è§¦æ–°çš„äº‹ç‰©å§ï¼å»åšæ—¶é—´çš„æœ‹å‹å§ï¼</li><li>äººç”Ÿæ˜¯ä¸€åœºæ—…ç¨‹ã€‚æˆ‘ä»¬ç»å†äº†å‡ æ¬¡è½®å›ï¼Œæ‰æ¢æ¥è¿™ä¸ªæ—…ç¨‹ã€‚è€Œè¿™ä¸ªæ—…ç¨‹å¾ˆçŸ­ï¼Œå› æ­¤ä¸å¦¨å¤§èƒ†ä¸€äº›ï¼Œä¸å¦¨å¤§èƒ†ä¸€äº›å»çˆ±ä¸€ä¸ªäººï¼Œå»æ”€ä¸€åº§å±±ï¼Œå»è¿½ä¸€ä¸ªæ¢¦â€¦â€¦æœ‰å¾ˆå¤šäº‹æˆ‘éƒ½ä¸æ˜ç™½ã€‚ä½†æˆ‘ç›¸ä¿¡ä¸€ä»¶äº‹ã€‚ä¸Šå¤©è®©æˆ‘ä»¬æ¥åˆ°è¿™ä¸ªä¸–ä¸Šï¼Œå°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬åˆ›é€ å¥‡è¿¹ã€‚</li></ul></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Mon Mar 11 2019 06:25:42 GMT+0800 (China Standard Time) --&gt;&lt;p&gt;&lt;img alt=&quot;upload successful&quot; data-original=&quot;/images/my_blog_0.png&quot;&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;
    
    </summary>
    
      <category term="short life" scheme="http://mmmmmm.me/categories/short-life/"/>
    
      <category term="short life" scheme="http://mmmmmm.me/categories/short-life/short-life/"/>
    
    
      <category term="äººç”Ÿ" scheme="http://mmmmmm.me/tags/%E4%BA%BA%E7%94%9F/"/>
    
  </entry>
  
</feed>
